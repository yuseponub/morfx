---
phase: 10-search-tasks-analytics
plan: 05
type: execute
wave: 1
depends_on: []
files_modified:
  - src/app/actions/analytics.ts
  - src/lib/analytics/types.ts
  - src/app/(dashboard)/analytics/page.tsx
  - src/app/(dashboard)/analytics/components/metric-cards.tsx
  - src/app/(dashboard)/analytics/components/sales-chart.tsx
  - src/app/(dashboard)/analytics/components/period-selector.tsx
autonomous: true

must_haves:
  truths:
    - "Admin/owner can access /analytics dashboard"
    - "Dashboard shows total orders, total value, conversion rate, ticket promedio"
    - "Charts show trend data over selected period"
    - "Period selector changes displayed data"
    - "Agents cannot access analytics page (redirect)"
  artifacts:
    - path: "src/app/(dashboard)/analytics/page.tsx"
      provides: "Analytics dashboard page"
      contains: "MetricCards"
    - path: "src/app/actions/analytics.ts"
      provides: "Server Actions for metrics"
      exports: ["getOrderMetrics", "getSalesTrend"]
    - path: "src/app/(dashboard)/analytics/components/sales-chart.tsx"
      provides: "Trend chart component"
      contains: "AreaChart"
  key_links:
    - from: "analytics/page.tsx"
      to: "getOrderMetrics"
      via: "Server Action call"
      pattern: "await getOrderMetrics"
    - from: "sales-chart.tsx"
      to: "getSalesTrend"
      via: "Data for chart"
      pattern: "getSalesTrend"
---

<objective>
Create the analytics dashboard for workspace admins with key sales metrics.

Purpose: Admins can view business KPIs including total orders, revenue, conversion rate, and trends. Provides visibility into sales performance. Agents are restricted from this page.

Output: Analytics page with metric cards, trend charts, and period selector.
</objective>

<execution_context>
@/home/jose147/.claude/get-shit-done/workflows/execute-plan.md
@/home/jose147/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/10-search-tasks-analytics/10-CONTEXT.md
@.planning/phases/10-search-tasks-analytics/10-RESEARCH.md

# Existing patterns to follow
@src/app/(dashboard)/configuracion/whatsapp/costos/page.tsx
@src/app/(dashboard)/configuracion/whatsapp/costos/components/usage-chart.tsx
@src/app/(dashboard)/configuracion/whatsapp/costos/components/period-selector.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create analytics types and Server Actions</name>
  <files>
    src/lib/analytics/types.ts
    src/app/actions/analytics.ts
  </files>
  <action>
**1. src/lib/analytics/types.ts**

```typescript
export type Period = 'today' | '7days' | '30days' | 'month'

export interface OrderMetrics {
  totalOrders: number
  totalValue: number
  conversionRate: number  // percentage
  avgTicket: number
  // Comparison to previous period
  ordersDelta?: number    // percentage change
  valueDelta?: number     // percentage change
}

export interface TrendDataPoint {
  date: string           // ISO date string
  label: string          // Display label (e.g., "Lun 3")
  orders: number
  value: number
}

export interface SalesTrend {
  data: TrendDataPoint[]
  totalOrders: number
  totalValue: number
}
```

**2. src/app/actions/analytics.ts**

```typescript
'use server'

import { createClient } from '@/lib/supabase/server'
import { getWorkspaceId } from '@/lib/workspace/server'
import { startOfDay, subDays, startOfMonth, endOfDay, format, eachDayOfInterval } from 'date-fns'
import { es } from 'date-fns/locale'
import type { Period, OrderMetrics, SalesTrend, TrendDataPoint } from '@/lib/analytics/types'

function getDateRange(period: Period): { start: Date; end: Date } {
  const now = new Date()
  const end = endOfDay(now)

  switch (period) {
    case 'today':
      return { start: startOfDay(now), end }
    case '7days':
      return { start: startOfDay(subDays(now, 6)), end }
    case '30days':
      return { start: startOfDay(subDays(now, 29)), end }
    case 'month':
      return { start: startOfMonth(now), end }
  }
}

export async function getOrderMetrics(period: Period): Promise<OrderMetrics> {
  const supabase = await createClient()
  const workspaceId = await getWorkspaceId()
  if (!workspaceId) {
    return { totalOrders: 0, totalValue: 0, conversionRate: 0, avgTicket: 0 }
  }

  const { start, end } = getDateRange(period)

  // Fetch orders with stage info for conversion calculation
  const { data: orders } = await supabase
    .from('orders')
    .select('id, total_value, stage:pipeline_stages(is_closed)')
    .eq('workspace_id', workspaceId)
    .gte('created_at', start.toISOString())
    .lte('created_at', end.toISOString())

  const totalOrders = orders?.length ?? 0
  const totalValue = orders?.reduce((sum, o) => sum + (o.total_value || 0), 0) ?? 0

  // Conversion: orders in closed stages / total orders
  const closedOrders = orders?.filter(o => (o.stage as any)?.is_closed).length ?? 0
  const conversionRate = totalOrders > 0 ? (closedOrders / totalOrders) * 100 : 0

  // Average ticket
  const avgTicket = totalOrders > 0 ? totalValue / totalOrders : 0

  // TODO: Calculate delta vs previous period (optional enhancement)

  return {
    totalOrders,
    totalValue,
    conversionRate: Math.round(conversionRate * 10) / 10, // 1 decimal
    avgTicket: Math.round(avgTicket)
  }
}

export async function getSalesTrend(period: Period): Promise<SalesTrend> {
  const supabase = await createClient()
  const workspaceId = await getWorkspaceId()
  if (!workspaceId) {
    return { data: [], totalOrders: 0, totalValue: 0 }
  }

  const { start, end } = getDateRange(period)

  // Fetch orders in period
  const { data: orders } = await supabase
    .from('orders')
    .select('id, total_value, created_at')
    .eq('workspace_id', workspaceId)
    .gte('created_at', start.toISOString())
    .lte('created_at', end.toISOString())
    .order('created_at', { ascending: true })

  // Generate all days in range
  const days = eachDayOfInterval({ start, end })

  // Group orders by day
  const ordersByDay = new Map<string, { orders: number; value: number }>()

  orders?.forEach(order => {
    const dateKey = format(new Date(order.created_at), 'yyyy-MM-dd')
    const existing = ordersByDay.get(dateKey) || { orders: 0, value: 0 }
    ordersByDay.set(dateKey, {
      orders: existing.orders + 1,
      value: existing.value + (order.total_value || 0)
    })
  })

  // Build data points for all days
  const data: TrendDataPoint[] = days.map(day => {
    const dateKey = format(day, 'yyyy-MM-dd')
    const dayData = ordersByDay.get(dateKey) || { orders: 0, value: 0 }

    return {
      date: dateKey,
      label: format(day, 'EEE d', { locale: es }), // "Lun 3"
      orders: dayData.orders,
      value: dayData.value
    }
  })

  const totalOrders = orders?.length ?? 0
  const totalValue = orders?.reduce((sum, o) => sum + (o.total_value || 0), 0) ?? 0

  return { data, totalOrders, totalValue }
}
```

Handle edge cases:
- Empty workspace returns zeros
- Period with no orders returns empty array but valid structure
- Use America/Bogota timezone context from project convention
  </action>
  <verify>
Run: `pnpm tsc --noEmit` - types compile.
Test Server Actions return correct structure.
  </verify>
  <done>
Analytics types defined. Server Actions calculate metrics and trend data.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create analytics dashboard UI</name>
  <files>
    src/app/(dashboard)/analytics/page.tsx
    src/app/(dashboard)/analytics/components/metric-cards.tsx
    src/app/(dashboard)/analytics/components/sales-chart.tsx
    src/app/(dashboard)/analytics/components/analytics-view.tsx
  </files>
  <action>
**1. src/app/(dashboard)/analytics/page.tsx**

Server component with role check:

```tsx
import { redirect } from 'next/navigation'
import { createClient } from '@/lib/supabase/server'
import { getWorkspaceId } from '@/lib/workspace/server'
import { AnalyticsView } from './components/analytics-view'
import { getOrderMetrics, getSalesTrend } from '@/app/actions/analytics'

export default async function AnalyticsPage() {
  // Role check: only admin/owner can access
  const supabase = await createClient()
  const workspaceId = await getWorkspaceId()

  if (!workspaceId) {
    redirect('/crm/pedidos')
  }

  const { data: { user } } = await supabase.auth.getUser()
  if (!user) {
    redirect('/login')
  }

  const { data: membership } = await supabase
    .from('workspace_members')
    .select('role')
    .eq('workspace_id', workspaceId)
    .eq('user_id', user.id)
    .single()

  // Agents cannot access
  if (membership?.role === 'agent') {
    redirect('/crm/pedidos')
  }

  // Fetch initial data (7 days default)
  const metrics = await getOrderMetrics('7days')
  const trend = await getSalesTrend('7days')

  return (
    <div className="container py-6 space-y-6">
      <div>
        <h1 className="text-2xl font-bold">Analytics</h1>
        <p className="text-muted-foreground">
          Metricas de ventas y rendimiento del workspace
        </p>
      </div>

      <AnalyticsView initialMetrics={metrics} initialTrend={trend} />
    </div>
  )
}
```

**2. src/app/(dashboard)/analytics/components/analytics-view.tsx**

Client component managing state:

```tsx
'use client'

import { useState, useTransition } from 'react'
import { getOrderMetrics, getSalesTrend } from '@/app/actions/analytics'
import type { Period, OrderMetrics, SalesTrend } from '@/lib/analytics/types'
import { MetricCards } from './metric-cards'
import { SalesChart } from './sales-chart'
import { PeriodSelector } from './period-selector'

interface AnalyticsViewProps {
  initialMetrics: OrderMetrics
  initialTrend: SalesTrend
}

export function AnalyticsView({ initialMetrics, initialTrend }: AnalyticsViewProps) {
  const [period, setPeriod] = useState<Period>('7days')
  const [metrics, setMetrics] = useState(initialMetrics)
  const [trend, setTrend] = useState(initialTrend)
  const [isPending, startTransition] = useTransition()

  const handlePeriodChange = (newPeriod: Period) => {
    setPeriod(newPeriod)
    startTransition(async () => {
      const [newMetrics, newTrend] = await Promise.all([
        getOrderMetrics(newPeriod),
        getSalesTrend(newPeriod)
      ])
      setMetrics(newMetrics)
      setTrend(newTrend)
    })
  }

  return (
    <div className="space-y-6">
      <div className="flex justify-end">
        <PeriodSelector value={period} onChange={handlePeriodChange} disabled={isPending} />
      </div>

      <MetricCards metrics={metrics} loading={isPending} />

      <SalesChart data={trend.data} loading={isPending} />
    </div>
  )
}
```

**3. src/app/(dashboard)/analytics/components/metric-cards.tsx**

```tsx
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card'
import { ShoppingCart, DollarSign, TrendingUp, Receipt } from 'lucide-react'
import { Skeleton } from '@/components/ui/skeleton'
import type { OrderMetrics } from '@/lib/analytics/types'

interface MetricCardsProps {
  metrics: OrderMetrics
  loading?: boolean
}

export function MetricCards({ metrics, loading }: MetricCardsProps) {
  const formatCurrency = (value: number) =>
    new Intl.NumberFormat('es-CO', {
      style: 'currency',
      currency: 'COP',
      maximumFractionDigits: 0
    }).format(value)

  const cards = [
    {
      title: 'Total Pedidos',
      value: metrics.totalOrders.toLocaleString('es-CO'),
      icon: ShoppingCart
    },
    {
      title: 'Valor Total',
      value: formatCurrency(metrics.totalValue),
      icon: DollarSign
    },
    {
      title: 'Tasa de Conversion',
      value: `${metrics.conversionRate}%`,
      icon: TrendingUp
    },
    {
      title: 'Ticket Promedio',
      value: formatCurrency(metrics.avgTicket),
      icon: Receipt
    }
  ]

  if (loading) {
    return (
      <div className="grid gap-4 md:grid-cols-2 lg:grid-cols-4">
        {[1, 2, 3, 4].map(i => (
          <Card key={i}>
            <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
              <Skeleton className="h-4 w-24" />
              <Skeleton className="h-4 w-4" />
            </CardHeader>
            <CardContent>
              <Skeleton className="h-8 w-32" />
            </CardContent>
          </Card>
        ))}
      </div>
    )
  }

  return (
    <div className="grid gap-4 md:grid-cols-2 lg:grid-cols-4">
      {cards.map(card => {
        const Icon = card.icon
        return (
          <Card key={card.title}>
            <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
              <CardTitle className="text-sm font-medium text-muted-foreground">
                {card.title}
              </CardTitle>
              <Icon className="h-4 w-4 text-muted-foreground" />
            </CardHeader>
            <CardContent>
              <div className="text-2xl font-bold">{card.value}</div>
            </CardContent>
          </Card>
        )
      })}
    </div>
  )
}
```

**4. src/app/(dashboard)/analytics/components/sales-chart.tsx**

Follow existing usage-chart.tsx pattern:

```tsx
'use client'

import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card'
import { Skeleton } from '@/components/ui/skeleton'
import {
  ResponsiveContainer,
  AreaChart,
  Area,
  XAxis,
  YAxis,
  CartesianGrid,
  Tooltip
} from 'recharts'
import type { TrendDataPoint } from '@/lib/analytics/types'

interface SalesChartProps {
  data: TrendDataPoint[]
  loading?: boolean
}

export function SalesChart({ data, loading }: SalesChartProps) {
  const formatCurrency = (value: number) =>
    new Intl.NumberFormat('es-CO', {
      style: 'currency',
      currency: 'COP',
      maximumFractionDigits: 0,
      notation: 'compact'
    }).format(value)

  if (loading) {
    return (
      <Card>
        <CardHeader>
          <CardTitle>Tendencia de Ventas</CardTitle>
        </CardHeader>
        <CardContent>
          <Skeleton className="h-[300px] w-full" />
        </CardContent>
      </Card>
    )
  }

  return (
    <Card>
      <CardHeader>
        <CardTitle>Tendencia de Ventas</CardTitle>
      </CardHeader>
      <CardContent>
        <div className="h-[300px]">
          <ResponsiveContainer width="100%" height="100%">
            <AreaChart data={data} margin={{ top: 10, right: 10, left: 0, bottom: 0 }}>
              <defs>
                <linearGradient id="colorValue" x1="0" y1="0" x2="0" y2="1">
                  <stop offset="5%" stopColor="#3b82f6" stopOpacity={0.3} />
                  <stop offset="95%" stopColor="#3b82f6" stopOpacity={0} />
                </linearGradient>
              </defs>
              <CartesianGrid strokeDasharray="3 3" className="stroke-muted" />
              <XAxis
                dataKey="label"
                tick={{ fontSize: 12 }}
                tickLine={false}
                axisLine={false}
              />
              <YAxis
                tickFormatter={formatCurrency}
                tick={{ fontSize: 12 }}
                tickLine={false}
                axisLine={false}
                width={80}
              />
              <Tooltip
                content={({ active, payload, label }) => {
                  if (!active || !payload?.length) return null
                  const data = payload[0].payload as TrendDataPoint
                  return (
                    <div className="bg-popover border rounded-md shadow-md p-3">
                      <p className="font-medium">{label}</p>
                      <p className="text-sm text-muted-foreground">
                        {data.orders} pedidos
                      </p>
                      <p className="text-sm font-medium">
                        {formatCurrency(data.value)}
                      </p>
                    </div>
                  )
                }}
              />
              <Area
                type="monotone"
                dataKey="value"
                stroke="#3b82f6"
                fillOpacity={1}
                fill="url(#colorValue)"
                strokeWidth={2}
              />
            </AreaChart>
          </ResponsiveContainer>
        </div>
      </CardContent>
    </Card>
  )
}
```

**5. src/app/(dashboard)/analytics/components/period-selector.tsx**

Reuse pattern from costos:

```tsx
'use client'

import { Button } from '@/components/ui/button'
import { cn } from '@/lib/utils'
import type { Period } from '@/lib/analytics/types'

interface PeriodSelectorProps {
  value: Period
  onChange: (period: Period) => void
  disabled?: boolean
}

const periods: { value: Period; label: string }[] = [
  { value: 'today', label: 'Hoy' },
  { value: '7days', label: '7 dias' },
  { value: '30days', label: '30 dias' },
  { value: 'month', label: 'Este mes' },
]

export function PeriodSelector({ value, onChange, disabled }: PeriodSelectorProps) {
  return (
    <div className="flex gap-1 p-1 bg-muted rounded-lg">
      {periods.map((period) => (
        <Button
          key={period.value}
          variant="ghost"
          size="sm"
          disabled={disabled}
          onClick={() => onChange(period.value)}
          className={cn(
            'rounded-md',
            value === period.value && 'bg-background shadow-sm'
          )}
        >
          {period.label}
        </Button>
      ))}
    </div>
  )
}
```
  </action>
  <verify>
1. Navigate to /analytics as admin - page renders
2. Navigate to /analytics as agent - redirected to /crm/pedidos
3. Metric cards show correct values
4. Chart displays trend data
5. Period selector updates data
  </verify>
  <done>
Analytics dashboard functional with metrics, charts, period selection, and role-based access.
  </done>
</task>

</tasks>

<verification>
1. Admin/owner can access /analytics
2. Agent is redirected away from /analytics
3. Four metric cards display: orders, value, conversion, avg ticket
4. Sales trend chart renders with data
5. Period selector changes displayed data
6. Loading states show skeletons
7. Empty state handles gracefully (zeros, empty chart)
</verification>

<success_criteria>
- [ ] /analytics page only accessible to admin/owner
- [ ] Metric cards show total orders, value, conversion rate, avg ticket
- [ ] Trend chart displays sales data
- [ ] Period selector works (Hoy, 7 dias, 30 dias, Este mes)
- [ ] Loading states display during data fetch
- [ ] Currency formatted as COP
</success_criteria>

<output>
After completion, create `.planning/phases/10-search-tasks-analytics/10-05-SUMMARY.md`
</output>
