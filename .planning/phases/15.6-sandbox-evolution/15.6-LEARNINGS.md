# Phase 15.6: Sandbox Evolution - Learnings

**Fecha:** 2026-02-07
**Duración:** 1 día (5 plans ejecutados: 01-05, verificación Plan 06 pendiente)
**Plans ejecutados:** 5 completos + 8 bugfixes posteriores

---

## Bugs Encontrados

| Bug | Causa | Fix | Prevención |
|-----|-------|-----|------------|
| Tab toggle capturado por drag & drop | DnD capturaba todos los click events sin threshold de distancia | Agregar `PointerSensor` con 5px distancia + botón X explícito en tabs activas | Siempre usar sensors con distance threshold cuando DnD y clicks coexisten |
| CRM agent selection perdida en reset | `handleReset` solo limpiaba mensajes, no estado de agentes CRM | Agregar reset de `crmAgents` a estado inicial (todos disabled + dry-run) | Auditar todos los estados del componente al implementar reset functions |
| Contact ID no extraído en modo LIVE | Asumir `outputs.contactId` en vez de leer estructura real `outputs.data.id` | Extraer de `outputs.data.id` (estructura de executeToolFromAgent) | Revisar estructura real de responses en consola antes de asumir paths |
| Tool name incorrecto para tagging | Usar `crm.contact.tag` en vez del nombre real de la herramienta | Cambiar a `crm.tag.add` (nombre real del tool en Action DSL) | Verificar nombres de tools en codebase existente antes de hardcodear |
| Workspace hardcodeado como string | Pasar `'sandbox'` literal en vez de workspaceId real | Pasar `workspaceId` real del contexto de sesión | Evitar hardcodear IDs - siempre pasar valores reales del contexto |
| Teléfono sin formato E.164 | Enviar teléfono sin prefijo `+` al crear contacto | Agregar prefijo `+57` para Colombia (E.164 format) | Validar formatos de datos externos (teléfonos, emails) antes de enviar a APIs |
| Tool registry no inicializado en sandbox API | Sandbox API no inicializaba tool registry antes de ejecutar tools | Importar y registrar todos los tools al inicio del API route | Inicializar registries/singletons en API routes antes de usar |
| Validación de campos bloqueaba órdenes parciales | OrderManager rechazaba crear órdenes sin todos los campos (modo draft) | Eliminar validación de campos - permitir órdenes parciales | No validar datos de negocio en agentes - dejar que la DB/API valide |
| ToolResult.data no se unwrappeaba correctamente | OrderManager y OrderCreator accedian a `result` directo en vez de `result.data` | Commit `f6b9538`: Extraer datos de `ToolResult.data` correctamente | ToolResult<T> wrappea datos en `.data` - siempre unwrap antes de usar |
| Stage NUEVO PEDIDO + contactos test- reutilizados | Ordenes se creaban sin stage (null), y contactos existentes no se prefijaban con test- | Commit `adc5a76`: Usar stage NUEVO PEDIDO por defecto + agregar prefijo test- en contactos reutilizados | Siempre asignar stage default al crear ordenes; prefijo test- debe aplicar a TODOS los datos en sandbox |

## Decisiones Técnicas

| Decisión | Alternativas Descartadas | Razón |
|----------|-------------------------|-------|
| ModelTokenEntry usa ClaudeModel type | Usar `string` para campo model | Type safety - evita typos en nombres de modelos |
| Aproximar split 70/30 input/output para orchestrator | Esperar a que SomnioOrchestrator exponga split exacto | Aceptable para sandbox debug - no afecta producción |
| IngestStatus.timeline requerido (no optional) | Hacer timeline opcional | Simplifica consumer code - evita null checks en todos lados |
| Retornar tokenDetails como array | Retornar single ModelTokenEntry | Soporta multi-call scenarios (reanalyze puede hacer varias llamadas) |
| No modificar SomnioOrchestrator/SomnioEngine | Agregar per-model tracking a producción | Solo sandbox necesita este nivel de detalle - evitar complejidad innecesaria |
| CRM agents vía API route | Importar registry directamente en client | Registry es server-only - client/server boundary clara |
| Self-registration pattern para CRM agents | Registry manual en archivo central | Extensibilidad - nuevos agentes solo agregan su archivo |
| ToolExecution.mode opcional | Requerir mode en todos los tools | Backward compatible - solo CRM tools usan mode |
| Max 3 paneles visibles | Permitir todos los tabs simultáneamente | UX - evitar sobrecarga visual, mantener focus |
| Default tabs: Tools + Estado | Guardar preferencia del usuario | Simplicidad - consistencia entre sesiones |
| @dnd-kit para drag & drop | react-beautiful-dnd, react-dnd | Mejor mantenida, mejor DX, hooks modernos |
| Radix UI Slider vía shadcn | Componente custom | Consistencia con UI kit existente |
| Live mode usa workspace='sandbox' | Crear workspace separado para testing | Reusar infraestructura existente - datos test-prefixed son suficientes |
| Prefijo `test-` en nombres | Flag en metadata de registros | Más visible - fácil filtrar en queries |

## Problemas de Integración

| Componente A | Componente B | Problema | Solución |
|--------------|--------------|----------|----------|
| TabBar drag & drop | Tab toggle clicks | DnD capturaba clicks antes de que llegaran al button onClick | PointerSensor con 5px threshold + botón X explícito |
| CrmOrchestrator | OrderManagerAgent.executeLive | executeToolFromAgent retorna outputs.data.id, no outputs.id | Actualizar path de extracción a outputs.data.id |
| Sandbox API route | Tool registry | Tools no registrados al momento de ejecutar CRM live mode | Importar toolRegistry al inicio del route |
| OrderManagerAgent | Action DSL tools | Nombres de tools asumidos vs reales (crm.contact.tag vs crm.tag.add) | Verificar nombres en codebase, actualizar hardcoded strings |
| SandboxEngine | CrmOrchestrator | Orquestador llamado incluso cuando CRM agents disabled | Conditional: solo llamar si shouldCreateOrder Y order-manager en crmModes |
| IngestTab timeline | MessageClassifier | Timeline vacía sin llamadas a handleIngestMode | Poblar timeline en handleIngestMode y checkImplicitYes |
| TokensTab | DebugTurn | Turns antiguos sin field models | Usar optional chaining (?.) para backward compatibility |
| SandboxHeader CRM dropdown | SandboxLayout | Estado de CRM agents no compartido entre componentes | Lift state up a layout, pasar via props a header |

## Tips para Futuros Agentes

### Lo que funcionó bien
- **Backward compatibility pattern**: agregar campos nuevos (tokenDetail) junto a existentes (tokensUsed) - cero breaking changes
- **Type-first approach**: definir todos los types en Plan 01 antes de implementar UI/logic - evitó refactors
- **Per-model token tracking**: ModelTokenEntry[] acumulado en array - extensible a N modelos
- **Self-registration pattern**: cada agente CRM se registra al importarse - cero config central
- **Mode-annotated tools**: ToolExecution.mode opcional permite dry-run/live coexistir con tools normales
- **API route para CRM agents**: client/server boundary clara - registry server-only accesible desde client
- **Prefijo test-**: visible, simple, fácil de filtrar en queries - mejor que flags en metadata
- **Commits atómicos**: cada task = 1 commit - fácil de revertir si algo falla
- **Mock data generators**: BaseCrmAgent provee utilities - DRY para nuevos agentes

### Lo que NO hacer
- **NO asumir paths de datos**: siempre revisar estructura real en consola (outputs.data.id vs outputs.id)
- **NO hardcodear IDs**: usar valores reales del contexto (workspaceId, no 'sandbox')
- **NO hardcodear nombres de tools**: verificar en codebase antes de asumir (crm.tag.add vs crm.contact.tag)
- **NO olvidar inicializar registries**: importar y registrar al inicio de API routes
- **NO validar datos de negocio en agentes**: dejar que DB/APIs validen - agentes solo orquestan
- **NO usar DnD sin sensors configurados**: siempre PointerSensor con threshold cuando hay clicks
- **NO modificar producción para features de debug**: sandbox-only features se quedan en sandbox
- **NO hacer fields opcionales si simplifican consumers**: timeline requerido evitó null checks everywhere
- **NO guardar estado de UI entre sesiones** (en sandbox): layout default siempre - consistencia > conveniencia

### Patrones a seguir
- **Per-model tracking propagation**: ClaudeClient → IntentDetector → SandboxEngine → DebugTurn
- **CRM agent composition**: CrmAgent interface → BaseCrmAgent abstract → AgentImpl concrete
- **Multi-panel debug**: TabBar (controls) + PanelContainer (rendering) composition
- **Mode annotation**: ToolExecution.mode opcional - graceful degradation para non-CRM tools
- **Timeline accumulation**: push IngestTimelineEntry en cada clasificación - audit trail completo
- **Timer presets + sliders**: ToggleGroup para presets, Slider para fine-tuning override
- **Approximate token split**: cuando API no expone split exacto, usar heurística razonable (70/30)
- **Self-registration**: import barrel file → side-effect registers agents → zero config
- **State lifting**: parent layout maneja estado complejo, pasa a children via props
- **Conditional orchestration**: verificar precondiciones (shouldCreateOrder Y agent enabled) antes de llamar

### Comandos útiles
```bash
# Ver estructura de outputs de executeToolFromAgent
console.log(JSON.stringify(outputs, null, 2))

# Verificar nombres de tools registrados
grep -r "toolName:" src/lib/tools/

# Ver commits de una fase específica
git log --oneline --all --grep="15.6" | head -30

# Filtrar datos de testing en DB
SELECT * FROM orders WHERE name LIKE 'test-%';

# Ver tipos exportados de un módulo
grep -A5 "export.*interface\|export.*type" src/lib/agents/types.ts

# Verificar client/server boundary violations
grep -r "crmAgentRegistry" src/app/  # debería solo estar en API routes

# Debug drag & drop sensors
console.log(sensors.map(s => s.constructor.name))
```

## Deuda Técnica Identificada

| Item | Prioridad | Fase sugerida |
|------|-----------|---------------|
| SomnioOrchestrator no expone input/output token split | Baja | 16.x (si tokens reales importan) |
| Layout de debug panels no persiste entre sesiones | Baja | 17.x (UX polish) |
| Aproximación 70/30 para orchestrator tokens | Baja | 16.x (cuando orchestrator refactor) |
| Hardcoded timer preset values (sin config) | Media | 16.x (cuando agreguemos user settings) |
| Hardcoded Colombia phone prefix (+57) | Media | 16.x (soporte multi-país) |
| CRM agent icons hardcoded en TabBar | Baja | 17.x (cuando haya 5+ agentes CRM) |
| No hay logs de CRM tool execution en production | Media | 16.x (observability) |
| Mock data generators usan IDs secuenciales | Baja | Cuando sea confuso en testing |
| IngestTab timeline no pagina (podría crecer infinito) | Media | 16.x (cuando sesiones largas) |
| No hay cleanup de datos test- en DB | Media | 16.x (agregar cron job?) |

## Notas para el Módulo

Información específica que un agente de documentación de este módulo necesitaría saber:

- **Sandbox Evolution** es la 6ta iteración del sandbox (15.6 bajo Phase 15: Agent Sandbox)
- El sandbox ahora distingue entre **agentes conversacionales** (Somnio) y **agentes CRM** (Order Manager, etc.)
- **Multi-panel debug UI** permite hasta 3 paneles simultáneos con drag & drop reordering
- **Per-model token tracking**: cada DebugTurn tiene `tokens.models: ModelTokenEntry[]` con breakdown Haiku/Sonnet
- **IngestTab** muestra timeline de clasificación + timer controls (3 presets + sliders)
- **CRM agents** usan **self-registration pattern** - importar barrel file los registra automáticamente
- **Dry-run vs Live**: dry-run genera mocks, live ejecuta tools reales con prefijo `test-`
- **OrderManagerAgent** tiene 3 modos: full (8 campos + pack), no_promo (8 campos sin pack), draft (nombre + teléfono)
- **Action DSL integration**: live mode usa `executeToolFromAgent` con workspace real (no hardcoded)
- **Tool naming**: usar nombres reales del Action DSL (crm.tag.add no crm.contact.tag)
- **Datos de testing**: todos llevan prefijo `test-` en nombre - fácil de filtrar/limpiar
- **Client/server boundary**: CRM agent registry es server-only, expuesto via `/api/sandbox/crm-agents`
- **Backward compatibility**: nuevos fields son opcionales o adiciones (nunca breaking changes)
- **Default UI state**: Tools + Estado visibles por defecto, layout no persiste entre sesiones
- **Max 3 panels enforced**: handleToggleTab previene abrir 4to panel
- **DnD UX**: PointerSensor con 5px threshold previene robo de clicks, botón X para cerrar explícito
- **Timeline pattern**: IngestStatus.timeline acumula IngestTimelineEntry en cada clasificación
- **E.164 phone format**: teléfonos llevan prefijo `+57` (Colombia) antes de crear contactos
- **Tool registry initialization**: API routes deben importar registry antes de ejecutar tools
- **No field validation in agents**: OrderManager no valida campos - permite órdenes parciales
- **8 bugfixes post-implementation**: todos menores, mayoría relacionados a assumptions vs realidad

---
*Generado al completar la fase. Input para entrenamiento de agentes de documentación.*
