---
phase: 07-whatsapp-core
plan: 03
type: execute
wave: 2
depends_on: ["07-01"]
files_modified:
  - src/app/(dashboard)/whatsapp/components/chat-view.tsx
  - src/app/(dashboard)/whatsapp/components/message-bubble.tsx
  - src/app/(dashboard)/whatsapp/components/message-input.tsx
  - src/app/(dashboard)/whatsapp/components/chat-header.tsx
  - src/app/(dashboard)/whatsapp/components/media-preview.tsx
  - src/app/(dashboard)/whatsapp/components/emoji-picker.tsx
  - src/app/actions/messages.ts
autonomous: true

must_haves:
  truths:
    - "User can view complete message history of a conversation"
    - "User can send text messages within 24h window"
    - "User sees message status (sent, delivered, read)"
    - "Messages display in chat-style bubbles with timestamps"
    - "Media messages show inline previews"
  artifacts:
    - path: "src/app/(dashboard)/whatsapp/components/chat-view.tsx"
      provides: "Message list with virtualization"
      min_lines: 80
    - path: "src/app/(dashboard)/whatsapp/components/message-bubble.tsx"
      provides: "Individual message rendering"
      min_lines: 50
    - path: "src/app/(dashboard)/whatsapp/components/message-input.tsx"
      provides: "Message composition with attachments"
      min_lines: 60
    - path: "src/app/actions/messages.ts"
      provides: "Server Actions for message operations"
      exports: ["getMessages", "sendMessage"]
  key_links:
    - from: "src/app/(dashboard)/whatsapp/components/message-input.tsx"
      to: "src/app/actions/messages.ts"
      via: "sendMessage action call"
      pattern: "sendMessage\\("
    - from: "src/app/actions/messages.ts"
      to: "src/lib/whatsapp/api.ts"
      via: "360dialog API call"
      pattern: "sendTextMessage\\("
---

<objective>
Build the chat view: message history with virtualized rendering, message composition with emoji picker and attachments, and the sending flow with 24h window enforcement.

Purpose: Users can view message history and send messages within the 24-hour window - the center column of the 3-column layout.

Output: Chat view components, message input, Server Actions for sending.
</objective>

<execution_context>
@/home/jose147/.claude/get-shit-done/workflows/execute-plan.md
@/home/jose147/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-whatsapp-core/07-RESEARCH.md
@.planning/phases/07-whatsapp-core/07-CONTEXT.md
@.planning/phases/07-whatsapp-core/07-01-SUMMARY.md

# Existing patterns
@src/app/(dashboard)/crm/pedidos/components/order-form.tsx
@src/components/ui/textarea.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install dependencies and create message Server Actions</name>
  <files>src/app/actions/messages.ts</files>
  <action>
1. Install required packages:
```bash
pnpm add @tanstack/react-virtual frimousse
```

2. Create messages.ts Server Actions:

**getMessages(conversationId: string, limit = 100, before?: string):**
- Get workspace from cookie
- Verify conversation belongs to workspace
- Query messages by conversation_id
- Order by timestamp ASC (oldest first for chat)
- If before provided, use cursor pagination (timestamp < before)
- Return messages array

**sendMessage(conversationId: string, text: string):**
- Get workspace from cookie
- Get conversation (phone, last_customer_message_at)
- Check 24h window using differenceInHours from date-fns:
  - If closed (>24h), return { error: 'Ventana de 24h cerrada. Usa un template.' }
- Get workspace settings (whatsapp_api_key)
- Call sendTextMessage from @/lib/whatsapp/api
- Insert message to DB with status 'sent', direction 'outbound'
- Update conversation last_message_at, last_message_preview
- Revalidate path
- Return { success: true, messageId }

**sendMediaMessage(conversationId: string, file: File, caption?: string):**
- Similar to sendMessage but for media
- First upload file to Supabase Storage (bucket: 'whatsapp-media')
- Get public URL
- Call sendMediaMessage from api.ts with URL
- Store our URL in media_url field
- Return { success: true, messageId }

Use ActionResult<T> pattern from orders.ts.
  </action>
  <verify>
```bash
pnpm list @tanstack/react-virtual frimousse
grep "export async function" src/app/actions/messages.ts
```
Should list: getMessages, sendMessage, sendMediaMessage

TypeScript compiles: `cd morfx && npx tsc --noEmit`
  </verify>
  <done>
Dependencies installed. Server Actions exist for getting and sending messages with 24h window check.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create chat view with virtualized message list</name>
  <files>
src/app/(dashboard)/whatsapp/components/chat-view.tsx
src/app/(dashboard)/whatsapp/components/message-bubble.tsx
src/app/(dashboard)/whatsapp/components/chat-header.tsx
src/app/(dashboard)/whatsapp/components/media-preview.tsx
  </files>
  <action>
**chat-view.tsx (Client Component):**

- Props: conversationId (string | null), conversation (ConversationWithDetails | null)
- If no conversationId: show empty state "Selecciona una conversacion"
- Use useMessages(conversationId) hook for real-time messages
- TanStack Virtual setup:
  ```tsx
  const parentRef = useRef<HTMLDivElement>(null)
  const virtualizer = useVirtualizer({
    count: messages.length,
    getScrollElement: () => parentRef.current,
    estimateSize: () => 80,
    measureElement: (el) => el.getBoundingClientRect().height,
    overscan: 5,
  })
  ```
- Scroll to bottom on new messages (useEffect with messages.length)
- Render ChatHeader at top
- Virtual list container with position: relative
- Map virtualizer.getVirtualItems() -> MessageBubble
- MessageInput at bottom

**message-bubble.tsx:**

- Props: message, isOwn (direction === 'outbound')
- Layout: flex with justify-end for own, justify-start for received
- Bubble styling:
  - Own: bg-primary text-primary-foreground, rounded-lg rounded-br-none
  - Received: bg-muted, rounded-lg rounded-bl-none
- Content rendering by type:
  - text: message.content.text
  - image/video: MediaPreview component
  - document: file icon + filename
  - audio: audio player
- Timestamp below bubble (small, muted)
- Status indicator for outbound (sent/delivered/read checkmarks)

**chat-header.tsx:**

- Props: conversation
- Display: Contact name (or phone), WindowIndicator
- Actions (icons):
  - Archive (archive icon)
  - Mark as read (check icon)
  - Open in CRM (external link icon, links to /crm/contactos/[contact_id])
- Use Button variant="ghost" size="icon"

**media-preview.tsx:**

- Props: type, url, filename, mimeType
- image: <img> with object-cover, onClick opens full size
- video: <video> with controls
- document: icon + filename + download link
- audio: <audio> with controls
- Handle loading states

**Background pattern (per CONTEXT.md):**
Add subtle geometric/math pattern to chat container:
```css
.chat-bg {
  background-color: hsl(var(--background));
  background-image: url("data:image/svg+xml,..."); /* subtle geometric pattern */
  background-size: 100px 100px;
  opacity: 0.03; /* very subtle */
}
```
Or use a pseudo-element for the pattern overlay.
  </action>
  <verify>
```bash
ls src/app/\(dashboard\)/whatsapp/components/
grep "useVirtualizer" src/app/\(dashboard\)/whatsapp/components/chat-view.tsx
grep "MessageBubble" src/app/\(dashboard\)/whatsapp/components/message-bubble.tsx
```
TypeScript compiles: `cd morfx && npx tsc --noEmit`
  </verify>
  <done>
Chat view renders messages with virtualization, bubbles styled appropriately, header shows actions.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create message input with emoji picker and attachments</name>
  <files>
src/app/(dashboard)/whatsapp/components/message-input.tsx
src/app/(dashboard)/whatsapp/components/emoji-picker.tsx
  </files>
  <action>
**message-input.tsx (Client Component):**

- Props: conversationId, isWindowOpen (boolean), onSend (callback)
- State: text, isLoading, showEmojiPicker
- Disabled state when window closed:
  - Show "Ventana cerrada" text
  - Button "Usar template" (links to template selector - placeholder for Phase 8)
  - Input disabled
- When window open:
  - Textarea (auto-expand, max 5 lines)
  - Keyboard: Enter sends, Shift+Enter newline
  - Left buttons: Attach file (paperclip icon), Emoji picker (smile icon)
  - Right button: Send (paper-plane icon)
- Attach file flow:
  - Hidden <input type="file" accept="image/*,video/*,audio/*,.pdf,.doc,.docx,.xls,.xlsx">
  - On file select: call sendMediaMessage action
  - Show loading indicator
- Emoji picker:
  - Toggle popover with EmojiPicker component
  - On select: insert emoji at cursor position

**emoji-picker.tsx:**

Use frimousse (lightweight, shadcn-compatible):
```tsx
import { Emoji, EmojiPicker as FrimousseEmojiPicker } from 'frimousse'

export function EmojiPicker({ onSelect }: { onSelect: (emoji: string) => void }) {
  return (
    <FrimousseEmojiPicker.Root
      onEmojiSelect={(emoji) => onSelect(emoji.emoji)}
      className="..."
    >
      <FrimousseEmojiPicker.Search />
      <FrimousseEmojiPicker.Viewport>
        <FrimousseEmojiPicker.Category />
      </FrimousseEmojiPicker.Viewport>
    </FrimousseEmojiPicker.Root>
  )
}
```
Style to match shadcn theme (bg-popover, border, etc.).

**Integration with inbox-layout.tsx:**

Update InboxLayout to:
1. Pass selectedConversation to ChatView
2. Calculate isWindowOpen from conversation.last_customer_message_at
3. Handle onSend callback to refresh conversation
  </action>
  <verify>
```bash
grep "EmojiPicker" src/app/\(dashboard\)/whatsapp/components/emoji-picker.tsx
grep "MessageInput" src/app/\(dashboard\)/whatsapp/components/message-input.tsx
grep "Textarea\|textarea" src/app/\(dashboard\)/whatsapp/components/message-input.tsx
```
TypeScript compiles: `cd morfx && npx tsc --noEmit`
  </verify>
  <done>
Message input sends text on Enter, supports emoji picker, shows disabled state when window closed.
  </done>
</task>

</tasks>

<verification>
1. Navigate to /whatsapp and select a conversation
2. Messages display in chat bubbles (if any exist)
3. Scroll is smooth with virtualization
4. Can type message and see it in textarea
5. Enter sends message (if window open)
6. Message appears in list after sending
7. Emoji picker opens and inserts emoji
8. Attach button opens file picker
9. When window closed, input is disabled with template button

Full flow test:
1. Simulate incoming message via webhook (or DB insert)
2. Message appears in real-time
3. Send reply within 24h window
4. Message sent and appears with status

Manual verification in dev tools:
- Only visible messages render in DOM (virtualization working)
</verification>

<success_criteria>
- [ ] Chat view displays messages with proper alignment (inbound left, outbound right)
- [ ] TanStack Virtual is set up for performance
- [ ] Messages auto-scroll to bottom on new messages
- [ ] Text messages can be sent via Enter key
- [ ] Shift+Enter creates newline
- [ ] Emoji picker works and inserts emoji
- [ ] File attachment triggers file picker
- [ ] 24h window check prevents sending when closed
- [ ] Input shows disabled state with template button when window closed
- [ ] Message status shows for outbound messages
- [ ] Media messages show preview
</success_criteria>

<output>
After completion, create `.planning/phases/07-whatsapp-core/07-03-SUMMARY.md`
</output>
