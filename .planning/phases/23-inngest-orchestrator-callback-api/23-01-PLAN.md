---
phase: 23-inngest-orchestrator-callback-api
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/inngest/events.ts
  - src/lib/automations/types.ts
  - src/lib/automations/constants.ts
  - src/lib/automations/trigger-emitter.ts
  - src/lib/automations/variable-resolver.ts
  - src/inngest/functions/automation-runner.ts
  - src/app/api/inngest/route.ts
autonomous: true

must_haves:
  truths:
    - "robot.coord.completed aparece como trigger disponible en TRIGGER_CATALOG"
    - "Automation runner para robot.coord.completed se registra en Inngest serve()"
    - "emitRobotCoordCompleted envia evento a Inngest con cascade depth check"
    - "buildTriggerContext mapea datos de robot.coord.completed a namespace orden/contacto"
    - "robot/job.batch_completed event type existe en RobotEvents"
  artifacts:
    - path: "src/inngest/events.ts"
      provides: "robot/job.batch_completed event type + automation/robot.coord.completed event type"
      contains: "robot/job.batch_completed"
    - path: "src/lib/automations/types.ts"
      provides: "robot.coord.completed in TriggerType union"
      contains: "robot.coord.completed"
    - path: "src/lib/automations/constants.ts"
      provides: "TRIGGER_CATALOG + VARIABLE_CATALOG entries for robot.coord.completed"
      contains: "robot.coord.completed"
    - path: "src/lib/automations/trigger-emitter.ts"
      provides: "emitRobotCoordCompleted function"
      exports: ["emitRobotCoordCompleted"]
    - path: "src/lib/automations/variable-resolver.ts"
      provides: "Mapping for trackingNumber, carrier to orden namespace"
      contains: "trackingNumber"
    - path: "src/inngest/functions/automation-runner.ts"
      provides: "robotCoordCompletedRunner in automationFunctions"
      contains: "robot.coord.completed"
    - path: "src/app/api/inngest/route.ts"
      provides: "TODO placeholder for orchestrator registration (Plan 23-02)"
      contains: "TODO(Phase 23-02)"
  key_links:
    - from: "src/lib/automations/trigger-emitter.ts"
      to: "src/inngest/events.ts"
      via: "inngest.send with automation/robot.coord.completed event"
      pattern: "automation/robot\\.coord\\.completed"
    - from: "src/inngest/functions/automation-runner.ts"
      to: "src/lib/automations/types.ts"
      via: "TriggerType includes robot.coord.completed"
      pattern: "robot\\.coord\\.completed"
---

<objective>
Register the `robot.coord.completed` automation trigger type and the `robot/job.batch_completed` Inngest event across all automation system files, so the automation engine can process robot completion events and the orchestrator (Plan 02) can wait for batch completion signals.

Purpose: This is the foundation layer -- all downstream plans (orchestrator and callback API) depend on these types and registrations existing.
Output: Updated type system, trigger catalog, emitter, variable resolver, automation runner, and Inngest serve registration.
</objective>

<execution_context>
@/home/jose147/.claude/get-shit-done/workflows/execute-plan.md
@/home/jose147/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/23-inngest-orchestrator-callback-api/23-RESEARCH.md

# Key source files (read ALL before editing)
@src/inngest/events.ts
@src/lib/automations/types.ts
@src/lib/automations/constants.ts
@src/lib/automations/trigger-emitter.ts
@src/lib/automations/variable-resolver.ts
@src/inngest/functions/automation-runner.ts
@src/app/api/inngest/route.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add event types and trigger type registration</name>
  <files>
    src/inngest/events.ts
    src/lib/automations/types.ts
    src/lib/automations/constants.ts
  </files>
  <action>
**1. src/inngest/events.ts** -- Add `robot/job.batch_completed` to `RobotEvents`:

```typescript
/**
 * Emitted by callback API when all items in a batch have been processed.
 * Consumed by robot-orchestrator via step.waitForEvent() to unblock.
 */
'robot/job.batch_completed': {
  data: {
    jobId: string
    workspaceId: string
    successCount: number
    errorCount: number
  }
}
```

Also add `automation/robot.coord.completed` to `AutomationEvents`:

```typescript
'automation/robot.coord.completed': {
  data: {
    workspaceId: string
    orderId: string
    orderName?: string
    trackingNumber: string
    carrier: string
    contactId: string | null
    contactName?: string
    contactPhone?: string
    contactEmail?: string
    orderValue?: number
    shippingCity?: string
    shippingAddress?: string
    shippingDepartment?: string
    cascadeDepth: number
  }
}
```

**2. src/lib/automations/types.ts** -- Add `'robot.coord.completed'` to the `TriggerType` union (append after `'shopify.order_updated'`).

**3. src/lib/automations/constants.ts** -- Add entry to `TRIGGER_CATALOG` array (after shopify.order_updated entry):

```typescript
{
  type: 'robot.coord.completed',
  label: 'Robot Coordinadora completado',
  category: 'Logistica',
  description: 'Se dispara cuando el robot crea exitosamente un pedido en Coordinadora',
  configFields: [],
  variables: [
    'orden.id', 'orden.nombre', 'orden.valor',
    'orden.tracking_number', 'orden.carrier',
    'orden.ciudad_envio', 'orden.direccion_envio', 'orden.departamento_envio',
    'contacto.nombre', 'contacto.telefono', 'contacto.email',
  ],
},
```

Add entry to `VARIABLE_CATALOG` object:

```typescript
'robot.coord.completed': [
  { path: 'orden.id', label: 'ID de la orden' },
  { path: 'orden.nombre', label: 'Nombre/referencia de la orden' },
  { path: 'orden.valor', label: 'Valor total' },
  { path: 'orden.tracking_number', label: 'Numero de pedido Coordinadora' },
  { path: 'orden.carrier', label: 'Transportadora' },
  { path: 'orden.ciudad_envio', label: 'Ciudad de envio' },
  { path: 'orden.direccion_envio', label: 'Direccion de envio' },
  { path: 'orden.departamento_envio', label: 'Departamento de envio' },
  { path: 'contacto.nombre', label: 'Nombre del contacto' },
  { path: 'contacto.telefono', label: 'Telefono del contacto' },
  { path: 'contacto.email', label: 'Email del contacto' },
],
```

**IMPORTANT:** constants.ts has ZERO imports (prevents circular deps). Do NOT add any imports.
  </action>
  <verify>Run `npx tsc --noEmit` -- no TypeScript errors. Grep for 'robot.coord.completed' in types.ts, constants.ts, and events.ts -- all three files contain it.</verify>
  <done>TriggerType union includes robot.coord.completed, TRIGGER_CATALOG has the Logistica entry, VARIABLE_CATALOG has the variable mapping, events.ts has both robot/job.batch_completed and automation/robot.coord.completed.</done>
</task>

<task type="auto">
  <name>Task 2: Add trigger emitter, variable resolver mapping, and automation runner</name>
  <files>
    src/lib/automations/trigger-emitter.ts
    src/lib/automations/variable-resolver.ts
    src/inngest/functions/automation-runner.ts
    src/app/api/inngest/route.ts
  </files>
  <action>
**1. src/lib/automations/trigger-emitter.ts** -- Add `emitRobotCoordCompleted` function. Follow the exact pattern of existing emitters (e.g., emitOrderStageChanged). Add at end of file, before no other section:

```typescript
// ============================================================================
// Robot Trigger Emitters (Phase 23: Inngest Orchestrator + Callback API)
// ============================================================================

/**
 * Emit when the robot successfully creates a shipment on Coordinadora for an order.
 * Fires per-order (not per-batch) so automations run per order.
 */
export async function emitRobotCoordCompleted(data: {
  workspaceId: string
  orderId: string
  orderName?: string
  trackingNumber: string
  carrier: string
  contactId: string | null
  contactName?: string
  contactPhone?: string
  contactEmail?: string
  orderValue?: number
  shippingCity?: string
  shippingAddress?: string
  shippingDepartment?: string
  cascadeDepth?: number
}): Promise<void> {
  const depth = data.cascadeDepth ?? 0
  if (isCascadeSuppressed('robot.coord.completed', data.workspaceId, depth)) return

  await sendEvent(
    'automation/robot.coord.completed',
    { ...data, cascadeDepth: depth },
    'robot.coord.completed',
    data.workspaceId
  )
}
```

**2. src/lib/automations/variable-resolver.ts** -- In `buildTriggerContext`, add mappings for `trackingNumber` and `carrier` to the `orden` namespace. Insert AFTER the existing `orden.descripcion` mapping (around line 176):

```typescript
if (eventData.trackingNumber !== undefined) orden.tracking_number = eventData.trackingNumber
if (eventData.carrier !== undefined) orden.carrier = eventData.carrier
```

These two lines ensure `{{orden.tracking_number}}` and `{{orden.carrier}}` resolve correctly in automation templates.

**3. src/inngest/functions/automation-runner.ts** -- Three changes:

a) Add to `EVENT_TO_TRIGGER` map:
```typescript
'automation/robot.coord.completed': 'robot.coord.completed',
```

b) Add `'robot.coord.completed'` to the "no config filters" case list in `matchesTriggerConfig` switch (alongside `contact.created`, `task.completed`, etc.).

c) Add the runner instance and export. After the Shopify runners section:

```typescript
// Robot runners (Phase 23: Inngest Orchestrator + Callback API)
const robotCoordCompletedRunner = createAutomationRunner(
  'robot.coord.completed',
  'automation/robot.coord.completed'
)
```

Add `robotCoordCompletedRunner` to the `automationFunctions` export array.

d) Add order enrichment for robot.coord.completed trigger. In the `needsOrderEnrichment` check, add the robot trigger:

Change:
```typescript
const needsOrderEnrichment =
  (triggerType === 'order.created' || triggerType === 'order.stage_changed') &&
  eventData.orderId
```
To:
```typescript
const needsOrderEnrichment =
  (triggerType === 'order.created' || triggerType === 'order.stage_changed' || triggerType === 'robot.coord.completed') &&
  eventData.orderId
```

**4. src/app/api/inngest/route.ts** -- Import the robot orchestrator function (will be created in Plan 02) by adding a future-safe import. For now, just add the import line commented out with a TODO:

Actually, do NOT add the orchestrator import yet (it doesn't exist). Instead, just verify the automation runner already gets auto-included through `automationFunctions` export. The new `robotCoordCompletedRunner` was added to `automationFunctions` in step 3c, so it's already served. No change needed to route.ts for the automation runner.

However, add a placeholder import comment for the orchestrator that Plan 02 will add:
```typescript
// TODO(Phase 23-02): import { robotOrchestratorFunctions } from '@/inngest/functions/robot-orchestrator'
```
  </action>
  <verify>Run `npx tsc --noEmit` -- no TypeScript errors. Grep for 'emitRobotCoordCompleted' in trigger-emitter.ts -- function exists. Grep for 'robotCoordCompletedRunner' in automation-runner.ts -- exists in export array. Grep for 'tracking_number' in variable-resolver.ts -- mapping exists.</verify>
  <done>emitRobotCoordCompleted emitter function exists, variable resolver maps trackingNumber and carrier to orden namespace, automation runner has robot.coord.completed in EVENT_TO_TRIGGER map and matchesTriggerConfig switch, robotCoordCompletedRunner is in automationFunctions export array, and order enrichment fires for robot.coord.completed trigger.</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with no errors
2. `grep -r 'robot.coord.completed' src/` returns hits in: types.ts, constants.ts, trigger-emitter.ts, automation-runner.ts, events.ts
3. `grep -r 'robot/job.batch_completed' src/` returns hit in events.ts
4. `grep 'tracking_number' src/lib/automations/variable-resolver.ts` returns mapping line
5. `grep 'robotCoordCompletedRunner' src/inngest/functions/automation-runner.ts` returns definition and export
</verification>

<success_criteria>
- TypeScript compiles without errors
- robot.coord.completed is a valid TriggerType that can be used in automation creation
- The automation runner for robot.coord.completed is registered in Inngest serve()
- Variable resolver supports {{orden.tracking_number}} and {{orden.carrier}} templates
- emitRobotCoordCompleted sends events through the standard cascade-checked pipeline
- robot/job.batch_completed event type is defined for the orchestrator to use
</success_criteria>

<output>
After completion, create `.planning/phases/23-inngest-orchestrator-callback-api/23-01-SUMMARY.md`
</output>
