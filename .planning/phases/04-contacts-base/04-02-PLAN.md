---
phase: 04-contacts-base
plan: 02
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - src/app/(dashboard)/crm/contactos/page.tsx
  - src/app/(dashboard)/crm/contactos/components/contacts-table.tsx
  - src/app/(dashboard)/crm/contactos/components/columns.tsx
  - src/app/(dashboard)/crm/contactos/components/contact-form.tsx
  - src/app/(dashboard)/crm/contactos/components/contact-dialog.tsx
  - src/app/(dashboard)/crm/contactos/components/empty-state.tsx
  - src/app/(dashboard)/crm/contactos/components/bulk-actions.tsx
  - src/app/(dashboard)/crm/contactos/[id]/page.tsx
  - src/components/ui/data-table.tsx
  - src/components/contacts/phone-input.tsx
  - src/components/contacts/city-combobox.tsx
autonomous: true

must_haves:
  truths:
    - "User can view a list of all contacts in their workspace"
    - "User can create a new contact with name, phone, email, address, and city"
    - "User can edit and delete contacts"
    - "Table displays Name, Phone, City, Tags, Last contact columns"
    - "Empty state shows when no contacts exist"
  artifacts:
    - path: "src/app/(dashboard)/crm/contactos/page.tsx"
      provides: "Contact list page with data fetching"
      min_lines: 20
    - path: "src/app/(dashboard)/crm/contactos/components/contacts-table.tsx"
      provides: "TanStack Table wrapper with sorting and selection"
      min_lines: 80
    - path: "src/app/(dashboard)/crm/contactos/components/columns.tsx"
      provides: "Column definitions with sorting headers"
      exports: ["columns"]
    - path: "src/app/(dashboard)/crm/contactos/components/contact-form.tsx"
      provides: "Contact create/edit form with validation"
      min_lines: 60
    - path: "src/components/contacts/phone-input.tsx"
      provides: "Phone input with formatting feedback"
      min_lines: 30
  key_links:
    - from: "src/app/(dashboard)/crm/contactos/page.tsx"
      to: "src/app/actions/contacts.ts"
      via: "getContacts import"
      pattern: "import.*getContacts.*from.*actions/contacts"
    - from: "src/app/(dashboard)/crm/contactos/components/contact-form.tsx"
      to: "src/app/actions/contacts.ts"
      via: "createContact/updateContact actions"
      pattern: "import.*(createContact|updateContact).*from.*actions/contacts"
    - from: "src/app/(dashboard)/crm/contactos/components/columns.tsx"
      to: "@tanstack/react-table"
      via: "ColumnDef import"
      pattern: "import.*ColumnDef.*from.*@tanstack/react-table"
---

<objective>
Build the contact list UI with TanStack Table, contact forms, and detail page.

Purpose: Create the primary CRM interface that users interact with daily. The data table must feel modern (like Linear/Notion) with sorting, selection, and bulk actions. Forms enable contact creation and editing with phone normalization feedback.

Output:
- /crm/contactos route with TanStack Table listing all contacts
- Column definitions with sortable headers (Name, Phone, City, Tags)
- Row selection with checkboxes for bulk operations
- Contact form with React Hook Form + Zod validation
- Quick edit dialog modal for rapid edits
- Detail page /crm/contactos/[id] for full contact view
- Empty state with friendly CTA
- Phone input with real-time normalization feedback
- City combobox with Colombian cities autocomplete
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-contacts-base/04-CONTEXT.md
@.planning/phases/04-contacts-base/04-RESEARCH.md
@.planning/phases/04-contacts-base/04-01-SUMMARY.md

# Phase 1 form patterns
@src/app/(auth)/login/page.tsx

# Existing dashboard layout
@src/app/(dashboard)/layout.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add TanStack Table and create data table base component</name>
  <files>
    - package.json
    - src/components/ui/data-table.tsx
    - src/components/contacts/phone-input.tsx
    - src/components/contacts/city-combobox.tsx
  </files>
  <action>
1. Install TanStack Table:
   ```bash
   pnpm add @tanstack/react-table
   ```

2. Add shadcn/ui Table component (if not already present):
   ```bash
   npx shadcn@latest add table
   ```

3. Create reusable data table component `src/components/ui/data-table.tsx`:
   - Generic component: `DataTable<TData, TValue>`
   - Props: columns, data, onRowSelectionChange
   - Features:
     - Sorting (getSortedRowModel)
     - Row selection (getSelectedRowModel)
     - Column visibility (getFilteredLeafColumns)
   - Uses shadcn/ui Table components for rendering
   - Handles empty state internally (show message if data.length === 0)

4. Create phone input component `src/components/contacts/phone-input.tsx`:
   - Controlled input that shows normalization preview
   - Display formatted phone below input: "+57 300 123 4567"
   - Show validation state (green check if valid, red X if invalid)
   - Use `formatPhoneDisplay` and `isValidColombianPhone` from phone.ts
   - Debounce validation (300ms) to avoid flicker

5. Create city combobox component `src/components/contacts/city-combobox.tsx`:
   - Use shadcn/ui Combobox pattern (Command + Popover)
   - Add command component if not present: `npx shadcn@latest add command popover`
   - Search filters cities as user types
   - Display: "City - Department"
   - Limit displayed results to 50 for performance
   - Props: value, onChange, placeholder
  </action>
  <verify>
    - TanStack Table installed: `pnpm list @tanstack/react-table`
    - TypeScript compiles: `pnpm tsc --noEmit`
    - Table, Command, Popover components exist in src/components/ui/
  </verify>
  <done>
    - DataTable component renders with sorting and selection
    - PhoneInput shows real-time validation feedback
    - CityCombobox provides searchable dropdown with Colombian cities
  </done>
</task>

<task type="auto">
  <name>Task 2: Create contacts table with columns and empty state</name>
  <files>
    - src/app/(dashboard)/crm/contactos/page.tsx
    - src/app/(dashboard)/crm/contactos/components/contacts-table.tsx
    - src/app/(dashboard)/crm/contactos/components/columns.tsx
    - src/app/(dashboard)/crm/contactos/components/empty-state.tsx
    - src/app/(dashboard)/crm/contactos/components/bulk-actions.tsx
  </files>
  <action>
1. Create contacts page `src/app/(dashboard)/crm/contactos/page.tsx`:
   - Server Component that fetches contacts
   - Call `getContacts()` Server Action
   - Pass data to ContactsTable client component
   - Page title "Contactos" with "Nuevo contacto" button
   - Handle loading state with Suspense if needed

2. Create column definitions `src/app/(dashboard)/crm/contactos/components/columns.tsx`:
   - **IMPORTANT:** Define columns OUTSIDE component or with useMemo to prevent re-renders
   - Export `columns` array of ColumnDef<ContactWithTags>

   Columns:
   - `select`: Checkbox for row selection (no sorting)
   - `name`: Sortable, bold text
   - `phone`: Display formatted (+57 300 123 4567)
   - `city`: Plain text, sortable
   - `tags`: Render colored badges (no sorting)
   - `updated_at`: "Ultimo contacto", relative time (hace 2 horas)
   - `actions`: Dropdown menu (Editar, Eliminar)

3. Create contacts table wrapper `src/app/(dashboard)/crm/contactos/components/contacts-table.tsx`:
   - "use client" component
   - Import columns and DataTable
   - Add search input at top (filters by name)
   - Add "Nuevo contacto" button that opens dialog
   - Show BulkActions toolbar when rows selected
   - Pass onRowSelectionChange to track selection

4. Create empty state `src/app/(dashboard)/crm/contactos/components/empty-state.tsx`:
   - UserPlus icon in muted circle
   - "No hay contactos" heading
   - "Agrega tu primer contacto..." description
   - "Crear primer contacto" button
   - Props: onCreateClick callback

5. Create bulk actions toolbar `src/app/(dashboard)/crm/contactos/components/bulk-actions.tsx`:
   - Shown when 1+ rows selected
   - Display "{N} seleccionados"
   - Buttons: "Agregar tag", "Quitar tag", "Eliminar"
   - Delete shows confirmation count ("Eliminar 3 contactos?")
   - Props: selectedIds, onClearSelection
  </action>
  <verify>
    - TypeScript compiles: `pnpm tsc --noEmit`
    - Navigate to /crm/contactos shows table or empty state
    - No infinite re-render warnings in console
  </verify>
  <done>
    - Contacts page fetches and displays contacts in table
    - Columns are sortable by clicking header
    - Row selection works with checkboxes
    - Empty state displays when no contacts
    - Bulk actions toolbar appears on selection
  </done>
</task>

<task type="auto">
  <name>Task 3: Create contact form, dialog, and detail page</name>
  <files>
    - src/app/(dashboard)/crm/contactos/components/contact-form.tsx
    - src/app/(dashboard)/crm/contactos/components/contact-dialog.tsx
    - src/app/(dashboard)/crm/contactos/[id]/page.tsx
  </files>
  <action>
1. Create contact form `src/app/(dashboard)/crm/contactos/components/contact-form.tsx`:
   - "use client" component
   - React Hook Form with Zod resolver
   - Props: mode ('create' | 'edit'), defaultValues?, onSuccess callback

   Fields:
   - name: Input (required)
   - phone: PhoneInput component (required)
   - email: Input type="email" (optional)
   - address: Textarea (optional)
   - city: CityCombobox (optional)

   Behavior:
   - Disable submit until form valid
   - Show loading state on submit button
   - Call createContact or updateContact Server Action
   - Use `toast.promise()` from Sonner for feedback
   - Call onSuccess callback after successful submit

2. Create contact dialog `src/app/(dashboard)/crm/contactos/components/contact-dialog.tsx`:
   - Wrapper around Dialog from shadcn/ui
   - Add Dialog component if not present: `npx shadcn@latest add dialog`
   - Props: open, onOpenChange, contact? (for edit mode)
   - Title: "Nuevo contacto" or "Editar contacto"
   - Contains ContactForm
   - Closes on successful submit

3. Create detail page `src/app/(dashboard)/crm/contactos/[id]/page.tsx`:
   - Server Component that fetches single contact
   - Call `getContact(id)` Server Action
   - If not found, redirect or show 404
   - Display contact info in card layout:
     - Header: Name (large) + Edit button
     - Phone: With copy button
     - Email: With mailto link
     - Address: Plain text
     - City: Plain text
     - Tags: Colored badges with remove button
     - Created/Updated timestamps
   - "Volver a contactos" link at top
   - Delete button (with confirmation modal)

4. Add Sonner Toaster to root layout if not present:
   - Check if `<Toaster />` from sonner exists in app/layout.tsx
   - If not, add `npx shadcn@latest add sonner` and add Toaster
  </action>
  <verify>
    - TypeScript compiles: `pnpm tsc --noEmit`
    - Create contact dialog opens and form submits
    - Detail page accessible at /crm/contactos/[id]
    - Toast notifications appear on actions
  </verify>
  <done>
    - Contact form validates and submits with phone normalization
    - Dialog provides quick create/edit experience
    - Detail page shows full contact information
    - Toast notifications provide action feedback
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

1. **Dependencies installed:**
   ```bash
   pnpm list @tanstack/react-table
   ```

2. **TypeScript compiles:**
   ```bash
   pnpm tsc --noEmit
   ```

3. **Visual verification (requires dev server):**
   - Start server: `pnpm dev`
   - Navigate to http://localhost:3020/crm/contactos
   - Should see empty state or table with contacts
   - Click "Nuevo contacto" - dialog opens
   - Fill form and submit - contact created with toast
   - Click contact row - navigates to detail page

4. **Table functionality:**
   - Click column headers - sorts table
   - Select checkboxes - bulk actions toolbar appears
   - Search input - filters contacts by name
</verification>

<success_criteria>
- [ ] TanStack Table installed and configured
- [ ] DataTable generic component created
- [ ] PhoneInput shows validation feedback
- [ ] CityCombobox provides Colombian cities autocomplete
- [ ] Contacts page lists all contacts in table
- [ ] Columns sortable with visual indicator
- [ ] Row selection with checkboxes works
- [ ] Empty state displays with CTA
- [ ] Bulk actions toolbar on selection
- [ ] Contact form validates with Zod
- [ ] Contact dialog for quick create/edit
- [ ] Detail page shows full contact info
- [ ] Toast notifications for all actions
</success_criteria>

<output>
After completion, create `.planning/phases/04-contacts-base/04-02-SUMMARY.md` using the summary template.
</output>
