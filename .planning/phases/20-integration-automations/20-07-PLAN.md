---
phase: 20-integration-automations
plan: 07
type: execute
wave: 4
depends_on: ["20-02", "20-03", "20-04", "20-05", "20-06"]
files_modified: []
autonomous: false

must_haves:
  truths:
    - "TypeScript compiles without errors"
    - "Twilio credentials configurable from /configuracion/integraciones"
    - "send_sms action available in the automation wizard"
    - "Shopify triggers available in the automation wizard"
    - "AI builder knows about send_sms and Shopify triggers"
    - "SMS usage dashboard renders with stats and chart"
    - "Shopify auto-sync toggle visible and functional"
  artifacts: []
  key_links: []
---

<objective>
TypeScript verification and human end-to-end testing of all Phase 20 success criteria.

Purpose: Verify that all Phase 20 components work together: Twilio SMS integration, Shopify trigger expansion, wizard UI categories, config UI, and AI builder awareness. Ensures no TypeScript errors and all integration points are wired correctly.

Output: Verified phase ready for production.
</objective>

<execution_context>
@/home/jose147/.claude/get-shit-done/workflows/execute-plan.md
@/home/jose147/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/20-integration-automations/20-CONTEXT.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: TypeScript verification and build check</name>
  <files></files>
  <action>
1. Run `npx tsc --noEmit` and fix ALL TypeScript errors. Common issues to watch for:
   - Exhaustive switch in action-executor.ts (must have send_sms case)
   - Exhaustive switch or missing cases in automation-runner.ts matchesTriggerConfig (must have 3 Shopify cases)
   - Import paths for new files (twilio/client.ts, twilio/types.ts)
   - ShopifyDraftOrderWebhook type compatibility with existing phone normalizer

2. Run `npm run build` and verify no build errors.

3. Verify the AI builder system prompt auto-includes new entries:
   - Check that `src/lib/builder/system-prompt.ts` reads from TRIGGER_CATALOG and ACTION_CATALOG programmatically
   - The 3 Shopify triggers and send_sms action should automatically appear in the builder's knowledge
   - No manual update needed if the system-prompt reads catalogs dynamically (confirmed in research)

4. Verify Inngest route registration:
   - Check `src/app/api/inngest/route.ts` uses `...automationFunctions` spread
   - The 3 new Shopify runners are included in automationFunctions array (added in Plan 02)
   - No additional route.ts change needed

5. Verify all file connections:
   - action-executor.ts imports from twilio/client.ts
   - webhook-handler.ts imports from automations/trigger-emitter.ts
   - events.ts has all 3 Shopify event types
   - automation-runner.ts has all 3 Shopify entries in EVENT_TO_TRIGGER
   - validation.ts has send_sms in ACTION_TO_TRIGGER_MAP
  </action>
  <verify>`npx tsc --noEmit` exits with code 0. `npm run build` exits with code 0.</verify>
  <done>TypeScript compiles without errors. Build succeeds. All file connections verified. AI builder auto-includes new catalog entries.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete Phase 20: Integration Automations (Twilio + Shopify)
- Twilio SMS as action type in automation engine
- 3 Shopify triggers (order_created, draft_order_created, order_updated)
- Twilio credentials config with test connection
- SMS usage dashboard with stats and chart
- Shopify auto-sync toggle
- Wizard UI with Shopify trigger category and Twilio action category
- AI builder awareness of new triggers/actions
  </what-built>
  <how-to-verify>
1. **Twilio Config UI:**
   - Navigate to /configuracion/integraciones
   - Verify Twilio tab is visible alongside Shopify
   - Fill in Twilio credentials (Account SID, Auth Token, Phone Number)
   - Click "Guardar" -- should save successfully
   - Verify Auth Token is masked (****XXXX)
   - Click "Probar conexion" -- enter phone number -- should send test SMS (if credentials are real)

2. **Shopify Auto-Sync Toggle:**
   - On Shopify tab, verify "Crear ordenes automaticamente" toggle is visible
   - Toggle it off and on -- should save state

3. **Automation Wizard - Shopify Triggers:**
   - Navigate to /automatizaciones, click "Crear automatizacion"
   - In trigger step: verify Shopify category (purple, ShoppingBag icon) with 3 triggers
   - Select "Orden de Shopify creada" -- verify variables show shopify.order_number, shopify.total, etc.

4. **Automation Wizard - Twilio Action:**
   - In actions step: verify Twilio category (teal, Phone icon)
   - Select "Enviar SMS" -- verify body textarea with variable support, optional to and mediaUrl fields
   - Verify MMS warning on mediaUrl field

5. **SMS Usage Dashboard:**
   - On Twilio tab in /configuracion/integraciones
   - Below the form, verify usage dashboard renders (may show empty state if no SMS sent yet)
   - Verify period selector (Dia/Semana/Mes) works

6. **AI Builder:**
   - Navigate to /automatizaciones/builder
   - Ask: "Cuando llega una orden de Shopify, envia un SMS al cliente con el numero de orden"
   - Builder should understand both Shopify trigger and send_sms action

7. **End-to-End (if Twilio credentials available):**
   - Create automation: trigger=shopify.order_created, action=send_sms with body="Orden {{shopify.order_number}} recibida. Total: {{shopify.total}}"
   - Verify automation saves correctly
   - Check automation appears in list with correct trigger/action labels
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
- TypeScript: `npx tsc --noEmit` passes
- Build: `npm run build` passes
- UI: All 7 verification steps pass human testing
</verification>

<success_criteria>
Phase 20 success criteria (from ROADMAP.md):
1. Credenciales Twilio configurables desde /configuracion/integraciones -- VERIFIED
2. Action type send_sms disponible en el builder de automatizaciones -- VERIFIED (make_call deferred per CONTEXT.md)
3. Triggers Shopify en catalogo: shopify.order_created, shopify.draft_order_created -- VERIFIED (+shopify.order_updated)
4. Webhook de Shopify emite triggers directos (no solo crea orden en MorfX) -- VERIFIED
5. Usuario puede decidir desde automatizaciones que hacer con ordenes/draft orders de Shopify -- VERIFIED
6. SMS Twilio se envian correctamente desde el action executor -- VERIFIED
</success_criteria>

<output>
After completion, create `.planning/phases/20-integration-automations/20-07-SUMMARY.md`
</output>
