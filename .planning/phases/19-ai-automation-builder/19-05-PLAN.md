---
phase: 19-ai-automation-builder
plan: 05
type: execute
wave: 3
depends_on: ["19-01", "19-03"]
files_modified:
  - src/app/(dashboard)/automatizaciones/builder/page.tsx
  - src/app/(dashboard)/automatizaciones/builder/components/builder-layout.tsx
  - src/app/(dashboard)/automatizaciones/builder/components/builder-chat.tsx
  - src/app/(dashboard)/automatizaciones/builder/components/builder-message.tsx
  - src/app/(dashboard)/automatizaciones/builder/components/builder-input.tsx
autonomous: true

must_haves:
  truths:
    - "User can navigate to /automatizaciones/builder and see a chat interface"
    - "User can type a message and receive a streaming response from the agent"
    - "Messages display with proper role styling (user right, agent left)"
    - "Tool call parts show loading states during execution"
  artifacts:
    - path: "src/app/(dashboard)/automatizaciones/builder/page.tsx"
      provides: "Server component page for the builder"
      min_lines: 15
    - path: "src/app/(dashboard)/automatizaciones/builder/components/builder-layout.tsx"
      provides: "Main layout with chat area and session sidebar"
      min_lines: 40
    - path: "src/app/(dashboard)/automatizaciones/builder/components/builder-chat.tsx"
      provides: "Chat container using useChat hook from AI SDK"
      min_lines: 80
    - path: "src/app/(dashboard)/automatizaciones/builder/components/builder-message.tsx"
      provides: "Message bubble with parts rendering (text, tool calls)"
      min_lines: 60
  key_links:
    - from: "src/app/(dashboard)/automatizaciones/builder/components/builder-chat.tsx"
      to: "/api/builder/chat"
      via: "useChat({ api: '/api/builder/chat' })"
      pattern: "useChat.*api.*builder/chat"
    - from: "src/app/(dashboard)/automatizaciones/builder/components/builder-message.tsx"
      to: "part.type === 'tool-invocation'"
      via: "AI SDK message parts rendering"
      pattern: "part\\.type"
---

<objective>
Create the builder page and chat UI using AI SDK's useChat hook. The chat displays at /automatizaciones/builder with message bubbles, streaming responses, and tool call status indicators.

Purpose: The user-facing interface for interacting with the automation builder agent.
Output: Working chat page with streaming AI responses and message rendering.
</objective>

<execution_context>
@/home/jose147/.claude/get-shit-done/workflows/execute-plan.md
@/home/jose147/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/19-ai-automation-builder/19-01-PLAN.md
@.planning/phases/19-ai-automation-builder/19-03-PLAN.md
@src/app/(dashboard)/sandbox/components/sandbox-chat.tsx
@src/app/(dashboard)/sandbox/components/sandbox-message-bubble.tsx
@src/app/(dashboard)/sandbox/components/sandbox-layout.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create builder page and layout</name>
  <files>
    src/app/(dashboard)/automatizaciones/builder/page.tsx
    src/app/(dashboard)/automatizaciones/builder/components/builder-layout.tsx
  </files>
  <action>
    1. **Builder page** (`page.tsx`):
    Server component. Minimal — just renders the layout:
    ```tsx
    import { BuilderLayout } from './components/builder-layout'

    export default function BuilderPage() {
      return <BuilderLayout />
    }
    ```

    2. **Builder layout** (`builder-layout.tsx`):
    Client component ('use client'). Full-height layout with:

    - Header section at top:
      - Back link: `<Link href="/automatizaciones">` with ArrowLeft icon + "Automatizaciones"
      - Title: "AI Builder" centered or left-aligned
      - Session controls (new session button) on the right

    - Main area: The chat component (BuilderChat) taking full remaining height
    - Use `flex flex-col h-full` for the outer container
    - The dashboard layout already provides the sidebar, so this just fills the content area

    State management:
    - `sessionId: string | null` — current session ID
    - `sessionTitle: string | null` — current session title
    - `onNewSession()` — resets sessionId to null, causing a new session on next message
    - Pass sessionId to BuilderChat

    Styling: Match the existing dashboard page patterns. Use `<div className="flex-1 overflow-y-auto">` as the outermost wrapper (required for dashboard pages per project conventions).

    Import components from the builder's components directory.
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - Navigating to /automatizaciones/builder renders the page
  </verify>
  <done>
    - Builder page exists at /automatizaciones/builder
    - Layout has header with back link and session controls
    - Chat area fills remaining height
  </done>
</task>

<task type="auto">
  <name>Task 2: Create chat component and message rendering</name>
  <files>
    src/app/(dashboard)/automatizaciones/builder/components/builder-chat.tsx
    src/app/(dashboard)/automatizaciones/builder/components/builder-message.tsx
    src/app/(dashboard)/automatizaciones/builder/components/builder-input.tsx
  </files>
  <action>
    1. **BuilderChat** (`builder-chat.tsx`):
    Client component using AI SDK `useChat` hook.

    ```tsx
    'use client'
    import { useChat } from 'ai/react'
    import { useRef, useEffect } from 'react'
    import { BuilderMessage } from './builder-message'
    import { BuilderInput } from './builder-input'
    ```

    Props: `{ sessionId: string | null, onSessionCreated: (id: string) => void }`

    useChat configuration:
    ```typescript
    const { messages, input, handleInputChange, handleSubmit, isLoading, error } = useChat({
      api: '/api/builder/chat',
      body: { sessionId },
      onResponse: (response) => {
        // Extract session ID from response header
        const newSessionId = response.headers.get('X-Session-Id')
        if (newSessionId && !sessionId) {
          onSessionCreated(newSessionId)
        }
      },
    })
    ```

    Auto-scroll to bottom: Use a ref on the messages container and scroll to bottom when messages change.

    Layout:
    - Scrollable messages area (flex-1 overflow-y-auto) with padding
    - Fixed input area at bottom
    - If no messages, show a centered welcome message: "Describe la automatizacion que quieres crear. Por ejemplo: 'Cuando un pedido llegue a la etapa Confirmado, asigna el tag VIP al contacto'"
    - Error display: if `error` is set, show it as a red banner above the input

    Render each message with `<BuilderMessage>` component.

    2. **BuilderMessage** (`builder-message.tsx`):
    Client component that renders a single message with AI SDK parts.

    Props: `{ message: Message }` (Message from 'ai/react')

    Rendering logic:
    - User messages: Right-aligned, primary background, rounded bubble
    - Assistant messages: Left-aligned, muted background, rounded bubble
    - Use `message.parts` array to render content:

    ```tsx
    {message.parts.map((part, i) => {
      switch (part.type) {
        case 'text':
          return <div key={i} className="prose prose-sm dark:prose-invert max-w-none">{part.text}</div>

        case 'tool-invocation':
          // Show tool call status
          if (part.toolInvocation.state === 'call' || part.toolInvocation.state === 'partial-call') {
            return <ToolLoading key={i} toolName={part.toolInvocation.toolName} />
          }
          if (part.toolInvocation.state === 'result') {
            // For generatePreview tool, render the diagram (Plan 06)
            if (part.toolInvocation.toolName === 'generatePreview') {
              return <PreviewPlaceholder key={i} data={part.toolInvocation.result} />
            }
            // For other tools, show a subtle indicator
            return <ToolResult key={i} toolName={part.toolInvocation.toolName} />
          }
          return null

        default:
          return null
      }
    })}
    ```

    Helper sub-components (defined in the same file or inline):

    - `ToolLoading`: Shows a small loading indicator with tool name in Spanish. Map tool names: listPipelines -> "Consultando pipelines...", listTags -> "Consultando tags...", generatePreview -> "Generando preview...", createAutomation -> "Creando automatizacion...", etc.

    - `ToolResult`: A subtle chip/badge showing the tool executed. Hidden for resource lookup tools (listPipelines, listTags, etc.) since the agent will relay results in text. Visible for createAutomation/updateAutomation with a checkmark.

    - `PreviewPlaceholder`: Temporary placeholder div with "Preview del diagrama" text. Will be replaced with actual React Flow diagram in Plan 06.

    Styling:
    - User: `bg-primary text-primary-foreground ml-auto max-w-[80%]`
    - Agent: `bg-muted text-muted-foreground mr-auto max-w-[80%]`
    - Both: `rounded-2xl px-4 py-2.5`
    - Timestamp below each message (small, muted)

    3. **BuilderInput** (`builder-input.tsx`):
    Client component for the message input.

    Props: `{ input, handleInputChange, handleSubmit, isLoading }`

    Simple textarea (not input) that:
    - Expands up to 4 lines
    - Submits on Enter (not Shift+Enter which adds newline)
    - Has a send button (Send icon from lucide-react) disabled when empty or loading
    - Shows a loading spinner on the button when isLoading
    - Placeholder: "Describe tu automatizacion..."
    - Styled with border, rounded corners, matching existing project input patterns
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - All 3 files exist in the builder components directory
    - BuilderChat uses useChat hook with /api/builder/chat endpoint
    - BuilderMessage handles text and tool-invocation parts
  </verify>
  <done>
    - Chat UI sends messages to /api/builder/chat and displays streaming responses
    - Message parts rendering handles text and tool call states
    - Input supports multi-line with Enter to submit
    - Welcome message shown when no messages exist
    - Auto-scroll to latest message
  </done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` passes
- Navigate to /automatizaciones/builder — page loads
- Type a message — it appears as a user bubble
- Agent response streams in as assistant bubble
- Tool calls show loading/result indicators
</verification>

<success_criteria>
Builder page renders a functional chat interface. Messages stream from the agent with proper styling. Tool call parts show appropriate status. Input handles multi-line with Enter submission. Session ID propagated from response headers.
</success_criteria>

<output>
After completion, create `.planning/phases/19-ai-automation-builder/19-05-SUMMARY.md`
</output>
