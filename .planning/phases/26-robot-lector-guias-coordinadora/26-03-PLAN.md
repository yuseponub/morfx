---
phase: 26-robot-lector-guias-coordinadora
plan: 03
type: execute
wave: 3
depends_on: ["26-01", "26-02"]
files_modified:
  - src/app/actions/comandos.ts
  - src/app/(dashboard)/comandos/components/comandos-layout.tsx
  - src/app/(dashboard)/comandos/components/command-output.tsx
  - src/app/(dashboard)/comandos/components/history-panel.tsx
autonomous: false

must_haves:
  truths:
    - "User can type 'buscar guias coord' and the system looks up guides from the portal"
    - "Preview shows how many orders are pending guide lookup"
    - "Real-time progress updates appear during guide lookup"
    - "Summary shows pedido->guide mapping for found guides and 'Pendiente' for missing ones"
    - "Help command lists 'buscar guias coord' as available"
    - "History panel shows job_type label to distinguish shipment vs guide lookup jobs"
    - "Guide lookup and shipment creation jobs don't block each other"
  artifacts:
    - path: "src/app/actions/comandos.ts"
      provides: "executeBuscarGuiasCoord server action"
      exports: ["executeBuscarGuiasCoord"]
    - path: "src/app/(dashboard)/comandos/components/comandos-layout.tsx"
      provides: "buscar guias coord command handler"
      contains: "buscar guias coord"
    - path: "src/app/(dashboard)/comandos/components/command-output.tsx"
      provides: "buscar guias coord in help list"
      contains: "buscar guias coord"
    - path: "src/app/(dashboard)/comandos/components/history-panel.tsx"
      provides: "job_type label display"
      contains: "job_type"
  key_links:
    - from: "src/app/(dashboard)/comandos/components/comandos-layout.tsx"
      to: "src/app/actions/comandos.ts"
      via: "executeBuscarGuiasCoord import and call"
      pattern: "executeBuscarGuiasCoord"
    - from: "src/app/actions/comandos.ts"
      to: "src/lib/domain/orders.ts"
      via: "getOrdersPendingGuide query"
      pattern: "getOrdersPendingGuide"
    - from: "src/app/actions/comandos.ts"
      to: "src/inngest/client"
      via: "inngest.send robot/guide-lookup.submitted"
      pattern: "guide-lookup.submitted"
---

<objective>
Wire the `buscar guias coord` command into the Chat de Comandos UI: server action, command handler, help text, result display, and history panel job_type labels.

Purpose: Completes the user-facing feature — operations team can issue the guide lookup command and see results in real time, matching the exact UX of `subir ordenes coord`.
Output: Working command that triggers guide lookup, shows real-time progress, and displays results with pedido->guide mappings.
</objective>

<execution_context>
@/home/jose147/.claude/get-shit-done/workflows/execute-plan.md
@/home/jose147/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@.planning/phases/26-robot-lector-guias-coordinadora/26-CONTEXT.md
@.planning/phases/26-robot-lector-guias-coordinadora/26-RESEARCH.md
@.planning/phases/26-robot-lector-guias-coordinadora/26-01-SUMMARY.md
@.planning/phases/26-robot-lector-guias-coordinadora/26-02-SUMMARY.md

@src/app/actions/comandos.ts
@src/app/(dashboard)/comandos/components/comandos-layout.tsx
@src/app/(dashboard)/comandos/components/command-output.tsx
@src/app/(dashboard)/comandos/components/command-panel.tsx
@src/app/(dashboard)/comandos/components/history-panel.tsx
@src/hooks/use-robot-job-progress.ts
@src/lib/domain/orders.ts
@src/lib/domain/robot-jobs.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Server action + command handler + help text + history labels</name>
  <files>
    src/app/actions/comandos.ts
    src/app/(dashboard)/comandos/components/comandos-layout.tsx
    src/app/(dashboard)/comandos/components/command-output.tsx
    src/app/(dashboard)/comandos/components/history-panel.tsx
  </files>
  <action>
**In `src/app/actions/comandos.ts`:**

1. Add imports for the new domain functions:
   ```typescript
   import { getOrdersPendingGuide, type OrderPendingGuide } from '@/lib/domain/orders'
   ```
   Also import `getActiveJob` — it's already imported but verify the import includes the function (it does: `getActiveJob` is already in the import block).

2. Add a new result type:
   ```typescript
   interface BuscarGuiasResult {
     jobId: string
     totalOrders: number
   }
   ```

3. Add the `executeBuscarGuiasCoord` server action (export it). Place it after `executeSubirOrdenesCoord`:

   ```typescript
   /**
    * Full flow for "buscar guias coord" command:
    * 1. Validate credentials
    * 2. Get dispatch stage config
    * 3. Check for active guide_lookup job
    * 4. Get orders with tracking_number but no carrier_guide_number
    * 5. Create robot job (job_type: 'guide_lookup')
    * 6. Dispatch to Inngest
    */
   export async function executeBuscarGuiasCoord(): Promise<CommandResult<BuscarGuiasResult>> {
     try {
       // 1. Auth
       const auth = await getAuthContext()
       if ('error' in auth) return { success: false, error: auth.error }

       const ctx: DomainContext = { workspaceId: auth.workspaceId, source: 'server-action' }

       // 2. Carrier credentials (same portal credentials)
       const creds = await getCarrierCredentials(ctx)
       if (!creds.success || !creds.data) {
         return { success: false, error: creds.error || 'Credenciales de transportadora no configuradas' }
       }

       // 3. Dispatch stage config
       const dispatchStageResult = await getDispatchStage(ctx)
       if (!dispatchStageResult.success) {
         return { success: false, error: dispatchStageResult.error! }
       }
       if (!dispatchStageResult.data) {
         return {
           success: false,
           error: 'Etapa de despacho no configurada. Configure la etapa en Configuracion > Logistica.',
         }
       }

       // 4. Check for active guide_lookup job (scoped by type — doesn't block shipment jobs)
       const activeJobResult = await getActiveJob(ctx, 'guide_lookup')
       if (!activeJobResult.success) {
         return { success: false, error: activeJobResult.error! }
       }
       if (activeJobResult.data) {
         return { success: false, error: 'Ya hay una búsqueda de guías en progreso' }
       }

       // 5. Get orders pending guide (tracking_number NOT NULL, carrier_guide_number IS NULL)
       const ordersResult = await getOrdersPendingGuide(ctx, dispatchStageResult.data.stageId)
       if (!ordersResult.success) return { success: false, error: ordersResult.error! }
       const orders = ordersResult.data!

       if (orders.length === 0) {
         return { success: false, error: 'No hay órdenes pendientes de guía en la etapa de despacho' }
       }

       // 6. Create robot job (job_type: 'guide_lookup')
       const jobResult = await createRobotJob(ctx, {
         orderIds: orders.map(o => o.id),
         carrier: 'coordinadora',
         jobType: 'guide_lookup',
       })
       if (!jobResult.success || !jobResult.data) {
         return { success: false, error: jobResult.error || 'Error creando job' }
       }

       // 7. Dispatch to Inngest
       await (inngest.send as any)({
         name: 'robot/guide-lookup.submitted',
         data: {
           jobId: jobResult.data.jobId,
           workspaceId: ctx.workspaceId,
           credentials: creds.data,
           pedidoNumbers: orders.map(order => {
             const item = jobResult.data!.items.find(i => i.orderId === order.id)!
             return {
               itemId: item.itemId,
               orderId: order.id,
               pedidoNumber: order.tracking_number,
             }
           }),
         },
       })

       return {
         success: true,
         data: {
           jobId: jobResult.data.jobId,
           totalOrders: orders.length,
         },
       }
     } catch (err) {
       const message = err instanceof Error ? err.message : String(err)
       console.error('[comandos] executeBuscarGuiasCoord error:', message)
       return { success: false, error: message }
     }
   }
   ```

4. Update `getJobStatus` to accept an optional `jobType` parameter so the UI can check for active jobs by type:
   ```typescript
   export async function getJobStatus(jobType?: string): Promise<CommandResult<GetJobWithItemsResult | null>> {
     try {
       const auth = await getAuthContext()
       if ('error' in auth) return { success: false, error: auth.error }

       const ctx: DomainContext = { workspaceId: auth.workspaceId, source: 'server-action' }
       const result = await getActiveJob(ctx, jobType)

       if (!result.success) return { success: false, error: result.error! }
       return { success: true, data: result.data }
     } catch (err) {
       const message = err instanceof Error ? err.message : String(err)
       return { success: false, error: message }
     }
   }
   ```

**In `src/app/(dashboard)/comandos/components/comandos-layout.tsx`:**

1. Add the import for the new server action:
   ```typescript
   import {
     executeSubirOrdenesCoord,
     executeBuscarGuiasCoord,
     getJobStatus,
     getCommandHistory,
     getJobItemsForHistory,
   } from '@/app/actions/comandos'
   ```

2. In the `handleCommand` callback, add a new branch for `buscar guias coord` BEFORE the unknown command fallback. Follow the exact same pattern as `subir ordenes coord`:

   ```typescript
   if (normalized === 'buscar guias coord') {
     setIsExecuting(true)
     addMessage({
       type: 'system',
       text: 'Buscando órdenes pendientes de guía...',
       timestamp: now(),
     })

     const result = await executeBuscarGuiasCoord()
     if (!result.success) {
       addMessage({
         type: 'error',
         text: result.error!,
         timestamp: now(),
       })
       setIsExecuting(false)
       return
     }

     const data = result.data!
     addMessage({
       type: 'system',
       text: `Job creado: buscando guías para ${data.totalOrders} órdenes.`,
       timestamp: now(),
     })

     setActiveJobId(data.jobId)
     return
   }
   ```

3. In the result message rendering (completion detection useEffect), the existing code shows `#{detail.trackingNumber}` for successful items. For guide lookup jobs, this trackingNumber field carries the guide number. The display is correct as-is because the guide number WILL appear as `#GUIA_NUMBER` which is the desired format (`Pedido 9597 -> Guia 1234567890` style can be done by adjusting the result detail rendering — but per CONTEXT.md, the simple `#{number}` display is consistent with existing UX). No changes needed to the completion effect.

**In `src/app/(dashboard)/comandos/components/command-output.tsx`:**

1. Add `buscar guias coord` to the `HELP_COMMANDS` array:
   ```typescript
   const HELP_COMMANDS = [
     { cmd: 'subir ordenes coord', desc: 'Subir órdenes pendientes a Coordinadora' },
     { cmd: 'buscar guias coord', desc: 'Buscar guías asignadas por Coordinadora' },
     { cmd: 'estado', desc: 'Ver estado del job activo' },
     { cmd: 'ayuda', desc: 'Mostrar esta ayuda' },
   ]
   ```

**In `src/app/(dashboard)/comandos/components/history-panel.tsx`:**

1. Add a `job_type` field to the display. The `RobotJob` type (from Plan 01) now includes `job_type: string`. Show a label in the collapsed job row to distinguish job types.

   In the job row (inside the `<button>` element), after the `StatusBadge`, add a job type label:
   ```tsx
   <Badge variant="outline" className="text-[10px]">
     {job.job_type === 'guide_lookup' ? 'Buscar guías' : 'Subir órdenes'}
   </Badge>
   ```

   Place this between the `StatusBadge` and the closing `</div>` of the first row div (the one with `flex items-center gap-2 mb-1`).

2. Ensure the `job_type` property is read from the job object. Since `RobotJob` interface was extended in Plan 01 to include `job_type`, TypeScript will type-check this. The `job_type` column has a DEFAULT of `'create_shipment'`, so existing jobs will show the correct label.
  </action>
  <verify>
Run `npx tsc --noEmit` — no TypeScript errors. Visually verify the help text includes the new command by reading `command-output.tsx`.
  </verify>
  <done>
- executeBuscarGuiasCoord server action created
- "buscar guias coord" command wired into the command handler
- Help text includes the new command
- History panel shows job type labels
- Real-time progress works via existing Supabase Realtime hook
- Result display shows tracking numbers (guide numbers) for successful lookups
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete "buscar guias coord" command flow:
- Type the command in Chat de Comandos
- System queries orders with tracking_number but no carrier_guide_number
- Robot reads guide numbers from Coordinadora portal
- Real-time progress updates appear
- Summary shows pedido->guide mappings
- History panel distinguishes guide lookup from shipment creation jobs
- Help command lists all available commands
  </what-built>
  <how-to-verify>
1. Navigate to /comandos
2. Type "ayuda" — verify "buscar guias coord" appears in help list
3. Type "buscar guias coord" — verify it shows preview message or informative error
4. In history panel, verify job type labels appear (if there are existing jobs)
5. Push to Vercel and test the deployed version
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues</resume-signal>
</task>

</tasks>

<verification>
1. "buscar guias coord" command is recognized and executes the server action
2. Server action queries correct orders (tracking_number NOT NULL, carrier_guide_number IS NULL)
3. Help text includes the new command
4. History panel shows job type labels
5. Real-time progress works for guide lookup jobs
6. Guide lookup and shipment creation jobs can run independently
7. `npx tsc --noEmit` passes
</verification>

<success_criteria>
- User can type "buscar guias coord" and the system responds correctly
- Help lists all 4 commands (subir ordenes coord, buscar guias coord, estado, ayuda)
- History distinguishes job types visually
- Real-time progress and completion detection work
- No regression in existing "subir ordenes coord" command
</success_criteria>

<output>
After completion, create `.planning/phases/26-robot-lector-guias-coordinadora/26-03-SUMMARY.md`
</output>
