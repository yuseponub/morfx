---
phase: 04-contacts-base
plan: 03
type: execute
wave: 3
depends_on: ["04-02"]
files_modified:
  - src/app/(dashboard)/crm/contactos/components/tag-filter.tsx
  - src/app/(dashboard)/crm/contactos/components/tag-manager.tsx
  - src/app/(dashboard)/crm/contactos/components/contacts-table.tsx
  - src/components/contacts/tag-input.tsx
  - src/components/contacts/tag-badge.tsx
  - src/app/(dashboard)/crm/contactos/[id]/page.tsx
autonomous: true

must_haves:
  truths:
    - "User can add and remove tags from contacts"
    - "User can filter the contact list by one or more tags"
    - "Tags display with workspace-defined colors"
    - "Any user can create new tags"
  artifacts:
    - path: "src/app/(dashboard)/crm/contactos/components/tag-filter.tsx"
      provides: "Filter contacts by tags"
      min_lines: 40
    - path: "src/components/contacts/tag-input.tsx"
      provides: "Add/remove tags from contact"
      min_lines: 50
    - path: "src/components/contacts/tag-badge.tsx"
      provides: "Colored tag display with optional remove"
      min_lines: 20
  key_links:
    - from: "src/app/(dashboard)/crm/contactos/components/tag-filter.tsx"
      to: "src/app/actions/tags.ts"
      via: "getTags for filter options"
      pattern: "import.*getTags.*from.*actions/tags"
    - from: "src/components/contacts/tag-input.tsx"
      to: "src/app/actions/contacts.ts"
      via: "addTagToContact/removeTagFromContact"
      pattern: "import.*(addTagToContact|removeTagFromContact).*from.*actions/contacts"
---

<objective>
Implement the tag system with colors, filtering, and contact-tag management.

Purpose: Tags are the primary way users segment and organize contacts. The tag system enables quick categorization (VIP, Lead, Cliente) and powerful filtering to find specific groups. Colors provide visual distinction for rapid recognition.

Output:
- Tag filter component for multi-tag filtering
- Tag input with Emblor for adding/removing tags
- Tag badge component with color and optional remove button
- Tag manager for creating new tags with color selection
- Integration with contact detail page and bulk actions
- Client-side filtering in table based on selected tags
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-contacts-base/04-CONTEXT.md
@.planning/phases/04-contacts-base/04-RESEARCH.md
@.planning/phases/04-contacts-base/04-01-SUMMARY.md
@.planning/phases/04-contacts-base/04-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create tag badge and tag input components</name>
  <files>
    - src/components/contacts/tag-badge.tsx
    - src/components/contacts/tag-input.tsx
  </files>
  <action>
1. Create tag badge component `src/components/contacts/tag-badge.tsx`:
   - Props: tag (name, color), onRemove? (optional callback)
   - Display colored pill with tag name
   - Use `getContrastColor()` from tag-colors.ts for text color
   - Show X button when onRemove provided (on hover or always)
   - Tailwind classes: px-2 py-0.5 rounded-full text-xs font-medium
   - Export `TagBadge` component

2. Create tag input component `src/components/contacts/tag-input.tsx`:
   - "use client" component
   - Props: contactId, currentTags, availableTags
   - Use Emblor tag input library
   - Features:
     - Autocomplete from availableTags
     - Create new tag inline (type name + Enter)
     - Remove tag by clicking X or backspace
     - Color picker for new tags (optional, use default)

   Implementation:
   - When tag added:
     - If tag exists in availableTags, call addTagToContact(contactId, tagId)
     - If tag is new, call createTag first, then addTagToContact
   - When tag removed:
     - Call removeTagFromContact(contactId, tagId)
   - Show toast on success/error
   - Optimistic update: show tag immediately, revert on error

   If Emblor proves difficult, fallback to simpler implementation:
   - Popover with tag list (checkboxes)
   - "+" button to create new tag
   - Selected tags shown as badges
  </action>
  <verify>
    - TypeScript compiles: `pnpm tsc --noEmit`
    - TagBadge renders with correct color and contrast
  </verify>
  <done>
    - TagBadge displays tag with proper color contrast
    - TagInput allows adding/removing tags from contact
    - New tags can be created inline
  </done>
</task>

<task type="auto">
  <name>Task 2: Create tag filter and manager components</name>
  <files>
    - src/app/(dashboard)/crm/contactos/components/tag-filter.tsx
    - src/app/(dashboard)/crm/contactos/components/tag-manager.tsx
  </files>
  <action>
1. Create tag filter component `src/app/(dashboard)/crm/contactos/components/tag-filter.tsx`:
   - "use client" component
   - Props: tags (all workspace tags), selectedTagIds, onSelectionChange
   - UI: Horizontal list of tag badges or dropdown with checkboxes
   - Allow multi-select (filter by ANY of selected tags)
   - Show "X tags seleccionados" count when filtering
   - "Limpiar filtros" button to reset

   Design options (choose based on space):
   a) Pill buttons that toggle on click (like Linear)
   b) Dropdown multi-select (more compact)
   c) Popover with checkbox list

   Recommendation: Pill buttons for first 5 tags, "Ver mas" expands to popover

2. Create tag manager component `src/app/(dashboard)/crm/contactos/components/tag-manager.tsx`:
   - Dialog/Sheet for managing workspace tags
   - List all tags with color preview
   - "Nuevo tag" form: name + color picker
   - Color picker: grid of TAG_COLORS palette + custom hex option
   - Edit inline: click tag to edit name/color
   - Delete with confirmation (warns about removal from contacts)
   - Access via gear icon in tag filter or settings menu
  </action>
  <verify>
    - TypeScript compiles: `pnpm tsc --noEmit`
    - Tag filter allows multi-select
    - Tag manager can create/edit/delete tags
  </verify>
  <done>
    - Tag filter enables multi-tag selection
    - Filter selection updates table results
    - Tag manager provides full tag CRUD
    - Color palette selection works
  </done>
</task>

<task type="auto">
  <name>Task 3: Integrate tags into contacts table and detail page</name>
  <files>
    - src/app/(dashboard)/crm/contactos/components/contacts-table.tsx
    - src/app/(dashboard)/crm/contactos/page.tsx
    - src/app/(dashboard)/crm/contactos/[id]/page.tsx
    - src/app/(dashboard)/crm/contactos/components/bulk-actions.tsx
  </files>
  <action>
1. Update contacts page `src/app/(dashboard)/crm/contactos/page.tsx`:
   - Fetch tags with `getTags()` in addition to contacts
   - Pass tags to ContactsTable for filtering

2. Update contacts table `src/app/(dashboard)/crm/contactos/components/contacts-table.tsx`:
   - Add TagFilter component above table
   - Track selectedTagIds in state
   - Apply client-side filtering:
     - If no tags selected, show all contacts
     - If tags selected, show contacts that have ANY of the selected tags
   - Pass availableTags to column renderer for tag display

3. Update detail page `src/app/(dashboard)/crm/contactos/[id]/page.tsx`:
   - Add TagInput component for managing contact's tags
   - Fetch available tags (or pass from parent)
   - Display current tags as badges
   - Allow adding/removing tags inline

4. Update bulk actions `src/app/(dashboard)/crm/contactos/components/bulk-actions.tsx`:
   - Implement "Agregar tag" button:
     - Opens popover with tag list
     - Select tag to add to all selected contacts
     - Call bulkAddTag(selectedIds, tagId)
     - Show toast with count: "Tag agregado a 5 contactos"

   - Implement "Quitar tag" button:
     - Opens popover with tag list (only show tags that ANY selected contact has)
     - Select tag to remove from all selected contacts
     - Call bulkRemoveTag(selectedIds, tagId)
     - Show toast with count: "Tag eliminado de 3 contactos"

5. Ensure columns.tsx tags column uses TagBadge:
   - Import TagBadge component
   - Render each tag as a badge with correct color
   - Handle empty tags gracefully (show nothing, not "-")
  </action>
  <verify>
    - TypeScript compiles: `pnpm tsc --noEmit`
    - Start dev server: `pnpm dev`
    - Navigate to /crm/contactos
    - Tag filter filters table results
    - Detail page allows tag editing
    - Bulk tag operations work
  </verify>
  <done>
    - Tag filter integrated and functional
    - Client-side filtering by tags works
    - Detail page has inline tag editing
    - Bulk add/remove tag operations work
    - All tag displays use TagBadge component
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

1. **TypeScript compiles:**
   ```bash
   pnpm tsc --noEmit
   ```

2. **Manual testing (requires dev server and migration applied):**
   ```bash
   pnpm dev
   ```

   Test flow:
   a. Navigate to /crm/contactos
   b. Click tag filter - see available tags
   c. Select one or more tags - table filters
   d. Clear filters - all contacts return
   e. Click on a contact to view detail
   f. Add a tag to the contact - tag appears
   g. Remove a tag - tag disappears
   h. Create a new tag inline - appears in list
   i. Select multiple contacts in table
   j. Bulk add tag - all selected get tag
   k. Bulk remove tag - tag removed from selected

3. **Edge cases:**
   - Contact with no tags displays correctly
   - Filtering by non-existent tag shows empty (or all)
   - Creating duplicate tag name shows error
   - Deleting tag removes from all contacts
</verification>

<success_criteria>
- [ ] TagBadge displays with correct color and contrast
- [ ] TagInput allows adding/removing tags from single contact
- [ ] New tags can be created inline with default color
- [ ] TagFilter allows multi-tag selection
- [ ] Table filters by selected tags (client-side)
- [ ] Filter shows count of selected tags
- [ ] Clear filters button resets selection
- [ ] TagManager allows creating tags with color
- [ ] TagManager allows editing tag name/color
- [ ] TagManager allows deleting tags
- [ ] Detail page has inline tag editing
- [ ] Bulk add tag works for selected contacts
- [ ] Bulk remove tag works for selected contacts
- [ ] Toast notifications for all tag operations
</success_criteria>

<output>
After completion, create `.planning/phases/04-contacts-base/04-03-SUMMARY.md` using the summary template.
</output>
