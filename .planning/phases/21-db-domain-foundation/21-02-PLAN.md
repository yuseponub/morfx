---
phase: 21-db-domain-foundation
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/20260222000002_carrier_configs.sql
  - supabase/migrations/20260222000003_robot_jobs.sql
autonomous: true

must_haves:
  truths:
    - "Workspace admin can store carrier credentials (username + password) per carrier"
    - "Carrier config is retrievable per workspace with is_enabled flag"
    - "Only one config per workspace per carrier (unique constraint)"
    - "A robot job can be created with N orders, each getting an independent tracking row"
    - "Each robot_job_item tracks status, tracking_number, error_type, error_message, and retry_count independently"
    - "Duplicate batch submissions are prevented via idempotency_key"
  artifacts:
    - path: "supabase/migrations/20260222000002_carrier_configs.sql"
      provides: "carrier_configs workspace-scoped table with RLS"
      contains: "CREATE TABLE carrier_configs"
    - path: "supabase/migrations/20260222000003_robot_jobs.sql"
      provides: "robot_jobs + robot_job_items tables with RLS"
      contains: "CREATE TABLE robot_jobs"
  key_links:
    - from: "carrier_configs"
      to: "workspaces"
      via: "workspace_id FK"
      pattern: "REFERENCES workspaces"
    - from: "robot_jobs"
      to: "workspaces"
      via: "workspace_id FK"
      pattern: "REFERENCES workspaces"
    - from: "robot_job_items"
      to: "robot_jobs"
      via: "job_id FK with CASCADE"
      pattern: "REFERENCES robot_jobs.*ON DELETE CASCADE"
    - from: "robot_job_items"
      to: "orders"
      via: "order_id FK with CASCADE"
      pattern: "REFERENCES orders"
---

<objective>
Create the workspace-scoped carrier configuration and robot job tracking tables.

Purpose: carrier_configs stores per-workspace portal credentials for Coordinadora (and future carriers). robot_jobs + robot_job_items track batch robot executions with per-order granularity, enabling retry, error categorization, and automation triggers. These tables are required by Phase 22 (robot service) and Phase 23 (Inngest orchestrator).

Output: Two SQL migration files with table creation, RLS policies, indexes, and triggers following existing codebase patterns.
</objective>

<execution_context>
@/home/jose147/.claude/get-shit-done/workflows/execute-plan.md
@/home/jose147/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/21-db-domain-foundation/21-CONTEXT.md
@.planning/phases/21-db-domain-foundation/21-RESEARCH.md

# Existing migration patterns (RLS, triggers, grants)
@supabase/migrations/20260221000000_client_activation_badge.sql
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create carrier_configs table</name>
  <files>supabase/migrations/20260222000002_carrier_configs.sql</files>
  <action>
Create a SQL migration for the `carrier_configs` workspace-scoped table. Follow the exact pattern from `client_activation_config` in `20260221000000_client_activation_badge.sql`.

1. Create `carrier_configs` table:
   - `id UUID PRIMARY KEY DEFAULT gen_random_uuid()`
   - `workspace_id UUID NOT NULL REFERENCES workspaces(id) ON DELETE CASCADE`
   - `carrier TEXT NOT NULL DEFAULT 'coordinadora'`
   - `portal_username TEXT` -- nullable, set when configured
   - `portal_password TEXT` -- nullable, plaintext for v3.0 (not payment data)
   - `is_enabled BOOLEAN NOT NULL DEFAULT false`
   - `created_at TIMESTAMPTZ NOT NULL DEFAULT timezone('America/Bogota', NOW())`
   - `updated_at TIMESTAMPTZ NOT NULL DEFAULT timezone('America/Bogota', NOW())`
   - `UNIQUE(workspace_id, carrier)` -- one config per carrier per workspace

2. Add comment on password column:
   ```sql
   COMMENT ON COLUMN carrier_configs.portal_password IS 'Portal password stored in plaintext (v3.0). Not payment credentials. Encryption deferred to v4.0+.';
   ```

3. Enable RLS and create policies (following codebase pattern):
   ```sql
   ALTER TABLE carrier_configs ENABLE ROW LEVEL SECURITY;

   CREATE POLICY "select_carrier_configs" ON carrier_configs
     FOR SELECT USING (is_workspace_member(workspace_id));

   CREATE POLICY "insert_carrier_configs" ON carrier_configs
     FOR INSERT WITH CHECK (is_workspace_admin(workspace_id));

   CREATE POLICY "update_carrier_configs" ON carrier_configs
     FOR UPDATE USING (is_workspace_admin(workspace_id));

   CREATE POLICY "delete_carrier_configs" ON carrier_configs
     FOR DELETE USING (is_workspace_admin(workspace_id));
   ```

4. Grants:
   ```sql
   GRANT ALL ON carrier_configs TO authenticated;
   GRANT ALL ON carrier_configs TO service_role;
   ```

5. Auto-update trigger:
   ```sql
   CREATE TRIGGER update_carrier_configs_updated_at
     BEFORE UPDATE ON carrier_configs
     FOR EACH ROW
     EXECUTE FUNCTION update_updated_at_column();
   ```

6. Index for workspace lookup:
   ```sql
   CREATE INDEX idx_carrier_configs_workspace ON carrier_configs(workspace_id);
   ```
  </action>
  <verify>
Run: `grep "CREATE TABLE carrier_configs" supabase/migrations/20260222000002_carrier_configs.sql` -- should exist.
Run: `grep "ENABLE ROW LEVEL SECURITY" supabase/migrations/20260222000002_carrier_configs.sql` -- should exist.
Run: `grep "is_workspace_member" supabase/migrations/20260222000002_carrier_configs.sql` -- should show SELECT policy.
Run: `grep "is_workspace_admin" supabase/migrations/20260222000002_carrier_configs.sql` -- should show INSERT/UPDATE/DELETE policies.
Run: `grep "update_updated_at_column" supabase/migrations/20260222000002_carrier_configs.sql` -- should show trigger.
Run: `grep "UNIQUE" supabase/migrations/20260222000002_carrier_configs.sql` -- should show workspace_id+carrier unique.
  </verify>
  <done>
carrier_configs table exists with UUID PK, workspace_id FK, carrier, portal_username/password, is_enabled flag. UNIQUE(workspace_id, carrier) constraint enforced. RLS enabled with workspace member/admin policies. Auto-update trigger on updated_at. Follows exact codebase pattern.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create robot_jobs and robot_job_items tracking tables</name>
  <files>supabase/migrations/20260222000003_robot_jobs.sql</files>
  <action>
Create a SQL migration for the robot job tracking tables (parent/child pattern). These are workspace-scoped with RLS.

1. Create `robot_jobs` table (batch-level tracking):
   - `id UUID PRIMARY KEY DEFAULT gen_random_uuid()`
   - `workspace_id UUID NOT NULL REFERENCES workspaces(id) ON DELETE CASCADE`
   - `carrier TEXT NOT NULL DEFAULT 'coordinadora'`
   - `status TEXT NOT NULL DEFAULT 'pending' CHECK (status IN ('pending', 'processing', 'completed', 'failed'))`
   - `total_items INTEGER NOT NULL DEFAULT 0`
   - `success_count INTEGER NOT NULL DEFAULT 0`
   - `error_count INTEGER NOT NULL DEFAULT 0`
   - `idempotency_key TEXT` -- optional, for duplicate batch prevention
   - `started_at TIMESTAMPTZ`
   - `completed_at TIMESTAMPTZ`
   - `created_at TIMESTAMPTZ NOT NULL DEFAULT timezone('America/Bogota', NOW())`
   - `updated_at TIMESTAMPTZ NOT NULL DEFAULT timezone('America/Bogota', NOW())`
   - `UNIQUE(workspace_id, idempotency_key)` -- prevent duplicate batch submissions within workspace

2. Create `robot_job_items` table (per-order tracking):
   - `id UUID PRIMARY KEY DEFAULT gen_random_uuid()`
   - `job_id UUID NOT NULL REFERENCES robot_jobs(id) ON DELETE CASCADE`
   - `order_id UUID NOT NULL REFERENCES orders(id) ON DELETE CASCADE`
   - `status TEXT NOT NULL DEFAULT 'pending' CHECK (status IN ('pending', 'processing', 'success', 'error'))`
   - `tracking_number TEXT` -- # pedido Coordinadora (NOT guia), null until success
   - `validated_city TEXT` -- the exact Coordinadora city string used for this order
   - `value_sent JSONB` -- snapshot of PedidoInput sent to robot (audit trail)
   - `error_type TEXT CHECK (error_type IS NULL OR error_type IN ('validation', 'portal', 'timeout', 'unknown'))`
   - `error_message TEXT`
   - `retry_count INTEGER NOT NULL DEFAULT 0`
   - `last_retry_at TIMESTAMPTZ`
   - `started_at TIMESTAMPTZ`
   - `completed_at TIMESTAMPTZ`
   - `created_at TIMESTAMPTZ NOT NULL DEFAULT timezone('America/Bogota', NOW())`
   - `updated_at TIMESTAMPTZ NOT NULL DEFAULT timezone('America/Bogota', NOW())`
   - `UNIQUE(job_id, order_id)` -- each order appears once per job

3. Indexes for robot_jobs:
   ```sql
   CREATE INDEX idx_robot_jobs_workspace ON robot_jobs(workspace_id);
   CREATE INDEX idx_robot_jobs_status ON robot_jobs(workspace_id, status);
   CREATE INDEX idx_robot_jobs_idempotency ON robot_jobs(workspace_id, idempotency_key) WHERE idempotency_key IS NOT NULL;
   ```

4. Indexes for robot_job_items:
   ```sql
   CREATE INDEX idx_robot_job_items_job ON robot_job_items(job_id);
   CREATE INDEX idx_robot_job_items_order ON robot_job_items(order_id);
   CREATE INDEX idx_robot_job_items_status ON robot_job_items(job_id, status);
   ```

5. Enable RLS on BOTH tables and create policies:
   ```sql
   -- robot_jobs RLS
   ALTER TABLE robot_jobs ENABLE ROW LEVEL SECURITY;

   CREATE POLICY "select_robot_jobs" ON robot_jobs
     FOR SELECT USING (is_workspace_member(workspace_id));

   CREATE POLICY "insert_robot_jobs" ON robot_jobs
     FOR INSERT WITH CHECK (is_workspace_member(workspace_id));

   CREATE POLICY "update_robot_jobs" ON robot_jobs
     FOR UPDATE USING (is_workspace_member(workspace_id));

   -- robot_job_items RLS (workspace check through parent join)
   ALTER TABLE robot_job_items ENABLE ROW LEVEL SECURITY;

   CREATE POLICY "select_robot_job_items" ON robot_job_items
     FOR SELECT USING (
       EXISTS (
         SELECT 1 FROM robot_jobs rj
         WHERE rj.id = robot_job_items.job_id
         AND is_workspace_member(rj.workspace_id)
       )
     );

   CREATE POLICY "insert_robot_job_items" ON robot_job_items
     FOR INSERT WITH CHECK (
       EXISTS (
         SELECT 1 FROM robot_jobs rj
         WHERE rj.id = robot_job_items.job_id
         AND is_workspace_member(rj.workspace_id)
       )
     );

   CREATE POLICY "update_robot_job_items" ON robot_job_items
     FOR UPDATE USING (
       EXISTS (
         SELECT 1 FROM robot_jobs rj
         WHERE rj.id = robot_job_items.job_id
         AND is_workspace_member(rj.workspace_id)
       )
     );
   ```

6. Grants:
   ```sql
   GRANT ALL ON robot_jobs TO authenticated;
   GRANT ALL ON robot_jobs TO service_role;
   GRANT ALL ON robot_job_items TO authenticated;
   GRANT ALL ON robot_job_items TO service_role;
   ```

7. Auto-update triggers:
   ```sql
   CREATE TRIGGER update_robot_jobs_updated_at
     BEFORE UPDATE ON robot_jobs
     FOR EACH ROW
     EXECUTE FUNCTION update_updated_at_column();

   CREATE TRIGGER update_robot_job_items_updated_at
     BEFORE UPDATE ON robot_job_items
     FOR EACH ROW
     EXECUTE FUNCTION update_updated_at_column();
   ```

8. Enable Supabase Realtime on robot_job_items (for Chat de Comandos real-time progress in Phase 24):
   ```sql
   DO $$
   BEGIN
     ALTER PUBLICATION supabase_realtime ADD TABLE robot_job_items;
   EXCEPTION WHEN duplicate_object THEN
     NULL;
   END;
   $$;
   ```

**Important:** Use the exact same comment style as existing migrations. Include a header comment explaining the table's purpose.
  </action>
  <verify>
Run: `grep "CREATE TABLE robot_jobs" supabase/migrations/20260222000003_robot_jobs.sql` -- should exist.
Run: `grep "CREATE TABLE robot_job_items" supabase/migrations/20260222000003_robot_jobs.sql` -- should exist.
Run: `grep "ENABLE ROW LEVEL SECURITY" supabase/migrations/20260222000003_robot_jobs.sql` -- should appear twice (once per table).
Run: `grep "is_workspace_member" supabase/migrations/20260222000003_robot_jobs.sql` -- should appear in policies.
Run: `grep "REFERENCES orders" supabase/migrations/20260222000003_robot_jobs.sql` -- should show robot_job_items -> orders FK.
Run: `grep "supabase_realtime" supabase/migrations/20260222000003_robot_jobs.sql` -- should show realtime publication.
Run: `grep "CHECK" supabase/migrations/20260222000003_robot_jobs.sql` -- should show status CHECK constraints for both tables.
  </verify>
  <done>
robot_jobs table with UUID PK, workspace_id FK, status state machine (pending/processing/completed/failed), counters, idempotency_key with UNIQUE constraint. robot_job_items with UUID PK, job_id FK CASCADE, order_id FK CASCADE, per-order status (pending/processing/success/error), tracking_number, validated_city, value_sent JSONB, error_type/message, retry_count. Both tables have RLS, auto-update triggers, and appropriate indexes. robot_job_items added to Supabase Realtime publication.
  </done>
</task>

</tasks>

<verification>
1. Both migration files follow naming convention and order correctly (000002 before 000003)
2. carrier_configs has workspace_id FK, UNIQUE(workspace_id, carrier), RLS with admin policies
3. robot_jobs has workspace_id FK, status CHECK, idempotency_key UNIQUE
4. robot_job_items has job_id FK CASCADE, order_id FK CASCADE, status CHECK, error_type CHECK, UNIQUE(job_id, order_id)
5. All three tables use timezone('America/Bogota', NOW()) for timestamps
6. All three tables have RLS enabled with is_workspace_member policies
7. Auto-update triggers on all three tables
8. robot_job_items is in Supabase Realtime publication
</verification>

<success_criteria>
- carrier_configs: per-workspace carrier credentials with portal_username/portal_password, is_enabled flag, admin-only write access
- robot_jobs: batch-level job tracking with status state machine and idempotency protection
- robot_job_items: per-order tracking with independent status, tracking_number, error categorization, retry support
- All workspace-scoped tables have proper RLS following existing patterns
- robot_job_items subscriptions possible via Supabase Realtime
</success_criteria>

<output>
After completion, create `.planning/phases/21-db-domain-foundation/21-02-SUMMARY.md`
</output>
