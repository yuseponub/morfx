---
phase: 16.1-engine-unification
plan: 03
type: execute
wave: 2
depends_on: ["16.1-01"]
files_modified:
  - src/lib/agents/engine-adapters/sandbox/storage.ts
  - src/lib/agents/engine-adapters/sandbox/timer.ts
  - src/lib/agents/engine-adapters/sandbox/messaging.ts
  - src/lib/agents/engine-adapters/sandbox/orders.ts
  - src/lib/agents/engine-adapters/sandbox/debug.ts
  - src/lib/agents/engine-adapters/sandbox/index.ts
  - src/lib/agents/engine-adapters/production/storage.ts
  - src/lib/agents/engine-adapters/production/timer.ts
  - src/lib/agents/engine-adapters/production/messaging.ts
  - src/lib/agents/engine-adapters/production/orders.ts
  - src/lib/agents/engine-adapters/production/debug.ts
  - src/lib/agents/engine-adapters/production/index.ts
  - src/lib/agents/engine-adapters/index.ts
autonomous: true
note: "Adapters do NOT import from somnio-agent.ts. They only import from engine/types.ts (interfaces) and their respective I/O libraries (SessionManager, Inngest, MessageSequencer, etc.). Plan 02 and Plan 03 are truly independent — both depend only on Plan 01 types."

must_haves:
  truths:
    - "SandboxStorageAdapter builds mock session with intentsVistos BEFORE current intent (preserves primera_vez detection)"
    - "SandboxTimerAdapter accumulates sequential signals correctly (cancel ingest + start promo)"
    - "ProductionStorageAdapter delegates to SessionManager for all DB operations"
    - "ProductionTimerAdapter emits Inngest events at all 4 points (ingest_start, ingest_complete, customerMessage, modeTransition)"
    - "ProductionMessagingAdapter uses MessageSequencer for delayed message sending via WhatsApp"
    - "ProductionOrdersAdapter uses OrderCreator for direct DB order creation"
    - "SandboxOrdersAdapter uses CrmOrchestrator with dry-run/live mode annotation"
  artifacts:
    - path: "src/lib/agents/engine-adapters/sandbox/index.ts"
      provides: "createSandboxAdapters() factory"
      exports: ["createSandboxAdapters"]
    - path: "src/lib/agents/engine-adapters/production/index.ts"
      provides: "createProductionAdapters() factory"
      exports: ["createProductionAdapters"]
    - path: "src/lib/agents/engine-adapters/index.ts"
      provides: "Re-exports both factories"
  key_links:
    - from: "src/lib/agents/engine-adapters/production/storage.ts"
      to: "src/lib/agents/session-manager.ts"
      via: "uses SessionManager for DB operations"
      pattern: "SessionManager"
    - from: "src/lib/agents/engine-adapters/production/timer.ts"
      to: "src/inngest/client.ts"
      via: "dynamic import for Inngest event emission"
      pattern: "import.*inngest/client"
    - from: "src/lib/agents/engine-adapters/production/messaging.ts"
      to: "src/lib/agents/somnio/message-sequencer.ts"
      via: "uses MessageSequencer for delayed sending"
      pattern: "MessageSequencer"
    - from: "src/lib/agents/engine-adapters/sandbox/orders.ts"
      to: "src/lib/agents/crm/crm-orchestrator.ts"
      via: "uses crmOrchestrator.route()"
      pattern: "crmOrchestrator\\.route"
---

<objective>
Implement all 10 adapter classes (5 sandbox + 5 production) that encapsulate environment-specific I/O.

Purpose: These adapters are the "different parts" that justify two engines today. By extracting them into discrete classes behind interfaces, the unified engine becomes environment-agnostic. Each adapter is a thin I/O wrapper — it translates the generic adapter interface call into an environment-specific I/O operation (e.g., StorageAdapter.saveState → SessionManager.updateState for production, or → in-memory merge for sandbox). Adapters contain ZERO business logic; they only do reads, writes, and event emissions. This is why 13 files across 2 tasks is manageable — each file is 20-80 lines of delegation code.
Output: 13 files in `src/lib/agents/engine-adapters/` (5+1 sandbox, 5+1 production, 1 root barrel).
</objective>

<execution_context>
@/home/jose147/.claude/get-shit-done/workflows/execute-plan.md
@/home/jose147/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/phases/16.1-engine-unification/16.1-CONTEXT.md
@.planning/phases/16.1-engine-unification/16.1-RESEARCH.md
@.planning/phases/16.1-engine-unification/16.1-01-SUMMARY.md

Key source files for extraction:
@src/lib/sandbox/sandbox-engine.ts (sandbox I/O patterns to extract)
@src/lib/agents/somnio/somnio-engine.ts (production I/O patterns to extract)
@src/lib/agents/engine/types.ts (adapter interfaces from Plan 01)
@src/lib/agents/session-manager.ts (SessionManager for production storage)
@src/lib/agents/somnio/message-sequencer.ts (MessageSequencer for production messaging)
@src/lib/agents/somnio/order-creator.ts (OrderCreator for production orders)
@src/lib/agents/crm/crm-orchestrator.ts (CrmOrchestrator for sandbox orders)
@src/lib/sandbox/types.ts (SandboxState, DebugTurn, etc.)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create sandbox adapter implementations</name>
  <files>
    src/lib/agents/engine-adapters/sandbox/storage.ts
    src/lib/agents/engine-adapters/sandbox/timer.ts
    src/lib/agents/engine-adapters/sandbox/messaging.ts
    src/lib/agents/engine-adapters/sandbox/orders.ts
    src/lib/agents/engine-adapters/sandbox/debug.ts
    src/lib/agents/engine-adapters/sandbox/index.ts
  </files>
  <action>
Create 6 files under `src/lib/agents/engine-adapters/sandbox/`:

**1. storage.ts — SandboxStorageAdapter:**
- Constructor receives: `SandboxState` (initial state), `history: { role: 'user' | 'assistant'; content: string }[]`, `workspaceId?: string`
- `getSession()`: Build and return an `AgentSessionLike` from the in-memory state. This replaces the mock session building from sandbox-engine.ts lines 226-257.
  - CRITICAL: Use `this.state.intentsVistos` (the current snapshot) when building the session. The agent will call this BEFORE adding the current intent, preserving the primera_vez ordering.
  - Map `intentsVistos: string[]` to `IntentRecord[]` format: `{ intent, orden: idx+1, timestamp: now }`
  - Fields: id='sandbox-session', agent_id from somnioAgentConfig.id, conversation_id='sandbox-conversation', contact_id='sandbox-contact', workspace_id from constructor param or 'sandbox-workspace', version=1, status='active', current_mode from state
- `getOrCreateSession()`: Same as getSession() (sandbox always has state)
- `getHistory()`: Return the history array passed to constructor
- `saveState()`: Merge updates into internal state (spread operator)
- `updateMode()`: Update currentMode in internal state
- `addTurn()`: No-op (sandbox doesn't persist turns to DB)
- `addIntentSeen()`: No-op (the agent tracks intents in its output)
- `handoff()`: No-op (sandbox returns handoff state directly)
- Expose `getState(): SandboxState` getter for reading current state after processing

**2. timer.ts — SandboxTimerAdapter:**
- Constructor: no params
- Internal: `lastSignal: TimerSignal | null = null`
- `signal(signal)`: Store as lastSignal. Supports sequential calls (cancel then start = lastSignal is start). This preserves the two-step pattern.
- All optional methods (onCustomerMessage, onModeTransition, etc.): Not implemented (undefined)
- `getLastSignal()`: Return lastSignal or undefined

**3. messaging.ts — SandboxMessagingAdapter:**
- `send()`: No-op, return `{ messagesSent: 0 }`. Sandbox collects messages from agent output directly, doesn't dispatch them.

**4. orders.ts — SandboxOrdersAdapter:**
- Constructor receives: `crmModes?: CrmMode[]`, `workspaceId?: string`
- `createOrder()`: Route to `crmOrchestrator.route()` if order-manager mode is configured, using the mode (dry-run/live). Return tool calls and token usage for debug. If no order-manager mode configured, return placeholder result.
- Import `crmOrchestrator` from `@/lib/agents/crm`
- This extracts lines 347-394 from sandbox-engine.ts

**5. debug.ts — SandboxDebugAdapter:**
- Internal accumulator for intent info, tools, tokens, state
- `recordIntent(info)`: Store intent
- `recordTools(tools)`: Append to tools list
- `recordTokens(tokens)`: Store token details
- `recordState(state)`: Store state
- `getDebugTurn(turnNumber)`: Build and return DebugTurn from accumulated data

**6. index.ts — Factory:**
```typescript
export function createSandboxAdapters(params: {
  state: SandboxState
  history: { role: 'user' | 'assistant'; content: string }[]
  crmModes?: CrmMode[]
  workspaceId?: string
}): EngineAdapters {
  return {
    storage: new SandboxStorageAdapter(params.state, params.history, params.workspaceId),
    timer: new SandboxTimerAdapter(),
    messaging: new SandboxMessagingAdapter(),
    orders: new SandboxOrdersAdapter(params.crmModes, params.workspaceId),
    debug: new SandboxDebugAdapter(),
  }
}
```
Also re-export individual adapter classes for direct access when needed.
  </action>
  <verify>`npx tsc --noEmit` passes. All 5 sandbox adapters implement their interfaces correctly.</verify>
  <done>5 sandbox adapter classes created with factory function. Mock session building preserved in SandboxStorageAdapter. Timer two-step pattern preserved in SandboxTimerAdapter.</done>
</task>

<task type="auto">
  <name>Task 2: Create production adapter implementations</name>
  <files>
    src/lib/agents/engine-adapters/production/storage.ts
    src/lib/agents/engine-adapters/production/timer.ts
    src/lib/agents/engine-adapters/production/messaging.ts
    src/lib/agents/engine-adapters/production/orders.ts
    src/lib/agents/engine-adapters/production/debug.ts
    src/lib/agents/engine-adapters/production/index.ts
  </files>
  <action>
Create 6 files under `src/lib/agents/engine-adapters/production/`:

**1. storage.ts — ProductionStorageAdapter:**
- Constructor receives: `SessionManager` instance, `workspaceId: string`
- `getSession(sessionId)`: Call `sessionManager.getSession(sessionId)`, return as AgentSessionLike
- `getOrCreateSession(conversationId, contactId)`: Call `sessionManager.getSessionByConversation()`. If null, call `sessionManager.createSession()`. This extracts somnio-engine.ts lines 405-427.
- `getHistory(sessionId)`: Call `sessionManager.getTurns(sessionId)`, filter out 'system' role and empty content, map to `{ role, content }`. This extracts somnio-engine.ts lines 432-442.
- `saveState(sessionId, updates)`: Call `sessionManager.updateState(sessionId, updates)`. This extracts somnio-engine.ts lines 465-499 (applyStateUpdates).
- `updateMode(sessionId, version, newMode)`: Call `sessionManager.updateSessionWithVersion(sessionId, version, { currentMode: newMode, lastActivityAt: new Date().toISOString() })`
- `addTurn(params)`: Call `sessionManager.addTurn(params)`. Maps to somnio-engine.ts lines 209-217.
- `addIntentSeen(sessionId, intent)`: Call `sessionManager.addIntentSeen(sessionId, intent)`. Maps to somnio-engine.ts line 220.
- `handoff(sessionId, version)`: Call `sessionManager.handoffSession(sessionId, version)`. Maps to somnio-engine.ts lines 447-460.

**2. timer.ts — ProductionTimerAdapter:**
- Constructor receives: `workspaceId: string`
- `signal()`: No-op (production uses specific Inngest events, not generic signals)
- `getLastSignal()`: Return undefined (production doesn't need this)
- `onCustomerMessage(sessionId, conversationId, content)`: Emit `agent/message.received` Inngest event (for timer cancellation workflow). Dynamic import of inngest client. Non-blocking (try/catch with logging).
- `onModeTransition(sessionId, previousMode, newMode)`: Emit `agent/mode.transitioned` Inngest event. Non-blocking.
- `onIngestStarted(session, hasPartialData)`: Emit `agent/ingest.started` Inngest event with timerDurationMs (6min partial, 10min no data). This extracts somnio-engine.ts lines 754-788.
- `onIngestCompleted(sessionId, reason)`: Emit `agent/ingest.completed` Inngest event. This extracts somnio-engine.ts lines 796-818.
- All Inngest emissions: dynamic import, non-blocking, logged via createModuleLogger.

**3. messaging.ts — ProductionMessagingAdapter:**
- Constructor receives: `SessionManager`, `conversationId: string`, `workspaceId: string`, `phoneNumber?: string`
- `send(params)`: Build message sequence via `MessageSequencer.buildSequence()`, merge with pending via `mergeWithPending()`, execute via `executeSequence()`. Return `{ messagesSent }`. This extracts somnio-engine.ts lines 324-348.
- Uses `MessageSequencer` from `../../somnio/message-sequencer`

**4. orders.ts — ProductionOrdersAdapter:**
- Constructor receives: `workspaceId: string`
- `createOrder(data)`: Extract contact data from datosCapturados, validate required fields (nombre, telefono, direccion, ciudad, departamento), call `OrderCreator.createContactAndOrder()`. Return { success, orderId, contactId }. This extracts somnio-engine.ts lines 269-322.
- Uses `OrderCreator` from `../../somnio/order-creator`

**5. debug.ts — ProductionDebugAdapter:**
- `recordIntent()`, `recordTools()`, `recordTokens()`, `recordState()`: All no-ops (production only logs)
- `getDebugTurn()`: Returns undefined (no debug output for production)
- Uses `createModuleLogger` for any logging needed

**6. index.ts — Factory:**
```typescript
export function createProductionAdapters(params: {
  workspaceId: string
  conversationId: string
  phoneNumber?: string
  sessionManager?: SessionManager
}): EngineAdapters {
  const sessionManager = params.sessionManager ?? new SessionManager()
  return {
    storage: new ProductionStorageAdapter(sessionManager, params.workspaceId),
    timer: new ProductionTimerAdapter(params.workspaceId),
    messaging: new ProductionMessagingAdapter(sessionManager, params.conversationId, params.workspaceId, params.phoneNumber),
    orders: new ProductionOrdersAdapter(params.workspaceId),
    debug: new ProductionDebugAdapter(),
  }
}
```
Also re-export individual adapter classes.

**Root barrel (src/lib/agents/engine-adapters/index.ts):**
```typescript
export { createSandboxAdapters } from './sandbox'
export { createProductionAdapters } from './production'
```
  </action>
  <verify>`npx tsc --noEmit` passes. All 5 production adapters implement their interfaces correctly.</verify>
  <done>5 production adapter classes + 5 sandbox adapter classes + 3 barrel files. All adapters implement correct interfaces. Production timer emits all 4 Inngest event types.</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes
2. `createSandboxAdapters()` returns valid EngineAdapters bundle
3. `createProductionAdapters()` returns valid EngineAdapters bundle
4. ProductionStorageAdapter delegates all calls to SessionManager
5. SandboxTimerAdapter preserves sequential signal pattern (cancel then start)
6. ProductionTimerAdapter has all 4 Inngest event emission methods
</verification>

<success_criteria>
- 10 adapter classes implementing 5 interfaces
- 3 barrel files (sandbox/index, production/index, root/index)
- All adapters compile without errors
- Each adapter encapsulates environment-specific I/O with zero business logic
</success_criteria>

<output>
After completion, create `.planning/phases/16.1-engine-unification/16.1-03-SUMMARY.md`
</output>
