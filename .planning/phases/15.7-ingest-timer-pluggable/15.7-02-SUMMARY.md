---
phase: 15.7-ingest-timer-pluggable
plan: 02
subsystem: sandbox-timer-ui
tags: [timer, ingest, sandbox, ui, react, sliders, countdown]
depends_on:
  requires: [15.7-01]
  provides: [timer-ui-integration, timer-state-management, 5-level-slider-controls]
  affects: [15.7-03]
tech-stack:
  added: []
  patterns: [ref-based-stale-closure-prevention, callback-ref-pattern, prop-drilling-through-panels]
key-files:
  created: []
  modified:
    - src/app/(dashboard)/sandbox/components/sandbox-layout.tsx
    - src/app/(dashboard)/sandbox/components/debug-panel/debug-tabs.tsx
    - src/app/(dashboard)/sandbox/components/debug-panel/panel-container.tsx
    - src/app/(dashboard)/sandbox/components/debug-panel/ingest-tab.tsx
decisions:
  - Use timerExpireRef pattern to prevent stale closures in simulator callbacks
  - Use shadcn Switch component (not inline toggle) for timer enable/disable
  - PackSelection is always string|null in SandboxState, no .pack accessor needed
  - Slider ranges differ per level (L2 max 300s, L0/L3/L4 max 900s, L1 max 600s)
  - TimerDisplay shows M:SS format with level identifier and pause button inline
metrics:
  duration: 8m25s
  completed: 2026-02-08
---

# Phase 15.7 Plan 02: Timer UI Integration Summary

IngestTimerSimulator wired into sandbox-layout with full state management, timer signal processing from SandboxEngine, and 5-level timer UI with sliders/presets/countdown in the Ingest tab.

## What Was Done

### Task 1: Integrate timer into sandbox-layout with state management and action handling
Modified `src/app/(dashboard)/sandbox/components/sandbox-layout.tsx` (+184 lines):
- **Timer state**: timerState, timerEnabled, timerConfig managed via useState
- **simulatorRef**: useRef holding IngestTimerSimulator instance
- **timerExpireRef**: Callback ref pattern to prevent stale closures in simulator's onExpire
- **startTimerForLevel**: Helper to start timer at a level using current config
- **handleTimerExpire**: Processes timer actions on expiration:
  - Injects messages into chat as normal assistant messages
  - Handles mode transitions (level 2 -> ofrecer_promos)
  - Chains level 2 to level 3 via setTimeout
  - Shows placeholder messages for order creation (levels 3/4)
- **Timer signal processing in handleSendMessage**: Processes start/reevaluate/cancel signals from SandboxEngineResult, builds TimerEvalContext from new state, delegates to simulator
- **handleTimerConfigChange**: Updates config and restarts active timer with new duration
- **handleTimerToggle**: Enables/disables timer, stops simulator when disabled
- **handleTimerPause**: Toggles pause/resume on active timer
- **handleReset**: Stops timer, resets state, disables toggle on session reset
- **Props**: 6 timer props passed to DebugTabs component

### Task 2: Wire timer props through debug panel and rebuild IngestTab
Modified 3 files:

**debug-tabs.tsx**: Added 6 timer props to DebugTabsProps interface, destructured in component, forwarded to PanelContainer.

**panel-container.tsx**: Added 6 timer props to PanelContainerProps, forwarded to IngestTab in 'ingest' case of PanelContent switch.

**ingest-tab.tsx** (complete rewrite, 318 lines):
- **TimerDisplay** (replaces TimerCountdown): Shows countdown in M:SS format with "(LN: level name)" label and inline Pause/Play button
- **StatusGrid** (updated): Accepts timerState/onTimerPause, renders TimerDisplay instead of old cosmetic TimerCountdown
- **TimerControlsV2** (replaces TimerControls):
  - shadcn Switch toggle to enable/disable timer simulation
  - 3 preset buttons (Real/Rapido/Instantaneo) via ToggleGroup
  - 5 independent Slider controls with per-level min/max/step ranges
  - Auto-detects current preset from slider values
- Removed: old TimerCountdown, TimerControls, local TIMER_PRESETS type/constant, TimerPresetConfig type
- Removed unused imports: useState, useEffect, useCallback, formatDistanceToNow, es locale

## Decisions Made

| Decision | Context | Rationale |
|----------|---------|-----------|
| timerExpireRef callback ref pattern | Simulator created once on mount, but expire handler depends on changing state | Prevents stale closures without recreating simulator on every render |
| shadcn Switch for toggle | Plan suggested inline toggle or Switch | Switch component exists in project, provides better a11y and consistent styling |
| PackSelection direct access (no .pack) | Plan used .pack accessor on packSeleccionado | PackSelection is `'1x'\|'2x'\|'3x'` (string union), not an object - fixed type error |
| Per-level slider ranges | All sliders could use same range | Different levels have different practical ranges (L2 datos minimos rarely needs >5min) |

## Deviations from Plan

### Auto-fixed Issues

**1. [Rule 1 - Bug] Fixed PackSelection type access**
- **Found during:** Task 1
- **Issue:** Plan used `result.newState.packSeleccionado?.pack` but PackSelection is a string type, not an object with a .pack property
- **Fix:** Changed to `result.newState.packSeleccionado ?? null` (direct string access)
- **Files modified:** sandbox-layout.tsx
- **Commit:** 3a7d499

**2. [Rule 2 - Missing Critical] Used shadcn Switch instead of inline toggle**
- **Found during:** Task 2
- **Issue:** Plan suggested inline toggle button as fallback; project has proper Switch component
- **Fix:** Used `@/components/ui/switch` Switch component with size="sm" for consistent UI
- **Files modified:** ingest-tab.tsx
- **Commit:** 6e2a36b

## Verification Results

- `npx tsc --noEmit`: PASS (zero errors)
- sandbox-layout.tsx manages IngestTimerSimulator lifecycle with ref
- Timer signals from SandboxEngine are processed (start/reevaluate/cancel)
- Timer expiration injects messages into chat
- Level 2 chains to level 3 via setTimeout
- Session reset stops timer and disables toggle
- Timer config changes restart active timer
- IngestTab renders 5 sliders (one per TIMER_LEVELS entry)
- TimerDisplay shows countdown in M:SS (LN: name) format
- 3 presets set all 5 sliders simultaneously
- Pause/Resume button toggles timer state

## Next Phase Readiness

Plan 03 can now:
- Use the fully functional timer simulation in sandbox for end-to-end testing
- Add any additional timer-related features (e.g., timer history, analytics)
- The entire timer pipeline works: SandboxEngine emits signals -> sandbox-layout processes them -> IngestTimerSimulator counts down -> TimerDisplay shows progress -> expire handler injects messages
