---
phase: 10.1-task-notes-history
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/20260204000001_task_notes_history.sql
  - src/lib/tasks/types.ts
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Task changes are automatically logged to task_activity table"
    - "Task notes can be stored in task_notes table"
    - "Postponement count increments when due_date is moved forward"
  artifacts:
    - path: "supabase/migrations/20260204000001_task_notes_history.sql"
      provides: "task_notes table, task_activity table, log_task_changes trigger"
      contains: "CREATE TABLE task_notes"
    - path: "src/lib/tasks/types.ts"
      provides: "TaskNote, TaskActivity types"
      contains: "interface TaskNote"
  key_links:
    - from: "tasks table UPDATE"
      to: "task_activity INSERT"
      via: "log_task_changes() trigger"
      pattern: "CREATE TRIGGER.*log_task_changes"
    - from: "task_activity"
      to: "tasks.postponement_count"
      via: "trigger increments on due_date forward move"
      pattern: "postponement_count.*:=.*\\+ 1"
---

<objective>
Create database foundation for task notes and change history tracking with automatic postponement detection.

Purpose: Enable notes and activity logging for tasks following the proven contact_notes/contact_activity pattern. The trigger automatically logs all task changes and increments postponement_count when due_date is moved forward.

Output: Migration file with task_notes table, task_activity table, log_task_changes trigger function, and RLS policies. Extended TypeScript types for notes and activity.
</objective>

<execution_context>
@/home/jose147/.claude/get-shit-done/workflows/execute-plan.md
@/home/jose147/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10.1-task-notes-history/10.1-RESEARCH.md

# Key reference files
@supabase/migrations/20260129000002_custom_fields_notes_activity.sql
@supabase/migrations/20260203000004_tasks_foundation.sql
@src/lib/tasks/types.ts
@src/lib/custom-fields/types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create task notes and activity migration</name>
  <files>supabase/migrations/20260204000001_task_notes_history.sql</files>
  <action>
Create migration file following the contact_notes/contact_activity pattern exactly:

1. **Add postponement_count column to tasks:**
```sql
ALTER TABLE tasks ADD COLUMN IF NOT EXISTS postponement_count INTEGER NOT NULL DEFAULT 0;
```

2. **Create task_notes table** (mirror contact_notes):
- id UUID PRIMARY KEY
- task_id UUID NOT NULL REFERENCES tasks(id) ON DELETE CASCADE
- workspace_id UUID NOT NULL REFERENCES workspaces(id) ON DELETE CASCADE
- user_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE
- content TEXT NOT NULL
- created_at/updated_at TIMESTAMPTZ with America/Bogota timezone
- Indexes: task_id, workspace_id, created_at DESC
- Trigger for updated_at

3. **Create task_activity table** (mirror contact_activity):
- id UUID PRIMARY KEY
- task_id UUID NOT NULL REFERENCES tasks(id) ON DELETE CASCADE
- workspace_id UUID NOT NULL REFERENCES workspaces(id) ON DELETE CASCADE
- user_id UUID REFERENCES auth.users(id) ON DELETE SET NULL (nullable - system actions)
- action TEXT NOT NULL (created, updated, completed, reopened, due_date_changed, note_added, note_updated, note_deleted)
- changes JSONB (for field-level diffs)
- metadata JSONB (for note previews, etc.)
- created_at TIMESTAMPTZ
- Indexes: task_id, workspace_id, created_at DESC, action
- Special index: (task_id, action) WHERE action = 'due_date_changed'

4. **Create log_task_changes() trigger function:**
- SECURITY DEFINER with SET search_path = public
- Handle INSERT: log 'created' with full record
- Handle UPDATE:
  - Build JSONB diff excluding updated_at
  - Determine action type: 'due_date_changed' if due_date changed, 'completed'/'reopened' if status changed, otherwise 'updated'
  - **CRITICAL**: If due_date changed AND NEW.due_date > OLD.due_date AND both are NOT NULL, increment NEW.postponement_count
  - Only insert if changes_json != '{}'
- Handle DELETE: log 'deleted' with full record
- Get user_id from auth.jwt() with try/catch

5. **Attach trigger to tasks table:**
```sql
CREATE TRIGGER task_activity_trigger
  BEFORE INSERT OR UPDATE OR DELETE ON tasks
  FOR EACH ROW
  EXECUTE FUNCTION log_task_changes();
```
Note: Use BEFORE trigger (not AFTER) because we need to modify NEW.postponement_count.

6. **RLS policies:**

For task_notes:
- SELECT: is_workspace_member(workspace_id)
- INSERT: is_workspace_member(workspace_id) AND user_id = auth.uid()
- UPDATE: (author OR admin/owner) - same pattern as contact_notes
- DELETE: (author OR admin/owner) - same pattern as contact_notes

For task_activity:
- SELECT: is_workspace_member(workspace_id)
- No INSERT/UPDATE/DELETE policies (immutable, trigger-managed via SECURITY DEFINER)

**IMPORTANT:**
- Use timezone('America/Bogota', NOW()) for all timestamps
- Match the exact structure of contact_notes and contact_activity from 20260129000002
- The log_task_changes trigger must be BEFORE (not AFTER) to modify NEW.postponement_count
  </action>
  <verify>
Run migration locally:
```bash
cd /mnt/c/Users/Usuario/Proyectos/morfx-new
# Check SQL syntax
cat supabase/migrations/20260204000001_task_notes_history.sql | head -100
# Verify contains key elements
grep -E "(CREATE TABLE task_notes|CREATE TABLE task_activity|log_task_changes|postponement_count)" supabase/migrations/20260204000001_task_notes_history.sql
```
  </verify>
  <done>
Migration file exists with:
- task_notes table mirroring contact_notes
- task_activity table mirroring contact_activity
- log_task_changes() trigger function with postponement detection
- BEFORE trigger on tasks table
- RLS policies for workspace isolation
- postponement_count column on tasks
  </done>
</task>

<task type="auto">
  <name>Task 2: Extend TypeScript types for notes and activity</name>
  <files>src/lib/tasks/types.ts</files>
  <action>
Extend the existing types.ts file. Add at the END of the file (after existing types):

1. **Add postponement_count to Task interface:**
Find the Task interface and add:
```typescript
/** Number of times due_date was moved forward (postponed) */
postponement_count: number
```

2. **Add TaskNote types:**
```typescript
// ============================================================================
// TASK NOTE TYPES
// ============================================================================

/**
 * Note attached to a task.
 * All workspace members can see notes; author (or admin/owner) can edit/delete.
 */
export interface TaskNote {
  id: string
  task_id: string
  workspace_id: string
  user_id: string
  content: string
  created_at: string
  updated_at: string
}

/**
 * Note with user profile info for display.
 */
export interface TaskNoteWithUser extends TaskNote {
  user: {
    id: string
    email: string
  }
}
```

3. **Add TaskActivity types:**
```typescript
// ============================================================================
// TASK ACTIVITY TYPES
// ============================================================================

/**
 * Task activity action types.
 * Semantic actions for better timeline display.
 */
export type TaskActivityAction =
  | 'created'
  | 'updated'
  | 'completed'
  | 'reopened'
  | 'due_date_changed'
  | 'deleted'
  | 'note_added'
  | 'note_updated'
  | 'note_deleted'

/**
 * Activity log entry for a task.
 * Immutable audit trail of all task changes.
 */
export interface TaskActivity {
  id: string
  task_id: string
  workspace_id: string
  user_id: string | null
  action: TaskActivityAction
  changes: Record<string, { old: unknown; new: unknown }> | null
  metadata: Record<string, unknown> | null
  created_at: string
}

/**
 * Activity with user profile info for display.
 */
export interface TaskActivityWithUser extends TaskActivity {
  user: {
    id: string
    email: string
  } | null
}
```

**IMPORTANT:**
- Follow the existing file's code style (semicolons, JSDoc comments)
- Add to the END of the file, preserving all existing types
- The pattern matches ContactNoteWithUser and ContactActivityWithUser from custom-fields/types.ts
  </action>
  <verify>
```bash
# Check types are added
grep -E "(interface TaskNote|interface TaskActivity|postponement_count)" /mnt/c/Users/Usuario/Proyectos/morfx-new/src/lib/tasks/types.ts
# Verify TypeScript compiles
cd /mnt/c/Users/Usuario/Proyectos/morfx-new && pnpm tsc --noEmit --skipLibCheck 2>&1 | head -20
```
  </verify>
  <done>
src/lib/tasks/types.ts contains:
- postponement_count field added to Task interface
- TaskNote and TaskNoteWithUser interfaces
- TaskActivityAction type with all action types
- TaskActivity and TaskActivityWithUser interfaces
- TypeScript compiles without errors
  </done>
</task>

</tasks>

<verification>
After both tasks complete:
1. Migration file exists with correct structure
2. Types file extended with notes and activity types
3. TypeScript compiles without errors:
```bash
cd /mnt/c/Users/Usuario/Proyectos/morfx-new && pnpm tsc --noEmit --skipLibCheck
```
</verification>

<success_criteria>
- task_notes table follows contact_notes pattern exactly
- task_activity table follows contact_activity pattern exactly
- log_task_changes trigger function handles INSERT/UPDATE/DELETE
- Postponement detection increments count only when due_date moves forward
- TypeScript types match the database schema
- All workspace isolation via RLS
</success_criteria>

<output>
After completion, create `.planning/phases/10.1-task-notes-history/10.1-01-SUMMARY.md`
</output>
