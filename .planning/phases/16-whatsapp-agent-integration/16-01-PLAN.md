---
phase: 16-whatsapp-agent-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/20260209_agent_production.sql
  - src/lib/agents/production/agent-config.ts
  - src/app/actions/agent-config.ts
  - src/lib/whatsapp/types.ts
autonomous: true

must_haves:
  truths:
    - "workspace_agent_config table exists with global toggle, agent selection, handoff message, timer preset, response speed"
    - "conversations table has agent_conversational and agent_crm nullable boolean columns"
    - "messages table has sent_by_agent boolean column"
    - "Server actions can read and update workspace agent config"
    - "Server actions can toggle per-conversation agent settings"
    - "Agent enabled resolution logic works: global OFF = all OFF, per-chat override"
  artifacts:
    - path: "supabase/migrations/20260209_agent_production.sql"
      provides: "Database schema for agent production config"
      contains: "workspace_agent_config"
    - path: "src/lib/agents/production/agent-config.ts"
      provides: "Agent config resolution and CRUD logic"
      exports: ["isAgentEnabledForConversation", "getWorkspaceAgentConfig", "AgentConfig"]
    - path: "src/app/actions/agent-config.ts"
      provides: "Server actions for agent config UI"
      exports: ["getAgentConfig", "updateAgentConfig", "toggleConversationAgent"]
  key_links:
    - from: "src/app/actions/agent-config.ts"
      to: "workspace_agent_config table"
      via: "Supabase admin client"
      pattern: "from\\('workspace_agent_config'\\)"
    - from: "src/lib/agents/production/agent-config.ts"
      to: "conversations table"
      via: "agent_conversational column check"
      pattern: "agent_conversational"
---

<objective>
Create the database foundation and config layer for production agent integration.

Purpose: All other plans depend on this foundation — the workspace_agent_config table stores global settings, conversations gain per-chat agent toggles, and messages gain agent attribution. The config resolution logic (global + per-chat override) is the core mechanism that the webhook processor, UI components, and metrics module all depend on.

Output: Migration SQL file, agent-config module with resolution logic, server actions for config CRUD.
</objective>

<execution_context>
@/home/jose147/.claude/get-shit-done/workflows/execute-plan.md
@/home/jose147/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/16-whatsapp-agent-integration/16-CONTEXT.md
@.planning/phases/16-whatsapp-agent-integration/16-RESEARCH.md

Key source files:
@src/lib/supabase/admin.ts
@src/lib/whatsapp/types.ts
@src/app/actions/conversations.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Database migration for agent production</name>
  <files>supabase/migrations/20260209_agent_production.sql</files>
  <action>
Create migration SQL with three changes:

1. **workspace_agent_config table:**
```sql
CREATE TABLE workspace_agent_config (
  workspace_id UUID PRIMARY KEY REFERENCES workspaces(id) ON DELETE CASCADE,
  agent_enabled BOOLEAN NOT NULL DEFAULT false,
  conversational_agent_id TEXT NOT NULL DEFAULT 'somnio-sales-v1',
  crm_agents_enabled JSONB NOT NULL DEFAULT '{"order-manager": true}',
  handoff_message TEXT NOT NULL DEFAULT 'Regalame 1 min, ya te comunico con un asesor',
  timer_preset TEXT NOT NULL DEFAULT 'real' CHECK (timer_preset IN ('real', 'rapido', 'instantaneo')),
  response_speed NUMERIC(3,1) NOT NULL DEFAULT 1.0,
  created_at TIMESTAMPTZ NOT NULL DEFAULT timezone('America/Bogota', NOW()),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT timezone('America/Bogota', NOW())
);
```

Add RLS policies:
- `workspace_agent_config_select`: SELECT for users who are members of the workspace (via workspace_members)
- `workspace_agent_config_update`: UPDATE for owner/admin role only
- `workspace_agent_config_insert`: INSERT for owner/admin role only

2. **conversations columns:**
```sql
ALTER TABLE conversations
  ADD COLUMN agent_conversational BOOLEAN DEFAULT NULL,
  ADD COLUMN agent_crm BOOLEAN DEFAULT NULL;
```
Add partial index: `CREATE INDEX idx_conversations_agent ON conversations(workspace_id) WHERE agent_conversational IS NOT NULL OR agent_crm IS NOT NULL;`

3. **messages column:**
```sql
ALTER TABLE messages ADD COLUMN sent_by_agent BOOLEAN NOT NULL DEFAULT false;
```

Enable RLS on workspace_agent_config:
```sql
ALTER TABLE workspace_agent_config ENABLE ROW LEVEL SECURITY;
```

Use `timezone('America/Bogota', NOW())` for all timestamps (CLAUDE.md rule).
  </action>
  <verify>Review SQL file for syntax correctness, verify RLS policies reference workspace_members correctly, confirm all three changes are present.</verify>
  <done>Migration file exists with workspace_agent_config table, conversations columns, messages column, RLS policies, and partial index.</done>
</task>

<task type="auto">
  <name>Task 2: Agent config resolution logic and server actions</name>
  <files>
    src/lib/agents/production/agent-config.ts
    src/app/actions/agent-config.ts
    src/lib/whatsapp/types.ts
  </files>
  <action>
**src/lib/agents/production/agent-config.ts:**

Create module with:

1. `AgentConfig` interface matching the workspace_agent_config table columns.

2. `getWorkspaceAgentConfig(workspaceId: string)` — Reads from workspace_agent_config using createAdminClient. Returns config or null if not configured.

3. `upsertWorkspaceAgentConfig(workspaceId: string, updates: Partial<AgentConfig>)` — Upserts config using createAdminClient. Uses `.upsert()` with `onConflict: 'workspace_id'`. Always sets `updated_at` to `new Date().toISOString()`.

4. `isAgentEnabledForConversation(conversationId: string, workspaceId: string, type: 'conversational' | 'crm' = 'conversational')` — Resolution logic:
   - Fetch workspace_agent_config. If agent_enabled is false, return false.
   - Fetch conversation's agent_conversational/agent_crm column.
   - If the column is explicitly false, return false.
   - If type is 'crm', also check crm_agents_enabled JSONB.
   - Otherwise return true (global ON, per-chat not explicitly OFF).

5. `setConversationAgentOverride(conversationId: string, type: 'conversational' | 'crm', enabled: boolean | null)` — Updates the specific column on conversations. null = inherit global.

Use createAdminClient for all DB operations (bypasses RLS, workspace isolation via explicit filters).

**src/app/actions/agent-config.ts:**

Create server actions using 'use server' directive:

1. `getAgentConfig()` — Gets current workspace from cookies, reads workspace_agent_config. Returns config or default values if none exists.

2. `updateAgentConfig(updates: Partial<AgentConfig>)` — Validates user is owner/admin (check workspace role), upserts config.

3. `toggleConversationAgent(conversationId: string, type: 'conversational' | 'crm', enabled: boolean | null)` — Validates user membership, calls setConversationAgentOverride.

4. `getConversationAgentStatus(conversationId: string)` — Returns the resolved agent status for a conversation (both conversational and crm toggles, plus global state).

All actions follow existing patterns: import createClient from server.ts for auth, createAdminClient for data operations. Check workspace membership. Return `{ error: string }` on failure, data on success.

**src/lib/whatsapp/types.ts:**

Add to Conversation interface:
```typescript
agent_conversational: boolean | null
agent_crm: boolean | null
```

Add to Message interface:
```typescript
sent_by_agent: boolean
```

These are the DB columns added by the migration.
  </action>
  <verify>TypeScript compiles without errors (`npx tsc --noEmit`). Verify agent-config.ts exports isAgentEnabledForConversation. Verify server actions export getAgentConfig, updateAgentConfig, toggleConversationAgent.</verify>
  <done>Agent config resolution logic correctly implements global+per-chat override pattern. Server actions provide complete CRUD for agent config. WhatsApp types updated with new columns.</done>
</task>

</tasks>

<verification>
- [ ] Migration SQL is syntactically correct
- [ ] workspace_agent_config has RLS policies for workspace members
- [ ] Resolution logic: global OFF -> false, per-chat OFF -> false, otherwise true
- [ ] Server actions check workspace membership and role
- [ ] TypeScript compiles cleanly
</verification>

<success_criteria>
Foundation is complete when:
1. Migration file creates workspace_agent_config table with all fields
2. conversations.agent_conversational and conversations.agent_crm columns added
3. messages.sent_by_agent column added
4. isAgentEnabledForConversation correctly resolves global+per-chat settings
5. Server actions provide full config CRUD with auth checks
6. WhatsApp types updated to include new columns
</success_criteria>

<output>
After completion, create `.planning/phases/16-whatsapp-agent-integration/16-01-SUMMARY.md`
</output>
