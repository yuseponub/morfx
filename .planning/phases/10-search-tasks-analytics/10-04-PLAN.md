---
phase: 10-search-tasks-analytics
plan: 04
type: execute
wave: 1
depends_on: []
files_modified:
  - src/components/search/global-search.tsx
  - src/components/search/search-result-item.tsx
  - src/hooks/use-global-search.ts
  - src/app/actions/search.ts
  - src/components/layout/sidebar.tsx
autonomous: true

must_haves:
  truths:
    - "User can open global search with Cmd+K / Ctrl+K"
    - "Search results include contacts, orders, and conversations"
    - "Results show type icon and preview information"
    - "User can filter results by type using tabs"
    - "Selecting a result navigates to that entity"
  artifacts:
    - path: "src/components/search/global-search.tsx"
      provides: "Command palette search UI"
      contains: "CommandDialog"
    - path: "src/hooks/use-global-search.ts"
      provides: "Search hook with Fuse.js"
      exports: ["useGlobalSearch"]
    - path: "src/app/actions/search.ts"
      provides: "Server Action for search data"
      exports: ["getSearchableItems"]
  key_links:
    - from: "global-search.tsx"
      to: "use-global-search.ts"
      via: "Hook for search state"
      pattern: "useGlobalSearch"
    - from: "sidebar.tsx"
      to: "global-search.tsx"
      via: "Renders search in sidebar"
      pattern: "GlobalSearch"
---

<objective>
Implement global search across contacts, orders, and conversations with command palette UI.

Purpose: Users can quickly find any entity in the system using Cmd+K shortcut or clicking the search input in the sidebar. Results show type and preview with keyboard navigation.

Output: GlobalSearch component, search hook, sidebar integration.
</objective>

<execution_context>
@/home/jose147/.claude/get-shit-done/workflows/execute-plan.md
@/home/jose147/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/10-search-tasks-analytics/10-CONTEXT.md
@.planning/phases/10-search-tasks-analytics/10-RESEARCH.md

# Existing patterns
@src/lib/search/fuse-config.ts
@src/components/ui/command.tsx
@src/components/layout/sidebar.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create search data fetching and hook</name>
  <files>
    src/app/actions/search.ts
    src/hooks/use-global-search.ts
    src/lib/search/global-search-config.ts
  </files>
  <action>
**1. src/app/actions/search.ts**

Server Action to fetch searchable items:

```typescript
'use server'

import { createClient } from '@/lib/supabase/server'
import { getWorkspaceId } from '@/lib/workspace/server'

export interface SearchableItem {
  type: 'contact' | 'order' | 'conversation'
  id: string
  title: string      // Primary text (name, order #, phone)
  subtitle: string   // Secondary info (phone, amount, last message)
  href: string       // Navigation target
}

export async function getSearchableItems(): Promise<SearchableItem[]> {
  const supabase = await createClient()
  const workspaceId = await getWorkspaceId()
  if (!workspaceId) return []

  // Fetch in parallel
  const [contactsResult, ordersResult, conversationsResult] = await Promise.all([
    supabase
      .from('contacts')
      .select('id, name, phone, city')
      .eq('workspace_id', workspaceId)
      .limit(500),

    supabase
      .from('orders')
      .select('id, total_value, created_at, contact:contacts(name)')
      .eq('workspace_id', workspaceId)
      .order('created_at', { ascending: false })
      .limit(500),

    supabase
      .from('conversations')
      .select('id, phone, last_message, contact:contacts(name)')
      .eq('workspace_id', workspaceId)
      .order('last_message_at', { ascending: false })
      .limit(500)
  ])

  const items: SearchableItem[] = []

  // Map contacts
  contactsResult.data?.forEach(contact => {
    items.push({
      type: 'contact',
      id: contact.id,
      title: contact.name,
      subtitle: contact.phone || contact.city || 'Sin telefono',
      href: `/crm/contactos/${contact.id}`
    })
  })

  // Map orders - format amount as currency
  ordersResult.data?.forEach(order => {
    const contactName = (order.contact as any)?.name || 'Sin cliente'
    const amount = new Intl.NumberFormat('es-CO', {
      style: 'currency',
      currency: 'COP',
      maximumFractionDigits: 0
    }).format(order.total_value || 0)

    items.push({
      type: 'order',
      id: order.id,
      title: `${contactName}`,
      subtitle: amount,
      href: `/crm/pedidos?order=${order.id}`
    })
  })

  // Map conversations
  conversationsResult.data?.forEach(conv => {
    const contactName = (conv.contact as any)?.name
    items.push({
      type: 'conversation',
      id: conv.id,
      title: contactName || conv.phone,
      subtitle: conv.last_message?.substring(0, 50) || 'Sin mensajes',
      href: `/whatsapp?chat=${conv.id}`
    })
  })

  return items
}
```

**2. src/lib/search/global-search-config.ts**

Fuse.js configuration for global search:

```typescript
import Fuse, { IFuseOptions } from 'fuse.js'
import type { SearchableItem } from '@/app/actions/search'

export const globalSearchOptions: IFuseOptions<SearchableItem> = {
  keys: [
    { name: 'title', weight: 2 },
    { name: 'subtitle', weight: 1 },
  ],
  threshold: 0.4,
  ignoreLocation: true,
  minMatchCharLength: 2,
  shouldSort: true,
  includeScore: true,
}

export function createGlobalSearcher(items: SearchableItem[]): Fuse<SearchableItem> {
  return new Fuse(items, globalSearchOptions)
}
```

**3. src/hooks/use-global-search.ts**

React hook managing search state:

```typescript
'use client'

import { useState, useEffect, useMemo, useCallback } from 'react'
import { useRouter } from 'next/navigation'
import { getSearchableItems, type SearchableItem } from '@/app/actions/search'
import { createGlobalSearcher } from '@/lib/search/global-search-config'

export type SearchFilter = 'all' | 'contact' | 'order' | 'conversation'

export function useGlobalSearch() {
  const router = useRouter()
  const [open, setOpen] = useState(false)
  const [query, setQuery] = useState('')
  const [filter, setFilter] = useState<SearchFilter>('all')
  const [items, setItems] = useState<SearchableItem[]>([])
  const [loading, setLoading] = useState(false)

  // Keyboard shortcut: Cmd+K / Ctrl+K
  useEffect(() => {
    const handleKeyDown = (e: KeyboardEvent) => {
      if ((e.metaKey || e.ctrlKey) && e.key === 'k') {
        e.preventDefault()
        setOpen(true)
      }
    }
    window.addEventListener('keydown', handleKeyDown)
    return () => window.removeEventListener('keydown', handleKeyDown)
  }, [])

  // Fetch items when dialog opens
  useEffect(() => {
    if (open && items.length === 0) {
      setLoading(true)
      getSearchableItems().then(data => {
        setItems(data)
        setLoading(false)
      })
    }
  }, [open, items.length])

  // Memoize Fuse instance
  const fuse = useMemo(() => createGlobalSearcher(items), [items])

  // Filter and search
  const results = useMemo(() => {
    let filtered = items

    // Apply type filter first
    if (filter !== 'all') {
      filtered = items.filter(item => item.type === filter)
    }

    // Then apply fuzzy search if query exists
    if (query.trim()) {
      const searchable = filter === 'all' ? items : filtered
      const fuseInstance = createGlobalSearcher(searchable)
      return fuseInstance.search(query.trim()).map(r => r.item).slice(0, 15)
    }

    // No query: return filtered items limited to 15
    return filtered.slice(0, 15)
  }, [items, query, filter, fuse])

  // Group results by type for display
  const groupedResults = useMemo(() => {
    if (filter !== 'all') {
      return { [filter]: results }
    }
    return {
      contact: results.filter(r => r.type === 'contact').slice(0, 5),
      order: results.filter(r => r.type === 'order').slice(0, 5),
      conversation: results.filter(r => r.type === 'conversation').slice(0, 5),
    }
  }, [results, filter])

  const navigate = useCallback((href: string) => {
    setOpen(false)
    setQuery('')
    router.push(href)
  }, [router])

  return {
    open,
    setOpen,
    query,
    setQuery,
    filter,
    setFilter,
    results,
    groupedResults,
    loading,
    navigate
  }
}
```
  </action>
  <verify>
Run: `pnpm tsc --noEmit` - types compile correctly.
Hook logic: keyboard shortcut, data fetching, filtering, search all work.
  </verify>
  <done>
Search Server Action fetches items from all entities. Hook manages state with Fuse.js filtering.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create GlobalSearch UI component</name>
  <files>
    src/components/search/global-search.tsx
    src/components/search/search-result-item.tsx
    src/components/layout/sidebar.tsx
  </files>
  <action>
**1. src/components/search/search-result-item.tsx**

Reusable result item component:

```tsx
'use client'

import { User, ShoppingCart, MessageSquare } from 'lucide-react'
import { CommandItem } from '@/components/ui/command'
import type { SearchableItem } from '@/app/actions/search'

const typeConfig = {
  contact: {
    icon: User,
    label: 'Contacto'
  },
  order: {
    icon: ShoppingCart,
    label: 'Pedido'
  },
  conversation: {
    icon: MessageSquare,
    label: 'Chat'
  }
}

interface SearchResultItemProps {
  item: SearchableItem
  onSelect: (href: string) => void
}

export function SearchResultItem({ item, onSelect }: SearchResultItemProps) {
  const config = typeConfig[item.type]
  const Icon = config.icon

  return (
    <CommandItem
      value={`${item.type}-${item.id}-${item.title}`}
      onSelect={() => onSelect(item.href)}
      className="flex items-center gap-3 py-2"
    >
      <Icon className="h-4 w-4 text-muted-foreground shrink-0" />
      <div className="flex-1 min-w-0">
        <p className="text-sm font-medium truncate">{item.title}</p>
        <p className="text-xs text-muted-foreground truncate">{item.subtitle}</p>
      </div>
    </CommandItem>
  )
}
```

**2. src/components/search/global-search.tsx**

Main search component with command palette:

```tsx
'use client'

import { Search, User, ShoppingCart, MessageSquare, Loader2 } from 'lucide-react'
import {
  CommandDialog,
  CommandInput,
  CommandList,
  CommandEmpty,
  CommandGroup,
} from '@/components/ui/command'
import { Button } from '@/components/ui/button'
import { cn } from '@/lib/utils'
import { useGlobalSearch, type SearchFilter } from '@/hooks/use-global-search'
import { SearchResultItem } from './search-result-item'

const filterTabs: { value: SearchFilter; label: string; icon: React.ComponentType<{ className?: string }> }[] = [
  { value: 'all', label: 'Todos', icon: Search },
  { value: 'contact', label: 'Contactos', icon: User },
  { value: 'order', label: 'Pedidos', icon: ShoppingCart },
  { value: 'conversation', label: 'Chats', icon: MessageSquare },
]

const groupLabels = {
  contact: 'Contactos',
  order: 'Pedidos',
  conversation: 'Conversaciones'
}

export function GlobalSearch() {
  const {
    open,
    setOpen,
    query,
    setQuery,
    filter,
    setFilter,
    groupedResults,
    loading,
    navigate
  } = useGlobalSearch()

  return (
    <>
      {/* Trigger button in sidebar */}
      <Button
        variant="outline"
        className="w-full justify-start text-muted-foreground font-normal"
        onClick={() => setOpen(true)}
      >
        <Search className="mr-2 h-4 w-4" />
        <span>Buscar...</span>
        <kbd className="ml-auto pointer-events-none inline-flex h-5 select-none items-center gap-1 rounded border bg-muted px-1.5 font-mono text-[10px] font-medium text-muted-foreground">
          <span className="text-xs">âŒ˜</span>K
        </kbd>
      </Button>

      {/* Command Dialog */}
      <CommandDialog
        open={open}
        onOpenChange={setOpen}
        title="Buscar"
        description="Buscar contactos, pedidos y conversaciones"
      >
        <CommandInput
          placeholder="Buscar contactos, pedidos, chats..."
          value={query}
          onValueChange={setQuery}
        />

        {/* Filter tabs */}
        <div className="flex gap-1 p-2 border-b">
          {filterTabs.map(tab => {
            const Icon = tab.icon
            return (
              <Button
                key={tab.value}
                variant="ghost"
                size="sm"
                onClick={() => setFilter(tab.value)}
                className={cn(
                  'h-7 px-2 text-xs',
                  filter === tab.value && 'bg-accent'
                )}
              >
                <Icon className="h-3 w-3 mr-1" />
                {tab.label}
              </Button>
            )
          })}
        </div>

        <CommandList>
          {loading ? (
            <div className="flex items-center justify-center py-6">
              <Loader2 className="h-6 w-6 animate-spin text-muted-foreground" />
            </div>
          ) : (
            <>
              <CommandEmpty>No se encontraron resultados.</CommandEmpty>

              {filter === 'all' ? (
                // Grouped display
                <>
                  {Object.entries(groupedResults).map(([type, items]) => {
                    if (!items || items.length === 0) return null
                    return (
                      <CommandGroup key={type} heading={groupLabels[type as keyof typeof groupLabels]}>
                        {items.map(item => (
                          <SearchResultItem
                            key={`${item.type}-${item.id}`}
                            item={item}
                            onSelect={navigate}
                          />
                        ))}
                      </CommandGroup>
                    )
                  })}
                </>
              ) : (
                // Single type display
                <CommandGroup heading={groupLabels[filter as keyof typeof groupLabels]}>
                  {groupedResults[filter]?.map(item => (
                    <SearchResultItem
                      key={`${item.type}-${item.id}`}
                      item={item}
                      onSelect={navigate}
                    />
                  ))}
                </CommandGroup>
              )}
            </>
          )}
        </CommandList>
      </CommandDialog>
    </>
  )
}
```

**3. Update sidebar.tsx**

Add GlobalSearch below workspace switcher:

```tsx
// Import
import { GlobalSearch } from '@/components/search/global-search'

// In Sidebar component, after WorkspaceSwitcher div:
{/* Workspace Switcher */}
<div className="p-4 border-b">
  <WorkspaceSwitcher ... />
</div>

{/* Global Search - NEW */}
<div className="px-4 pb-4">
  <GlobalSearch />
</div>
```

Position: Below workspace selector, always visible (per CONTEXT.md).
  </action>
  <verify>
1. Press Cmd+K (Mac) or Ctrl+K (Windows/Linux) - search dialog opens
2. Click search button in sidebar - dialog opens
3. Type query - results filter with fuzzy matching
4. Click filter tabs - results update by type
5. Select result - navigates to entity page
6. Press Escape - dialog closes
  </verify>
  <done>
Global search fully functional with command palette, keyboard shortcut, filtering, and navigation.
  </done>
</task>

</tasks>

<verification>
1. Cmd+K opens search from anywhere in the app
2. Search input in sidebar is visible and clickable
3. Results show correct type icons
4. Fuzzy search works (partial matches, typos tolerated)
5. Filter tabs work correctly
6. Keyboard navigation works (up/down arrows, enter to select)
7. Selecting result navigates and closes dialog
</verification>

<success_criteria>
- [ ] Cmd+K / Ctrl+K keyboard shortcut works globally
- [ ] Search button visible in sidebar
- [ ] Results include contacts, orders, conversations
- [ ] Each result shows type icon and preview text
- [ ] Filter tabs filter by entity type
- [ ] Result selection navigates correctly
- [ ] Empty state displays when no matches
</success_criteria>

<output>
After completion, create `.planning/phases/10-search-tasks-analytics/10-04-SUMMARY.md`
</output>
