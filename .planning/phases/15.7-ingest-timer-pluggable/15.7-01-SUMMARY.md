---
phase: 15.7-ingest-timer-pluggable
plan: 01
subsystem: sandbox-timer
tags: [timer, ingest, sandbox, state-machine, typescript]
depends_on:
  requires: [15.5, 15.6]
  provides: [IngestTimerSimulator, TimerSignal, 5-level-timer-config]
  affects: [15.7-02, 15.7-03]
tech-stack:
  added: []
  patterns: [pure-logic-class, callback-based-timer, 5-level-state-machine]
key-files:
  created:
    - src/lib/sandbox/ingest-timer.ts
  modified:
    - src/lib/sandbox/types.ts
    - src/lib/sandbox/sandbox-engine.ts
decisions:
  - TIMER_MINIMUM_FIELDS (6 fields including apellido) defined separately from CRITICAL_FIELDS (5 fields)
  - IngestTimerSimulator is pure-logic class with no React dependencies
  - Timer state stored in instance properties to avoid stale closure pitfall
  - timerExpiresAt kept null for backward compatibility; new timer reads from TimerState
metrics:
  duration: 7m30s
  completed: 2026-02-08
---

# Phase 15.7 Plan 01: Timer Engine Foundation Summary

IngestTimerSimulator pure-logic class with 5-level state machine, timer type system, and SandboxEngine signal propagation for start/reevaluate/cancel signals.

## What Was Done

### Task 1: IngestTimerSimulator Class and Timer Constants
Created `src/lib/sandbox/ingest-timer.ts` (455 lines) with:
- **IngestTimerSimulator class** - Pure logic, uses setTimeout/setInterval, callbacks for onTick/onExpire
- **8 methods**: start, stop, pause, resume, reevaluateLevel, evaluateLevel, getState, destroy
- **5 timer levels** with evaluate conditions and buildAction functions:
  - Level 0 "Sin datos": collecting_data, 0 fields, 600s
  - Level 1 "Datos parciales": collecting_data, partial fields, 360s
  - Level 2 "Datos minimos": collecting_data, all 6 minimum, 120s (silent transition)
  - Level 3 "Promos sin respuesta": ofrecer_promos, no pack, 600s
  - Level 4 "Pack sin confirmar": ofrecer_promos, has pack, 600s
- **TIMER_MINIMUM_FIELDS** (6 fields): nombre, apellido, telefono, direccion, ciudad, departamento
- **TIMER_ALL_FIELDS** (8 fields): + barrio, correo
- **FIELD_LABELS**: Human-readable Spanish labels for missing fields messages
- **3 presets**: real, rapido, instantaneo with 5 durations each
- **TIMER_DEFAULTS**: Same as 'real' preset

### Task 2: Timer Type Definitions
Extended `src/lib/sandbox/types.ts` with:
- **TimerSignal**: start/reevaluate/cancel signals for SandboxEngineResult
- **TimerState**: active, level, levelName, remainingMs, paused (for UI)
- **TimerConfig**: Record<levelId, seconds> for preset configuration
- **TimerAction**: send_message/transition_mode/create_order with message and config
- **TimerEvalContext**: fieldsCollected, totalFields, currentMode, packSeleccionado, promosOffered
- **TimerLevelConfig**: id, name, defaultDurationS, evaluate(), buildAction()
- **TimerPreset**: 'real' | 'rapido' | 'instantaneo'
- Added `timerSignal?: TimerSignal` to SandboxEngineResult

### Task 3: SandboxEngine Timer Signal Propagation
Fixed `src/lib/sandbox/sandbox-engine.ts` to propagate timer signals:
- Added `lastTimerSignal` class property, reset per processMessage call
- **Silent action + shouldEmitTimerStart**: returns `timerSignal: { type: 'start' }`
- **Silent action + subsequent data**: returns `timerSignal: { type: 'reevaluate' }`
- **Complete action**: sets `lastTimerSignal: { type: 'cancel', reason: 'ingest_complete' }`
- **Implicit yes (partial data)**: returns `timerSignal: { type: 'start' }`
- **Final return**: propagates `lastTimerSignal` for pregunta/mixto flows
- Questions do NOT produce timer signals (timer continues unaffected)

## Decisions Made

| Decision | Context | Rationale |
|----------|---------|-----------|
| Separate TIMER_MINIMUM_FIELDS from CRITICAL_FIELDS | Timer needs 6 fields (+ apellido), CRITICAL_FIELDS has 5 | Different purposes: timer level evaluation vs order creation validation |
| Store timer state in instance properties | setTimeout closures capture stale values | Avoids Pitfall 1 from research: race condition on level re-evaluation |
| Keep timerExpiresAt null | Backward compat with existing IngestStatus consumers | New timer display reads from TimerState via simulator, not IngestStatus |
| buildAction receives minimal context on expire | Timer expire callback fires with level only | Caller (sandbox-layout) has the real context and can rebuild action if needed |

## Deviations from Plan

None - plan executed exactly as written.

## Verification Results

- `npx tsc --noEmit`: PASS (zero errors)
- IngestTimerSimulator exports: class + 5 constants + all types
- SandboxEngineResult has timerSignal field
- 5 timer levels with evaluate/buildAction functions
- TIMER_MINIMUM_FIELDS has 6 fields
- TIMER_PRESETS has 3 presets x 5 levels
- No React imports in ingest-timer.ts (pure logic)
- No changes to production files (ingest-manager.ts, somnio-engine.ts, agent-timers.ts)

## Next Phase Readiness

Plan 02 can now:
- Import IngestTimerSimulator and instantiate it in sandbox-layout
- Use TimerSignal from SandboxEngineResult to drive timer start/reevaluate/cancel
- Use TimerState for UI display in ingest-tab
- Use TIMER_PRESETS and TIMER_LEVELS for configuration UI (5 sliders)
