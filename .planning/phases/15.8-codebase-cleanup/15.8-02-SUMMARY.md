---
phase: 15.8
plan: 02
subsystem: security-bugs
tags: [bugfix, security, null-safety, hmac, auth, workspace-isolation]
dependency-graph:
  requires: [15.8-RESEARCH, audit/BUGS.md, audit/SECURITY.md]
  provides: [high-severity-bugs-fixed, security-hardening]
  affects: [16-whatsapp-agent-integration]
tech-stack:
  added: []
  patterns: [hmac-verification, workspace-membership-check, uuid-validation, optional-chaining]
key-files:
  created: []
  modified:
    - src/lib/agents/somnio/data-extractor.ts
    - src/lib/agents/somnio/somnio-orchestrator.ts
    - src/lib/agents/somnio/template-manager.ts
    - src/lib/agents/somnio/message-sequencer.ts
    - src/lib/agents/crm/order-manager/agent.ts
    - src/app/api/sandbox/process/route.ts
    - src/app/api/webhooks/whatsapp/route.ts
    - src/app/actions/invitations.ts
decisions:
  - id: 15.8-02-01
    summary: "DataExtractor model from constructor parameter (not hardcoded)"
  - id: 15.8-02-02
    summary: "WhatsApp HMAC verification env-gated (WHATSAPP_WEBHOOK_SECRET)"
  - id: 15.8-02-03
    summary: "Sandbox auth check + workspace membership for LIVE mode only"
  - id: 15.8-02-04
    summary: "UUID regex validation for workspaceId in template-manager query"
metrics:
  duration: "~11 minutes"
  completed: 2026-02-09
---

# Phase 15.8 Plan 02: High Severity Bugs + Security Fixes Summary

**One-liner:** Fixed 6 high-severity bugs (null access, token tracking, model config, query safety, array check, error handling) and implemented 3 security fixes (sandbox auth, WhatsApp HMAC, workspace isolation).

## Tasks Completed

### Task 1: Fix High Severity Bugs #7, #9, #10, #11, #12, #13
**Commit:** `4fbcec3`

| Bug | File | Fix |
|-----|------|-----|
| #7 | sandbox-layout.tsx | `result.debugTurn?.tokens?.tokensUsed ?? 0` (already in HEAD via 15.8-01) |
| #9 | somnio-orchestrator.ts + data-extractor.ts | Added `tokensUsed` to `ExtractionResult`, captured from `claudeClient.detectIntent()` |
| #10 | data-extractor.ts | Added `model: ClaudeModel` constructor param, replaced hardcoded `'claude-sonnet-4-5'` with `this.model` |
| #11 | template-manager.ts | UUID regex validation before `.or()` interpolation (defense-in-depth) |
| #12 | order-manager/agent.ts | `Array.isArray(contacts) && contacts.length > 0` instead of truthy check |
| #13 | message-sequencer.ts | Defense-in-depth try/catch wrapping `sendMessage` call in sequence loop |

### Task 2: Security Fixes #2, #3, #4
**Commit:** `4b60b19`

| Security | File | Fix |
|----------|------|-----|
| #4 | sandbox/process/route.ts | `supabase.auth.getUser()` check + 401 response; LIVE mode validates workspace_members membership |
| #2 | webhooks/whatsapp/route.ts | `verifyWhatsAppHmac()` with `crypto.createHmac('sha256')` + `timingSafeEqual`; env-gated via `WHATSAPP_WEBHOOK_SECRET`; body read as text before parse |
| #3 | invitations.ts | `cancelInvitation`: fetch invitation workspace_id then verify admin/owner; `removeMember`: verify callerMembership admin/owner; `updateMemberRole`: same pattern |

## Decisions Made

1. **DataExtractor model configurable** (15.8-02-01): Instead of hardcoding `'claude-sonnet-4-5'`, the `DataExtractor` constructor now accepts an optional `model: ClaudeModel` parameter with default fallback. This lets the agent config drive model selection.

2. **HMAC env-gated** (15.8-02-02): WhatsApp webhook HMAC verification only activates when `WHATSAPP_WEBHOOK_SECRET` is set. In development (no env var), requests pass through unverified. This avoids breaking local/testing flows while hardening production.

3. **Sandbox auth + conditional workspace check** (15.8-02-03): Authentication is always required (401 without user). Workspace membership check only applies when LIVE mode CRM agents are in the request (dry-run doesn't touch real DB, so membership isn't critical).

4. **UUID validation for template query** (15.8-02-04): Rather than switching from template literal to string concat (both go through Supabase client escaping), we validate the workspaceId is a valid UUID before interpolation. This is defense-in-depth since Supabase already handles escaping.

## Deviations from Plan

### Auto-fixed Issues

**1. [Rule 2 - Missing Critical] ExtractionResult type missing tokensUsed field**
- **Found during:** Task 1 (Bug #9)
- **Issue:** The `ExtractionResult` interface in data-extractor.ts had no `tokensUsed` field, even though the underlying `claudeClient.detectIntent()` returns it. The orchestrator couldn't propagate tokens because the type didn't expose them.
- **Fix:** Added `tokensUsed: number` to `ExtractionResult`, returned it from `extract()` method.
- **Files modified:** src/lib/agents/somnio/data-extractor.ts

**2. [Rule 1 - Bug] Bug #7 already fixed by parallel plan 15.8-01**
- **Found during:** Task 1 (Bug #7)
- **Issue:** When reading sandbox-layout.tsx, the parallel plan 15.8-01 had already committed the fix for line 435 (null-safe token access with optional chaining) as part of its stale closure fix commit.
- **Resolution:** No additional change needed. Documented in commit message for traceability.

## Verification

- `npx tsc --noEmit` passes with zero source errors (all 3 checks passed)
- All 8 modified files contain expected patterns (verified via grep)
- No `request.json()` calls remain in WhatsApp webhook (all use `JSON.parse(rawBody)`)
- Workspace membership checks verified in all 3 invitation functions

## Next Phase Readiness

No blockers. Plan 15.8-03 (consistency fixes) and 15.8-04 (medium bugs + code quality) can proceed.
