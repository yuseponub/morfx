---
phase: 08-whatsapp-extended
plan: 06
type: execute
wave: 2
depends_on: ["08-01", "08-02"]
files_modified:
  - supabase/migrations/20260131000002_conversation_rls_update.sql
  - src/hooks/use-conversations.ts
  - src/app/(dashboard)/whatsapp/components/conversation-list.tsx
autonomous: true

must_haves:
  truths:
    - "Manager/Admin can see all conversations in workspace"
    - "Agent can only see conversations assigned to them or unassigned"
    - "Visibility rules enforced at database level via RLS"
    - "Conversation list respects visibility rules"
  artifacts:
    - path: "supabase/migrations/20260131000002_conversation_rls_update.sql"
      provides: "Updated RLS policy for role-based visibility"
      contains: "conversations_role_based_select"
  key_links:
    - from: "supabase RLS policy"
      to: "workspace_members table"
      via: "role check for manager vs agent"
      pattern: "is_workspace_manager"
---

<objective>
Implement role-based visibility for conversations (WAPP-07, WAPP-08).

Purpose: Managers see all conversations, agents only see assigned or unassigned ones.
Output: Updated RLS policies and verified visibility rules.
</objective>

<execution_context>
@/home/jose147/.claude/get-shit-done/workflows/execute-plan.md
@/home/jose147/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/08-whatsapp-extended/08-CONTEXT.md
@.planning/phases/08-whatsapp-extended/08-RESEARCH.md
@supabase/migrations/20260130000002_whatsapp_conversations.sql
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update RLS Policies for Role-Based Visibility</name>
  <files>supabase/migrations/20260131000002_conversation_rls_update.sql</files>
  <action>
Create a migration to update conversation visibility based on user role:

```sql
-- Migration: Update conversation RLS for role-based visibility
-- Manager+ sees all workspace conversations
-- Agent sees only assigned to self OR unassigned

-- First, create helper function to check if user is manager or above
CREATE OR REPLACE FUNCTION is_workspace_manager(workspace_uuid UUID)
RETURNS BOOLEAN
LANGUAGE sql
STABLE
SECURITY DEFINER
SET search_path = public
AS $$
  SELECT EXISTS (
    SELECT 1 FROM workspace_members
    WHERE workspace_id = workspace_uuid
    AND user_id = auth.uid()
    AND role IN ('owner', 'admin')  -- owner and admin are considered managers
  )
$$;

-- Grant execute to authenticated users
GRANT EXECUTE ON FUNCTION is_workspace_manager(UUID) TO authenticated;

-- Drop existing conversation SELECT policy
DROP POLICY IF EXISTS "conversations_workspace_isolation_select" ON conversations;
DROP POLICY IF EXISTS "Workspace members can view conversations" ON conversations;

-- Create new role-based SELECT policy
CREATE POLICY "conversations_role_based_select"
  ON conversations FOR SELECT
  USING (
    -- Must be workspace member first
    is_workspace_member(workspace_id)
    AND (
      -- Managers (owner/admin) see all workspace conversations
      is_workspace_manager(workspace_id)
      OR
      -- Agents see conversations assigned to them
      assigned_to = auth.uid()
      OR
      -- Agents also see unassigned conversations
      assigned_to IS NULL
    )
  );

-- Update INSERT policy (no change needed, workspace members can create)
-- Keep existing INSERT policy

-- Update UPDATE policy for assignments
-- Managers can update any conversation
-- Agents can only update conversations assigned to them or unassigned
DROP POLICY IF EXISTS "conversations_workspace_isolation_update" ON conversations;
DROP POLICY IF EXISTS "Workspace members can update conversations" ON conversations;

CREATE POLICY "conversations_role_based_update"
  ON conversations FOR UPDATE
  USING (
    is_workspace_member(workspace_id)
    AND (
      is_workspace_manager(workspace_id)
      OR assigned_to = auth.uid()
      OR assigned_to IS NULL
    )
  )
  WITH CHECK (
    is_workspace_member(workspace_id)
  );

-- Delete policy - only managers can delete
DROP POLICY IF EXISTS "conversations_workspace_isolation_delete" ON conversations;
DROP POLICY IF EXISTS "Workspace members can delete conversations" ON conversations;

CREATE POLICY "conversations_manager_only_delete"
  ON conversations FOR DELETE
  USING (
    is_workspace_member(workspace_id)
    AND is_workspace_manager(workspace_id)
  );

-- Add comment explaining the policy
COMMENT ON POLICY "conversations_role_based_select" ON conversations IS
  'Manager/Admin sees all workspace conversations. Agent sees only assigned to self or unassigned.';
```

This migration:
1. Creates is_workspace_manager helper function
2. Replaces old SELECT policy with role-based visibility
3. Updates UPDATE policy for same visibility rules
4. Adds DELETE policy (managers only)
  </action>
  <verify>Run `pnpm supabase db push --dry-run` to validate SQL syntax. Check that no errors are reported.</verify>
  <done>Migration creates is_workspace_manager function and updates conversations RLS policies. Managers see all, agents see assigned or unassigned only.</done>
</task>

<task type="auto">
  <name>Task 2: Update Conversation List to Handle Visibility</name>
  <files>
    src/hooks/use-conversations.ts
    src/app/(dashboard)/whatsapp/components/conversation-list.tsx
  </files>
  <action>
**Update src/hooks/use-conversations.ts:**

The hook should already work correctly since RLS handles visibility at the database level. However, add a helpful comment and ensure the query doesn't override RLS:

```typescript
// Add comment at top of hook:
/**
 * Fetches conversations for the current workspace.
 *
 * Visibility is handled by RLS policies:
 * - Managers (owner/admin) see all workspace conversations
 * - Agents see only conversations assigned to them or unassigned
 *
 * No additional filtering needed in this hook.
 */

// Ensure the select query doesn't have any .eq('assigned_to', ...)
// that would conflict with RLS - let RLS handle visibility

export function useConversations() {
  // ... existing implementation

  // The Supabase query should just be:
  const { data } = await supabase
    .from('conversations')
    .select(`
      *,
      contact:contacts(id, name, email),
      messages:messages(count)
    `)
    .eq('workspace_id', workspaceId)
    .order('last_message_at', { ascending: false })

  // RLS will automatically filter based on user's role
  // No need for additional assigned_to filtering
}
```

**Update src/app/(dashboard)/whatsapp/components/conversation-list.tsx:**

Add visual indicator for assignment status and ensure filters work with RLS:

```typescript
// In ConversationItem or ConversationList component, add assignment indicator:

// If showing assigned agent name:
{conversation.assigned_to && conversation.assigned_name && (
  <span className="text-xs text-muted-foreground">
    Asignado a {conversation.assigned_name}
  </span>
)}

// Add "Unassigned" badge for unassigned conversations
{!conversation.assigned_to && (
  <Badge variant="outline" className="text-xs">
    Sin asignar
  </Badge>
)}
```

The key insight is that RLS handles visibility, so the frontend just needs to:
1. Display what the database returns
2. Show assignment status for context
3. Not add redundant filtering that would conflict with RLS

If there are existing filters in the UI (like "My Conversations" vs "All"), they should:
- "My Conversations": Add .eq('assigned_to', currentUserId) - will show only user's assigned
- "All": No filter - RLS returns what user can see (all for managers, assigned+unassigned for agents)
  </action>
  <verify>Run `pnpm tsc --noEmit` to verify TypeScript compiles. Test that agents see limited conversations and managers see all.</verify>
  <done>Hooks updated with visibility documentation. Conversation list shows assignment status. RLS handles actual visibility filtering at database level.</done>
</task>

<task type="auto">
  <name>Task 3: Add UI Filters for Assignment Status</name>
  <files>
    src/app/(dashboard)/whatsapp/components/filters/inbox-filters.tsx
  </files>
  <action>
**Update src/app/(dashboard)/whatsapp/components/filters/inbox-filters.tsx:**

Add assignment filter options:

```typescript
// Add to existing filter options (alongside all, unread, archived):

interface InboxFiltersProps {
  filter: 'all' | 'unread' | 'archived' | 'mine' | 'unassigned'
  onFilterChange: (filter: string) => void
}

const filters = [
  { value: 'all', label: 'Todas' },
  { value: 'unread', label: 'No leidas' },
  { value: 'mine', label: 'Mis chats' },
  { value: 'unassigned', label: 'Sin asignar' },
  { value: 'archived', label: 'Archivadas' }
]

// In parent component or hook, apply filter:
// Note: RLS already limits what agents can see, these filters further refine

function applyAssignmentFilter(conversations: Conversation[], filter: string, userId: string) {
  switch (filter) {
    case 'mine':
      return conversations.filter(c => c.assigned_to === userId)
    case 'unassigned':
      return conversations.filter(c => !c.assigned_to)
    default:
      return conversations
  }
}

// Or better, do it at query level in useConversations:
// When filter is 'mine': .eq('assigned_to', auth.uid())
// When filter is 'unassigned': .is('assigned_to', null)
// This is more efficient than client-side filtering
```

The filter UI should update the conversation query to add the appropriate filter condition. For agents, the "Todas" filter shows all they can see (assigned + unassigned). For managers, it shows all workspace conversations.

If using client-side filtering, ensure it happens after RLS filtering (which is automatic via Supabase).
  </action>
  <verify>Test that "Mis chats" shows only user's assigned conversations. Test that "Sin asignar" shows only unassigned.</verify>
  <done>Inbox filters extended with "Mis chats" and "Sin asignar" options. Filters work in conjunction with RLS visibility rules.</done>
</task>

</tasks>

<verification>
1. is_workspace_manager function created and works correctly
2. RLS SELECT policy enforces role-based visibility
3. Managers can see all conversations
4. Agents can only see assigned to self or unassigned
5. Agents cannot see conversations assigned to other agents
6. UI filters refine visible conversations
7. Assignment status displayed in conversation list
</verification>

<success_criteria>
- Migration executes without errors
- is_workspace_manager returns true for owner/admin roles
- Agent querying conversations only sees limited set
- Manager querying conversations sees all
- DELETE only works for managers
- Filters work in conjunction with RLS
</success_criteria>

<output>
After completion, create `.planning/phases/08-whatsapp-extended/08-06-SUMMARY.md`
</output>
