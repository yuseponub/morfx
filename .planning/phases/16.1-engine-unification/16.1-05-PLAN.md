---
phase: 16.1-engine-unification
plan: 05
type: execute
wave: 3
depends_on: ["16.1-01", "16.1-02", "16.1-03"]
files_modified:
  - src/lib/agents/production/webhook-processor.ts
autonomous: true

must_haves:
  truths:
    - "webhook-processor.ts uses UnifiedEngine + production adapters internally"
    - "ProcessMessageInput interface is unchanged"
    - "processMessageWithAgent return type is still SomnioEngineResult"
    - "All external behavior preserved: agent-config check, auto-contact creation, typing indicator, sent_by_agent marking, handoff workflow"
    - "Inngest function (agent-production.ts) continues to work without changes"
  artifacts:
    - path: "src/lib/agents/production/webhook-processor.ts"
      provides: "Production agent processing using unified engine"
  key_links:
    - from: "src/lib/agents/production/webhook-processor.ts"
      to: "src/lib/agents/engine/unified-engine.ts"
      via: "creates UnifiedEngine for processing"
      pattern: "UnifiedEngine"
    - from: "src/lib/agents/production/webhook-processor.ts"
      to: "src/lib/agents/engine-adapters/production/index.ts"
      via: "creates production adapters"
      pattern: "createProductionAdapters"
    - from: "src/inngest/functions/agent-production.ts"
      to: "src/lib/agents/production/webhook-processor.ts"
      via: "calls processMessageWithAgent (unchanged interface)"
      pattern: "processMessageWithAgent"
---

<objective>
Update webhook-processor.ts to use UnifiedEngine with production adapters while keeping its external interface (ProcessMessageInput, SomnioEngineResult return) completely unchanged.

Purpose: This is the production path. The Inngest function and all callers of processMessageWithAgent must continue to work without any changes.
Output: Updated webhook-processor.ts with internal engine swap.
</objective>

<execution_context>
@/home/jose147/.claude/get-shit-done/workflows/execute-plan.md
@/home/jose147/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/phases/16.1-engine-unification/16.1-CONTEXT.md
@.planning/phases/16.1-engine-unification/16.1-RESEARCH.md
@.planning/phases/16.1-engine-unification/16.1-01-SUMMARY.md
@.planning/phases/16.1-engine-unification/16.1-02-SUMMARY.md
@.planning/phases/16.1-engine-unification/16.1-03-SUMMARY.md

Key source files:
@src/lib/agents/production/webhook-processor.ts (file to modify — KEEP external interface)
@src/lib/agents/somnio/somnio-engine.ts (OLD engine — reference for SomnioEngineResult mapping)
@src/lib/agents/engine/unified-engine.ts (new engine from Plan 04)
@src/lib/agents/engine-adapters/production/index.ts (production adapters from Plan 03)
@src/inngest/functions/agent-production.ts (caller — must NOT be changed)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update webhook-processor to use UnifiedEngine</name>
  <files>src/lib/agents/production/webhook-processor.ts</files>
  <action>
Update `processMessageWithAgent()` in webhook-processor.ts. The external interface MUST NOT change.

**Keep unchanged:**
- `ProcessMessageInput` interface (exact same fields)
- Return type `SomnioEngineResult` (exact same shape)
- Steps 1-5 (agent check, conversation fetch, auto-contact, typing start, timestamp)
- Steps 7-9 (typing stop, sent_by_agent marking, handoff workflow)
- `autoCreateContact()` helper function
- All logging

**Change only step 6 (engine processing):**

Replace:
```typescript
// Import barrel to trigger agent self-registration, then get engine
const { SomnioEngine } = await import('../somnio')
const engine = new SomnioEngine(workspaceId)

result = await engine.processMessage({
  conversationId,
  contactId,
  messageContent,
  workspaceId,
  phoneNumber: phone,
})
```

With:
```typescript
// Import barrel to trigger agent self-registration
await import('../somnio')
const { UnifiedEngine } = await import('../engine')
const { createProductionAdapters } = await import('../engine-adapters/production')

const adapters = createProductionAdapters({
  workspaceId,
  conversationId,
  phoneNumber: phone,
})

const engine = new UnifiedEngine(adapters, { workspaceId })

const engineOutput = await engine.processMessage({
  conversationId,
  contactId: contactId!,
  message: messageContent,
  workspaceId,
  phoneNumber: phone,
})

// Map EngineOutput to SomnioEngineResult for backward compatibility
result = {
  success: engineOutput.success,
  response: engineOutput.response,
  messagesSent: engineOutput.messagesSent,
  orderCreated: engineOutput.orderCreated,
  orderId: engineOutput.orderId,
  contactId: engineOutput.contactId,
  newMode: engineOutput.newMode,
  tokensUsed: engineOutput.tokensUsed,
  sessionId: engineOutput.sessionId,
  error: engineOutput.error ? {
    code: engineOutput.error.code,
    message: engineOutput.error.message,
    retryable: engineOutput.error.retryable ?? true,
  } : undefined,
}
```

**Keep the import of SomnioEngineResult type:**
The `SomnioEngineResult` type is still used as the return type. Keep:
```typescript
import type { SomnioEngineResult } from '../somnio/somnio-engine'
```
This ensures backward compat without changing the somnio-engine.ts file.

**Dynamic imports preserved:**
Both `UnifiedEngine` and `createProductionAdapters` use dynamic import (consistent with existing pattern for `SomnioEngine`). This avoids circular dependency issues.

**Error handling:**
The catch block already wraps engine errors into SomnioEngineResult format. This stays unchanged — the only difference is the internal engine call.

**IMPORTANT:** Do NOT modify agent-production.ts (the Inngest function). It calls `processMessageWithAgent()` and expects `SomnioEngineResult`. This plan ensures zero changes are needed there.
  </action>
  <verify>
1. `npx tsc --noEmit` passes
2. `ProcessMessageInput` interface unchanged (diff shows no changes to the type)
3. Return type is still `Promise<SomnioEngineResult>`
4. Dynamic imports used for engine and adapters
5. Grep `agent-production.ts` to confirm it still imports from `webhook-processor` without issues
  </verify>
  <done>webhook-processor.ts uses UnifiedEngine internally while maintaining identical external interface. Inngest function and all callers unaffected.</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes across entire project
2. `ProcessMessageInput` interface exact same fields as before
3. `processMessageWithAgent` return type is `Promise<SomnioEngineResult>`
4. agent-production.ts compiles without changes
5. Old SomnioEngine is still in codebase (backup) but no longer imported by webhook-processor
</verification>

<success_criteria>
- webhook-processor.ts updated with zero external interface changes
- EngineOutput correctly mapped to SomnioEngineResult
- All callers (Inngest function) continue to work
- TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/16.1-engine-unification/16.1-05-SUMMARY.md`
</output>
