# Phase 9.1: Order States Config - Research

**Researched:** 2026-02-03
**Domain:** Configuration UI with drag-and-drop reordering and emoji selection
**Confidence:** HIGH

## Summary

This phase replaces the hardcoded `stage-phases.ts` mapping with a configurable `order_states` table at workspace level. Each state has a name, emoji, and order (position). Pipeline stages are assigned to states via a foreign key relationship (N:1 - many stages can map to one state). The emoji is displayed as an indicator over contact avatars in the WhatsApp conversation list.

The implementation leverages existing patterns in the codebase:
- **@dnd-kit** for drag-and-drop reordering (already used in stage-manager.tsx)
- **frimousse** for emoji picker (already used in chat emoji-picker.tsx)
- **Server Actions** for CRUD operations (established pattern)
- **Supabase RLS** for workspace isolation

**Primary recommendation:** Follow the exact patterns from `stage-manager.tsx` for the reorderable list and `emoji-picker.tsx` for emoji selection. Add `order_state_id` foreign key to `pipeline_stages` table to map stages to states.

## Standard Stack

The established libraries/tools for this domain:

### Core
| Library | Version | Purpose | Why Standard |
|---------|---------|---------|--------------|
| @dnd-kit/core | ^6.3.1 | Drag-and-drop foundation | Already in use, React 19 compatible, accessible |
| @dnd-kit/sortable | ^10.0.0 | Sortable list primitive | Vertical list reordering pattern established |
| @dnd-kit/utilities | ^3.2.2 | CSS transform utilities | Standard dnd-kit companion |
| frimousse | ^0.3.0 | Emoji picker | Already in use, 2kb bundle, React 19 compatible |

### Supporting
| Library | Version | Purpose | When to Use |
|---------|---------|---------|-------------|
| lucide-react | ^0.563.0 | Icons (GripVertical, Plus, Pencil, Trash2) | All UI icons |
| sonner | ^2.0.7 | Toast notifications | Success/error feedback |
| @radix-ui/react-dialog | ^1.1.15 | Form dialogs | Create/edit state forms |
| @radix-ui/react-popover | ^1.1.15 | Emoji picker container | Trigger emoji selection |

### Alternatives Considered
| Instead of | Could Use | Tradeoff |
|------------|-----------|----------|
| frimousse | emoji-mart | emoji-mart is 40x larger (~80kb vs 2kb), overkill for this use case |
| @dnd-kit | react-beautiful-dnd | react-beautiful-dnd doesn't support React 19 |

**Installation:**
```bash
# No new packages needed - all already installed
```

## Architecture Patterns

### Recommended Project Structure
```
src/app/(dashboard)/crm/configuracion/
  estados-pedido/
    page.tsx                    # Server component, fetch states
    components/
      order-state-list.tsx      # Reorderable list with dnd-kit
      order-state-form.tsx      # Create/edit dialog with emoji picker
      stage-assignment.tsx      # Multi-select stages to assign
      avatar-preview.tsx        # Live preview of emoji on avatar
src/app/actions/
  order-states.ts               # Server Actions for CRUD
src/lib/orders/
  types.ts                      # Add OrderState type
  stage-phases.ts               # DEPRECATE - replace with DB lookup
```

### Pattern 1: Sortable List with Optimistic Updates
**What:** Drag-and-drop reorderable list with immediate UI feedback and server persistence
**When to use:** Any list where order matters and is user-controlled
**Example:**
```typescript
// Source: Established pattern from stage-manager.tsx
const handleDragEnd = async (event: DragEndEvent) => {
  const { active, over } = event
  if (over && active.id !== over.id) {
    const oldIndex = states.findIndex((s) => s.id === active.id)
    const newIndex = states.findIndex((s) => s.id === over.id)

    // Optimistic update
    const newStates = arrayMove(states, oldIndex, newIndex)
    setStates(newStates)

    // Persist to server
    const stateIds = newStates.map((s) => s.id)
    const result = await updateStateOrder(stateIds)

    if ('error' in result) {
      setStates(states) // Revert on error
      toast.error(result.error)
    } else {
      toast.success('Orden actualizado')
    }
  }
}
```

### Pattern 2: Emoji Picker in Popover
**What:** Trigger button that opens emoji picker in popover, selected emoji shown on button
**When to use:** Any form field requiring emoji selection
**Example:**
```typescript
// Source: Established pattern from emoji-picker.tsx + popover usage
<Popover>
  <PopoverTrigger asChild>
    <Button variant="outline" className="w-14 h-14 text-2xl">
      {emoji || '+'}
    </Button>
  </PopoverTrigger>
  <PopoverContent className="w-auto p-0" align="start">
    <EmojiPicker onSelect={(e) => {
      setEmoji(e)
      // Close popover after selection
    }} />
  </PopoverContent>
</Popover>
```

### Pattern 3: Stage Assignment Multi-Select
**What:** Show stages grouped by pipeline, checkbox to assign/unassign from current state
**When to use:** N:1 relationships where user picks from a finite list
**Example:**
```typescript
// Stages grouped by pipeline for clarity
<div className="space-y-4">
  {pipelines.map(pipeline => (
    <div key={pipeline.id}>
      <h4 className="text-sm font-medium mb-2">{pipeline.name}</h4>
      <div className="space-y-1">
        {pipeline.stages.map(stage => (
          <label key={stage.id} className="flex items-center gap-2">
            <Checkbox
              checked={assignedStageIds.includes(stage.id)}
              onCheckedChange={() => toggleStage(stage.id)}
              disabled={stage.order_state_id && stage.order_state_id !== currentStateId}
            />
            <span className="w-3 h-3 rounded-full" style={{ backgroundColor: stage.color }} />
            <span>{stage.name}</span>
            {stage.order_state_id && stage.order_state_id !== currentStateId && (
              <span className="text-xs text-muted-foreground">(asignado a otro estado)</span>
            )}
          </label>
        ))}
      </div>
    </div>
  ))}
</div>
```

### Pattern 4: Live Avatar Preview
**What:** Show emoji positioned over a sample avatar to preview the indicator appearance
**When to use:** When the output of configuration affects visual display elsewhere
**Example:**
```typescript
// Callbell-style indicator: emoji badge on upper-right of avatar
<div className="relative inline-block">
  {/* Sample avatar */}
  <div className="w-12 h-12 rounded-full bg-muted flex items-center justify-center">
    <span className="text-lg">JD</span>
  </div>
  {/* Emoji indicator badge */}
  {emoji && (
    <span className="absolute -top-1 -right-1 text-sm">
      {emoji}
    </span>
  )}
</div>
```

### Anti-Patterns to Avoid
- **Hand-rolling drag-and-drop:** @dnd-kit handles accessibility, touch, keyboard, and edge cases
- **Storing emoji in multiple places:** Single source of truth in order_states.emoji
- **Inline stage assignment:** Use a sheet/dialog, not inline editing in the list
- **Forgetting to handle orphaned stages:** When deleting a state, stages become unassigned (null)

## Don't Hand-Roll

Problems that look simple but have existing solutions:

| Problem | Don't Build | Use Instead | Why |
|---------|-------------|-------------|-----|
| Drag-and-drop list | Mouse event handlers | @dnd-kit | Accessibility, keyboard nav, touch support, drop zones |
| Emoji picker | Unicode list or native input | frimousse | Categories, search, keyboard nav, localization |
| Position management | Manual position swapping | arrayMove from @dnd-kit/sortable | Handles all edge cases correctly |
| Unique ID for DndContext | Static strings | React.useId() | Prevents hydration mismatch in SSR |

**Key insight:** The existing codebase already solved these problems in `stage-manager.tsx` and `emoji-picker.tsx`. Copy the patterns exactly.

## Common Pitfalls

### Pitfall 1: Hydration Mismatch with DndContext
**What goes wrong:** SSR and client render different IDs causing React warnings
**Why it happens:** DndContext needs stable unique ID across server/client
**How to avoid:** Use `const dndContextId = React.useId()` and pass to `<DndContext id={dndContextId}>`
**Warning signs:** Console errors about hydration mismatch

### Pitfall 2: Emoji Storage
**What goes wrong:** Emoji stored incorrectly (as codepoint, escaped, or in wrong encoding)
**Why it happens:** Database or JSON serialization issues
**How to avoid:** Store emoji as native UTF-8 string in TEXT column (PostgreSQL handles this natively)
**Warning signs:** Emoji appears as `?` or `\uXXXX` or box character

### Pitfall 3: Stage Orphaning on State Delete
**What goes wrong:** Stages still reference deleted state, causing FK errors or orphaned data
**Why it happens:** ON DELETE behavior not specified correctly
**How to avoid:** Use `ON DELETE SET NULL` for order_state_id FK in pipeline_stages
**Warning signs:** Delete fails or stages disappear

### Pitfall 4: Race Condition on Reorder
**What goes wrong:** Multiple rapid reorders result in incorrect final order
**Why it happens:** Async updates interleave
**How to avoid:** Optimistic UI + server returns authoritative order + revert on error
**Warning signs:** Order "jumps" after drag

### Pitfall 5: Stage Already Assigned Feedback
**What goes wrong:** User tries to assign stage already in another state
**Why it happens:** No visual indication of existing assignment
**How to avoid:** Show current assignment with disabled checkbox and helper text
**Warning signs:** User confused why stage doesn't appear in their state

## Code Examples

Verified patterns from official sources:

### Sortable Item with Drag Handle
```typescript
// Source: Established pattern from stage-manager.tsx
function SortableStateItem({ state, onEdit, onDelete }: SortableStateItemProps) {
  const {
    attributes,
    listeners,
    setNodeRef,
    transform,
    transition,
    isDragging,
  } = useSortable({ id: state.id })

  const style = {
    transform: CSS.Transform.toString(transform),
    transition,
  }

  return (
    <div
      ref={setNodeRef}
      style={style}
      className={cn(
        'flex items-center gap-3 p-3 bg-background border rounded-md',
        isDragging && 'opacity-50 shadow-lg'
      )}
    >
      <button {...attributes} {...listeners} className="cursor-grab">
        <GripVerticalIcon className="h-5 w-5" />
      </button>
      <span className="text-xl">{state.emoji}</span>
      <span className="font-medium flex-1">{state.name}</span>
      {/* Edit/Delete buttons */}
    </div>
  )
}
```

### EmojiPicker with Spanish Locale
```typescript
// Source: Established pattern from emoji-picker.tsx
<FrimousseEmojiPicker.Root
  onEmojiSelect={(emoji: Emoji) => onSelect(emoji.emoji)}
  locale="es"
  columns={8}
  className="w-[320px] h-[400px] bg-popover border rounded-lg shadow-lg"
>
  <FrimousseEmojiPicker.Search placeholder="Buscar emoji..." />
  <FrimousseEmojiPicker.Viewport>
    <FrimousseEmojiPicker.List components={{...}} />
  </FrimousseEmojiPicker.Viewport>
</FrimousseEmojiPicker.Root>
```

### Database Migration Pattern
```sql
-- Source: Established migration patterns in project
CREATE TABLE order_states (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  workspace_id UUID NOT NULL REFERENCES workspaces(id) ON DELETE CASCADE,
  name TEXT NOT NULL,
  emoji TEXT NOT NULL,
  position INTEGER NOT NULL DEFAULT 0,
  created_at TIMESTAMPTZ NOT NULL DEFAULT timezone('America/Bogota', NOW()),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT timezone('America/Bogota', NOW()),
  UNIQUE(workspace_id, position)
);

-- Add FK to pipeline_stages (nullable - stages can be unassigned)
ALTER TABLE pipeline_stages
ADD COLUMN order_state_id UUID REFERENCES order_states(id) ON DELETE SET NULL;

CREATE INDEX idx_stages_order_state ON pipeline_stages(order_state_id);
```

### Server Action Pattern
```typescript
// Source: Established pattern from pipelines.ts, contacts.ts
'use server'

import { getSupabaseServerClient, getWorkspaceId } from '@/lib/supabase/server'
import { revalidatePath } from 'next/cache'

export async function createOrderState(data: { name: string; emoji: string }) {
  const supabase = await getSupabaseServerClient()
  const workspaceId = await getWorkspaceId()

  // Get next position
  const { data: maxPos } = await supabase
    .from('order_states')
    .select('position')
    .eq('workspace_id', workspaceId)
    .order('position', { ascending: false })
    .limit(1)
    .single()

  const nextPosition = (maxPos?.position ?? -1) + 1

  const { data: state, error } = await supabase
    .from('order_states')
    .insert({
      workspace_id: workspaceId,
      name: data.name,
      emoji: data.emoji,
      position: nextPosition,
    })
    .select()
    .single()

  if (error) {
    return { error: error.message }
  }

  revalidatePath('/crm/configuracion/estados-pedido')
  return state
}
```

## State of the Art

| Old Approach | Current Approach | When Changed | Impact |
|--------------|------------------|--------------|--------|
| Hardcoded stage-phases.ts | Database-driven order_states | This phase | Admin-configurable, no code deploys |
| Fixed emoji per phase | User-selected emoji per state | This phase | Full customization |
| Phase inference by stage name | Explicit stageâ†’state FK | This phase | Reliable, no string matching |

**Deprecated/outdated:**
- `src/lib/orders/stage-phases.ts`: Will be replaced by DB lookup function. Keep for fallback during migration, remove after.

## Open Questions

Things that couldn't be fully resolved:

1. **None identified**
   - All patterns are established in codebase
   - Libraries are already installed and verified working
   - Database patterns clear from existing migrations

## Sources

### Primary (HIGH confidence)
- `/mnt/c/Users/Usuario/Proyectos/morfx-new/src/app/(dashboard)/crm/configuracion/pipelines/components/stage-manager.tsx` - @dnd-kit implementation pattern
- `/mnt/c/Users/Usuario/Proyectos/morfx-new/src/app/(dashboard)/whatsapp/components/emoji-picker.tsx` - frimousse implementation pattern
- `/mnt/c/Users/Usuario/Proyectos/morfx-new/supabase/migrations/20260129000003_orders_foundation.sql` - Database schema patterns
- `/mnt/c/Users/Usuario/Proyectos/morfx-new/src/lib/orders/stage-phases.ts` - Current hardcoded mapping to replace
- `/mnt/c/Users/Usuario/Proyectos/morfx-new/package.json` - Verified library versions

### Secondary (MEDIUM confidence)
- N/A - All patterns verified directly from codebase

### Tertiary (LOW confidence)
- N/A - No external research needed

## Metadata

**Confidence breakdown:**
- Standard stack: HIGH - All libraries already installed and patterns established in codebase
- Architecture: HIGH - Following exact patterns from stage-manager.tsx and existing config pages
- Pitfalls: HIGH - Known issues from existing dnd-kit implementation in codebase

**Research date:** 2026-02-03
**Valid until:** 2026-03-03 (30 days - stable patterns, no library updates expected)
