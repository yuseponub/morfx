---
phase: 15.8-codebase-cleanup
plan: 03
type: execute
wave: 2
depends_on: ["15.8-01", "15.8-02"]
files_modified:
  - src/app/(dashboard)/sandbox/components/sandbox-layout.tsx
  - src/lib/agents/somnio/somnio-engine.ts
  - src/lib/sandbox/ingest-timer.ts
  - src/lib/agents/somnio/constants.ts
  - src/lib/agents/somnio/data-extractor.ts
  - src/lib/agents/somnio/transition-validator.ts
autonomous: true

must_haves:
  truths:
    - "Medium bugs #14, #15, #16 fixed: timer cleanup, hasPartialData logic, adjusted duration context"
    - "CRITICAL_FIELDS defined once in src/lib/agents/somnio/constants.ts, imported everywhere"
    - "TIMER_MINIMUM_FIELDS defined once in constants.ts, imported by ingest-timer.ts"
    - "TypeScript compiles with zero source errors"
  artifacts:
    - path: "src/lib/agents/somnio/constants.ts"
      provides: "Single source of truth for CRITICAL_FIELDS, TIMER_MINIMUM_FIELDS, field count thresholds"
      exports: ["CRITICAL_FIELDS", "TIMER_MINIMUM_FIELDS", "MIN_FIELDS_FOR_AUTO_PROMO"]
    - path: "src/lib/sandbox/ingest-timer.ts"
      provides: "contextProvider cleared on destroy, imports from constants.ts"
      contains: "contextProvider.*null|import.*TIMER_MINIMUM_FIELDS"
  key_links:
    - from: "src/lib/agents/somnio/data-extractor.ts"
      to: "src/lib/agents/somnio/constants.ts"
      via: "import CRITICAL_FIELDS"
      pattern: "import.*CRITICAL_FIELDS.*from.*constants"
    - from: "src/lib/agents/somnio/transition-validator.ts"
      to: "src/lib/agents/somnio/constants.ts"
      via: "import CRITICAL_FIELDS"
      pattern: "import.*CRITICAL_FIELDS.*from.*constants"
    - from: "src/lib/sandbox/ingest-timer.ts"
      to: "src/lib/agents/somnio/constants.ts"
      via: "import TIMER_MINIMUM_FIELDS"
      pattern: "import.*TIMER_MINIMUM_FIELDS.*from.*constants"
---

<objective>
Fix 3 medium severity bugs and consolidate CRITICAL_FIELDS + TIMER_MINIMUM_FIELDS constants into a single source of truth.

Purpose: Eliminate medium bugs and create constants.ts as the foundation for further consolidation in Plan 04.
Output: 6 files modified (1 new), all verified by `tsc --noEmit`.
</objective>

<execution_context>
@/home/jose147/.claude/get-shit-done/workflows/execute-plan.md
@/home/jose147/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/codebase/audit/BUGS.md
@.planning/codebase/audit/DUPLICATES.md
@.planning/phases/15.8-codebase-cleanup/15.8-RESEARCH.md
@.planning/phases/15.8-codebase-cleanup/15.8-01-SUMMARY.md
@.planning/phases/15.8-codebase-cleanup/15.8-02-SUMMARY.md

Key source files:
@src/lib/agents/somnio/data-extractor.ts
@src/lib/agents/somnio/transition-validator.ts
@src/lib/sandbox/ingest-timer.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix medium bugs #14, #15, #16</name>
  <files>
    src/app/(dashboard)/sandbox/components/sandbox-layout.tsx
    src/lib/agents/somnio/somnio-engine.ts
    src/lib/sandbox/ingest-timer.ts
  </files>
  <action>
Fix 3 medium severity bugs. Each is a small, targeted change.

**Bug #14 (timer leak in sandbox-layout.tsx, ~line 307):**
Find the `useEffect` cleanup function that calls `destroy()` on the simulator (~line 307).
In `ingest-timer.ts`, find the `destroy()` method and add:
```typescript
this.contextProvider = null
```
This ensures the context provider reference is cleared on cleanup, preventing stale callbacks if the simulator instance is somehow retained.

**Bug #15 (wrong hasPartialData in somnio-engine.ts, ~line 712):**
Find `emitIngestStarted` call (or similar) around line 712 in somnio-engine.ts.
The `hasPartialData` boolean is passed incorrectly. It should be based on actual extracted fields count, not a flag.
Fix: Change to something like:
```typescript
hasPartialData: Object.keys(extractedData || {}).length > 0
```
Read the surrounding context to understand what data is available at this point and use the actual field count.

**Bug #16 (adjusted duration context in ingest-timer.ts, ~line 326-328):**
Find `reevaluateLevel` where `adjustedDuration = newDurationMs - elapsed` can go negative.
The code correctly fires immediately when `<= 0`, but doesn't include context about why it fired early.
Add an `earlyExpiration` flag or `reason` to the action:
```typescript
if (adjustedDuration <= 0) {
  const action = this.buildActionForLevel(newLevel)
  if (action) {
    action.reason = 'duration_exceeded'  // or add to metadata
    this.onExpire(action)
  }
  return
}
```
Check the `TimerAction` type to see if it supports a `reason` field. If not, either add it to the type or add a comment documenting the early expiration scenario.

After ALL fixes, run `npx tsc --noEmit` to verify clean compilation.
Commit: `fix(15.8-03): medium bugs #14, #15, #16`
  </action>
  <verify>
1. `npx tsc --noEmit` passes with zero source errors
2. Bug #14: `grep -n "contextProvider.*null" src/lib/sandbox/ingest-timer.ts` in destroy()
3. Bug #15: `grep -n "hasPartialData" src/lib/agents/somnio/somnio-engine.ts` shows correct logic
4. Bug #16: `grep -n "duration_exceeded\|earlyExpiration\|adjusted.*<= 0" src/lib/sandbox/ingest-timer.ts` shows documentation
  </verify>
  <done>
- Bug #14: contextProvider cleared to null in destroy()
- Bug #15: hasPartialData uses actual field count
- Bug #16: Early expiration documented/flagged in reevaluateLevel
- TypeScript compiles clean
  </done>
</task>

<task type="auto">
  <name>Task 2: Create constants.ts and consolidate CRITICAL_FIELDS + TIMER_MINIMUM_FIELDS</name>
  <files>
    src/lib/agents/somnio/constants.ts
    src/lib/agents/somnio/data-extractor.ts
    src/lib/agents/somnio/transition-validator.ts
    src/lib/sandbox/ingest-timer.ts
  </files>
  <action>
Consolidate duplicate constant definitions into a single source of truth.

**Create `src/lib/agents/somnio/constants.ts`:**

```typescript
/**
 * Critical fields required for minimum viable customer data.
 * Used by DataExtractor validation and TransitionValidator.
 */
export const CRITICAL_FIELDS = [
  'nombre',
  'telefono',
  'direccion',
  'ciudad',
  'departamento',
] as const

/**
 * Minimum fields required for timer to consider data collection sufficient.
 * Includes 'apellido' in addition to CRITICAL_FIELDS.
 * Used by IngestTimerSimulator level evaluation.
 */
export const TIMER_MINIMUM_FIELDS = [
  'nombre',
  'apellido',
  'telefono',
  'direccion',
  'ciudad',
  'departamento',
] as const

/** Number of total fields needed to auto-trigger ofrecer_promos */
export const MIN_FIELDS_FOR_AUTO_PROMO = 8

/** Number of critical fields for timer promo threshold */
export const CRITICAL_FIELDS_COUNT = CRITICAL_FIELDS.length  // 5
```

**IMPORTANT:** This file must have ZERO imports from other project files to avoid circular dependencies.

**Update `src/lib/agents/somnio/data-extractor.ts`:**
- Remove the local `CRITICAL_FIELDS` definition (~lines 61-67)
- Add import: `import { CRITICAL_FIELDS } from './constants'`

**Update `src/lib/agents/somnio/transition-validator.ts`:**
- Remove the local `CRITICAL_FIELDS` definition (~lines 61-67)
- Add import: `import { CRITICAL_FIELDS } from './constants'`

**Update `src/lib/sandbox/ingest-timer.ts`:**
- Remove the local `TIMER_MINIMUM_FIELDS` definition (~lines 44-51)
- Add import: `import { TIMER_MINIMUM_FIELDS } from '@/lib/agents/somnio/constants'`
- If there are numeric thresholds (like `5` for critical fields count), replace with imported constant

After ALL changes, run `npx tsc --noEmit` to verify clean compilation.
Commit: `refactor(15.8-03): consolidate CRITICAL_FIELDS and TIMER_MINIMUM_FIELDS into constants.ts`
  </action>
  <verify>
1. `npx tsc --noEmit` passes with zero source errors
2. New file exists: `ls src/lib/agents/somnio/constants.ts`
3. No duplicate CRITICAL_FIELDS: `grep -rn "export const CRITICAL_FIELDS" src/` shows only constants.ts
4. No duplicate TIMER_MINIMUM_FIELDS: `grep -rn "export const TIMER_MINIMUM_FIELDS" src/` shows only constants.ts
5. Imports verified: `grep -rn "from.*constants" src/lib/agents/somnio/data-extractor.ts src/lib/agents/somnio/transition-validator.ts src/lib/sandbox/ingest-timer.ts`
  </verify>
  <done>
- constants.ts created with CRITICAL_FIELDS, TIMER_MINIMUM_FIELDS, MIN_FIELDS_FOR_AUTO_PROMO
- data-extractor.ts imports from constants.ts
- transition-validator.ts imports from constants.ts
- ingest-timer.ts imports TIMER_MINIMUM_FIELDS from constants.ts
- TypeScript compiles clean
  </done>
</task>

</tasks>

<verification>
After both tasks complete:
1. `npx tsc --noEmit` passes with zero source errors (GATE)
2. Zero duplicate definitions of CRITICAL_FIELDS, TIMER_MINIMUM_FIELDS
3. All 6 files modified correctly
4. No circular dependency issues (constants.ts has zero imports)
</verification>

<success_criteria>
1. Bugs #14, #15, #16 all fixed
2. constants.ts created with consolidated field definitions
3. data-extractor.ts and transition-validator.ts import CRITICAL_FIELDS from constants.ts
4. ingest-timer.ts imports TIMER_MINIMUM_FIELDS from constants.ts
5. TypeScript compiles with zero source errors
6. Each change group committed atomically
</success_criteria>

<output>
After completion, create `.planning/phases/15.8-codebase-cleanup/15.8-03-SUMMARY.md`
</output>
