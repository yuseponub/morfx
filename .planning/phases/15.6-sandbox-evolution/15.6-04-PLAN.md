---
phase: 15.6-sandbox-evolution
plan: 04
type: execute
wave: 2
depends_on: ["15.6-01", "15.6-02"]
files_modified:
  - src/app/(dashboard)/sandbox/components/debug-panel/ingest-tab.tsx
  - src/app/(dashboard)/sandbox/components/debug-panel/tokens-tab.tsx
  - src/app/(dashboard)/sandbox/components/debug-panel/panel-container.tsx
autonomous: true

must_haves:
  truths:
    - "Ingest tab shows ingest status (active/inactive, fields accumulated, timer countdown)"
    - "Ingest tab shows timeline of classified messages with timestamps and fields extracted"
    - "Ingest tab has timer presets (Real 6min/10min, Rapido 30s/60s, Instantaneo 0s/0s) and sliders"
    - "Tokens tab shows per-model breakdown table (Modelo | Input | Output | Total)"
    - "Tokens tab shows separate rows for Haiku and Sonnet"
  artifacts:
    - path: "src/app/(dashboard)/sandbox/components/debug-panel/ingest-tab.tsx"
      provides: "Ingest status, timeline, and timer controls"
      contains: "IngestTab"
    - path: "src/app/(dashboard)/sandbox/components/debug-panel/tokens-tab.tsx"
      provides: "Per-model token breakdown table"
      contains: "ModelTokenEntry"
  key_links:
    - from: "panel-container.tsx"
      to: "ingest-tab.tsx"
      via: "Renders IngestTab for 'ingest' panel ID"
      pattern: "case 'ingest'"
    - from: "tokens-tab.tsx"
      to: "DebugTurn.tokens.models"
      via: "Reads per-model token data from debug turns"
      pattern: "turn.tokens.models"
---

<objective>
Build the Ingest tab (status + timeline + configurable timers) and enhance the Tokens tab with per-model breakdown (Haiku vs Sonnet input/output tokens). Wire the Ingest tab into the panel container.

Purpose: Success Criteria 5 ("Tab Ingest permite configurar timers") and 6 ("Tab Tokens desglosa uso por modelo") both depend on these UI components.
Output: New IngestTab component with timer presets/sliders, enhanced TokensTab with per-model table.
</objective>

<execution_context>
@/home/jose147/.claude/get-shit-done/workflows/execute-plan.md
@/home/jose147/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/15.6-sandbox-evolution/15.6-01-SUMMARY.md
@.planning/phases/15.6-sandbox-evolution/15.6-02-SUMMARY.md
@src/lib/sandbox/types.ts
@src/app/(dashboard)/sandbox/components/debug-panel/tokens-tab.tsx
@src/app/(dashboard)/sandbox/components/debug-panel/panel-container.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create IngestTab with status display, timeline, and configurable timers</name>
  <files>
    src/app/(dashboard)/sandbox/components/debug-panel/ingest-tab.tsx
    src/app/(dashboard)/sandbox/components/debug-panel/panel-container.tsx
  </files>
  <action>
**Create `ingest-tab.tsx`:**

The Ingest tab has 3 sections as defined in CONTEXT.md:

**Section 1 - Status (top):** Shows ingest state (active/inactive), fields accumulated, last classification, timer countdown.

**Section 2 - Timeline (middle, scrollable):** Each message classification with timestamp, classification badge, and fields extracted.

**Section 3 - Timer Controls (bottom):** Preset buttons (Real/Rapido/Instantaneo) + fine-tune sliders for partial and no_data timers.

```typescript
'use client'

/**
 * Ingest Tab Component
 * Phase 15.6: Sandbox Evolution
 *
 * Shows ingest status, classification timeline, and configurable timer presets.
 * Per CONTEXT.md: "Ingest necesita ser 'jugable' - poder configurar timers para hacer pruebas rapidas"
 */

import { useState, useEffect, useCallback } from 'react'
import { Database, Clock, Activity, ChevronDown, ChevronRight } from 'lucide-react'
import { Badge } from '@/components/ui/badge'
import { Slider } from '@/components/ui/slider'
import { ToggleGroup, ToggleGroupItem } from '@/components/ui/toggle-group'
import { Separator } from '@/components/ui/separator'
import { cn } from '@/lib/utils'
import { format } from 'date-fns'
import type { SandboxState, IngestTimelineEntry } from '@/lib/sandbox/types'

// Timer presets per CONTEXT.md
const TIMER_PRESETS = [
  { id: 'real', label: 'Real', partial: 360, noData: 600 },       // 6min / 10min
  { id: 'rapido', label: 'Rapido', partial: 30, noData: 60 },     // 30s / 60s
  { id: 'instant', label: 'Instantaneo', partial: 0, noData: 0 }, // 0s / 0s
] as const

interface IngestTabProps {
  state: SandboxState
  onTimerChange?: (partial: number, noData: number) => void
}

function getClassificationBadge(classification: string): 'default' | 'secondary' | 'destructive' | 'outline' {
  switch (classification) {
    case 'datos': return 'default'
    case 'pregunta': return 'secondary'
    case 'mixto': return 'outline'
    case 'irrelevante': return 'destructive'
    default: return 'secondary'
  }
}

function formatSeconds(seconds: number): string {
  if (seconds === 0) return '0s'
  if (seconds < 60) return `${seconds}s`
  const min = Math.floor(seconds / 60)
  const sec = seconds % 60
  return sec > 0 ? `${min}m ${sec}s` : `${min}m`
}

function TimelineEntry({ entry }: { entry: IngestTimelineEntry }) {
  const [expanded, setExpanded] = useState(false)

  return (
    <div className="border rounded p-2 space-y-1">
      <div className="flex items-center justify-between">
        <div className="flex items-center gap-2">
          <button
            onClick={() => setExpanded(!expanded)}
            className="p-0.5 hover:bg-muted rounded"
          >
            {expanded ? <ChevronDown className="h-3 w-3" /> : <ChevronRight className="h-3 w-3" />}
          </button>
          <Badge variant={getClassificationBadge(entry.classification)} className="text-[10px]">
            {entry.classification}
          </Badge>
          <span className="text-[10px] text-muted-foreground">
            {entry.confidence}%
          </span>
        </div>
        <span className="text-[10px] text-muted-foreground">
          {format(new Date(entry.timestamp), 'HH:mm:ss')}
        </span>
      </div>
      {expanded && (
        <div className="pl-6 space-y-1">
          <p className="text-xs text-muted-foreground truncate">{entry.message}</p>
          {entry.fieldsExtracted.length > 0 && (
            <div className="flex flex-wrap gap-1">
              {entry.fieldsExtracted.map(field => (
                <Badge key={field} variant="outline" className="text-[10px]">
                  {field}
                </Badge>
              ))}
            </div>
          )}
        </div>
      )}
    </div>
  )
}

export function IngestTab({ state, onTimerChange }: IngestTabProps) {
  const [activePreset, setActivePreset] = useState('real')
  const [partialTimer, setPartialTimer] = useState(360)
  const [noDataTimer, setNoDataTimer] = useState(600)
  const [countdown, setCountdown] = useState<number | null>(null)

  const ingest = state.ingestStatus

  // Timer countdown simulation
  useEffect(() => {
    if (!ingest?.active || !ingest?.firstDataAt) {
      setCountdown(null)
      return
    }

    const timerSeconds = ingest.timerType === 'partial' ? partialTimer : noDataTimer
    if (timerSeconds === 0) {
      setCountdown(0)
      return
    }

    const startTime = new Date(ingest.firstDataAt).getTime()
    const interval = setInterval(() => {
      const elapsed = Math.floor((Date.now() - startTime) / 1000)
      const remaining = Math.max(0, timerSeconds - elapsed)
      setCountdown(remaining)
    }, 1000)

    return () => clearInterval(interval)
  }, [ingest?.active, ingest?.firstDataAt, ingest?.timerType, partialTimer, noDataTimer])

  const handlePresetChange = useCallback((value: string) => {
    if (!value) return
    setActivePreset(value)
    const preset = TIMER_PRESETS.find(p => p.id === value)
    if (preset) {
      setPartialTimer(preset.partial)
      setNoDataTimer(preset.noData)
      onTimerChange?.(preset.partial, preset.noData)
    }
  }, [onTimerChange])

  const handlePartialChange = useCallback((value: number[]) => {
    const v = value[0]
    setPartialTimer(v)
    setActivePreset('')
    onTimerChange?.(v, noDataTimer)
  }, [noDataTimer, onTimerChange])

  const handleNoDataChange = useCallback((value: number[]) => {
    const v = value[0]
    setNoDataTimer(v)
    setActivePreset('')
    onTimerChange?.(partialTimer, v)
  }, [partialTimer, onTimerChange])

  const timeline = ingest?.timeline ?? []
  const fieldsCount = ingest?.fieldsAccumulated?.length ?? 0

  return (
    <div className="space-y-3 text-xs">
      {/* Section 1: Status */}
      <div className="space-y-2">
        <div className="flex items-center gap-2">
          <Database className="h-4 w-4 text-primary" />
          <span className="font-medium text-sm">Estado del Ingest</span>
        </div>

        <div className="grid grid-cols-2 gap-2">
          <div className="border rounded p-2">
            <div className="text-muted-foreground">Estado</div>
            <div className="flex items-center gap-1.5 mt-1">
              <span className={cn(
                'inline-block w-2 h-2 rounded-full',
                ingest?.active ? 'bg-green-500' : 'bg-gray-400'
              )} />
              <span className="font-medium">
                {ingest?.active ? 'Activo' : 'Inactivo'}
              </span>
            </div>
          </div>

          <div className="border rounded p-2">
            <div className="text-muted-foreground">Campos</div>
            <div className="font-medium mt-1">{fieldsCount}/8</div>
          </div>

          <div className="border rounded p-2">
            <div className="text-muted-foreground">Clasificacion</div>
            <div className="mt-1">
              {ingest?.lastClassification ? (
                <Badge variant={getClassificationBadge(ingest.lastClassification)} className="text-[10px]">
                  {ingest.lastClassification}
                </Badge>
              ) : (
                <span className="text-muted-foreground">-</span>
              )}
            </div>
          </div>

          <div className="border rounded p-2">
            <div className="text-muted-foreground">Timer</div>
            <div className="flex items-center gap-1 mt-1">
              <Clock className="h-3 w-3" />
              {countdown !== null ? (
                <span className={cn('font-mono font-medium', countdown === 0 && 'text-destructive')}>
                  {formatSeconds(countdown)}
                </span>
              ) : (
                <span className="text-muted-foreground">-</span>
              )}
            </div>
          </div>
        </div>

        {/* Fields accumulated */}
        {fieldsCount > 0 && (
          <div className="flex flex-wrap gap-1">
            {ingest?.fieldsAccumulated?.map(field => (
              <Badge key={field} variant="outline" className="text-[10px]">
                {field}
              </Badge>
            ))}
          </div>
        )}
      </div>

      <Separator />

      {/* Section 2: Timeline */}
      <div className="space-y-2">
        <div className="flex items-center gap-2">
          <Activity className="h-4 w-4 text-primary" />
          <span className="font-medium text-sm">Timeline</span>
          <span className="text-muted-foreground">({timeline.length})</span>
        </div>

        {timeline.length === 0 ? (
          <div className="text-center text-muted-foreground py-4">
            No hay mensajes clasificados todavia
          </div>
        ) : (
          <div className="space-y-1 max-h-[200px] overflow-y-auto">
            {timeline.map((entry, idx) => (
              <TimelineEntry key={idx} entry={entry} />
            ))}
          </div>
        )}
      </div>

      <Separator />

      {/* Section 3: Timer Controls */}
      <div className="space-y-3">
        <div className="flex items-center gap-2">
          <Clock className="h-4 w-4 text-primary" />
          <span className="font-medium text-sm">Configuracion de Timers</span>
        </div>

        {/* Preset buttons */}
        <ToggleGroup type="single" value={activePreset} onValueChange={handlePresetChange}>
          {TIMER_PRESETS.map(preset => (
            <ToggleGroupItem key={preset.id} value={preset.id} className="text-xs px-3">
              {preset.label}
              <span className="ml-1 text-muted-foreground">
                ({formatSeconds(preset.partial)}/{formatSeconds(preset.noData)})
              </span>
            </ToggleGroupItem>
          ))}
        </ToggleGroup>

        {/* Fine-tune sliders */}
        <div className="space-y-3">
          <div className="space-y-1.5">
            <div className="flex items-center justify-between">
              <label className="text-muted-foreground">Con datos (parcial)</label>
              <span className="font-mono text-muted-foreground">{formatSeconds(partialTimer)}</span>
            </div>
            <Slider
              value={[partialTimer]}
              onValueChange={handlePartialChange}
              min={0}
              max={600}
              step={10}
            />
          </div>

          <div className="space-y-1.5">
            <div className="flex items-center justify-between">
              <label className="text-muted-foreground">Sin datos</label>
              <span className="font-mono text-muted-foreground">{formatSeconds(noDataTimer)}</span>
            </div>
            <Slider
              value={[noDataTimer]}
              onValueChange={handleNoDataChange}
              min={0}
              max={600}
              step={10}
            />
          </div>
        </div>
      </div>
    </div>
  )
}
```

**Update `panel-container.tsx`:**

Replace the ingest placeholder with the real IngestTab component:
- Import `IngestTab` from `./ingest-tab`
- In the `PanelContent` switch, replace the `case 'ingest'` placeholder with:
```typescript
case 'ingest':
  return <IngestTab state={props.state} />
```
- Add `onTimerChange` prop threading if needed (can be added later when wiring to sandbox-engine)
  </action>
  <verify>
```bash
cd /mnt/c/Users/Usuario/Proyectos/morfx-new && npx tsc --noEmit --pretty 2>&1 | head -30
```
IngestTab compiles. panel-container renders it for 'ingest' ID.
  </verify>
  <done>
- IngestTab shows status (active/inactive, fields count, last classification, timer countdown)
- IngestTab shows timeline of classified messages with expandable entries
- IngestTab has 3 timer presets: Real (6min/10min), Rapido (30s/60s), Instantaneo (0s/0s)
- IngestTab has fine-tune sliders for partial and noData timers
- panel-container wires IngestTab for 'ingest' panel ID
  </done>
</task>

<task type="auto">
  <name>Task 2: Enhance TokensTab with per-model breakdown table</name>
  <files>
    src/app/(dashboard)/sandbox/components/debug-panel/tokens-tab.tsx
  </files>
  <action>
**Rewrite `tokens-tab.tsx`** to show per-model token breakdown.

Keep the existing summary card and per-turn breakdown, but add:

1. **Per-model summary table** between the summary card and per-turn list:
   - Columns: Modelo | Input | Output | Total
   - One row per model used (aggregate across all turns)
   - Models: 'claude-haiku-4-5' displayed as 'Haiku', 'claude-sonnet-4-5' as 'Sonnet'

2. **Per-turn breakdown enhanced** with model badges:
   - Each turn shows which models were used
   - Input/output split visible

Import `ModelTokenEntry` from `@/lib/agents/types`.

The TokensTab already receives `debugTurns` which (after Plan 01) contain `turn.tokens.models: ModelTokenEntry[]`.

Add model display name mapping:
```typescript
const MODEL_DISPLAY_NAMES: Record<string, string> = {
  'claude-haiku-4-5': 'Haiku',
  'claude-sonnet-4-5': 'Sonnet',
}
```

Add aggregation function:
```typescript
function aggregateByModel(debugTurns: DebugTurn[]): Map<string, { input: number; output: number }> {
  const totals = new Map<string, { input: number; output: number }>()
  for (const turn of debugTurns) {
    for (const entry of turn.tokens.models ?? []) {
      const existing = totals.get(entry.model) ?? { input: 0, output: 0 }
      existing.input += entry.inputTokens
      existing.output += entry.outputTokens
      totals.set(entry.model, existing)
    }
  }
  return totals
}
```

**Layout after enhancement:**
1. Summary card (total + avg per turn) - keep existing
2. Per-model table (new) - shown if any models have data
3. Budget warning (keep existing, shown at 40K)
4. Per-turn breakdown (enhanced with model badges)

For per-turn items, if `turn.tokens.models` has entries, show small model badges:
```tsx
{turn.tokens.models?.length > 0 && (
  <div className="flex gap-1 mt-1">
    {turn.tokens.models.map((m, i) => (
      <Badge key={i} variant="outline" className="text-[10px]">
        {MODEL_DISPLAY_NAMES[m.model] ?? m.model}: {m.inputTokens}+{m.outputTokens}
      </Badge>
    ))}
  </div>
)}
```

**IMPORTANT:** Handle backward compatibility - `turn.tokens.models` may be undefined for debug turns created before Plan 01 changes. Use optional chaining: `turn.tokens.models ?? []`.
  </action>
  <verify>
```bash
cd /mnt/c/Users/Usuario/Proyectos/morfx-new && npx tsc --noEmit --pretty 2>&1 | head -30
```
TokensTab compiles and renders per-model table.
  </verify>
  <done>
- Tokens tab shows per-model summary table (Haiku/Sonnet with input/output/total)
- Per-turn breakdown shows model badges with input+output split
- Backward compatible with turns that don't have models array
- Budget warning at 40K still works
  </done>
</task>

</tasks>

<verification>
```bash
cd /mnt/c/Users/Usuario/Proyectos/morfx-new && npx tsc --noEmit --pretty
```
Both IngestTab and TokensTab compile and work within the multi-panel container.
</verification>

<success_criteria>
1. IngestTab shows ingest status grid (active/inactive, fields, classification, timer)
2. IngestTab shows scrollable timeline of classified messages
3. IngestTab has 3 timer presets with slider fine-tuning
4. TokensTab shows per-model table with Input/Output/Total columns
5. TokensTab per-turn items show model badges
6. Both tabs render correctly in the panel container
</success_criteria>

<output>
After completion, create `.planning/phases/15.6-sandbox-evolution/15.6-04-SUMMARY.md`
</output>
