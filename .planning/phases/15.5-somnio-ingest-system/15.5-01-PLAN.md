---
phase: 15.5-somnio-ingest-system
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/agents/somnio/message-classifier.ts
autonomous: true

must_haves:
  truths:
    - "Classifier returns 'datos' for data-only messages (Jose Romero, calle 123)"
    - "Classifier returns 'pregunta' for question-only messages (cuanto cuesta?)"
    - "Classifier returns 'mixto' for messages with both (Jose, cuanto vale?)"
    - "Classifier returns 'irrelevante' for acknowledgments (ok, gracias)"
  artifacts:
    - path: "src/lib/agents/somnio/message-classifier.ts"
      provides: "LLM-based message classification"
      exports: ["MessageClassifier", "MessageClassification", "ClassificationResult"]
      min_lines: 80
  key_links:
    - from: "message-classifier.ts"
      to: "ClaudeClient"
      via: "claude-haiku-4-5 structured outputs"
      pattern: "claudeClient.*create"
---

<objective>
Create LLM-based message classifier for detecting datos/pregunta/mixto/irrelevante

Purpose: Enable intelligent routing during data collection - respond to questions, stay silent on data
Output: MessageClassifier class using Claude Haiku for fast, cheap classification
</objective>

<execution_context>
@/home/jose147/.claude/get-shit-done/workflows/execute-plan.md
@/home/jose147/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/15.5-somnio-ingest-system/15.5-CONTEXT.md
@.planning/phases/15.5-somnio-ingest-system/15.5-RESEARCH.md

# Existing patterns to follow
@src/lib/agents/somnio/data-extractor.ts
@src/lib/agents/claude-client.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create MessageClassifier with structured outputs</name>
  <files>src/lib/agents/somnio/message-classifier.ts</files>
  <action>
Create MessageClassifier class that uses Claude Haiku for message classification:

1. Define types:
   - `MessageClassification = 'datos' | 'pregunta' | 'mixto' | 'irrelevante'`
   - `ClassificationResult { classification, confidence, reasoning?, extractedDataHint? }`

2. Create CLASSIFIER_PROMPT (from RESEARCH.md):
   - Explain the 4 categories with clear examples
   - Include hola+datos as mixto variant (Pitfall 5 from research)
   - Examples: "Juan Carlos Perez" -> datos, "Cuanto vale?" -> pregunta, "Jose, de Bogota. Hacen envios?" -> mixto, "Ok" -> irrelevante

3. Implement classify() method:
   - Use ClaudeClient with model 'claude-haiku-4-5-20251101'
   - IMPORTANT: Fallback to 'claude-sonnet-4-5' if Haiku errors (decision 13-03 pattern)
   - Parse JSON response, return ClassificationResult
   - Log classification with createModuleLogger('message-classifier')

4. Handle edge cases:
   - Greetings with data: "Hola soy Maria" -> mixto (saludo + nombre)
   - Pure greetings: "Hola" -> irrelevante (no data, no question)
   - Multiple data: "Jose de Bogota en calle 123" -> datos

Follow DataExtractor pattern for ClaudeClient usage. Use existing patterns from data-extractor.ts.
  </action>
  <verify>
TypeScript compiles: `cd /mnt/c/Users/Usuario/Proyectos/morfx-new && npx tsc --noEmit --skipLibCheck 2>&1 | grep -E "(error|message-classifier)" || echo "No errors"`
  </verify>
  <done>
MessageClassifier exports classify() method that returns ClassificationResult with one of 4 classifications
  </done>
</task>

<task type="auto">
  <name>Task 2: Export from somnio index and add unit test examples</name>
  <files>src/lib/agents/somnio/index.ts</files>
  <action>
1. Add exports to src/lib/agents/somnio/index.ts:
   ```typescript
   export { MessageClassifier, type MessageClassification, type ClassificationResult } from './message-classifier'
   ```

2. In message-classifier.ts, add JSDoc examples that serve as documentation:
   ```typescript
   /**
    * @example
    * // datos
    * await classifier.classify("Jose Romero") // -> { classification: 'datos', ... }
    *
    * // pregunta
    * await classifier.classify("Cuanto cuesta?") // -> { classification: 'pregunta', ... }
    *
    * // mixto
    * await classifier.classify("Jose, cuanto vale?") // -> { classification: 'mixto', ... }
    *
    * // irrelevante
    * await classifier.classify("Ok") // -> { classification: 'irrelevante', ... }
    */
   ```
  </action>
  <verify>
Check exports: `cd /mnt/c/Users/Usuario/Proyectos/morfx-new && grep -l "MessageClassifier" src/lib/agents/somnio/index.ts`
  </verify>
  <done>
MessageClassifier is exported from somnio module and has documented usage examples
  </done>
</task>

</tasks>

<verification>
1. File exists: `ls src/lib/agents/somnio/message-classifier.ts`
2. TypeScript compiles without errors
3. Module exports include MessageClassifier
</verification>

<success_criteria>
- MessageClassifier class created with classify() method
- Uses Claude Haiku with structured output parsing
- Handles all 4 classification types (datos, pregunta, mixto, irrelevante)
- Exported from somnio module index
- Follows existing DataExtractor patterns
</success_criteria>

<output>
After completion, create `.planning/phases/15.5-somnio-ingest-system/15.5-01-SUMMARY.md`
</output>
