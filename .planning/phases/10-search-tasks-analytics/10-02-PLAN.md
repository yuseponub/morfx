---
phase: 10-search-tasks-analytics
plan: 02
type: execute
wave: 2
depends_on: ["10-01"]
files_modified:
  - src/app/actions/tasks.ts
  - src/app/(dashboard)/tareas/page.tsx
  - src/app/(dashboard)/tareas/components/task-list.tsx
  - src/app/(dashboard)/tareas/components/task-form.tsx
  - src/app/(dashboard)/tareas/components/task-filters.tsx
  - src/components/tasks/task-item.tsx
autonomous: true

must_haves:
  truths:
    - "User can view list of all tasks in workspace"
    - "User can create a new task with title, description, due date, priority"
    - "User can edit and complete tasks"
    - "User can filter tasks by status, priority, and assignment"
  artifacts:
    - path: "src/app/actions/tasks.ts"
      provides: "Server Actions for task CRUD"
      exports: ["getTasks", "createTask", "updateTask", "deleteTask", "completeTask", "getTaskSummary"]
    - path: "src/app/(dashboard)/tareas/page.tsx"
      provides: "Tasks list page"
      contains: "TaskList"
    - path: "src/app/(dashboard)/tareas/components/task-form.tsx"
      provides: "Task creation/edit form"
      contains: "TaskForm"
  key_links:
    - from: "tareas/page.tsx"
      to: "getTasks"
      via: "Server Action call"
      pattern: "await getTasks"
    - from: "task-form.tsx"
      to: "createTask"
      via: "Form submission"
      pattern: "createTask\\("
---

<objective>
Create the core task management functionality with Server Actions and main UI.

Purpose: Users can view, create, edit, and filter their tasks from a central /tareas page. This is the foundation for task management before integrating with entities.

Output: Server Actions for task CRUD, tasks page with list and filters, task form modal.
</objective>

<execution_context>
@/home/jose147/.claude/get-shit-done/workflows/execute-plan.md
@/home/jose147/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/10-search-tasks-analytics/10-CONTEXT.md
@.planning/phases/10-search-tasks-analytics/10-01-SUMMARY.md

# Existing patterns to follow
@src/app/actions/orders.ts
@src/app/(dashboard)/crm/pedidos/page.tsx
@src/app/(dashboard)/crm/pedidos/components/order-form.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create task Server Actions</name>
  <files>src/app/actions/tasks.ts</files>
  <action>
Create Server Actions following existing patterns (see orders.ts):

```typescript
'use server'

import { createClient } from '@/lib/supabase/server'
import { getWorkspaceId } from '@/lib/workspace/server'
import type {
  Task,
  TaskWithDetails,
  CreateTaskInput,
  UpdateTaskInput,
  TaskFilters,
  TaskSummary,
  TaskType,
  CreateTaskTypeInput,
  UpdateTaskTypeInput
} from '@/lib/tasks/types'
```

**Functions to implement:**

1. `getTasks(filters?: TaskFilters): Promise<TaskWithDetails[]>`
   - Join with contact, order, conversation, assigned_user, task_type
   - Apply filters (status, priority, assigned_to, entity_type, due dates)
   - Order by: overdue first, then by due_date ASC, then by created_at DESC
   - Use `.eq('workspace_id', workspaceId)` for isolation

2. `getTask(id: string): Promise<TaskWithDetails | null>`
   - Single task with all relations

3. `createTask(input: CreateTaskInput): Promise<Task>`
   - Set workspace_id, created_by from context
   - Validate at most one entity_id is provided
   - Return created task

4. `updateTask(id: string, input: UpdateTaskInput): Promise<Task>`
   - Update allowed fields
   - If status changes to 'completed', set completed_at
   - If status changes to 'pending', clear completed_at

5. `deleteTask(id: string): Promise<void>`
   - Delete task by id (RLS enforces permissions)

6. `completeTask(id: string): Promise<Task>`
   - Shorthand for updateTask with status: 'completed'

7. `reopenTask(id: string): Promise<Task>`
   - Set status back to 'pending', clear completed_at

8. `getTaskSummary(): Promise<TaskSummary>`
   - Count pending tasks
   - Count overdue (due_date < now AND status = pending)
   - Count dueSoon (due_date within 24 hours AND status = pending)
   - Single query with CASE WHEN aggregations for efficiency

9. `getTaskTypes(): Promise<TaskType[]>`
   - List all task types for workspace, ordered by position

10. `createTaskType(input: CreateTaskTypeInput): Promise<TaskType>`

11. `updateTaskType(id: string, input: UpdateTaskTypeInput): Promise<TaskType>`

12. `deleteTaskType(id: string): Promise<void>`

13. `reorderTaskTypes(ids: string[]): Promise<void>`
    - Update positions based on array order

**Error handling:** Use try/catch, return `{ error: string }` on failure (match existing pattern).

**Important:** For Supabase nested joins with nullable FKs, cast results as needed for TypeScript compatibility (see existing patterns with `as any[]`).
  </action>
  <verify>
Run: `pnpm tsc --noEmit` - compiles without errors.
Verify function signatures match types from 10-01.
  </verify>
  <done>
All Server Actions exported and TypeScript compiles. Functions cover full CRUD plus summary.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create tasks page and components</name>
  <files>
    src/app/(dashboard)/tareas/page.tsx
    src/app/(dashboard)/tareas/components/task-list.tsx
    src/app/(dashboard)/tareas/components/task-form.tsx
    src/app/(dashboard)/tareas/components/task-filters.tsx
    src/components/tasks/task-item.tsx
  </files>
  <action>
Create the tasks page following pedidos/page.tsx patterns:

**1. src/app/(dashboard)/tareas/page.tsx**
Server component that:
- Fetches tasks with getTasks()
- Fetches task types with getTaskTypes()
- Fetches workspace members for assignment dropdown
- Renders TaskList with data

```tsx
export default async function TareasPage() {
  const tasks = await getTasks({ status: 'all' })
  const taskTypes = await getTaskTypes()
  const members = await getWorkspaceMembers()

  return (
    <div className="container py-6 space-y-6">
      <div className="flex items-center justify-between">
        <div>
          <h1 className="text-2xl font-bold">Tareas</h1>
          <p className="text-muted-foreground">Gestiona tus tareas y recordatorios</p>
        </div>
        <TaskFormDialog taskTypes={taskTypes} members={members} />
      </div>
      <TaskList
        initialTasks={tasks}
        taskTypes={taskTypes}
        members={members}
      />
    </div>
  )
}
```

**2. src/app/(dashboard)/tareas/components/task-filters.tsx**
Filter bar with:
- Status toggle: Todas | Pendientes | Completadas
- Priority filter dropdown
- Assigned filter: Todas | Mis tareas | Sin asignar | [member list]
- Clear filters button

Use existing patterns from order-filters.tsx.

**3. src/app/(dashboard)/tareas/components/task-list.tsx**
Client component that:
- Takes initialTasks, manages state
- Renders TaskFilters
- Maps tasks to TaskItem components
- Groups by: Vencidas, Hoy, Esta semana, Proximas, Sin fecha
- Empty state when no tasks

**4. src/app/(dashboard)/tareas/components/task-form.tsx**
Dialog/Sheet with form for create/edit:
- Title (required)
- Description (textarea, optional)
- Due date (Calendar picker)
- Priority (select: low/medium/high)
- Task type (select from workspace types)
- Assigned to (select from workspace members)
- Entity link display (read-only when editing linked task)

Use react-hook-form, NOT Zod (following project convention from order-form.tsx).
Submit calls createTask or updateTask action.
Use Sheet component for more space (like order-form).

**5. src/components/tasks/task-item.tsx**
Reusable task item component:
- Checkbox for completion toggle
- Title with strikethrough when completed
- Due date badge (red if overdue, yellow if today, gray otherwise)
- Priority indicator (colored dot)
- Assigned user avatar
- Entity link icon (contact/order/chat) with tooltip
- Edit/delete actions in dropdown

Priority colors:
- high: red
- medium: yellow
- low: gray

**Styling:** Use Tailwind, follow existing component patterns. Spanish labels.
  </action>
  <verify>
1. Navigate to /tareas - page renders without errors
2. Click "Nueva tarea" - form dialog opens
3. Create a task - appears in list
4. Toggle filters - list updates
5. Complete a task - checkbox works, item shows strikethrough
  </verify>
  <done>
Tasks page functional with list, filters, create/edit form. Users can manage tasks.
  </done>
</task>

</tasks>

<verification>
1. /tareas page renders task list
2. Task creation form validates required fields
3. Filters update task list correctly
4. Task completion toggles work
5. Edit/delete operations function
6. Empty state displays when no tasks
7. Due date grouping works correctly
</verification>

<success_criteria>
- [ ] User can view list of tasks with filters
- [ ] User can create tasks with all fields
- [ ] User can edit and delete tasks
- [ ] User can mark tasks complete/incomplete
- [ ] Task list groups by due date proximity
- [ ] Priority and assignment filters work
</success_criteria>

<output>
After completion, create `.planning/phases/10-search-tasks-analytics/10-02-SUMMARY.md`
</output>
