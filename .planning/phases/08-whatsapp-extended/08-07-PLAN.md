---
phase: 08-whatsapp-extended
plan: 07
type: execute
wave: 2
depends_on: ["08-02"]
files_modified:
  - src/app/(dashboard)/configuracion/whatsapp/quick-replies/page.tsx
  - src/app/(dashboard)/configuracion/whatsapp/quick-replies/components/quick-reply-list.tsx
  - src/app/(dashboard)/configuracion/whatsapp/quick-replies/components/quick-reply-form.tsx
  - src/app/(dashboard)/whatsapp/components/message-input.tsx
autonomous: true

must_haves:
  truths:
    - "User can create and manage quick replies"
    - "User can type / in message input to trigger autocomplete"
    - "Selecting quick reply inserts content into input"
    - "Quick replies are searchable by shortcut"
  artifacts:
    - path: "src/app/(dashboard)/configuracion/whatsapp/quick-replies/page.tsx"
      provides: "Quick reply management page"
      min_lines: 40
    - path: "src/app/(dashboard)/whatsapp/components/message-input.tsx"
      provides: "Message input with slash-command autocomplete"
      contains: "trigger"
  key_links:
    - from: "quick-reply-list.tsx"
      to: "src/app/actions/quick-replies.ts"
      via: "Server Action calls"
      pattern: "getQuickReplies"
    - from: "message-input.tsx"
      to: "src/app/actions/quick-replies.ts"
      via: "searchQuickReplies for autocomplete"
      pattern: "searchQuickReplies"
---

<objective>
Build quick replies management and slash-command autocomplete in message input (WAPP-09).

Purpose: Allow agents to quickly insert common responses using keyboard shortcuts.
Output: Quick reply settings page and message input with / trigger.
</objective>

<execution_context>
@/home/jose147/.claude/get-shit-done/workflows/execute-plan.md
@/home/jose147/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/08-whatsapp-extended/08-CONTEXT.md
@.planning/phases/08-whatsapp-extended/08-RESEARCH.md
@src/app/actions/quick-replies.ts
@src/app/(dashboard)/whatsapp/components/message-input.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Quick Reply Management Page</name>
  <files>
    src/app/(dashboard)/configuracion/whatsapp/quick-replies/page.tsx
    src/app/(dashboard)/configuracion/whatsapp/quick-replies/components/quick-reply-list.tsx
    src/app/(dashboard)/configuracion/whatsapp/quick-replies/components/quick-reply-form.tsx
  </files>
  <action>
**Create src/app/(dashboard)/configuracion/whatsapp/quick-replies/page.tsx:**

```typescript
import { getQuickReplies } from '@/app/actions/quick-replies'
import { QuickReplyList } from './components/quick-reply-list'
import { QuickReplyForm } from './components/quick-reply-form'
import { Button } from '@/components/ui/button'
import { Plus } from 'lucide-react'
import {
  Dialog,
  DialogContent,
  DialogHeader,
  DialogTitle,
  DialogTrigger
} from '@/components/ui/dialog'

export default async function QuickRepliesPage() {
  const quickReplies = await getQuickReplies()

  return (
    <div className="container py-6">
      <div className="flex items-center justify-between mb-6">
        <div>
          <h1 className="text-2xl font-bold">Respuestas Rapidas</h1>
          <p className="text-muted-foreground">
            Crea atajos para respuestas frecuentes. Escribe / en el chat para usarlas.
          </p>
        </div>

        <Dialog>
          <DialogTrigger asChild>
            <Button>
              <Plus className="h-4 w-4 mr-2" />
              Nueva Respuesta
            </Button>
          </DialogTrigger>
          <DialogContent>
            <DialogHeader>
              <DialogTitle>Crear Respuesta Rapida</DialogTitle>
            </DialogHeader>
            <QuickReplyForm />
          </DialogContent>
        </Dialog>
      </div>

      <QuickReplyList quickReplies={quickReplies} />
    </div>
  )
}
```

**Create src/app/(dashboard)/configuracion/whatsapp/quick-replies/components/quick-reply-form.tsx:**

```typescript
'use client'

import { useState } from 'react'
import { useRouter } from 'next/navigation'
import { Button } from '@/components/ui/button'
import { Input } from '@/components/ui/input'
import { Label } from '@/components/ui/label'
import { Textarea } from '@/components/ui/textarea'
import { createQuickReply, updateQuickReply } from '@/app/actions/quick-replies'
import { QuickReply } from '@/lib/whatsapp/types'
import { toast } from 'sonner'
import { Loader2 } from 'lucide-react'

interface QuickReplyFormProps {
  quickReply?: QuickReply
  onSuccess?: () => void
}

export function QuickReplyForm({ quickReply, onSuccess }: QuickReplyFormProps) {
  const router = useRouter()
  const [loading, setLoading] = useState(false)
  const [shortcut, setShortcut] = useState(quickReply?.shortcut || '')
  const [content, setContent] = useState(quickReply?.content || '')

  const isEditing = !!quickReply

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault()
    setLoading(true)

    try {
      if (isEditing) {
        await updateQuickReply(quickReply.id, { shortcut, content })
        toast.success('Respuesta actualizada')
      } else {
        await createQuickReply({ shortcut, content })
        toast.success('Respuesta creada')
      }
      router.refresh()
      onSuccess?.()
    } catch (error) {
      toast.error(error instanceof Error ? error.message : 'Error al guardar')
    } finally {
      setLoading(false)
    }
  }

  return (
    <form onSubmit={handleSubmit} className="space-y-4">
      <div className="space-y-2">
        <Label htmlFor="shortcut">Atajo</Label>
        <div className="flex items-center gap-2">
          <span className="text-muted-foreground">/</span>
          <Input
            id="shortcut"
            value={shortcut}
            onChange={(e) => setShortcut(e.target.value.toLowerCase().replace(/[^a-z0-9_]/g, ''))}
            placeholder="saludo"
            required
          />
        </div>
        <p className="text-xs text-muted-foreground">
          Solo letras minusculas, numeros y guiones bajos
        </p>
      </div>

      <div className="space-y-2">
        <Label htmlFor="content">Contenido</Label>
        <Textarea
          id="content"
          value={content}
          onChange={(e) => setContent(e.target.value)}
          placeholder="Hola! Gracias por contactarnos. En que podemos ayudarte?"
          rows={4}
          required
        />
        <p className="text-xs text-muted-foreground">
          Este texto se insertara cuando uses el atajo /{shortcut || 'atajo'}
        </p>
      </div>

      <div className="flex justify-end gap-2 pt-2">
        <Button type="submit" disabled={loading || !shortcut.trim() || !content.trim()}>
          {loading && <Loader2 className="h-4 w-4 mr-2 animate-spin" />}
          {isEditing ? 'Guardar Cambios' : 'Crear Respuesta'}
        </Button>
      </div>
    </form>
  )
}
```

**Create src/app/(dashboard)/configuracion/whatsapp/quick-replies/components/quick-reply-list.tsx:**

```typescript
'use client'

import { useState } from 'react'
import { QuickReply } from '@/lib/whatsapp/types'
import { Card, CardContent } from '@/components/ui/card'
import { Button } from '@/components/ui/button'
import { QuickReplyForm } from './quick-reply-form'
import { deleteQuickReply } from '@/app/actions/quick-replies'
import { toast } from 'sonner'
import { MessageSquare, Edit, Trash2 } from 'lucide-react'
import {
  Dialog,
  DialogContent,
  DialogHeader,
  DialogTitle
} from '@/components/ui/dialog'
import {
  AlertDialog,
  AlertDialogAction,
  AlertDialogCancel,
  AlertDialogContent,
  AlertDialogDescription,
  AlertDialogFooter,
  AlertDialogHeader,
  AlertDialogTitle,
  AlertDialogTrigger
} from '@/components/ui/alert-dialog'

export function QuickReplyList({ quickReplies }: { quickReplies: QuickReply[] }) {
  const [editingReply, setEditingReply] = useState<QuickReply | null>(null)

  if (quickReplies.length === 0) {
    return (
      <Card>
        <CardContent className="py-12 text-center">
          <MessageSquare className="h-12 w-12 mx-auto text-muted-foreground mb-4" />
          <h3 className="font-medium text-lg">No hay respuestas rapidas</h3>
          <p className="text-muted-foreground">
            Crea respuestas rapidas para agilizar la atencion al cliente
          </p>
        </CardContent>
      </Card>
    )
  }

  async function handleDelete(id: string) {
    try {
      await deleteQuickReply(id)
      toast.success('Respuesta eliminada')
    } catch (error) {
      toast.error('Error al eliminar')
    }
  }

  return (
    <>
      <div className="grid gap-3 md:grid-cols-2 lg:grid-cols-3">
        {quickReplies.map((reply) => (
          <Card key={reply.id}>
            <CardContent className="p-4">
              <div className="flex items-start justify-between mb-2">
                <code className="text-sm font-mono bg-muted px-2 py-1 rounded">
                  /{reply.shortcut}
                </code>
                <div className="flex gap-1">
                  <Button
                    variant="ghost"
                    size="icon"
                    className="h-8 w-8"
                    onClick={() => setEditingReply(reply)}
                  >
                    <Edit className="h-4 w-4" />
                  </Button>
                  <AlertDialog>
                    <AlertDialogTrigger asChild>
                      <Button variant="ghost" size="icon" className="h-8 w-8 text-destructive">
                        <Trash2 className="h-4 w-4" />
                      </Button>
                    </AlertDialogTrigger>
                    <AlertDialogContent>
                      <AlertDialogHeader>
                        <AlertDialogTitle>Eliminar respuesta</AlertDialogTitle>
                        <AlertDialogDescription>
                          Esta accion no se puede deshacer.
                        </AlertDialogDescription>
                      </AlertDialogHeader>
                      <AlertDialogFooter>
                        <AlertDialogCancel>Cancelar</AlertDialogCancel>
                        <AlertDialogAction onClick={() => handleDelete(reply.id)}>
                          Eliminar
                        </AlertDialogAction>
                      </AlertDialogFooter>
                    </AlertDialogContent>
                  </AlertDialog>
                </div>
              </div>
              <p className="text-sm text-muted-foreground line-clamp-3">
                {reply.content}
              </p>
            </CardContent>
          </Card>
        ))}
      </div>

      <Dialog open={!!editingReply} onOpenChange={() => setEditingReply(null)}>
        <DialogContent>
          <DialogHeader>
            <DialogTitle>Editar Respuesta Rapida</DialogTitle>
          </DialogHeader>
          {editingReply && (
            <QuickReplyForm
              quickReply={editingReply}
              onSuccess={() => setEditingReply(null)}
            />
          )}
        </DialogContent>
      </Dialog>
    </>
  )
}
```

Use grid layout for card display of quick replies.
  </action>
  <verify>Run `pnpm tsc --noEmit` to verify TypeScript compiles. Navigate to /configuracion/whatsapp/quick-replies and verify page renders.</verify>
  <done>Quick reply management page created with card grid layout. Create/edit form validates shortcut format. Delete with confirmation.</done>
</task>

<task type="auto">
  <name>Task 2: Install and Configure Textarea Autocomplete</name>
  <files>
    package.json
  </files>
  <action>
Install the react-textarea-autocomplete library:

```bash
pnpm add @webscopeio/react-textarea-autocomplete
```

This library provides GitHub-style autocomplete functionality triggered by specific characters.

After installation, the library will be available for use in the message input component.

Note: Check if there are any peer dependencies that need to be installed. The library should work with React 18+.
  </action>
  <verify>Run `pnpm install` and verify the package is added to package.json. Check `node_modules/@webscopeio/react-textarea-autocomplete` exists.</verify>
  <done>@webscopeio/react-textarea-autocomplete installed successfully.</done>
</task>

<task type="auto">
  <name>Task 3: Integrate Slash-Command Autocomplete in Message Input</name>
  <files>
    src/app/(dashboard)/whatsapp/components/message-input.tsx
    src/app/(dashboard)/whatsapp/components/quick-reply-autocomplete.tsx
  </files>
  <action>
**Create src/app/(dashboard)/whatsapp/components/quick-reply-autocomplete.tsx:**

A wrapper component for the autocomplete functionality:

```typescript
'use client'

import React, { forwardRef } from 'react'
import ReactTextareaAutocomplete from '@webscopeio/react-textarea-autocomplete'
import '@webscopeio/react-textarea-autocomplete/style.css'
import { QuickReply } from '@/lib/whatsapp/types'
import { searchQuickReplies } from '@/app/actions/quick-replies'

interface QuickReplyItemProps {
  entity: QuickReply
}

const QuickReplyItem = ({ entity }: QuickReplyItemProps) => (
  <div className="px-3 py-2 hover:bg-accent cursor-pointer">
    <div className="flex items-center gap-2">
      <code className="text-xs font-mono bg-muted px-1.5 py-0.5 rounded">
        /{entity.shortcut}
      </code>
    </div>
    <div className="text-sm text-muted-foreground mt-1 line-clamp-2">
      {entity.content}
    </div>
  </div>
)

const Loading = () => (
  <div className="px-3 py-2 text-sm text-muted-foreground">
    Buscando...
  </div>
)

interface QuickReplyAutocompleteProps {
  value: string
  onChange: (value: string) => void
  onSubmit: () => void
  placeholder?: string
  disabled?: boolean
  className?: string
}

export const QuickReplyAutocomplete = forwardRef<
  HTMLTextAreaElement,
  QuickReplyAutocompleteProps
>(({ value, onChange, onSubmit, placeholder, disabled, className }, ref) => {
  const handleKeyDown = (e: React.KeyboardEvent) => {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault()
      onSubmit()
    }
  }

  return (
    <ReactTextareaAutocomplete<QuickReply>
      value={value}
      onChange={(e) => onChange(e.target.value)}
      onKeyDown={handleKeyDown}
      placeholder={placeholder}
      disabled={disabled}
      className={className}
      loadingComponent={Loading}
      minChar={0}
      trigger={{
        '/': {
          dataProvider: async (token) => {
            try {
              const results = await searchQuickReplies(token)
              return results.slice(0, 5)
            } catch {
              return []
            }
          },
          component: QuickReplyItem,
          output: (item) => item.content  // Replace /shortcut with full content
        }
      }}
      containerStyle={{
        position: 'relative'
      }}
      dropdownStyle={{
        position: 'absolute',
        bottom: '100%',
        left: 0,
        right: 0,
        marginBottom: '4px',
        backgroundColor: 'hsl(var(--background))',
        border: '1px solid hsl(var(--border))',
        borderRadius: '8px',
        boxShadow: '0 4px 6px -1px rgb(0 0 0 / 0.1)',
        overflow: 'hidden',
        zIndex: 50
      }}
      listStyle={{
        maxHeight: '200px',
        overflow: 'auto'
      }}
      itemStyle={{}}
      style={{
        width: '100%',
        minHeight: '80px',
        maxHeight: '200px',
        resize: 'none',
        padding: '12px',
        fontSize: '14px',
        lineHeight: '1.5',
        border: 'none',
        outline: 'none',
        backgroundColor: 'transparent'
      }}
    />
  )
})

QuickReplyAutocomplete.displayName = 'QuickReplyAutocomplete'
```

**Update src/app/(dashboard)/whatsapp/components/message-input.tsx:**

Replace the existing Textarea with QuickReplyAutocomplete:

```typescript
// Add import
import { QuickReplyAutocomplete } from './quick-reply-autocomplete'

// In the component, replace the Textarea with:
<QuickReplyAutocomplete
  value={message}
  onChange={setMessage}
  onSubmit={handleSend}
  placeholder="Escribe un mensaje... (/ para respuestas rapidas)"
  disabled={!isWindowOpen}
/>

// Keep the existing emoji picker and file upload buttons
// The autocomplete dropdown will appear above the input when / is typed
```

Important styling notes:
- Dropdown appears ABOVE the input (bottom: '100%')
- Dropdown matches shadcn/ui styling
- Quick reply item shows shortcut as code and content preview
- Selecting a reply replaces the /shortcut text with full content

The exact integration depends on current message-input.tsx structure. Key changes:
1. Replace Textarea with QuickReplyAutocomplete
2. Keep emoji picker and file upload alongside
3. Maintain Enter key handling for send
  </action>
  <verify>Run `pnpm tsc --noEmit` to verify component compiles. Test that typing / shows autocomplete dropdown with quick replies.</verify>
  <done>QuickReplyAutocomplete component wraps react-textarea-autocomplete with project styling. Message input updated to use autocomplete. Typing / triggers quick reply search and selection inserts content.</done>
</task>

</tasks>

<verification>
1. Quick reply management page shows all replies in grid
2. Create/edit form works with shortcut validation
3. Delete removes quick reply
4. Typing / in message input shows autocomplete dropdown
5. Dropdown shows matching quick replies with shortcut and preview
6. Selecting quick reply inserts full content
7. Enter key still sends message
8. Autocomplete works with arrow keys and Enter to select
</verification>

<success_criteria>
- Quick replies page at /configuracion/whatsapp/quick-replies
- CRUD operations work correctly
- Package @webscopeio/react-textarea-autocomplete installed
- / trigger shows dropdown above input
- Quick reply content replaces shortcut when selected
- Dropdown styled to match project design
</success_criteria>

<output>
After completion, create `.planning/phases/08-whatsapp-extended/08-07-SUMMARY.md`
</output>
