---
phase: 13-agent-engine-core
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/20260205_agent_sessions.sql
  - src/lib/agents/types.ts
  - src/lib/agents/errors.ts
  - src/lib/agents/index.ts
autonomous: true

must_haves:
  truths:
    - "Agent sessions can be stored and retrieved from database"
    - "Session versioning supports optimistic locking"
    - "Agent turns track complete conversation history with token counts"
    - "TypeScript types provide compile-time safety for agent operations"
  artifacts:
    - path: "supabase/migrations/20260205_agent_sessions.sql"
      provides: "agent_sessions, agent_turns, session_state tables with RLS"
      contains: "CREATE TABLE agent_sessions"
    - path: "src/lib/agents/types.ts"
      provides: "AgentConfig, AgentSession, AgentTurn, SessionState, IntentResult, OrchestratorResult types"
      min_lines: 100
    - path: "src/lib/agents/errors.ts"
      provides: "VersionConflictError, SessionError, AgentError, BudgetExceededError"
      exports: ["VersionConflictError", "SessionError", "AgentError", "BudgetExceededError"]
  key_links:
    - from: "src/lib/agents/types.ts"
      to: "agent_sessions table schema"
      via: "TypeScript interface matching SQL columns"
      pattern: "interface AgentSession"
---

<objective>
Create database foundation and TypeScript types for the Agent Engine.

Purpose: Establish the data layer that all agent operations depend on. The agent_sessions, agent_turns, and session_state tables enable conversation persistence with optimistic locking. TypeScript types provide compile-time safety for the entire agent system.

Output: Migration file for 3 tables with RLS policies, TypeScript types for agents/sessions/turns, and error classes for agent-specific failure scenarios.
</objective>

<execution_context>
@/home/jose147/.claude/get-shit-done/workflows/execute-plan.md
@/home/jose147/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/13-agent-engine-core/13-CONTEXT.md
@.planning/phases/13-agent-engine-core/13-RESEARCH.md

# Phase 12 provides tool types we'll reference
@src/lib/tools/types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create database migration for agent tables</name>
  <files>supabase/migrations/20260205_agent_sessions.sql</files>
  <action>
Create migration with 3 tables following the schema from RESEARCH.md:

**agent_sessions table:**
- id UUID PRIMARY KEY DEFAULT gen_random_uuid()
- agent_id TEXT NOT NULL (references agent config, not a FK since agents are code-defined)
- conversation_id UUID NOT NULL REFERENCES conversations(id) ON DELETE CASCADE
- contact_id UUID NOT NULL REFERENCES contacts(id) ON DELETE CASCADE
- workspace_id UUID NOT NULL REFERENCES workspaces(id) ON DELETE CASCADE
- version INTEGER NOT NULL DEFAULT 1 (for optimistic locking)
- status TEXT NOT NULL DEFAULT 'active' CHECK (status IN ('active', 'paused', 'closed', 'handed_off'))
- current_mode TEXT NOT NULL DEFAULT 'conversacion'
- created_at TIMESTAMPTZ NOT NULL DEFAULT timezone('America/Bogota', NOW())
- updated_at TIMESTAMPTZ NOT NULL DEFAULT timezone('America/Bogota', NOW())
- last_activity_at TIMESTAMPTZ NOT NULL DEFAULT timezone('America/Bogota', NOW())
- UNIQUE(conversation_id, agent_id) -- one active session per conversation

**agent_turns table:**
- id UUID PRIMARY KEY DEFAULT gen_random_uuid()
- session_id UUID NOT NULL REFERENCES agent_sessions(id) ON DELETE CASCADE
- turn_number INTEGER NOT NULL
- role TEXT NOT NULL CHECK (role IN ('user', 'assistant', 'system'))
- content TEXT NOT NULL
- intent_detected TEXT (nullable, for user turns)
- confidence NUMERIC(5,2) (nullable, for user turns)
- tools_called JSONB NOT NULL DEFAULT '[]'
- tokens_used INTEGER NOT NULL DEFAULT 0
- created_at TIMESTAMPTZ NOT NULL DEFAULT timezone('America/Bogota', NOW())
- UNIQUE(session_id, turn_number)

**session_state table:**
- session_id UUID PRIMARY KEY REFERENCES agent_sessions(id) ON DELETE CASCADE
- intents_vistos JSONB NOT NULL DEFAULT '[]'
- templates_enviados JSONB NOT NULL DEFAULT '[]'
- datos_capturados JSONB NOT NULL DEFAULT '{}'
- pack_seleccionado TEXT CHECK (pack_seleccionado IN ('1x', '2x', '3x') OR pack_seleccionado IS NULL)
- proactive_started_at TIMESTAMPTZ (nullable, for timer tracking)
- first_data_at TIMESTAMPTZ (nullable)
- min_data_at TIMESTAMPTZ (nullable)
- ofrecer_promos_at TIMESTAMPTZ (nullable)
- updated_at TIMESTAMPTZ NOT NULL DEFAULT timezone('America/Bogota', NOW())

**Indexes:**
- idx_agent_sessions_workspace ON agent_sessions(workspace_id)
- idx_agent_sessions_conversation ON agent_sessions(conversation_id)
- idx_agent_sessions_status ON agent_sessions(workspace_id, status)
- idx_agent_sessions_activity ON agent_sessions(workspace_id, last_activity_at DESC)
- idx_agent_turns_session ON agent_turns(session_id, turn_number)
- idx_agent_turns_created ON agent_turns(session_id, created_at DESC)

**Triggers:**
- Use existing update_updated_at_column() function for agent_sessions and session_state

**RLS Policies:**
- Enable RLS on all 3 tables
- agent_sessions: workspace isolation using is_workspace_member(workspace_id)
- agent_turns: access via parent session (EXISTS subquery to agent_sessions)
- session_state: access via parent session (EXISTS subquery to agent_sessions)
- Add SELECT/INSERT/UPDATE policies for each table

**Realtime:**
- ALTER PUBLICATION supabase_realtime ADD TABLE agent_sessions
  </action>
  <verify>
Check migration syntax:
```bash
grep -E "CREATE TABLE agent_sessions|CREATE TABLE agent_turns|CREATE TABLE session_state" supabase/migrations/20260205_agent_sessions.sql
```
Verify RLS policies exist:
```bash
grep -c "CREATE POLICY" supabase/migrations/20260205_agent_sessions.sql
```
Should return at least 6 policies (2 per table minimum).
  </verify>
  <done>
Migration file exists with all 3 tables, proper indexes, triggers for updated_at, RLS policies for workspace isolation, and realtime publication for agent_sessions.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create TypeScript types and error classes</name>
  <files>
src/lib/agents/types.ts
src/lib/agents/errors.ts
src/lib/agents/index.ts
  </files>
  <action>
**Create src/lib/agents/types.ts:**

```typescript
/**
 * Agent Engine Types
 * Phase 13: Agent Engine Core
 */

// ============================================================================
// Agent Configuration
// ============================================================================

/** Supported Claude models for agent components */
export type ClaudeModel = 'claude-haiku-4-5' | 'claude-sonnet-4-5'

/** Model component configuration */
export interface ModelConfig {
  model: ClaudeModel
  systemPrompt: string
  maxTokens: number
}

/** Confidence thresholds for intent routing (user decision from CONTEXT.md) */
export interface ConfidenceThresholds {
  proceed: number      // >= 85 default: execute flow normally
  reanalyze: number    // 60-84 default: use more context
  clarify: number      // 40-59 default: ask customer for clarification
  handoff: number      // < 40 default: pass to human
}

/** Full agent configuration */
export interface AgentConfig {
  id: string
  name: string
  description: string

  // Claude configuration per component
  intentDetector: ModelConfig
  orchestrator: ModelConfig

  // Available tools from Action DSL
  tools: string[]  // e.g., ['crm.contact.create', 'whatsapp.message.send']

  // State machine
  states: string[]
  initialState: string
  validTransitions: Record<string, string[]>

  // Confidence thresholds
  confidenceThresholds: ConfidenceThresholds
}

// ============================================================================
// Session Types
// ============================================================================

/** Session status enum */
export type SessionStatus = 'active' | 'paused' | 'closed' | 'handed_off'

/** Agent session record (matches agent_sessions table) */
export interface AgentSession {
  id: string
  agent_id: string
  conversation_id: string
  contact_id: string
  workspace_id: string

  version: number
  status: SessionStatus
  current_mode: string

  created_at: string
  updated_at: string
  last_activity_at: string
}

/** Agent session with state joined */
export interface AgentSessionWithState extends AgentSession {
  state: SessionState
}

/** Turn role enum */
export type TurnRole = 'user' | 'assistant' | 'system'

/** Tool call recorded in a turn */
export interface TurnToolCall {
  name: string
  input: Record<string, unknown>
  result?: unknown
  success?: boolean
}

/** Agent turn record (matches agent_turns table) */
export interface AgentTurn {
  id: string
  session_id: string
  turn_number: number
  role: TurnRole
  content: string
  intent_detected: string | null
  confidence: number | null
  tools_called: TurnToolCall[]
  tokens_used: number
  created_at: string
}

/** Session state (matches session_state table) */
export interface SessionState {
  session_id?: string
  intents_vistos: Array<{ intent: string; orden: number; timestamp: string }>
  templates_enviados: string[]
  datos_capturados: Record<string, string>
  pack_seleccionado: '1x' | '2x' | '3x' | null

  // Timer tracking timestamps
  proactive_started_at?: string | null
  first_data_at?: string | null
  min_data_at?: string | null
  ofrecer_promos_at?: string | null

  updated_at?: string
}

// ============================================================================
// Claude Response Types
// ============================================================================

/** Intent detection result */
export interface IntentResult {
  intent: string
  confidence: number  // 0-100
  alternatives?: Array<{ intent: string; confidence: number }>
  reasoning?: string
}

/** Action determined by confidence routing */
export type ConfidenceAction = 'proceed' | 'reanalyze' | 'clarify' | 'handoff'

/** Orchestrator action type */
export type OrchestratorAction =
  | 'proceed'        // Continue with response
  | 'reanalyze'      // Need more context
  | 'clarify'        // Ask customer for clarification
  | 'handoff'        // Pass to human
  | 'execute_tool'   // Call one or more tools

/** Tool call request from orchestrator */
export interface ToolCallRequest {
  name: string  // Action DSL tool name (e.g., 'crm.contact.create')
  input: Record<string, unknown>
}

/** Orchestrator result */
export interface OrchestratorResult {
  action: OrchestratorAction
  toolCalls?: ToolCallRequest[]
  response?: string
  nextMode?: string
}

/** Claude message for conversation history */
export interface ClaudeMessage {
  role: 'user' | 'assistant'
  content: string | ClaudeContentBlock[]
}

/** Content block in Claude message */
export interface ClaudeContentBlock {
  type: 'text' | 'tool_use' | 'tool_result'
  text?: string
  id?: string
  name?: string
  input?: Record<string, unknown>
  tool_use_id?: string
  content?: string
  is_error?: boolean
}

// ============================================================================
// Engine Types
// ============================================================================

/** Input to process a message */
export interface ProcessMessageInput {
  sessionId: string
  conversationId: string
  contactId: string
  messageContent: string
  workspaceId: string
}

/** Tool execution result (from Action DSL) */
export interface ToolExecutionResult {
  name: string
  success: boolean
  data?: unknown
  error?: {
    code: string
    message: string
    retryable: boolean
  }
}

/** Agent response after processing */
export interface AgentResponse {
  response: string | null
  toolResults: ToolExecutionResult[]
  sessionUpdated: boolean
  intent?: IntentResult
  nextMode?: string
  handedOff?: boolean
}

/** Token usage tracking */
export interface TokenUsage {
  sessionId: string
  totalTokens: number
  turnCount: number
  remaining: number
}

// ============================================================================
// Constants
// ============================================================================

/** Maximum tokens per conversation (user decision) */
export const MAX_TOKENS_PER_CONVERSATION = 50_000

/** Default confidence thresholds (user decision from CONTEXT.md) */
export const DEFAULT_CONFIDENCE_THRESHOLDS: ConfidenceThresholds = {
  proceed: 85,
  reanalyze: 60,
  clarify: 40,
  handoff: 0,  // Everything below clarify threshold
}
```

**Create src/lib/agents/errors.ts:**

```typescript
/**
 * Agent Engine Errors
 * Phase 13: Agent Engine Core
 */

/** Base error for all agent-related errors */
export class AgentError extends Error {
  public readonly code: string

  constructor(message: string, code: string = 'AGENT_ERROR') {
    super(message)
    this.name = 'AgentError'
    this.code = code
  }
}

/** Error thrown when session version conflicts (optimistic locking) */
export class VersionConflictError extends AgentError {
  public readonly sessionId: string
  public readonly expectedVersion: number

  constructor(sessionId: string, expectedVersion: number) {
    super(
      `Version conflict for session ${sessionId}. Expected version ${expectedVersion} but it was modified concurrently.`,
      'VERSION_CONFLICT'
    )
    this.name = 'VersionConflictError'
    this.sessionId = sessionId
    this.expectedVersion = expectedVersion
  }
}

/** Error thrown for session operations */
export class SessionError extends AgentError {
  public readonly sessionId?: string
  public readonly cause?: unknown

  constructor(message: string, sessionId?: string, cause?: unknown) {
    super(message, 'SESSION_ERROR')
    this.name = 'SessionError'
    this.sessionId = sessionId
    this.cause = cause
  }
}

/** Error thrown when token budget is exceeded */
export class BudgetExceededError extends AgentError {
  public readonly sessionId: string
  public readonly used: number
  public readonly limit: number

  constructor(sessionId: string, used: number, limit: number) {
    super(
      `Token budget exceeded for session ${sessionId}. Used: ${used}, Limit: ${limit}`,
      'BUDGET_EXCEEDED'
    )
    this.name = 'BudgetExceededError'
    this.sessionId = sessionId
    this.used = used
    this.limit = limit
  }
}

/** Error thrown when agent is not found in registry */
export class AgentNotFoundError extends AgentError {
  public readonly agentId: string

  constructor(agentId: string) {
    super(`Agent "${agentId}" not found in registry`, 'AGENT_NOT_FOUND')
    this.name = 'AgentNotFoundError'
    this.agentId = agentId
  }
}

/** Error thrown when session is not found */
export class SessionNotFoundError extends SessionError {
  constructor(sessionId: string) {
    super(`Session "${sessionId}" not found`, sessionId)
    this.name = 'SessionNotFoundError'
    ;(this as { code: string }).code = 'SESSION_NOT_FOUND'
  }
}

/** Error thrown when Claude API call fails */
export class ClaudeApiError extends AgentError {
  public readonly statusCode?: number
  public readonly apiMessage?: string

  constructor(message: string, statusCode?: number, apiMessage?: string) {
    super(message, 'CLAUDE_API_ERROR')
    this.name = 'ClaudeApiError'
    this.statusCode = statusCode
    this.apiMessage = apiMessage
  }
}

/** Error thrown when intent detection fails */
export class IntentDetectionError extends AgentError {
  public readonly rawResponse?: string

  constructor(message: string, rawResponse?: string) {
    super(message, 'INTENT_DETECTION_ERROR')
    this.name = 'IntentDetectionError'
    this.rawResponse = rawResponse
  }
}
```

**Create src/lib/agents/index.ts:**

```typescript
/**
 * Agent Engine Module
 * Phase 13: Agent Engine Core
 *
 * Public exports for the agent system.
 */

// Types
export * from './types'

// Errors
export * from './errors'
```
  </action>
  <verify>
TypeScript compilation:
```bash
cd /mnt/c/Users/Usuario/Proyectos/morfx-new && npx tsc --noEmit src/lib/agents/index.ts 2>&1 | head -20
```
Check exports:
```bash
grep -E "^export" src/lib/agents/index.ts
```
Verify type definitions exist:
```bash
grep -c "export interface\|export type\|export const" src/lib/agents/types.ts
```
Should return at least 15 exports.
  </verify>
  <done>
- types.ts has all agent types (AgentConfig, AgentSession, AgentTurn, SessionState, IntentResult, OrchestratorResult, ClaudeMessage)
- errors.ts has all error classes (VersionConflictError, SessionError, BudgetExceededError, AgentNotFoundError, ClaudeApiError)
- index.ts re-exports everything for clean imports
- TypeScript compiles without errors
  </done>
</task>

</tasks>

<verification>
After both tasks complete:

1. Migration file exists and has correct structure:
```bash
ls -la supabase/migrations/20260205_agent_sessions.sql
```

2. Types file has all required interfaces:
```bash
grep "export interface" src/lib/agents/types.ts
```

3. Errors file has all error classes:
```bash
grep "export class" src/lib/agents/errors.ts
```

4. TypeScript compiles:
```bash
cd /mnt/c/Users/Usuario/Proyectos/morfx-new && npx tsc --noEmit
```
</verification>

<success_criteria>
- Migration file creates agent_sessions, agent_turns, session_state tables with America/Bogota timezone
- All tables have RLS policies for workspace isolation
- agent_sessions has optimistic locking via version column
- TypeScript types match database schema exactly
- Error classes provide meaningful error handling for agent operations
- All files compile without TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/13-agent-engine-core/13-01-SUMMARY.md`
</output>
