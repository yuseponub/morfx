---
phase: 16.1-engine-unification
plan: 01
subsystem: api
tags: [typescript, interfaces, ports-adapters, hexagonal-architecture, dependency-injection]

# Dependency graph
requires:
  - phase: 13-agent-engine-core
    provides: SessionState, AgentSession, SessionManager types
  - phase: 15.7-ingest-timer-pluggable
    provides: TimerSignal type definition
provides:
  - 5 adapter interfaces (StorageAdapter, TimerAdapter, MessagingAdapter, OrdersAdapter, DebugAdapter)
  - EngineInput/EngineOutput unified types
  - EngineConfig per-environment configuration type
  - EngineAdapters bundle type
  - AgentSessionLike shared session shape
affects: [16.1-02 SomnioAgent, 16.1-03 Adapters, 16.1-04 UnifiedEngine, 16.1-05 Sandbox wiring, 16.1-06 Production wiring]

# Tech tracking
tech-stack:
  added: []
  patterns: [ports-adapters, constructor-injection, environment-agnostic-types]

key-files:
  created:
    - src/lib/agents/engine/types.ts
    - src/lib/agents/engine/index.ts
  modified: []

key-decisions:
  - "AgentSessionLike uses SessionState directly (not a simplified shape) for full compatibility with orchestrator"
  - "Debug-related fields use 'any' types to keep engine types environment-agnostic (adapters use specific types internally)"
  - "TimerAdapter.signal() is synchronous void (sandbox accumulates; production can fire-and-forget)"
  - "EngineOutput includes both sandbox fields (newState, debugTurn, timerSignal) and production fields (response, messagesSent, sessionId)"
  - "engine/ directory coexists with engine.ts (old AgentEngine) - bundler resolution prefers engine.ts for existing '../engine' imports"

patterns-established:
  - "Adapter interface pattern: JSDoc on each interface documents sandbox vs production behavior"
  - "Environment-agnostic typing: use 'any' for fields that differ across environments, let adapters enforce specific types"
  - "Barrel export in engine/index.ts: single import path for all engine types"

# Metrics
duration: 15min
completed: 2026-02-10
---

# Phase 16.1 Plan 01: Engine Type Foundation Summary

**5 adapter interfaces + unified engine I/O types for ports/adapters unification of SandboxEngine and SomnioEngine**

## Performance

- **Duration:** 15 min
- **Started:** 2026-02-10T16:37:19Z
- **Completed:** 2026-02-10T16:52:40Z
- **Tasks:** 2
- **Files created:** 2

## Accomplishments
- Defined all 5 adapter interfaces (StorageAdapter, TimerAdapter, MessagingAdapter, OrdersAdapter, DebugAdapter) with full method signatures
- Created EngineInput covering all fields from both SandboxEngine.processMessage and SomnioEngine.processMessage
- Created EngineOutput covering all fields from both SandboxEngineResult and SomnioEngineResult
- AgentSessionLike shared session shape compatible with both production AgentSessionWithState and sandbox mock session
- Barrel export enables clean imports from `@/lib/agents/engine`

## Task Commits

Each task was committed atomically:

1. **Task 1: Create adapter interfaces and engine types** - `f235c8b` (feat)
2. **Task 2: Create barrel export** - `2ce4668` (feat)

## Files Created/Modified
- `src/lib/agents/engine/types.ts` - All adapter interfaces, engine types, and shared state shapes (362 lines)
- `src/lib/agents/engine/index.ts` - Barrel re-exports for all 10 public types (20 lines)

## Decisions Made
- **AgentSessionLike uses SessionState directly:** Rather than creating a simplified `SessionStateLike`, we reuse the full `SessionState` type. The orchestrator already depends on `SessionState` fields like `intents_vistos`, `templates_enviados`, `datos_capturados`, etc. A simplified shape would just duplicate the same fields.
- **Debug fields use `any`:** DebugTurn, ToolExecution, IngestStatus are sandbox-specific types. Using `any` in the engine interface keeps types environment-agnostic. Each adapter implementation will use the specific types internally.
- **TimerAdapter.signal() is synchronous:** Sandbox accumulates signals synchronously. Production can wrap async Inngest calls internally. The interface is `void` not `Promise<void>` for simplicity.
- **engine/ directory coexists with engine.ts:** TypeScript bundler resolution picks `engine.ts` for `'../engine'` imports (existing code). New code imports from `'../engine/types'` or `'../engine/index'`. No conflict.

## Deviations from Plan

None - plan executed exactly as written.

## Issues Encountered

None.

## User Setup Required

None - no external service configuration required.

## Next Phase Readiness
- All 10 types compile without errors
- Plan 02 (SomnioAgent) can import StorageAdapter, TimerAdapter, EngineAdapters, etc. from `@/lib/agents/engine`
- Plan 03 (Adapters) can implement all 5 interfaces with well-documented method signatures
- Plan 04 (UnifiedEngine) can use EngineInput/EngineOutput as its public API
- No blockers for any downstream plan

---
*Phase: 16.1-engine-unification*
*Completed: 2026-02-10*
