---
phase: 15.5-somnio-ingest-system
plan: 02
type: execute
wave: 2
depends_on: ["15.5-01"]
files_modified:
  - src/lib/agents/somnio/ingest-manager.ts
  - src/inngest/functions/agent-timers.ts
  - src/inngest/events.ts
autonomous: true

must_haves:
  truths:
    - "IngestManager returns silent=true when classification is 'datos'"
    - "IngestManager returns silent=false and processes question when classification is 'pregunta'"
    - "IngestManager extracts data AND returns response when classification is 'mixto'"
    - "Timer starts on first data message with 6 min duration"
    - "Timer uses 10 min duration when no data was received"
  artifacts:
    - path: "src/lib/agents/somnio/ingest-manager.ts"
      provides: "Silent accumulation logic with classification routing"
      exports: ["IngestManager", "IngestResult", "IngestState"]
      min_lines: 120
    - path: "src/inngest/functions/agent-timers.ts"
      provides: "Ingest timer with dual timeout logic"
      contains: "ingestTimer"
    - path: "src/inngest/events.ts"
      provides: "Ingest event definitions"
      contains: "agent/ingest.started"
  key_links:
    - from: "ingest-manager.ts"
      to: "message-classifier.ts"
      via: "MessageClassifier.classify()"
      pattern: "classifier\\.classify"
    - from: "ingest-manager.ts"
      to: "data-extractor.ts"
      via: "DataExtractor.extract()"
      pattern: "dataExtractor\\.extract"
    - from: "agent-timers.ts"
      to: "ingest-manager.ts"
      via: "Inngest event emission"
      pattern: "agent/ingest\\.(started|completed)"
---

<objective>
Create IngestManager for silent data accumulation and update timer logic for ingest workflow

Purpose: Implement the core "silence on data, respond on question" behavior with proper timer management
Output: IngestManager class + updated Inngest timer with 6min/10min conditional timeout
</objective>

<execution_context>
@/home/jose147/.claude/get-shit-done/workflows/execute-plan.md
@/home/jose147/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/15.5-somnio-ingest-system/15.5-CONTEXT.md
@.planning/phases/15.5-somnio-ingest-system/15.5-RESEARCH.md
@.planning/phases/15.5-somnio-ingest-system/15.5-01-SUMMARY.md

# Existing code to modify/use
@src/inngest/functions/agent-timers.ts
@src/inngest/events.ts
@src/lib/agents/somnio/data-extractor.ts
@src/lib/agents/somnio/message-classifier.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create IngestManager with silent accumulation logic</name>
  <files>src/lib/agents/somnio/ingest-manager.ts</files>
  <action>
Create IngestManager class that coordinates classification, extraction, and silent accumulation:

1. Define types:
   ```typescript
   interface IngestState {
     active: boolean
     startedAt: string | null
     firstDataAt: string | null
     fieldsCollected: string[]
   }

   interface IngestResult {
     action: 'silent' | 'respond' | 'complete'
     classification: MessageClassification
     extractedData?: ExtractedData
     shouldEmitTimerStart?: boolean
     shouldEmitTimerComplete?: boolean
     timerDuration?: '6m' | '10m'
   }
   ```

2. Implement handleMessage() method:
   - Call MessageClassifier.classify() first
   - For 'datos': extract data, accumulate silently, return action='silent'
   - For 'pregunta': return action='respond' (caller handles response)
   - For 'mixto': extract data AND return action='respond'
   - For 'irrelevante': return action='silent' (no timer effect)

3. Timer coordination logic:
   - On first 'datos' when ingestState.firstDataAt is null:
     - Set shouldEmitTimerStart=true with timerDuration='6m'
   - When all 8 fields complete:
     - Set shouldEmitTimerComplete=true, action='complete'
   - Timer does NOT restart on additional data (CONTEXT.md rule)

4. Use existing components:
   - MessageClassifier (from Plan 01)
   - DataExtractor (existing)
   - hasCriticalData() from data-extractor.ts to check 8-field completion

Follow existing patterns. Use createModuleLogger('ingest-manager').
  </action>
  <verify>
TypeScript compiles: `cd /mnt/c/Users/Usuario/Proyectos/morfx-new && npx tsc --noEmit --skipLibCheck 2>&1 | grep -E "(error|ingest-manager)" || echo "No errors"`
  </verify>
  <done>
IngestManager exports handleMessage() that returns IngestResult with proper action and timer signals
  </done>
</task>

<task type="auto">
  <name>Task 2: Add ingest events to Inngest event definitions</name>
  <files>src/inngest/events.ts</files>
  <action>
Add ingest lifecycle events to the events file:

```typescript
// Add to existing event definitions

// Ingest events for Phase 15.5
'agent/ingest.started': {
  data: {
    sessionId: string
    conversationId: string
    workspaceId: string
    hasPartialData: boolean
    timerDurationMs: number // 360000 (6 min) or 600000 (10 min)
  }
}

'agent/ingest.completed': {
  data: {
    sessionId: string
    reason: 'all_fields' | 'timeout' | 'cancelled'
  }
}

'agent/ingest.data_received': {
  data: {
    sessionId: string
    fieldsExtracted: string[]
    totalFields: number
  }
}
```

These events allow timer cancellation when data collection completes.
  </action>
  <verify>
Check events: `cd /mnt/c/Users/Usuario/Proyectos/morfx-new && grep "ingest.started" src/inngest/events.ts`
  </verify>
  <done>
Ingest events defined in events.ts for timer lifecycle management
  </done>
</task>

<task type="auto">
  <name>Task 3: Create ingestTimer with dual timeout logic</name>
  <files>src/inngest/functions/agent-timers.ts</files>
  <action>
Add ingestTimer function to agent-timers.ts (alongside existing dataCollectionTimer):

```typescript
/**
 * Ingest Timer
 * Phase 15.5: Somnio Ingest System
 *
 * Triggered when first data is received in collecting_data mode.
 * Uses waitForEvent with conditional timeout (6 min partial / 10 min no data).
 *
 * Flow from CONTEXT.md:
 * - 6 min timeout if customer sent partial data
 * - 10 min timeout if no data was received
 * - On timeout: send appropriate message based on data status
 * - Timer cancelled if agent/ingest.completed received
 */
export const ingestTimer = inngest.createFunction(
  {
    id: 'ingest-timer',
    name: 'Ingest Timer',
    retries: 3,
  },
  { event: 'agent/ingest.started' },
  async ({ event, step }) => {
    const { sessionId, conversationId, workspaceId, hasPartialData, timerDurationMs } = event.data

    logger.info({ sessionId, hasPartialData, timerDurationMs }, 'Ingest timer started')

    // Wait for completion event OR timeout
    const completionEvent = await step.waitForEvent('wait-for-completion', {
      event: 'agent/ingest.completed',
      timeout: `${timerDurationMs}ms`,
      match: 'data.sessionId',
    })

    if (completionEvent) {
      // Data collection completed normally
      logger.info({ sessionId, reason: completionEvent.data.reason }, 'Ingest completed')
      return { status: 'completed', reason: completionEvent.data.reason }
    }

    // Timeout expired - send appropriate message
    await step.run('handle-ingest-timeout', async () => {
      const sessionManager = getSessionManager()
      const session = await sessionManager.getSession(sessionId)
      const datos = session.state.datos_capturados

      const message = buildTimeoutMessage(datos, hasPartialData)

      await executeToolFromAgent(
        'whatsapp.message.send',
        { contactId: conversationId, message },
        workspaceId,
        sessionId
      )
    })

    return { status: 'timeout', hadData: hasPartialData }
  }
)
```

Add buildTimeoutMessage helper (from CONTEXT.md):
```typescript
function buildTimeoutMessage(
  datosCapturados: Record<string, string>,
  hasPartialData: boolean
): string {
  if (!hasPartialData) {
    return 'Quedamos pendientes a tus datos, o si tienes alguna pregunta acerca del producto no dudes en hacerla'
  }

  const criticalFields = ['nombre', 'telefono', 'direccion', 'ciudad', 'departamento']
  const fieldLabels: Record<string, string> = {
    nombre: 'Tu nombre completo',
    telefono: 'Numero de telefono',
    direccion: 'Direccion de entrega',
    ciudad: 'Ciudad',
    departamento: 'Departamento',
  }

  const missing = criticalFields
    .filter(f => !datosCapturados[f] || datosCapturados[f] === 'N/A')
    .map(f => `- ${fieldLabels[f]}`)

  return `Para poder despachar tu producto nos faltaria:\n${missing.join('\n')}\nQuedamos pendientes`
}
```

Add ingestTimer to agentTimerFunctions export array.
  </action>
  <verify>
Check function exists: `cd /mnt/c/Users/Usuario/Proyectos/morfx-new && grep -c "ingestTimer" src/inngest/functions/agent-timers.ts`
  </verify>
  <done>
ingestTimer function added with dual timeout logic (6min/10min) and proper timeout messages
  </done>
</task>

</tasks>

<verification>
1. IngestManager file exists: `ls src/lib/agents/somnio/ingest-manager.ts`
2. Ingest events defined: `grep "ingest.started" src/inngest/events.ts`
3. Timer function added: `grep "ingestTimer" src/inngest/functions/agent-timers.ts`
4. TypeScript compiles without errors
</verification>

<success_criteria>
- IngestManager handles all 4 classification types with correct action
- 'datos' returns silent action and extracts data
- 'pregunta' returns respond action
- 'mixto' extracts data AND returns respond action
- Timer signals emitted correctly (start on first data, complete on 8 fields)
- ingestTimer uses 6min for partial data, 10min for no data
- Timeout messages match CONTEXT.md format exactly
</success_criteria>

<output>
After completion, create `.planning/phases/15.5-somnio-ingest-system/15.5-02-SUMMARY.md`
</output>
