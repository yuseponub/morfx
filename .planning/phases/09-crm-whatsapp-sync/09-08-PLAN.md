---
phase: 09-crm-whatsapp-sync
plan: 08
type: execute
wave: 5
depends_on: ["09-06", "09-07"]
files_modified:
  - src/app/(dashboard)/crm/contactos/components/tag-manager.tsx
  - src/app/actions/tags.ts
autonomous: false

must_haves:
  truths:
    - "Tag manager shows applies_to field for scope selection"
    - "Users can set tag scope when creating/editing tags"
    - "Scope filter works correctly"
  artifacts:
    - path: "src/app/(dashboard)/crm/contactos/components/tag-manager.tsx"
      provides: "Tag manager with scope selection"
      contains: "applies_to"
  key_links:
    - from: "TagManager"
      to: "createTag/updateTag"
      via: "form submission with applies_to"
      pattern: "applies_to"
---

<objective>
Add tag scope selection to the tag manager UI and verify full integration.

Purpose: This final plan adds the UI for setting tag scope when creating/editing tags, and provides a checkpoint to verify the complete CRM-WhatsApp sync functionality works end-to-end.

Output: Updated tag manager with scope selection, full phase verification.
</objective>

<execution_context>
@/home/jose147/.claude/get-shit-done/workflows/execute-plan.md
@/home/jose147/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-crm-whatsapp-sync/09-CONTEXT.md
@.planning/phases/09-crm-whatsapp-sync/09-RESEARCH.md
@.planning/phases/09-crm-whatsapp-sync/09-06-SUMMARY.md
@.planning/phases/09-crm-whatsapp-sync/09-07-SUMMARY.md

# Tag manager
@src/app/(dashboard)/crm/contactos/components/tag-manager.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update TagManager with scope selection</name>
  <files>src/app/(dashboard)/crm/contactos/components/tag-manager.tsx</files>
  <action>
Update the TagManager component to include a scope selection field when creating or editing tags.

Add the scope selection using a Select component:

1. Import Select components if not already present:
```typescript
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from '@/components/ui/select'
```

2. Find the form for creating/editing tags and add the scope field.

The scope options are:
- 'both' - "Todos" (default) - Can be used on conversations and orders
- 'whatsapp' - "Solo WhatsApp" - Only on conversations
- 'orders' - "Solo Pedidos" - Only on orders

Add the Select after the color picker or before the submit button:

```tsx
{/* Tag scope selection */}
<div className="space-y-2">
  <Label htmlFor="applies_to">Aplicar a</Label>
  <Select
    name="applies_to"
    defaultValue={editingTag?.applies_to || 'both'}
  >
    <SelectTrigger>
      <SelectValue placeholder="Seleccionar ambito" />
    </SelectTrigger>
    <SelectContent>
      <SelectItem value="both">
        <div className="flex items-center gap-2">
          <span>Todos</span>
          <span className="text-xs text-muted-foreground">(WhatsApp y Pedidos)</span>
        </div>
      </SelectItem>
      <SelectItem value="whatsapp">
        <div className="flex items-center gap-2">
          <span>Solo WhatsApp</span>
          <span className="text-xs text-muted-foreground">(Conversaciones)</span>
        </div>
      </SelectItem>
      <SelectItem value="orders">
        <div className="flex items-center gap-2">
          <span>Solo Pedidos</span>
          <span className="text-xs text-muted-foreground">(CRM)</span>
        </div>
      </SelectItem>
    </SelectContent>
  </Select>
  <p className="text-xs text-muted-foreground">
    Define donde se puede usar esta etiqueta
  </p>
</div>
```

3. Ensure the form submission includes applies_to in the FormData. The Select with name="applies_to" should automatically be included.

4. If the tag manager shows a list of tags, optionally add a visual indicator for the scope:

```tsx
{/* In tag list item */}
{tag.applies_to !== 'both' && (
  <span className="text-xs text-muted-foreground ml-2">
    ({tag.applies_to === 'whatsapp' ? 'WhatsApp' : 'Pedidos'})
  </span>
)}
```

5. If using controlled form state, add state for applies_to:
```typescript
const [appliesTo, setAppliesTo] = useState<'whatsapp' | 'orders' | 'both'>('both')
```

And in edit mode, populate from existing tag:
```typescript
useEffect(() => {
  if (editingTag) {
    setAppliesTo(editingTag.applies_to || 'both')
  }
}, [editingTag])
```
  </action>
  <verify>
```bash
cd /mnt/c/Users/Usuario/Proyectos/morfx-new && npx tsc --noEmit src/app/\\(dashboard\\)/crm/contactos/components/tag-manager.tsx
```
  </verify>
  <done>
TagManager has scope selection field for applies_to when creating/editing tags.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete CRM-WhatsApp sync functionality:
1. Database schema: conversation_tags table, tags.applies_to column, auto-tag trigger
2. Server Actions: conversation tag CRUD, tag scope filtering
3. WhatsApp UI: order status indicators, conversation tag management, dual tag display
4. CRM UI: WhatsApp section in contact detail, tag scope selection
5. Realtime sync: subscriptions for conversation_tags and contact_tags
  </what-built>
  <how-to-verify>
**Test 1: Tag Scope**
1. Go to /crm/contactos and open the tag manager
2. Create a new tag with scope "Solo WhatsApp"
3. Create another tag with scope "Solo Pedidos"
4. Go to WhatsApp, select a conversation, try to add tags
5. Verify: "Solo Pedidos" tag should NOT appear in the list
6. Go to Orders/Pedidos, try to add tags to an order
7. Verify: "Solo WhatsApp" tag should NOT appear in the list

**Test 2: Conversation Tags**
1. Go to WhatsApp, select a conversation with a linked contact
2. Add a tag to the conversation from the chat header
3. Verify: Tag appears immediately in the conversation list
4. Go to CRM > Contacts > [same contact]
5. Verify: WhatsApp section shows the conversation with the tag

**Test 3: Contact Tags in WhatsApp**
1. In CRM, add a tag directly to a contact
2. Go to WhatsApp, find the conversation for that contact
3. Verify: Contact tags appear with "opacity" or "inherited" visual distinction
4. Verify: Tags in contact panel show "Etiquetas de contacto" section

**Test 4: Order Status Indicators**
1. Create an order for a contact that has a WhatsApp conversation
2. Set the order stage to "Nuevo" or similar pending stage
3. Go to WhatsApp conversation list
4. Verify: Hourglass emoji indicator appears next to the conversation
5. Change the order stage to "Despachado" (transit)
6. Verify: Truck emoji indicator appears

**Test 5: Auto-Tag on Ganado**
1. Create a "Cliente" tag in the workspace if not exists
2. Create an order for a contact, move it through stages to "Ganado"
3. Go to the contact in CRM
4. Verify: "Cliente" tag was automatically added to the contact

**Test 6: Realtime Sync**
1. Open WhatsApp in one browser tab
2. Open CRM contact detail in another tab
3. Add a tag to the conversation in WhatsApp
4. Check CRM tab (without refreshing manually)
5. Verify: Tag should appear in WhatsApp section after a moment

Report:
- Which tests passed
- Any issues found
- Screenshots if helpful
  </how-to-verify>
  <resume-signal>Type "approved" if all tests pass, or describe issues found</resume-signal>
</task>

</tasks>

<verification>
1. All TypeScript compiles without errors
2. Tag scope selection works in tag manager
3. All 6 functional tests pass
</verification>

<success_criteria>
Phase 9 success criteria (from ROADMAP.md):
1. When a tag is added to a contact in CRM, it appears in their WhatsApp conversation - VERIFIED
2. When a tag is added to a conversation in WhatsApp, it appears on the contact in CRM - VERIFIED
3. When an order state changes in CRM, it reflects in the linked WhatsApp conversation - VERIFIED
4. Contact, order, and conversation data remain consistent across modules - VERIFIED
</success_criteria>

<output>
After completion, create `.planning/phases/09-crm-whatsapp-sync/09-08-SUMMARY.md`
</output>
