---
phase: 15.6-sandbox-evolution
plan: 05
subsystem: ui, agents
tags: [sandbox, crm, popover, dry-run, live-mode, action-dsl, executeToolFromAgent]

# Dependency graph
requires:
  - phase: 15.6-01
    provides: "Enhanced sandbox types (ModelTokenEntry, IngestTimeline, DebugPanelTab)"
  - phase: 15.6-02
    provides: "Multi-panel debug infrastructure (PanelContainer, TabBar)"
  - phase: 15.6-03
    provides: "CRM agent system (OrderManagerAgent, CrmOrchestrator, crmAgentRegistry)"
provides:
  - "CRM agent multi-select dropdown in sandbox header"
  - "DRY/LIVE mode badges in tools tab"
  - "CRM orchestrator integration in SandboxEngine"
  - "OrderManagerAgent.executeLive with real Action DSL tools"
  - "API route for CRM agent listing"
affects: ["15.6-06-end-to-end-verification"]

# Tech tracking
tech-stack:
  added: []
  patterns:
    - "CRM agent state management via useEffect + API fetch on mount"
    - "Mode-annotated ToolExecution (mode?: 'dry-run' | 'live') for visual differentiation"
    - "CRM orchestrator routing in SandboxEngine conditional on crmModes parameter"

key-files:
  created:
    - "src/app/api/sandbox/crm-agents/route.ts"
  modified:
    - "src/app/(dashboard)/sandbox/components/sandbox-header.tsx"
    - "src/app/(dashboard)/sandbox/components/sandbox-layout.tsx"
    - "src/app/(dashboard)/sandbox/components/debug-panel/tools-tab.tsx"
    - "src/app/(dashboard)/sandbox/components/debug-panel/index.ts"
    - "src/lib/sandbox/sandbox-engine.ts"
    - "src/lib/sandbox/types.ts"
    - "src/app/api/sandbox/process/route.ts"
    - "src/lib/agents/crm/order-manager/agent.ts"

key-decisions:
  - "CRM agents loaded via /api/sandbox/crm-agents route on mount, not hardcoded"
  - "CRM agent state reset to disabled+dry-run on session reset"
  - "Live mode uses executeToolFromAgent with workspace='sandbox' and session='sandbox-session'"
  - "CRM tool calls annotated with mode field for visual DRY/LIVE distinction"
  - "ToolExecution.mode is optional - no badge shown for non-CRM tools"
  - "CRM orchestrator only invoked when shouldCreateOrder=true AND order-manager is in crmModes"

patterns-established:
  - "CRM state management: parent layout manages state, passes to header via props"
  - "Mode-annotated tools: ToolExecution.mode for visual debug differentiation"
  - "Conditional CRM routing: SandboxEngine checks crmModes before calling orchestrator"

# Metrics
duration: 18min
completed: 2026-02-07
---

# Phase 15.6 Plan 05: CRM Sandbox Integration Summary

**CRM agent multi-select in sandbox header with DRY/LIVE toggle, CRM orchestrator integration in SandboxEngine, and live Action DSL tool execution in OrderManagerAgent**

## Performance

- **Duration:** 18 min
- **Started:** 2026-02-07T21:37:26Z
- **Completed:** 2026-02-07T21:55:31Z
- **Tasks:** 4
- **Files modified:** 9

## Accomplishments
- CRM agent multi-select dropdown in sandbox header with checkbox enable/disable and DRY/LIVE switch per agent
- SandboxEngine routes to CRM orchestrator when shouldCreateOrder AND CRM agents enabled
- Tools tab shows DRY/LIVE badges with mode summary counts
- OrderManagerAgent.executeLive uses real executeToolFromAgent (crm.contact.create, crm.contact.tag, crm.order.create) with test- prefix
- Existing Somnio flow unchanged when no CRM agents are selected

## Task Commits

Each task was committed atomically:

1. **Task 1: Add CRM agent multi-select dropdown to sandbox header** - `f0891e2` (feat)
2. **Task 2: Wire CRM agents into sandbox-layout and sandbox-engine** - `31bf2c6` (feat)
3. **Task 3: Enhance Tools tab for dry-run visibility with mode badges** - `7fd1dbd` (feat)
4. **Task 4: Wire OrderManagerAgent.executeLive to real Action DSL tools** - `bccd081` (feat)

## Files Created/Modified
- `src/app/(dashboard)/sandbox/components/sandbox-header.tsx` - CRM agent Popover with checkbox + switch per agent
- `src/app/(dashboard)/sandbox/components/sandbox-layout.tsx` - CRM agent state management, handlers, API integration
- `src/app/(dashboard)/sandbox/components/debug-panel/tools-tab.tsx` - DRY/LIVE badges with mode summary
- `src/app/(dashboard)/sandbox/components/debug-panel/index.ts` - Added IngestTab export
- `src/lib/sandbox/sandbox-engine.ts` - CRM orchestrator routing on shouldCreateOrder
- `src/lib/sandbox/types.ts` - ToolExecution.mode optional field
- `src/app/api/sandbox/process/route.ts` - CRM agent import + pass crmAgents to engine
- `src/app/api/sandbox/crm-agents/route.ts` - New: lists available CRM agents from registry
- `src/lib/agents/crm/order-manager/agent.ts` - Real executeToolFromAgent in executeLive

## Decisions Made
- CRM agents fetched via API route on mount (dynamic from registry, not hardcoded list)
- Session reset also resets CRM agents to disabled + dry-run
- Live mode uses workspace='sandbox' for all executeToolFromAgent calls
- ToolExecution.mode is optional - non-CRM tools gracefully show no badge
- CRM orchestrator only invoked when both shouldCreateOrder is true and order-manager is found in crmModes

## Deviations from Plan

### Auto-fixed Issues

**1. [Rule 3 - Blocking] Created /api/sandbox/crm-agents route**
- **Found during:** Task 2 (sandbox-layout CRM agent initialization)
- **Issue:** Plan specified loading from registry via listAgents() in client code, but crmAgentRegistry is server-only (uses module state). Client needs an API route.
- **Fix:** Created /api/sandbox/crm-agents/route.ts that returns CrmAgentState[] from the registry
- **Files modified:** src/app/api/sandbox/crm-agents/route.ts (created)
- **Verification:** TypeScript compiles, layout fetches agents on mount
- **Committed in:** 31bf2c6 (Task 2 commit)

---

**Total deviations:** 1 auto-fixed (1 blocking)
**Impact on plan:** Necessary for correct client-server boundary. No scope creep.

## Issues Encountered
- Write tool had intermittent persistence issues on WSL2 filesystem. Resolved by using bash heredocs for file writes instead.

## User Setup Required
None - no external service configuration required.

## Next Phase Readiness
- All CRM agent wiring complete: header dropdown, engine integration, live tools, debug visibility
- Ready for Plan 06: End-to-end verification
- Success criteria 1 (Tools tab), 2 (Toggle), and 3 (Agentes separados) dependencies satisfied

---
*Phase: 15.6-sandbox-evolution*
*Completed: 2026-02-07*
