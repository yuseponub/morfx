---
phase: 20-integration-automations
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/automations/constants.ts
  - src/lib/automations/types.ts
  - src/lib/twilio/client.ts
  - src/lib/twilio/types.ts
  - src/lib/shopify/types.ts
  - supabase/migrations/20260216_sms_messages.sql
autonomous: true

must_haves:
  truths:
    - "ActionType union includes send_sms"
    - "TriggerType union includes 3 Shopify trigger types"
    - "ACTION_CATALOG has send_sms entry with body, to, mediaUrl params"
    - "TRIGGER_CATALOG has 3 Shopify entries with category Shopify"
    - "VARIABLE_CATALOG has entries for all 3 Shopify trigger types"
    - "Twilio client factory creates per-workspace clients from integrations table"
    - "sms_messages migration SQL exists and is valid"
  artifacts:
    - path: "src/lib/automations/constants.ts"
      provides: "Updated catalogs with +3 triggers, +1 action, +3 variable sets"
      contains: "send_sms"
    - path: "src/lib/automations/types.ts"
      provides: "Extended TriggerType and ActionType unions"
      contains: "shopify.order_created"
    - path: "src/lib/twilio/client.ts"
      provides: "Twilio client factory with per-workspace credentials"
      exports: ["createTwilioClient", "getTwilioConfig"]
    - path: "src/lib/twilio/types.ts"
      provides: "TwilioConfig, SmsMessage, SmsStatus types"
      exports: ["TwilioConfig", "SmsMessage"]
    - path: "src/lib/shopify/types.ts"
      provides: "ShopifyDraftOrderWebhook type + ShopifyConfig.auto_sync_orders field"
      contains: "ShopifyDraftOrderWebhook"
    - path: "supabase/migrations/20260216_sms_messages.sql"
      provides: "sms_messages table migration"
      contains: "CREATE TABLE sms_messages"
  key_links:
    - from: "src/lib/twilio/client.ts"
      to: "integrations table"
      via: "createAdminClient query for type=twilio"
      pattern: "eq.*type.*twilio"
    - from: "src/lib/automations/constants.ts"
      to: "src/lib/builder/system-prompt.ts"
      via: "system-prompt reads TRIGGER_CATALOG + ACTION_CATALOG programmatically"
      pattern: "TRIGGER_CATALOG|ACTION_CATALOG"
---

<objective>
Foundation: types, constants, Twilio client module, and database migration for Phase 20.

Purpose: Establish all shared type definitions, catalog entries, and the Twilio client module that all subsequent plans depend on. After this plan, the automations engine "knows" about send_sms and Shopify triggers at the type level, and the Twilio SDK wrapper exists for use by the action executor.

Output: Updated constants.ts/types.ts with 3 new triggers + 1 new action, Twilio client module, Shopify draft order type, sms_messages migration.
</objective>

<execution_context>
@/home/jose147/.claude/get-shit-done/workflows/execute-plan.md
@/home/jose147/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/20-integration-automations/20-CONTEXT.md
@.planning/phases/20-integration-automations/20-RESEARCH.md
@src/lib/automations/constants.ts
@src/lib/automations/types.ts
@src/lib/shopify/types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend automations type system and catalogs</name>
  <files>src/lib/automations/constants.ts, src/lib/automations/types.ts</files>
  <action>
1. In `types.ts`, add 3 Shopify trigger types to TriggerType union:
   - `'shopify.order_created'`
   - `'shopify.draft_order_created'`
   - `'shopify.order_updated'`

2. In `types.ts`, add `'send_sms'` to ActionType union.

3. In `constants.ts`, add 3 entries to TRIGGER_CATALOG (BEFORE the `] as const` closing):
   - `shopify.order_created`: label "Orden de Shopify creada", category "Shopify", description "Se dispara cuando llega una orden nueva desde Shopify", configFields: [] (no required filters), variables: ['shopify.order_number', 'shopify.total', 'shopify.financial_status', 'shopify.email', 'shopify.phone', 'shopify.note', 'shopify.productos', 'shopify.direccion_envio', 'shopify.tags', 'contacto.nombre', 'contacto.telefono']
   - `shopify.draft_order_created`: label "Borrador de Shopify creado", category "Shopify", description "Se dispara cuando se crea un borrador de orden en Shopify", configFields: [], variables: ['shopify.order_number', 'shopify.total', 'shopify.status', 'shopify.email', 'shopify.phone', 'shopify.note', 'shopify.productos', 'shopify.direccion_envio', 'contacto.nombre', 'contacto.telefono']
   - `shopify.order_updated`: label "Orden de Shopify actualizada", category "Shopify", description "Se dispara cuando una orden existente de Shopify se actualiza", configFields: [], variables: ['shopify.order_number', 'shopify.total', 'shopify.financial_status', 'shopify.fulfillment_status', 'shopify.email', 'shopify.phone', 'shopify.note', 'shopify.productos', 'shopify.direccion_envio', 'shopify.tags', 'contacto.nombre', 'contacto.telefono']

4. In `constants.ts`, add 1 entry to ACTION_CATALOG:
   - `send_sms`: label "Enviar SMS", category "Twilio", description "Envia un mensaje SMS al contacto via Twilio", params: [{ name: 'body', label: 'Mensaje', type: 'textarea', required: true, supportsVariables: true }, { name: 'to', label: 'Telefono destino (opcional)', type: 'text', required: false, supportsVariables: true }, { name: 'mediaUrl', label: 'URL de media (MMS)', type: 'text', required: false }]

5. In `constants.ts`, add 3 entries to VARIABLE_CATALOG:
   - `'shopify.order_created'`: variables for order_number, total, financial_status, email, phone, note, productos, direccion_envio, tags + contacto.nombre, contacto.telefono
   - `'shopify.draft_order_created'`: variables for order_number, total, status, email, phone, note, productos, direccion_envio + contacto.nombre, contacto.telefono
   - `'shopify.order_updated'`: variables for order_number, total, financial_status, fulfillment_status, email, phone, note, productos, direccion_envio, tags + contacto.nombre, contacto.telefono

IMPORTANT: constants.ts must maintain ZERO imports from other project files (prevents circular deps). This is an established pattern.
  </action>
  <verify>Run `npx tsc --noEmit 2>&1 | head -30` -- no new type errors related to TriggerType/ActionType exhaustive checks (exhaustive switch errors are EXPECTED since we haven't added handlers yet -- those are fixed in Plans 02/03).</verify>
  <done>TriggerType has 13 values (10 existing + 3 Shopify), ActionType has 12 values (11 existing + send_sms), TRIGGER_CATALOG has 13 entries, ACTION_CATALOG has 12 entries, VARIABLE_CATALOG has 13 keys.</done>
</task>

<task type="auto">
  <name>Task 2: Create Twilio client module, Shopify draft type, and DB migration</name>
  <files>src/lib/twilio/client.ts, src/lib/twilio/types.ts, src/lib/shopify/types.ts, supabase/migrations/20260216_sms_messages.sql</files>
  <action>
1. Create `src/lib/twilio/types.ts`:
   ```typescript
   export interface TwilioConfig {
     account_sid: string
     auth_token: string
     phone_number: string  // E.164 format e.g. +15017122661
   }

   export interface SmsMessage {
     id: string
     workspace_id: string
     twilio_sid: string
     from_number: string
     to_number: string
     body: string
     direction: 'outbound' | 'inbound'
     status: SmsStatus
     price: number | null
     price_unit: string
     segments: number
     media_url: string | null
     automation_execution_id: string | null
     error_code: string | null
     error_message: string | null
     created_at: string
   }

   export type SmsStatus = 'queued' | 'sending' | 'sent' | 'delivered' | 'failed' | 'undelivered'
   ```

2. Create `src/lib/twilio/client.ts`:
   - Import `createAdminClient` from `@/lib/supabase/admin`
   - Import `TwilioConfig` from `./types`
   - `getTwilioConfig(workspaceId: string): Promise<TwilioConfig>` -- queries integrations table for type='twilio', is_active=true, workspace_id filter, returns typed config. Throws error "Twilio no configurado en este workspace" if not found.
   - `createTwilioClient(config: TwilioConfig)` -- uses `require('twilio')` to create client from config.account_sid and config.auth_token. Returns the Twilio client instance.
   - Note: Use `require('twilio')` (not import) because twilio package doesn't have ESM default export. Type the return as `any` to avoid the dependency on @types/twilio.

3. Update `src/lib/shopify/types.ts`:
   - Add `ShopifyDraftOrderWebhook` interface that shares most fields with `ShopifyOrderWebhook` but:
     - Has `status` field (string) instead of relying on `financial_status` (draft orders use 'open', 'invoice_sent', 'completed')
     - Has optional `invoice_url` field (string | null)
     - `fulfillment_status` is always null for drafts
     - line_items structure is the same
   - Add `auto_sync_orders?: boolean` field to `ShopifyConfig` interface (defaults to true when undefined for backward compatibility)

4. Create `supabase/migrations/20260216_sms_messages.sql`:
   ```sql
   -- Phase 20: SMS Messages tracking table for Twilio integration
   CREATE TABLE IF NOT EXISTS sms_messages (
     id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
     workspace_id UUID NOT NULL REFERENCES workspaces(id) ON DELETE CASCADE,
     twilio_sid TEXT NOT NULL UNIQUE,
     from_number TEXT NOT NULL,
     to_number TEXT NOT NULL,
     body TEXT NOT NULL,
     direction TEXT NOT NULL DEFAULT 'outbound',
     status TEXT NOT NULL,
     price DECIMAL(10, 6),
     price_unit TEXT DEFAULT 'USD',
     segments INTEGER DEFAULT 1,
     media_url TEXT,
     automation_execution_id UUID REFERENCES automation_executions(id) ON DELETE SET NULL,
     error_code TEXT,
     error_message TEXT,
     created_at TIMESTAMPTZ NOT NULL DEFAULT timezone('America/Bogota', NOW())
   );

   -- Index for workspace queries
   CREATE INDEX idx_sms_messages_workspace ON sms_messages(workspace_id, created_at DESC);

   -- Index for status callback lookup
   CREATE INDEX idx_sms_messages_twilio_sid ON sms_messages(twilio_sid);

   -- RLS policies
   ALTER TABLE sms_messages ENABLE ROW LEVEL SECURITY;

   -- Workspace members can read SMS messages
   CREATE POLICY sms_messages_select ON sms_messages
     FOR SELECT TO authenticated
     USING (workspace_id IN (
       SELECT workspace_id FROM workspace_members WHERE user_id = auth.uid()
     ));

   -- System inserts only (from automation executor / status callback)
   -- No user insert/update/delete policies needed
   ```

5. Install twilio npm package: `npm install twilio`
  </action>
  <verify>Run `npm install twilio && npx tsc --noEmit 2>&1 | grep -c "error TS"` -- twilio installs and the only TS errors should be exhaustive switch errors in action-executor.ts and automation-runner.ts (expected, fixed in Plans 02/03). Verify files exist: `ls src/lib/twilio/client.ts src/lib/twilio/types.ts supabase/migrations/20260216_sms_messages.sql`</verify>
  <done>Twilio client module exists with getTwilioConfig and createTwilioClient functions. ShopifyDraftOrderWebhook type exists. ShopifyConfig has auto_sync_orders field. sms_messages migration SQL is valid. twilio npm package installed.</done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` shows only expected exhaustive-switch errors for send_sms and shopify triggers (not yet handled in executor/runner)
- `ls src/lib/twilio/` shows client.ts and types.ts
- `grep 'send_sms' src/lib/automations/constants.ts` finds the ACTION_CATALOG entry
- `grep 'shopify.order_created' src/lib/automations/constants.ts` finds the TRIGGER_CATALOG entry
- `grep 'shopify.order_created' src/lib/automations/types.ts` finds the TriggerType entry
- `grep 'ShopifyDraftOrderWebhook' src/lib/shopify/types.ts` finds the new type
- `grep 'auto_sync_orders' src/lib/shopify/types.ts` finds the new config field
</verification>

<success_criteria>
- TriggerType has 13 members, ActionType has 12 members
- TRIGGER_CATALOG has 13 entries (10 + 3 Shopify)
- ACTION_CATALOG has 12 entries (11 + send_sms)
- VARIABLE_CATALOG has 13 keys (10 + 3 Shopify)
- Twilio client module can load config and create SDK client
- ShopifyDraftOrderWebhook type defined
- ShopifyConfig.auto_sync_orders field added
- sms_messages table migration ready
- twilio npm package installed
</success_criteria>

<output>
After completion, create `.planning/phases/20-integration-automations/20-01-SUMMARY.md`
</output>
