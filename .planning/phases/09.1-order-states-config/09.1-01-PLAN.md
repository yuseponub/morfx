---
phase: 09.1-order-states-config
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/20260203000002_order_states.sql
  - src/lib/orders/types.ts
  - src/app/actions/order-states.ts
autonomous: true

must_haves:
  truths:
    - "order_states table exists with workspace_id, name, emoji, position columns"
    - "pipeline_stages has order_state_id FK with ON DELETE SET NULL"
    - "OrderState type is exported from types.ts"
    - "Server Actions can create, read, update, delete, and reorder order states"
    - "Server Actions can assign/unassign stages to states"
  artifacts:
    - path: "supabase/migrations/20260203000002_order_states.sql"
      provides: "order_states table, FK on pipeline_stages, RLS policies"
      contains: "CREATE TABLE order_states"
    - path: "src/lib/orders/types.ts"
      provides: "OrderState type definition"
      contains: "export interface OrderState"
    - path: "src/app/actions/order-states.ts"
      provides: "CRUD + reorder + stage assignment Server Actions"
      exports: ["getOrderStates", "createOrderState", "updateOrderState", "deleteOrderState", "updateOrderStateOrder", "assignStagesToState"]
  key_links:
    - from: "src/app/actions/order-states.ts"
      to: "supabase.order_states"
      via: "Supabase client queries"
      pattern: "from\\('order_states'\\)"
    - from: "src/app/actions/order-states.ts"
      to: "supabase.pipeline_stages"
      via: "FK update for stage assignment"
      pattern: "from\\('pipeline_stages'\\)"
---

<objective>
Create database foundation and Server Actions for configurable order states.

Purpose: Replace the hardcoded stage-phases.ts mapping with a database-driven order_states table. Each order state has a name, emoji, and position. Pipeline stages can be assigned to states via a foreign key.

Output:
- Migration creating order_states table with RLS
- FK order_state_id added to pipeline_stages
- OrderState type in lib/orders/types.ts
- Server Actions for CRUD, reorder, and stage assignment
</objective>

<execution_context>
@/home/jose147/.claude/get-shit-done/workflows/execute-plan.md
@/home/jose147/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/09.1-order-states-config/09.1-CONTEXT.md
@.planning/phases/09.1-order-states-config/09.1-RESEARCH.md

# Existing patterns to follow
@src/app/actions/pipelines.ts
@src/lib/orders/types.ts
@supabase/migrations/20260129000003_orders_foundation.sql
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create order_states migration</name>
  <files>supabase/migrations/20260203000002_order_states.sql</files>
  <action>
Create migration file with:

1. order_states table:
```sql
CREATE TABLE order_states (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  workspace_id UUID NOT NULL REFERENCES workspaces(id) ON DELETE CASCADE,
  name TEXT NOT NULL,
  emoji TEXT NOT NULL,
  position INTEGER NOT NULL DEFAULT 0,
  created_at TIMESTAMPTZ NOT NULL DEFAULT timezone('America/Bogota', NOW()),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT timezone('America/Bogota', NOW()),
  UNIQUE(workspace_id, position)
);
```

2. Indexes:
- idx_order_states_workspace on workspace_id
- idx_order_states_position on (workspace_id, position)

3. Add FK to pipeline_stages:
```sql
ALTER TABLE pipeline_stages
ADD COLUMN order_state_id UUID REFERENCES order_states(id) ON DELETE SET NULL;

CREATE INDEX idx_stages_order_state ON pipeline_stages(order_state_id);
```

4. RLS policies (same pattern as pipelines):
- Enable RLS
- SELECT: workspace members can read
- INSERT/UPDATE/DELETE: workspace admins only (is_workspace_manager function)

5. updated_at trigger (copy pattern from pipelines)

Use existing migration patterns from 20260129000003_orders_foundation.sql.
  </action>
  <verify>
Migration file exists and contains:
- CREATE TABLE order_states
- ALTER TABLE pipeline_stages ADD COLUMN order_state_id
- RLS policies enabled
- Indexes created
  </verify>
  <done>
order_states table schema is defined with proper RLS, FK on pipeline_stages with ON DELETE SET NULL, indexes created.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add OrderState type and update PipelineStage type</name>
  <files>src/lib/orders/types.ts</files>
  <action>
Add to existing types.ts file:

1. OrderState interface:
```typescript
export interface OrderState {
  id: string
  workspace_id: string
  name: string
  emoji: string
  position: number
  created_at: string
  updated_at: string
}
```

2. OrderStateFormData type:
```typescript
export interface OrderStateFormData {
  name: string
  emoji: string
}
```

3. Update PipelineStage interface to include order_state_id:
```typescript
// Add to existing PipelineStage interface:
order_state_id?: string | null
```

4. Add OrderStateWithStages type for display in UI:
```typescript
export interface OrderStateWithStages extends OrderState {
  stages: Pick<PipelineStage, 'id' | 'name' | 'color' | 'pipeline_id'>[]
}
```

Place new types after existing Pipeline types section.
  </action>
  <verify>
grep for "OrderState" in src/lib/orders/types.ts returns the interface definition.
grep for "order_state_id" in PipelineStage interface exists.
  </verify>
  <done>
OrderState, OrderStateFormData, and OrderStateWithStages types exported. PipelineStage includes order_state_id field.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create order-states Server Actions</name>
  <files>src/app/actions/order-states.ts</files>
  <action>
Create new Server Actions file following pipelines.ts patterns:

1. 'use server' directive at top

2. Imports:
- createClient from @/lib/supabase/server
- revalidatePath from next/cache
- cookies from next/headers
- z from zod
- Types from @/lib/orders/types

3. Validation schema:
```typescript
const orderStateSchema = z.object({
  name: z.string().min(1, 'Nombre es requerido').max(50),
  emoji: z.string().min(1, 'Emoji es requerido'),
})
```

4. ActionResult type (copy from pipelines.ts)

5. getOrderStates(): Promise<OrderStateWithStages[]>
- Fetch all order_states for workspace
- Join pipeline_stages where order_state_id matches
- Order by position ASC
- Return with nested stages array

6. createOrderState(data: OrderStateFormData): Promise<ActionResult<OrderState>>
- Validate with schema
- Get next position (max position + 1)
- Insert record
- revalidatePath('/crm/configuracion/estados-pedido')

7. updateOrderState(id: string, data: Partial<OrderStateFormData>): Promise<ActionResult<OrderState>>
- Validate
- Update record
- revalidatePath('/crm/configuracion/estados-pedido')

8. deleteOrderState(id: string): Promise<ActionResult>
- Delete record (stages will be unassigned via ON DELETE SET NULL)
- revalidatePath('/crm/configuracion/estados-pedido')

9. updateOrderStateOrder(stateIds: string[]): Promise<ActionResult>
- Same pattern as updateStageOrder in pipelines.ts
- Use temp negative positions to avoid unique constraint violations
- revalidatePath('/crm/configuracion/estados-pedido')

10. assignStagesToState(stateId: string, stageIds: string[]): Promise<ActionResult>
- Clear existing assignments (set order_state_id = null for stages not in stageIds that currently point to this state)
- Set order_state_id = stateId for all stageIds
- revalidatePath('/crm/configuracion/estados-pedido')
- revalidatePath('/crm/configuracion/pipelines')

11. getOrderStateForStage(stageId: string): Promise<OrderState | null>
- Lookup pipeline_stages.order_state_id
- If null, return null
- Fetch and return the order_state
- Used by WhatsApp indicator to get emoji
  </action>
  <verify>
File exists with 'use server' at top.
grep for each exported function name returns matches.
TypeScript compiles without errors: pnpm tsc --noEmit (should not fail on this file)
  </verify>
  <done>
All Server Actions exported: getOrderStates, createOrderState, updateOrderState, deleteOrderState, updateOrderStateOrder, assignStagesToState, getOrderStateForStage.
  </done>
</task>

</tasks>

<verification>
After all tasks complete:
1. Migration file exists at supabase/migrations/20260203000002_order_states.sql
2. OrderState type can be imported: `import { OrderState } from '@/lib/orders/types'`
3. Server Actions can be imported: `import { getOrderStates } from '@/app/actions/order-states'`
4. TypeScript compiles: `cd /mnt/c/Users/Usuario/Proyectos/morfx-new && pnpm tsc --noEmit`
</verification>

<success_criteria>
- [x] Migration creates order_states table with RLS
- [x] Migration adds order_state_id FK to pipeline_stages with ON DELETE SET NULL
- [x] OrderState type exported from lib/orders/types.ts
- [x] PipelineStage type includes order_state_id field
- [x] All 7 Server Actions implemented and exported
- [x] Code follows existing patterns (pipelines.ts)
</success_criteria>

<output>
After completion, create `.planning/phases/09.1-order-states-config/09.1-01-SUMMARY.md`
</output>
