---
phase: 22-robot-coordinadora-service
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - robot-coordinadora/package.json
  - robot-coordinadora/tsconfig.json
  - robot-coordinadora/.dockerignore
  - robot-coordinadora/.gitignore
  - robot-coordinadora/src/types/index.ts
  - robot-coordinadora/src/middleware/locks.ts

autonomous: true

must_haves:
  truths:
    - "The project compiles with npx tsc --noEmit (no errors)"
    - "Types define the exact contract between MorfX and the robot (BatchRequest, BatchItemResult, OrderInput)"
    - "Workspace lock prevents concurrent batch processing for the same workspace"
    - "Per-order lock skips orders already being processed"
  artifacts:
    - path: "robot-coordinadora/package.json"
      provides: "Project dependencies and scripts"
      contains: "playwright"
    - path: "robot-coordinadora/tsconfig.json"
      provides: "TypeScript configuration"
      contains: "strict"
    - path: "robot-coordinadora/src/types/index.ts"
      provides: "All shared types for the microservice"
      exports: ["BatchRequest", "BatchItemResult", "OrderInput", "PedidoInput", "Credentials"]
    - path: "robot-coordinadora/src/middleware/locks.ts"
      provides: "Workspace and order locking primitives"
      exports: ["withWorkspaceLock", "isWorkspaceLocked", "tryLockOrder", "unlockOrder"]
  key_links:
    - from: "robot-coordinadora/src/types/index.ts"
      to: "MorfX PedidoInput (src/lib/logistics/constants.ts)"
      via: "Identical interface definition (copied, not imported -- separate repo)"
      pattern: "interface PedidoInput"
---

<objective>
Initialize the robot-coordinadora standalone microservice project with TypeScript scaffold, shared types mirroring MorfX's PedidoInput contract, and in-memory locking primitives for workspace and order concurrency control.

Purpose: Establish the project foundation that the CoordinadoraAdapter (Plan 02) and Express server (Plan 03) will build upon. Types define the contract between MorfX and the robot. Locks prevent duplicate batch processing.

Output: A compilable TypeScript project with types and locking middleware ready for use.
</objective>

<execution_context>
@/home/jose147/.claude/get-shit-done/workflows/execute-plan.md
@/home/jose147/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/22-robot-coordinadora-service/22-CONTEXT.md
@.planning/phases/22-robot-coordinadora-service/22-RESEARCH.md

# Key reference: MorfX PedidoInput type (the robot must accept this exact interface)
@src/lib/logistics/constants.ts

# Key reference: RobotEvents showing the data contract MorfX sends to the robot
@src/inngest/events.ts (lines 411-461 -- RobotEvents type)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create project scaffold</name>
  <files>
    robot-coordinadora/package.json
    robot-coordinadora/tsconfig.json
    robot-coordinadora/.dockerignore
    robot-coordinadora/.gitignore
  </files>
  <action>
Create a new directory `robot-coordinadora/` at the repository root (sibling to `src/`, NOT inside it).

**IMPORTANT:** This is a SEPARATE standalone project, NOT part of the MorfX Next.js app. It has its own package.json, tsconfig, and will be deployed independently to Railway.

**package.json:**
- name: "robot-coordinadora"
- version: "1.0.0"
- private: true
- scripts:
  - `build`: `tsc`
  - `start`: `node dist/index.js`
  - `dev`: `tsx watch src/index.ts`
- dependencies:
  - `playwright`: `^1.52.0` (NOTE: Use ^1.52.0 not 1.58.2 â€” 1.58.2 does not exist yet; 1.52.0 is the latest stable as of May 2025; check npm for the actual latest but do NOT use a version that doesn't exist)
  - `express`: `^4.21.0`
- devDependencies:
  - `typescript`: `^5.7.0`
  - `@types/node`: `^22.0.0`
  - `@types/express`: `^5.0.0`
  - `tsx`: `^4.19.0`

**tsconfig.json:**
- target: ES2022
- module: NodeNext
- moduleResolution: NodeNext
- outDir: ./dist
- rootDir: ./src
- strict: true
- esModuleInterop: true
- skipLibCheck: true
- forceConsistentCasingInFileNames: true
- resolveJsonModule: true
- declaration: true
- sourceMap: true

**.dockerignore:**
```
node_modules
dist
storage/sessions
*.md
.git
```

**.gitignore:**
```
node_modules/
dist/
storage/sessions/
*.log
```

Run `cd robot-coordinadora && npm install` to install dependencies.

Then run `npx playwright install chromium --with-deps` to install the Chromium browser binary needed for automation.
  </action>
  <verify>
- `ls robot-coordinadora/package.json` exists
- `ls robot-coordinadora/node_modules/playwright` exists
- `cd robot-coordinadora && npx tsc --version` outputs TypeScript version
  </verify>
  <done>
Project scaffold exists with all dependencies installed and TypeScript configured.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create shared types and locking middleware</name>
  <files>
    robot-coordinadora/src/types/index.ts
    robot-coordinadora/src/middleware/locks.ts
  </files>
  <action>
**src/types/index.ts** -- All shared types for the microservice:

```typescript
// ============================================================================
// Robot Coordinadora - Shared Types
// Mirrors MorfX contracts (PedidoInput from src/lib/logistics/constants.ts)
// and defines the HTTP API contract.
// ============================================================================

/**
 * PedidoInput -- Data needed to create a Coordinadora shipment.
 * MUST stay in sync with MorfX's PedidoInput (src/lib/logistics/constants.ts).
 */
export interface PedidoInput {
  identificacion: string
  nombres: string
  apellidos: string
  direccion: string
  /** Coordinadora city format: "CITY (DEPT)" */
  ciudad: string
  /** Department abbreviation */
  departamento: string
  celular: string
  email: string
  /** Order reference / name */
  referencia: string
  unidades: number
  totalConIva: number
  valorDeclarado: number
  esRecaudoContraentrega: boolean
  peso: number
  alto: number
  largo: number
  ancho: number
}

/** Portal credentials for Coordinadora ff.coordinadora.com */
export interface Credentials {
  username: string
  password: string
}

/** Single order within a batch request */
export interface OrderInput {
  /** robot_job_items.id from MorfX */
  itemId: string
  /** orders.id from MorfX */
  orderId: string
  /** The shipment data to fill in the portal form */
  pedidoInput: PedidoInput
}

/** Incoming batch request from MorfX (via Inngest orchestrator) */
export interface BatchRequest {
  workspaceId: string
  credentials: Credentials
  callbackUrl: string
  jobId: string
  orders: OrderInput[]
}

/** Result reported back to MorfX callback URL per order */
export interface BatchItemResult {
  itemId: string
  status: 'success' | 'error'
  trackingNumber?: string
  errorType?: 'validation' | 'portal' | 'timeout' | 'unknown'
  errorMessage?: string
}

/** Response from the robot's batch endpoint (immediate acknowledgement) */
export interface BatchResponse {
  success: boolean
  jobId?: string
  message: string
  error?: string
}

/** Health check response */
export interface HealthResponse {
  status: 'ok'
  uptime: number
  timestamp: string
}

/** Result from creating a single guia (adapter return) */
export interface GuiaResult {
  success: boolean
  /** Pedido/tracking number from Coordinadora */
  numeroPedido?: string
  error?: string
}
```

**src/middleware/locks.ts** -- In-memory workspace and order locking:

Implement:

1. **withWorkspaceLock(workspaceId, fn)** -- Mutex per workspace. Uses `Map<string, Promise<void>>`. While the map has an entry for this workspaceId, wait for it to resolve. Then set a new promise, execute fn, delete the entry, and resolve.

2. **isWorkspaceLocked(workspaceId)** -- Check if workspace has active lock. Returns boolean. Used by the endpoint to reject immediately with 409.

3. **tryLockOrder(orderId)** -- Add orderId to `Set<string>`. Returns false if already present (order is being processed). Returns true if added.

4. **unlockOrder(orderId)** -- Remove orderId from the Set.

Keep it simple. In-memory is fine because this is a single-instance service. No Redis, no external state. The locks reset on container restart, which is acceptable.

Export all 4 functions.
  </action>
  <verify>
- `cd robot-coordinadora && npx tsc --noEmit` compiles without errors
- `grep "export interface PedidoInput" robot-coordinadora/src/types/index.ts` finds the type
- `grep "export async function withWorkspaceLock" robot-coordinadora/src/middleware/locks.ts` finds the lock function
- `grep "export function tryLockOrder" robot-coordinadora/src/middleware/locks.ts` finds the order lock
  </verify>
  <done>
All shared types match MorfX contract. Locking middleware provides workspace mutex and per-order skip-if-processing. Project compiles cleanly.
  </done>
</task>

</tasks>

<verification>
1. `robot-coordinadora/` directory exists at repo root
2. `cd robot-coordinadora && npx tsc --noEmit` passes with zero errors
3. Types match the MorfX contract (PedidoInput fields identical to src/lib/logistics/constants.ts)
4. Locking middleware exports withWorkspaceLock, isWorkspaceLocked, tryLockOrder, unlockOrder
5. node_modules/playwright exists (Chromium dependency installed)
</verification>

<success_criteria>
- The robot-coordinadora project compiles with zero TypeScript errors
- PedidoInput interface matches MorfX's definition exactly (field names, types)
- Workspace lock and order lock are implemented and exported
- All npm dependencies are installed
</success_criteria>

<output>
After completion, create `.planning/phases/22-robot-coordinadora-service/22-01-SUMMARY.md`
</output>
