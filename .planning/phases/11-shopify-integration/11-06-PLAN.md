---
phase: 11-shopify-integration
plan: 06
type: execute
wave: 3
depends_on: ["11-04"]
files_modified:
  - src/app/(dashboard)/configuracion/integraciones/page.tsx
  - src/app/(dashboard)/configuracion/integraciones/components/shopify-form.tsx
  - src/app/(dashboard)/configuracion/integraciones/components/sync-status.tsx
autonomous: true

must_haves:
  truths:
    - "Admin can access integrations settings page"
    - "Form shows all Shopify configuration fields"
    - "Test connection button validates before save"
    - "Sync status shows recent webhook activity"
  artifacts:
    - path: "src/app/(dashboard)/configuracion/integraciones/page.tsx"
      provides: "Integrations settings page"
      min_lines: 50
    - path: "src/app/(dashboard)/configuracion/integraciones/components/shopify-form.tsx"
      provides: "Shopify configuration form"
      min_lines: 100
    - path: "src/app/(dashboard)/configuracion/integraciones/components/sync-status.tsx"
      provides: "Sync status display"
      min_lines: 50
  key_links:
    - from: "src/app/(dashboard)/configuracion/integraciones/page.tsx"
      to: "src/app/actions/shopify.ts"
      via: "import getShopifyIntegration"
      pattern: "import.*getShopifyIntegration"
---

<objective>
Create the integrations settings page with Shopify configuration form.

Purpose: Enable admin to configure Shopify integration through a user-friendly interface.
Output: Settings page with form, validation, and sync status display.
</objective>

<execution_context>
@/home/jose147/.claude/get-shit-done/workflows/execute-plan.md
@/home/jose147/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/11-shopify-integration/11-CONTEXT.md
@.planning/phases/11-shopify-integration/11-RESEARCH.md

# Existing settings page patterns:
@src/app/(dashboard)/configuracion/whatsapp/page.tsx
@src/app/(dashboard)/crm/configuracion/pipelines/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Integrations settings page</name>
  <files>src/app/(dashboard)/configuracion/integraciones/page.tsx</files>
  <action>
Create the main integrations page:

```typescript
// ============================================================================
// Phase 11: Integrations Settings Page
// Configure external integrations (Shopify, etc.)
// ============================================================================

import { Suspense } from 'react'
import { redirect } from 'next/navigation'
import { createClient } from '@/lib/supabase/server'
import { getShopifyIntegration, getPipelinesForConfig, getWebhookEvents } from '@/app/actions/shopify'
import { ShopifyForm } from './components/shopify-form'
import { SyncStatus } from './components/sync-status'
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card'
import { Tabs, TabsContent, TabsList, TabsTrigger } from '@/components/ui/tabs'
import { ShoppingBag, Settings2 } from 'lucide-react'

export default async function IntegracionesPage() {
  // Verify user is Owner
  const supabase = await createClient()
  const { data: { user } } = await supabase.auth.getUser()

  if (!user) {
    redirect('/login')
  }

  const { data: member } = await supabase
    .from('workspace_members')
    .select('role')
    .eq('user_id', user.id)
    .single()

  // Only Owner can access this page
  if (!member || member.role !== 'owner') {
    redirect('/crm/contactos')
  }

  // Load integration data
  const [integration, pipelines, webhookData] = await Promise.all([
    getShopifyIntegration(),
    getPipelinesForConfig(),
    getWebhookEvents(10),
  ])

  return (
    <div className="container mx-auto py-6 space-y-6">
      <div>
        <h1 className="text-2xl font-bold tracking-tight">Integraciones</h1>
        <p className="text-muted-foreground">
          Conecta tu tienda con servicios externos para sincronizar datos automaticamente.
        </p>
      </div>

      <Tabs defaultValue="shopify" className="space-y-4">
        <TabsList>
          <TabsTrigger value="shopify" className="flex items-center gap-2">
            <ShoppingBag className="h-4 w-4" />
            Shopify
          </TabsTrigger>
          {/* Future integrations can be added here */}
        </TabsList>

        <TabsContent value="shopify" className="space-y-4">
          <div className="grid gap-4 lg:grid-cols-3">
            {/* Configuration Form */}
            <div className="lg:col-span-2">
              <Card>
                <CardHeader>
                  <CardTitle className="flex items-center gap-2">
                    <ShoppingBag className="h-5 w-5" />
                    Configuracion de Shopify
                  </CardTitle>
                  <CardDescription>
                    Conecta tu tienda Shopify para sincronizar pedidos automaticamente.
                    Los pedidos creados en Shopify apareceran en tu CRM.
                  </CardDescription>
                </CardHeader>
                <CardContent>
                  <Suspense fallback={<div className="h-96 animate-pulse bg-muted rounded" />}>
                    <ShopifyForm
                      integration={integration}
                      pipelines={pipelines}
                    />
                  </Suspense>
                </CardContent>
              </Card>
            </div>

            {/* Sync Status */}
            <div>
              <Card>
                <CardHeader>
                  <CardTitle className="flex items-center gap-2">
                    <Settings2 className="h-5 w-5" />
                    Estado de Sincronizacion
                  </CardTitle>
                  <CardDescription>
                    Actividad reciente de webhooks
                  </CardDescription>
                </CardHeader>
                <CardContent>
                  <SyncStatus
                    integration={integration}
                    events={webhookData.events}
                    stats={webhookData.stats}
                  />
                </CardContent>
              </Card>
            </div>
          </div>

          {/* Instructions */}
          <Card>
            <CardHeader>
              <CardTitle>Como configurar</CardTitle>
            </CardHeader>
            <CardContent className="prose prose-sm max-w-none">
              <ol className="list-decimal pl-4 space-y-2">
                <li>
                  En tu admin de Shopify, ve a <strong>Settings &gt; Apps and sales channels &gt; Develop apps</strong>
                </li>
                <li>
                  Crea una nueva app o selecciona una existente
                </li>
                <li>
                  En <strong>Configuration</strong>, habilita los permisos: <code>read_orders</code>, <code>read_customers</code>
                </li>
                <li>
                  En <strong>API credentials</strong>, copia el <strong>Admin API access token</strong> y el <strong>API secret key</strong>
                </li>
                <li>
                  Pega las credenciales en el formulario y prueba la conexion
                </li>
                <li>
                  Configura el webhook en Shopify:
                  <ul className="list-disc pl-4 mt-1">
                    <li>Topic: <code>orders/create</code></li>
                    <li>URL: <code>{process.env.NEXT_PUBLIC_APP_URL}/api/webhooks/shopify</code></li>
                    <li>Format: JSON</li>
                  </ul>
                </li>
              </ol>
            </CardContent>
          </Card>
        </TabsContent>
      </Tabs>
    </div>
  )
}
```

Key features:
- Owner-only access (redirects non-owners)
- Tabbed layout for future integrations
- Grid layout with form and status sidebar
- Instructions for Shopify setup
  </action>
  <verify>Page renders without errors. Owner access check works.</verify>
  <done>Integrations page displays Shopify configuration with form and status.</done>
</task>

<task type="auto">
  <name>Task 2: Shopify configuration form component</name>
  <files>src/app/(dashboard)/configuracion/integraciones/components/shopify-form.tsx</files>
  <action>
Create the Shopify configuration form:

```typescript
'use client'

import { useState, useTransition } from 'react'
import { useRouter } from 'next/navigation'
import { useForm } from 'react-hook-form'
import { toast } from 'sonner'
import {
  testConnection,
  saveShopifyIntegration,
  toggleShopifyIntegration,
  deleteShopifyIntegration,
} from '@/app/actions/shopify'
import type { ShopifyIntegration, IntegrationFormData } from '@/lib/shopify/types'
import type { Pipeline, PipelineStage } from '@/lib/orders/types'
import { Button } from '@/components/ui/button'
import { Input } from '@/components/ui/input'
import { Label } from '@/components/ui/label'
import { Switch } from '@/components/ui/switch'
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from '@/components/ui/select'
import {
  AlertDialog,
  AlertDialogAction,
  AlertDialogCancel,
  AlertDialogContent,
  AlertDialogDescription,
  AlertDialogFooter,
  AlertDialogHeader,
  AlertDialogTitle,
  AlertDialogTrigger,
} from '@/components/ui/alert-dialog'
import { Badge } from '@/components/ui/badge'
import { Loader2, CheckCircle2, XCircle, Plug, Trash2, Eye, EyeOff } from 'lucide-react'

interface ShopifyFormProps {
  integration: ShopifyIntegration | null
  pipelines: Array<Pipeline & { stages: PipelineStage[] }>
}

export function ShopifyForm({ integration, pipelines }: ShopifyFormProps) {
  const router = useRouter()
  const [isPending, startTransition] = useTransition()
  const [isTesting, setIsTesting] = useState(false)
  const [testResult, setTestResult] = useState<{ success: boolean; shopName?: string; error?: string } | null>(null)
  const [showSecrets, setShowSecrets] = useState(false)
  const [selectedPipelineId, setSelectedPipelineId] = useState(
    integration?.config.default_pipeline_id || pipelines[0]?.id || ''
  )

  const {
    register,
    handleSubmit,
    watch,
    setValue,
    formState: { errors },
  } = useForm<IntegrationFormData>({
    defaultValues: {
      name: integration?.name || '',
      shop_domain: integration?.config.shop_domain || '',
      access_token: integration?.config.access_token || '',
      api_secret: integration?.config.api_secret || '',
      default_pipeline_id: integration?.config.default_pipeline_id || pipelines[0]?.id || '',
      default_stage_id: integration?.config.default_stage_id || '',
      enable_fuzzy_matching: integration?.config.enable_fuzzy_matching ?? true,
      product_matching: integration?.config.product_matching || 'sku',
    },
  })

  const selectedPipeline = pipelines.find(p => p.id === selectedPipelineId)
  const stages = selectedPipeline?.stages || []

  // Handle pipeline change
  const handlePipelineChange = (pipelineId: string) => {
    setSelectedPipelineId(pipelineId)
    setValue('default_pipeline_id', pipelineId)
    // Reset stage to first stage of new pipeline
    const newPipeline = pipelines.find(p => p.id === pipelineId)
    if (newPipeline?.stages[0]) {
      setValue('default_stage_id', newPipeline.stages[0].id)
    }
  }

  // Test connection
  const handleTestConnection = async () => {
    setIsTesting(true)
    setTestResult(null)

    const formData = watch()
    const result = await testConnection(formData)

    setTestResult(result)
    setIsTesting(false)

    if (result.success) {
      toast.success(`Conexion exitosa con ${result.shopName}`)
    } else {
      toast.error(result.error || 'Error de conexion')
    }
  }

  // Save integration
  const onSubmit = (data: IntegrationFormData) => {
    startTransition(async () => {
      const result = await saveShopifyIntegration(data)

      if (result.success) {
        toast.success(integration ? 'Integracion actualizada' : 'Integracion creada')
        router.refresh()
      } else {
        toast.error(result.error || 'Error al guardar')
      }
    })
  }

  // Toggle active status
  const handleToggleActive = () => {
    if (!integration) return

    startTransition(async () => {
      const result = await toggleShopifyIntegration(!integration.is_active)

      if (result.success) {
        toast.success(integration.is_active ? 'Integracion desactivada' : 'Integracion activada')
        router.refresh()
      } else {
        toast.error(result.error || 'Error al actualizar')
      }
    })
  }

  // Delete integration
  const handleDelete = () => {
    startTransition(async () => {
      const result = await deleteShopifyIntegration()

      if (result.success) {
        toast.success('Integracion eliminada')
        router.refresh()
      } else {
        toast.error(result.error || 'Error al eliminar')
      }
    })
  }

  return (
    <form onSubmit={handleSubmit(onSubmit)} className="space-y-6">
      {/* Status Badge */}
      {integration && (
        <div className="flex items-center justify-between">
          <div className="flex items-center gap-2">
            <Badge variant={integration.is_active ? 'default' : 'secondary'}>
              {integration.is_active ? 'Activa' : 'Inactiva'}
            </Badge>
            {integration.config.shop_domain && (
              <span className="text-sm text-muted-foreground">
                {integration.config.shop_domain}
              </span>
            )}
          </div>
          <div className="flex items-center gap-2">
            <Switch
              checked={integration.is_active}
              onCheckedChange={handleToggleActive}
              disabled={isPending}
            />
          </div>
        </div>
      )}

      {/* Credentials Section */}
      <div className="space-y-4">
        <h3 className="text-sm font-medium">Credenciales</h3>

        <div className="space-y-2">
          <Label htmlFor="shop_domain">Dominio de la tienda</Label>
          <Input
            id="shop_domain"
            placeholder="mitienda.myshopify.com"
            {...register('shop_domain', { required: 'Requerido' })}
          />
          {errors.shop_domain && (
            <p className="text-sm text-destructive">{errors.shop_domain.message}</p>
          )}
          <p className="text-xs text-muted-foreground">
            Solo el subdominio de Shopify (ej: mitienda.myshopify.com)
          </p>
        </div>

        <div className="space-y-2">
          <div className="flex items-center justify-between">
            <Label htmlFor="access_token">Access Token</Label>
            <Button
              type="button"
              variant="ghost"
              size="sm"
              onClick={() => setShowSecrets(!showSecrets)}
            >
              {showSecrets ? <EyeOff className="h-4 w-4" /> : <Eye className="h-4 w-4" />}
            </Button>
          </div>
          <Input
            id="access_token"
            type={showSecrets ? 'text' : 'password'}
            placeholder="shpat_xxxxx"
            {...register('access_token', { required: 'Requerido' })}
          />
          {errors.access_token && (
            <p className="text-sm text-destructive">{errors.access_token.message}</p>
          )}
        </div>

        <div className="space-y-2">
          <Label htmlFor="api_secret">API Secret Key</Label>
          <Input
            id="api_secret"
            type={showSecrets ? 'text' : 'password'}
            placeholder="shpss_xxxxx"
            {...register('api_secret', { required: 'Requerido' })}
          />
          {errors.api_secret && (
            <p className="text-sm text-destructive">{errors.api_secret.message}</p>
          )}
        </div>

        {/* Test Connection */}
        <div className="flex items-center gap-2">
          <Button
            type="button"
            variant="outline"
            onClick={handleTestConnection}
            disabled={isTesting}
          >
            {isTesting ? (
              <Loader2 className="h-4 w-4 mr-2 animate-spin" />
            ) : (
              <Plug className="h-4 w-4 mr-2" />
            )}
            Probar conexion
          </Button>
          {testResult && (
            <div className="flex items-center gap-1">
              {testResult.success ? (
                <>
                  <CheckCircle2 className="h-4 w-4 text-green-500" />
                  <span className="text-sm text-green-600">{testResult.shopName}</span>
                </>
              ) : (
                <>
                  <XCircle className="h-4 w-4 text-red-500" />
                  <span className="text-sm text-red-600">{testResult.error}</span>
                </>
              )}
            </div>
          )}
        </div>
      </div>

      {/* Configuration Section */}
      <div className="space-y-4">
        <h3 className="text-sm font-medium">Configuracion de pedidos</h3>

        <div className="grid gap-4 sm:grid-cols-2">
          <div className="space-y-2">
            <Label>Pipeline destino</Label>
            <Select
              value={selectedPipelineId}
              onValueChange={handlePipelineChange}
            >
              <SelectTrigger>
                <SelectValue placeholder="Seleccionar pipeline" />
              </SelectTrigger>
              <SelectContent>
                {pipelines.map(pipeline => (
                  <SelectItem key={pipeline.id} value={pipeline.id}>
                    {pipeline.name}
                  </SelectItem>
                ))}
              </SelectContent>
            </Select>
          </div>

          <div className="space-y-2">
            <Label>Etapa inicial</Label>
            <Select
              value={watch('default_stage_id')}
              onValueChange={(value) => setValue('default_stage_id', value)}
            >
              <SelectTrigger>
                <SelectValue placeholder="Seleccionar etapa" />
              </SelectTrigger>
              <SelectContent>
                {stages.map(stage => (
                  <SelectItem key={stage.id} value={stage.id}>
                    <div className="flex items-center gap-2">
                      <div
                        className="h-3 w-3 rounded-full"
                        style={{ backgroundColor: stage.color }}
                      />
                      {stage.name}
                    </div>
                  </SelectItem>
                ))}
              </SelectContent>
            </Select>
          </div>
        </div>

        <div className="space-y-2">
          <Label>Matching de productos</Label>
          <Select
            value={watch('product_matching')}
            onValueChange={(value: 'sku' | 'name' | 'value') => setValue('product_matching', value)}
          >
            <SelectTrigger>
              <SelectValue />
            </SelectTrigger>
            <SelectContent>
              <SelectItem value="sku">Por SKU (exacto)</SelectItem>
              <SelectItem value="name">Por nombre (aproximado)</SelectItem>
              <SelectItem value="value">Por precio (exacto)</SelectItem>
            </SelectContent>
          </Select>
          <p className="text-xs text-muted-foreground">
            Como se vinculan los productos de Shopify con tu catalogo
          </p>
        </div>

        <div className="flex items-center justify-between">
          <div className="space-y-0.5">
            <Label>Matching inteligente de contactos</Label>
            <p className="text-xs text-muted-foreground">
              Busca contactos similares por nombre y ciudad si no hay coincidencia por telefono
            </p>
          </div>
          <Switch
            checked={watch('enable_fuzzy_matching')}
            onCheckedChange={(checked) => setValue('enable_fuzzy_matching', checked)}
          />
        </div>
      </div>

      {/* Actions */}
      <div className="flex items-center justify-between pt-4 border-t">
        <div>
          {integration && (
            <AlertDialog>
              <AlertDialogTrigger asChild>
                <Button type="button" variant="destructive" size="sm">
                  <Trash2 className="h-4 w-4 mr-2" />
                  Eliminar
                </Button>
              </AlertDialogTrigger>
              <AlertDialogContent>
                <AlertDialogHeader>
                  <AlertDialogTitle>Eliminar integracion</AlertDialogTitle>
                  <AlertDialogDescription>
                    Se desconectara la tienda Shopify. Los pedidos ya importados no se eliminaran.
                  </AlertDialogDescription>
                </AlertDialogHeader>
                <AlertDialogFooter>
                  <AlertDialogCancel>Cancelar</AlertDialogCancel>
                  <AlertDialogAction onClick={handleDelete}>
                    Eliminar
                  </AlertDialogAction>
                </AlertDialogFooter>
              </AlertDialogContent>
            </AlertDialog>
          )}
        </div>

        <Button type="submit" disabled={isPending}>
          {isPending && <Loader2 className="h-4 w-4 mr-2 animate-spin" />}
          {integration ? 'Guardar cambios' : 'Conectar tienda'}
        </Button>
      </div>
    </form>
  )
}
```

Key features:
- Test connection before save
- Show/hide secrets toggle
- Pipeline and stage selection with proper cascading
- Product matching strategy selection
- Fuzzy matching toggle
- Delete with confirmation
- Active/inactive toggle
  </action>
  <verify>Form renders and validates. Test connection button works.</verify>
  <done>ShopifyForm allows full configuration of Shopify integration with validation.</done>
</task>

<task type="auto">
  <name>Task 3: Sync status component</name>
  <files>src/app/(dashboard)/configuracion/integraciones/components/sync-status.tsx</files>
  <action>
Create sync status display:

```typescript
'use client'

import type { ShopifyIntegration } from '@/lib/shopify/types'
import { Badge } from '@/components/ui/badge'
import { ScrollArea } from '@/components/ui/scroll-area'
import { formatDistanceToNow } from 'date-fns'
import { es } from 'date-fns/locale'
import { CheckCircle2, XCircle, Clock, Activity } from 'lucide-react'

interface SyncStatusProps {
  integration: ShopifyIntegration | null
  events: Array<{
    id: string
    external_id: string
    topic: string
    status: string
    error_message: string | null
    created_at: string
    processed_at: string | null
  }>
  stats: {
    total: number
    processed: number
    failed: number
    pending: number
  }
}

export function SyncStatus({ integration, events, stats }: SyncStatusProps) {
  if (!integration) {
    return (
      <div className="text-center py-8 text-muted-foreground">
        <Activity className="h-8 w-8 mx-auto mb-2 opacity-50" />
        <p>Configura la integracion para ver el estado de sincronizacion</p>
      </div>
    )
  }

  return (
    <div className="space-y-4">
      {/* Stats */}
      <div className="grid grid-cols-2 gap-2">
        <div className="text-center p-2 bg-muted/50 rounded">
          <div className="text-2xl font-bold">{stats.processed}</div>
          <div className="text-xs text-muted-foreground">Procesados</div>
        </div>
        <div className="text-center p-2 bg-muted/50 rounded">
          <div className="text-2xl font-bold text-red-600">{stats.failed}</div>
          <div className="text-xs text-muted-foreground">Fallidos</div>
        </div>
      </div>

      {/* Last sync */}
      {integration.last_sync_at && (
        <div className="text-sm">
          <span className="text-muted-foreground">Ultima sincronizacion: </span>
          <span>
            {formatDistanceToNow(new Date(integration.last_sync_at), {
              addSuffix: true,
              locale: es,
            })}
          </span>
        </div>
      )}

      {/* Recent events */}
      <div>
        <h4 className="text-sm font-medium mb-2">Eventos recientes</h4>
        {events.length === 0 ? (
          <p className="text-sm text-muted-foreground">No hay eventos</p>
        ) : (
          <ScrollArea className="h-[200px]">
            <div className="space-y-2">
              {events.map(event => (
                <div
                  key={event.id}
                  className="flex items-start gap-2 p-2 bg-muted/30 rounded text-sm"
                >
                  <StatusIcon status={event.status} />
                  <div className="flex-1 min-w-0">
                    <div className="flex items-center gap-2">
                      <Badge variant="outline" className="text-xs">
                        {event.topic}
                      </Badge>
                      <span className="text-xs text-muted-foreground">
                        {formatDistanceToNow(new Date(event.created_at), {
                          addSuffix: true,
                          locale: es,
                        })}
                      </span>
                    </div>
                    {event.error_message && (
                      <p className="text-xs text-red-600 mt-1 truncate">
                        {event.error_message}
                      </p>
                    )}
                  </div>
                </div>
              ))}
            </div>
          </ScrollArea>
        )}
      </div>

      {/* Webhook URL info */}
      <div className="pt-2 border-t">
        <p className="text-xs text-muted-foreground">
          URL del webhook:
        </p>
        <code className="text-xs bg-muted p-1 rounded block mt-1 truncate">
          {typeof window !== 'undefined' ? window.location.origin : ''}/api/webhooks/shopify
        </code>
      </div>
    </div>
  )
}

function StatusIcon({ status }: { status: string }) {
  switch (status) {
    case 'processed':
      return <CheckCircle2 className="h-4 w-4 text-green-500 flex-shrink-0" />
    case 'failed':
      return <XCircle className="h-4 w-4 text-red-500 flex-shrink-0" />
    case 'pending':
      return <Clock className="h-4 w-4 text-yellow-500 flex-shrink-0" />
    default:
      return <Activity className="h-4 w-4 text-muted-foreground flex-shrink-0" />
  }
}
```

Key features:
- Stats summary (processed/failed counts)
- Last sync timestamp
- Recent events list with status icons
- Error messages displayed
- Webhook URL for easy copying
  </action>
  <verify>Component renders with integration data. Status icons display correctly.</verify>
  <done>SyncStatus displays webhook activity with stats and event history.</done>
</task>

</tasks>

<verification>
1. Integrations page accessible at /configuracion/integraciones
2. Only Owner can access (non-owners redirected)
3. Form validates required fields
4. Test connection works before save
5. Sync status shows recent activity
</verification>

<success_criteria>
- Admin can access integrations settings page
- Form shows all Shopify configuration fields
- Test connection validates before save
- Sync status shows recent webhook activity
</success_criteria>

<output>
After completion, create `.planning/phases/11-shopify-integration/11-06-SUMMARY.md`
</output>
