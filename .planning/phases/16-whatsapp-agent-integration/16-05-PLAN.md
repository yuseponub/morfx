---
phase: 16-whatsapp-agent-integration
plan: 05
type: execute
wave: 3
depends_on: ["16-01", "16-04"]
files_modified:
  - src/lib/agents/production/metrics.ts
  - src/app/(dashboard)/agentes/layout.tsx
  - src/app/(dashboard)/agentes/page.tsx
  - src/app/(dashboard)/agentes/config/page.tsx
  - src/app/(dashboard)/agentes/components/metrics-dashboard.tsx
  - src/app/(dashboard)/agentes/components/config-panel.tsx
  - src/app/actions/agent-metrics.ts
autonomous: true

must_haves:
  truths:
    - "User can navigate to /agentes and see a dashboard with agent metrics"
    - "Dashboard shows metrics by period: Hoy, 7 dias, 30 dias, custom"
    - "Metrics include: total conversations, orders created, conversion rate"
    - "Metrics include: handoffs count, % resolved without human, avg response time"
    - "Metrics include: tokens used, cost per conversation, cost per order"
    - "Config tab shows full agent configuration (same as slider but more detailed)"
  artifacts:
    - path: "src/lib/agents/production/metrics.ts"
      provides: "Metrics aggregation queries"
      exports: ["getAgentMetrics", "AgentMetrics"]
    - path: "src/app/(dashboard)/agentes/layout.tsx"
      provides: "Agentes module layout with tabs"
      contains: "Dashboard"
    - path: "src/app/(dashboard)/agentes/page.tsx"
      provides: "Dashboard tab"
      contains: "MetricsDashboard"
    - path: "src/app/(dashboard)/agentes/config/page.tsx"
      provides: "Config tab"
      contains: "ConfigPanel"
    - path: "src/app/(dashboard)/agentes/components/metrics-dashboard.tsx"
      provides: "Dashboard cards and charts"
      contains: "AgentMetrics"
    - path: "src/app/actions/agent-metrics.ts"
      provides: "Server actions for metrics fetching"
      exports: ["fetchAgentMetrics"]
  key_links:
    - from: "src/app/(dashboard)/agentes/page.tsx"
      to: "src/app/actions/agent-metrics.ts"
      via: "Server-side data fetching"
      pattern: "fetchAgentMetrics"
    - from: "src/lib/agents/production/metrics.ts"
      to: "agent_sessions and agent_turns tables"
      via: "Supabase aggregate queries"
      pattern: "agent_sessions"
---

<objective>
Create the Agentes module with metrics dashboard and advanced configuration page.

Purpose: Managers need visibility into agent performance (conversations handled, orders created, handoffs, costs). The dedicated module provides this via a dashboard with period selection and a full config page for advanced settings.

Output: /agentes page with Dashboard tab (metrics) and Config tab (advanced settings), metrics queries, server actions.
</objective>

<execution_context>
@/home/jose147/.claude/get-shit-done/workflows/execute-plan.md
@/home/jose147/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/16-whatsapp-agent-integration/16-CONTEXT.md
@.planning/phases/16-whatsapp-agent-integration/16-RESEARCH.md

Key source files:
@src/lib/agents/types.ts
@src/app/(dashboard)/analytics/page.tsx (for pattern reference)
@src/app/actions/agent-config.ts (from Plan 01)
@src/lib/agents/production/agent-config.ts (from Plan 01)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Metrics queries and server actions</name>
  <files>
    src/lib/agents/production/metrics.ts
    src/app/actions/agent-metrics.ts
  </files>
  <action>
**src/lib/agents/production/metrics.ts:**

Create module with:

1. `AgentMetrics` interface:
```typescript
export interface AgentMetrics {
  // Conversations & Orders
  totalConversations: number
  totalOrders: number
  conversionRate: number  // orders / conversations as percentage

  // Handoffs & Resolution
  totalHandoffs: number
  resolvedWithoutHuman: number
  resolvedWithoutHumanPct: number  // percentage
  avgResponseTimeMs: number

  // AI Costs
  totalTokensUsed: number
  costPerConversation: number  // in USD
  costPerOrder: number  // in USD
  totalAiCost: number  // in USD
}
```

2. `getAgentMetrics(workspaceId: string, startDate: string, endDate: string): Promise<AgentMetrics>`:

   Use createAdminClient for all queries.

   a. **Total conversations:** Count from agent_sessions where workspace_id matches and created_at between startDate and endDate.

   b. **Total handoffs:** Count from agent_sessions where status = 'handed_off' (or check if newMode was 'handoff' in the session state). Actually, simpler: count from tasks table where title starts with 'Handoff:' and workspace_id matches. Or add a query on agent_sessions filtering by sessions that reached handoff mode.

   For simplicity: Count sessions that have mode='handoff' in their state JSONB. Query:
   ```sql
   SELECT COUNT(*) FROM agent_sessions
   WHERE workspace_id = $1
   AND created_at BETWEEN $2 AND $3
   AND state->>'currentMode' = 'handoff'
   ```
   Use Supabase `.filter('state->>currentMode', 'eq', 'handoff')`.

   c. **Total orders:** Count from orders table where created_at between dates AND there exists an agent_session for the same conversation_id. Alternatively, count orders where the workspace matches and an `agent_session_id` is linked.

   Simplest approach: query orders table with workspace_id and date range, then filter those whose contact has a corresponding agent_session. OR: Count tool_executions with tool_name = 'crm.order.create' within the date range and workspace.

   Best approach: Count tool_executions where tool_name = 'crm.order.create' and workspace_id matches and created_at in range. This directly measures agent-created orders.

   d. **Total tokens:** SUM from agent_turns where the session's workspace_id matches and created_at in range. Join agent_turns with agent_sessions on session_id.

   ```typescript
   const { data: tokenData } = await supabase
     .from('agent_turns')
     .select('tokens_used, agent_sessions!inner(workspace_id)')
     .eq('agent_sessions.workspace_id', workspaceId)
     .gte('created_at', startDate)
     .lte('created_at', endDate)

   const totalTokensUsed = tokenData?.reduce((sum, t) => sum + (t.tokens_used ?? 0), 0) ?? 0
   ```

   e. **AI cost calculation:** Use configurable rates:
   ```typescript
   const COST_PER_1K_INPUT_TOKENS = 0.001   // Haiku approximate
   const COST_PER_1K_OUTPUT_TOKENS = 0.005  // Haiku approximate
   // Rough estimate: average cost per token (blended)
   const COST_PER_TOKEN = 0.000003  // ~$3 per 1M tokens blended
   ```
   totalAiCost = totalTokensUsed * COST_PER_TOKEN.

   f. **Avg response time:** Calculate from agent_turns: difference between turn created_at and the previous inbound message timestamp. This is complex to compute. For MVP: use the average of `duration_ms` from tool_executions with agent_session_id, or simply: average time between customer message and first agent response. Set to 0 for now and add a comment "// TODO: Calculate from message timestamps".

   g. Compute derived metrics: conversionRate, resolvedWithoutHuman, etc.

3. `getMetricsByPeriod(workspaceId: string, period: 'today' | '7d' | '30d' | 'custom', customStart?: string, customEnd?: string)` — Helper that calculates startDate/endDate and calls getAgentMetrics. Use America/Bogota timezone for "today" calculation.

**src/app/actions/agent-metrics.ts:**

Server action:

1. `fetchAgentMetrics(period: 'today' | '7d' | '30d' | 'custom', customStart?: string, customEnd?: string)`:
   - Get workspace from cookies
   - Check user is authenticated and member
   - Call getMetricsByPeriod
   - Return AgentMetrics or { error: string }
  </action>
  <verify>TypeScript compiles. Metrics function returns all AgentMetrics fields. Server action validates authentication.</verify>
  <done>Metrics queries aggregate data from agent_sessions, agent_turns, and tool_executions. Server action provides authenticated access to metrics.</done>
</task>

<task type="auto">
  <name>Task 2: Agentes module pages and components</name>
  <files>
    src/app/(dashboard)/agentes/layout.tsx
    src/app/(dashboard)/agentes/page.tsx
    src/app/(dashboard)/agentes/config/page.tsx
    src/app/(dashboard)/agentes/components/metrics-dashboard.tsx
    src/app/(dashboard)/agentes/components/config-panel.tsx
  </files>
  <action>
**layout.tsx:**

Create layout with:
- Header: "Agentes" title with Bot icon
- Tab navigation: "Dashboard" (href=/agentes) and "Configuracion" (href=/agentes/config)
- Use Link components with active state based on pathname
- Style: Similar to existing settings layout pattern
- Content area with `{children}` slot

```typescript
'use client'
import { usePathname } from 'next/navigation'
import Link from 'next/link'
import { Bot } from 'lucide-react'
import { cn } from '@/lib/utils'

const tabs = [
  { label: 'Dashboard', href: '/agentes' },
  { label: 'Configuracion', href: '/agentes/config' },
]
```

**page.tsx (Dashboard):**

Server component that:
1. Gets workspace from createClient (server) cookies
2. Fetches default metrics (today) via fetchAgentMetrics
3. Passes to MetricsDashboard client component

```typescript
import { createClient } from '@/lib/supabase/server'
import { fetchAgentMetrics } from '@/app/actions/agent-metrics'
import { MetricsDashboard } from './components/metrics-dashboard'
```

**components/metrics-dashboard.tsx:**

Client component with:

1. Period selector: 4 buttons (Hoy, 7 dias, 30 dias, Custom)
   - Custom shows a date range picker (use two date inputs for simplicity)
   - Active period highlighted

2. Three card groups matching CONTEXT.md:

   **Group 1: Conversaciones y Ordenes**
   - Card: "Conversaciones atendidas" (totalConversations)
   - Card: "Ordenes creadas" (totalOrders)
   - Card: "Tasa de conversion" (conversionRate + %)

   **Group 2: Handoffs y Resolucion**
   - Card: "Handoffs" (totalHandoffs)
   - Card: "Resuelto sin humano" (resolvedWithoutHumanPct + %)
   - Card: "Tiempo promedio" (avgResponseTimeMs formatted)

   **Group 3: Costos de IA**
   - Card: "Tokens usados" (totalTokensUsed formatted with K/M suffix)
   - Card: "Costo por conversacion" (costPerConversation formatted as $X.XX)
   - Card: "Costo total" (totalAiCost formatted)

3. Each card: shadcn Card with CardHeader (title), CardContent (large number), CardDescription (context).

4. Use Recharts for optional chart below cards:
   - Simple bar chart showing conversations per day (if time, otherwise skip for MVP)
   - Chart can be added in a future iteration — focus on cards for now

5. Period changes call fetchAgentMetrics server action and update state.

Style: 3-column grid on lg, 1-column on mobile. Clean cards with large numbers. Use lucide-react icons for each group header.

**config/page.tsx:**

Server component that loads agent config and renders ConfigPanel.

**components/config-panel.tsx:**

Full configuration panel — same content as AgentConfigSlider but in a full-page layout:
- Global toggle (prominent)
- Agent selection with description
- CRM agent toggles with descriptions
- Handoff message (larger textarea)
- Timer preset with detailed descriptions of what each preset does
- Response speed with more granular control

This is essentially the same as AgentConfigSlider but with more space and descriptions. Can import and reuse the same server actions.

Alternatively: Extract shared config form logic into a shared component that both AgentConfigSlider and ConfigPanel use, with a `compact: boolean` prop.

For this plan: Create ConfigPanel as a standalone component that uses the same server actions but with full-page layout and more descriptive labels. Reuse patterns from AgentConfigSlider without importing it directly.
  </action>
  <verify>TypeScript compiles. /agentes renders dashboard with metrics cards. /agentes/config renders full config form. Period selector loads metrics for selected period. Tab navigation works between Dashboard and Config.</verify>
  <done>Agentes module has working Dashboard with metric cards and period selector, and Config page with full settings form.</done>
</task>

</tasks>

<verification>
- [ ] /agentes page renders with Dashboard tab active
- [ ] Metrics cards show all three groups (Conversations, Handoffs, Costs)
- [ ] Period selector (Hoy, 7d, 30d, Custom) loads correct data
- [ ] /agentes/config page renders full config form
- [ ] Config changes save via server actions
- [ ] Tab navigation works correctly
- [ ] Layout is responsive (3-col on lg, 1-col on mobile)
- [ ] TypeScript compiles cleanly
</verification>

<success_criteria>
Agentes module complete when:
1. /agentes shows dashboard with metrics cards for selected period
2. All three metric groups rendered (Conversations, Handoffs, Costs)
3. /agentes/config shows full agent configuration
4. Tab navigation between Dashboard and Config works
5. Period selector fetches correct data ranges
</success_criteria>

<output>
After completion, create `.planning/phases/16-whatsapp-agent-integration/16-05-SUMMARY.md`
</output>
