---
phase: 05-contacts-extended
plan: 03
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - src/app/actions/notes.ts
  - src/app/actions/activity.ts
  - src/app/(dashboard)/crm/contactos/[id]/components/notes-section.tsx
  - src/app/(dashboard)/crm/contactos/[id]/components/activity-timeline.tsx
  - src/app/(dashboard)/crm/contactos/[id]/page.tsx
  - src/components/ui/timeline.tsx
autonomous: true

must_haves:
  truths:
    - "User can add a note to any contact"
    - "Notes display in a timeline with author and date"
    - "Author/admin can edit or delete their notes"
    - "Activity history shows all contact changes with diff"
    - "Activity can be filtered by type (edits, notes, tags)"
  artifacts:
    - path: "src/app/actions/notes.ts"
      provides: "Server Actions for contact notes CRUD"
      exports: ["getContactNotes", "createNote", "updateNote", "deleteNote"]
    - path: "src/app/actions/activity.ts"
      provides: "Server Action to fetch contact activity"
      exports: ["getContactActivity"]
    - path: "src/app/(dashboard)/crm/contactos/[id]/components/notes-section.tsx"
      provides: "Notes timeline UI with add/edit/delete"
    - path: "src/app/(dashboard)/crm/contactos/[id]/components/activity-timeline.tsx"
      provides: "Activity history timeline with filters"
    - path: "src/components/ui/timeline.tsx"
      provides: "Reusable timeline component"
  key_links:
    - from: "notes-section.tsx"
      to: "src/app/actions/notes.ts"
      via: "createNote, updateNote, deleteNote calls"
      pattern: "createNote|updateNote|deleteNote"
    - from: "activity-timeline.tsx"
      to: "src/app/actions/activity.ts"
      via: "getContactActivity call"
      pattern: "getContactActivity"
---

<objective>
Implement contact notes system and activity history timeline. Users can add internal notes to contacts (visible to all workspace members) and view a complete history of all changes made to the contact.

Purpose: Notes allow team collaboration on contact context. Activity history provides audit trail and shows "what changed and when".
Output: Notes section with CRUD, activity timeline with filters, reusable timeline component.
</objective>

<execution_context>
@/home/jose147/.claude/get-shit-done/workflows/execute-plan.md
@/home/jose147/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/05-contacts-extended/05-CONTEXT.md
@.planning/phases/05-contacts-extended/05-RESEARCH.md
@.planning/phases/05-contacts-extended/05-01-SUMMARY.md
@src/lib/custom-fields/types.ts
@src/app/actions/contacts.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Server Actions for notes and activity</name>
  <files>src/app/actions/notes.ts, src/app/actions/activity.ts</files>
  <action>
**src/app/actions/notes.ts:**

Create Server Actions for contact notes:

1. `getContactNotes(contactId: string)` - Get all notes for a contact
   - Return sorted by created_at DESC (newest first)
   - Include user info (email, name) for each note via join with profiles table
   - Return type: NoteWithUser[]

2. `createNote(contactId: string, content: string)` - Add a note
   - Validate content is not empty
   - Insert with current user_id and workspace_id
   - Also insert activity record: action='note_added', metadata={preview: content.substring(0,100)}
   - Return the created note

3. `updateNote(noteId: string, content: string)` - Edit a note
   - Only author or admin/owner can update
   - Update content and updated_at
   - Insert activity: action='note_updated'
   - Return success/error

4. `deleteNote(noteId: string)` - Delete a note
   - Only author or admin/owner can delete
   - Insert activity: action='note_deleted', metadata={preview: note.content.substring(0,100)}
   - Return success/error

Type for note with user:
```typescript
interface NoteWithUser {
  id: string
  contact_id: string
  content: string
  created_at: string
  updated_at: string
  user: {
    id: string
    email: string
    full_name?: string
  }
}
```

**src/app/actions/activity.ts:**

Create Server Action for activity history:

1. `getContactActivity(contactId: string, options?: { types?: string[], limit?: number })` - Get activity
   - Default limit: 50
   - Optional filter by action types: ['created', 'updated', 'note_added', 'tag_added', etc.]
   - Include user info via left join with profiles
   - Return sorted by created_at DESC
   - Return type: ActivityWithUser[]

Format the changes JSONB for display:
- For 'updated' action: format as "Campo: valor_anterior -> valor_nuevo"
- For 'note_added': show note preview from metadata
- For 'tag_added'/'tag_removed': show tag name from metadata

Type:
```typescript
interface ActivityWithUser {
  id: string
  contact_id: string
  action: string
  changes: Record<string, { old: unknown; new: unknown }> | null
  metadata: Record<string, unknown> | null
  created_at: string
  user: {
    id: string
    email: string
    full_name?: string
  } | null
}
```
  </action>
  <verify>TypeScript compiles: `cd morfx && pnpm exec tsc --noEmit`</verify>
  <done>Server Actions exist for notes CRUD and activity fetch</done>
</task>

<task type="auto">
  <name>Task 2: Create reusable timeline component</name>
  <files>src/components/ui/timeline.tsx</files>
  <action>
Create a reusable timeline component for shadcn/ui style:

```typescript
// Timeline container
interface TimelineProps {
  children: React.ReactNode
  className?: string
}

export function Timeline({ children, className }: TimelineProps)

// Timeline item
interface TimelineItemProps {
  icon?: React.ReactNode
  title: string
  description?: React.ReactNode
  date: string
  children?: React.ReactNode  // For expandable content
  className?: string
}

export function TimelineItem({ icon, title, description, date, children, className }: TimelineItemProps)
```

Visual design (matching shadcn aesthetics):
- Vertical line connecting items on the left
- Small circle/icon at each item position
- Title in semi-bold, description in muted text
- Date formatted relative or absolute (e.g., "hace 2 horas" or "29 ene 2026")
- Optional expandable content (for showing full diff or note content)

Use Tailwind classes consistent with existing shadcn components:
- Border colors: border-border
- Muted text: text-muted-foreground
- Icon containers: rounded-full bg-muted

Responsive: stack nicely on mobile
  </action>
  <verify>Component renders without errors</verify>
  <done>Reusable Timeline and TimelineItem components exist</done>
</task>

<task type="auto">
  <name>Task 3: Create notes section and activity timeline for contact detail</name>
  <files>
    src/app/(dashboard)/crm/contactos/[id]/components/notes-section.tsx
    src/app/(dashboard)/crm/contactos/[id]/components/activity-timeline.tsx
    src/app/(dashboard)/crm/contactos/[id]/page.tsx
  </files>
  <action>
**src/app/(dashboard)/crm/contactos/[id]/components/notes-section.tsx:**

Notes section with add form and timeline:

```typescript
interface NotesSectionProps {
  contactId: string
  initialNotes: NoteWithUser[]
}
```

Features:
- Textarea for adding new note with "Agregar nota" button
- Timeline of existing notes using Timeline component
- Each note shows: author email/name, date (relative), content
- Edit button (opens inline edit mode) - only for author or admin
- Delete button with confirmation - only for author or admin
- Optimistic updates: show new note immediately, revert on error
- Empty state: "Sin notas" with encouraging message

Use icons:
- MessageSquare for notes
- User for author indicator
- Clock for timestamp

**src/app/(dashboard)/crm/contactos/[id]/components/activity-timeline.tsx:**

Activity history with filters:

```typescript
interface ActivityTimelineProps {
  contactId: string
  initialActivity: ActivityWithUser[]
}
```

Features:
- Filter toggles at top: Ediciones, Notas, Tags (default: all on)
- Timeline of activity events
- Different icons per action type:
  - created: Plus
  - updated: Edit
  - deleted: Trash
  - note_added/updated/deleted: MessageSquare
  - tag_added/removed: Tag
- For 'updated' events: show diff (field: old -> new)
- For note events: show note preview
- For tag events: show tag name with color badge
- Load more button if > 50 items
- Empty state if no activity

Format changes display:
```typescript
function formatChanges(changes: Record<string, { old: unknown; new: unknown }>): string[] {
  return Object.entries(changes)
    .filter(([key]) => !['updated_at', 'created_at'].includes(key))
    .map(([key, { old, new: newVal }]) => {
      const fieldLabel = FIELD_LABELS[key] || key
      return `${fieldLabel}: ${formatValue(old)} -> ${formatValue(newVal)}`
    })
}
```

**Update src/app/(dashboard)/crm/contactos/[id]/page.tsx:**

Add tabs or sections for:
1. Informacion (existing contact fields)
2. Campos personalizados (from Plan 02)
3. Notas (NotesSection)
4. Historial (ActivityTimeline)

Use Tabs component from shadcn/ui:
```tsx
<Tabs defaultValue="info">
  <TabsList>
    <TabsTrigger value="info">Informacion</TabsTrigger>
    <TabsTrigger value="custom">Campos</TabsTrigger>
    <TabsTrigger value="notes">Notas</TabsTrigger>
    <TabsTrigger value="history">Historial</TabsTrigger>
  </TabsList>
  <TabsContent value="info">...</TabsContent>
  ...
</Tabs>
```

Fetch notes and activity in server component:
```typescript
const notes = await getContactNotes(contactId)
const activity = await getContactActivity(contactId)
```
  </action>
  <verify>
1. Navigate to contact detail page - tabs visible
2. Add a note - appears in notes tab
3. View history tab - shows activity events
  </verify>
  <done>
- Notes section with add/edit/delete
- Activity timeline with type filters
- Contact detail page has tabs for all sections
  </done>
</task>

</tasks>

<verification>
1. TypeScript compiles: `cd morfx && pnpm exec tsc --noEmit`
2. Server Actions exported: getContactNotes, createNote, updateNote, deleteNote, getContactActivity
3. Timeline component exists at src/components/ui/timeline.tsx
4. Contact detail page shows tabs with Notes and History
5. Creating a note adds activity entry automatically
</verification>

<success_criteria>
- User can add internal notes to contacts
- Notes display in timeline with author and date
- Only author/admin can edit/delete notes
- Activity history shows all contact changes
- Activity shows field-level diffs for edits
- Activity can be filtered by type
</success_criteria>

<output>
After completion, create `.planning/phases/05-contacts-extended/05-03-SUMMARY.md`
</output>
