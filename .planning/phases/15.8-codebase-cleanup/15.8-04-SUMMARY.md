---
phase: 15.8
plan: 04
subsystem: code-consolidation
tags: [refactor, phone-normalization, supabase-admin, state-factory, model-constants, deduplication]
dependency-graph:
  requires: [15.8-01, 15.8-02]
  provides: [code-consolidation-complete, single-source-phone, model-constants, state-factory]
  affects: [16-whatsapp-agent-integration]
tech-stack:
  added: []
  patterns: [re-export-pattern, factory-helper, const-object-as-const]
key-files:
  created: []
  modified:
    - src/lib/utils/phone.ts
    - src/lib/agents/somnio/normalizers.ts
    - src/lib/whatsapp/webhook-handler.ts
    - src/lib/supabase/server.ts
    - src/lib/agents/types.ts
    - src/lib/agents/session-manager.ts
    - src/lib/agents/intent-detector.ts
    - src/lib/agents/orchestrator.ts
    - src/lib/agents/somnio/data-extractor.ts
    - src/lib/agents/somnio/config.ts
decisions:
  - id: "15.8-04-D1"
    decision: "normalizePhoneRaw in phone.ts duplicates normalizers.ts logic (not delegate to normalizePhone)"
    reason: "The two functions serve different purposes: normalizePhone returns E.164 with +, normalizePhoneRaw returns without +. The raw version uses its own digit-based normalization for datos_capturados backward compatibility."
  - id: "15.8-04-D2"
    decision: "message-classifier.ts keeps direct API model ID string (claude-sonnet-4-20250514)"
    reason: "MessageClassifier calls Anthropic SDK directly (not through ClaudeClient), so it uses the resolved model ID. The CLAUDE_MODELS aliases are for the ClaudeClient abstraction layer only."
  - id: "15.8-04-D3"
    decision: "ClaudeModel type defined as alias of ClaudeModelId (derived from CLAUDE_MODELS const)"
    reason: "Preserves backward compatibility with existing ClaudeModel type usage while making it derived from the constant object for type safety."
metrics:
  duration: "~11 minutes"
  completed: "2026-02-09"
---

# Phase 15.8 Plan 04: Code Consolidation Summary

**One-liner:** Consolidated 4 categories of duplicate code: phone normalization (normalizePhoneRaw in phone.ts), Supabase admin client (re-export from admin.ts), session state factory (createDefaultSessionState helper), and model ID constants (CLAUDE_MODELS in types.ts).

## Tasks Completed

### Task 1: Consolidate phone normalization + Supabase admin client
**Commit:** `b9b3d7e`

| Category | Before | After |
|----------|--------|-------|
| Phone (raw format) | 4 implementations across phone.ts, normalizers.ts, webhook-handler.ts | 1 canonical source in phone.ts, normalizers.ts re-exports |
| Phone (webhook) | Private function in webhook-handler.ts | Import from phone.ts with null fallback |
| Admin client | Duplicate in server.ts and admin.ts | server.ts re-exports from admin.ts |

**Changes:**
- Added `normalizePhoneRaw` to `src/lib/utils/phone.ts` (E.164 without + prefix, for datos_capturados format)
- Removed local `normalizePhone` from `normalizers.ts`, replaced with `export { normalizePhoneRaw as normalizePhone }` re-export
- Removed private `normalizePhone` from `webhook-handler.ts`, added import from `phone.ts`
- Added null fallback in webhook handler: `normalizePhone(msg.from) ?? \`+\${msg.from.replace(/[^\\d]/g, '')}\``
- Removed duplicate `createAdminClient` from `server.ts`, added re-export from `./admin`
- Removed unused `createClient as createSupabaseClient` import from server.ts

### Task 2: Consolidate state factory + model ID constants
**Commit:** `bf67b68`

| Category | Before | After |
|----------|--------|-------|
| Session state | 2 inline constructions (createSession, getState) | 1 factory helper: createDefaultSessionState |
| Model IDs | String literals in 5 files | CLAUDE_MODELS constant in types.ts, imported everywhere |

**Changes:**
- Added `CLAUDE_MODELS` constant object to `types.ts` with `HAIKU` and `SONNET` keys
- Added `ClaudeModelId` type derived from the constant
- Made `ClaudeModel` an alias of `ClaudeModelId` for backward compatibility
- Replaced `'claude-haiku-4-5'` in intent-detector.ts with `CLAUDE_MODELS.HAIKU`
- Replaced `'claude-sonnet-4-5'` in orchestrator.ts, config.ts (2 places), data-extractor.ts with `CLAUDE_MODELS.SONNET`
- Created `createDefaultSessionState(sessionId)` helper function in session-manager.ts
- Updated `createSession` to use factory with spread for initialState overrides
- Updated `getState` fallback to use factory directly

## Deviations from Plan

### Auto-fixed Issues

**1. [Rule 3 - Blocking] Null handling for normalizePhone in webhook-handler**
- **Found during:** Task 1
- **Issue:** Canonical `normalizePhone` from `phone.ts` returns `string | null`, but webhook handler used the phone value as non-null `string` throughout
- **Fix:** Added fallback: `normalizePhone(msg.from) ?? \`+\${msg.from.replace(/[^\\d]/g, '')}\``
- **Files modified:** src/lib/whatsapp/webhook-handler.ts
- **Commit:** b9b3d7e

**2. [Parallel Plan Overlap] data-extractor.ts CLAUDE_MODELS changes done by Plan 03**
- **Found during:** Task 2
- **Issue:** Plan 03 (running in parallel) already added `import { CLAUDE_MODELS }` and replaced `'claude-sonnet-4-5'` with `CLAUDE_MODELS.SONNET` in data-extractor.ts as part of its constants consolidation
- **Resolution:** No conflict. My edits applied cleanly on top of Plan 03's commit since the content was identical.

## Decisions Made

| ID | Decision | Rationale |
|----|----------|-----------|
| 15.8-04-D1 | normalizePhoneRaw uses own digit-based logic | Different normalization for datos_capturados format (without +) vs E.164 (with +) |
| 15.8-04-D2 | message-classifier.ts keeps direct API model ID | Uses Anthropic SDK directly, not ClaudeClient abstraction |
| 15.8-04-D3 | ClaudeModel = ClaudeModelId alias | Backward compatible while being type-safe via const derivation |

## Commits

| Task | Commit | Description |
|------|--------|-------------|
| 1 | b9b3d7e | Consolidate phone normalization and admin client |
| 2 | bf67b68 | Consolidate state factory and model constants |

## Verification

- `npx tsc --noEmit` passes with zero source errors (all checks passed)
- `normalizePhoneRaw` exported only from phone.ts (single source)
- No `function normalizePhone` definitions remain in normalizers.ts or webhook-handler.ts
- `createAdminClient` in server.ts is a re-export, not a function definition
- `createDefaultSessionState` used in 3 places (definition + 2 call sites)
- `CLAUDE_MODELS` imported in 5 files across the agents module
- No remaining hardcoded model strings in intent-detector, orchestrator, or config

## Next Phase Readiness

Phase 15.8 is now complete (4/4 plans). The codebase is clean and ready for Phase 16 (WhatsApp Agent Integration):
- Single phone normalization source prevents format divergence
- Single admin client prevents configuration drift
- Model constants enable easy model upgrades (change one place)
- State factory prevents missing-field bugs in new sessions

**No blockers for Phase 16.**
