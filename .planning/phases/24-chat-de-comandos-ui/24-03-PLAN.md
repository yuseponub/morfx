---
phase: 24-chat-de-comandos-ui
plan: 03
type: execute
wave: 3
depends_on: ["24-02"]
files_modified:
  - src/app/(dashboard)/comandos/page.tsx
  - src/app/(dashboard)/comandos/components/comandos-layout.tsx
  - src/app/(dashboard)/comandos/components/comandos-split-panel.tsx
  - src/app/(dashboard)/comandos/components/command-panel.tsx
  - src/app/(dashboard)/comandos/components/command-input.tsx
  - src/app/(dashboard)/comandos/components/command-output.tsx
  - src/app/(dashboard)/comandos/components/history-panel.tsx
  - src/app/(dashboard)/comandos/components/progress-indicator.tsx
  - src/components/layout/sidebar.tsx
autonomous: false

must_haves:
  truths:
    - "A /comandos page exists in the sidebar navigation between Tareas and Automatizaciones"
    - "The page shows a split panel: left for command interaction, right for job history"
    - "User can type 'subir ordenes coord', 'estado', or 'ayuda' and see appropriate responses"
    - "Quick-action chips/buttons exist for each command with confirmation on click"
    - "During a running job, a live progress counter updates showing N/M processed orders"
    - "When a job completes, a full result report appears with successes and failures per order"
    - "The right panel shows a chronological list of past jobs with date, result counts, and status"
    - "Input is disabled while a job is in progress with a placeholder message"
    - "If user navigates to /comandos during an active job, it reconnects to live progress"
  artifacts:
    - path: "src/app/(dashboard)/comandos/page.tsx"
      provides: "Server component page wrapper"
      contains: "metadata"
    - path: "src/app/(dashboard)/comandos/components/comandos-layout.tsx"
      provides: "Client root with state management and split panel"
      contains: "useRobotJobProgress"
    - path: "src/app/(dashboard)/comandos/components/comandos-split-panel.tsx"
      provides: "Allotment wrapper with dynamic import ssr:false"
      contains: "Allotment"
    - path: "src/app/(dashboard)/comandos/components/command-panel.tsx"
      provides: "Left panel with command output and input"
      contains: "CommandMessage"
    - path: "src/app/(dashboard)/comandos/components/command-input.tsx"
      provides: "Text input with command chips"
      contains: "subir ordenes coord"
    - path: "src/app/(dashboard)/comandos/components/command-output.tsx"
      provides: "Scrollable output messages area"
      contains: "ScrollArea"
    - path: "src/app/(dashboard)/comandos/components/history-panel.tsx"
      provides: "Right panel with job history table"
      contains: "getCommandHistory"
    - path: "src/app/(dashboard)/comandos/components/progress-indicator.tsx"
      provides: "Live progress counter component"
      contains: "procesadas"
    - path: "src/components/layout/sidebar.tsx"
      provides: "Updated sidebar with Comandos entry"
      contains: "comandos"
  key_links:
    - from: "src/app/(dashboard)/comandos/components/comandos-layout.tsx"
      to: "src/hooks/use-robot-job-progress.ts"
      via: "hook call for live progress"
      pattern: "useRobotJobProgress"
    - from: "src/app/(dashboard)/comandos/components/comandos-layout.tsx"
      to: "src/app/actions/comandos.ts"
      via: "server action calls for command execution"
      pattern: "executeSubirOrdenesCoord|getJobStatus|getCommandHistory"
    - from: "src/app/(dashboard)/comandos/components/command-input.tsx"
      to: "comandos-layout.tsx"
      via: "onCommand callback prop"
      pattern: "onCommand"
    - from: "src/components/layout/sidebar.tsx"
      to: "/comandos"
      via: "Link href"
      pattern: "href.*comandos"
---

<objective>
Build the full Chat de Comandos UI: page, components, and sidebar navigation.

Purpose: Operations team needs a visual interface to dispatch logistics commands, monitor real-time progress, and review job history -- all within MorfX without external tools.

Output: Complete /comandos page with split-panel layout, command interaction, live progress, and job history.
</objective>

<execution_context>
@/home/jose147/.claude/get-shit-done/workflows/execute-plan.md
@/home/jose147/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@.planning/phases/24-chat-de-comandos-ui/24-01-SUMMARY.md
@.planning/phases/24-chat-de-comandos-ui/24-02-SUMMARY.md

@src/app/(dashboard)/sandbox/page.tsx
@src/app/(dashboard)/sandbox/components/sandbox-layout.tsx
@src/app/(dashboard)/sandbox/components/sandbox-split-panel.tsx
@src/app/(dashboard)/sandbox/components/sandbox-chat.tsx
@src/app/(dashboard)/sandbox/components/sandbox-input.tsx
@src/components/layout/sidebar.tsx
@src/hooks/use-robot-job-progress.ts
@src/app/actions/comandos.ts
@src/lib/domain/robot-jobs.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Page, split panel, and layout scaffolding</name>
  <files>
    src/app/(dashboard)/comandos/page.tsx,
    src/app/(dashboard)/comandos/components/comandos-split-panel.tsx,
    src/app/(dashboard)/comandos/components/comandos-layout.tsx,
    src/components/layout/sidebar.tsx
  </files>
  <action>
  **page.tsx** (server component):
  - Export metadata: `{ title: 'Comandos | MorfX', description: 'Panel de comandos de logistica' }`
  - Render `<ComandosLayout />`
  - Follow exact pattern from sandbox/page.tsx.

  **comandos-split-panel.tsx** ('use client'):
  - Follow exact pattern from sandbox-split-panel.tsx.
  - Import `Allotment` and CSS.
  - Props: `leftPanel: ReactNode`, `rightPanel: ReactNode`.
  - Default sizes: `[55, 45]` (slightly more room for history panel).
  - Min size: 300.
  - Right pane gets `snap` prop.

  **comandos-layout.tsx** ('use client'):
  - This is the CLIENT ROOT that manages all state for the Comandos module.
  - Dynamic import of `ComandosSplitPanel` with `ssr: false` (Allotment SSR crash prevention).

  **State management:**
  ```typescript
  // Command output messages
  const [messages, setMessages] = useState<CommandMessage[]>([])
  // Active job tracking
  const [activeJobId, setActiveJobId] = useState<string | null>(null)
  // Job history
  const [history, setHistory] = useState<RobotJob[]>([])
  // Input disabled flag
  const [isExecuting, setIsExecuting] = useState(false)
  ```

  **CommandMessage type** (define in this file or a shared types file):
  ```typescript
  type CommandMessage =
    | { type: 'command'; text: string; timestamp: string }
    | { type: 'system'; text: string; timestamp: string }
    | { type: 'progress'; current: number; total: number; timestamp: string }
    | { type: 'result'; success: number; error: number; details: Array<{ orderId: string; orderName: string | null; status: 'success' | 'error'; trackingNumber?: string; errorMessage?: string }>; timestamp: string }
    | { type: 'error'; text: string; timestamp: string }
    | { type: 'help'; timestamp: string }
  ```

  **Realtime hook usage:**
  ```typescript
  const { job, items, successCount, errorCount, totalItems, isComplete } = useRobotJobProgress(activeJobId)
  ```

  **Progress message injection (useEffect on items/successCount/errorCount):**
  When successCount + errorCount changes and job is active, update the LAST progress message in the messages array (or add one if not present). DON'T add a new message each tick -- replace the existing progress message.

  **Completion detection (useEffect on isComplete):**
  When isComplete transitions to true:
  - Build result details from items array (map each item to success/error with tracking number or error message)
  - Add a 'result' message to messages
  - Set activeJobId to null (but keep the message history)
  - Refresh history panel (call getCommandHistory)
  - Set isExecuting to false

  **Initial load (useEffect on mount):**
  1. Call `getCommandHistory()` to load history.
  2. Call `getJobStatus()` to detect active job.
  3. If active job found, set activeJobId, add a system message "Reconectando a job activo...", set isExecuting to true.

  **Command handler:**
  ```typescript
  const handleCommand = useCallback(async (input: string) => {
    const normalized = input.trim().toLowerCase()

    // Echo the command
    addMessage({ type: 'command', text: input, timestamp: now() })

    if (normalized === 'ayuda') {
      addMessage({ type: 'help', timestamp: now() })
      return
    }

    if (normalized === 'estado') {
      if (activeJobId && job) {
        addMessage({ type: 'system', text: `Job activo: ${successCount + errorCount}/${totalItems} procesadas (${successCount} exitos, ${errorCount} errores)`, timestamp: now() })
      } else {
        addMessage({ type: 'system', text: 'No hay job activo.', timestamp: now() })
      }
      return
    }

    if (normalized === 'subir ordenes coord') {
      setIsExecuting(true)
      addMessage({ type: 'system', text: 'Preparando ordenes...', timestamp: now() })
      const result = await executeSubirOrdenesCoord()
      if (!result.success) {
        addMessage({ type: 'error', text: result.error!, timestamp: now() })
        setIsExecuting(false)
        return
      }
      // Report validation summary
      const data = result.data!
      addMessage({ type: 'system', text: `Job creado: ${data.validCount} ordenes validas de ${data.totalOrders} total. ${data.invalidCount > 0 ? `${data.invalidCount} invalidas.` : ''}`, timestamp: now() })
      if (data.invalidOrders.length > 0) {
        const invalidText = data.invalidOrders.map(o => `  - ${o.orderName || o.orderId}: ${o.reason}`).join('\n')
        addMessage({ type: 'system', text: `Ordenes invalidas:\n${invalidText}`, timestamp: now() })
      }
      setActiveJobId(data.jobId)
      return
    }

    // Unknown command
    addMessage({ type: 'system', text: `Comando no reconocido: "${input}". Escribe "ayuda" para ver los comandos disponibles.`, timestamp: now() })
  }, [activeJobId, job, successCount, errorCount, totalItems])
  ```

  **Confirmation handler** (for chip buttons):
  ```typescript
  const handleCommandWithConfirmation = useCallback(async (command: string) => {
    // Will be handled by command-input component showing a confirmation dialog
    handleCommand(command)
  }, [handleCommand])
  ```

  **Layout render:**
  ```tsx
  return (
    <div className="flex flex-col h-full">
      <div className="h-14 flex items-center px-6 border-b bg-card">
        <Terminal className="h-5 w-5 mr-2 text-muted-foreground" />
        <h1 className="text-lg font-semibold">Comandos</h1>
      </div>
      <div className="flex-1 min-h-0">
        <ComandosSplitPanel
          leftPanel={
            <CommandPanel
              messages={messages}
              onCommand={handleCommand}
              onCommandWithConfirmation={handleCommandWithConfirmation}
              isExecuting={isExecuting}
              activeJobId={activeJobId}
              successCount={successCount}
              errorCount={errorCount}
              totalItems={totalItems}
            />
          }
          rightPanel={
            <HistoryPanel
              history={history}
              onRefresh={() => getCommandHistory().then(r => r.success && r.data && setHistory(r.data))}
            />
          }
        />
      </div>
    </div>
  )
  ```

  **sidebar.tsx update:**
  Add a new nav item for Comandos between Tareas and Automatizaciones:
  ```typescript
  {
    href: '/comandos',
    label: 'Comandos',
    icon: Terminal,
    adminOnly: true,
  },
  ```
  Import `Terminal` from `lucide-react` (add to existing import).
  Place it AFTER Tareas and BEFORE Automatizaciones in the navItems array.
  `adminOnly: true` ensures only owner and admin roles see it (matches CONTEXT.md: "admin y equipo de operaciones", which maps to owner+admin roles per RESEARCH.md).
  </action>
  <verify>
  - `npx tsc --noEmit` passes
  - `/comandos` page renders without SSR errors (Allotment dynamic import)
  - Sidebar shows "Comandos" between "Tareas" and "Automatizaciones"
  - Terminal icon imported from lucide-react
  - CommandMessage type covers all output types (command, system, progress, result, error, help)
  - Active job detection on mount works (reconnect scenario)
  </verify>
  <done>Page scaffolding complete: server page with metadata, Allotment split panel, client layout with full state management and command handling, sidebar navigation entry.</done>
</task>

<task type="auto">
  <name>Task 2: Command panel components (input, output, progress)</name>
  <files>
    src/app/(dashboard)/comandos/components/command-panel.tsx,
    src/app/(dashboard)/comandos/components/command-input.tsx,
    src/app/(dashboard)/comandos/components/command-output.tsx,
    src/app/(dashboard)/comandos/components/progress-indicator.tsx
  </files>
  <action>
  **command-panel.tsx** ('use client'):
  Container for the left panel. Contains output area + input bar at bottom.

  Props:
  ```typescript
  interface CommandPanelProps {
    messages: CommandMessage[]
    onCommand: (input: string) => void
    onCommandWithConfirmation: (command: string) => void
    isExecuting: boolean
    activeJobId: string | null
    successCount: number
    errorCount: number
    totalItems: number
  }
  ```

  Layout:
  ```tsx
  <div className="flex flex-col h-full">
    <CommandOutput messages={messages} />
    {activeJobId && (
      <ProgressIndicator
        successCount={successCount}
        errorCount={errorCount}
        totalItems={totalItems}
      />
    )}
    <CommandInput
      onCommand={onCommand}
      onCommandWithConfirmation={onCommandWithConfirmation}
      isDisabled={isExecuting}
    />
  </div>
  ```

  **command-output.tsx** ('use client'):
  Scrollable output area displaying messages chronologically.

  Props:
  ```typescript
  interface CommandOutputProps {
    messages: CommandMessage[]
  }
  ```

  Implementation:
  - Use shadcn `ScrollArea` for the scrollable container.
  - Use a `bottomRef` and `scrollIntoView({ behavior: 'smooth' })` on messages change (same pattern as sandbox-chat.tsx).
  - Render each message based on its type:

    **type: 'command'** — User command echo:
    ```tsx
    <div className="flex items-start gap-2 text-sm">
      <ChevronRight className="h-4 w-4 mt-0.5 text-primary shrink-0" />
      <span className="font-medium">{message.text}</span>
      <span className="text-xs text-muted-foreground ml-auto">{formatTime(message.timestamp)}</span>
    </div>
    ```

    **type: 'system'** — Info message (may contain newlines):
    ```tsx
    <div className="text-sm text-muted-foreground whitespace-pre-wrap">{message.text}</div>
    ```

    **type: 'error'** — Error in destructive color:
    ```tsx
    <div className="text-sm text-destructive flex items-start gap-2">
      <AlertCircle className="h-4 w-4 mt-0.5 shrink-0" />
      <span>{message.text}</span>
    </div>
    ```

    **type: 'result'** — Batch result report:
    ```tsx
    <div className="space-y-2 text-sm">
      <div className="font-medium">
        Resultado: {message.success} exitosas, {message.error} con error
      </div>
      <div className="space-y-1 pl-4">
        {message.details.map(d => (
          <div key={d.orderId} className={d.status === 'success' ? 'text-green-600 dark:text-green-400' : 'text-destructive'}>
            {d.status === 'success'
              ? `✓ ${d.orderName || d.orderId} — Pedido #${d.trackingNumber}`
              : `✗ ${d.orderName || d.orderId} — ${d.errorMessage}`}
          </div>
        ))}
      </div>
    </div>
    ```

    **type: 'help'** — Help listing:
    ```tsx
    <div className="text-sm space-y-1">
      <div className="font-medium">Comandos disponibles:</div>
      <div className="pl-4 space-y-1 text-muted-foreground">
        <div><code className="text-xs bg-muted px-1 py-0.5 rounded">subir ordenes coord</code> — Validar ciudades y subir ordenes a Coordinadora</div>
        <div><code className="text-xs bg-muted px-1 py-0.5 rounded">estado</code> — Ver estado del job actual</div>
        <div><code className="text-xs bg-muted px-1 py-0.5 rounded">ayuda</code> — Mostrar este mensaje</div>
      </div>
    </div>
    ```

    **type: 'progress'** — Live counter (rendered inline, but mostly progress-indicator handles this):
    ```tsx
    <div className="text-sm text-muted-foreground">
      Procesando: {message.current}/{message.total}
    </div>
    ```

  **command-input.tsx** ('use client'):
  Input bar with text input + quick-action chips.

  Props:
  ```typescript
  interface CommandInputProps {
    onCommand: (input: string) => void
    onCommandWithConfirmation: (command: string) => void
    isDisabled: boolean
  }
  ```

  Implementation:
  - State: `inputValue: string`
  - State: `showConfirmation: string | null` (stores the command waiting for confirmation)
  - Text input:
    - Placeholder: isDisabled ? "Job en progreso..." : "Escribe un comando..."
    - Disabled when isDisabled is true
    - On Enter key: call `onCommand(inputValue)`, clear input
    - Use shadcn Input or HTML input with Tailwind classes
  - Quick-action chips (above or below the input, horizontal row):
    - Three buttons: "Subir ordenes", "Estado", "Ayuda"
    - Each styled as small outline/ghost badges/buttons
    - Icons: Upload (or Truck) for subir, Activity for estado, HelpCircle for ayuda
    - Disabled when isDisabled is true
    - On click for "Subir ordenes": show confirmation dialog (use a simple inline confirmation, NOT a modal)
      - Show: "Confirmar: subir ordenes a Coordinadora?" with "Confirmar" and "Cancelar" buttons
      - On confirm: call `onCommandWithConfirmation('subir ordenes coord')`, hide confirmation
    - On click for "Estado" and "Ayuda": call `onCommand()` directly (no confirmation needed)
  - Layout:
    ```tsx
    <div className="border-t p-4 space-y-3">
      {/* Quick action chips */}
      <div className="flex items-center gap-2">
        {showConfirmation ? (
          <div className="flex items-center gap-2 text-sm">
            <span>Confirmar: subir ordenes a Coordinadora?</span>
            <Button size="sm" onClick={handleConfirm}>Confirmar</Button>
            <Button size="sm" variant="ghost" onClick={() => setShowConfirmation(null)}>Cancelar</Button>
          </div>
        ) : (
          <>
            <Button size="sm" variant="outline" disabled={isDisabled} onClick={() => setShowConfirmation('subir ordenes coord')}>
              <Upload className="h-3.5 w-3.5 mr-1.5" />Subir ordenes
            </Button>
            <Button size="sm" variant="outline" disabled={isDisabled} onClick={() => onCommand('estado')}>
              <Activity className="h-3.5 w-3.5 mr-1.5" />Estado
            </Button>
            <Button size="sm" variant="outline" disabled={isDisabled} onClick={() => onCommand('ayuda')}>
              <HelpCircle className="h-3.5 w-3.5 mr-1.5" />Ayuda
            </Button>
          </>
        )}
      </div>
      {/* Text input */}
      <div className="flex items-center gap-2">
        <Input
          value={inputValue}
          onChange={e => setInputValue(e.target.value)}
          onKeyDown={handleKeyDown}
          placeholder={isDisabled ? 'Job en progreso...' : 'Escribe un comando...'}
          disabled={isDisabled}
          className="flex-1"
        />
        <Button size="icon" variant="ghost" disabled={isDisabled || !inputValue.trim()} onClick={handleSubmit}>
          <Send className="h-4 w-4" />
        </Button>
      </div>
    </div>
    ```

  **progress-indicator.tsx** ('use client'):
  Compact live counter shown during active job.

  Props:
  ```typescript
  interface ProgressIndicatorProps {
    successCount: number
    errorCount: number
    totalItems: number
  }
  ```

  Implementation:
  - Shows a horizontal bar with:
    - Progress bar (shadcn Progress component): value = ((successCount + errorCount) / totalItems) * 100
    - Text: "{successCount + errorCount}/{totalItems} procesadas"
    - Badge for successes (green): "{successCount} exitosas"
    - Badge for errors (red, only if > 0): "{errorCount} errores"
  - Animated: use `transition-all` on progress bar width
  - Layout:
    ```tsx
    <div className="border-t px-4 py-2 bg-muted/50">
      <div className="flex items-center gap-3 text-sm">
        <Loader2 className="h-4 w-4 animate-spin text-primary" />
        <span className="font-medium">{processed}/{totalItems} procesadas</span>
        {successCount > 0 && <Badge variant="outline" className="text-green-600 border-green-300">{successCount} exitosas</Badge>}
        {errorCount > 0 && <Badge variant="destructive">{errorCount} errores</Badge>}
      </div>
      <Progress value={percentage} className="mt-2 h-1.5" />
    </div>
    ```

  Import icons from lucide-react: ChevronRight, AlertCircle, Upload, Activity, HelpCircle, Send, Loader2.
  Import shadcn components: ScrollArea, Button, Input, Badge, Progress.
  </action>
  <verify>
  - `npx tsc --noEmit` passes
  - All command types render appropriate UI (command echo, system info, error, result, help, progress)
  - Quick-action chips show confirmation for "Subir ordenes" but not for others
  - Input is disabled when isExecuting is true
  - Progress indicator shows live counter with progress bar
  - Auto-scroll to bottom on new messages
  </verify>
  <done>Command panel components complete: scrollable output with per-type rendering, input bar with chips and confirmation, live progress indicator with animated counter.</done>
</task>

<task type="auto">
  <name>Task 3: History panel with job list and expandable detail</name>
  <files>src/app/(dashboard)/comandos/components/history-panel.tsx</files>
  <action>
  **history-panel.tsx** ('use client'):
  Right panel showing job history in reverse chronological order.

  Props:
  ```typescript
  interface HistoryPanelProps {
    history: RobotJob[]
    onRefresh: () => void
  }
  ```

  Implementation:

  **State:**
  - `expandedJobId: string | null` — which job is expanded to show details
  - `expandedItems: RobotJobItem[] | null` — items for the expanded job
  - `isLoadingItems: boolean` — loading state for item fetch

  **Header:**
  ```tsx
  <div className="h-12 flex items-center justify-between px-4 border-b">
    <h2 className="text-sm font-semibold">Historial de Jobs</h2>
    <Button size="icon" variant="ghost" onClick={onRefresh}>
      <RefreshCw className="h-4 w-4" />
    </Button>
  </div>
  ```

  **Job list (ScrollArea):**
  Map over history array. Each job is a clickable row that expands to show details.

  **Job row (collapsed):**
  ```tsx
  <div
    className={cn(
      "p-3 border-b cursor-pointer hover:bg-accent/50 transition-colors",
      expandedJobId === job.id && "bg-accent/30"
    )}
    onClick={() => handleToggleExpand(job.id)}
  >
    <div className="flex items-center justify-between">
      <div className="text-sm font-medium">
        {formatDate(job.created_at)}
      </div>
      <StatusBadge status={job.status} />
    </div>
    <div className="flex items-center gap-2 mt-1 text-xs text-muted-foreground">
      <span>{job.total_items} ordenes</span>
      <span>·</span>
      <span className="text-green-600 dark:text-green-400">{job.success_count} ok</span>
      {job.error_count > 0 && (
        <>
          <span>·</span>
          <span className="text-destructive">{job.error_count} err</span>
        </>
      )}
    </div>
  </div>
  ```

  **StatusBadge** (inline helper):
  ```typescript
  function StatusBadge({ status }: { status: RobotJob['status'] }) {
    const config = {
      pending: { label: 'Pendiente', variant: 'outline' as const },
      processing: { label: 'Procesando', variant: 'default' as const },
      completed: { label: 'Completado', variant: 'outline' as const, className: 'border-green-300 text-green-600' },
      failed: { label: 'Fallido', variant: 'destructive' as const },
    }
    const c = config[status]
    return <Badge variant={c.variant} className={cn("text-xs", c.className)}>{c.label}</Badge>
  }
  ```

  **Job row (expanded):**
  When a job is expanded and items are loaded, show a detail section below the row:
  ```tsx
  {expandedJobId === job.id && expandedItems && (
    <div className="px-3 pb-3 space-y-1">
      {expandedItems.map(item => (
        <div key={item.id} className="flex items-center justify-between text-xs py-1 border-b border-dashed last:border-0">
          <span className="truncate max-w-[60%]">
            {/* Use order_id or order name if available from the item */}
            {item.order_id.slice(0, 8)}...
          </span>
          <div className="flex items-center gap-2">
            {item.status === 'success' && (
              <span className="text-green-600 dark:text-green-400">
                #{item.tracking_number}
              </span>
            )}
            {item.status === 'error' && (
              <span className="text-destructive truncate max-w-[120px]" title={item.error_message || ''}>
                {item.error_message || 'Error'}
              </span>
            )}
            <Badge variant={item.status === 'success' ? 'outline' : item.status === 'error' ? 'destructive' : 'secondary'} className="text-[10px] px-1.5">
              {item.status}
            </Badge>
          </div>
        </div>
      ))}
    </div>
  )}
  ```

  **handleToggleExpand:**
  ```typescript
  const handleToggleExpand = async (jobId: string) => {
    if (expandedJobId === jobId) {
      // Collapse
      setExpandedJobId(null)
      setExpandedItems(null)
      return
    }
    // Expand: fetch items via server action
    setExpandedJobId(jobId)
    setIsLoadingItems(true)
    try {
      const result = await getJobItemsForHistory(jobId)
      if (result.success) {
        setExpandedItems(result.data!)
      }
    } finally {
      setIsLoadingItems(false)
    }
  }
  ```

  NOTE: You'll need to add a `getJobItemsForHistory` server action in `comandos.ts` (or reuse `getJobStatus` with the specific jobId). Add this as a simple wrapper:
  ```typescript
  // In src/app/actions/comandos.ts
  export async function getJobItemsForHistory(jobId: string): Promise<CommandResult<RobotJobItem[]>> {
    const auth = await getAuthContext()
    if ('error' in auth) return { success: false, error: auth.error }
    const ctx: DomainContext = { workspaceId: auth.workspaceId, source: 'server-action' }
    const result = await getJobWithItems(ctx, jobId)
    if (!result.success) return { success: false, error: result.error }
    return { success: true, data: result.data!.items }
  }
  ```

  **Empty state:**
  If history is empty, show a centered message:
  ```tsx
  <div className="flex-1 flex items-center justify-center text-sm text-muted-foreground">
    No hay trabajos anteriores
  </div>
  ```

  **Date formatting:**
  Use `toLocaleString('es-CO', { timeZone: 'America/Bogota', day: '2-digit', month: 'short', hour: '2-digit', minute: '2-digit' })` for compact display.

  Import: Badge, Button, ScrollArea from shadcn. RefreshCw, ChevronDown from lucide-react. cn from @/lib/utils.
  </action>
  <verify>
  - `npx tsc --noEmit` passes
  - History panel shows jobs in reverse chronological order
  - Clicking a job expands it to show per-item details
  - Empty state renders when no jobs exist
  - Status badges have correct colors for each status
  - Date formatting uses America/Bogota timezone
  </verify>
  <done>History panel complete: scrollable job list with expandable detail rows, status badges, date formatting, and empty state.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
  Complete Chat de Comandos UI module:
  - /comandos page accessible from sidebar (between Tareas and Automatizaciones)
  - Split panel layout matching Sandbox design (Allotment)
  - Left panel: command output with typed messages, input with quick-action chips, live progress indicator
  - Right panel: job history with expandable detail rows
  - Command parsing: "subir ordenes coord", "estado", "ayuda", unknown command handling
  - Chip buttons with confirmation for "Subir ordenes"
  - Input disabled during job execution
  - Active job detection on page load (reconnect scenario)
  </what-built>
  <how-to-verify>
  1. Navigate to the deployed app and confirm "Comandos" appears in sidebar between "Tareas" and "Automatizaciones"
  2. Click "Comandos" -- verify split panel loads (left: command area, right: history)
  3. Type "ayuda" and press Enter -- verify help text appears with command list
  4. Type "estado" -- verify "No hay job activo" message
  5. Click "Subir ordenes" chip -- verify confirmation appears ("Confirmar: subir ordenes a Coordinadora?")
  6. Click "Cancelar" on confirmation -- verify it dismisses
  7. Verify the history panel shows "No hay trabajos anteriores" if empty
  8. Verify input placeholder changes to "Job en progreso..." when disabled (simulate by checking UI state)
  9. Verify the overall look matches MorfX design system (not dark terminal style)
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with no errors
2. `/comandos` page loads without SSR errors
3. Sidebar shows "Comandos" with Terminal icon, only for admin/owner roles
4. Split panel renders with Allotment (left: commands, right: history)
5. All three commands work: subir ordenes coord, estado, ayuda
6. Quick-action chips render and handle confirmation correctly
7. Progress indicator shows during active job
8. History panel lists past jobs with expandable details
9. Reconnect on page load detects active job
</verification>

<success_criteria>
- Complete /comandos module accessible from sidebar
- Command interaction: type commands or click chips
- Live progress via Realtime during active job
- Job history with expandable per-order detail
- Matches MorfX design system (not terminal/dark)
- Input locked during execution with clear feedback
- Reconnect to active job on page revisit
</success_criteria>

<output>
After completion, create `.planning/phases/24-chat-de-comandos-ui/24-03-SUMMARY.md`
</output>
