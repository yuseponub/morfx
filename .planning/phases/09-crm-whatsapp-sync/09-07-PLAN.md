---
phase: 09-crm-whatsapp-sync
plan: 07
type: execute
wave: 4
depends_on: ["09-04", "09-05"]
files_modified:
  - src/app/(dashboard)/crm/contactos/[id]/components/whatsapp-section.tsx
  - src/app/(dashboard)/crm/contactos/[id]/page.tsx
  - src/app/actions/contacts.ts
autonomous: true

must_haves:
  truths:
    - "Contact detail page shows conversation tags from linked conversations"
    - "CRM shows WhatsApp conversation context for the contact"
    - "Tags added in WhatsApp appear in CRM contact view"
  artifacts:
    - path: "src/app/(dashboard)/crm/contactos/[id]/components/whatsapp-section.tsx"
      provides: "WhatsApp conversation summary in CRM"
      exports: ["WhatsAppSection"]
    - path: "src/app/(dashboard)/crm/contactos/[id]/page.tsx"
      provides: "Contact detail page with WhatsApp section"
      contains: "WhatsAppSection"
  key_links:
    - from: "WhatsAppSection"
      to: "getContactConversations"
      via: "server action"
      pattern: "getContactConversations"
---

<objective>
Show WhatsApp conversation data in CRM contact detail view.

Purpose: This plan implements the reverse direction of sync - showing WhatsApp conversation tags and status in the CRM contact detail page. This completes the bidirectional sync by ensuring data flows both ways.

Output: WhatsAppSection component for CRM contact page, server action to fetch conversations by contact.
</objective>

<execution_context>
@/home/jose147/.claude/get-shit-done/workflows/execute-plan.md
@/home/jose147/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-crm-whatsapp-sync/09-CONTEXT.md
@.planning/phases/09-crm-whatsapp-sync/09-RESEARCH.md
@.planning/phases/09-crm-whatsapp-sync/09-04-SUMMARY.md
@.planning/phases/09-crm-whatsapp-sync/09-05-SUMMARY.md

# Existing CRM structure
@src/app/(dashboard)/crm/contactos/[id]/page.tsx
@src/app/actions/contacts.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add server action to fetch conversations by contact</name>
  <files>src/app/actions/contacts.ts</files>
  <action>
Add a new server action to fetch WhatsApp conversations linked to a contact.

Add this function at the end of the contacts.ts file:

```typescript
// ============================================================================
// WhatsApp Integration
// ============================================================================

/**
 * Conversation summary for display in CRM contact page.
 */
export interface ContactConversationSummary {
  id: string
  phone: string
  status: string
  last_message_at: string | null
  last_message_preview: string | null
  unread_count: number
  tags: Array<{ id: string; name: string; color: string }>
}

/**
 * Get WhatsApp conversations linked to a contact.
 * Returns conversations with their conversation-specific tags.
 */
export async function getContactConversations(
  contactId: string
): Promise<ContactConversationSummary[]> {
  const supabase = await createClient()

  const { data: { user } } = await supabase.auth.getUser()
  if (!user) {
    return []
  }

  const { data, error } = await supabase
    .from('conversations')
    .select(`
      id,
      phone,
      status,
      last_message_at,
      last_message_preview,
      unread_count,
      conversation_tags:conversation_tags(tag:tags(id, name, color))
    `)
    .eq('contact_id', contactId)
    .order('last_message_at', { ascending: false, nullsFirst: false })

  if (error) {
    console.error('Error fetching contact conversations:', error)
    return []
  }

  // Transform to summary format
  return (data || []).map((conv) => {
    const tags = (conv.conversation_tags || [])
      .map((ct: { tag: { id: string; name: string; color: string } | null }) => ct.tag)
      .filter((tag): tag is { id: string; name: string; color: string } => tag !== null)

    return {
      id: conv.id,
      phone: conv.phone,
      status: conv.status,
      last_message_at: conv.last_message_at,
      last_message_preview: conv.last_message_preview,
      unread_count: conv.unread_count,
      tags,
    }
  })
}
```
  </action>
  <verify>
```bash
cd /mnt/c/Users/Usuario/Proyectos/morfx-new && npx tsc --noEmit src/app/actions/contacts.ts
```
  </verify>
  <done>
contacts.ts exports getContactConversations function.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create WhatsAppSection component for CRM</name>
  <files>src/app/(dashboard)/crm/contactos/[id]/components/whatsapp-section.tsx</files>
  <action>
Create a component that displays WhatsApp conversation information in the CRM contact detail page.

```typescript
'use client'

import { useState, useEffect } from 'react'
import Link from 'next/link'
import { formatDistanceToNow } from 'date-fns'
import { es } from 'date-fns/locale'
import { MessageCircle, ExternalLink, Inbox } from 'lucide-react'
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card'
import { Badge } from '@/components/ui/badge'
import { Button } from '@/components/ui/button'
import { Separator } from '@/components/ui/separator'
import { TagBadge } from '@/components/contacts/tag-badge'
import { getContactConversations, type ContactConversationSummary } from '@/app/actions/contacts'

interface WhatsAppSectionProps {
  contactId: string
}

/**
 * WhatsApp conversation summary section for CRM contact detail page.
 * Shows linked conversations with their tags and last message info.
 */
export function WhatsAppSection({ contactId }: WhatsAppSectionProps) {
  const [conversations, setConversations] = useState<ContactConversationSummary[]>([])
  const [isLoading, setIsLoading] = useState(true)

  useEffect(() => {
    async function fetchConversations() {
      setIsLoading(true)
      try {
        const data = await getContactConversations(contactId)
        setConversations(data)
      } catch (error) {
        console.error('Error fetching conversations:', error)
      } finally {
        setIsLoading(false)
      }
    }

    fetchConversations()
  }, [contactId])

  if (isLoading) {
    return (
      <Card>
        <CardHeader>
          <CardTitle className="text-sm font-medium flex items-center gap-2">
            <MessageCircle className="h-4 w-4" />
            WhatsApp
          </CardTitle>
        </CardHeader>
        <CardContent>
          <div className="space-y-2">
            {[1, 2].map((i) => (
              <div key={i} className="h-16 bg-muted/50 rounded animate-pulse" />
            ))}
          </div>
        </CardContent>
      </Card>
    )
  }

  if (conversations.length === 0) {
    return (
      <Card>
        <CardHeader>
          <CardTitle className="text-sm font-medium flex items-center gap-2">
            <MessageCircle className="h-4 w-4" />
            WhatsApp
          </CardTitle>
        </CardHeader>
        <CardContent>
          <div className="text-center py-4">
            <Inbox className="h-8 w-8 mx-auto text-muted-foreground mb-2" />
            <p className="text-sm text-muted-foreground">
              Sin conversaciones de WhatsApp
            </p>
            <Button variant="outline" size="sm" className="mt-3" asChild>
              <Link href="/whatsapp">
                Ir a WhatsApp
              </Link>
            </Button>
          </div>
        </CardContent>
      </Card>
    )
  }

  return (
    <Card>
      <CardHeader>
        <CardTitle className="text-sm font-medium flex items-center gap-2">
          <MessageCircle className="h-4 w-4" />
          WhatsApp
          {conversations.some(c => c.unread_count > 0) && (
            <Badge variant="default" className="ml-auto">
              {conversations.reduce((sum, c) => sum + c.unread_count, 0)} sin leer
            </Badge>
          )}
        </CardTitle>
      </CardHeader>
      <CardContent className="space-y-3">
        {conversations.map((conv, index) => (
          <div key={conv.id}>
            {index > 0 && <Separator className="my-3" />}
            <div className="space-y-2">
              {/* Conversation header */}
              <div className="flex items-center justify-between">
                <div className="flex items-center gap-2">
                  <span className="text-sm font-medium">{conv.phone}</span>
                  {conv.unread_count > 0 && (
                    <Badge variant="secondary" className="h-5">
                      {conv.unread_count}
                    </Badge>
                  )}
                  {conv.status === 'archived' && (
                    <Badge variant="outline" className="text-xs">
                      Archivado
                    </Badge>
                  )}
                </div>
                <Link
                  href={`/whatsapp?conversation=${conv.id}`}
                  className="text-primary hover:underline text-sm flex items-center gap-1"
                >
                  <ExternalLink className="h-3 w-3" />
                  Ver chat
                </Link>
              </div>

              {/* Last message preview */}
              {conv.last_message_preview && (
                <div className="text-sm text-muted-foreground">
                  <span className="line-clamp-1">{conv.last_message_preview}</span>
                  {conv.last_message_at && (
                    <span className="text-xs ml-2">
                      {formatDistanceToNow(new Date(conv.last_message_at), {
                        addSuffix: true,
                        locale: es,
                      })}
                    </span>
                  )}
                </div>
              )}

              {/* Conversation tags */}
              {conv.tags.length > 0 && (
                <div className="flex flex-wrap gap-1">
                  <span className="text-xs text-muted-foreground mr-1">Etiquetas de chat:</span>
                  {conv.tags.map((tag) => (
                    <TagBadge key={tag.id} tag={tag} size="sm" />
                  ))}
                </div>
              )}
            </div>
          </div>
        ))}

        {/* View all in WhatsApp link */}
        <div className="pt-2">
          <Button variant="ghost" size="sm" className="w-full" asChild>
            <Link href="/whatsapp">
              Ver todas las conversaciones
            </Link>
          </Button>
        </div>
      </CardContent>
    </Card>
  )
}
```
  </action>
  <verify>
```bash
cd /mnt/c/Users/Usuario/Proyectos/morfx-new && npx tsc --noEmit src/app/\\(dashboard\\)/crm/contactos/\\[id\\]/components/whatsapp-section.tsx
```
  </verify>
  <done>
WhatsAppSection component exists with conversation list, tags display, and links to WhatsApp.
  </done>
</task>

<task type="auto">
  <name>Task 3: Add WhatsAppSection to contact detail page</name>
  <files>src/app/(dashboard)/crm/contactos/[id]/page.tsx</files>
  <action>
Update the contact detail page to include the WhatsAppSection component.

Add import at top:
```typescript
import { WhatsAppSection } from './components/whatsapp-section'
```

Find a suitable location in the page layout to add the WhatsApp section. It should be placed:
- In a sidebar or secondary column if the page uses a two-column layout
- Below contact info but above or alongside orders/notes if single column

Look for the existing page structure. Common patterns:
1. If using a grid layout with sidebar, add to sidebar
2. If using tabs, add as a new tab or section within existing tab
3. If single column, add after contact info section

Example integration (depends on existing layout):

If there's a sidebar/right column:
```tsx
<div className="lg:col-span-1 space-y-4">
  <WhatsAppSection contactId={contact.id} />
  {/* ... other sidebar content ... */}
</div>
```

Or if tabs are used, add within the info tab or as separate section:
```tsx
{/* After contact basic info */}
<WhatsAppSection contactId={contact.id} />
```

If the page uses a card-based layout:
```tsx
<div className="grid gap-4 md:grid-cols-2">
  {/* ... existing cards ... */}
  <WhatsAppSection contactId={contact.id} />
</div>
```

The component handles its own loading and empty states, so just needs to receive the contactId.
  </action>
  <verify>
```bash
cd /mnt/c/Users/Usuario/Proyectos/morfx-new && npx tsc --noEmit src/app/\\(dashboard\\)/crm/contactos/\\[id\\]/page.tsx
```

Manually verify:
1. Navigate to /crm/contactos/[any-contact-id]
2. WhatsAppSection appears
3. Conversations display if any linked
4. Click "Ver chat" navigates to WhatsApp
  </verify>
  <done>
Contact detail page includes WhatsAppSection showing linked conversations and their tags.
  </done>
</task>

</tasks>

<verification>
1. TypeScript compiles without errors
2. Contact detail page shows WhatsApp section
3. Conversations with tags display correctly
4. Links navigate to WhatsApp inbox
5. Empty state shows for contacts without conversations
</verification>

<success_criteria>
- CRM contact page shows WhatsApp conversation summary
- Conversation tags from WhatsApp are visible in CRM
- "Ver chat" link opens correct conversation in WhatsApp
- Empty state displays when no conversations linked
- Data flows bidirectionally between CRM and WhatsApp
</success_criteria>

<output>
After completion, create `.planning/phases/09-crm-whatsapp-sync/09-07-SUMMARY.md`
</output>
