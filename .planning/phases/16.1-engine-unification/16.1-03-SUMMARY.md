---
phase: 16.1
plan: 03
subsystem: engine-adapters
tags: [adapters, ports-and-adapters, sandbox, production, hexagonal-architecture]
dependency-graph:
  requires: [16.1-01]
  provides: [sandbox-adapters, production-adapters, adapter-factories]
  affects: [16.1-04, 16.1-05, 16.1-06]
tech-stack:
  added: []
  patterns: [ports-and-adapters, adapter-factory, dynamic-import, non-blocking-events]
key-files:
  created:
    - src/lib/agents/engine-adapters/sandbox/storage.ts
    - src/lib/agents/engine-adapters/sandbox/timer.ts
    - src/lib/agents/engine-adapters/sandbox/messaging.ts
    - src/lib/agents/engine-adapters/sandbox/orders.ts
    - src/lib/agents/engine-adapters/sandbox/debug.ts
    - src/lib/agents/engine-adapters/sandbox/index.ts
    - src/lib/agents/engine-adapters/production/storage.ts
    - src/lib/agents/engine-adapters/production/timer.ts
    - src/lib/agents/engine-adapters/production/messaging.ts
    - src/lib/agents/engine-adapters/production/orders.ts
    - src/lib/agents/engine-adapters/production/debug.ts
    - src/lib/agents/engine-adapters/production/index.ts
    - src/lib/agents/engine-adapters/index.ts
  modified: []
decisions:
  - "SandboxStorageAdapter adds created_at/updated_at/last_activity_at to mock session for AgentSessionWithState compat"
  - "SandboxOrdersAdapter uses dynamic import for crmOrchestrator to avoid circular deps"
  - "ProductionTimerAdapter emits 5 distinct Inngest events covering all 4 lifecycle points"
  - "ProductionMessagingAdapter creates its own MessageSequencer instance (no reuse needed)"
  - "ProductionStorageAdapter uses 'as unknown as AgentSessionLike' cast since AgentSessionWithState structurally extends AgentSessionLike"
metrics:
  duration: "10 minutes"
  completed: "2026-02-10"
  tasks: "2/2"
  files-created: 13
  files-modified: 0
  lines-added: ~1087
---

# Phase 16.1 Plan 03: Adapter Implementations Summary

**One-liner:** 10 adapter classes (5 sandbox + 5 production) encapsulating all environment-specific I/O behind Plan 01 interfaces, with factory functions for each environment.

## Tasks Completed

### Task 1: Sandbox Adapter Implementations
- **SandboxStorageAdapter**: In-memory state management. Builds mock AgentSessionLike from SandboxState with the CRITICAL invariant of using intentsVistos BEFORE current intent (preserves primera_vez detection for TemplateManager).
- **SandboxTimerAdapter**: Accumulates TimerSignal objects with overwrite semantics. Supports the two-step signal pattern (cancel ingest + start promo) by always keeping only the last signal.
- **SandboxMessagingAdapter**: No-op implementation. Messages returned via EngineOutput for frontend rendering with configurable delays.
- **SandboxOrdersAdapter**: Routes to CrmOrchestrator with dry-run/live mode. Adds mode annotation to tool calls for debug panel visibility.
- **SandboxDebugAdapter**: Accumulates intent, tools, tokens, and state for DebugTurn construction. Provides reset() for reuse between turns.
- **createSandboxAdapters()**: Factory function returning complete EngineAdapters bundle.

### Task 2: Production Adapter Implementations + Barrels
- **ProductionStorageAdapter**: Full delegation to SessionManager for all DB operations (getSession, getOrCreateSession, getHistory from agent_turns, saveState, updateMode with optimistic locking, addTurn, addIntentSeen, handoff).
- **ProductionTimerAdapter**: Emits 5 Inngest events at 4 lifecycle points: agent/customer.message (timer cancellation), agent/collecting_data.started and agent/promos.offered (mode transitions), agent/ingest.started (data collection timer), agent/ingest.completed (cancel timer). All non-blocking with dynamic import.
- **ProductionMessagingAdapter**: Uses MessageSequencer for delayed WhatsApp sending with interruption detection and pending message merging.
- **ProductionOrdersAdapter**: Uses OrderCreator for direct DB order creation. Validates required contact data before creation.
- **ProductionDebugAdapter**: All no-ops. Debug info handled by module logger at engine level.
- **createProductionAdapters()**: Factory function with optional SessionManager reuse.
- **Root barrel**: Re-exports both factory functions.

## Decisions Made

| Decision | Rationale |
|----------|-----------|
| Mock session includes created_at/updated_at/last_activity_at | AgentSessionWithState (used by orchestrator) requires these fields beyond AgentSessionLike |
| Dynamic import for crmOrchestrator in SandboxOrdersAdapter | Avoids circular dependency between engine-adapters and crm module |
| ProductionTimerAdapter emits 5 events (not 4 method calls) | Mode transition emits 2 different events (collecting_data.started, promos.offered) depending on target mode |
| Cast AgentSessionWithState as unknown as AgentSessionLike | Structural compatibility - AgentSessionWithState has all fields of AgentSessionLike plus extras |
| SandboxTimerAdapter.reset() and SandboxDebugAdapter.reset() | Convenience methods for adapter reuse between turns (not in interface, extra public methods) |

## Deviations from Plan

None - plan executed exactly as written.

## Verification

- `npx tsc --noEmit` passes (0 errors outside .next/ generated files)
- All 10 adapter classes implement their respective interfaces from engine/types.ts
- createSandboxAdapters() returns valid EngineAdapters bundle
- createProductionAdapters() returns valid EngineAdapters bundle
- All must-have truths verified via grep on source files

## Commits

| Hash | Message |
|------|---------|
| 7499589 | feat(16.1-03): create sandbox adapter implementations |
| 1ff2adc | feat(16.1-03): create production adapter implementations and barrel exports |

## Next Phase Readiness

Plan 04 (UnifiedEngine) can now use both adapter factories:
- `createSandboxAdapters()` for sandbox API route
- `createProductionAdapters()` for webhook-processor

The adapters are fully independent of Plan 02 (SomnioAgent extraction) - they only depend on Plan 01 types.
