---
phase: 20-integration-automations
plan: 05
type: execute
wave: 3
depends_on: ["20-01", "20-03"]
files_modified:
  - src/app/(dashboard)/configuracion/integraciones/page.tsx
  - src/app/(dashboard)/configuracion/integraciones/components/twilio-form.tsx
  - src/app/(dashboard)/configuracion/integraciones/components/twilio-usage.tsx
  - src/app/(dashboard)/configuracion/integraciones/components/shopify-form.tsx
  - src/lib/actions/integrations.ts
autonomous: true

must_haves:
  truths:
    - "User can see Twilio tab on /configuracion/integraciones page"
    - "User can enter Twilio credentials (Account SID, Auth Token, Phone Number)"
    - "User can test Twilio connection which sends a test SMS"
    - "Auth Token is masked after save (shows ****XXXX)"
    - "Twilio usage dashboard shows SMS count, total cost, and recent messages"
    - "Shopify form has auto-sync toggle"
  artifacts:
    - path: "src/app/(dashboard)/configuracion/integraciones/page.tsx"
      provides: "Tab layout with Shopify + Twilio tabs"
      contains: "Twilio"
    - path: "src/app/(dashboard)/configuracion/integraciones/components/twilio-form.tsx"
      provides: "Twilio credentials form with 3 fields + test connection"
      min_lines: 100
    - path: "src/app/(dashboard)/configuracion/integraciones/components/twilio-usage.tsx"
      provides: "SMS usage dashboard with stats and table"
      min_lines: 80
    - path: "src/lib/actions/integrations.ts"
      provides: "Server actions for Twilio config save, test, and usage queries"
      contains: "saveTwilioIntegration"
  key_links:
    - from: "src/app/(dashboard)/configuracion/integraciones/components/twilio-form.tsx"
      to: "src/lib/actions/integrations.ts"
      via: "Server action calls for save and test"
      pattern: "saveTwilioIntegration|testTwilioConnection"
    - from: "src/app/(dashboard)/configuracion/integraciones/components/twilio-usage.tsx"
      to: "src/lib/actions/integrations.ts"
      via: "Server action for fetching SMS usage data"
      pattern: "getSmsUsage"
---

<objective>
Config UI: Twilio credentials form with test connection, SMS usage dashboard, and Shopify auto-sync toggle.

Purpose: After this plan, users can configure Twilio credentials from /configuracion/integraciones, test the connection by sending a test SMS, view SMS usage statistics (total sent, total cost, recent messages with per-message cost), and control whether Shopify auto-creates CRM records via the auto-sync toggle.

Output: Twilio tab in integrations page, credentials form, usage dashboard, Shopify auto-sync toggle.
</objective>

<execution_context>
@/home/jose147/.claude/get-shit-done/workflows/execute-plan.md
@/home/jose147/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/20-integration-automations/20-CONTEXT.md
@.planning/phases/20-integration-automations/20-RESEARCH.md
@src/app/(dashboard)/configuracion/integraciones/page.tsx
@src/app/(dashboard)/configuracion/integraciones/components/shopify-form.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Server actions for Twilio integration management</name>
  <files>src/lib/actions/integrations.ts</files>
  <action>
Find or create `src/lib/actions/integrations.ts`. If it already exists (for Shopify), extend it. If not, create it as a 'use server' module.

Add these server actions (all with auth + role check for owner or admin):

1. `saveTwilioIntegration(formData: { accountSid: string, authToken: string, phoneNumber: string })`
   - Validate auth context (getAuthContext pattern from Phase 17)
   - Check role is 'owner' or 'admin' (per CONTEXT.md: "Owner + Admin pueden configurar integraciones")
   - Upsert into integrations table: type='twilio', config={ account_sid, auth_token, phone_number }, name='Twilio SMS', is_active=true
   - Use createAdminClient (bypasses RLS, validates role in action)
   - Return { success: true } or { error: string }

2. `testTwilioConnection(phoneNumber: string)`
   - Load Twilio config from integrations table
   - Create Twilio client
   - Send test SMS to the provided phoneNumber: body="MorfX: conexion Twilio verificada correctamente"
   - Return { success: true, messageSid } or { error: string }

3. `getTwilioIntegration()`
   - Load integration with type='twilio' for current workspace
   - If exists: return config with auth_token MASKED (show only last 4 chars: "****" + last4)
   - If not: return null

4. `getSmsUsage(period: 'day' | 'week' | 'month')`
   - Query sms_messages for workspace within the period
   - Return:
     - totalSent: number (count)
     - totalCost: number (sum of price where price is not null)
     - pendingCost: number (count where price is null -- awaiting callback)
     - messages: array of recent messages (last 50) with { id, to_number, body (truncated to 100 chars), status, price, price_unit, segments, created_at }
   - Period filter: 'day' = last 24h, 'week' = last 7 days, 'month' = last 30 days

5. `getSmsUsageChart(period: 'week' | 'month')`
   - Query sms_messages grouped by date (day) within the period
   - Return array of { date: string, count: number, cost: number } for chart rendering
   - Use createAdminClient with workspace_id filter

IMPORTANT: Use createAdminClient for ALL queries (Inngest/system context). Validate role in the server action before any mutation. Reuse the existing `getAuthContext` pattern from Phase 17 actions.

For Shopify auto-sync toggle, add:

6. `updateShopifyAutoSync(autoSync: boolean)`
   - Load existing Shopify integration
   - Update config.auto_sync_orders field
   - Return { success: true } or { error: string }
  </action>
  <verify>`grep 'saveTwilioIntegration' src/lib/actions/integrations.ts` -- function exists. `grep 'getSmsUsage' src/lib/actions/integrations.ts` -- function exists.</verify>
  <done>6 server actions exist: saveTwilioIntegration, testTwilioConnection, getTwilioIntegration (with masked auth_token), getSmsUsage, getSmsUsageChart, updateShopifyAutoSync.</done>
</task>

<task type="auto">
  <name>Task 2: Twilio form, usage dashboard, and integrations page tabs</name>
  <files>src/app/(dashboard)/configuracion/integraciones/page.tsx, src/app/(dashboard)/configuracion/integraciones/components/twilio-form.tsx, src/app/(dashboard)/configuracion/integraciones/components/twilio-usage.tsx, src/app/(dashboard)/configuracion/integraciones/components/shopify-form.tsx</files>
  <action>
1. Create `twilio-form.tsx`:
   - Client component ('use client')
   - Form with 3 fields: Account SID (text input), Auth Token (password input with show/hide toggle), Phone Number (text input with E.164 hint)
   - If existing config loaded: show masked auth_token (****XXXX), allow update
   - "Guardar" button calls saveTwilioIntegration
   - "Probar conexion" button: shows input for test phone number, sends test SMS via testTwilioConnection, shows success/error toast
   - Loading states, error handling, success toast via sonner
   - Use react-hook-form (already installed) for form state
   - Visual pattern: copy shopify-form.tsx layout (same card structure, similar field layout)
   - Show connection status badge (Conectado/No configurado) based on whether integration exists

2. Create `twilio-usage.tsx`:
   - Client component ('use client')
   - Period selector: Dia / Semana / Mes (tabs or segmented control)
   - Stats row (3 cards): SMS Enviados (count), Costo Total (USD, 4 decimal places), Pendientes (count where price null)
   - Chart: bar chart or line chart using recharts (already installed) showing daily SMS count + cost. Reuse the pattern from WhatsApp costs chart in `/configuracion/whatsapp/costos/`
   - Table: recent messages (last 50) with columns: Destino (to_number), Mensaje (body truncated), Estado (badge: delivered=green, sent=blue, failed=red, queued=gray), Costo (price in USD or "Pendiente"), Fecha (formatted)
   - Calls getSmsUsage and getSmsUsageChart on mount and period change

3. Update `page.tsx`:
   - Add tab navigation: Shopify | Twilio (use shadcn Tabs component)
   - Shopify tab renders existing shopify-form + sync-status
   - Twilio tab renders twilio-form + twilio-usage (stacked vertically)
   - Default active tab based on URL hash or first tab

4. Update `shopify-form.tsx`:
   - Add "Crear ordenes automaticamente" toggle (Switch component) below existing form fields
   - Toggle calls updateShopifyAutoSync server action
   - Default value: true (backward compatible)
   - Help text: "Cuando esta activado, las ordenes de Shopify crean automaticamente contactos y pedidos en MorfX. Cuando esta desactivado, solo se disparan automatizaciones."
   - Only show toggle when integration is already configured and active

IMPORTANT:
- Twilio category color: teal (text-teal-600 bg-teal-50)
- All USD amounts shown with 4 decimal places (SMS costs are fractions of cents)
- "Pendiente" label for null prices (awaiting Twilio callback)
- Dashboard is read-only; all data comes from sms_messages table
  </action>
  <verify>Navigate to /configuracion/integraciones -- Twilio tab visible. `ls src/app/(dashboard)/configuracion/integraciones/components/twilio-form.tsx src/app/(dashboard)/configuracion/integraciones/components/twilio-usage.tsx` -- both files exist.</verify>
  <done>Integrations page has Shopify + Twilio tabs. Twilio form with 3 fields + test connection. Usage dashboard with stats, chart, and message table. Shopify form has auto-sync toggle.</done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit 2>&1 | grep "integraciones"` -- no type errors
- `grep 'Twilio' src/app/(dashboard)/configuracion/integraciones/page.tsx` -- tab exists
- `ls src/app/(dashboard)/configuracion/integraciones/components/twilio-*.tsx | wc -l` -- 2 files
- `grep 'auto_sync' src/app/(dashboard)/configuracion/integraciones/components/shopify-form.tsx` -- toggle exists
</verification>

<success_criteria>
- Twilio tab renders credentials form and usage dashboard
- Form saves config to integrations table (type=twilio)
- Test connection sends real SMS and shows result
- Auth token masked after save
- Usage dashboard shows SMS stats grouped by day/week/month
- Shopify form has working auto-sync toggle
- Owner and Admin roles can access (not just Owner)
</success_criteria>

<output>
After completion, create `.planning/phases/20-integration-automations/20-05-SUMMARY.md`
</output>
