---
phase: 15.5-somnio-ingest-system
plan: 03
subsystem: agents
tags: [ingest, somnio-engine, sandbox, silent-accumulation, timer-events]

# Dependency graph
requires:
  - phase: 15.5-02
    provides: IngestManager for silent data accumulation
  - phase: 15.5-01
    provides: MessageClassifier for datos/pregunta/mixto/irrelevante
provides:
  - SomnioEngine with integrated IngestManager routing
  - Silent accumulation during collecting_data mode
  - Implicit yes detection for datos outside collecting_data
  - Ingest timer events (started, completed) for Inngest
  - IngestStatus type for sandbox visibility
  - SandboxEngine with ingest tracking and debug output
affects: [15.5-04-inngest-timer-handler, 16-whatsapp-integration]

# Tech tracking
tech-stack:
  added: []
  patterns:
    - Ingest mode routing in main engine
    - Implicit yes detection via classifier
    - Silent accumulation with timer event emission
    - Sandbox debug output for ingest classification

key-files:
  created: []
  modified:
    - src/lib/agents/somnio/somnio-engine.ts
    - src/lib/sandbox/types.ts
    - src/lib/sandbox/sandbox-engine.ts

key-decisions:
  - "Route through IngestManager BEFORE intent detection in collecting_data mode"
  - "Return undefined response (silent) for datos classification"
  - "Emit agent/ingest.started on first data, agent/ingest.completed on 8 fields"
  - "Implicit yes: datos outside collecting_data triggers mode transition + data extraction"
  - "Sandbox shows classification in debug output: [SANDBOX: Silent - clasificacion: datos]"
  - "IngestStatus tracks: active, startedAt, firstDataAt, fieldsAccumulated, timerType, lastClassification"

patterns-established:
  - "Ingest routing: check mode first, route through IngestManager, then normal flow"
  - "Silent return pattern: success=true, response=undefined"
  - "Timer event emission: dynamic import of inngest to avoid circular deps"

# Metrics
duration: 8min
completed: 2026-02-07
---

# Phase 15.5 Plan 03: SomnioEngine Integration Summary

**Integrated IngestManager into SomnioEngine for silent data accumulation during collecting_data mode, with sandbox visibility**

## Performance

- **Duration:** 8 min
- **Started:** 2026-02-07T16:51:09Z
- **Completed:** 2026-02-07T16:59:38Z
- **Tasks:** 3
- **Files modified:** 3

## Accomplishments

- SomnioEngine routes through IngestManager in collecting_data mode
- Returns silent (no response) for 'datos' classification
- Emits agent/ingest.started on first data detection
- Emits agent/ingest.completed when 8 fields complete
- Implicit yes detection: datos outside collecting_data triggers mode transition
- IngestStatus type added to SandboxState for debug visibility
- SandboxEngine shows classification in debug output

## Task Commits

Each task was committed atomically:

1. **Task 1: Integrate IngestManager into SomnioEngine** - `a5383b7` (feat)
2. **Task 2: Add IngestStatus to SandboxState types** - `eb20d85` (feat)
3. **Task 3: Integrate IngestManager into SandboxEngine** - `f07c275` (feat)

## Files Created/Modified

- `src/lib/agents/somnio/somnio-engine.ts` - Integrated ingest mode routing, implicit yes, timer events (+359 lines)
- `src/lib/sandbox/types.ts` - Added IngestStatus interface and field to SandboxState (+25 lines)
- `src/lib/sandbox/sandbox-engine.ts` - Added ingest handling with debug output (+248 lines)

## Decisions Made

- **Ingest routing order:** Check for ingest mode and implicit yes BEFORE intent detection to avoid unnecessary LLM calls
- **Silent response:** Return `response: undefined` to indicate no message should be sent (different from empty string)
- **Timer event emission:** Use dynamic import for inngest client to avoid circular dependency issues
- **Non-blocking events:** Timer event failures are logged but don't fail message processing
- **Sandbox debug format:** Show `[SANDBOX: Silent - clasificacion: datos, confidence: X%]` for visibility

## Deviations from Plan

None - plan executed exactly as written.

## Issues Encountered

None.

## User Setup Required

None - no external service configuration required.

## Next Phase Readiness

- SomnioEngine fully integrated with IngestManager
- SandboxEngine tracks and displays ingest status
- Timer events ready for Inngest function (Plan 04 if needed)
- All exports available from `@/lib/agents/somnio`
- No blockers for next plan

---
*Phase: 15.5-somnio-ingest-system*
*Completed: 2026-02-07*
