---
phase: 13-agent-engine-core
plan: 06
type: execute
wave: 4
depends_on: ["13-02", "13-03", "13-05"]
files_modified:
  - src/inngest/client.ts
  - src/inngest/events.ts
  - src/inngest/functions/agent-timers.ts
  - src/app/api/inngest/route.ts
  - src/lib/agents/index.ts
autonomous: true
user_setup:
  - service: inngest
    why: "Durable workflow orchestration for timer-based agent flows"
    env_vars:
      - name: INNGEST_EVENT_KEY
        source: "Inngest Dashboard -> Settings -> Event Keys -> Create Key"
      - name: INNGEST_SIGNING_KEY
        source: "Inngest Dashboard -> Settings -> Signing Keys"
    dashboard_config:
      - task: "Create Inngest account"
        location: "https://www.inngest.com/"

must_haves:
  truths:
    - "Inngest client is configured and can send events"
    - "Timer workflows wait for customer messages with timeout"
    - "Timeout triggers proactive agent action"
    - "API route serves Inngest functions"
  artifacts:
    - path: "src/inngest/client.ts"
      provides: "Inngest client singleton"
      exports: ["inngest"]
    - path: "src/inngest/events.ts"
      provides: "Agent event type definitions"
      exports: ["AgentEvents"]
    - path: "src/inngest/functions/agent-timers.ts"
      provides: "Timer workflow functions"
      exports: ["dataCollectionTimer", "promosTimer"]
    - path: "src/app/api/inngest/route.ts"
      provides: "Inngest serve endpoint"
      exports: ["GET", "POST", "PUT"]
  key_links:
    - from: "src/inngest/functions/agent-timers.ts"
      to: "src/lib/agents/session-manager.ts"
      via: "SessionManager for state queries"
      pattern: "sessionManager\\."
    - from: "src/inngest/functions/agent-timers.ts"
      to: "src/lib/tools/handlers/whatsapp/index.ts"
      via: "executeToolFromAgent('whatsapp.message.send')"
      pattern: "whatsapp\\.message\\.send"
    - from: "src/app/api/inngest/route.ts"
      to: "src/inngest/client.ts"
      via: "serve function"
      pattern: "serve.*inngest"
---

<objective>
Create Inngest integration for timer-based agent workflows.

Purpose: Inngest provides durable, event-driven workflows that replace n8n's Proactive Timer. The `step.waitForEvent()` function allows waiting for customer messages with timeout, enabling proactive follow-ups without polling.

Output: Inngest client, event types, timer workflow functions, and API route.
</objective>

<execution_context>
@/home/jose147/.claude/get-shit-done/workflows/execute-plan.md
@/home/jose147/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/13-agent-engine-core/13-CONTEXT.md
@.planning/phases/13-agent-engine-core/13-RESEARCH.md
@.planning/phases/13-agent-engine-core/13-01-SUMMARY.md
@.planning/phases/13-agent-engine-core/13-02-SUMMARY.md
@.planning/phases/13-agent-engine-core/13-03-SUMMARY.md
@.planning/phases/13-agent-engine-core/13-05-SUMMARY.md

# Session manager for state access
@src/lib/agents/session-manager.ts
@src/lib/agents/types.ts

# WhatsApp handlers from Phase 12 (already implemented)
# Note: whatsapp.message.send handler exists at src/lib/tools/handlers/whatsapp/index.ts
# It was implemented in Phase 12 Plan 03 - see 12-03-SUMMARY.md for details
@src/lib/tools/handlers/whatsapp/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install Inngest and create client with events</name>
  <files>
src/inngest/client.ts
src/inngest/events.ts
  </files>
  <action>
First, install Inngest:
```bash
cd /mnt/c/Users/Usuario/Proyectos/morfx-new && npm install inngest
```

Create the Inngest client:

```typescript
// src/inngest/client.ts
/**
 * Inngest Client
 * Phase 13: Agent Engine Core
 *
 * Durable workflow orchestration for agent timer workflows.
 * Replaces n8n's Proactive Timer with event-driven architecture.
 */

import { Inngest } from 'inngest'
import type { AgentEvents } from './events'

/**
 * Inngest client for MorfX agent workflows.
 *
 * Used for:
 * - Data collection timeout (6 min)
 * - Promos offer timeout (10 min)
 * - Other time-based agent behaviors
 */
export const inngest = new Inngest({
  id: 'morfx-agents',
  schemas: new Inngest.EventSchemas().fromRecord<AgentEvents>(),
})
```

Create the event type definitions:

```typescript
// src/inngest/events.ts
/**
 * Agent Events
 * Phase 13: Agent Engine Core
 *
 * Type definitions for Inngest events used in agent workflows.
 */

/**
 * All agent-related events.
 *
 * Event naming convention: agent/{entity}.{action}
 */
export type AgentEvents = {
  /**
   * Emitted when an agent session starts.
   */
  'agent/session.started': {
    data: {
      sessionId: string
      workspaceId: string
      agentId: string
      conversationId: string
      contactId: string
      mode: string
    }
  }

  /**
   * Emitted when a customer sends a message.
   * Used to cancel pending timeouts.
   */
  'agent/customer.message': {
    data: {
      sessionId: string
      conversationId: string
      messageId: string
      content: string
    }
  }

  /**
   * Emitted when data collection mode starts.
   * Triggers 6-minute timeout workflow.
   */
  'agent/collecting_data.started': {
    data: {
      sessionId: string
      conversationId: string
      workspaceId: string
    }
  }

  /**
   * Emitted when promos are offered.
   * Triggers 10-minute timeout workflow.
   */
  'agent/promos.offered': {
    data: {
      sessionId: string
      conversationId: string
      workspaceId: string
      packOptions: string[]
    }
  }

  /**
   * Emitted when session should be closed.
   */
  'agent/session.close': {
    data: {
      sessionId: string
      reason: 'timeout' | 'completed' | 'handoff' | 'cancelled'
    }
  }

  /**
   * Emitted to trigger a proactive message.
   */
  'agent/proactive.send': {
    data: {
      sessionId: string
      conversationId: string
      workspaceId: string
      messageType: 'reminder' | 'followup' | 'timeout_warning'
      content?: string
    }
  }
}
```
  </action>
  <verify>
Check npm install succeeded:
```bash
cat /mnt/c/Users/Usuario/Proyectos/morfx-new/package.json | grep "inngest"
```
TypeScript compilation:
```bash
cd /mnt/c/Users/Usuario/Proyectos/morfx-new && npx tsc --noEmit src/inngest/client.ts src/inngest/events.ts
```
Check exports:
```bash
grep "export" src/inngest/client.ts src/inngest/events.ts
```
  </verify>
  <done>
- Inngest installed
- inngest client configured with event schemas
- AgentEvents type defines all agent-related events
- Type-safe event emission
  </done>
</task>

<task type="auto">
  <name>Task 2: Create timer workflow functions</name>
  <files>src/inngest/functions/agent-timers.ts</files>
  <action>
Create the timer workflow functions:

```typescript
// src/inngest/functions/agent-timers.ts
/**
 * Agent Timer Workflows
 * Phase 13: Agent Engine Core
 *
 * Durable timer workflows for proactive agent actions.
 * Uses step.waitForEvent() for timeout-based customer engagement.
 *
 * Replaces n8n's Proactive Timer with event-driven architecture:
 * - No polling loops
 * - Persistent across restarts
 * - Automatic retry on failures
 *
 * Note: Uses whatsapp.message.send handler implemented in Phase 12
 * (src/lib/tools/handlers/whatsapp/index.ts)
 */

import { inngest } from '../client'
import { SessionManager } from '@/lib/agents/session-manager'
import { executeToolFromAgent } from '@/lib/tools/executor'
import { createModuleLogger } from '@/lib/audit/logger'

const logger = createModuleLogger('agent-timers')

// Lazy initialization to avoid circular dependencies
let _sessionManager: SessionManager | null = null
function getSessionManager(): SessionManager {
  if (!_sessionManager) {
    _sessionManager = new SessionManager()
  }
  return _sessionManager
}

/**
 * Data Collection Timer
 *
 * Triggered when agent enters 'collecting_data' mode.
 * Waits for customer message with 6-minute timeout.
 *
 * Flow from CONTEXT.md:
 * - Wait for customer message (6 min timeout)
 * - If timeout without data: send "quedamos pendientes"
 * - If partial data: request missing fields
 * - If complete data: wait 2 min, then offer promos
 */
export const dataCollectionTimer = inngest.createFunction(
  {
    id: 'data-collection-timer',
    name: 'Data Collection Timer',
    retries: 3,
  },
  { event: 'agent/collecting_data.started' },
  async ({ event, step }) => {
    const { sessionId, conversationId, workspaceId } = event.data

    logger.info({ sessionId }, 'Data collection timer started')

    // Update session state to track timer start
    await step.run('mark-timer-start', async () => {
      const sessionManager = getSessionManager()
      await sessionManager.updateState(sessionId, {
        proactive_started_at: new Date().toISOString(),
      })
    })

    // Wait for customer message or timeout after 6 minutes
    const customerMessage = await step.waitForEvent('wait-for-data', {
      event: 'agent/customer.message',
      timeout: '6m',
      match: 'data.sessionId',
    })

    if (!customerMessage) {
      // Timeout: check data status and act accordingly
      const dataStatus = await step.run('check-data-status', async () => {
        const sessionManager = getSessionManager()
        const session = await sessionManager.getSession(sessionId)
        const datos = session.state.datos_capturados

        const required = ['nombre', 'telefono', 'ciudad', 'direccion']
        const missing = required.filter((field) => !datos[field])

        return {
          hasAnyData: Object.keys(datos).length > 0,
          missingFields: missing,
          isComplete: missing.length === 0,
        }
      })

      if (!dataStatus.hasAnyData) {
        // No data at all - send "quedamos pendientes"
        // Uses whatsapp.message.send from Phase 12: src/lib/tools/handlers/whatsapp/index.ts
        await step.run('send-pending-message', async () => {
          await executeToolFromAgent(
            'whatsapp.message.send',
            {
              contactId: conversationId, // Tool uses contactId to find conversation
              message: 'Quedamos pendientes! Cuando tengas un momento, me cuentas para ayudarte con tu pedido.',
            },
            workspaceId,
            sessionId
          )
        })

        return { status: 'timeout', action: 'sent_pending_message' }
      }

      if (!dataStatus.isComplete) {
        // Partial data - request missing fields
        const missingText = dataStatus.missingFields.join(', ')
        await step.run('request-missing-data', async () => {
          await executeToolFromAgent(
            'whatsapp.message.send',
            {
              contactId: conversationId,
              message: `Para continuar con tu pedido, necesito que me confirmes: ${missingText}`,
            },
            workspaceId,
            sessionId
          )
        })

        return { status: 'timeout', action: 'requested_missing_data', missing: dataStatus.missingFields }
      }

      // Complete data but timeout - still transition to promos
      logger.info({ sessionId }, 'Data complete, transitioning to promos after timeout')
    }

    // Check if data is complete
    const isComplete = await step.run('verify-data-complete', async () => {
      const sessionManager = getSessionManager()
      const session = await sessionManager.getSession(sessionId)
      const datos = session.state.datos_capturados
      const required = ['nombre', 'telefono', 'ciudad', 'direccion']
      return required.every((field) => !!datos[field])
    })

    if (isComplete) {
      // Data complete - wait 2 minutes then trigger promos
      await step.sleep('wait-before-promos', '2m')

      await step.run('transition-to-promos', async () => {
        // Emit event to trigger promos workflow
        await inngest.send({
          name: 'agent/promos.offered',
          data: {
            sessionId,
            conversationId,
            workspaceId,
            packOptions: ['1x', '2x', '3x'],
          },
        })

        // Update session mode
        const sessionManager = getSessionManager()
        const session = await sessionManager.getSession(sessionId)
        await sessionManager.updateSessionWithVersion(sessionId, session.version, {
          currentMode: 'ofrecer_promos',
        })
        await sessionManager.updateState(sessionId, {
          ofrecer_promos_at: new Date().toISOString(),
        })
      })

      return { status: 'complete', action: 'transitioned_to_promos' }
    }

    // Customer responded but data still incomplete
    return { status: 'responded', action: 'awaiting_more_data' }
  }
)

/**
 * Promos Timer
 *
 * Triggered when promos are offered to customer.
 * Waits for pack selection with 10-minute timeout.
 *
 * Flow from CONTEXT.md:
 * - Wait for customer response (10 min timeout)
 * - If timeout: auto-create order with default pack
 * - If response: process pack selection
 */
export const promosTimer = inngest.createFunction(
  {
    id: 'promos-timer',
    name: 'Promos Timer',
    retries: 3,
  },
  { event: 'agent/promos.offered' },
  async ({ event, step }) => {
    const { sessionId, conversationId, workspaceId } = event.data

    logger.info({ sessionId }, 'Promos timer started')

    // Wait for customer response or timeout after 10 minutes
    const response = await step.waitForEvent('wait-for-selection', {
      event: 'agent/customer.message',
      timeout: '10m',
      match: 'data.sessionId',
    })

    if (!response) {
      // Timeout: auto-create order with default pack (1x)
      logger.info({ sessionId }, 'Promos timeout, auto-creating order')

      const orderResult = await step.run('auto-create-order', async () => {
        const sessionManager = getSessionManager()
        const session = await sessionManager.getSession(sessionId)
        const datos = session.state.datos_capturados

        // Create order with default pack
        const result = await executeToolFromAgent(
          'crm.order.create',
          {
            contact_id: session.contact_id,
            products: [{ product_id: 'default-pack-1x', quantity: 1 }],
            notes: 'Auto-created after 10 min timeout. Pack: 1x',
          },
          workspaceId,
          sessionId
        )

        // Update session state
        await sessionManager.updateState(sessionId, {
          pack_seleccionado: '1x',
        })

        return result
      })

      // Send confirmation message using whatsapp.message.send from Phase 12
      await step.run('send-order-confirmation', async () => {
        await executeToolFromAgent(
          'whatsapp.message.send',
          {
            contactId: conversationId,
            message: 'He creado tu pedido con el Pack 1x. Un asesor se pondra en contacto contigo pronto para confirmar los detalles.',
          },
          workspaceId,
          sessionId
        )
      })

      // Update session mode
      await step.run('update-session-mode', async () => {
        const sessionManager = getSessionManager()
        const session = await sessionManager.getSession(sessionId)
        await sessionManager.updateSessionWithVersion(sessionId, session.version, {
          currentMode: 'compra_confirmada',
        })
      })

      return { status: 'timeout', action: 'auto_created_order', orderId: orderResult?.outputs?.id }
    }

    // Customer responded - let the main engine process the selection
    return { status: 'responded', action: 'awaiting_selection_processing' }
  }
)

/**
 * All agent timer functions for export.
 */
export const agentTimerFunctions = [
  dataCollectionTimer,
  promosTimer,
]
```
  </action>
  <verify>
TypeScript compilation:
```bash
cd /mnt/c/Users/Usuario/Proyectos/morfx-new && npx tsc --noEmit src/inngest/functions/agent-timers.ts
```
Check waitForEvent usage:
```bash
grep "waitForEvent" src/inngest/functions/agent-timers.ts
```
Check step.sleep usage:
```bash
grep "step.sleep" src/inngest/functions/agent-timers.ts
```
Verify whatsapp.message.send usage:
```bash
grep "whatsapp.message.send" src/inngest/functions/agent-timers.ts
```
  </verify>
  <done>
- dataCollectionTimer: 6-minute timeout for data collection
- promosTimer: 10-minute timeout for pack selection
- step.waitForEvent for event-driven timeouts
- step.sleep for delay before promos
- Tool execution via executeToolFromAgent (uses Phase 12 handlers)
- whatsapp.message.send handler from Phase 12 used for proactive messages
- Session state updates via SessionManager
  </done>
</task>

<task type="auto">
  <name>Task 3: Create Inngest API route and update exports</name>
  <files>
src/app/api/inngest/route.ts
src/lib/agents/index.ts
  </files>
  <action>
Create the Inngest API route:

```typescript
// src/app/api/inngest/route.ts
/**
 * Inngest Serve Route
 * Phase 13: Agent Engine Core
 *
 * API endpoint for Inngest to invoke workflow functions.
 * Must be accessible at /api/inngest for Inngest Cloud to call.
 */

import { serve } from 'inngest/next'
import { inngest } from '@/inngest/client'
import { agentTimerFunctions } from '@/inngest/functions/agent-timers'

/**
 * Serve all Inngest functions.
 * Inngest will call this endpoint to execute functions.
 */
export const { GET, POST, PUT } = serve({
  client: inngest,
  functions: [
    ...agentTimerFunctions,
  ],
})
```

Update src/lib/agents/index.ts to export the inngest client:

Add at the end of the file:
```typescript
// Inngest (re-export for convenience)
export { inngest } from '@/inngest/client'
export type { AgentEvents } from '@/inngest/events'
```
  </action>
  <verify>
TypeScript compilation:
```bash
cd /mnt/c/Users/Usuario/Proyectos/morfx-new && npx tsc --noEmit src/app/api/inngest/route.ts
```
Check route exports:
```bash
grep -E "export.*GET|export.*POST|export.*PUT" src/app/api/inngest/route.ts
```
Verify serve configuration:
```bash
grep "serve" src/app/api/inngest/route.ts
```
  </verify>
  <done>
- /api/inngest route serves all agent timer functions
- GET, POST, PUT handlers exported for Inngest
- inngest client re-exported from agents module
- AgentEvents type re-exported for consumers
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

1. Inngest installed:
```bash
cat /mnt/c/Users/Usuario/Proyectos/morfx-new/package.json | grep "inngest"
```

2. Timer functions defined:
```bash
grep "createFunction" src/inngest/functions/agent-timers.ts
```

3. API route exports:
```bash
grep -E "export.*GET" src/app/api/inngest/route.ts
```

4. Event types defined:
```bash
grep "type AgentEvents" src/inngest/events.ts
```

5. WhatsApp handler available (from Phase 12):
```bash
grep "whatsapp.message.send" src/lib/tools/handlers/whatsapp/index.ts
```

6. TypeScript compiles:
```bash
cd /mnt/c/Users/Usuario/Proyectos/morfx-new && npx tsc --noEmit
```
</verification>

<success_criteria>
- Inngest package installed
- inngest client configured with event schemas
- AgentEvents type defines all agent events
- dataCollectionTimer: 6-min timeout with data status check
- promosTimer: 10-min timeout with auto-order creation
- /api/inngest route serves all functions
- step.waitForEvent used for event-driven timeouts
- step.sleep used for promos delay
- whatsapp.message.send from Phase 12 used for proactive messages
- All TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/13-agent-engine-core/13-06-SUMMARY.md`
</output>
