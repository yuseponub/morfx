---
phase: 09.1-order-states-config
plan: 04
type: execute
wave: 3
depends_on: ["09.1-02", "09.1-03"]
files_modified:
  - src/app/actions/orders.ts
  - src/hooks/use-conversations.ts
autonomous: false

must_haves:
  truths:
    - "Orders query includes order_state join on stage"
    - "Conversations load orders with order_state data"
    - "End-to-end flow works: create state -> assign stage -> order in stage -> emoji on avatar"
  artifacts:
    - path: "src/app/actions/orders.ts"
      provides: "Updated getOrdersForContacts with order_state join"
      contains: "order_state"
    - path: "src/hooks/use-conversations.ts"
      provides: "Orders data includes order_state"
      contains: "order_state"
  key_links:
    - from: "use-conversations.ts"
      to: "orders.ts"
      via: "getOrdersForContacts call"
      pattern: "getOrdersForContacts"
---

<objective>
Wire order data fetching to include order_state and verify end-to-end integration.

Purpose: Ensure orders fetched for WhatsApp conversations include the order_state data needed for emoji indicators. Verify the complete flow from state configuration to indicator display.

Output:
- Updated order queries with order_state join
- Working end-to-end integration
- Human verification of the complete feature
</objective>

<execution_context>
@/home/jose147/.claude/get-shit-done/workflows/execute-plan.md
@/home/jose147/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/09.1-order-states-config/09.1-01-SUMMARY.md
@.planning/phases/09.1-order-states-config/09.1-02-SUMMARY.md
@.planning/phases/09.1-order-states-config/09.1-03-SUMMARY.md

# Files to update
@src/app/actions/orders.ts
@src/hooks/use-conversations.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update order queries to include order_state</name>
  <files>src/app/actions/orders.ts</files>
  <action>
Update the getOrdersForContacts function (and any other order fetching functions that provide data to WhatsApp) to include order_state join.

Find the select statement for stage and add order_state:

Before:
```typescript
stage:pipeline_stages(id, name, color)
```

After:
```typescript
stage:pipeline_stages(
  id,
  name,
  color,
  order_state_id,
  order_state:order_states(id, emoji, name)
)
```

This nested join will include the order_state data when the stage has one assigned.

Also update any OrderSummary mapping to preserve the order_state data.
  </action>
  <verify>
- grep "order_state:order_states" orders.ts returns match
- grep "order_state_id" orders.ts returns match in stage select
  </verify>
  <done>
getOrdersForContacts returns orders with stage.order_state populated when assigned.
  </done>
</task>

<task type="auto">
  <name>Task 2: Verify use-conversations.ts passes order_state data</name>
  <files>src/hooks/use-conversations.ts</files>
  <action>
Verify that use-conversations.ts properly passes the order data with order_state to conversation items.

The hook should already be calling getOrdersForContacts and mapping the results. Ensure the mapping preserves the order_state data on the stage object.

If there's any transformation that strips the order_state, fix it to preserve:

```typescript
// Ensure OrderSummary mapping preserves order_state
const orderSummary: OrderSummary = {
  id: order.id,
  total_value: order.total_value,
  is_closed: order.stage.is_closed,
  stage: {
    id: order.stage.id,
    name: order.stage.name,
    color: order.stage.color,
    order_state_id: order.stage.order_state_id,
    order_state: order.stage.order_state,
  },
}
```

Also check:
1. Type assertions are correct (no `as any` that would lose type safety)
2. The orders are passed to ConversationItem correctly
  </action>
  <verify>
- grep "order_state" use-conversations.ts returns match (either in mapping or comments confirming it passes through)
- TypeScript compiles without errors: pnpm tsc --noEmit
  </verify>
  <done>
use-conversations.ts passes complete order data including order_state to conversation items.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete order states configuration feature:
1. Settings page at /crm/configuracion/estados-pedido for managing order states
2. Each state has name and emoji, reorderable via drag-and-drop
3. Pipeline stages can be assigned to states
4. WhatsApp conversation list shows emoji indicator on avatar corner (Callbell style)
  </what-built>
  <how-to-verify>
1. Start the dev server: pnpm dev (port 3020)
2. Run migration: Apply the new migration to your Supabase database

**Test state creation:**
3. Go to http://localhost:3020/crm/configuracion/estados-pedido
4. Click "Agregar estado"
5. Enter name "En Transito" and select a truck emoji
6. Verify the avatar preview shows the emoji on the corner
7. Save the state

**Test stage assignment:**
8. Click edit on the state you created
9. In stage assignment, check a stage from your pipeline (e.g., "Despachado" or "Enviado")
10. Save changes

**Test indicator display:**
11. Create or move an order to the stage you assigned
12. Ensure the contact has an active WhatsApp conversation
13. Go to http://localhost:3020/whatsapp
14. Find the conversation for that contact
15. Verify the emoji appears on the avatar corner (top-right), not inline with timestamp

**Test fallback:**
16. Create an order in a stage NOT assigned to any order state
17. Verify it shows the hardcoded emoji (hourglass, checkmark, etc.) as fallback

**Test drag-and-drop:**
18. Create 2-3 order states
19. Drag to reorder them
20. Refresh page and verify order persisted

Expected: All tests pass. Emoji indicators work with both configured states and fallback.
  </how-to-verify>
  <resume-signal>Type "approved" if all tests pass, or describe any issues found</resume-signal>
</task>

</tasks>

<verification>
Human verification checkpoint covers end-to-end testing.
</verification>

<success_criteria>
- [x] Order queries include order_state join
- [x] Conversations receive orders with order_state data
- [x] Human verified: state creation works
- [x] Human verified: stage assignment works
- [x] Human verified: emoji indicator on avatar works
- [x] Human verified: drag-and-drop reorder works
- [x] Human verified: fallback to hardcoded works for unassigned stages
</success_criteria>

<output>
After completion, create `.planning/phases/09.1-order-states-config/09.1-04-SUMMARY.md`
</output>
