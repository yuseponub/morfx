---
phase: 15.8-codebase-cleanup
plan: 04
type: execute
wave: 2
depends_on: ["15.8-01", "15.8-02"]
files_modified:
  - src/lib/utils/phone.ts
  - src/lib/agents/somnio/normalizers.ts
  - src/lib/whatsapp/webhook-handler.ts
  - src/lib/supabase/server.ts
  - src/lib/agents/session-manager.ts
  - src/lib/agents/types.ts
  - src/lib/agents/intent-detector.ts
  - src/lib/agents/orchestrator.ts
  - src/lib/agents/somnio/data-extractor.ts
  - src/lib/agents/somnio/config.ts
  - src/lib/agents/somnio/message-classifier.ts
autonomous: true

must_haves:
  truths:
    - "Phone normalization consolidated: single source in src/lib/utils/phone.ts with normalizePhoneRaw export"
    - "Supabase admin client has single implementation, server.ts re-exports from admin.ts"
    - "State factory helper eliminates duplicate state initialization in session-manager.ts"
    - "Model ID constants replace scattered string literals"
    - "TypeScript compiles with zero source errors"
  artifacts:
    - path: "src/lib/utils/phone.ts"
      provides: "Canonical phone normalization with multiple export formats"
      contains: "normalizePhoneRaw"
    - path: "src/lib/agents/types.ts"
      provides: "CLAUDE_MODELS constant object"
      contains: "CLAUDE_MODELS"
    - path: "src/lib/supabase/server.ts"
      provides: "Re-export of createAdminClient from admin.ts"
      contains: "export.*createAdminClient.*from.*admin"
    - path: "src/lib/agents/session-manager.ts"
      provides: "createDefaultSessionState helper function"
      contains: "createDefaultSessionState"
  key_links:
    - from: "src/lib/agents/somnio/normalizers.ts"
      to: "src/lib/utils/phone.ts"
      via: "import normalizePhoneRaw instead of local implementation"
      pattern: "import.*normalizePhoneRaw.*from.*phone"
    - from: "src/lib/whatsapp/webhook-handler.ts"
      to: "src/lib/utils/phone.ts"
      via: "import normalizePhone instead of local implementation"
      pattern: "import.*normalizePhone.*from.*phone"
    - from: "src/lib/agents/intent-detector.ts"
      to: "src/lib/agents/types.ts"
      via: "import CLAUDE_MODELS"
      pattern: "import.*CLAUDE_MODELS.*from.*types"
---

<objective>
Consolidate 4 categories of duplicate code: phone normalization, Supabase admin client, session state factory, and model ID constants.

Purpose: Reduce code duplication to prevent divergence bugs, improve maintainability, and create a clean foundation for Phase 16.
Output: 11 files modified with consolidation changes, all verified by `tsc --noEmit`.
</objective>

<execution_context>
@/home/jose147/.claude/get-shit-done/workflows/execute-plan.md
@/home/jose147/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/codebase/audit/DUPLICATES.md
@.planning/phases/15.8-codebase-cleanup/15.8-RESEARCH.md
@.planning/phases/15.8-codebase-cleanup/15.8-01-SUMMARY.md
@.planning/phases/15.8-codebase-cleanup/15.8-02-SUMMARY.md

Key source files:
@src/lib/utils/phone.ts
@src/lib/agents/somnio/normalizers.ts
@src/lib/whatsapp/webhook-handler.ts
@src/lib/supabase/admin.ts
@src/lib/supabase/server.ts
@src/lib/agents/session-manager.ts
@src/lib/agents/types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Consolidate phone normalization + Supabase admin client</name>
  <files>
    src/lib/utils/phone.ts
    src/lib/agents/somnio/normalizers.ts
    src/lib/whatsapp/webhook-handler.ts
    src/lib/supabase/server.ts
  </files>
  <action>
Consolidate 2 categories of duplicate code.

**Phone Normalization Consolidation:**

1. Read `src/lib/utils/phone.ts` (canonical implementation - returns E.164 with `+`).
2. Read `src/lib/agents/somnio/normalizers.ts` lines 260-292 (returns WITHOUT `+`).
3. Read `src/lib/whatsapp/webhook-handler.ts` lines 470-480 (basic normalization).

4. Add `normalizePhoneRaw` to `src/lib/utils/phone.ts`:
   ```typescript
   /**
    * Normalize phone to E.164 format WITHOUT + prefix.
    * Used by Somnio agent for backward compatibility with datos_capturados format.
    * Example: "300 123 4567" -> "573001234567"
    */
   export function normalizePhoneRaw(input: string): string | null {
     const normalized = normalizePhone(input)
     return normalized ? normalized.replace('+', '') : null
   }
   ```

5. Update `src/lib/agents/somnio/normalizers.ts`:
   - Remove the local `normalizePhone` function (~lines 260-292)
   - Import from phone.ts: `import { normalizePhoneRaw } from '@/lib/utils/phone'`
   - If `normalizePhone` was exported from normalizers.ts and used elsewhere, update the export to re-export `normalizePhoneRaw` as `normalizePhone` for backward compatibility:
     ```typescript
     export { normalizePhoneRaw as normalizePhone } from '@/lib/utils/phone'
     ```
   - Check all files that import `normalizePhone` from `normalizers.ts` and verify they still work

6. Update `src/lib/whatsapp/webhook-handler.ts`:
   - Remove the private `normalizePhone` function (~lines 470-480)
   - Import from phone.ts: `import { normalizePhone } from '@/lib/utils/phone'`
   - Verify the caller at ~line 95 still works (the canonical function returns `string | null`, the old one returned `string` - handle null case)

**Supabase Admin Client Consolidation:**

1. Read `src/lib/supabase/server.ts` lines 36-47 (duplicate `createAdminClient`).
2. Remove the duplicate function definition.
3. Add re-export: `export { createAdminClient } from './admin'`
4. Verify: check which files import `createAdminClient` from `server.ts` vs `admin.ts`:
   ```bash
   grep -rn "from.*supabase/server.*createAdminClient\|createAdminClient.*from.*supabase/server" src/
   ```
   These files should continue working since the re-export maintains the same import path.

After ALL changes, run `npx tsc --noEmit` to verify clean compilation.
Commit: `refactor(15.8-04): consolidate phone normalization and admin client`
  </action>
  <verify>
1. `npx tsc --noEmit` passes with zero source errors
2. Phone: `grep -rn "export function normalizePhoneRaw" src/` shows only phone.ts
3. Phone: `grep -rn "function normalizePhone" src/lib/agents/somnio/normalizers.ts` returns nothing (removed)
4. Phone: `grep -rn "function normalizePhone" src/lib/whatsapp/webhook-handler.ts` returns nothing (removed)
5. Admin: `grep -rn "createAdminClient" src/lib/supabase/server.ts` shows re-export, not function definition
6. Verify all imports resolve: `grep -rn "from.*normalizers.*normalizePhone\|from.*phone.*normalizePhone" src/`
  </verify>
  <done>
- Phone normalization: normalizePhoneRaw added to phone.ts, duplicates removed from normalizers.ts and webhook-handler.ts
- Supabase admin client: server.ts re-exports from admin.ts, duplicate removed
- All import paths verified working
- TypeScript compiles clean
  </done>
</task>

<task type="auto">
  <name>Task 2: Consolidate state factory + model ID constants</name>
  <files>
    src/lib/agents/session-manager.ts
    src/lib/agents/types.ts
    src/lib/agents/intent-detector.ts
    src/lib/agents/orchestrator.ts
    src/lib/agents/somnio/data-extractor.ts
    src/lib/agents/somnio/config.ts
    src/lib/agents/somnio/message-classifier.ts
  </files>
  <action>
Consolidate 2 categories of duplicate code.

**State Factory Pattern (session-manager.ts):**

1. Read `src/lib/agents/session-manager.ts` and find the two places where default state is constructed (~lines 119-129 and ~lines 299-312).
2. Create a private helper function:
   ```typescript
   function createDefaultSessionState(sessionId: string): SessionState {
     return {
       session_id: sessionId,
       intents_vistos: [],
       templates_enviados: [],
       datos_capturados: {},
       pack_seleccionado: null,
       proactive_started_at: null,
       first_data_at: null,
       min_data_at: null,
       ofrecer_promos_at: null,
       updated_at: new Date().toISOString(),
     }
   }
   ```
3. Replace both state construction sites to use this helper.
4. For the `createSession` site, the helper result can be spread with `params.initialState` overrides.

**Model ID Constants:**

1. Add to `src/lib/agents/types.ts`:
   ```typescript
   /** Canonical model identifiers for Claude API */
   export const CLAUDE_MODELS = {
     HAIKU: 'claude-haiku-4-5' as const,
     SONNET: 'claude-sonnet-4-5' as const,
   } as const

   export type ClaudeModelId = typeof CLAUDE_MODELS[keyof typeof CLAUDE_MODELS]
   ```

2. Update string literals in these files:
   - `src/lib/agents/intent-detector.ts` (~line 120): Replace `'claude-haiku-4-5'` with `CLAUDE_MODELS.HAIKU`
   - `src/lib/agents/orchestrator.ts` (~line 145): Replace `'claude-sonnet-4-5'` with `CLAUDE_MODELS.SONNET`
   - `src/lib/agents/somnio/data-extractor.ts` (~line 217): Should already use config from Bug #10 fix in Plan 02. If there are remaining literals, replace.
   - `src/lib/agents/somnio/config.ts` (~lines 102, 109): Replace model strings with constants
   - `src/lib/agents/somnio/message-classifier.ts` (~lines 151, 159): This file uses `'claude-sonnet-4-20250514'` (the direct API model ID). This is the RESOLVED model ID, not the alias. Leave this as-is since it's the direct API call - the MODEL_MAP in claude-client.ts handles the alias resolution. OR if it should use the alias, replace with `CLAUDE_MODELS.SONNET` (the client will resolve it).

   Read each file carefully before replacing to make sure the replacement is correct for the context.

After ALL consolidation changes, run `npx tsc --noEmit` to verify clean compilation.
Commit: `refactor(15.8-04): consolidate state factory and model constants`
  </action>
  <verify>
1. `npx tsc --noEmit` passes with zero source errors
2. State: `grep -n "createDefaultSessionState" src/lib/agents/session-manager.ts` shows helper function used in 2+ places
3. Models: `grep -rn "CLAUDE_MODELS" src/lib/agents/` shows imports in multiple files
4. Verify no remaining hardcoded model strings: `grep -rn "'claude-haiku-4-5'\|'claude-sonnet-4-5'" src/lib/agents/intent-detector.ts src/lib/agents/orchestrator.ts src/lib/agents/somnio/config.ts` returns nothing
  </verify>
  <done>
- State factory: createDefaultSessionState helper used in both initialization sites
- Model constants: CLAUDE_MODELS in types.ts, imported in 4+ files replacing string literals
- TypeScript compiles clean
  </done>
</task>

</tasks>

<verification>
After both tasks complete:
1. `npx tsc --noEmit` passes with zero source errors (GATE)
2. Phone normalization has single source of truth with backward-compatible exports
3. Supabase admin client has single implementation
4. State factory eliminates duplicate construction
5. Model IDs use constants, not string literals
6. All 11 files modified correctly, no broken imports
</verification>

<success_criteria>
1. Phone normalization consolidated to phone.ts with normalizePhoneRaw
2. Supabase admin client unified via re-export
3. State factory helper eliminates duplication
4. CLAUDE_MODELS constants replace string literals
5. TypeScript compiles with zero source errors
6. Each change group committed atomically
</success_criteria>

<output>
After completion, create `.planning/phases/15.8-codebase-cleanup/15.8-04-SUMMARY.md`
</output>
