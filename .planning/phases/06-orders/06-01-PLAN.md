---
phase: 06-orders
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/20260129000003_orders_foundation.sql
  - src/lib/orders/types.ts
autonomous: true

must_haves:
  truths:
    - "Database tables exist for products, pipelines, stages, orders, and order_products"
    - "Order total auto-calculates from product line items via trigger"
    - "RLS policies isolate orders by workspace"
    - "TypeScript types match database schema"
  artifacts:
    - path: "supabase/migrations/20260129000003_orders_foundation.sql"
      provides: "Complete database schema for orders module"
      contains: "CREATE TABLE orders"
    - path: "src/lib/orders/types.ts"
      provides: "TypeScript types for orders, products, pipelines"
      exports: ["Order", "Product", "Pipeline", "PipelineStage", "OrderProduct"]
  key_links:
    - from: "order_products"
      to: "orders.total_value"
      via: "PostgreSQL trigger"
      pattern: "update_order_total"
    - from: "orders.stage_id"
      to: "pipeline_stages.id"
      via: "foreign key ON DELETE RESTRICT"
      pattern: "REFERENCES pipeline_stages"
---

<objective>
Create the complete database foundation for the orders module including products catalog, multi-pipeline support, and order-products junction table.

Purpose: Establish the data layer that supports Kanban boards, multi-products per order, and configurable pipelines
Output: Migration file with all tables/triggers/RLS and TypeScript type definitions
</objective>

<execution_context>
@/home/jose147/.claude/get-shit-done/workflows/execute-plan.md
@/home/jose147/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/06-orders/06-CONTEXT.md
@.planning/phases/06-orders/06-RESEARCH.md
@supabase/migrations/20260129000001_contacts_and_tags.sql
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create database migration for orders foundation</name>
  <files>supabase/migrations/20260129000003_orders_foundation.sql</files>
  <action>
Create migration file with the following tables:

**1. products table:**
- id UUID PRIMARY KEY DEFAULT gen_random_uuid()
- workspace_id UUID NOT NULL REFERENCES workspaces(id) ON DELETE CASCADE
- sku TEXT NOT NULL
- title TEXT NOT NULL
- price DECIMAL(12, 2) NOT NULL
- shopify_product_id TEXT (nullable, for future Shopify match)
- is_active BOOLEAN DEFAULT true
- created_at, updated_at with America/Bogota timezone
- UNIQUE(workspace_id, sku)
- Index on workspace_id

**2. pipelines table:**
- id UUID PRIMARY KEY DEFAULT gen_random_uuid()
- workspace_id UUID NOT NULL REFERENCES workspaces(id) ON DELETE CASCADE
- name TEXT NOT NULL
- description TEXT
- is_default BOOLEAN DEFAULT false
- created_at, updated_at
- UNIQUE(workspace_id, name)
- Index on workspace_id

**3. pipeline_stages table:**
- id UUID PRIMARY KEY DEFAULT gen_random_uuid()
- pipeline_id UUID NOT NULL REFERENCES pipelines(id) ON DELETE CASCADE
- name TEXT NOT NULL
- color TEXT NOT NULL DEFAULT '#6366f1'
- position INTEGER NOT NULL DEFAULT 0
- wip_limit INTEGER (nullable = unlimited)
- is_closed BOOLEAN DEFAULT false (for "Won", "Lost" stages)
- created_at
- UNIQUE(pipeline_id, position)
- Index on (pipeline_id, position)

**4. orders table:**
- id UUID PRIMARY KEY DEFAULT gen_random_uuid()
- workspace_id UUID NOT NULL REFERENCES workspaces(id) ON DELETE CASCADE
- contact_id UUID REFERENCES contacts(id) ON DELETE SET NULL
- pipeline_id UUID NOT NULL REFERENCES pipelines(id) ON DELETE RESTRICT
- stage_id UUID NOT NULL REFERENCES pipeline_stages(id) ON DELETE RESTRICT
- total_value DECIMAL(12, 2) NOT NULL DEFAULT 0
- closing_date DATE
- description TEXT
- carrier TEXT (transportadora)
- tracking_number TEXT (guia)
- linked_order_id UUID REFERENCES orders(id) ON DELETE SET NULL
- custom_fields JSONB DEFAULT '{}'
- created_at, updated_at
- Indexes on workspace_id, contact_id, pipeline_id, stage_id

**5. order_products junction table:**
- id UUID PRIMARY KEY DEFAULT gen_random_uuid()
- order_id UUID NOT NULL REFERENCES orders(id) ON DELETE CASCADE
- product_id UUID REFERENCES products(id) ON DELETE SET NULL
- sku TEXT NOT NULL (snapshot)
- title TEXT NOT NULL (snapshot)
- unit_price DECIMAL(12, 2) NOT NULL (snapshot)
- quantity INTEGER NOT NULL CHECK (quantity > 0)
- subtotal DECIMAL(12, 2) GENERATED ALWAYS AS (unit_price * quantity) STORED
- created_at
- Index on order_id

**6. order_tags junction table:**
- id, order_id, tag_id, created_at
- UNIQUE(order_id, tag_id)
- Indexes on order_id, tag_id

**7. saved_views table (for saved filters):**
- id, workspace_id, user_id, name, entity_type, filters JSONB, is_shared, created_at, updated_at
- Index on (workspace_id, entity_type)

**Triggers:**
- update_order_total() - Auto-calculate total_value from order_products
- Trigger on order_products AFTER INSERT/UPDATE/DELETE
- Auto-set workspace_id triggers for products, pipelines, orders
- Auto-update updated_at triggers

**RLS Policies:**
- All tables: Enable RLS
- SELECT/INSERT/UPDATE/DELETE based on workspace_id matching JWT claims
- Use SECURITY DEFINER where needed for cross-table operations

Follow patterns from 20260129000001_contacts_and_tags.sql for consistency.
  </action>
  <verify>
Run: `supabase db lint` (if available) or manually verify SQL syntax
Check: Migration file exists and follows project conventions
  </verify>
  <done>
Migration file creates all tables with correct constraints, triggers auto-calculate order totals, RLS policies enforce workspace isolation
  </done>
</task>

<task type="auto">
  <name>Task 2: Create TypeScript types for orders module</name>
  <files>src/lib/orders/types.ts</files>
  <action>
Create type definitions that match the database schema:

```typescript
// src/lib/orders/types.ts

// Product catalog
export interface Product {
  id: string
  workspace_id: string
  sku: string
  title: string
  price: number
  shopify_product_id: string | null
  is_active: boolean
  created_at: string
  updated_at: string
}

export interface ProductFormData {
  sku: string
  title: string
  price: number
  shopify_product_id?: string | null
  is_active?: boolean
}

// Pipelines and stages
export interface Pipeline {
  id: string
  workspace_id: string
  name: string
  description: string | null
  is_default: boolean
  created_at: string
  updated_at: string
  stages?: PipelineStage[]
}

export interface PipelineFormData {
  name: string
  description?: string | null
  is_default?: boolean
}

export interface PipelineStage {
  id: string
  pipeline_id: string
  name: string
  color: string
  position: number
  wip_limit: number | null
  is_closed: boolean
  created_at: string
}

export interface StageFormData {
  name: string
  color?: string
  position?: number
  wip_limit?: number | null
  is_closed?: boolean
}

// Orders
export interface Order {
  id: string
  workspace_id: string
  contact_id: string | null
  pipeline_id: string
  stage_id: string
  total_value: number
  closing_date: string | null
  description: string | null
  carrier: string | null
  tracking_number: string | null
  linked_order_id: string | null
  custom_fields: Record<string, unknown>
  created_at: string
  updated_at: string
  // Joined relations
  contact?: {
    id: string
    name: string
    phone: string
    city: string | null
  }
  stage?: PipelineStage
  pipeline?: Pipeline
  products?: OrderProduct[]
  tags?: { id: string; name: string; color: string }[]
}

export interface OrderFormData {
  contact_id?: string | null
  pipeline_id: string
  stage_id: string
  closing_date?: string | null
  description?: string | null
  carrier?: string | null
  tracking_number?: string | null
  custom_fields?: Record<string, unknown>
  products?: OrderProductInput[]
}

// Order-Product junction
export interface OrderProduct {
  id: string
  order_id: string
  product_id: string | null
  sku: string
  title: string
  unit_price: number
  quantity: number
  subtotal: number
  created_at: string
}

export interface OrderProductInput {
  product_id?: string | null
  sku: string
  title: string
  unit_price: number
  quantity: number
}

// Saved views
export interface SavedView {
  id: string
  workspace_id: string
  user_id: string
  name: string
  entity_type: 'orders' | 'contacts'
  filters: OrderFilters
  is_shared: boolean
  created_at: string
  updated_at: string
}

export interface OrderFilters {
  stage_ids?: string[]
  pipeline_id?: string
  contact_id?: string
  tag_ids?: string[]
  city?: string
  date_range?: { from: string; to: string }
  value_range?: { min: number; max: number }
  product_ids?: string[]
  search?: string
}

// Kanban helpers
export interface OrdersByStage {
  [stageId: string]: Order[]
}

export interface KanbanState {
  pipeline: Pipeline
  stages: PipelineStage[]
  ordersByStage: OrdersByStage
}
```

Ensure types align exactly with database columns (including nullable fields).
  </action>
  <verify>
Run: `pnpm tsc --noEmit` - TypeScript compiles without errors
Check: All types exported and match database schema
  </verify>
  <done>
TypeScript types exist for Product, Pipeline, PipelineStage, Order, OrderProduct, SavedView with correct nullable annotations
  </done>
</task>

</tasks>

<verification>
1. Migration file exists at supabase/migrations/20260129000003_orders_foundation.sql
2. TypeScript types exist at src/lib/orders/types.ts
3. Types compile without errors: `pnpm tsc --noEmit`
4. Migration SQL is syntactically valid
</verification>

<success_criteria>
- Database schema supports multi-pipeline Kanban with configurable stages
- Order totals auto-calculate from products via trigger
- RLS policies enforce workspace isolation
- TypeScript types provide full type safety for orders module
</success_criteria>

<output>
After completion, create `.planning/phases/06-orders/06-01-SUMMARY.md`
</output>
