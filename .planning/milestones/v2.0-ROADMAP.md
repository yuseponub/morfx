# Milestone v2.0: Agentes Conversacionales

**Status:** SHIPPED 2026-02-16
**Phases:** 12-20 (+ 15.5, 15.6, 15.7, 15.8, 16.1 inserted)
**Total Plans:** 83
**Total Phases:** 14

## Overview

MVP v2 focused on transforming existing n8n agents into code-controlled conversational agents with Claude API, visual management, automations engine, and WhatsApp integration. The milestone expanded from the original 8 phases (12-19) to include 5 inserted phases for urgent fixes and architectural improvements, plus Phase 20 for integration automations.

## Phases

### Phase 12: Action DSL Real
**Goal**: Los handlers placeholder del Action DSL ejecutan operaciones reales de CRM y WhatsApp
**Depends on**: Phase 11 (MVP v1 complete)
**Plans**: 4 plans

Plans:
- [x] 12-01: Foundation — ToolResult types, rate limiter, migration, enhanced logging
- [x] 12-02: CRM handlers real — 9 handlers (contact CRUD, tags, orders)
- [x] 12-03: WhatsApp handlers real — 7 handlers (message send, templates, conversations)
- [x] 12-04: Executor enhancement — timeout, rate limiting, API route structured responses

**Completed:** 2026-02-05

### Phase 13: Agent Engine Core
**Goal**: Motor generico que ejecuta agentes conversacionales con Claude API, tools, y persistencia de sesion
**Depends on**: Phase 12
**Plans**: 6 plans

Plans:
- [x] 13-01: Database foundation — agent_sessions, agent_turns, session_state tables
- [x] 13-02: Agent Registry and Session Manager with optimistic locking
- [x] 13-03: Claude Client with streaming and Token Budget Manager
- [x] 13-04: Intent Detector and Orchestrator with confidence routing
- [x] 13-05: Agent Engine main loop with tool execution and retry logic
- [x] 13-06: Inngest timer workflows for proactive agent actions

**Completed:** 2026-02-06

### Phase 14: Agente Ventas Somnio
**Goal**: El agente de ventas de Somnio funciona como el actual en n8n pero con codigo controlado
**Depends on**: Phase 13
**Plans**: 6 plans

Plans:
- [x] 14-01: Database schema for templates + Somnio agent config with 20 intents
- [x] 14-02: Data Extractor component with normalization and inference
- [x] 14-03: Template Manager with variable substitution
- [x] 14-04: Message Sequencer with delays and interruption handling
- [x] 14-05: Somnio Orchestrator with transition validation and flow logic
- [x] 14-06: Order Creator and API endpoint for end-to-end flow

**Completed:** 2026-02-06

### Phase 15: Agent Sandbox
**Goal**: UI de pruebas para simular conversaciones sin afectar WhatsApp real
**Depends on**: Phase 14
**Plans**: 5 plans (4 executed, 1 human verification deferred)

Plans:
- [x] 15-01: Foundation — SandboxEngine, session persistence, typing indicator
- [x] 15-02: Chat UI — Allotment layout, message bubbles, input
- [x] 15-03: Debug panel — 4 tabs (Tools, Estado, Intent, Tokens)
- [x] 15-04: Session management — save/load/new controls, sidebar navigation
- [ ] 15-05: Human verification (deferred)

**Completed:** 2026-02-07 (code complete)

### Phase 15.5: Somnio Ingest System (INSERTED)
**Goal**: Sistema de acumulacion de datos con deteccion datos vs pregunta
**Depends on**: Phase 15
**Plans**: 4 plans (3 executed, 1 human verification deferred)

Plans:
- [x] 15.5-01: Message Classifier with Claude Haiku structured outputs
- [x] 15.5-02: Ingest Manager and Timer with 6min/10min conditional timeout
- [x] 15.5-03: Engine Integration and Sandbox IngestStatus visibility
- [ ] 15.5-04: Human verification (deferred)

**Completed:** 2026-02-07 (code complete)

### Phase 15.6: Sandbox Evolution (INSERTED)
**Goal**: Debug multi-panel, tools visibility, agent separation, ingest testing
**Depends on**: Phase 15.5
**Plans**: 6 plans

Plans:
- [x] 15.6-01: Foundation types + per-model token tracking
- [x] 15.6-02: Multi-panel debug UI with tab bar
- [x] 15.6-03: CRM agent system (OrderManager, CrmOrchestrator)
- [x] 15.6-04: Ingest tab + Tokens tab per-model enhancement
- [x] 15.6-05: CRM sandbox integration (header, engine, tools tab)
- [x] 15.6-06: Human verification of all success criteria

**Completed:** 2026-02-08

### Phase 15.7: Ingest Timer Pluggable (INSERTED)
**Goal**: Timer funcional con 5 niveles, configurable en sandbox
**Depends on**: Phase 15.6
**Plans**: 3 plans (2 executed, 1 human verification deferred)

Plans:
- [x] 15.7-01: Types + IngestTimerSimulator engine + signal fix
- [x] 15.7-02: SandboxLayout timer integration + IngestTab 5-level UI
- [ ] 15.7-03: Human verification (deferred)

**Completed:** 2026-02-08 (code complete)

### Phase 15.8: Codebase Cleanup (INSERTED)
**Goal**: Corregir 16 bugs, seguridad, duplicados e inconsistencias del audit
**Depends on**: Phase 15.7
**Plans**: 4 plans

Plans:
- [x] 15.8-01: Critical bugs — stale closures, state mutation, timer signal
- [x] 15.8-02: High severity bugs + security fixes
- [x] 15.8-03: Medium bugs + constants consolidation
- [x] 15.8-04: Code consolidation (phone normalization, admin client, model IDs)

**Completed:** 2026-02-09

### Phase 16: WhatsApp Agent Integration
**Goal**: Agentes conectados con inbox de WhatsApp real con handoff
**Depends on**: Phase 15.8
**Plans**: 6 plans (5 executed, 1 human verification deferred)

Plans:
- [x] 16-01: DB foundation — workspace_agent_config, conversation columns
- [x] 16-02: Backend — Webhook-to-agent routing via Inngest, handoff
- [x] 16-03: Inbox UX — Bot badge, per-chat toggles, typing indicator
- [x] 16-04: Agent config slider, inbox panel switching
- [x] 16-05: Agentes module — metrics dashboard, config page
- [ ] 16-06: Human verification (deferred)

**Completed:** 2026-02-10 (code complete)

### Phase 16.1: Engine Unification (INSERTED)
**Goal**: Unificar SandboxEngine y SomnioEngine en un solo flujo con adapters
**Depends on**: Phase 16
**Plans**: 6 plans

Plans:
- [x] 16.1-01: Adapter interfaces, engine types, shared state shapes
- [x] 16.1-02: SomnioAgent extraction (shared business logic)
- [x] 16.1-03: Sandbox + Production adapter implementations (10 adapters)
- [x] 16.1-04: UnifiedEngine class + wire sandbox API route
- [x] 16.1-05: Wire production webhook-processor with backward compat
- [x] 16.1-06: TypeScript verification + sandbox testing

**Completed:** 2026-02-10

### Phase 17: CRM Automations Engine
**Goal**: Motor de automatizaciones configurable con triggers y acciones
**Depends on**: Phase 16.1
**Plans**: 10 plans

Plans:
- [x] 17-01: DB schema + TypeScript types + constants catalog
- [x] 17-02: Condition evaluator + variable resolver
- [x] 17-03: Automation CRUD server actions + execution history
- [x] 17-04: Action executor (11 types) + trigger emitter (cascade protection)
- [x] 17-05: Builder wizard UI (3-step: trigger, conditions, actions)
- [x] 17-06: Inngest automation runner functions (10 trigger types)
- [x] 17-07: Wire trigger emission into existing server actions
- [x] 17-08: Automation list + execution history pages
- [x] 17-09: Connected orders + related orders UI
- [x] 17-10: TypeScript verification + human verification

**Completed:** 2026-02-13

### Phase 18: Domain Layer Foundation
**Goal**: Capa domain/ como unica fuente de verdad para todas las mutaciones
**Depends on**: Phase 17
**Plans**: 10 plans

Plans:
- [x] 18-01: Foundation — domain types, DB audit trigger, CLAUDE.md rule
- [x] 18-02: Orders domain functions (7 functions)
- [x] 18-03: Orders wiring — all callers to domain + 4 new tool handlers
- [x] 18-04: Contacts + Tags domain functions
- [x] 18-05: Contacts + Tags wiring — all callers to domain
- [x] 18-06: Messages/WhatsApp domain + keyword_match activation
- [x] 18-07: Tasks domain + 4 new task tool handlers
- [x] 18-08: Notes + Custom Fields domain + 5 new tool handlers
- [x] 18-09: Conversations domain + task.overdue cron activation
- [x] 18-10: TypeScript verification + human verification

**Completed:** 2026-02-13

### Phase 19: AI Automation Builder
**Goal**: Meta-agente de IA que crea automatizaciones por lenguaje natural
**Depends on**: Phase 18
**Plans**: 10 plans

Plans:
- [x] 19-01: Foundation — deps, builder types, builder_sessions migration
- [x] 19-02: System prompt + 9 builder tool definitions
- [x] 19-03: Streaming API route + session store
- [x] 19-04: Diagram generator + validation (resources, cycles, duplicates)
- [x] 19-05: Builder page + chat UI with useChat
- [x] 19-06: React Flow preview + custom nodes
- [x] 19-07: Wire diagram into chat + confirmation flow
- [x] 19-08: Session history UI + sessions API + resume
- [x] 19-09: Navigation + modify/clone/explain polish
- [x] 19-10: TypeScript verification + human verification

**Completed:** 2026-02-16

### Phase 20: Integration Automations (Twilio + Shopify)
**Goal**: Expandir motor de automatizaciones con Twilio SMS y triggers directos de Shopify
**Depends on**: Phase 17, Phase 19
**Plans**: 7 plans (5 executed + 2 verification + 5 hotfixes)

Plans:
- [x] 20-01: Foundation — types, constants, Twilio client, sms_messages migration
- [x] 20-02: Shopify automations engine — triggers, Inngest events, runners
- [x] 20-03: Twilio SMS action — executeSendSms, status callback
- [x] 20-04: Shopify webhook extension — 3-topic dispatch, dual-behavior toggle
- [x] 20-05: Config UI — Twilio credentials, SMS usage dashboard, auto-sync toggle
- [x] 20-06: Wizard UI — Shopify triggers (purple), Twilio actions (teal)
- [x] 20-07: Human verification (7/7 tests passed, 5 hotfixes)

**Completed:** 2026-02-16

---

## Milestone Summary

**Decimal Phases (Inserted):**
- Phase 15.5: Somnio Ingest System (urgent fix for data accumulation)
- Phase 15.6: Sandbox Evolution (debug multi-panel, CRM agent separation)
- Phase 15.7: Ingest Timer Pluggable (5-level timer with presets)
- Phase 15.8: Codebase Cleanup (audit-driven bug fixes and security)
- Phase 16.1: Engine Unification (eliminate ~800 lines of duplicated flow logic)

**Key Decisions:**
- AI SDK v6 for Claude integration (useChat, DefaultChatTransport, sendMessage pattern)
- Inngest for async job processing (automation runners, agent timers, webhook routing)
- Domain layer as single source of truth for all mutations (Regla 3)
- Ports/Adapters architecture for UnifiedEngine (sandbox vs production)
- React Flow for automation diagram visualization
- Fire-and-forget pattern abandoned in webhook context (Vercel serverless termination)
- Two automation contexts: flat TriggerContext vs nested variableContext

**Issues Resolved:**
- Fire-and-forget unreliable on Vercel serverless (await inngest.send instead)
- Contact resolution for external triggers (auto-create via domain)
- Variable resolution requires nested context, not flat TriggerContext
- AI SDK v6 migration (UIMessage parts[] not content, DefaultChatTransport)
- React Flow SSR incompatibility (dynamic import with ssr:false)
- Stale closures in timer simulator (callback ref pattern)
- ~800 lines duplicated between SandboxEngine and SomnioEngine (unified)

**Issues Deferred:**
- Deprecated SomnioEngine and SandboxEngine files preserved as backup
- 4 human verification plans never formally executed (tested in practice)
- make_call Twilio action deferred to future phase

**Technical Debt Incurred:**
- 7 phases without formal VERIFICATION.md (code quality confirmed via integration check)
- v2 requirements tracked informally in ROADMAP.md, not REQUIREMENTS.md
- Some phases still "In progress" in ROADMAP (documentation inconsistency, fixed during archival)

---

*Archived: 2026-02-16 as part of v2.0 milestone completion*
*For current project status, see .planning/ROADMAP.md*
