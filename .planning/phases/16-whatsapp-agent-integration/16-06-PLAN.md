---
phase: 16-whatsapp-agent-integration
plan: 06
type: execute
wave: 4
depends_on: ["16-01", "16-02", "16-03", "16-04", "16-05"]
files_modified: []
autonomous: false

must_haves:
  truths:
    - "Conversacion de WhatsApp puede tener agente asignado que procesa mensajes automaticamente"
    - "Agente puede ser habilitado/deshabilitado por conversacion individual"
    - "Sistema soporta handoff bidireccional: agente a humano y humano a agente"
    - "Manager puede ver conversaciones atendidas por agente (filtro especial)"
    - "Sistema registra metricas de conversaciones automatizadas"
  artifacts: []
  key_links: []
---

<objective>
Human verification of all Phase 16 success criteria.

Purpose: Verify that agent-WhatsApp integration works end-to-end before marking the phase complete. This is the final quality gate before production deployment.

Output: Verification results, list of issues (if any).
</objective>

<execution_context>
@/home/jose147/.claude/get-shit-done/workflows/execute-plan.md
@/home/jose147/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/16-whatsapp-agent-integration/16-CONTEXT.md
</context>

<tasks>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete WhatsApp Agent Integration system:
- Database schema for agent config (workspace_agent_config table, conversations columns, messages column)
- Backend: Webhook-to-agent routing via Inngest with concurrency control
- Backend: Handoff handler with task creation and round-robin assignment
- Inbox UX: Bot badge on agent messages, bot avatar overlay, per-chat toggles
- Inbox UX: "Bot escribiendo..." typing indicator via Realtime
- Inbox: Agent config slider panel with global settings
- Agentes module: Dashboard with metrics (conversations, handoffs, costs)
- Agentes module: Config page with full agent settings
- Navigation: Agentes link in sidebar and mobile nav
  </what-built>
  <how-to-verify>
**CRITICAL: Push to Vercel first, then verify on deployed app.**

1. **Agent Config (Slider):**
   - Open WhatsApp inbox
   - Click Bot icon in chat header to open agent config slider
   - Toggle global agent ON
   - Verify slider shows: agent selector, CRM toggles, handoff message, timer preset, response speed
   - Close slider, verify contact panel returns

2. **Per-Chat Toggles:**
   - Select a conversation
   - Verify two toggles in chat header (conversational + CRM) next to contact name
   - Toggle conversational ON for a specific conversation
   - Verify bot overlay appears on that conversation's avatar in the list

3. **Agent Processing (if WhatsApp connected):**
   - Send a test message from a WhatsApp number
   - Verify agent responds automatically
   - Verify agent messages have Bot badge
   - Verify "Bot escribiendo..." appears during processing

4. **Handoff (if WhatsApp connected):**
   - Send "necesito un asesor" from WhatsApp
   - Verify agent sends handoff message ("Regalame 1 min...")
   - Verify conversational toggle turns OFF
   - Verify task created in /tareas

5. **Agentes Module:**
   - Navigate to /agentes
   - Verify Dashboard tab shows metric cards (may be zeros if no data)
   - Switch between period selectors (Hoy, 7d, 30d)
   - Navigate to /agentes/config
   - Verify full config form renders

6. **Navigation:**
   - Verify "Agentes" appears in sidebar between Sandbox and Equipo
   - On mobile: verify Agentes in mobile nav

7. **TypeScript:**
   - `npx tsc --noEmit` passes
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues found</resume-signal>
</task>

</tasks>

<verification>
Phase 16 Success Criteria (from ROADMAP.md):
1. Conversacion de WhatsApp puede tener agente asignado que procesa mensajes automaticamente
2. Agente puede ser habilitado/deshabilitado por conversacion individual
3. Sistema soporta handoff bidireccional: agente a humano y humano a agente
4. Manager puede ver conversaciones atendidas por agente (filtro especial)
5. Sistema registra metricas de conversaciones automatizadas (tiempo respuesta, resolucion, handoffs)
</verification>

<success_criteria>
Phase 16 is complete when ALL success criteria pass human verification.
</success_criteria>

<output>
After completion, create `.planning/phases/16-whatsapp-agent-integration/16-06-SUMMARY.md`
Then create `.planning/phases/16-whatsapp-agent-integration/16-LEARNINGS.md`
</output>
