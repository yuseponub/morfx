---
phase: 09.1-order-states-config
plan: 03
type: execute
wave: 2
depends_on: ["09.1-01"]
files_modified:
  - src/lib/orders/stage-phases.ts
  - src/app/(dashboard)/whatsapp/components/order-status-indicator.tsx
  - src/app/(dashboard)/whatsapp/components/conversation-item.tsx
autonomous: true

must_haves:
  truths:
    - "Order indicator uses emoji from database-configured order state"
    - "Emoji appears on avatar corner in conversation list (Callbell style)"
    - "Orders without assigned state show no indicator"
    - "Fallback to hardcoded mapping only when DB lookup returns null (backward compatibility)"
  artifacts:
    - path: "src/lib/orders/stage-phases.ts"
      provides: "Updated getOrderPhase with DB lookup, fallback to hardcoded"
      contains: "getOrderStateForStageId"
    - path: "src/app/(dashboard)/whatsapp/components/order-status-indicator.tsx"
      provides: "Updated indicator using DB emoji"
      contains: "orderState.emoji"
    - path: "src/app/(dashboard)/whatsapp/components/conversation-item.tsx"
      provides: "Avatar indicator positioning"
      contains: "absolute"
  key_links:
    - from: "order-status-indicator.tsx"
      to: "stage-phases.ts"
      via: "getOrderStateEmoji function"
      pattern: "getOrderStateEmoji|getOrderPhase"
---

<objective>
Update WhatsApp conversation UI to use database-configured order state emojis.

Purpose: Replace hardcoded emoji mapping with database lookup. Show emoji on avatar corner (Callbell style) instead of inline text. Maintain backward compatibility with fallback to hardcoded mapping.

Output:
- Updated stage-phases.ts with getOrderStateForStageId helper
- Updated order-status-indicator.tsx to use DB emoji
- Updated conversation-item.tsx to show emoji on avatar
</objective>

<execution_context>
@/home/jose147/.claude/get-shit-done/workflows/execute-plan.md
@/home/jose147/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/09.1-order-states-config/09.1-CONTEXT.md
@.planning/phases/09.1-order-states-config/09.1-01-SUMMARY.md

# Current implementation to update
@src/lib/orders/stage-phases.ts
@src/app/(dashboard)/whatsapp/components/order-status-indicator.tsx
@src/app/(dashboard)/whatsapp/components/conversation-item.tsx
@src/lib/whatsapp/types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update stage-phases.ts with DB lookup support</name>
  <files>src/lib/orders/stage-phases.ts</files>
  <action>
Keep existing hardcoded mapping as fallback. Add new functions for DB-driven lookup.

1. Keep existing code (STAGE_TO_PHASE, PHASE_INDICATORS, getOrderPhase, shouldShowIndicator)

2. Add new type for stage with order_state info:
```typescript
export interface StageWithOrderState {
  id: string
  name: string
  color: string
  order_state_id?: string | null
  order_state?: {
    id: string
    emoji: string
    name: string
  } | null
}
```

3. Add function to get emoji for a stage (used by indicator):
```typescript
/**
 * Get the emoji for a stage.
 * Returns the configured order_state.emoji if assigned, otherwise falls back to hardcoded PHASE_INDICATORS.
 */
export function getStageEmoji(stage: StageWithOrderState): string | null {
  // If stage has order_state assigned, use its emoji
  if (stage.order_state?.emoji) {
    return stage.order_state.emoji
  }

  // Fallback to hardcoded mapping
  const phase = getOrderPhase(stage.name)
  if (!shouldShowIndicator(phase)) {
    return null
  }
  return PHASE_INDICATORS[phase].emoji
}
```

4. Add function to check if stage should show indicator:
```typescript
/**
 * Check if a stage should show an indicator.
 * If stage has order_state assigned, always show (unless empty emoji).
 * If no order_state, use legacy shouldShowIndicator logic.
 */
export function shouldShowStageIndicator(stage: StageWithOrderState): boolean {
  // If stage has order_state, show indicator (order_state.emoji is required so always truthy)
  if (stage.order_state_id) {
    return !!stage.order_state?.emoji
  }

  // Fallback to legacy logic
  const phase = getOrderPhase(stage.name)
  return shouldShowIndicator(phase)
}
```

5. Export all new functions and type

The key insight: stage data will now include order_state info when fetched with a join. The indicator component will receive this enriched data.
  </action>
  <verify>
- grep "StageWithOrderState" returns match
- grep "getStageEmoji" returns match
- grep "shouldShowStageIndicator" returns match
- Existing functions (getOrderPhase, shouldShowIndicator, PHASE_INDICATORS) still exist
  </verify>
  <done>
stage-phases.ts has new functions for DB-driven emoji lookup with fallback to hardcoded mapping.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update OrderSummary type and order-status-indicator.tsx</name>
  <files>
    src/lib/whatsapp/types.ts
    src/app/(dashboard)/whatsapp/components/order-status-indicator.tsx
  </files>
  <action>
**Update src/lib/whatsapp/types.ts**:

Update OrderSummary to include order_state info on stage:
```typescript
export interface OrderSummary {
  id: string
  total_value: number
  is_closed: boolean
  stage: {
    id: string
    name: string
    color: string
    order_state_id?: string | null
    order_state?: {
      id: string
      emoji: string
      name: string
    } | null
  }
}
```

**Update order-status-indicator.tsx**:

1. Update imports:
```typescript
import { getStageEmoji, shouldShowStageIndicator, type StageWithOrderState } from '@/lib/orders/stage-phases'
```

2. Update OrderStatusIndicator logic:

```typescript
export function OrderStatusIndicator({
  orders,
  maxDisplay = 3,
  showTooltip = true,
  size = 'sm',
}: OrderStatusIndicatorProps) {
  // Filter to orders with stages that should show indicators
  const activeOrders = orders.filter(order =>
    shouldShowStageIndicator(order.stage as StageWithOrderState)
  )

  if (activeOrders.length === 0) {
    return null
  }

  // Get unique emojis (deduplicate by emoji value)
  const emojiMap = new Map<string, { emoji: string; orders: typeof activeOrders }>()

  for (const order of activeOrders) {
    const emoji = getStageEmoji(order.stage as StageWithOrderState)
    if (emoji) {
      const existing = emojiMap.get(emoji)
      if (existing) {
        existing.orders.push(order)
      } else {
        emojiMap.set(emoji, { emoji, orders: [order] })
      }
    }
  }

  const uniqueEmojis = Array.from(emojiMap.values())
  const displayedEmojis = uniqueEmojis.slice(0, maxDisplay)
  const overflow = uniqueEmojis.length - maxDisplay

  // ... rest of render logic using displayedEmojis instead of displayedPhases
  // Update to use emoji directly instead of PHASE_INDICATORS[phase].emoji
}
```

3. Update tooltip content to show order_state.name if available, fallback to stage.name

4. Keep OrderStageBadge unchanged (it shows stage color/name, not order state emoji)
  </action>
  <verify>
- grep "getStageEmoji" order-status-indicator.tsx returns match
- grep "shouldShowStageIndicator" order-status-indicator.tsx returns match
- grep "order_state" types.ts returns match in OrderSummary
- No TypeScript errors
  </verify>
  <done>
OrderStatusIndicator uses DB-configured emoji via getStageEmoji. Falls back to hardcoded if no order_state assigned.
  </done>
</task>

<task type="auto">
  <name>Task 3: Update conversation-item.tsx for avatar indicator</name>
  <files>src/app/(dashboard)/whatsapp/components/conversation-item.tsx</files>
  <action>
Update conversation item to show emoji indicator on avatar corner (Callbell style).

1. Add avatar to the conversation item display (currently shows name text, needs avatar circle)

2. Position the order indicator emoji on top-right of avatar:

```typescript
// In the component, after displayName extraction:
const firstOrder = orders[0]
const primaryEmoji = firstOrder ? getStageEmoji(firstOrder.stage as StageWithOrderState) : null

// In the render, replace name section with:
<div className="flex items-center gap-3 min-w-0">
  {/* Avatar with optional indicator */}
  <div className="relative flex-shrink-0">
    {/* Avatar circle with initials */}
    <div className="w-10 h-10 rounded-full bg-primary/20 flex items-center justify-center">
      <span className="text-sm font-medium text-primary">
        {getInitials(displayName)}
      </span>
    </div>
    {/* Emoji indicator on top-right - Callbell style */}
    {primaryEmoji && (
      <span className="absolute -top-0.5 -right-0.5 text-xs leading-none">
        {primaryEmoji}
      </span>
    )}
  </div>

  {/* Name and unread badge */}
  <div className="flex items-center gap-2 min-w-0">
    <span className={cn(
      'font-medium truncate',
      !conversation.is_read && 'font-semibold'
    )}>
      {displayName}
    </span>
    {/* unread count badge */}
  </div>
</div>
```

3. Add getInitials helper:
```typescript
function getInitials(name: string): string {
  return name
    .split(' ')
    .slice(0, 2)
    .map(n => n[0])
    .join('')
    .toUpperCase()
}
```

4. Remove the inline OrderStatusIndicator from the timestamp area since emoji is now on avatar

5. Import getStageEmoji and StageWithOrderState from stage-phases.ts

The key change: Move from inline emoji indicators to avatar badge style (Callbell reference).
  </action>
  <verify>
- grep "absolute" conversation-item.tsx returns match in emoji positioning context
- grep "getInitials" conversation-item.tsx returns match
- grep "getStageEmoji" conversation-item.tsx returns match
- Visual check: emoji appears on avatar corner, not inline with timestamp
  </verify>
  <done>
Conversation item shows avatar with initials. Order state emoji appears on avatar corner (Callbell style). Inline indicator removed.
  </done>
</task>

</tasks>

<verification>
After all tasks complete:
1. Create an order state with custom emoji in settings
2. Assign a pipeline stage to that state
3. Create/move an order to that stage
4. View WhatsApp conversations with that contact
5. Verify emoji appears on avatar corner (not inline)
6. Verify orders without assigned state fall back to hardcoded emoji
7. Verify won orders (is_closed) don't show indicator

Manual test at http://localhost:3020/whatsapp
</verification>

<success_criteria>
- [x] StageWithOrderState type exported from stage-phases.ts
- [x] getStageEmoji returns DB emoji when available, hardcoded fallback otherwise
- [x] shouldShowStageIndicator uses DB-driven logic with fallback
- [x] OrderSummary type includes order_state info on stage
- [x] Conversation item shows avatar with initials
- [x] Emoji indicator positioned on avatar top-right corner
- [x] Inline OrderStatusIndicator removed from conversation item
- [x] Backward compatible with orders using non-assigned stages
</success_criteria>

<output>
After completion, create `.planning/phases/09.1-order-states-config/09.1-03-SUMMARY.md`
</output>
