---
phase: 18-domain-layer-foundation
plan: 05
type: execute
wave: 3
depends_on: ["18-03", "18-04"]
files_modified:
  - src/app/actions/contacts.ts
  - src/app/actions/tags.ts
  - src/lib/tools/handlers/crm/index.ts
  - src/lib/automations/action-executor.ts
  - src/lib/shopify/webhook-handler.ts
autonomous: true

must_haves:
  truths:
    - "Server action createContact calls domain.createContact and no longer has inline DB logic"
    - "Server action bulk tag operations call domain.assignTag/removeTag per item"
    - "All CRM tool handlers for contacts and tags call domain functions"
    - "Action executor assign_tag, remove_tag, update_field (for contacts) call domain"
    - "Shopify webhook resolveContact calls domain.createContact for new contacts"
    - "No duplicate trigger emissions for contacts or tags"
  artifacts:
    - path: "src/app/actions/contacts.ts"
      provides: "Thin adapter calling domain/contacts and domain/tags"
      contains: "import.*domain/contacts"
  key_links:
    - from: "src/app/actions/contacts.ts"
      to: "src/lib/domain/contacts.ts"
      via: "import domain contact functions"
      pattern: "domain/contacts"
    - from: "src/lib/tools/handlers/crm/index.ts"
      to: "src/lib/domain/contacts.ts"
      via: "import domain contact functions"
      pattern: "domain/contacts"
---

<objective>
Wire ALL contact and tag callers to use domain/contacts.ts and domain/tags.ts. Remove old trigger emissions from callers. Complete the contacts+tags entity migration.

Purpose: After this plan, every contact creation, update, deletion, and tag operation goes through domain/, with automatic trigger emission. Bot operations, Shopify imports, and automations all trigger automations consistently.

Output: 5 refactored caller files with all contact/tag mutations delegated to domain.
</objective>

<execution_context>
@/home/jose147/.claude/get-shit-done/workflows/execute-plan.md
@/home/jose147/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/18-domain-layer-foundation/18-RESEARCH.md
@.planning/phases/18-domain-layer-foundation/18-02-SUMMARY.md
@.planning/phases/18-domain-layer-foundation/18-04-SUMMARY.md

Key reference files:
@src/lib/domain/contacts.ts (domain functions from Plan 04)
@src/lib/domain/tags.ts (domain functions from Plan 04)
@src/app/actions/contacts.ts (server actions to refactor)
@src/app/actions/tags.ts (if separate tag actions file exists)
@src/lib/tools/handlers/crm/index.ts (contact + tag handlers to refactor)
@src/lib/automations/action-executor.ts (assign_tag, remove_tag, update_field to refactor)
@src/lib/shopify/webhook-handler.ts (resolveContact to refactor)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Wire contact server actions + Shopify webhook</name>
  <files>src/app/actions/contacts.ts, src/lib/shopify/webhook-handler.ts</files>
  <action>
**Refactor `src/app/actions/contacts.ts`:**

For each mutation function:
1. `createContact` / `createContactFromForm`: Import and call `domainCreateContact`. Keep auth validation, Zod validation, revalidatePath. REMOVE trigger emission (emitContactCreated).
2. `updateContactFromForm`: Import and call `domainUpdateContact`. REMOVE trigger emission (emitFieldChanged calls).
3. `deleteContact` / `deleteContacts`: Import and call `domainDeleteContact`. Keep revalidatePath.
4. `addTagToContact`: Import and call `domainAssignTag({ entityType: 'contact', entityId: contactId, tagName })`. REMOVE emitTagAssigned.
5. `removeTagFromContact`: Import and call `domainRemoveTag({ entityType: 'contact', ... })`. REMOVE emitTagRemoved.
6. `bulkAddTag`: Loop over contact IDs, call `domainAssignTag` per contact. REMOVE inline tag emission.
7. `bulkRemoveTag`: Loop over contact IDs, call `domainRemoveTag` per contact. REMOVE inline tag emission.
8. `bulkCreateContacts`: Import and call `domainBulkCreateContacts`. REMOVE per-item trigger emissions.

**Keep unchanged:** Read-only functions (getContacts, getContactById, searchContacts, etc.) — they don't mutate data.

**CRITICAL:** Remove ALL trigger emission imports (emitContactCreated, emitFieldChanged, emitTagAssigned, emitTagRemoved) from contacts.ts. Domain handles them now.

**Refactor `src/lib/shopify/webhook-handler.ts`:**

In `resolveContact` / contact creation section:
1. Import `createContact as domainCreateContact` from `@/lib/domain/contacts`
2. Build DomainContext: `{ workspaceId, source: 'webhook' }`
3. Replace direct contact INSERT with `domainCreateContact(ctx, { name, phone, email, ... })`
4. Keep contact matching logic (phone/email lookup) as-is — it's read-only
5. If contact was already migrated in Plan 03 (order creation), verify no conflicts

Note: Orders in Shopify webhook were already migrated in Plan 03. Now contacts are also migrated. After this, the Shopify webhook handler is fully domain-powered.
  </action>
  <verify>No trigger emission code in contacts.ts (grep for emitContact, emitField, emitTag — should find nothing). Shopify webhook imports from domain/contacts. TypeScript compiles.</verify>
  <done>Contact server actions and Shopify webhook delegate all mutations to domain.</done>
</task>

<task type="auto">
  <name>Task 2: Wire CRM tool handlers + action executor for contacts/tags</name>
  <files>src/lib/tools/handlers/crm/index.ts, src/lib/automations/action-executor.ts</files>
  <action>
**Refactor `src/lib/tools/handlers/crm/index.ts` — contact + tag handlers:**

For existing handlers:
1. `crm.contact.create`: Call `domainCreateContact(ctx, params)`. Map DomainResult to ToolResult. Remove direct DB logic.
2. `crm.contact.update`: Call `domainUpdateContact(ctx, params)`. Remove direct DB logic.
3. `crm.contact.delete`: Call `domainDeleteContact(ctx, { contactId })`. Remove direct DB logic.
4. `crm.contact.read`: Keep as-is — it's read-only (no mutation, no trigger needed).
5. `crm.contact.list`: Keep as-is — it's read-only.
6. `crm.tag.add`: Call `domainAssignTag(ctx, { entityType: 'contact', entityId: contactId, tagName })`. Remove direct DB logic.
7. `crm.tag.remove`: Call `domainRemoveTag(ctx, { entityType: 'contact', entityId: contactId, tagName })`. Remove direct DB logic.

Build DomainContext for all: `{ workspaceId: context.workspaceId, source: 'tool-handler' }`

**Refactor `src/lib/automations/action-executor.ts` — contact/tag actions:**

For action types:
1. `assign_tag`: Already partially wired to domain from Plan 03 (for orders). Now also handle contact tags via domain. The action executor's assign_tag should call `domainAssignTag(ctx, { entityType, entityId, tagName })` with `source: 'automation'` and `cascadeDepth`. REMOVE inline trigger emission for tag actions.
2. `remove_tag`: Same as assign_tag — call `domainRemoveTag`. REMOVE inline trigger emission.
3. `update_field` (for contacts): Call `domainUpdateContact(ctx, { contactId, ...fieldUpdates })`. For custom field updates, domain handles the JSONB merge. REMOVE inline trigger emission for field.changed.

**CRITICAL:** After this task, the action executor should have NO inline trigger emissions for tag or contact actions. All trigger code for orders + contacts + tags is removed from action-executor. Only WhatsApp actions and task actions remain (they'll be migrated in later plans).
  </action>
  <verify>CRM handlers for contacts/tags import from domain. Action executor contact/tag/field actions import from domain. No inline trigger code for these entities in action-executor. TypeScript compiles.</verify>
  <done>CRM tool handlers and action executor delegate all contact/tag mutations to domain. Contacts+Tags entity 100% complete.</done>
</task>

</tasks>

<verification>
1. `src/app/actions/contacts.ts` has NO trigger emission code
2. `src/lib/tools/handlers/crm/index.ts` contact/tag handlers call domain functions (not direct DB)
3. `src/lib/automations/action-executor.ts` has no inline trigger code for orders, contacts, or tags
4. `src/lib/shopify/webhook-handler.ts` calls domain for both contacts and orders
5. `npx tsc --noEmit` passes
6. All contact mutations go through domain → triggers fire → automations run for bot operations
</verification>

<success_criteria>
- Every contact and tag mutation goes through domain/
- No duplicate trigger emissions for contacts or tags
- Bot tag.add, tag.remove now trigger automations
- Shopify webhook contact creation now triggers contact.created automation
- Action executor contact/tag actions use domain (no inline DB + trigger code)
</success_criteria>

<output>
After completion, create `.planning/phases/18-domain-layer-foundation/18-05-SUMMARY.md`
</output>
