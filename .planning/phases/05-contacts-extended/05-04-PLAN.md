---
phase: 05-contacts-extended
plan: 04
type: execute
wave: 3
depends_on: ["05-02"]
files_modified:
  - package.json
  - src/lib/csv/parser.ts
  - src/lib/csv/exporter.ts
  - src/app/(dashboard)/crm/contactos/components/csv-import-dialog.tsx
  - src/app/(dashboard)/crm/contactos/components/csv-export-button.tsx
  - src/app/(dashboard)/crm/contactos/components/duplicate-resolver.tsx
  - src/app/actions/contacts.ts
autonomous: true

must_haves:
  truths:
    - "User can import contacts from a CSV file"
    - "CSV import auto-detects columns and allows user to map them"
    - "Duplicate contacts (by phone) are shown for user resolution"
    - "User can export contacts to a CSV file"
    - "User can select which columns to include in export"
    - "User can export all contacts or only filtered ones"
  artifacts:
    - path: "src/lib/csv/parser.ts"
      provides: "PapaParse wrapper for CSV parsing"
      exports: ["parseContactsCsv"]
    - path: "src/lib/csv/exporter.ts"
      provides: "CSV generation with PapaParse"
      exports: ["exportContactsToCsv", "downloadCsv"]
    - path: "src/app/(dashboard)/crm/contactos/components/csv-import-dialog.tsx"
      provides: "Import wizard with column mapping"
    - path: "src/app/(dashboard)/crm/contactos/components/csv-export-button.tsx"
      provides: "Export button with column selection"
  key_links:
    - from: "csv-import-dialog.tsx"
      to: "src/app/actions/contacts.ts"
      via: "bulkCreateContacts Server Action"
      pattern: "bulkCreateContacts"
    - from: "csv-export-button.tsx"
      to: "src/lib/csv/exporter.ts"
      via: "exportContactsToCsv call"
      pattern: "exportContactsToCsv"
---

<objective>
Implement CSV import and export for contacts. Import uses react-csv-importer for column mapping UI with duplicate detection. Export uses PapaParse to generate CSV with user-selected columns.

Purpose: Users need to migrate data from spreadsheets and export data for reporting/backup.
Output: Import dialog with mapping and duplicate resolution, export button with column selection.
</objective>

<execution_context>
@/home/jose147/.claude/get-shit-done/workflows/execute-plan.md
@/home/jose147/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/05-contacts-extended/05-CONTEXT.md
@.planning/phases/05-contacts-extended/05-RESEARCH.md
@.planning/phases/05-contacts-extended/05-02-SUMMARY.md
@src/app/actions/contacts.ts
@src/lib/utils/phone.ts
@src/lib/custom-fields/types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install dependencies and create CSV utilities</name>
  <files>package.json, src/lib/csv/parser.ts, src/lib/csv/exporter.ts</files>
  <action>
**Install dependencies:**
```bash
cd morfx && pnpm add papaparse react-csv-importer && pnpm add -D @types/papaparse
```

**src/lib/csv/parser.ts:**

Create CSV parsing utilities:

```typescript
import Papa from 'papaparse'
import { normalizePhone } from '@/lib/utils/phone'

interface ParsedContact {
  name: string
  phone: string
  email?: string
  city?: string
  address?: string
  custom_fields: Record<string, unknown>
}

interface ParseResult {
  valid: ParsedContact[]
  invalid: { row: number; data: Record<string, string>; errors: string[] }[]
  duplicates: { row: number; data: ParsedContact; existingPhone: string }[]
}

export async function parseContactsCsv(
  file: File,
  existingPhones: Set<string>,
  customFieldKeys: string[]
): Promise<ParseResult> {
  return new Promise((resolve) => {
    const result: ParseResult = { valid: [], invalid: [], duplicates: [] }
    let rowNum = 0

    Papa.parse<Record<string, string>>(file, {
      header: true,
      skipEmptyLines: true,
      transformHeader: (h) => h.trim().toLowerCase().replace(/\s+/g, '_'),
      worker: true,

      step: (row) => {
        rowNum++
        const errors: string[] = []

        // Validate required fields
        const name = row.data.nombre || row.data.name
        const phone = row.data.telefono || row.data.phone || row.data.celular

        if (!name?.trim()) errors.push('Nombre requerido')
        if (!phone?.trim()) errors.push('Telefono requerido')

        // Normalize phone
        const normalizedPhone = phone ? normalizePhone(phone) : null
        if (phone && !normalizedPhone) errors.push('Telefono invalido')

        if (errors.length > 0) {
          result.invalid.push({ row: rowNum, data: row.data, errors })
          return
        }

        // Build contact object
        const contact: ParsedContact = {
          name: name!.trim(),
          phone: normalizedPhone!,
          email: (row.data.email || row.data.correo)?.trim() || undefined,
          city: (row.data.ciudad || row.data.city)?.trim() || undefined,
          address: (row.data.direccion || row.data.address)?.trim() || undefined,
          custom_fields: {}
        }

        // Extract custom fields
        for (const key of customFieldKeys) {
          if (row.data[key] !== undefined && row.data[key] !== '') {
            contact.custom_fields[key] = row.data[key]
          }
        }

        // Check for duplicates
        if (existingPhones.has(normalizedPhone!)) {
          result.duplicates.push({
            row: rowNum,
            data: contact,
            existingPhone: normalizedPhone!
          })
          return
        }

        result.valid.push(contact)
      },

      complete: () => resolve(result)
    })
  })
}
```

**src/lib/csv/exporter.ts:**

Create CSV export utilities:

```typescript
import Papa from 'papaparse'
import type { Contact } from '@/lib/types/database'
import type { CustomFieldDefinition } from '@/lib/custom-fields/types'

interface ExportOptions {
  contacts: Contact[]
  standardFields: string[]  // ['name', 'phone', 'email', 'city', 'address']
  customFields: CustomFieldDefinition[]  // Field definitions to include
}

const FIELD_LABELS: Record<string, string> = {
  name: 'Nombre',
  phone: 'Telefono',
  email: 'Email',
  city: 'Ciudad',
  address: 'Direccion',
  created_at: 'Fecha de creacion'
}

export function exportContactsToCsv(options: ExportOptions): string {
  const { contacts, standardFields, customFields } = options

  // Build header labels
  const headers = [
    ...standardFields.map(f => FIELD_LABELS[f] || f),
    ...customFields.map(f => f.name)
  ]

  // Transform contacts to export rows
  const data = contacts.map(contact => {
    const row: Record<string, string> = {}

    // Standard fields
    for (const field of standardFields) {
      const value = contact[field as keyof Contact]
      row[FIELD_LABELS[field] || field] = formatExportValue(value)
    }

    // Custom fields
    for (const field of customFields) {
      const value = contact.custom_fields?.[field.key]
      row[field.name] = formatExportValue(value, field.field_type)
    }

    return row
  })

  return Papa.unparse(data, {
    header: true,
    quotes: true,
    quoteChar: '"',
    escapeChar: '"',
    delimiter: ',',
    newline: '\r\n',
    columns: headers
  })
}

function formatExportValue(value: unknown, fieldType?: string): string {
  if (value === null || value === undefined) return ''
  if (fieldType === 'date' && value) {
    return new Date(value as string).toISOString().split('T')[0]
  }
  if (fieldType === 'checkbox') {
    return value ? 'Si' : 'No'
  }
  return String(value)
}

export function downloadCsv(csv: string, filename: string) {
  // BOM for Excel UTF-8 compatibility
  const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8' })
  const url = URL.createObjectURL(blob)
  const link = document.createElement('a')
  link.href = url
  link.download = filename
  document.body.appendChild(link)
  link.click()
  document.body.removeChild(link)
  URL.revokeObjectURL(url)
}
```
  </action>
  <verify>
1. Dependencies installed: `cd morfx && pnpm list papaparse react-csv-importer`
2. TypeScript compiles: `cd morfx && pnpm exec tsc --noEmit`
  </verify>
  <done>PapaParse and react-csv-importer installed, CSV utilities created</done>
</task>

<task type="auto">
  <name>Task 2: Create bulk import Server Action and import dialog</name>
  <files>src/app/actions/contacts.ts, src/app/(dashboard)/crm/contactos/components/csv-import-dialog.tsx, src/app/(dashboard)/crm/contactos/components/duplicate-resolver.tsx</files>
  <action>
**Add to src/app/actions/contacts.ts:**

```typescript
export async function bulkCreateContacts(contacts: {
  name: string
  phone: string
  email?: string
  city?: string
  address?: string
  custom_fields?: Record<string, unknown>
}[]): Promise<{ created: number; errors: { row: number; error: string }[] }> {
  // Validate all contacts
  // Insert in batches of 100
  // Return count of created and any errors
}

export async function getExistingPhones(): Promise<string[]> {
  // Return all phone numbers in workspace for duplicate detection
}

export async function updateContactByPhone(phone: string, data: Partial<Contact>): Promise<{ success: boolean; error?: string }> {
  // Update existing contact by phone number
  // Used for "update" option in duplicate resolution
}
```

**src/app/(dashboard)/crm/contactos/components/csv-import-dialog.tsx:**

Import wizard dialog using react-csv-importer:

```typescript
'use client'

import { Importer, ImporterField } from 'react-csv-importer'
import 'react-csv-importer/dist/index.css'
import { useState, useEffect } from 'react'
import { Dialog, DialogContent, DialogHeader, DialogTitle, DialogDescription } from '@/components/ui/dialog'
import { bulkCreateContacts, getExistingPhones } from '@/app/actions/contacts'
import { getCustomFields } from '@/app/actions/custom-fields'
import { DuplicateResolver } from './duplicate-resolver'

interface CsvImportDialogProps {
  open: boolean
  onOpenChange: (open: boolean) => void
  onImportComplete: () => void
}

export function CsvImportDialog({ open, onOpenChange, onImportComplete }: CsvImportDialogProps)
```

Flow:
1. Show Importer component with field mapping
2. Collect valid rows and duplicates
3. If duplicates exist, show DuplicateResolver
4. Create contacts via bulkCreateContacts
5. Show results (X created, Y skipped, Z errors)
6. Close dialog and refresh contacts list

Standard ImporterFields:
- name/nombre (required)
- phone/telefono (required)
- email/correo (optional)
- city/ciudad (optional)
- address/direccion (optional)

Dynamic ImporterFields for custom fields (from getCustomFields)

**src/app/(dashboard)/crm/contactos/components/duplicate-resolver.tsx:**

Dialog for resolving duplicate contacts:

```typescript
interface DuplicateEntry {
  row: number
  csvData: ParsedContact
  existingContact: Contact
}

interface DuplicateResolverProps {
  duplicates: DuplicateEntry[]
  onResolve: (resolutions: Map<number, 'skip' | 'update' | 'create_new'>) => void
  onCancel: () => void
}

export function DuplicateResolver({ duplicates, onResolve, onCancel }: DuplicateResolverProps)
```

UI:
- List each duplicate with side-by-side comparison (CSV vs Existing)
- For each: radio buttons for Skip / Update existing / Create new
- "Aplicar a todos" option: apply same choice to all duplicates
- Confirm button to proceed with resolutions
  </action>
  <verify>Components render, import dialog opens</verify>
  <done>CSV import dialog with column mapping and duplicate resolution</done>
</task>

<task type="auto">
  <name>Task 3: Create export button and integrate import/export into contacts page</name>
  <files>src/app/(dashboard)/crm/contactos/components/csv-export-button.tsx, src/app/(dashboard)/crm/contactos/page.tsx</files>
  <action>
**src/app/(dashboard)/crm/contactos/components/csv-export-button.tsx:**

Export button with column selection popover:

```typescript
'use client'

import { useState } from 'react'
import { Button } from '@/components/ui/button'
import { Popover, PopoverContent, PopoverTrigger } from '@/components/ui/popover'
import { Checkbox } from '@/components/ui/checkbox'
import { Download } from 'lucide-react'
import { exportContactsToCsv, downloadCsv } from '@/lib/csv/exporter'
import type { Contact } from '@/lib/types/database'
import type { CustomFieldDefinition } from '@/lib/custom-fields/types'

interface CsvExportButtonProps {
  contacts: Contact[]  // All or filtered contacts
  customFields: CustomFieldDefinition[]
  mode: 'filtered' | 'all'
  totalCount: number  // For showing "Export N contacts"
}

export function CsvExportButton({ contacts, customFields, mode, totalCount }: CsvExportButtonProps)
```

UI:
1. Button "Exportar" with Download icon
2. On click, open Popover with:
   - Radio: "Exportar todos (N)" / "Exportar filtrados (M)"
   - Checklist of standard fields (all checked by default)
   - Checklist of custom fields (all checked by default)
   - "Exportar CSV" button
3. On export:
   - Generate CSV with selected fields
   - Download as "contactos-{date}.csv"
   - Show toast "X contactos exportados"

**Update src/app/(dashboard)/crm/contactos/page.tsx (or contacts-table.tsx):**

Add import and export buttons to the toolbar:

```tsx
<div className="flex gap-2">
  <CsvImportDialog
    open={importOpen}
    onOpenChange={setImportOpen}
    onImportComplete={() => router.refresh()}
  />
  <Button variant="outline" onClick={() => setImportOpen(true)}>
    <Upload className="h-4 w-4 mr-2" />
    Importar
  </Button>
  <CsvExportButton
    contacts={filteredContacts}
    customFields={customFields}
    mode={hasFilters ? 'filtered' : 'all'}
    totalCount={allContacts.length}
  />
</div>
```

Make sure to:
- Pass filtered contacts when filters are active
- Pass all contacts otherwise
- Show toast on successful import/export
  </action>
  <verify>
1. Import button opens dialog
2. Export button shows column selection
3. Import creates contacts
4. Export downloads CSV file
  </verify>
  <done>
- Import button in contacts toolbar
- Export button with column selection
- Full import/export flow working
  </done>
</task>

</tasks>

<verification>
1. Dependencies installed: papaparse, react-csv-importer
2. TypeScript compiles: `cd morfx && pnpm exec tsc --noEmit`
3. Import dialog opens and shows column mapping
4. Duplicates are detected and shown for resolution
5. Export generates valid CSV with BOM for Excel
6. Custom fields included in both import and export
</verification>

<success_criteria>
- User can import contacts from CSV with column mapping
- Duplicates (by phone) are detected and user can choose how to handle each
- User can export contacts with selected columns
- Export includes custom field values
- Large files handled via streaming (no browser crash)
</success_criteria>

<output>
After completion, create `.planning/phases/05-contacts-extended/05-04-SUMMARY.md`
</output>
