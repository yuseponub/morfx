---
phase: 09-crm-whatsapp-sync
plan: 03
type: execute
wave: 2
depends_on: ["09-01"]
files_modified:
  - src/lib/whatsapp/types.ts
  - src/app/actions/orders.ts
  - src/app/actions/whatsapp.ts
autonomous: true

must_haves:
  truths:
    - "ConversationWithDetails includes contactTags property for inherited tags"
    - "Orders can be fetched by contact ID for WhatsApp display"
    - "Order stage changes are available for realtime sync"
  artifacts:
    - path: "src/lib/whatsapp/types.ts"
      provides: "Extended conversation types with dual tag sources"
      contains: "contactTags"
    - path: "src/app/actions/whatsapp.ts"
      provides: "Extended WhatsApp actions for order display"
      exports: ["getContactOrders"]
  key_links:
    - from: "ConversationWithDetails"
      to: "Tag arrays"
      via: "tags and contactTags properties"
      pattern: "contactTags.*Tag"
---

<objective>
Extend WhatsApp types and add order fetching for contact panel display.

Purpose: This plan updates the TypeScript types to support dual tag sources (conversation vs contact), and adds server actions to efficiently fetch order data for display in the WhatsApp contact panel and conversation list indicators.

Output: Extended WhatsApp types, order fetching actions for WhatsApp context.
</objective>

<execution_context>
@/home/jose147/.claude/get-shit-done/workflows/execute-plan.md
@/home/jose147/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-crm-whatsapp-sync/09-CONTEXT.md
@.planning/phases/09-crm-whatsapp-sync/09-RESEARCH.md
@.planning/phases/09-crm-whatsapp-sync/09-01-SUMMARY.md

# Existing patterns
@src/lib/whatsapp/types.ts
@src/app/actions/whatsapp.ts
@src/app/actions/orders.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update ConversationWithDetails type</name>
  <files>src/lib/whatsapp/types.ts</files>
  <action>
Update the ConversationWithDetails interface to include both conversation-specific tags and inherited contact tags.

Find the existing ConversationWithDetails interface and update it:

```typescript
/**
 * Conversation with contact details for UI display.
 * Tags are split into two sources:
 * - tags: Direct conversation tags (applied to the conversation)
 * - contactTags: Inherited from linked contact (read-only in conversation context)
 */
export interface ConversationWithDetails extends Conversation {
  contact: {
    id: string
    name: string
    phone: string
    address: string | null
    city: string | null
  } | null
  /** Direct tags applied to this conversation */
  tags: Array<{
    id: string
    name: string
    color: string
  }>
  /** Inherited tags from linked contact (read-only display) */
  contactTags: Array<{
    id: string
    name: string
    color: string
  }>
  // Assignee info (joined from profiles)
  assigned_name?: string | null
}
```

Also add a new type for orders with stage info for the contact panel:

```typescript
/**
 * Order summary for display in WhatsApp contact panel.
 * Minimal fields needed for order indicators and list display.
 */
export interface OrderSummary {
  id: string
  total_value: number | null
  stage: {
    id: string
    name: string
    color: string
    is_closed: boolean
  }
  pipeline: {
    id: string
    name: string
  }
  created_at: string
  updated_at: string
}
```
  </action>
  <verify>
```bash
cd /mnt/c/Users/Usuario/Proyectos/morfx-new && npx tsc --noEmit src/lib/whatsapp/types.ts
```
  </verify>
  <done>
ConversationWithDetails has contactTags property, OrderSummary type defined.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add order fetching for WhatsApp context</name>
  <files>src/app/actions/whatsapp.ts</files>
  <action>
Extend the whatsapp.ts actions file with functions to fetch orders for contact panel and conversation list indicators.

Add these new functions:

```typescript
// ============================================================================
// ORDER FETCHING FOR WHATSAPP CONTEXT
// ============================================================================

import type { OrderSummary } from '@/lib/whatsapp/types'
import { getOrderPhase } from '@/lib/orders/stage-phases'

/**
 * Get all orders for a contact with stage information.
 * Used for order indicators in conversation list and contact panel.
 *
 * @param contactId - The contact ID to fetch orders for
 * @param limit - Maximum number of orders to return (default: 10)
 */
export async function getContactOrders(
  contactId: string,
  limit: number = 10
): Promise<OrderSummary[]> {
  const supabase = await createClient()

  const { data: { user } } = await supabase.auth.getUser()
  if (!user) {
    return []
  }

  const { data, error } = await supabase
    .from('orders')
    .select(`
      id,
      total_value,
      created_at,
      updated_at,
      stage:pipeline_stages(id, name, color, is_closed),
      pipeline:pipelines(id, name)
    `)
    .eq('contact_id', contactId)
    .order('created_at', { ascending: false })
    .limit(limit)

  if (error) {
    console.error('Error fetching contact orders:', error)
    return []
  }

  // Transform to OrderSummary format
  return (data || []).map((order) => ({
    id: order.id,
    total_value: order.total_value,
    stage: order.stage as OrderSummary['stage'],
    pipeline: order.pipeline as OrderSummary['pipeline'],
    created_at: order.created_at,
    updated_at: order.updated_at,
  })).filter(order => order.stage !== null)
}

/**
 * Get active (non-won) orders for a contact.
 * Used for order status indicators in conversation list.
 * Active = stage is not closed OR stage name is not 'Ganado'
 */
export async function getActiveContactOrders(
  contactId: string,
  limit: number = 5
): Promise<OrderSummary[]> {
  const orders = await getContactOrders(contactId, limit * 2) // Fetch more to filter

  // Filter out won orders
  return orders
    .filter(order => {
      const phase = getOrderPhase(order.stage.name)
      return phase !== 'won'
    })
    .slice(0, limit)
}

/**
 * Get orders for multiple contacts in batch.
 * Used for efficiently loading order indicators in conversation list.
 *
 * @param contactIds - Array of contact IDs
 * @returns Map of contactId -> OrderSummary[]
 */
export async function getOrdersForContacts(
  contactIds: string[]
): Promise<Map<string, OrderSummary[]>> {
  const supabase = await createClient()

  const { data: { user } } = await supabase.auth.getUser()
  if (!user) {
    return new Map()
  }

  if (contactIds.length === 0) {
    return new Map()
  }

  const { data, error } = await supabase
    .from('orders')
    .select(`
      id,
      contact_id,
      total_value,
      created_at,
      updated_at,
      stage:pipeline_stages(id, name, color, is_closed),
      pipeline:pipelines(id, name)
    `)
    .in('contact_id', contactIds)
    .order('created_at', { ascending: false })

  if (error) {
    console.error('Error fetching orders for contacts:', error)
    return new Map()
  }

  // Group by contact_id
  const ordersByContact = new Map<string, OrderSummary[]>()

  for (const order of data || []) {
    if (!order.stage || !order.contact_id) continue

    const contactId = order.contact_id as string
    const existing = ordersByContact.get(contactId) || []
    existing.push({
      id: order.id,
      total_value: order.total_value,
      stage: order.stage as OrderSummary['stage'],
      pipeline: order.pipeline as OrderSummary['pipeline'],
      created_at: order.created_at,
      updated_at: order.updated_at,
    })
    ordersByContact.set(contactId, existing)
  }

  return ordersByContact
}
```

Make sure to add the necessary imports at the top of the file:

```typescript
import { createClient } from '@/lib/supabase/server'
import type { OrderSummary } from '@/lib/whatsapp/types'
import { getOrderPhase } from '@/lib/orders/stage-phases'
```

Note: whatsapp.ts already exists from Phase 7 with conversation CRUD actions. Add these new order-fetching functions to the existing file.
  </action>
  <verify>
```bash
cd /mnt/c/Users/Usuario/Proyectos/morfx-new && npx tsc --noEmit src/app/actions/whatsapp.ts
```
  </verify>
  <done>
whatsapp.ts exports getContactOrders, getActiveContactOrders, getOrdersForContacts functions.
  </done>
</task>

</tasks>

<verification>
1. TypeScript compiles without errors
2. ConversationWithDetails has contactTags array
3. Order fetching functions return proper OrderSummary types
4. getOrderPhase import works correctly
</verification>

<success_criteria>
- ConversationWithDetails type includes contactTags property
- OrderSummary type defined for order display
- getContactOrders returns orders with stage info
- getOrdersForContacts provides batch order loading
</success_criteria>

<output>
After completion, create `.planning/phases/09-crm-whatsapp-sync/09-03-SUMMARY.md`
</output>
