# Phase 15.5: Somnio Ingest System - Context

**Gathered:** 2026-02-07
**Status:** Ready for planning

<domain>
## Phase Boundary

Sistema de acumulaci√≥n de datos del cliente durante el modo `collecting_data`. Incluye:
- Detecci√≥n inteligente de si el mensaje es datos, pregunta, mixto o irrelevante
- Comportamiento de silencio mientras acumula datos
- Timers de espera (6 min parcial / 10 min sin datos)
- Manejo de "s√≠ impl√≠cito" cuando cliente env√≠a datos sin confirmaci√≥n previa

NO incluye: cambios a templates, modificaciones al flujo de ofrecer_promos, ni l√≥gica de creaci√≥n de √≥rdenes.

</domain>

<decisions>
## Implementation Decisions

### Detecci√≥n datos vs pregunta
- Usar LLM (Claude Haiku) para clasificar CADA mensaje en modo `collecting_data`
- 4 categor√≠as de clasificaci√≥n: `datos` | `pregunta` | `mixto` | `irrelevante`
- Si es `mixto` (ej: "Jose Romero, cu√°nto cuesta?"): extraer datos Y responder pregunta
- Si es `irrelevante` (ok, gracias, üëç): ignorar silenciosamente, no afecta timer

### Comportamiento de silencio
- Cuando el mensaje es `datos`: NO responder, solo acumular silenciosamente
- El bot permanece en silencio durante todo el per√≠odo de ingest
- Solo responde cuando: (1) pregunta, (2) timer expira, (3) datos completos
- En Sandbox: mostrar estado del ingest en Tab Estado, no como pseudo-tool

### Timers y timeouts
- **6 minutos** si envi√≥ datos parciales
- **10 minutos** si no envi√≥ ning√∫n dato
- Timer empieza con el PRIMER dato, NO se reinicia con datos adicionales
- Mensaje al expirar SIN datos: "Quedamos pendientes a tus datos, o si tienes alguna pregunta acerca del producto no dudes en hacerla"
- Mensaje al expirar con datos PARCIALES:
  ```
  Para poder despachar tu producto nos faltaria:
  - [campo faltante 1]
  - [campo faltante 2]
  - ...
  Quedamos pendientesü§ó
  ```

### S√≠ impl√≠cito (datos sin confirmaci√≥n)
- Si cliente env√≠a datos SIN decir "s√≠" primero ‚Üí "s√≠ impl√≠cito"
- Flujo: entrar a `collecting_data` + enviar 2 plantillas + extraer datos enviados
- Usar mismo LLM clasificador para detectar datos fuera de `collecting_data`
- Si env√≠a TODOS los 8 campos de una vez ‚Üí saltar directo a `ofrecer_promos`
- Si mensaje tiene saludo + datos (ej: "Hola, soy Jose"): responder saludo + collecting_data + extraer nombre

### Claude's Discretion
- Estructura exacta del prompt para el clasificador LLM
- Manejo de errores si LLM falla en clasificaci√≥n
- Formato exacto del ingestStatus en el estado del sandbox

</decisions>

<specifics>
## Specific Ideas

- El clasificador debe ser r√°pido (Haiku) porque se ejecuta en cada mensaje
- Los mensajes de timeout ya existen en n8n con el formato exacto documentado arriba
- El ingest debe integrarse con el timer de Inngest existente (`dataCollectionTimer`)

</specifics>

<deferred>
## Deferred Ideas

- Ninguna ‚Äî la discusi√≥n se mantuvo dentro del alcance de la fase

</deferred>

---

*Phase: 15.5-somnio-ingest-system*
*Context gathered: 2026-02-07*
