---
phase: 19-ai-automation-builder
plan: 08
type: execute
wave: 4
depends_on: ["19-05"]
files_modified:
  - src/app/(dashboard)/automatizaciones/builder/components/session-history.tsx
  - src/app/(dashboard)/automatizaciones/builder/components/builder-layout.tsx
  - src/app/api/builder/sessions/route.ts
autonomous: true

must_haves:
  truths:
    - "User can see a list of past builder sessions"
    - "User can click a past session to load its conversation"
    - "User can start a new session while viewing history"
    - "Sessions show title, date, and count of automations created"
  artifacts:
    - path: "src/app/(dashboard)/automatizaciones/builder/components/session-history.tsx"
      provides: "Session list sidebar/panel for browsing past builder conversations"
      min_lines: 60
    - path: "src/app/api/builder/sessions/route.ts"
      provides: "GET endpoint for listing sessions, DELETE for removing"
      exports: ["GET", "DELETE"]
      min_lines: 40
  key_links:
    - from: "src/app/(dashboard)/automatizaciones/builder/components/session-history.tsx"
      to: "/api/builder/sessions"
      via: "fetch for session list"
      pattern: "fetch.*api/builder/sessions"
    - from: "src/app/api/builder/sessions/route.ts"
      to: "src/lib/builder/session-store.ts"
      via: "getSessions, deleteSession"
      pattern: "getSessions|deleteSession"
---

<objective>
Create the session history UI and API endpoints so users can browse and resume past builder conversations. Sessions are listed in a sidebar/panel and can be loaded into the chat.

Purpose: Enable multi-session workflow â€” users can revisit past conversations and continue where they left off.
Output: Session history panel, sessions API endpoint, resume functionality.
</objective>

<execution_context>
@/home/jose147/.claude/get-shit-done/workflows/execute-plan.md
@/home/jose147/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/19-ai-automation-builder/19-05-PLAN.md
@src/lib/builder/session-store.ts
@src/lib/builder/types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create sessions API endpoint</name>
  <files>src/app/api/builder/sessions/route.ts</files>
  <action>
    Create `src/app/api/builder/sessions/route.ts` with GET and DELETE handlers.

    Both handlers share the same auth pattern:
    ```typescript
    import { createClient } from '@/lib/supabase/server'
    import { cookies } from 'next/headers'
    import { getSessions, getSession, deleteSession } from '@/lib/builder/session-store'
    import { NextResponse } from 'next/server'

    async function getAuthCtx() {
      const supabase = await createClient()
      const { data: { user } } = await supabase.auth.getUser()
      if (!user) return null

      const cookieStore = await cookies()
      const workspaceId = cookieStore.get('morfx_workspace')?.value
      if (!workspaceId) return null

      return { userId: user.id, workspaceId }
    }
    ```

    **GET handler**:
    - Extract optional `?sessionId=xxx` query param
    - If sessionId provided: return the full session (with messages) via `getSession(sessionId, workspaceId)`
    - If no sessionId: return list of sessions (without messages) via `getSessions(workspaceId, userId, 20)`
    - Return 401 if not authenticated

    **DELETE handler**:
    - Extract `sessionId` from request body or URL search params
    - Call `deleteSession(sessionId, workspaceId)`
    - Return 200 on success, 401 if not auth, 400 if no sessionId
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - File exports GET and DELETE functions
    - Both validate auth before proceeding
  </verify>
  <done>
    - GET /api/builder/sessions returns session list or single session with messages
    - DELETE /api/builder/sessions removes a session
    - Both endpoints validate auth and workspace
  </done>
</task>

<task type="auto">
  <name>Task 2: Create session history component and integrate into layout</name>
  <files>
    src/app/(dashboard)/automatizaciones/builder/components/session-history.tsx
    src/app/(dashboard)/automatizaciones/builder/components/builder-layout.tsx
  </files>
  <action>
    1. **SessionHistory** (`session-history.tsx`):
    Client component that fetches and displays past builder sessions.

    Props:
    ```typescript
    interface SessionHistoryProps {
      currentSessionId: string | null
      onSelectSession: (sessionId: string) => void
      onNewSession: () => void
    }
    ```

    Implementation:
    - Fetch sessions from `/api/builder/sessions` on mount and when currentSessionId changes
    - Use `useState` for sessions array and loading state
    - Display as a vertical list:
      - Each item: title (or "Session sin titulo"), date (relative: "hace 2 horas"), automations count badge
      - Current session highlighted with primary color
      - Click handler calls `onSelectSession(sessionId)`
      - Delete button (Trash2 icon) on hover, calls DELETE endpoint then refreshes list

    - "Nueva sesion" button at the top (Plus icon) calls `onNewSession()`

    - If no sessions: show "No hay sesiones anteriores" empty state

    - Style: compact list with `text-sm`, `hover:bg-muted` for items, `border-b` separators

    2. **Update BuilderLayout** (`builder-layout.tsx`):

    Add session history as a collapsible side panel:

    - Add a "Historial" button (Clock icon) in the header that toggles `showHistory` state
    - When showHistory is true, render SessionHistory in a side panel (absolute positioned overlay or a left panel, max-w-72)
    - SessionHistory receives currentSessionId and callbacks

    Add session loading logic:
    ```typescript
    const handleSelectSession = useCallback(async (sessionId: string) => {
      // Fetch full session from API
      const res = await fetch(`/api/builder/sessions?sessionId=${sessionId}`)
      const session = await res.json()
      if (session) {
        setSessionId(session.id)
        setSessionTitle(session.title)
        // Need to pass loaded messages to BuilderChat
        setInitialMessages(session.messages)
      }
      setShowHistory(false)
    }, [])
    ```

    Pass `initialMessages` to BuilderChat. BuilderChat needs to accept an `initialMessages` prop and pass it to useChat:
    ```typescript
    const { ... } = useChat({
      api: '/api/builder/chat',
      body: { sessionId },
      initialMessages: initialMessages,
      ...
    })
    ```

    Update BuilderChat props to include `initialMessages`.

    When `onNewSession` is called:
    - Reset sessionId to null
    - Reset initialMessages to empty array
    - Use useChat's `setMessages` to clear the current conversation (or rely on key change to remount)

    A clean approach for resetting: use a `key` prop on BuilderChat that changes when a new session or loaded session is set. This forces useChat to reinitialize.
    ```tsx
    <BuilderChat
      key={sessionId || 'new'}
      sessionId={sessionId}
      initialMessages={initialMessages}
      onSessionCreated={handleSessionCreated}
    />
    ```
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - SessionHistory fetches from /api/builder/sessions
    - Layout has Historial toggle button
    - Selecting a session loads its messages into the chat
    - New session clears the chat
  </verify>
  <done>
    - Session history panel shows past sessions with titles and dates
    - Clicking a session loads its conversation into the chat
    - "Nueva sesion" starts fresh
    - Delete button removes sessions
    - Current session is highlighted
  </done>
</task>

</tasks>

<verification>
- TypeScript compiles: `npx tsc --noEmit`
- Sessions API returns correct data
- History panel lists sessions
- Loading a session restores its messages
- Creating new session clears chat
</verification>

<success_criteria>
Users can browse past builder sessions, resume conversations, and start new ones. Session history persists across page reloads. Sessions show metadata (title, date, automations created).
</success_criteria>

<output>
After completion, create `.planning/phases/19-ai-automation-builder/19-08-SUMMARY.md`
</output>
