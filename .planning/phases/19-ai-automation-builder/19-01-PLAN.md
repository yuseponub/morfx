---
phase: 19-ai-automation-builder
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - src/lib/builder/types.ts
  - supabase/migrations/YYYYMMDD_builder_sessions.sql
autonomous: true

must_haves:
  truths:
    - "AI SDK, AI SDK Anthropic provider, and React Flow packages are installed and importable"
    - "Builder-specific TypeScript types exist for sessions, diagram data, and validation results"
    - "builder_sessions table exists in DB with workspace isolation"
  artifacts:
    - path: "src/lib/builder/types.ts"
      provides: "BuilderSession, DiagramData, DiagramNode, DiagramEdge, ValidationResult, BuilderToolContext types"
      min_lines: 80
    - path: "supabase/migrations/YYYYMMDD_builder_sessions.sql"
      provides: "builder_sessions table with workspace_id, user_id, title, messages JSONB, automations_created UUID[]"
      contains: "CREATE TABLE builder_sessions"
  key_links:
    - from: "src/lib/builder/types.ts"
      to: "src/lib/automations/types.ts"
      via: "imports AutomationFormData, TriggerType, ActionType"
      pattern: "import.*from.*automations/types"
---

<objective>
Install dependencies (ai, @ai-sdk/anthropic, @xyflow/react) and create the foundational type system and database table for the AI Automation Builder.

Purpose: Establish the type contracts and data layer that all subsequent builder plans depend on.
Output: Installed packages, TypeScript types file, DB migration for builder sessions.
</objective>

<execution_context>
@/home/jose147/.claude/get-shit-done/workflows/execute-plan.md
@/home/jose147/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/lib/automations/types.ts
@src/lib/automations/constants.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install dependencies and create builder types</name>
  <files>
    package.json
    src/lib/builder/types.ts
  </files>
  <action>
    1. Install packages: `npm install ai @ai-sdk/anthropic @xyflow/react`

    2. Create `src/lib/builder/types.ts` with ZERO project imports except from `@/lib/automations/types`:

    ```typescript
    import type { AutomationFormData, TriggerType, ActionType, AutomationAction, ConditionGroup } from '@/lib/automations/types'
    ```

    Define the following types:

    - `BuilderSession`: id (UUID), workspace_id, user_id, title (string|null), messages (unknown[] — AI SDK message format), automations_created (string[]), created_at, updated_at

    - `DiagramNode`: extends React Flow Node concept — id, type ('triggerNode' | 'conditionNode' | 'actionNode'), position ({x, y}), data (label, hasError, errorMessage, plus type-specific fields like triggerType, actionType, conditions, params, delay)

    - `DiagramEdge`: id, source, target, animated (boolean)

    - `DiagramData`: nodes (DiagramNode[]), edges (DiagramEdge[]), validationErrors ({nodeId: string, message: string}[])

    - `ValidationResult`: nodeId, valid (boolean), errors (string[])

    - `ResourceValidation`: type ('pipeline' | 'stage' | 'tag' | 'template' | 'user'), name (string), found (boolean), id (string | null), details (string | null)

    - `BuilderToolContext`: workspaceId (string), userId (string)

    - `AutomationPreviewData`: name, description, trigger_type (TriggerType), trigger_config (Record<string, unknown>), conditions (ConditionGroup | null), actions (AutomationAction[]), diagram (DiagramData), resourceValidations (ResourceValidation[]), hasCycles (boolean), duplicateWarning (string | null)

    - `BuilderMessage`: Re-export or alias for AI SDK message type annotation (just a type comment, the actual type comes from `ai` package at runtime)

    Export all types. Use `as const` where appropriate. Follow the zero-import pattern for constants (no circular deps).
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - `node -e "require('@ai-sdk/anthropic')"` doesn't throw
    - `node -e "require('@xyflow/react')"` doesn't throw
    - `src/lib/builder/types.ts` exists and exports all types
  </verify>
  <done>
    - AI SDK, AI SDK Anthropic, and React Flow are in package.json dependencies
    - All builder types are defined and exported from `src/lib/builder/types.ts`
    - TypeScript compiles without errors
  </done>
</task>

<task type="auto">
  <name>Task 2: Create builder_sessions DB migration</name>
  <files>
    supabase/migrations/YYYYMMDD_builder_sessions.sql
  </files>
  <action>
    Create a new SQL migration file in `supabase/migrations/` with the next sequential timestamp.

    The migration should:

    1. Create `builder_sessions` table:
    ```sql
    CREATE TABLE builder_sessions (
      id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
      workspace_id UUID NOT NULL REFERENCES workspaces(id) ON DELETE CASCADE,
      user_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
      title TEXT,
      messages JSONB NOT NULL DEFAULT '[]',
      automations_created UUID[] DEFAULT '{}',
      created_at TIMESTAMPTZ NOT NULL DEFAULT timezone('America/Bogota', NOW()),
      updated_at TIMESTAMPTZ NOT NULL DEFAULT timezone('America/Bogota', NOW())
    );
    ```

    2. Add index on (workspace_id, user_id) for efficient queries.

    3. Add index on created_at for ordering.

    4. Enable RLS on builder_sessions:
    ```sql
    ALTER TABLE builder_sessions ENABLE ROW LEVEL SECURITY;
    ```

    5. Create RLS policies:
    - SELECT: workspace members can read sessions from their workspace
    - INSERT: workspace members can create sessions in their workspace
    - UPDATE: only the session owner (user_id matches) can update
    - DELETE: only the session owner can delete

    6. Add updated_at trigger (reuse existing `update_updated_at_column` trigger function if it exists in the project, otherwise create one):
    ```sql
    CREATE TRIGGER update_builder_sessions_updated_at
      BEFORE UPDATE ON builder_sessions
      FOR EACH ROW
      EXECUTE FUNCTION update_updated_at_column();
    ```

    Follow the America/Bogota timezone convention for all timestamps.
  </action>
  <verify>
    - Migration file exists in `supabase/migrations/`
    - File contains CREATE TABLE, RLS policies, indexes
    - No syntax errors in the SQL (visual inspection)
  </verify>
  <done>
    - `builder_sessions` table migration ready with workspace isolation, RLS, and indexes
    - Follows existing project conventions (timezone, UUID PKs, CASCADE on workspace delete)
  </done>
</task>

</tasks>

<verification>
- `npm ls ai @ai-sdk/anthropic @xyflow/react` shows all three installed
- `src/lib/builder/types.ts` exports at least 8 types
- Migration file exists and is valid SQL
- TypeScript compiles: `npx tsc --noEmit`
</verification>

<success_criteria>
All three new packages installed. Builder type system defined. Database migration for builder sessions created. TypeScript compiles without errors.
</success_criteria>

<output>
After completion, create `.planning/phases/19-ai-automation-builder/19-01-SUMMARY.md`
</output>
