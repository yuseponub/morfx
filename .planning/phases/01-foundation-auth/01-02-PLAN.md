---
phase: 01-foundation-auth
plan: 02
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - src/app/(auth)/login/page.tsx
  - src/app/(auth)/signup/page.tsx
  - src/app/(auth)/forgot-password/page.tsx
  - src/app/(auth)/reset-password/page.tsx
  - src/app/auth/callback/route.ts
  - src/app/auth/confirm/route.ts
  - src/app/actions/auth.ts
  - src/components/auth/login-form.tsx
  - src/components/auth/signup-form.tsx
  - src/components/auth/forgot-password-form.tsx
  - src/components/auth/reset-password-form.tsx
autonomous: true

must_haves:
  truths:
    - "User can register with email and password"
    - "User can login with valid credentials"
    - "User can logout from authenticated state"
    - "User can request password reset email"
    - "User can set new password via reset link"
    - "Session persists across page refresh"
  artifacts:
    - path: "src/app/(auth)/login/page.tsx"
      provides: "Login page"
      min_lines: 15
    - path: "src/app/(auth)/signup/page.tsx"
      provides: "Registration page"
      min_lines: 15
    - path: "src/components/auth/login-form.tsx"
      provides: "Login form with validation"
      contains: "zodResolver"
    - path: "src/components/auth/signup-form.tsx"
      provides: "Signup form with validation"
      contains: "signUp"
    - path: "src/app/auth/callback/route.ts"
      provides: "Auth code exchange handler"
      contains: "exchangeCodeForSession"
    - path: "src/app/actions/auth.ts"
      provides: "Server actions for auth"
      exports: ["logout"]
  key_links:
    - from: "src/components/auth/login-form.tsx"
      to: "Supabase auth"
      via: "signInWithPassword"
      pattern: "supabase\\.auth\\.signInWithPassword"
    - from: "src/components/auth/signup-form.tsx"
      to: "Supabase auth"
      via: "signUp"
      pattern: "supabase\\.auth\\.signUp"
    - from: "src/app/auth/callback/route.ts"
      to: "Supabase auth"
      via: "code exchange"
      pattern: "exchangeCodeForSession"
---

<objective>
Implement complete authentication flows: register, login, logout, password reset

Purpose: Enable users to create accounts, authenticate, and recover access
Output: Working auth pages with forms that connect to Supabase Auth
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-foundation-auth/CONTEXT.md
@.planning/phases/01-foundation-auth/01-RESEARCH.md
@.planning/phases/01-foundation-auth/01-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create auth route group and login/signup pages</name>
  <files>
    src/app/(auth)/layout.tsx
    src/app/(auth)/login/page.tsx
    src/app/(auth)/signup/page.tsx
    src/components/auth/login-form.tsx
    src/components/auth/signup-form.tsx
  </files>
  <action>
Add required shadcn/ui components first:
```bash
pnpm dlx shadcn@latest add input label card
```

Create auth route group with centered layout:

**src/app/(auth)/layout.tsx:**
- Centered card layout (flex, min-h-screen, items-center, justify-center)
- Subtle gradient or solid background (gray tones per CONTEXT.md)
- No sidebar, no header - auth pages are standalone

**src/components/auth/login-form.tsx:**
Client component with:
- react-hook-form + zod validation
- Schema: email (required, valid email), password (required, min 6 chars)
- Call `supabase.auth.signInWithPassword({ email, password })`
- On success: `router.push('/crm')` (or '/onboarding' for new users)
- On error: Display error message in form
- Links to: "Olvidaste tu contrasena?" (/forgot-password), "Crear cuenta" (/signup)
- Spanish labels: "Correo electronico", "Contrasena", "Iniciar sesion"
- Use shadcn/ui Input, Label, Button, Card components

**src/components/auth/signup-form.tsx:**
Client component with:
- Schema: email, password (min 8 chars), confirmPassword (must match)
- Call `supabase.auth.signUp({ email, password, options: { emailRedirectTo } })`
- emailRedirectTo: `${window.location.origin}/auth/callback`
- On success: Show "Revisa tu correo" message OR redirect to /onboarding (if email verify off)
- Handle "User already registered" error gracefully
- Spanish labels: "Correo electronico", "Contrasena", "Confirmar contrasena", "Crear cuenta"
- Link to: "Ya tienes cuenta? Inicia sesion" (/login)

**src/app/(auth)/login/page.tsx:**
- Import and render LoginForm
- Page title/metadata: "Iniciar sesion - MorfX"
- MorfX logo or name at top of card

**src/app/(auth)/signup/page.tsx:**
- Import and render SignupForm
- Page title/metadata: "Crear cuenta - MorfX"
- MorfX logo or name at top of card
  </action>
  <verify>
    - `pnpm build` passes
    - /login page renders login form
    - /signup page renders signup form
    - Form validation shows Spanish error messages
  </verify>
  <done>Login and signup pages with validated forms connected to Supabase Auth</done>
</task>

<task type="auto">
  <name>Task 2: Create password reset flow and auth callback handlers</name>
  <files>
    src/app/(auth)/forgot-password/page.tsx
    src/app/(auth)/reset-password/page.tsx
    src/components/auth/forgot-password-form.tsx
    src/components/auth/reset-password-form.tsx
    src/app/auth/callback/route.ts
    src/app/auth/confirm/route.ts
  </files>
  <action>
**src/components/auth/forgot-password-form.tsx:**
Client component with:
- Schema: email only
- Call `supabase.auth.resetPasswordForEmail(email, { redirectTo })`
- redirectTo: `${window.location.origin}/auth/callback?next=/reset-password`
- On success: Show "Revisa tu correo para resetear tu contrasena"
- Spanish: "Correo electronico", "Enviar enlace de recuperacion"
- Link back to login

**src/components/auth/reset-password-form.tsx:**
Client component with:
- Schema: password (min 8), confirmPassword (must match)
- Call `supabase.auth.updateUser({ password })`
- On success: redirect to /login with success message
- On error: Show error message
- Spanish: "Nueva contrasena", "Confirmar contrasena", "Actualizar contrasena"

**src/app/(auth)/forgot-password/page.tsx:**
- Render ForgotPasswordForm in centered card
- Title: "Recuperar contrasena"

**src/app/(auth)/reset-password/page.tsx:**
- Render ResetPasswordForm in centered card
- Title: "Nueva contrasena"
- This page is accessed after clicking email link

**src/app/auth/callback/route.ts:**
Route handler for OAuth/email callbacks:
```typescript
import { createClient } from '@/lib/supabase/server'
import { NextResponse } from 'next/server'

export async function GET(request: Request) {
  const { searchParams, origin } = new URL(request.url)
  const code = searchParams.get('code')
  const next = searchParams.get('next') ?? '/crm'

  if (code) {
    const supabase = await createClient()
    const { error } = await supabase.auth.exchangeCodeForSession(code)
    if (!error) {
      return NextResponse.redirect(`${origin}${next}`)
    }
  }

  return NextResponse.redirect(`${origin}/login?error=auth_callback_error`)
}
```

**src/app/auth/confirm/route.ts:**
Route handler for email confirmation (PKCE flow):
```typescript
import { createClient } from '@/lib/supabase/server'
import { NextResponse } from 'next/server'

export async function GET(request: Request) {
  const { searchParams, origin } = new URL(request.url)
  const token_hash = searchParams.get('token_hash')
  const type = searchParams.get('type') as 'email' | 'recovery' | null
  const next = searchParams.get('next') ?? '/crm'

  if (token_hash && type) {
    const supabase = await createClient()
    const { error } = await supabase.auth.verifyOtp({ token_hash, type })
    if (!error) {
      return NextResponse.redirect(`${origin}${next}`)
    }
  }

  return NextResponse.redirect(`${origin}/login?error=confirmation_error`)
}
```
  </action>
  <verify>
    - `pnpm build` passes
    - /forgot-password page renders form
    - /reset-password page renders form
    - /auth/callback route handler exists
    - /auth/confirm route handler exists
  </verify>
  <done>Password reset flow complete with email request, callback handling, and new password form</done>
</task>

<task type="auto">
  <name>Task 3: Create logout action and update middleware for auth routes</name>
  <files>
    src/app/actions/auth.ts
    middleware.ts
  </files>
  <action>
**src/app/actions/auth.ts:**
Server action for logout:
```typescript
'use server'

import { createClient } from '@/lib/supabase/server'
import { redirect } from 'next/navigation'

export async function logout() {
  const supabase = await createClient()
  await supabase.auth.signOut()
  redirect('/login')
}
```

**Update middleware.ts:**
Ensure middleware allows access to all auth routes without authentication:

```typescript
// Routes that don't require authentication
const publicPaths = [
  '/login',
  '/signup',
  '/forgot-password',
  '/reset-password',
  '/auth/callback',
  '/auth/confirm',
]

// In middleware function, after getting user:
const isPublicPath = publicPaths.some(path =>
  request.nextUrl.pathname.startsWith(path)
)

if (!user && !isPublicPath) {
  const url = request.nextUrl.clone()
  url.pathname = '/login'
  return NextResponse.redirect(url)
}

// Redirect authenticated users away from auth pages (optional but good UX)
if (user && isPublicPath && !request.nextUrl.pathname.startsWith('/auth/')) {
  const url = request.nextUrl.clone()
  url.pathname = '/crm'
  return NextResponse.redirect(url)
}
```

Also update the root page (src/app/page.tsx) to redirect:
- If authenticated: redirect to /crm
- If not authenticated: redirect to /login
  </action>
  <verify>
    - `pnpm build` passes
    - Logout action exists and is importable
    - Middleware allows /login, /signup, /forgot-password, /reset-password without auth
    - Middleware redirects unauthenticated users from protected routes to /login
  </verify>
  <done>Logout server action created and middleware properly configured for auth flow</done>
</task>

</tasks>

<verification>
After all tasks complete:

1. **Build verification:**
   ```bash
   pnpm build
   ```
   Must complete without errors.

2. **Manual auth flow test (requires Supabase credentials configured):**

   a. Visit /signup - form renders with Spanish labels
   b. Submit invalid data - validation errors appear
   c. Submit valid data - account created (check Supabase dashboard)
   d. Visit /login - form renders
   e. Login with created credentials - redirects to /crm (or shows error if email unverified)
   f. Session persists on page refresh (check via browser dev tools or middleware logs)
   g. Visit /forgot-password - form renders
   h. Request reset - check Supabase for email sent

3. **Route structure check:**
   ```
   src/app/
   ├── (auth)/
   │   ├── layout.tsx
   │   ├── login/page.tsx
   │   ├── signup/page.tsx
   │   ├── forgot-password/page.tsx
   │   └── reset-password/page.tsx
   ├── auth/
   │   ├── callback/route.ts
   │   └── confirm/route.ts
   └── actions/
       └── auth.ts
   ```
</verification>

<success_criteria>
- User can register with email/password via /signup form
- User can login via /login form and session persists across refresh
- User can logout via server action (to be wired to UI in plan 03)
- User can request password reset via /forgot-password
- User can set new password via /reset-password after email link
- Auth callback handlers properly exchange codes for sessions
- All forms use Spanish labels and show validation errors
- Middleware properly protects routes and allows auth pages
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-auth/01-02-SUMMARY.md`
</output>
