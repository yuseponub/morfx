---
phase: 20-integration-automations
plan: 02
type: execute
wave: 2
depends_on: ["20-01"]
files_modified:
  - src/lib/automations/trigger-emitter.ts
  - src/lib/automations/variable-resolver.ts
  - src/inngest/events.ts
  - src/inngest/functions/automation-runner.ts
autonomous: true

must_haves:
  truths:
    - "3 Shopify emitter functions exist and can fire Inngest events"
    - "Variable resolver builds shopify.* namespace from event data"
    - "3 Shopify automation event types registered in Inngest"
    - "3 Shopify runners created via factory pattern and exported"
    - "Shopify triggers match without config filters (configFields empty)"
  artifacts:
    - path: "src/lib/automations/trigger-emitter.ts"
      provides: "3 new Shopify emitter functions"
      exports: ["emitShopifyOrderCreated", "emitShopifyDraftOrderCreated", "emitShopifyOrderUpdated"]
    - path: "src/lib/automations/variable-resolver.ts"
      provides: "shopify.* namespace in buildTriggerContext"
      contains: "shopify"
    - path: "src/inngest/events.ts"
      provides: "3 Shopify automation event types"
      contains: "automation/shopify.order_created"
    - path: "src/inngest/functions/automation-runner.ts"
      provides: "3 Shopify runners + EVENT_TO_TRIGGER entries"
      contains: "shopify.order_created"
  key_links:
    - from: "src/lib/automations/trigger-emitter.ts"
      to: "src/inngest/events.ts"
      via: "fireAndForget sends event names that match AutomationEvents keys"
      pattern: "automation/shopify"
    - from: "src/inngest/functions/automation-runner.ts"
      to: "src/lib/automations/trigger-emitter.ts"
      via: "EVENT_TO_TRIGGER maps event names to TriggerType values consumed by runner"
      pattern: "shopify.order_created"
---

<objective>
Shopify automations engine: trigger emitters, Inngest events, runners, and variable resolver for 3 Shopify trigger types.

Purpose: After this plan, the automations engine can receive, route, and execute automations triggered by Shopify events (order_created, draft_order_created, order_updated). The variable resolver can map Shopify payload data to {{shopify.*}} template variables. The Inngest runners will pick up and process events once they are emitted by the webhook handler (Plan 04).

Output: 3 emitter functions, 3 Inngest event types, 3 Inngest runners, shopify.* variable namespace.
</objective>

<execution_context>
@/home/jose147/.claude/get-shit-done/workflows/execute-plan.md
@/home/jose147/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/20-integration-automations/20-CONTEXT.md
@.planning/phases/20-integration-automations/20-RESEARCH.md
@src/lib/automations/trigger-emitter.ts
@src/lib/automations/variable-resolver.ts
@src/inngest/events.ts
@src/inngest/functions/automation-runner.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Shopify trigger emitters and Inngest events</name>
  <files>src/lib/automations/trigger-emitter.ts, src/inngest/events.ts</files>
  <action>
1. In `trigger-emitter.ts`, add 3 new emitter functions at the bottom (before file end), following the exact same pattern as existing emitters:

   `emitShopifyOrderCreated(data)` with params:
   - workspaceId: string, shopifyOrderId: number, shopifyOrderNumber: string, total: string, financialStatus: string, email: string | null, phone: string | null, note: string | null
   - products: Array<{ sku: string; title: string; quantity: number; price: string }>
   - shippingAddress: string | null, shippingCity: string | null, tags: string | null
   - contactId?: string, contactName?: string, contactPhone?: string, orderId?: string
   - cascadeDepth?: number
   - Uses `isCascadeSuppressed('shopify.order_created', ...)` then `fireAndForget('automation/shopify.order_created', ...)`

   `emitShopifyDraftOrderCreated(data)` with params:
   - workspaceId: string, shopifyDraftOrderId: number, shopifyOrderNumber: string, total: string, status: string, email: string | null, phone: string | null, note: string | null
   - products: Array<{ sku: string; title: string; quantity: number; price: string }>
   - shippingAddress: string | null
   - contactName?: string, contactPhone?: string
   - cascadeDepth?: number
   - Uses `isCascadeSuppressed('shopify.draft_order_created', ...)` then `fireAndForget('automation/shopify.draft_order_created', ...)`

   `emitShopifyOrderUpdated(data)` with params:
   - workspaceId: string, shopifyOrderId: number, shopifyOrderNumber: string, total: string, financialStatus: string, fulfillmentStatus: string | null, email: string | null, phone: string | null, note: string | null
   - products: Array<{ sku: string; title: string; quantity: number; price: string }>
   - shippingAddress: string | null, shippingCity: string | null, tags: string | null
   - contactId?: string, contactName?: string, contactPhone?: string, orderId?: string
   - cascadeDepth?: number
   - Uses `isCascadeSuppressed('shopify.order_updated', ...)` then `fireAndForget('automation/shopify.order_updated', ...)`

   Update the comment at the top: "Emitter Functions (13 total â€” one per trigger type)"

2. In `events.ts`, add 3 new event types to `AutomationEvents`:

   ```typescript
   'automation/shopify.order_created': {
     data: {
       workspaceId: string
       shopifyOrderId: number
       shopifyOrderNumber: string
       total: string
       financialStatus: string
       email: string | null
       phone: string | null
       note: string | null
       products: Array<{ sku: string; title: string; quantity: number; price: string }>
       shippingAddress: string | null
       shippingCity: string | null
       tags: string | null
       contactId?: string
       contactName?: string
       contactPhone?: string
       orderId?: string
       cascadeDepth: number
     }
   }
   'automation/shopify.draft_order_created': {
     data: {
       workspaceId: string
       shopifyDraftOrderId: number
       shopifyOrderNumber: string
       total: string
       status: string
       email: string | null
       phone: string | null
       note: string | null
       products: Array<{ sku: string; title: string; quantity: number; price: string }>
       shippingAddress: string | null
       contactName?: string
       contactPhone?: string
       cascadeDepth: number
     }
   }
   'automation/shopify.order_updated': {
     data: {
       workspaceId: string
       shopifyOrderId: number
       shopifyOrderNumber: string
       total: string
       financialStatus: string
       fulfillmentStatus: string | null
       email: string | null
       phone: string | null
       note: string | null
       products: Array<{ sku: string; title: string; quantity: number; price: string }>
       shippingAddress: string | null
       shippingCity: string | null
       tags: string | null
       contactId?: string
       contactName?: string
       contactPhone?: string
       orderId?: string
       cascadeDepth: number
     }
   }
   ```
  </action>
  <verify>`grep -c 'emitShopify' src/lib/automations/trigger-emitter.ts` returns 3 (3 function definitions). `grep -c 'automation/shopify' src/inngest/events.ts` returns 3 (3 event types).</verify>
  <done>3 Shopify emitters exist in trigger-emitter.ts. 3 Shopify event types exist in events.ts with full data shapes.</done>
</task>

<task type="auto">
  <name>Task 2: Extend variable resolver and automation runners for Shopify</name>
  <files>src/lib/automations/variable-resolver.ts, src/inngest/functions/automation-runner.ts</files>
  <action>
1. In `variable-resolver.ts`, find the `buildTriggerContext` function. Add a `shopify` namespace section after all existing namespace blocks (before the function return). Pattern:

   ```typescript
   // --- shopify ---
   const shopify: Record<string, unknown> = {}
   if (eventData.shopifyOrderNumber !== undefined) shopify.order_number = eventData.shopifyOrderNumber
   if (eventData.total !== undefined) shopify.total = eventData.total
   if (eventData.financialStatus !== undefined) shopify.financial_status = eventData.financialStatus
   if (eventData.fulfillmentStatus !== undefined) shopify.fulfillment_status = eventData.fulfillmentStatus
   if (eventData.email !== undefined) shopify.email = eventData.email
   if (eventData.phone !== undefined) shopify.phone = eventData.phone
   if (eventData.note !== undefined) shopify.note = eventData.note
   if (eventData.products !== undefined) shopify.productos = JSON.stringify(eventData.products)
   if (eventData.shippingAddress !== undefined) shopify.direccion_envio = eventData.shippingAddress
   if (eventData.shippingCity !== undefined) shopify.ciudad_envio = eventData.shippingCity
   if (eventData.tags !== undefined) shopify.tags = eventData.tags
   if (eventData.status !== undefined) shopify.status = eventData.status
   if (Object.keys(shopify).length > 0) context.shopify = shopify
   ```

   IMPORTANT: eventData keys use camelCase (from emitter), shopify namespace keys use snake_case (matching VARIABLE_CATALOG paths).

2. In `automation-runner.ts`:

   a) Add 3 entries to `EVENT_TO_TRIGGER` mapping:
   ```typescript
   'automation/shopify.order_created': 'shopify.order_created',
   'automation/shopify.draft_order_created': 'shopify.draft_order_created',
   'automation/shopify.order_updated': 'shopify.order_updated',
   ```

   b) In `matchesTriggerConfig` function, add 3 new cases to the switch:
   ```typescript
   // Shopify triggers have no config filters (configFields empty)
   case 'shopify.order_created':
   case 'shopify.draft_order_created':
   case 'shopify.order_updated':
     return true
   ```

   c) Create 3 new runners using the factory:
   ```typescript
   const shopifyOrderCreatedRunner = createAutomationRunner(
     'shopify.order_created',
     'automation/shopify.order_created'
   )
   const shopifyDraftOrderCreatedRunner = createAutomationRunner(
     'shopify.draft_order_created',
     'automation/shopify.draft_order_created'
   )
   const shopifyOrderUpdatedRunner = createAutomationRunner(
     'shopify.order_updated',
     'automation/shopify.order_updated'
   )
   ```

   d) Add them to the `automationFunctions` export array.

   e) Update the section comment: "Create All 13 Runners"
  </action>
  <verify>`grep 'shopify' src/lib/automations/variable-resolver.ts | head -5` shows shopify namespace. `grep -c 'shopify' src/inngest/functions/automation-runner.ts` shows at least 6 occurrences (3 EVENT_TO_TRIGGER + 3 runners).</verify>
  <done>Variable resolver maps shopify.* namespace from event data. Automation runner has 13 EVENT_TO_TRIGGER entries, 13 runners in automationFunctions array, and 3 new Shopify cases in matchesTriggerConfig.</done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit 2>&1 | grep -c "error TS"` -- should show only exhaustive switch error in action-executor.ts for send_sms (not yet handled, fixed in Plan 03)
- `grep -c 'emitShopify' src/lib/automations/trigger-emitter.ts` returns 3
- `grep 'automation/shopify' src/inngest/events.ts | wc -l` returns 3
- `grep 'shopify' src/inngest/functions/automation-runner.ts | wc -l` shows runner entries
- `grep 'shopify' src/lib/automations/variable-resolver.ts | wc -l` shows namespace mapping
</verification>

<success_criteria>
- 3 Shopify emitter functions callable from webhook handler
- 3 Shopify event types registered in AutomationEvents
- 3 Shopify runners created and exported in automationFunctions
- Variable resolver maps 12 Shopify-specific fields to shopify.* namespace
- All 3 Shopify triggers pass through matchesTriggerConfig with no filters
</success_criteria>

<output>
After completion, create `.planning/phases/20-integration-automations/20-02-SUMMARY.md`
</output>
