---
phase: 15.8-codebase-cleanup
plan: 03
type: execute
wave: 2
depends_on: ["15.8-01", "15.8-02"]
files_modified:
  - src/app/(dashboard)/sandbox/components/sandbox-layout.tsx
  - src/lib/agents/somnio/somnio-engine.ts
  - src/lib/sandbox/ingest-timer.ts
  - src/lib/agents/somnio/constants.ts
  - src/lib/agents/somnio/data-extractor.ts
  - src/lib/agents/somnio/transition-validator.ts
  - src/lib/utils/phone.ts
  - src/lib/agents/somnio/normalizers.ts
  - src/lib/whatsapp/webhook-handler.ts
  - src/lib/supabase/server.ts
  - src/lib/agents/session-manager.ts
  - src/lib/agents/types.ts
  - src/lib/agents/intent-detector.ts
  - src/lib/agents/orchestrator.ts
  - src/lib/agents/somnio/config.ts
  - src/lib/agents/somnio/message-classifier.ts
autonomous: true

must_haves:
  truths:
    - "Medium bugs #14, #15, #16 fixed: timer cleanup, hasPartialData logic, adjusted duration context"
    - "Phone normalization consolidated: single source in src/lib/utils/phone.ts with normalizePhoneRaw export"
    - "CRITICAL_FIELDS defined once in src/lib/agents/somnio/constants.ts, imported everywhere"
    - "Supabase admin client has single implementation, server.ts re-exports from admin.ts"
    - "State factory helper eliminates duplicate state initialization in session-manager.ts"
    - "Model ID constants replace scattered string literals"
    - "TypeScript compiles with zero source errors"
  artifacts:
    - path: "src/lib/agents/somnio/constants.ts"
      provides: "Single source of truth for CRITICAL_FIELDS, TIMER_MINIMUM_FIELDS, field count thresholds"
      exports: ["CRITICAL_FIELDS", "TIMER_MINIMUM_FIELDS", "MIN_FIELDS_FOR_AUTO_PROMO"]
    - path: "src/lib/utils/phone.ts"
      provides: "Canonical phone normalization with multiple export formats"
      contains: "normalizePhoneRaw"
    - path: "src/lib/agents/types.ts"
      provides: "CLAUDE_MODELS constant object"
      contains: "CLAUDE_MODELS"
    - path: "src/lib/supabase/server.ts"
      provides: "Re-export of createAdminClient from admin.ts"
      contains: "export.*createAdminClient.*from.*admin"
  key_links:
    - from: "src/lib/agents/somnio/data-extractor.ts"
      to: "src/lib/agents/somnio/constants.ts"
      via: "import CRITICAL_FIELDS"
      pattern: "import.*CRITICAL_FIELDS.*from.*constants"
    - from: "src/lib/agents/somnio/normalizers.ts"
      to: "src/lib/utils/phone.ts"
      via: "import normalizePhoneRaw instead of local implementation"
      pattern: "import.*normalizePhoneRaw.*from.*phone"
---

<objective>
Fix 3 medium severity bugs and consolidate all duplicate code: phone normalization, CRITICAL_FIELDS constants, Supabase admin client, state factory pattern, and model ID constants.

Purpose: Reduce code duplication to prevent divergence bugs, improve maintainability, and create a clean foundation for Phase 16.
Output: 16 files modified with consolidation changes, all verified by `tsc --noEmit`.
</objective>

<execution_context>
@/home/jose147/.claude/get-shit-done/workflows/execute-plan.md
@/home/jose147/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/codebase/audit/BUGS.md
@.planning/codebase/audit/DUPLICATES.md
@.planning/phases/15.8-codebase-cleanup/15.8-RESEARCH.md
@.planning/phases/15.8-codebase-cleanup/15.8-01-SUMMARY.md
@.planning/phases/15.8-codebase-cleanup/15.8-02-SUMMARY.md

Key source files:
@src/lib/agents/somnio/data-extractor.ts
@src/lib/agents/somnio/transition-validator.ts
@src/lib/sandbox/ingest-timer.ts
@src/lib/utils/phone.ts
@src/lib/agents/somnio/normalizers.ts
@src/lib/whatsapp/webhook-handler.ts
@src/lib/supabase/admin.ts
@src/lib/supabase/server.ts
@src/lib/agents/session-manager.ts
@src/lib/agents/types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix medium bugs #14, #15, #16 + Create constants.ts + Consolidate CRITICAL_FIELDS</name>
  <files>
    src/app/(dashboard)/sandbox/components/sandbox-layout.tsx
    src/lib/agents/somnio/somnio-engine.ts
    src/lib/sandbox/ingest-timer.ts
    src/lib/agents/somnio/constants.ts
    src/lib/agents/somnio/data-extractor.ts
    src/lib/agents/somnio/transition-validator.ts
  </files>
  <action>
Fix 3 medium bugs and consolidate CRITICAL_FIELDS into a new constants file.

**Bug #14 (timer leak in sandbox-layout.tsx, ~line 307):**
Find the `useEffect` cleanup function that calls `destroy()` on the simulator (~line 307).
In `ingest-timer.ts`, find the `destroy()` method and add:
```typescript
this.contextProvider = null
```
This ensures the context provider reference is cleared on cleanup, preventing stale callbacks if the simulator instance is somehow retained.

**Bug #15 (wrong hasPartialData in somnio-engine.ts, ~line 712):**
Find `emitIngestStarted` call (or similar) around line 712 in somnio-engine.ts.
The `hasPartialData` boolean is passed incorrectly. It should be based on actual extracted fields count, not a flag.
Fix: Change to something like:
```typescript
hasPartialData: Object.keys(extractedData || {}).length > 0
```
Read the surrounding context to understand what data is available at this point and use the actual field count.

**Bug #16 (adjusted duration context in ingest-timer.ts, ~line 326-328):**
Find `reevaluateLevel` where `adjustedDuration = newDurationMs - elapsed` can go negative.
The code correctly fires immediately when `<= 0`, but doesn't include context about why it fired early.
Add an `earlyExpiration` flag or `reason` to the action:
```typescript
if (adjustedDuration <= 0) {
  const action = this.buildActionForLevel(newLevel)
  if (action) {
    action.reason = 'duration_exceeded'  // or add to metadata
    this.onExpire(action)
  }
  return
}
```
Check the `TimerAction` type to see if it supports a `reason` field. If not, either add it to the type or add a comment documenting the early expiration scenario.

**Constants consolidation (CRITICAL_FIELDS + TIMER_MINIMUM_FIELDS):**

1. Create new file `src/lib/agents/somnio/constants.ts`:
   ```typescript
   /**
    * Critical fields required for minimum viable customer data.
    * Used by DataExtractor validation and TransitionValidator.
    */
   export const CRITICAL_FIELDS = [
     'nombre',
     'telefono',
     'direccion',
     'ciudad',
     'departamento',
   ] as const

   /**
    * Minimum fields required for timer to consider data collection sufficient.
    * Includes 'apellido' in addition to CRITICAL_FIELDS.
    * Used by IngestTimerSimulator level evaluation.
    */
   export const TIMER_MINIMUM_FIELDS = [
     'nombre',
     'apellido',
     'telefono',
     'direccion',
     'ciudad',
     'departamento',
   ] as const

   /** Number of total fields needed to auto-trigger ofrecer_promos */
   export const MIN_FIELDS_FOR_AUTO_PROMO = 8

   /** Number of critical fields for timer promo threshold */
   export const CRITICAL_FIELDS_COUNT = CRITICAL_FIELDS.length  // 5
   ```

   **IMPORTANT:** This file must have ZERO imports from other project files to avoid circular dependencies.

2. Update `src/lib/agents/somnio/data-extractor.ts`:
   - Remove the local `CRITICAL_FIELDS` definition (~lines 61-67)
   - Add import: `import { CRITICAL_FIELDS } from './constants'`

3. Update `src/lib/agents/somnio/transition-validator.ts`:
   - Remove the local `CRITICAL_FIELDS` definition (~lines 61-67)
   - Add import: `import { CRITICAL_FIELDS } from './constants'`

4. Update `src/lib/sandbox/ingest-timer.ts`:
   - Remove the local `TIMER_MINIMUM_FIELDS` definition (~lines 44-51)
   - Add import: `import { TIMER_MINIMUM_FIELDS } from '@/lib/agents/somnio/constants'`
   - If there are numeric thresholds (like `5` for critical fields count), replace with imported constant

After ALL changes, run `npx tsc --noEmit` to verify clean compilation.
Commit: `fix(15.8-03): medium bugs #14, #15, #16 + consolidate constants`
  </action>
  <verify>
1. `npx tsc --noEmit` passes with zero source errors
2. New file exists: `ls src/lib/agents/somnio/constants.ts`
3. No duplicate CRITICAL_FIELDS: `grep -rn "export const CRITICAL_FIELDS" src/` shows only constants.ts
4. No duplicate TIMER_MINIMUM_FIELDS: `grep -rn "export const TIMER_MINIMUM_FIELDS" src/` shows only constants.ts
5. Bug #14: `grep -n "contextProvider.*null" src/lib/sandbox/ingest-timer.ts` in destroy()
  </verify>
  <done>
- Bug #14: contextProvider cleared to null in destroy()
- Bug #15: hasPartialData uses actual field count
- Bug #16: Early expiration documented/flagged in reevaluateLevel
- constants.ts created with CRITICAL_FIELDS, TIMER_MINIMUM_FIELDS, MIN_FIELDS_FOR_AUTO_PROMO
- data-extractor.ts imports from constants.ts
- transition-validator.ts imports from constants.ts
- ingest-timer.ts imports TIMER_MINIMUM_FIELDS from constants.ts
- TypeScript compiles clean
  </done>
</task>

<task type="auto">
  <name>Task 2: Consolidate phone normalization + admin client + state factory + model constants</name>
  <files>
    src/lib/utils/phone.ts
    src/lib/agents/somnio/normalizers.ts
    src/lib/whatsapp/webhook-handler.ts
    src/lib/supabase/server.ts
    src/lib/agents/session-manager.ts
    src/lib/agents/types.ts
    src/lib/agents/intent-detector.ts
    src/lib/agents/orchestrator.ts
    src/lib/agents/somnio/data-extractor.ts
    src/lib/agents/somnio/config.ts
    src/lib/agents/somnio/message-classifier.ts
  </files>
  <action>
Consolidate 4 categories of duplicate code.

**Phone Normalization Consolidation:**

1. Read `src/lib/utils/phone.ts` (canonical implementation - returns E.164 with `+`).
2. Read `src/lib/agents/somnio/normalizers.ts` lines 260-292 (returns WITHOUT `+`).
3. Read `src/lib/whatsapp/webhook-handler.ts` lines 470-480 (basic normalization).

4. Add `normalizePhoneRaw` to `src/lib/utils/phone.ts`:
   ```typescript
   /**
    * Normalize phone to E.164 format WITHOUT + prefix.
    * Used by Somnio agent for backward compatibility with datos_capturados format.
    * Example: "300 123 4567" -> "573001234567"
    */
   export function normalizePhoneRaw(input: string): string | null {
     const normalized = normalizePhone(input)
     return normalized ? normalized.replace('+', '') : null
   }
   ```

5. Update `src/lib/agents/somnio/normalizers.ts`:
   - Remove the local `normalizePhone` function (~lines 260-292)
   - Import from phone.ts: `import { normalizePhoneRaw } from '@/lib/utils/phone'`
   - If `normalizePhone` was exported from normalizers.ts and used elsewhere, update the export to re-export `normalizePhoneRaw` as `normalizePhone` for backward compatibility:
     ```typescript
     export { normalizePhoneRaw as normalizePhone } from '@/lib/utils/phone'
     ```
   - Check all files that import `normalizePhone` from `normalizers.ts` and verify they still work

6. Update `src/lib/whatsapp/webhook-handler.ts`:
   - Remove the private `normalizePhone` function (~lines 470-480)
   - Import from phone.ts: `import { normalizePhone } from '@/lib/utils/phone'`
   - Verify the caller at ~line 95 still works (the canonical function returns `string | null`, the old one returned `string` - handle null case)

**Supabase Admin Client Consolidation:**

1. Read `src/lib/supabase/server.ts` lines 36-47 (duplicate `createAdminClient`).
2. Remove the duplicate function definition.
3. Add re-export: `export { createAdminClient } from './admin'`
4. Verify: check which files import `createAdminClient` from `server.ts` vs `admin.ts`:
   ```bash
   grep -rn "from.*supabase/server.*createAdminClient\|createAdminClient.*from.*supabase/server" src/
   ```
   These files should continue working since the re-export maintains the same import path.

**State Factory Pattern (session-manager.ts):**

1. Read `src/lib/agents/session-manager.ts` and find the two places where default state is constructed (~lines 119-129 and ~lines 299-312).
2. Create a private helper function:
   ```typescript
   function createDefaultSessionState(sessionId: string): SessionState {
     return {
       session_id: sessionId,
       intents_vistos: [],
       templates_enviados: [],
       datos_capturados: {},
       pack_seleccionado: null,
       proactive_started_at: null,
       first_data_at: null,
       min_data_at: null,
       ofrecer_promos_at: null,
       updated_at: new Date().toISOString(),
     }
   }
   ```
3. Replace both state construction sites to use this helper.
4. For the `createSession` site, the helper result can be spread with `params.initialState` overrides.

**Model ID Constants:**

1. Add to `src/lib/agents/types.ts`:
   ```typescript
   /** Canonical model identifiers for Claude API */
   export const CLAUDE_MODELS = {
     HAIKU: 'claude-haiku-4-5' as const,
     SONNET: 'claude-sonnet-4-5' as const,
   } as const

   export type ClaudeModelId = typeof CLAUDE_MODELS[keyof typeof CLAUDE_MODELS]
   ```

2. Update string literals in these files:
   - `src/lib/agents/intent-detector.ts` (~line 120): Replace `'claude-haiku-4-5'` with `CLAUDE_MODELS.HAIKU`
   - `src/lib/agents/orchestrator.ts` (~line 145): Replace `'claude-sonnet-4-5'` with `CLAUDE_MODELS.SONNET`
   - `src/lib/agents/somnio/data-extractor.ts` (~line 217): Should already use config from Bug #10 fix in Plan 02. If there are remaining literals, replace.
   - `src/lib/agents/somnio/config.ts` (~lines 102, 109): Replace model strings with constants
   - `src/lib/agents/somnio/message-classifier.ts` (~lines 151, 159): This file uses `'claude-sonnet-4-20250514'` (the direct API model ID). This is the RESOLVED model ID, not the alias. Leave this as-is since it's the direct API call - the MODEL_MAP in claude-client.ts handles the alias resolution. OR if it should use the alias, replace with `CLAUDE_MODELS.SONNET` (the client will resolve it).

   Read each file carefully before replacing to make sure the replacement is correct for the context.

After ALL consolidation changes, run `npx tsc --noEmit` to verify clean compilation.
Commit: `refactor(15.8-03): consolidate phone, admin client, state factory, model constants`
  </action>
  <verify>
1. `npx tsc --noEmit` passes with zero source errors
2. Phone: `grep -rn "export function normalizePhoneRaw" src/` shows only phone.ts
3. Phone: `grep -rn "function normalizePhone" src/lib/agents/somnio/normalizers.ts` returns nothing (removed)
4. Phone: `grep -rn "function normalizePhone" src/lib/whatsapp/webhook-handler.ts` returns nothing (removed)
5. Admin: `grep -rn "createAdminClient" src/lib/supabase/server.ts` shows re-export, not function definition
6. State: `grep -n "createDefaultSessionState" src/lib/agents/session-manager.ts` shows helper function
7. Models: `grep -rn "CLAUDE_MODELS" src/lib/agents/` shows imports in multiple files
  </verify>
  <done>
- Phone normalization: normalizePhoneRaw added to phone.ts, duplicates removed from normalizers.ts and webhook-handler.ts
- Supabase admin client: server.ts re-exports from admin.ts, duplicate removed
- State factory: createDefaultSessionState helper used in both initialization sites
- Model constants: CLAUDE_MODELS in types.ts, imported in 4+ files replacing string literals
- TypeScript compiles clean
  </done>
</task>

</tasks>

<verification>
After both tasks complete:
1. `npx tsc --noEmit` passes with zero source errors (GATE)
2. Zero duplicate definitions of CRITICAL_FIELDS, TIMER_MINIMUM_FIELDS
3. Phone normalization has single source of truth with backward-compatible exports
4. Supabase admin client has single implementation
5. Model IDs use constants, not string literals
6. All 16 files modified correctly
</verification>

<success_criteria>
1. Bugs #14, #15, #16 all fixed
2. constants.ts created with consolidated field definitions
3. Phone normalization consolidated to phone.ts with normalizePhoneRaw
4. Supabase admin client unified via re-export
5. State factory helper eliminates duplication
6. CLAUDE_MODELS constants replace string literals
7. TypeScript compiles with zero source errors
8. Each change group committed atomically
</success_criteria>

<output>
After completion, create `.planning/phases/15.8-codebase-cleanup/15.8-03-SUMMARY.md`
</output>
