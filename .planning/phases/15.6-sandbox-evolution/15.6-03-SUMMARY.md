---
phase: 15.6-sandbox-evolution
plan: 03
subsystem: agents
tags: [crm, agent-system, registry, orchestrator, order-manager, dry-run, mock-data]

# Dependency graph
requires:
  - phase: 15-agent-sandbox
    provides: ToolExecution type for debug visibility, SandboxState types
  - phase: 13-agent-engine-core
    provides: ModelTokenEntry type for per-model token tracking
provides:
  - CRM agent interface (CrmAgent) with execute(command, mode) method
  - CRM agent registry for registration and lookup
  - CRM orchestrator for routing commands to agents
  - Order Manager agent with 3 operating modes
  - Mock data generators for dry-run mode
affects: [15.6-05-PLAN (CRM sandbox integration wires live mode), 16-whatsapp-agent]

# Tech tracking
tech-stack:
  added: []
  patterns:
    - "CRM agent self-registration via module-level import (index.ts)"
    - "Abstract base class pattern for CRM agents (BaseCrmAgent)"
    - "Singleton registry + singleton orchestrator for CRM routing"
    - "Dry-run mock data generation for sandbox testing"

key-files:
  created:
    - src/lib/agents/crm/types.ts
    - src/lib/agents/crm/base-crm-agent.ts
    - src/lib/agents/crm/crm-agent-registry.ts
    - src/lib/agents/crm/crm-orchestrator.ts
    - src/lib/agents/crm/order-manager/tools.ts
    - src/lib/agents/crm/order-manager/agent.ts
    - src/lib/agents/crm/index.ts
  modified: []

key-decisions:
  - "CRM agents are completely separate from conversational agents (Somnio never calls CRM agents directly)"
  - "Self-registration pattern: importing index.ts registers all agents automatically"
  - "Live mode stubs return dry-run data with _note marker; real wiring deferred to Plan 05"
  - "OrderManagerMode: full (8 fields + pack), no_promo (8 fields, default 1x), draft (nombre + telefono only)"

patterns-established:
  - "BaseCrmAgent: abstract base with buildResult, buildError, buildMockToolExecution, generateMockId, prefixTestData"
  - "crmAgentRegistry.getAgentForCommand: command-type routing for agent discovery"
  - "Mock tool functions return ToolExecution objects matching sandbox debug format"

# Metrics
duration: 12min
completed: 2026-02-07
---

# Phase 15.6 Plan 03: CRM Agent System Summary

**CRM agent infrastructure with types, registry, orchestrator, and Order Manager agent supporting 3 modes (full/no_promo/draft) with dry-run mock data generation**

## Performance

- **Duration:** 12 min
- **Started:** 2026-02-07T21:21:21Z
- **Completed:** 2026-02-07T21:33:55Z
- **Tasks:** 2
- **Files created:** 7

## Accomplishments
- Complete CRM agent type system (CrmAgent, CrmCommand, CrmAgentResult, CrmCommandType)
- BaseCrmAgent abstract class with shared utilities for mock generation, test-data prefixing, result building
- Singleton registry with register/get/getAgentForCommand/listAgents and singleton orchestrator
- Order Manager agent handling create_order in 3 modes with field validation per mode
- Dry-run generates realistic mock tool calls (contact create, tag assign, order create) for sandbox visibility

## Task Commits

Each task was committed atomically:

1. **Task 1: Create CRM agent types, base class, and registry** - `c36c311` (feat)
2. **Task 2: Create CRM Orchestrator and Order Manager agent** - `9fd0cb8` (feat)

## Files Created/Modified
- `src/lib/agents/crm/types.ts` - CRM agent interfaces, command types, result types
- `src/lib/agents/crm/base-crm-agent.ts` - Abstract base class with shared utilities
- `src/lib/agents/crm/crm-agent-registry.ts` - Singleton registry for CRM agent registration and lookup
- `src/lib/agents/crm/crm-orchestrator.ts` - Routes CRM commands to registered agents
- `src/lib/agents/crm/order-manager/tools.ts` - Mock data generators for dry-run mode
- `src/lib/agents/crm/order-manager/agent.ts` - Order Manager agent with 3 operating modes
- `src/lib/agents/crm/index.ts` - Barrel export with self-registration on import

## Decisions Made
- CRM agents are fully separated from conversational agents; Somnio orchestrator routes through CrmOrchestrator, never calling CRM agents directly
- Self-registration pattern mirrors existing somnio/index.ts: importing the barrel file registers all agents
- Live mode currently returns dry-run data with `_note` marker; real Action DSL wiring deferred to Plan 05 Task 4
- Used `CrmCommandType` as discriminant union for extensibility (edit_order, search_contact reserved for future agents)

## Deviations from Plan

None - plan executed exactly as written.

## Issues Encountered
None

## User Setup Required
None - no external service configuration required.

## Next Phase Readiness
- CRM agent system ready for Plan 05 to wire live mode via Action DSL
- Registry and orchestrator can be imported from `@/lib/agents/crm` barrel
- Order Manager ready for sandbox UI integration (Plan 04/05)

---
*Phase: 15.6-sandbox-evolution*
*Completed: 2026-02-07*
