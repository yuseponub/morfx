---
phase: 14-agente-ventas-somnio
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/20260206_agent_templates.sql
  - src/lib/agents/types.ts
  - src/lib/agents/somnio/config.ts
  - src/lib/agents/somnio/intents.ts
  - src/lib/agents/somnio/prompts.ts
  - src/lib/agents/somnio/index.ts
autonomous: true

must_haves:
  truths:
    - "agent_templates table exists in database with intent-to-template mapping"
    - "Somnio agent is registered in AgentRegistry with 20 intents"
    - "Somnio system prompts are defined for Intent Detector and Orchestrator"
  artifacts:
    - path: "supabase/migrations/20260206_agent_templates.sql"
      provides: "Database schema for agent templates"
      contains: "CREATE TABLE agent_templates"
    - path: "src/lib/agents/somnio/config.ts"
      provides: "Somnio AgentConfig with all intents, states, transitions"
      exports: ["somnioAgentConfig"]
    - path: "src/lib/agents/somnio/intents.ts"
      provides: "Intent definitions with descriptions and examples"
      exports: ["SOMNIO_INTENTS", "IntentDefinition"]
    - path: "src/lib/agents/somnio/prompts.ts"
      provides: "System prompts for Intent Detector and Orchestrator"
      exports: ["INTENT_DETECTOR_PROMPT", "ORCHESTRATOR_PROMPT"]
  key_links:
    - from: "src/lib/agents/somnio/config.ts"
      to: "src/lib/agents/registry.ts"
      via: "agentRegistry.register(somnioAgentConfig)"
      pattern: "agentRegistry\\.register"
---

<objective>
Create database schema for agent templates and implement the Somnio sales agent configuration with all 20 intents, state machine, and system prompts.

Purpose: Foundation for Somnio agent - defines what intents it recognizes, how it transitions between states, and what its Claude components should do.

Output: Database migration, Somnio agent config registered in AgentRegistry, intent definitions, system prompts.
</objective>

<execution_context>
@/home/jose147/.claude/get-shit-done/workflows/execute-plan.md
@/home/jose147/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/14-agente-ventas-somnio/14-CONTEXT.md
@src/lib/agents/types.ts
@src/lib/agents/registry.ts
@src/lib/agents/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create agent_templates database schema</name>
  <files>
    supabase/migrations/20260206_agent_templates.sql
    src/lib/agents/types.ts
  </files>
  <action>
Create migration file with agent_templates table:

```sql
-- agent_templates table
CREATE TABLE agent_templates (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  agent_id TEXT NOT NULL,
  intent TEXT NOT NULL,
  visit_type TEXT NOT NULL CHECK (visit_type IN ('primera_vez', 'siguientes')),
  orden INTEGER NOT NULL DEFAULT 0,
  content_type TEXT NOT NULL CHECK (content_type IN ('texto', 'template', 'imagen')),
  content TEXT NOT NULL,
  delay_s INTEGER NOT NULL DEFAULT 0,
  workspace_id UUID REFERENCES workspaces(id) ON DELETE CASCADE,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW(),

  UNIQUE(agent_id, intent, visit_type, orden, workspace_id)
);

-- RLS policies
ALTER TABLE agent_templates ENABLE ROW LEVEL SECURITY;

CREATE POLICY "agent_templates_workspace_isolation" ON agent_templates
  FOR ALL USING (
    workspace_id IS NULL OR
    workspace_id IN (SELECT get_user_workspace_ids())
  );

-- Index for fast lookups
CREATE INDEX idx_agent_templates_lookup ON agent_templates(agent_id, intent, visit_type);

-- Trigger for updated_at
CREATE TRIGGER update_agent_templates_updated_at
  BEFORE UPDATE ON agent_templates
  FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();
```

Add TypeScript types to src/lib/agents/types.ts:
- AgentTemplate interface matching DB schema
- AgentTemplateRow for Supabase queries
- TemplateContentType = 'texto' | 'template' | 'imagen'
- TemplateVisitType = 'primera_vez' | 'siguientes'
  </action>
  <verify>
Migration file exists and is syntactically valid SQL. Types added to types.ts without TypeScript errors.
  </verify>
  <done>
agent_templates table schema defined with RLS, indexes, and TypeScript types exported.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Somnio agent configuration with intents and prompts</name>
  <files>
    src/lib/agents/somnio/intents.ts
    src/lib/agents/somnio/prompts.ts
    src/lib/agents/somnio/config.ts
    src/lib/agents/somnio/index.ts
    src/lib/agents/index.ts
  </files>
  <action>
Create src/lib/agents/somnio/intents.ts with SOMNIO_INTENTS constant:
- Define IntentDefinition type: { name, description, examples, triggers? }
- Include all 20 intents from CONTEXT.md:
  - 13 informativos: hola, precio, info_promociones, contenido_envase, como_se_toma, modopago, metodos_de_pago, modopago2, envio, invima, ubicacion, contraindicaciones, sisirve
  - 6 flujo de compra: captura_datos_si_compra, ofrecer_promos, resumen_1x, resumen_2x, resumen_3x, compra_confirmada, no_confirmado, no_interesa
  - 1 escape: fallback
- Include 11 combinations with hola: hola+precio, hola+como_se_toma, etc.
- Each intent has description and 2-3 example messages

Create src/lib/agents/somnio/prompts.ts:
- INTENT_DETECTOR_PROMPT: System prompt for classifying customer messages into intents
  - Include list of all intents with descriptions
  - Explain hola+X combination detection
  - Output format: JSON { intent, confidence, alternatives?, reasoning? }
- ORCHESTRATOR_PROMPT: System prompt for deciding actions based on intent
  - Include state transitions logic
  - Include tool usage patterns (crm.contact.create, crm.order.create, whatsapp.message.send)
  - Output format: response text + tools to call

Create src/lib/agents/somnio/config.ts:
- Import types from parent agents module
- Define somnioAgentConfig: AgentConfig with:
  - id: 'somnio-sales-v1'
  - name: 'Somnio Sales Agent'
  - intentDetector config with INTENT_DETECTOR_PROMPT, claude-sonnet-4-5 (since Haiku 4.5 not available yet per decision 13-03)
  - orchestrator config with ORCHESTRATOR_PROMPT, claude-sonnet-4-5
  - tools: ['crm.contact.create', 'crm.contact.update', 'crm.order.create', 'whatsapp.message.send']
  - states: ['conversacion', 'collecting_data', 'ofrecer_promos', 'resumen', 'confirmado', 'handoff']
  - initialState: 'conversacion'
  - validTransitions: Define state machine per CONTEXT.md rules
  - confidenceThresholds: DEFAULT_CONFIDENCE_THRESHOLDS

Create src/lib/agents/somnio/index.ts:
- Export somnioAgentConfig, SOMNIO_INTENTS, prompts
- Register agent on module load: agentRegistry.register(somnioAgentConfig)

Update src/lib/agents/index.ts:
- Add export for somnio module: export * from './somnio'
  </action>
  <verify>
```bash
cd /mnt/c/Users/Usuario/Proyectos/morfx-new && npx tsc --noEmit
```
TypeScript compiles. agentRegistry.get('somnio-sales-v1') returns config.
  </verify>
  <done>
Somnio agent registered with 20 intents, state machine, and Claude prompts. Can be retrieved via agentRegistry.get('somnio-sales-v1').
  </done>
</task>

</tasks>

<verification>
1. Migration file exists at supabase/migrations/20260206_agent_templates.sql
2. TypeScript compiles without errors: `npx tsc --noEmit`
3. Somnio agent is registered: `agentRegistry.get('somnio-sales-v1')` returns valid config
4. All 20 intents defined in SOMNIO_INTENTS
5. System prompts include intent list and output format instructions
</verification>

<success_criteria>
- agent_templates table schema ready for migration
- Somnio agent config with 20 intents and state machine
- Intent Detector and Orchestrator prompts defined
- Agent registered in AgentRegistry on module load
- TypeScript compiles cleanly
</success_criteria>

<output>
After completion, create `.planning/phases/14-agente-ventas-somnio/14-01-SUMMARY.md`
</output>
