---
phase: 24-chat-de-comandos-ui
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/20260222000004_carrier_dispatch_stage.sql
  - src/lib/domain/carrier-configs.ts
  - src/lib/domain/robot-jobs.ts
autonomous: true

must_haves:
  truths:
    - "carrier_configs table has dispatch_pipeline_id and dispatch_stage_id columns"
    - "robot_jobs table is included in Supabase Realtime publication"
    - "Domain function getActiveJob returns the currently active job for a workspace (or null)"
    - "Domain function getJobHistory returns a list of past jobs ordered by most recent first"
    - "Domain function getJobItemsWithOrderInfo returns job items with order name + contact name for display"
    - "carrier-configs domain supports reading and writing dispatch stage settings"
  artifacts:
    - path: "supabase/migrations/20260222000004_carrier_dispatch_stage.sql"
      provides: "DB migration for dispatch stage columns + robot_jobs Realtime"
      contains: "dispatch_pipeline_id"
    - path: "src/lib/domain/carrier-configs.ts"
      provides: "Updated carrier config with dispatch stage support"
      contains: "dispatch_pipeline_id"
    - path: "src/lib/domain/robot-jobs.ts"
      provides: "Extended robot jobs domain with getActiveJob, getJobHistory, getJobItemsWithOrderInfo"
      exports: ["getActiveJob", "getJobHistory", "getJobItemsWithOrderInfo"]
  key_links:
    - from: "src/lib/domain/robot-jobs.ts"
      to: "robot_jobs + robot_job_items"
      via: "createAdminClient query"
      pattern: "getActiveJob|getJobHistory|getJobItemsWithOrderInfo"
    - from: "src/lib/domain/carrier-configs.ts"
      to: "carrier_configs"
      via: "createAdminClient query"
      pattern: "dispatch_pipeline_id|dispatch_stage_id"
---

<objective>
Add the database columns and domain functions required by the Chat de Comandos UI.

Purpose: The command `subir ordenes coord` needs to know which pipeline stage to pull orders from (dispatch stage config), the UI needs to display job history and detect active jobs, and Realtime progress requires `robot_jobs` in the publication.

Output: Migration file, updated carrier-configs domain module, extended robot-jobs domain module.
</objective>

<execution_context>
@/home/jose147/.claude/get-shit-done/workflows/execute-plan.md
@/home/jose147/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@supabase/migrations/20260222000002_carrier_configs.sql
@supabase/migrations/20260222000003_robot_jobs.sql
@src/lib/domain/carrier-configs.ts
@src/lib/domain/robot-jobs.ts
@src/lib/domain/types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Migration for dispatch stage columns + robot_jobs Realtime</name>
  <files>supabase/migrations/20260222000004_carrier_dispatch_stage.sql</files>
  <action>
  Create a new migration that:

  1. Adds `dispatch_pipeline_id UUID REFERENCES pipelines(id) ON DELETE SET NULL` to `carrier_configs`.
  2. Adds `dispatch_stage_id UUID REFERENCES pipeline_stages(id) ON DELETE SET NULL` to `carrier_configs`.
  3. Adds `robot_jobs` to the `supabase_realtime` publication (same pattern as the existing robot_job_items publication in 20260222000003).
     Use DO $$ BEGIN ... EXCEPTION WHEN duplicate_object THEN NULL; END; $$ pattern.

  IMPORTANT: Both columns are nullable -- no workspace needs a dispatch stage until they configure it.
  IMPORTANT: Use the naming convention from existing migrations (comments, section numbering).
  </action>
  <verify>
  - File exists at `supabase/migrations/20260222000004_carrier_dispatch_stage.sql`
  - Contains ALTER TABLE carrier_configs ADD COLUMN for both columns
  - Contains ALTER PUBLICATION supabase_realtime ADD TABLE robot_jobs
  - SQL syntax is valid (no missing semicolons, correct DO $$ pattern)
  </verify>
  <done>Migration file creates dispatch_pipeline_id and dispatch_stage_id on carrier_configs, and adds robot_jobs to Realtime publication.</done>
</task>

<task type="auto">
  <name>Task 2: Extend domain modules with dispatch stage support and job queries</name>
  <files>src/lib/domain/carrier-configs.ts, src/lib/domain/robot-jobs.ts</files>
  <action>
  **carrier-configs.ts changes:**

  1. Update `CarrierConfig` interface to add:
     - `dispatch_pipeline_id: string | null`
     - `dispatch_stage_id: string | null`

  2. Update `UpsertCarrierConfigParams` to add:
     - `dispatchPipelineId?: string | null`
     - `dispatchStageId?: string | null`

  3. In `upsertCarrierConfig()`:
     - Add `dispatch_pipeline_id` and `dispatch_stage_id` to the INSERT payload (use params or null).
     - In the UPDATE section, add: `if (params.dispatchPipelineId !== undefined) updates.dispatch_pipeline_id = params.dispatchPipelineId`
     - Same for dispatchStageId.

  4. Add a new `getDispatchStage()` convenience function:
     ```typescript
     export async function getDispatchStage(
       ctx: DomainContext,
       carrier?: string
     ): Promise<DomainResult<{ pipelineId: string; stageId: string } | null>>
     ```
     - Calls getCarrierConfig.
     - Returns null if config doesn't exist OR dispatch_pipeline_id/dispatch_stage_id are null.
     - Returns `{ pipelineId, stageId }` if both are set.

  **robot-jobs.ts changes:**

  Add three new functions AFTER the existing `retryFailedItems`:

  1. `getActiveJob(ctx: DomainContext)`: Returns `DomainResult<GetJobWithItemsResult | null>`.
     - Query `robot_jobs` with `workspace_id` filter + status IN ('pending', 'processing')
     - ORDER BY created_at DESC, LIMIT 1, maybeSingle()
     - If no active job found, return `{ success: true, data: null }`
     - If found, call existing `getJobWithItems()` to get full data with items
     - This function enables the UI to detect and reconnect to a running job

  2. `getJobHistory(ctx: DomainContext, limit?: number)`: Returns `DomainResult<RobotJob[]>`.
     - Default limit = 20
     - Query `robot_jobs` with `workspace_id` filter
     - ORDER BY created_at DESC, LIMIT limit
     - Returns just the job rows (no items -- history panel only shows summaries)

  3. `getJobItemsWithOrderInfo(ctx: DomainContext, jobId: string)`: Returns `DomainResult<JobItemWithOrderInfo[]>`.
     - Define `JobItemWithOrderInfo` extending `RobotJobItem` with `order_name: string | null` and `contact_name: string | null`.
     - Query `robot_job_items` with `job_id` filter.
     - Use Supabase nested select to include order info: `.select('*, orders!inner(name, contact_id, contacts(name))')`.
       If `orders!inner` doesn't work with the FK, use a 2-query approach:
       - First query items by job_id
       - Then query orders by the unique order_ids from items, with `.select('id, name, contacts(name)')`
       - Map order info onto items
     - Verify job belongs to workspace by checking parent robot_jobs.workspace_id
     - This function powers the "detalle" view when clicking a job in history

  Export all new types and functions properly.
  </action>
  <verify>
  - `npx tsc --noEmit` passes (no TypeScript errors)
  - `CarrierConfig` interface has dispatch_pipeline_id and dispatch_stage_id
  - `getActiveJob`, `getJobHistory`, `getJobItemsWithOrderInfo` are exported from robot-jobs.ts
  - `getDispatchStage` is exported from carrier-configs.ts
  </verify>
  <done>Domain modules extended: carrier-configs supports dispatch stage read/write, robot-jobs has getActiveJob/getJobHistory/getJobItemsWithOrderInfo queries for the UI.</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with no errors
2. Migration file has valid SQL syntax
3. New domain functions follow existing patterns (createAdminClient, workspace_id filter, DomainResult return)
4. No circular dependency introduced (carrier-configs and robot-jobs don't import each other)
</verification>

<success_criteria>
- carrier_configs has dispatch_pipeline_id/dispatch_stage_id columns (migration)
- robot_jobs is in Supabase Realtime publication (migration)
- Three new domain query functions exist for active job detection, job history, and item detail
- Dispatch stage configuration is readable/writable through carrier-configs domain
- All TypeScript compiles cleanly
</success_criteria>

<output>
After completion, create `.planning/phases/24-chat-de-comandos-ui/24-01-SUMMARY.md`
</output>
