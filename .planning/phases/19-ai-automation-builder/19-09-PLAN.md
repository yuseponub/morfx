---
phase: 19-ai-automation-builder
plan: 09
type: execute
wave: 5
depends_on: ["19-07", "19-08"]
files_modified:
  - src/app/(dashboard)/automatizaciones/builder/components/builder-layout.tsx
  - src/components/layout/sidebar.tsx
  - src/app/(dashboard)/automatizaciones/components/automation-list.tsx
autonomous: true

must_haves:
  truths:
    - "Sidebar has a link to the AI Builder page"
    - "Automation list page has a button to open AI Builder"
    - "Agent can load and modify existing automations"
    - "Agent can clone an existing automation as a base for a new one"
  artifacts:
    - path: "src/components/layout/sidebar.tsx"
      provides: "Navigation item or sub-link to /automatizaciones/builder"
  key_links:
    - from: "src/components/layout/sidebar.tsx"
      to: "/automatizaciones/builder"
      via: "navigation link"
      pattern: "automatizaciones/builder"
    - from: "src/app/(dashboard)/automatizaciones/components/automation-list.tsx"
      to: "/automatizaciones/builder"
      via: "CTA button"
      pattern: "automatizaciones/builder"
---

<objective>
Add navigation to the AI Builder from the sidebar and automation list page. Ensure the agent can handle modification and cloning of existing automations end-to-end.

Purpose: Make the builder discoverable and complete the modification workflow.
Output: Navigation links, modification/clone flow verified.
</objective>

<execution_context>
@/home/jose147/.claude/get-shit-done/workflows/execute-plan.md
@/home/jose147/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/19-ai-automation-builder/19-07-PLAN.md
@.planning/phases/19-ai-automation-builder/19-08-PLAN.md
@src/components/layout/sidebar.tsx
@src/app/(dashboard)/automatizaciones/components/automation-list.tsx
@src/lib/builder/tools.ts
@src/lib/builder/system-prompt.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add navigation to AI Builder</name>
  <files>
    src/components/layout/sidebar.tsx
    src/app/(dashboard)/automatizaciones/components/automation-list.tsx
  </files>
  <action>
    1. **Sidebar navigation** (`sidebar.tsx`):

    The sidebar currently has `/automatizaciones` as a nav item. There are two approaches:
    - **Option A**: Add a sub-item under Automatizaciones for "AI Builder"
    - **Option B**: Add a separate nav item

    Go with **Option A** — add a small icon/badge on the Automatizaciones nav item that links to the builder, OR simply add the builder as accessible from the automation list page (more discoverable).

    Actually, the simplest approach that doesn't change sidebar structure: Add a `Sparkles` (or `Wand2`) icon button next to the Automatizaciones label that links to `/automatizaciones/builder`. This keeps the sidebar clean while providing quick access.

    OR even simpler: the main entry point is from the automation list page. The sidebar just goes to `/automatizaciones` which has a prominent "AI Builder" button. No sidebar changes needed.

    **Decision**: Do NOT modify the sidebar nav items. Instead, add a prominent CTA on the automation list page.

    2. **Automation list page** (`automation-list.tsx`):

    Add an "AI Builder" button in the header area, next to the existing "Nueva automatizacion" link:
    ```tsx
    import { Sparkles } from 'lucide-react'

    // In the header section, add:
    <Link href="/automatizaciones/builder">
      <Button variant="outline" className="gap-2">
        <Sparkles className="h-4 w-4" />
        AI Builder
      </Button>
    </Link>
    ```

    Place it next to the existing "+ Nueva automatizacion" button. The AI Builder is an alternative way to create automations (via natural language instead of the manual wizard).

    Also add a small informational banner or card at the top of the page (only if no automations exist, or always):
    ```tsx
    <div className="rounded-lg border bg-muted/50 p-4 flex items-start gap-3">
      <Sparkles className="h-5 w-5 text-violet-500 mt-0.5" />
      <div>
        <p className="text-sm font-medium">Nuevo: AI Builder</p>
        <p className="text-sm text-muted-foreground">
          Describe lo que quieres automatizar en lenguaje natural y el asistente lo creara por ti.
        </p>
        <Link href="/automatizaciones/builder" className="text-sm text-primary hover:underline mt-1 inline-block">
          Probar AI Builder →
        </Link>
      </div>
    </div>
    ```

    This banner should only show if the user hasn't dismissed it (use localStorage `morfx_builder_banner_dismissed`). Add a small X button to dismiss.
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - Automation list page has "AI Builder" button linking to /automatizaciones/builder
    - Banner appears with description and link
  </verify>
  <done>
    - AI Builder accessible from automation list page via button and banner
    - Clear visual distinction between manual wizard and AI Builder
    - Banner dismissable via localStorage
  </done>
</task>

<task type="auto">
  <name>Task 2: Verify and polish modification/clone flow</name>
  <files>
    src/lib/builder/tools.ts
    src/lib/builder/system-prompt.ts
  </files>
  <action>
    Ensure the modification and clone workflows are complete:

    1. **Modification flow verification**:
    The system prompt already instructs the agent to handle modifications. Verify the tools support it:
    - `getAutomation` tool can fetch by ID or name — used when user says "modify the automation called X"
    - `listAutomations` tool lists all — used when user says "show me my automations"
    - `generatePreview` tool shows the modified version
    - `updateAutomation` tool saves changes

    Review the system prompt in `system-prompt.ts` and ensure it covers:
    - When user wants to modify: first load with getAutomation, then show current state, ask what to change, regenerate preview, confirm, update
    - Every modification requires full diagram approval before saving
    - Agent only changes what the user asks — doesn't optimize or restructure unprompted

    2. **Clone flow**:
    Add instructions to the system prompt for cloning:
    - When user says "clone" or "copiar" an automation, the agent:
      a. Loads the existing automation with getAutomation
      b. Shows the current diagram
      c. Asks what changes the user wants
      d. Generates a new preview with changes applied (new name)
      e. Creates as a NEW automation (not update)
    - The cloned automation gets a different name (agent should ask or auto-suggest "X (copia)")

    3. **Explain existing automation**:
    The system prompt should handle "explicame la automatizacion X":
    - Load with getAutomation
    - Show the diagram
    - Provide a natural language description: "Esta automatizacion se activa cuando [trigger], verifica que [conditions], y entonces [actions]"

    Update the system prompt to include these three scenarios explicitly if not already covered.

    4. **Add `existingAutomationId` to AutomationPreviewData**:
    In `src/lib/builder/types.ts`, add `existingAutomationId?: string` to `AutomationPreviewData`. This helps the UI know whether to show "Crear" or "Guardar cambios" on the confirmation buttons.

    Update `generatePreview` tool to accept an optional `existingAutomationId` parameter and pass it through to the return value.
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - System prompt covers: modify, clone, and explain workflows
    - generatePreview accepts optional existingAutomationId
    - AutomationPreviewData has existingAutomationId field
  </verify>
  <done>
    - Modification flow: load -> preview changes -> confirm -> update
    - Clone flow: load -> preview with changes -> confirm -> create new
    - Explain flow: load -> diagram + natural language description
    - System prompt explicitly covers all three scenarios
    - Preview data includes existingAutomationId for UI branching
  </done>
</task>

</tasks>

<verification>
- TypeScript compiles: `npx tsc --noEmit`
- Automation list page links to builder
- System prompt covers modify, clone, explain workflows
</verification>

<success_criteria>
Builder is discoverable from the automation list page. Modification, cloning, and explanation workflows are fully supported by the system prompt and tools. Preview data distinguishes new vs. update operations.
</success_criteria>

<output>
After completion, create `.planning/phases/19-ai-automation-builder/19-09-SUMMARY.md`
</output>
