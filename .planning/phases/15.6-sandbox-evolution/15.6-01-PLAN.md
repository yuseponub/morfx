---
phase: 15.6-sandbox-evolution
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/sandbox/types.ts
  - src/lib/agents/claude-client.ts
  - src/lib/agents/types.ts
  - src/lib/agents/intent-detector.ts
  - src/lib/sandbox/sandbox-engine.ts
  - src/app/api/sandbox/process/route.ts
autonomous: true

must_haves:
  truths:
    - "ClaudeClient.detectIntent returns model identity and input/output token split"
    - "ClaudeClient.orchestrate returns model identity and input/output token split"
    - "SandboxEngine propagates per-model token detail through DebugTurn"
    - "TokenInfo contains per-model breakdown array"
    - "CRM agent types are defined for future use"
  artifacts:
    - path: "src/lib/sandbox/types.ts"
      provides: "Extended types for per-model tokens, CRM agents, ingest timeline"
      contains: "ModelTokenEntry"
    - path: "src/lib/agents/claude-client.ts"
      provides: "tokenDetail in detectIntent and orchestrate return values"
      contains: "tokenDetail"
    - path: "src/lib/agents/types.ts"
      provides: "ModelTokenEntry type exported from agent types"
      contains: "ModelTokenEntry"
  key_links:
    - from: "src/lib/agents/claude-client.ts"
      to: "src/lib/sandbox/types.ts"
      via: "ModelTokenEntry type used in both"
      pattern: "ModelTokenEntry"
    - from: "src/lib/sandbox/sandbox-engine.ts"
      to: "DebugTurn.tokens.models"
      via: "Propagates token detail from Claude calls to debug turns"
      pattern: "models.*ModelTokenEntry"
---

<objective>
Add per-model token tracking types and propagate model identity + input/output token split through the entire pipeline: ClaudeClient -> IntentDetector -> SandboxEngine -> DebugTurn. Also extend sandbox types with CRM agent, ingest timeline, and multi-panel types needed by subsequent plans.

Purpose: Foundation types that all other plans in this phase depend on. Without per-model token detail, the Tokens tab cannot show Haiku vs Sonnet breakdown.
Output: Extended type definitions and modified ClaudeClient/IntentDetector/SandboxEngine returning `tokenDetail` alongside `tokensUsed`.
</objective>

<execution_context>
@/home/jose147/.claude/get-shit-done/workflows/execute-plan.md
@/home/jose147/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/lib/agents/types.ts
@src/lib/agents/claude-client.ts
@src/lib/agents/intent-detector.ts
@src/lib/sandbox/types.ts
@src/lib/sandbox/sandbox-engine.ts
@src/app/api/sandbox/process/route.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend type definitions for per-model tokens, CRM agents, and ingest timeline</name>
  <files>
    src/lib/agents/types.ts
    src/lib/sandbox/types.ts
  </files>
  <action>
**In `src/lib/agents/types.ts`:**

Add a new section "Per-Model Token Tracking" after the Token Budget Types section:

```typescript
// ============================================================================
// Per-Model Token Tracking (Phase 15.6)
// ============================================================================

/**
 * Token usage detail for a single Claude API call, with model identity.
 */
export interface ModelTokenEntry {
  /** Model used for this call (e.g., 'claude-haiku-4-5', 'claude-sonnet-4-5') */
  model: ClaudeModel
  /** Input tokens consumed */
  inputTokens: number
  /** Output tokens consumed */
  outputTokens: number
}
```

**In `src/lib/sandbox/types.ts`:**

1. Add import for `ModelTokenEntry` from `@/lib/agents/types` (add to existing import line).

2. Modify `TokenInfo` to include per-model breakdown:
```typescript
export interface TokenInfo {
  turnNumber: number
  tokensUsed: number // Total (backward compatible)
  /** Per-model breakdown (Phase 15.6) */
  models: ModelTokenEntry[]
  timestamp: string
}
```

3. Add CRM agent types at the bottom of the file:
```typescript
// ============================================================================
// CRM Agent Types (Phase 15.6)
// ============================================================================

/** Execution mode for CRM agents in sandbox */
export type CrmExecutionMode = 'dry-run' | 'live'

/** State of a CRM agent in the sandbox */
export interface CrmAgentState {
  agentId: string
  name: string
  description: string
  enabled: boolean
  mode: CrmExecutionMode
}

/** Result from a CRM agent command execution */
export interface CrmCommandResult {
  success: boolean
  agentId: string
  commandType: string
  data?: Record<string, unknown>
  toolCalls: ToolExecution[]
  tokensUsed: ModelTokenEntry[]
  mode: CrmExecutionMode
  timestamp: string
}
```

4. Add ingest timeline entry type:
```typescript
// ============================================================================
// Ingest Timeline Types (Phase 15.6)
// ============================================================================

/** A single entry in the ingest timeline */
export interface IngestTimelineEntry {
  /** Message content (truncated for display) */
  message: string
  /** Classification result */
  classification: 'datos' | 'pregunta' | 'mixto' | 'irrelevante'
  /** Classification confidence */
  confidence: number
  /** Fields extracted in this message (if any) */
  fieldsExtracted: string[]
  /** Timestamp of classification */
  timestamp: string
}
```

5. Update `IngestStatus` to include timeline:
```typescript
export interface IngestStatus {
  active: boolean
  startedAt: string | null
  firstDataAt: string | null
  fieldsAccumulated: string[]
  timerType: 'partial' | 'no_data' | null
  timerExpiresAt: string | null
  lastClassification?: MessageClassification
  /** Timeline of all classifications (Phase 15.6) */
  timeline: IngestTimelineEntry[]
}
```

6. Add multi-panel types:
```typescript
// ============================================================================
// Multi-Panel Debug Types (Phase 15.6)
// ============================================================================

/** Available debug panel tab IDs */
export type DebugPanelTabId = 'tools' | 'state' | 'intent' | 'tokens' | 'ingest'

/** Configuration for a debug panel tab */
export interface DebugPanelTab {
  id: DebugPanelTabId
  label: string
  visible: boolean
}
```

**IMPORTANT:** Update the existing `ingestStatus` field in `SandboxState` to make timeline required instead of optional by updating the default in `sandbox-engine.ts` to include `timeline: []`.
  </action>
  <verify>
Run `cd /mnt/c/Users/Usuario/Proyectos/morfx-new && npx tsc --noEmit --pretty 2>&1 | head -50` to check for type errors. There may be errors from downstream consumers not yet updated - that's expected and handled in next task.
  </verify>
  <done>
- ModelTokenEntry type exists in agents/types.ts
- TokenInfo includes `models: ModelTokenEntry[]` array
- CrmAgentState, CrmCommandResult, CrmExecutionMode types exist in sandbox/types.ts
- IngestTimelineEntry type exists in sandbox/types.ts
- IngestStatus includes `timeline: IngestTimelineEntry[]`
- DebugPanelTabId and DebugPanelTab types exist
  </done>
</task>

<task type="auto">
  <name>Task 2: Add per-model token detail to ClaudeClient and propagate through IntentDetector</name>
  <files>
    src/lib/agents/claude-client.ts
    src/lib/agents/intent-detector.ts
  </files>
  <action>
**In `src/lib/agents/claude-client.ts`:**

1. Import `ModelTokenEntry` from `./types`.

2. Modify `detectIntent` return type to include `tokenDetail`:
```typescript
async detectIntent(
  systemPrompt: string,
  conversationHistory: ClaudeMessage[],
  currentMessage: string,
  model: ClaudeModel = 'claude-haiku-4-5'
): Promise<{ result: IntentResult; tokensUsed: number; tokenDetail: ModelTokenEntry }> {
```
In the return statement, add:
```typescript
return {
  result,
  tokensUsed,
  tokenDetail: {
    model,
    inputTokens: response.usage.input_tokens,
    outputTokens: response.usage.output_tokens,
  },
}
```

3. Modify `orchestrate` return type to include `tokenDetail`:
```typescript
async orchestrate(/* ... */): Promise<{ result: OrchestratorResult; tokensUsed: number; tokenDetail: ModelTokenEntry }> {
```
In the return statement, add:
```typescript
return {
  result,
  tokensUsed,
  tokenDetail: {
    model,
    inputTokens: response.usage.input_tokens,
    outputTokens: response.usage.output_tokens,
  },
}
```

4. Modify `streamResponse` return type to include `tokenDetail`:
```typescript
async streamResponse(/* ... */): Promise<{ fullText: string; tokensUsed: number; tokenDetail: ModelTokenEntry }> {
```
Add to return:
```typescript
return {
  fullText,
  tokensUsed,
  tokenDetail: {
    model,
    inputTokens: finalMessage.usage.input_tokens,
    outputTokens: finalMessage.usage.output_tokens,
  },
}
```

**In `src/lib/agents/intent-detector.ts`:**

Read the file first. The IntentDetector.detect() method calls claudeClient.detectIntent(). Its return type includes `tokensUsed`. Add `tokenDetails: ModelTokenEntry[]` to the return value.

- Import `ModelTokenEntry` from `./types`.
- In the `detect` method, capture `tokenDetail` from `claudeClient.detectIntent()`.
- Add `tokenDetails: ModelTokenEntry[]` to the return type (array because detect may make multiple calls for reanalyze).
- Collect all tokenDetails from all Claude calls made during detect (initial + possible reanalyze).
- Return `tokenDetails` alongside existing `intent`, `action`, `tokensUsed`.

**IMPORTANT:** Do NOT modify SomnioOrchestrator or SomnioEngine (production code paths) - only the sandbox pipeline needs per-model tracking. The existing `tokensUsed: number` return values remain for backward compatibility.
  </action>
  <verify>
Run `cd /mnt/c/Users/Usuario/Proyectos/morfx-new && npx tsc --noEmit --pretty 2>&1 | head -80`. There will likely be errors in files that call these methods and don't destructure `tokenDetail` yet - that's OK and handled in Task 3.
  </verify>
  <done>
- ClaudeClient.detectIntent returns `{ result, tokensUsed, tokenDetail: ModelTokenEntry }`
- ClaudeClient.orchestrate returns `{ result, tokensUsed, tokenDetail: ModelTokenEntry }`
- ClaudeClient.streamResponse returns `{ fullText, tokensUsed, tokenDetail: ModelTokenEntry }`
- IntentDetector.detect returns `tokenDetails: ModelTokenEntry[]` alongside existing fields
  </done>
</task>

<task type="auto">
  <name>Task 3: Propagate token detail through SandboxEngine to DebugTurn and fix downstream consumers</name>
  <files>
    src/lib/sandbox/sandbox-engine.ts
    src/lib/agents/somnio/somnio-orchestrator.ts
    src/lib/agents/somnio/somnio-engine.ts
    src/lib/agents/somnio/message-classifier.ts
    src/lib/agents/somnio/data-extractor.ts
    src/lib/agents/engine.ts
  </files>
  <action>
**NOTE:** This task lists 6 files but only `sandbox-engine.ts` requires actual code changes. The other 5 files are downstream consumers that need VERIFICATION ONLY (confirm destructuring ignores extra fields). If any consumer has an explicit return type annotation that causes a TypeScript error, fix it minimally. The two concerns (verify consumers + propagate tokens) are tightly coupled since a consumer compile error would block the sandbox-engine changes.

**Part A: Verify downstream consumers of ClaudeClient (read-only verification, fix ONLY if compile error):**

Read each file that calls ClaudeClient methods. The existing code uses destructuring like `const { result, tokensUsed } = await this.claudeClient.detectIntent(...)`. Since we added `tokenDetail` to the return, existing destructuring still works (extra fields are ignored). BUT TypeScript strict mode may complain if the return type is explicitly typed somewhere.

1. **`src/lib/agents/somnio/somnio-orchestrator.ts`** - Uses `this.claudeClient.orchestrate()`. The extra `tokenDetail` in the return is simply ignored by destructuring. Verify no type annotations prevent this. If it calls orchestrate and uses result destructuring, no changes needed - JS/TS destructuring ignores extra fields.

2. **`src/lib/agents/somnio/somnio-engine.ts`** - Uses `this.orchestrator.orchestrate()` (SomnioOrchestrator, not ClaudeClient directly). No changes needed.

3. **`src/lib/agents/somnio/message-classifier.ts`** - Uses `this.claudeClient.detectIntent()`. The extra `tokenDetail` is ignored. No changes needed.

4. **`src/lib/agents/somnio/data-extractor.ts`** - Uses `this.claudeClient.detectIntent()`. The extra `tokenDetail` is ignored. No changes needed.

5. **`src/lib/agents/engine.ts`** - Uses IntentDetector.detect(). The extra `tokenDetails` is ignored. No changes needed.

**Part B: Modify SandboxEngine (actual code changes):**

**Modify SandboxEngine to collect and propagate per-model token details:**

In `src/lib/sandbox/sandbox-engine.ts`:

1. Import `ModelTokenEntry` from `@/lib/agents/types`.

2. In `processMessage()`, initialize a `tokenDetails: ModelTokenEntry[]` array alongside the existing `totalTokens` counter.

3. After the intent detection call (step 3), capture `tokenDetails` from `this.intentDetector.detect()`:
```typescript
const detected = await this.intentDetector.detect(...)
intent = detected.intent
action = detected.action
totalTokens += detected.tokensUsed
// Collect per-model details
if (detected.tokenDetails) {
  tokenDetails.push(...detected.tokenDetails)
}
```

4. After orchestrator call (step 7), the orchestrator returns `tokensUsed` but NOT per-model detail (since we didn't modify SomnioOrchestrator). For now, record orchestrator tokens as Sonnet:
```typescript
totalTokens += orchestratorResult.tokensUsed ?? 0
if (orchestratorResult.tokensUsed) {
  tokenDetails.push({
    model: 'claude-sonnet-4-5',
    inputTokens: Math.round((orchestratorResult.tokensUsed ?? 0) * 0.7), // Approximate split
    outputTokens: Math.round((orchestratorResult.tokensUsed ?? 0) * 0.3),
  })
}
```
Note: This is an approximation. The orchestrator doesn't expose input/output split. This is acceptable for Phase 15.6 since exact tracking requires modifying SomnioOrchestrator which is production code.

5. Include `tokenDetails` in the `DebugTurn.tokens.models`:
```typescript
const debugTurn: DebugTurn = {
  turnNumber,
  intent: intentInfo,
  tools,
  tokens: {
    turnNumber,
    tokensUsed: totalTokens,
    models: tokenDetails,
    timestamp: new Date().toISOString(),
  },
  stateAfter: newState,
}
```

6. Do the same for all return paths (error path, handoff path, silent ingest path) - include `models: tokenDetails` (or `models: []` for paths where no Claude call happened).

7. Update `getInitialState()` to include `timeline: []` in the ingestStatus default:
```typescript
getInitialState(): SandboxState {
  return {
    currentMode: somnioAgentConfig.initialState,
    intentsVistos: [],
    templatesEnviados: [],
    datosCapturados: {},
    packSeleccionado: null,
    ingestStatus: undefined,
  }
}
```
(This remains `undefined` but when IngestStatus IS created in handleIngestMode, ensure `timeline: []` is included.)

8. In `handleIngestMode`, when building `newIngestStatus`, add:
```typescript
timeline: [
  ...(currentState.ingestStatus?.timeline ?? []),
  {
    message: message.substring(0, 100),
    classification: ingestResult.classification.classification,
    confidence: ingestResult.classification.confidence,
    fieldsExtracted: Object.keys(ingestResult.extractedData?.normalized ?? {}),
    timestamp: new Date().toISOString(),
  },
],
```

9. Similarly in `checkImplicitYes`, when building `newIngestStatus`, add `timeline` array with the classification entry.

**Also update `sandbox-layout.tsx` initial state constant** to keep consistency - but since `ingestStatus` is `undefined` initially, no change needed there.
  </action>
  <verify>
Run `cd /mnt/c/Users/Usuario/Proyectos/morfx-new && npx tsc --noEmit --pretty 2>&1 | head -80`. All type errors should be resolved. The build should pass cleanly.
  </verify>
  <done>
- SandboxEngine.processMessage collects ModelTokenEntry[] from all Claude calls
- DebugTurn.tokens.models is populated with per-model breakdown in all code paths
- IngestStatus.timeline is populated with classification entries
- All downstream consumers of ClaudeClient compile without errors
- No changes to production SomnioOrchestrator/SomnioEngine code paths
  </done>
</task>

</tasks>

<verification>
```bash
cd /mnt/c/Users/Usuario/Proyectos/morfx-new && npx tsc --noEmit --pretty
```
All files compile. No regressions in existing functionality.
</verification>

<success_criteria>
1. ModelTokenEntry type exists and is exported from agents/types.ts
2. TokenInfo.models array exists in sandbox/types.ts
3. ClaudeClient methods return tokenDetail: ModelTokenEntry
4. IntentDetector.detect returns tokenDetails: ModelTokenEntry[]
5. SandboxEngine propagates models array to DebugTurn.tokens
6. IngestStatus includes timeline: IngestTimelineEntry[]
7. CRM types (CrmAgentState, CrmCommandResult, etc.) defined
8. TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/15.6-sandbox-evolution/15.6-01-SUMMARY.md`
</output>
