---
phase: 11-shopify-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/20260204000004_shopify_integration.sql
  - src/lib/shopify/types.ts
autonomous: true

must_haves:
  truths:
    - "integrations table exists with workspace isolation"
    - "webhook_events table exists for idempotency and debugging"
    - "orders table has shopify_order_id column for deduplication"
  artifacts:
    - path: "supabase/migrations/20260204000004_shopify_integration.sql"
      provides: "Database schema for Shopify integration"
      contains: "CREATE TABLE integrations"
    - path: "src/lib/shopify/types.ts"
      provides: "TypeScript types for Shopify integration"
      exports: ["ShopifyIntegration", "ShopifyOrderWebhook", "WebhookEvent"]
  key_links:
    - from: "integrations"
      to: "workspaces"
      via: "workspace_id FK"
      pattern: "REFERENCES workspaces\\(id\\)"
    - from: "webhook_events"
      to: "integrations"
      via: "integration_id FK"
      pattern: "REFERENCES integrations\\(id\\)"
---

<objective>
Create database schema and TypeScript types for Shopify integration.

Purpose: Establish the data foundation for storing Shopify credentials, configuration, and webhook event logs with proper workspace isolation.
Output: Migration file with tables and RLS policies, TypeScript types for the integration domain.
</objective>

<execution_context>
@/home/jose147/.claude/get-shit-done/workflows/execute-plan.md
@/home/jose147/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/11-shopify-integration/11-CONTEXT.md
@.planning/phases/11-shopify-integration/11-RESEARCH.md

# Existing patterns to follow:
@supabase/migrations/20260131000002_whatsapp_extended_foundation.sql
@src/lib/orders/types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Database migration for integrations</name>
  <files>supabase/migrations/20260204000004_shopify_integration.sql</files>
  <action>
Create migration with:

1. **integrations table:**
   - id UUID PRIMARY KEY
   - workspace_id UUID NOT NULL REFERENCES workspaces(id) ON DELETE CASCADE
   - type TEXT NOT NULL ('shopify')
   - name TEXT NOT NULL (display name)
   - config JSONB NOT NULL DEFAULT '{}'
   - is_active BOOLEAN DEFAULT true
   - last_sync_at TIMESTAMPTZ
   - created_at/updated_at with timezone('America/Bogota', NOW())
   - UNIQUE(workspace_id, type) -- one Shopify integration per workspace

2. **webhook_events table:**
   - id UUID PRIMARY KEY
   - integration_id UUID NOT NULL REFERENCES integrations(id) ON DELETE CASCADE
   - external_id TEXT NOT NULL (X-Shopify-Webhook-Id)
   - topic TEXT NOT NULL ('orders/create')
   - payload JSONB NOT NULL
   - status TEXT NOT NULL DEFAULT 'pending' ('pending', 'processed', 'failed')
   - error_message TEXT
   - retry_count INTEGER DEFAULT 0
   - processed_at TIMESTAMPTZ
   - created_at with timezone('America/Bogota', NOW())
   - UNIQUE(integration_id, external_id) -- idempotency

3. **ALTER orders ADD COLUMN shopify_order_id BIGINT:**
   - Add column for deduplication
   - Create partial index on shopify_order_id WHERE shopify_order_id IS NOT NULL

4. **RLS policies:**
   - integrations: workspace members can SELECT, only Owner can INSERT/UPDATE/DELETE
   - webhook_events: workspace members can SELECT (for debugging UI)
   - Use is_workspace_owner() helper (create if not exists)

5. **Trigger for updated_at** on integrations table

Follow patterns from 20260131000002_whatsapp_extended_foundation.sql
  </action>
  <verify>Migration file exists with all tables and policies. Run `psql` dry-run if available, otherwise syntax check.</verify>
  <done>integrations, webhook_events tables created. orders.shopify_order_id column added. RLS policies enforce Owner-only write access.</done>
</task>

<task type="auto">
  <name>Task 2: TypeScript types for Shopify domain</name>
  <files>src/lib/shopify/types.ts</files>
  <action>
Create type definitions:

1. **Integration types:**
```typescript
export interface Integration {
  id: string
  workspace_id: string
  type: 'shopify'
  name: string
  config: ShopifyConfig
  is_active: boolean
  last_sync_at: string | null
  created_at: string
  updated_at: string
}

export interface ShopifyConfig {
  shop_domain: string
  access_token: string  // encrypted in practice
  api_secret: string    // encrypted in practice
  default_pipeline_id: string
  default_stage_id: string
  enable_fuzzy_matching: boolean
  product_matching: 'sku' | 'name' | 'value'
  field_mappings?: Record<string, string>
}

export interface ShopifyIntegration extends Integration {
  type: 'shopify'
  config: ShopifyConfig
}
```

2. **Webhook event types:**
```typescript
export interface WebhookEvent {
  id: string
  integration_id: string
  external_id: string
  topic: string
  payload: ShopifyOrderWebhook
  status: 'pending' | 'processed' | 'failed'
  error_message: string | null
  retry_count: number
  processed_at: string | null
  created_at: string
}
```

3. **Shopify Order Webhook payload types** (from research):
```typescript
export interface ShopifyOrderWebhook {
  id: number
  name: string  // "#1001"
  order_number: number
  email: string | null
  phone: string | null
  created_at: string
  total_price: string
  subtotal_price: string
  total_tax: string
  currency: string
  financial_status: string
  fulfillment_status: string | null
  customer: ShopifyCustomer | null
  billing_address: ShopifyAddress | null
  shipping_address: ShopifyAddress | null
  line_items: ShopifyLineItem[]
  note: string | null
}

export interface ShopifyCustomer {
  id: number
  email: string | null
  phone: string | null
  first_name: string | null
  last_name: string | null
  default_address: ShopifyAddress | null
}

export interface ShopifyAddress {
  first_name: string | null
  last_name: string | null
  address1: string | null
  address2: string | null
  city: string | null
  province: string | null
  country: string | null
  zip: string | null
  phone: string | null
}

export interface ShopifyLineItem {
  id: number
  product_id: number | null
  variant_id: number | null
  sku: string
  name: string
  title: string
  quantity: number
  price: string
  total_discount: string
}
```

4. **Form data types:**
```typescript
export interface IntegrationFormData {
  name: string
  shop_domain: string
  access_token: string
  api_secret: string
  default_pipeline_id: string
  default_stage_id: string
  enable_fuzzy_matching: boolean
  product_matching: 'sku' | 'name' | 'value'
}
```

5. **Contact match result types:**
```typescript
export interface ContactMatchResult {
  contact: { id: string; name: string; phone: string } | null
  matchType: 'phone' | 'fuzzy' | 'none'
  confidence: number
  needsVerification: boolean
}
```

Add doc comments for each interface explaining purpose.
  </action>
  <verify>`pnpm tsc --noEmit` passes with new types.</verify>
  <done>All Shopify-related types defined in src/lib/shopify/types.ts with proper exports.</done>
</task>

</tasks>

<verification>
1. Migration file has valid SQL syntax
2. TypeScript types compile without errors
3. RLS policies follow workspace isolation pattern
4. shopify_order_id column exists on orders table
</verification>

<success_criteria>
- integrations table can store Shopify credentials per workspace
- webhook_events table provides idempotency via external_id unique constraint
- orders.shopify_order_id enables deduplication
- TypeScript types match database schema and Shopify webhook format
</success_criteria>

<output>
After completion, create `.planning/phases/11-shopify-integration/11-01-SUMMARY.md`
</output>
