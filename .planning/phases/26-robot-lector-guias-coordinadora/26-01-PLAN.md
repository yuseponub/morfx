---
phase: 26-robot-lector-guias-coordinadora
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/20260222000004_guide_lookup_columns.sql
  - src/lib/domain/orders.ts
  - src/lib/domain/robot-jobs.ts
  - src/inngest/events.ts
autonomous: true

must_haves:
  truths:
    - "After guide lookup completes, CRM orders with found guides have carrier_guide_number populated; pendiente orders remain visible in future guide lookups"
    - "Orders table has a carrier_guide_number column separate from tracking_number"
    - "Robot jobs table has a job_type column to distinguish create_shipment from guide_lookup"
    - "Domain query getOrdersPendingGuide returns orders with tracking_number but without carrier_guide_number"
    - "getActiveJob filters by job_type so shipment and guide jobs don't block each other"
    - "updateOrder supports carrierGuideNumber field and emits field.changed trigger for it"
    - "createRobotJob accepts a jobType parameter stored in the database"
    - "Inngest event type robot/guide-lookup.submitted is defined"
  artifacts:
    - path: "supabase/migrations/20260222000004_guide_lookup_columns.sql"
      provides: "carrier_guide_number on orders + job_type on robot_jobs"
      contains: "carrier_guide_number"
    - path: "src/lib/domain/orders.ts"
      provides: "getOrdersPendingGuide query + carrierGuideNumber in UpdateOrderParams"
      exports: ["getOrdersPendingGuide"]
    - path: "src/lib/domain/robot-jobs.ts"
      provides: "job_type support in createRobotJob + getActiveJob type filtering"
      exports: ["createRobotJob", "getActiveJob"]
    - path: "src/inngest/events.ts"
      provides: "robot/guide-lookup.submitted event type"
      contains: "guide-lookup.submitted"
  key_links:
    - from: "src/lib/domain/orders.ts"
      to: "supabase orders table"
      via: "carrier_guide_number column in select/update"
      pattern: "carrier_guide_number"
    - from: "src/lib/domain/robot-jobs.ts"
      to: "supabase robot_jobs table"
      via: "job_type column in insert/select"
      pattern: "job_type"
---

<objective>
Add the database columns and domain layer extensions required for guide number lookup: `carrier_guide_number` on orders, `job_type` on robot_jobs, new domain queries, and Inngest event types.

Purpose: Establishes the data foundation for the guide lookup feature so that Plans 02 and 03 can build the orchestration and UI on top of it.
Output: Migration file, extended domain functions, and Inngest event type definition.
</objective>

<execution_context>
@/home/jose147/.claude/get-shit-done/workflows/execute-plan.md
@/home/jose147/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@.planning/phases/26-robot-lector-guias-coordinadora/26-CONTEXT.md
@.planning/phases/26-robot-lector-guias-coordinadora/26-RESEARCH.md
@supabase/migrations/20260222000003_robot_jobs.sql
@supabase/migrations/20260129000003_orders_foundation.sql
@src/lib/domain/orders.ts
@src/lib/domain/robot-jobs.ts
@src/inngest/events.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Database migration for carrier_guide_number and job_type</name>
  <files>supabase/migrations/20260222000004_guide_lookup_columns.sql</files>
  <action>
Create a SQL migration file with:

1. Add `carrier_guide_number TEXT` column to the `orders` table:
   ```sql
   ALTER TABLE orders ADD COLUMN IF NOT EXISTS carrier_guide_number TEXT;
   ```

2. Add a partial index on `carrier_guide_number` for efficient lookups of orders that have a guide:
   ```sql
   CREATE INDEX IF NOT EXISTS idx_orders_carrier_guide ON orders(carrier_guide_number)
     WHERE carrier_guide_number IS NOT NULL;
   ```

3. Add `job_type TEXT NOT NULL DEFAULT 'create_shipment'` column to the `robot_jobs` table:
   ```sql
   ALTER TABLE robot_jobs ADD COLUMN IF NOT EXISTS job_type TEXT NOT NULL DEFAULT 'create_shipment';
   ```

4. Add an index on `robot_jobs(workspace_id, job_type, status)` for the type-scoped active job query:
   ```sql
   CREATE INDEX IF NOT EXISTS idx_robot_jobs_type_status ON robot_jobs(workspace_id, job_type, status);
   ```

Use `IF NOT EXISTS` / `IF NOT EXISTS` patterns for idempotent application. Header comment explaining purpose (Phase 26: Guide Lookup Columns).
  </action>
  <verify>File exists and contains valid SQL syntax. Check with `cat supabase/migrations/20260222000004_guide_lookup_columns.sql`.</verify>
  <done>Migration file created with carrier_guide_number on orders, job_type on robot_jobs, and both indexes.</done>
</task>

<task type="auto">
  <name>Task 2: Domain layer extensions (orders + robot-jobs + events)</name>
  <files>
    src/lib/domain/orders.ts
    src/lib/domain/robot-jobs.ts
    src/inngest/events.ts
  </files>
  <action>
**In `src/lib/domain/orders.ts`:**

1. Add `carrierGuideNumber?: string | null` to `UpdateOrderParams` interface (between `trackingNumber` and `shippingAddress`).

2. Add the `carrier_guide_number` mapping to the `updates` object builder in `updateOrder()`:
   ```typescript
   if (params.carrierGuideNumber !== undefined) updates.carrier_guide_number = params.carrierGuideNumber || null
   ```

3. Add `carrier_guide_number` to the `previousOrder` SELECT query in `updateOrder()` so field.changed detection works.

4. Add `{ paramKey: 'carrier_guide_number', dbColumn: 'carrier_guide_number' }` to the `fieldMappings` array in `updateOrder()` so that `emitFieldChanged` fires for carrier_guide_number changes.

5. Add a new exported type `OrderPendingGuide`:
   ```typescript
   export interface OrderPendingGuide {
     id: string
     name: string | null
     tracking_number: string
     contact_name: string | null
   }
   ```

6. Add a new exported function `getOrdersPendingGuide(ctx, stageId)`:
   - Uses `createAdminClient()`, filters by `workspace_id` and `stage_id`
   - SELECT: `id, name, tracking_number, contacts(name)`
   - Filters: `.not('tracking_number', 'is', null)` AND `.is('carrier_guide_number', null)`
   - Maps results to `OrderPendingGuide[]`
   - Returns `DomainResult<OrderPendingGuide[]>`
   - Place this function after `getOrdersByStage` in the file

**In `src/lib/domain/robot-jobs.ts`:**

1. Add `job_type` to the `RobotJob` interface: `job_type: string`

2. Add `jobType?: string` to `CreateRobotJobParams` interface (optional, defaults to 'create_shipment').

3. In `createRobotJob()`, add `job_type` to the insert object: `job_type: params.jobType ?? 'create_shipment'`

4. Modify `getActiveJob()` to accept an optional `jobType?: string` parameter. When provided, add `.eq('job_type', jobType)` to the query. This allows `buscar guias coord` and `subir ordenes coord` to run independently. The function signature becomes:
   ```typescript
   export async function getActiveJob(
     ctx: DomainContext,
     jobType?: string
   ): Promise<DomainResult<GetJobWithItemsResult | null>>
   ```
   In the query, add conditionally:
   ```typescript
   let query = supabase
     .from('robot_jobs')
     .select('id')
     .eq('workspace_id', ctx.workspaceId)
     .in('status', ['pending', 'processing'])
     .order('created_at', { ascending: false })
     .limit(1)

   if (jobType) {
     query = query.eq('job_type', jobType)
   }

   const { data: activeJob, error } = await query.maybeSingle()
   ```

5. In `updateJobItemResult()`, after the existing `if (params.status === 'success' && params.trackingNumber)` block that updates order tracking_number, add a new block for carrier guide number. To know whether this is a guide_lookup job, look up the parent job's job_type:
   - BEFORE the existing tracking_number block, fetch the parent job's job_type:
     ```typescript
     // Fetch parent job type to determine which field to update on the order
     const { data: parentJob } = await supabase
       .from('robot_jobs')
       .select('job_type')
       .eq('id', item.job_id)
       .single()
     ```
   - Modify the existing tracking_number update block to be conditional on `parentJob?.job_type !== 'guide_lookup'` (only write tracking_number for create_shipment jobs).
   - Add new block: if `parentJob?.job_type === 'guide_lookup' && params.status === 'success' && params.trackingNumber` (the callback reuses trackingNumber field for the guide), call `updateOrder(ctx, { orderId: item.order_id, carrierGuideNumber: params.trackingNumber })`.

   IMPORTANT: For guide_lookup jobs, the callback payload's `trackingNumber` field will actually carry the guide number (to reuse the existing callback contract). The domain function maps it to the correct order field based on job_type.

**In `src/inngest/events.ts`:**

1. Add a new event type `'robot/guide-lookup.submitted'` to the `RobotEvents` type:
   ```typescript
   /**
    * Emitted by MorfX to trigger guide lookup robot job.
    * Consumed by Inngest guide-lookup orchestrator (Phase 26).
    */
   'robot/guide-lookup.submitted': {
     data: {
       jobId: string
       workspaceId: string
       credentials: {
         username: string
         password: string
       }
       pedidoNumbers: Array<{
         itemId: string
         orderId: string
         pedidoNumber: string
       }>
     }
   }
   ```
  </action>
  <verify>
Run `npx tsc --noEmit` from the project root. No TypeScript errors in modified files.
  </verify>
  <done>
- UpdateOrderParams has carrierGuideNumber field
- updateOrder emits field.changed for carrier_guide_number
- getOrdersPendingGuide query exported from orders domain
- createRobotJob accepts jobType parameter
- getActiveJob accepts optional jobType filter
- updateJobItemResult routes guide number updates to correct order field based on parent job type
- Pendiente callbacks (status=success, trackingNumber=undefined) leave carrier_guide_number untouched — orders remain in getOrdersPendingGuide results
- robot/guide-lookup.submitted event type defined
  </done>
</task>

</tasks>

<verification>
1. Migration file exists with correct SQL (carrier_guide_number on orders, job_type on robot_jobs)
2. `npx tsc --noEmit` passes — all new types and exports are valid
3. `getOrdersPendingGuide` correctly filters by tracking_number NOT NULL and carrier_guide_number IS NULL
4. `getActiveJob('guide_lookup')` would not conflict with `getActiveJob('create_shipment')`
5. `updateJobItemResult` for a guide_lookup job writes to carrier_guide_number (not tracking_number)
6. fieldMappings array includes carrier_guide_number so field.changed triggers fire
7. `updateJobItemResult` for a guide_lookup job with `trackingNumber=undefined` (pendiente) does NOT write carrier_guide_number=null — the condition `params.trackingNumber` is falsy so the updateOrder call is skipped entirely, leaving the order eligible for future guide lookups
</verification>

<success_criteria>
- Migration file created with both columns and indexes
- All domain functions extended and TypeScript compiles
- New event type is defined in events.ts
- No breaking changes to existing create_shipment flow (backward compatible defaults)
</success_criteria>

<output>
After completion, create `.planning/phases/26-robot-lector-guias-coordinadora/26-01-SUMMARY.md`
</output>
