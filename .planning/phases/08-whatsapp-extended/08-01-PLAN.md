---
phase: 08-whatsapp-extended
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/20260131000001_whatsapp_extended_foundation.sql
  - src/lib/whatsapp/types.ts
  - src/lib/whatsapp/templates-api.ts
  - src/app/actions/templates.ts
autonomous: true

must_haves:
  truths:
    - "Template records can be stored and retrieved per workspace"
    - "Teams can be created and agents added to them"
    - "Quick replies can be stored and retrieved per workspace"
    - "Message costs can be recorded with deduplication"
    - "Workspace limits can be configured by super admin"
  artifacts:
    - path: "supabase/migrations/20260131000001_whatsapp_extended_foundation.sql"
      provides: "Database schema for templates, teams, quick_replies, message_costs, workspace_limits"
      contains: "whatsapp_templates"
    - path: "src/lib/whatsapp/types.ts"
      provides: "TypeScript types for templates, teams, quick replies, costs"
      exports: ["Template", "Team", "TeamMember", "QuickReply", "MessageCost"]
    - path: "src/lib/whatsapp/templates-api.ts"
      provides: "360dialog API client for template operations"
      exports: ["createTemplate", "listTemplates", "deleteTemplate", "syncTemplateStatus"]
    - path: "src/app/actions/templates.ts"
      provides: "Server Actions for template CRUD"
      exports: ["getTemplates", "createTemplate", "updateTemplate", "deleteTemplate"]
  key_links:
    - from: "src/app/actions/templates.ts"
      to: "src/lib/whatsapp/templates-api.ts"
      via: "API calls for 360dialog operations"
      pattern: "templates-api"
---

<objective>
Create the database foundation and API layer for Phase 8 features: templates, teams, quick replies, and cost tracking.

Purpose: Establish all data models and 360dialog API integration before building UI.
Output: Database tables with RLS, TypeScript types, template API client, and template Server Actions.
</objective>

<execution_context>
@/home/jose147/.claude/get-shit-done/workflows/execute-plan.md
@/home/jose147/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-whatsapp-extended/08-CONTEXT.md
@.planning/phases/08-whatsapp-extended/08-RESEARCH.md
@supabase/migrations/20260130000002_whatsapp_conversations.sql
@src/lib/whatsapp/types.ts
@src/lib/whatsapp/api.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Database Schema for Extended WhatsApp Features</name>
  <files>supabase/migrations/20260131000001_whatsapp_extended_foundation.sql</files>
  <action>
Create a single migration file with all Phase 8 tables:

**whatsapp_templates table:**
- id UUID primary key
- workspace_id UUID references workspaces(id) ON DELETE CASCADE
- name TEXT NOT NULL (unique per workspace)
- language TEXT NOT NULL DEFAULT 'es'
- category TEXT NOT NULL CHECK IN ('MARKETING', 'UTILITY', 'AUTHENTICATION')
- status TEXT NOT NULL DEFAULT 'PENDING' CHECK IN ('PENDING', 'APPROVED', 'REJECTED', 'PAUSED', 'DISABLED')
- quality_rating TEXT CHECK IN ('HIGH', 'MEDIUM', 'LOW', 'PENDING')
- rejected_reason TEXT
- components JSONB NOT NULL (header, body, footer, buttons)
- variable_mapping JSONB DEFAULT '{}' (maps {{1}} to contact.name, etc.)
- created_at, updated_at, submitted_at, approved_at TIMESTAMPTZ
- UNIQUE(workspace_id, name)
- Index on (workspace_id, status)

**teams table:**
- id UUID primary key
- workspace_id UUID references workspaces(id) ON DELETE CASCADE
- name TEXT NOT NULL
- is_default BOOLEAN DEFAULT false (new conversations go here)
- created_at TIMESTAMPTZ
- UNIQUE(workspace_id, name)

**team_members table:**
- id UUID primary key
- team_id UUID references teams(id) ON DELETE CASCADE
- user_id UUID references auth.users(id) ON DELETE CASCADE
- is_online BOOLEAN NOT NULL DEFAULT false (manual availability toggle)
- last_assigned_at TIMESTAMPTZ (for round-robin)
- created_at TIMESTAMPTZ
- UNIQUE(team_id, user_id)

**ALTER conversations table:**
- Add team_id UUID REFERENCES teams(id) ON DELETE SET NULL
- Add index on team_id

**quick_replies table:**
- id UUID primary key
- workspace_id UUID references workspaces(id) ON DELETE CASCADE
- shortcut TEXT NOT NULL (e.g., "saludo")
- content TEXT NOT NULL
- category TEXT (optional grouping, future feature)
- created_at, updated_at TIMESTAMPTZ
- UNIQUE(workspace_id, shortcut)

**message_costs table:**
- id UUID primary key
- workspace_id UUID references workspaces(id) ON DELETE CASCADE
- wamid TEXT NOT NULL UNIQUE (prevents duplicate tracking from webhook retries)
- category TEXT NOT NULL CHECK IN ('marketing', 'utility', 'authentication', 'service')
- pricing_model TEXT NOT NULL DEFAULT 'PMP'
- recipient_country TEXT
- cost_usd DECIMAL(10, 6)
- recorded_at TIMESTAMPTZ
- Indexes on (workspace_id, recorded_at) and (workspace_id, category)

**workspace_limits table (for super admin):**
- workspace_id UUID PRIMARY KEY references workspaces(id) ON DELETE CASCADE
- allowed_categories JSONB DEFAULT '["MARKETING", "UTILITY", "AUTHENTICATION"]'
- quick_replies_with_variables BOOLEAN DEFAULT false
- quick_replies_with_categories BOOLEAN DEFAULT false
- monthly_spend_limit_usd DECIMAL(10, 2) NULL (NULL = unlimited)
- alert_threshold_percent INTEGER DEFAULT 80
- updated_at TIMESTAMPTZ
- updated_by UUID references auth.users(id)

**RLS Policies:**
- whatsapp_templates: is_workspace_admin for all operations (Owner/Admin only)
- teams: is_workspace_member for SELECT, is_workspace_admin for INSERT/UPDATE/DELETE
- team_members: is_workspace_member via team lookup
- quick_replies: is_workspace_member for all operations
- message_costs: is_workspace_admin for SELECT only (no insert via RLS - webhook uses service role)
- workspace_limits: NO policies (accessed via admin client only - super admin)

**Helper functions (if not exists):**
- is_workspace_admin(workspace_id UUID) - returns true if user is owner or admin

Use timezone('America/Bogota', NOW()) for all timestamps per project convention.
  </action>
  <verify>Run `pnpm supabase db push --dry-run` to validate SQL syntax. Check that no errors are reported.</verify>
  <done>Migration file exists with all 6 tables, proper foreign keys, indexes, and RLS policies. SQL syntax validates successfully.</done>
</task>

<task type="auto">
  <name>Task 2: TypeScript Types and 360dialog Template API Client</name>
  <files>
    src/lib/whatsapp/types.ts
    src/lib/whatsapp/templates-api.ts
  </files>
  <action>
**Extend src/lib/whatsapp/types.ts** with new types:

```typescript
// Template types
export type TemplateCategory = 'MARKETING' | 'UTILITY' | 'AUTHENTICATION'
export type TemplateStatus = 'PENDING' | 'APPROVED' | 'REJECTED' | 'PAUSED' | 'DISABLED'
export type QualityRating = 'HIGH' | 'MEDIUM' | 'LOW' | 'PENDING'

export interface TemplateComponent {
  type: 'HEADER' | 'BODY' | 'FOOTER' | 'BUTTONS'
  format?: 'TEXT' | 'IMAGE' | 'VIDEO' | 'DOCUMENT'
  text?: string
  buttons?: Array<{
    type: 'PHONE_NUMBER' | 'URL' | 'QUICK_REPLY'
    text: string
    phone_number?: string
    url?: string
  }>
}

export interface Template {
  id: string
  workspace_id: string
  name: string
  language: string
  category: TemplateCategory
  status: TemplateStatus
  quality_rating: QualityRating | null
  rejected_reason: string | null
  components: TemplateComponent[]
  variable_mapping: Record<string, string>  // "1" -> "contact.name"
  created_at: string
  updated_at: string
  submitted_at: string | null
  approved_at: string | null
}

// Team types
export interface Team {
  id: string
  workspace_id: string
  name: string
  is_default: boolean
  created_at: string
}

export interface TeamMember {
  id: string
  team_id: string
  user_id: string
  is_online: boolean
  last_assigned_at: string | null
  created_at: string
  // Joined fields
  user_email?: string
  user_name?: string
}

// Quick Reply types
export interface QuickReply {
  id: string
  workspace_id: string
  shortcut: string
  content: string
  category: string | null
  created_at: string
  updated_at: string
}

// Cost tracking types
export type CostCategory = 'marketing' | 'utility' | 'authentication' | 'service'

export interface MessageCost {
  id: string
  workspace_id: string
  wamid: string
  category: CostCategory
  pricing_model: string
  recipient_country: string | null
  cost_usd: number | null
  recorded_at: string
}

// Workspace limits types
export interface WorkspaceLimits {
  workspace_id: string
  allowed_categories: TemplateCategory[]
  quick_replies_with_variables: boolean
  quick_replies_with_categories: boolean
  monthly_spend_limit_usd: number | null
  alert_threshold_percent: number
  updated_at: string
  updated_by: string | null
}
```

**Create src/lib/whatsapp/templates-api.ts**:

```typescript
// 360dialog Template Management API client
// https://docs.360dialog.com/docs/waba-messaging/template-messaging

const BASE_URL = 'https://waba-v2.360dialog.io'

interface CreateTemplateParams {
  name: string
  language: string
  category: 'MARKETING' | 'UTILITY' | 'AUTHENTICATION'
  components: TemplateComponent[]
}

export async function createTemplate360(
  apiKey: string,
  params: CreateTemplateParams
) {
  const response = await fetch(`${BASE_URL}/v1/configs/templates`, {
    method: 'POST',
    headers: {
      'D360-API-KEY': apiKey,
      'Content-Type': 'application/json'
    },
    body: JSON.stringify(params)
  })

  if (!response.ok) {
    const error = await response.json()
    throw new Error(error.error?.message || 'Template creation failed')
  }

  return response.json()
}

export async function listTemplates360(apiKey: string) {
  const response = await fetch(`${BASE_URL}/v1/configs/templates?limit=250`, {
    headers: { 'D360-API-KEY': apiKey }
  })

  if (!response.ok) {
    throw new Error('Failed to list templates')
  }

  return response.json()  // { waba_templates: [...], count, total }
}

export async function deleteTemplate360(apiKey: string, templateName: string) {
  const response = await fetch(
    `${BASE_URL}/v1/configs/templates/${templateName}`,
    {
      method: 'DELETE',
      headers: { 'D360-API-KEY': apiKey }
    }
  )

  return response.ok
}

export async function getTemplateByName360(apiKey: string, templateName: string) {
  const response = await fetch(
    `${BASE_URL}/v1/configs/templates/${templateName}`,
    {
      headers: { 'D360-API-KEY': apiKey }
    }
  )

  if (!response.ok) {
    return null
  }

  return response.json()
}
```

Import TemplateComponent type in templates-api.ts.
  </action>
  <verify>Run `pnpm tsc --noEmit` to verify types compile without errors.</verify>
  <done>Types extended with Template, Team, TeamMember, QuickReply, MessageCost, WorkspaceLimits. API client created with createTemplate360, listTemplates360, deleteTemplate360, getTemplateByName360. TypeScript compiles successfully.</done>
</task>

<task type="auto">
  <name>Task 3: Template Server Actions</name>
  <files>src/app/actions/templates.ts</files>
  <action>
Create Server Actions for template CRUD operations:

```typescript
'use server'

import { createClient } from '@/lib/supabase/server'
import { getWorkspaceId } from '@/lib/workspace'
import { revalidatePath } from 'next/cache'
import { Template, TemplateComponent, TemplateCategory } from '@/lib/whatsapp/types'
import { createTemplate360, listTemplates360, deleteTemplate360, getTemplateByName360 } from '@/lib/whatsapp/templates-api'

// Get all templates for current workspace
export async function getTemplates(): Promise<Template[]> {
  const supabase = await createClient()
  const workspaceId = await getWorkspaceId()

  if (!workspaceId) {
    throw new Error('No workspace selected')
  }

  const { data, error } = await supabase
    .from('whatsapp_templates')
    .select('*')
    .eq('workspace_id', workspaceId)
    .order('created_at', { ascending: false })

  if (error) throw error
  return data || []
}

// Get single template by ID
export async function getTemplate(id: string): Promise<Template | null> {
  const supabase = await createClient()
  const workspaceId = await getWorkspaceId()

  const { data, error } = await supabase
    .from('whatsapp_templates')
    .select('*')
    .eq('id', id)
    .eq('workspace_id', workspaceId)
    .single()

  if (error) return null
  return data
}

// Create new template (local + submit to 360dialog)
export async function createTemplate(params: {
  name: string
  language: string
  category: TemplateCategory
  components: TemplateComponent[]
  variable_mapping?: Record<string, string>
}): Promise<Template> {
  const supabase = await createClient()
  const workspaceId = await getWorkspaceId()

  if (!workspaceId) {
    throw new Error('No workspace selected')
  }

  // Validate name format (lowercase, underscores only)
  const cleanName = params.name.toLowerCase().replace(/[^a-z0-9_]/g, '_')

  // Insert into local database first
  const { data: template, error } = await supabase
    .from('whatsapp_templates')
    .insert({
      workspace_id: workspaceId,
      name: cleanName,
      language: params.language || 'es',
      category: params.category,
      status: 'PENDING',
      components: params.components,
      variable_mapping: params.variable_mapping || {}
    })
    .select()
    .single()

  if (error) throw error

  // Submit to 360dialog (async, don't block)
  // TODO: Get API key from workspace settings
  const apiKey = process.env.WHATSAPP_API_KEY
  if (apiKey) {
    try {
      await createTemplate360(apiKey, {
        name: cleanName,
        language: params.language || 'es',
        category: params.category,
        components: params.components
      })

      // Update submitted_at
      await supabase
        .from('whatsapp_templates')
        .update({ submitted_at: new Date().toISOString() })
        .eq('id', template.id)
    } catch (apiError) {
      console.error('Failed to submit template to 360dialog:', apiError)
      // Template is saved locally, can retry submission later
    }
  }

  revalidatePath('/configuracion/whatsapp/templates')
  return template
}

// Update template variable mapping (local only - can't update submitted template)
export async function updateTemplateMapping(
  id: string,
  variable_mapping: Record<string, string>
): Promise<void> {
  const supabase = await createClient()
  const workspaceId = await getWorkspaceId()

  const { error } = await supabase
    .from('whatsapp_templates')
    .update({ variable_mapping, updated_at: new Date().toISOString() })
    .eq('id', id)
    .eq('workspace_id', workspaceId)

  if (error) throw error
  revalidatePath('/configuracion/whatsapp/templates')
}

// Delete template (local + from 360dialog if exists)
export async function deleteTemplate(id: string): Promise<void> {
  const supabase = await createClient()
  const workspaceId = await getWorkspaceId()

  // Get template name first
  const { data: template } = await supabase
    .from('whatsapp_templates')
    .select('name')
    .eq('id', id)
    .eq('workspace_id', workspaceId)
    .single()

  if (!template) {
    throw new Error('Template not found')
  }

  // Delete from 360dialog
  const apiKey = process.env.WHATSAPP_API_KEY
  if (apiKey) {
    try {
      await deleteTemplate360(apiKey, template.name)
    } catch (apiError) {
      console.error('Failed to delete template from 360dialog:', apiError)
      // Continue with local delete
    }
  }

  // Delete from local database
  const { error } = await supabase
    .from('whatsapp_templates')
    .delete()
    .eq('id', id)
    .eq('workspace_id', workspaceId)

  if (error) throw error
  revalidatePath('/configuracion/whatsapp/templates')
}

// Sync template status from 360dialog
export async function syncTemplateStatuses(): Promise<void> {
  const supabase = await createClient()
  const workspaceId = await getWorkspaceId()

  const apiKey = process.env.WHATSAPP_API_KEY
  if (!apiKey) return

  try {
    const response = await listTemplates360(apiKey)
    const remoteTemplates = response.waba_templates || []

    // Update local templates with remote status
    for (const remote of remoteTemplates) {
      await supabase
        .from('whatsapp_templates')
        .update({
          status: remote.status,
          quality_rating: remote.quality_score?.score || null,
          rejected_reason: remote.rejected_reason || null,
          approved_at: remote.status === 'APPROVED' ? new Date().toISOString() : null
        })
        .eq('workspace_id', workspaceId)
        .eq('name', remote.name)
    }

    revalidatePath('/configuracion/whatsapp/templates')
  } catch (error) {
    console.error('Failed to sync template statuses:', error)
  }
}

// Get only approved templates (for sending)
export async function getApprovedTemplates(): Promise<Template[]> {
  const supabase = await createClient()
  const workspaceId = await getWorkspaceId()

  const { data, error } = await supabase
    .from('whatsapp_templates')
    .select('*')
    .eq('workspace_id', workspaceId)
    .eq('status', 'APPROVED')
    .order('name')

  if (error) throw error
  return data || []
}
```

Use existing patterns from src/app/actions/conversations.ts for Supabase client and workspace context.
  </action>
  <verify>Run `pnpm tsc --noEmit` to verify no TypeScript errors. Verify imports resolve correctly.</verify>
  <done>Template Server Actions created: getTemplates, getTemplate, createTemplate, updateTemplateMapping, deleteTemplate, syncTemplateStatuses, getApprovedTemplates. All actions use workspace isolation and RLS.</done>
</task>

</tasks>

<verification>
1. Database migration creates all tables with proper constraints and indexes
2. RLS policies correctly restrict access by role
3. TypeScript types compile without errors
4. 360dialog API client functions are exported
5. Template Server Actions handle CRUD with workspace isolation
</verification>

<success_criteria>
- Migration file validates with `pnpm supabase db push --dry-run`
- TypeScript compiles with no errors
- Template types include all required fields
- API client has create, list, delete, get operations
- Server Actions handle local database + 360dialog sync
</success_criteria>

<output>
After completion, create `.planning/phases/08-whatsapp-extended/08-01-SUMMARY.md`
</output>
