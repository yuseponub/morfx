---
phase: 16-whatsapp-agent-integration
plan: 03
type: execute
wave: 2
depends_on: ["16-01"]
files_modified:
  - src/app/(dashboard)/whatsapp/components/message-bubble.tsx
  - src/app/(dashboard)/whatsapp/components/conversation-item.tsx
  - src/app/(dashboard)/whatsapp/components/chat-header.tsx
  - src/app/(dashboard)/whatsapp/components/chat-view.tsx
  - src/app/(dashboard)/whatsapp/components/conversation-list.tsx
autonomous: true

must_haves:
  truths:
    - "Agent messages show a robot badge icon (Apple style) on the message bubble"
    - "Conversation list shows robot overlay on avatar when agent is active for that conversation"
    - "Chat header has two toggle switches: one for conversational agent, one for CRM agents"
    - "Chat view shows 'Bot escribiendo...' indicator when agent is processing"
    - "User can toggle per-chat agent on/off and the change takes effect immediately"
    - "Manager can filter conversation list to see only conversations attended by the agent"
  artifacts:
    - path: "src/app/(dashboard)/whatsapp/components/message-bubble.tsx"
      provides: "Bot badge on agent-sent messages"
      contains: "sent_by_agent"
    - path: "src/app/(dashboard)/whatsapp/components/conversation-item.tsx"
      provides: "Bot avatar overlay when agent active"
      contains: "agent_conversational"
    - path: "src/app/(dashboard)/whatsapp/components/chat-header.tsx"
      provides: "Per-chat agent toggles"
      contains: "toggleConversationAgent"
    - path: "src/app/(dashboard)/whatsapp/components/chat-view.tsx"
      provides: "Bot typing indicator"
      contains: "agent_typing"
    - path: "src/app/(dashboard)/whatsapp/components/conversation-list.tsx"
      provides: "Agent filter in conversation list"
      contains: "agent_filter"
  key_links:
    - from: "src/app/(dashboard)/whatsapp/components/chat-header.tsx"
      to: "src/app/actions/agent-config.ts"
      via: "toggleConversationAgent server action"
      pattern: "toggleConversationAgent"
    - from: "src/app/(dashboard)/whatsapp/components/chat-view.tsx"
      to: "Supabase Realtime broadcast"
      via: "channel subscription for agent_typing"
      pattern: "agent_typing"
---

<objective>
Add agent visual indicators and per-chat controls to the WhatsApp inbox UI.

Purpose: Users need to see which messages were sent by the agent (robot badge), which conversations have the agent active (avatar overlay), and control the agent per-conversation (header toggles). The "Bot escribiendo..." indicator provides real-time feedback during agent processing.

Output: Modified message-bubble, conversation-item, chat-header, and chat-view components with agent UX.
</objective>

<execution_context>
@/home/jose147/.claude/get-shit-done/workflows/execute-plan.md
@/home/jose147/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/16-whatsapp-agent-integration/16-CONTEXT.md
@.planning/phases/16-whatsapp-agent-integration/16-RESEARCH.md

Key source files:
@src/app/(dashboard)/whatsapp/components/message-bubble.tsx
@src/app/(dashboard)/whatsapp/components/conversation-item.tsx
@src/app/(dashboard)/whatsapp/components/chat-header.tsx
@src/app/(dashboard)/whatsapp/components/chat-view.tsx
@src/app/actions/agent-config.ts (from Plan 01)
@src/lib/whatsapp/types.ts (updated in Plan 01)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Bot badge on messages + bot avatar overlay on conversations</name>
  <files>
    src/app/(dashboard)/whatsapp/components/message-bubble.tsx
    src/app/(dashboard)/whatsapp/components/conversation-item.tsx
  </files>
  <action>
**message-bubble.tsx:**

1. Import Bot icon from lucide-react.

2. The Message type now has `sent_by_agent: boolean` (from Plan 01 types update).

3. Add a bot badge to outbound messages when `message.sent_by_agent === true`:
   - Position: Small icon at the top-left of the message bubble (for outbound/own messages which appear on the right)
   - Style: A small circular badge with Bot icon (lucide-react), using a muted/secondary color
   - Apple/iPhone style: Clean, minimal, rounded — a small circle (w-5 h-5) with bg-muted border, containing a Bot icon (h-3 w-3)
   - Place it just above or beside the message content area, NOT inside the bubble but as an overlay/label

   Suggested implementation:
   ```tsx
   {message.sent_by_agent && isOwn && (
     <div className="flex items-center gap-1 mb-0.5">
       <span className="inline-flex items-center gap-1 text-[10px] text-muted-foreground">
         <Bot className="h-3 w-3" />
         Bot
       </span>
     </div>
   )}
   ```
   Place this ABOVE the message bubble content, within the outer wrapper div, only for outbound agent messages.

4. Do NOT change the bubble color or alignment — only add the badge label.

**conversation-item.tsx:**

1. Import Bot icon from lucide-react.

2. The Conversation type now has `agent_conversational: boolean | null` (from Plan 01 types update).

3. Add a bot overlay icon on the avatar when the conversation has agent_conversational !== false AND there exists a global config (we'll check just the conversation field for now — true or null means "active or inheriting"):
   - Since we can't easily check global config from a list item component, show the overlay when `conversation.agent_conversational === true` (explicitly enabled per-chat) OR when agent_conversational is null AND there's some visual hint. For simplicity: show overlay when `agent_conversational !== false` (null inherits global, true is explicit ON).
   - Actually, to avoid showing on ALL conversations when we don't know global state: only show overlay when `agent_conversational === true` (explicitly ON per-chat). The default (null) will show global-inherited state from the config slider context.
   - REVISED: Pass an `agentActive` boolean prop from the parent (ConversationList) that resolves global+per-chat. The ConversationList will need to know the global setting. For now, show the icon when `agent_conversational === true` explicitly. We can enhance in Plan 04 when we have the config slider providing global state.

4. Bot overlay position: Bottom-right of the avatar circle, as a small (w-4 h-4) circle with bg-blue-500 text-white containing Bot icon (h-2.5 w-2.5). Same position pattern as the existing order emoji overlay.
   ```tsx
   {conversation.agent_conversational === true && (
     <div className="absolute -bottom-0.5 -right-0.5 w-4 h-4 rounded-full bg-blue-500 flex items-center justify-center border border-background">
       <Bot className="h-2.5 w-2.5 text-white" />
     </div>
   )}
   ```
   Add this inside the `<div className="relative flex-shrink-0">` wrapper next to the existing emoji indicator.
  </action>
  <verify>TypeScript compiles. Visually inspect: outbound agent messages show "Bot" label, conversation avatar shows blue bot icon when agent_conversational is true.</verify>
  <done>Agent messages visually distinguished with Bot badge. Conversations with explicit agent activation show bot overlay on avatar.</done>
</task>

<task type="auto">
  <name>Task 2: Per-chat agent toggles + bot typing indicator</name>
  <files>
    src/app/(dashboard)/whatsapp/components/chat-header.tsx
    src/app/(dashboard)/whatsapp/components/chat-view.tsx
  </files>
  <action>
**chat-header.tsx:**

1. Import Switch from '@/components/ui/switch' (shadcn component, already in codebase from Phase 15.7).
2. Import Bot icon from lucide-react.
3. Import { toggleConversationAgent, getConversationAgentStatus } from '@/app/actions/agent-config'.
4. Import useEffect for loading agent status.

5. Add agent toggle state:
   ```typescript
   const [agentConversational, setAgentConversational] = useState<boolean | null>(null)
   const [agentCrm, setAgentCrm] = useState<boolean | null>(null)
   const [loadingAgent, setLoadingAgent] = useState(false)
   ```

6. Load agent status on conversation change:
   ```typescript
   useEffect(() => {
     getConversationAgentStatus(conversation.id).then(status => {
       if (!('error' in status)) {
         setAgentConversational(status.conversational)
         setAgentCrm(status.crm)
       }
     })
   }, [conversation.id])
   ```

7. Add toggle handlers:
   ```typescript
   const handleToggleConversational = async (checked: boolean) => {
     setAgentConversational(checked)
     const result = await toggleConversationAgent(conversation.id, 'conversational', checked)
     if ('error' in result) {
       toast.error(result.error)
       setAgentConversational(!checked) // Revert on error
     }
   }
   const handleToggleCrm = async (checked: boolean) => {
     setAgentCrm(checked)
     const result = await toggleConversationAgent(conversation.id, 'crm', checked)
     if ('error' in result) {
       toast.error(result.error)
       setAgentCrm(!checked)
     }
   }
   ```

8. Add toggles in the header, in the actions area (between the tag input and the assignment dropdown):
   ```tsx
   {/* Agent toggles - Apple style */}
   <div className="flex items-center gap-2 ml-2 pl-2 border-l">
     <div className="flex items-center gap-1.5">
       <Bot className="h-3.5 w-3.5 text-muted-foreground" />
       <Switch
         checked={agentConversational === true}
         onCheckedChange={handleToggleConversational}
         disabled={loadingAgent}
         className="scale-75"
       />
     </div>
     <div className="flex items-center gap-1.5">
       <span className="text-[10px] text-muted-foreground">CRM</span>
       <Switch
         checked={agentCrm === true}
         onCheckedChange={handleToggleCrm}
         disabled={loadingAgent}
         className="scale-75"
       />
     </div>
   </div>
   ```

   Place this group between the tag input section and the action buttons. Use `scale-75` on Switch for compact size.

**chat-view.tsx:**

1. Import { createBrowserClient } from '@supabase/ssr' or use existing browser client from '@/lib/supabase/client'.
2. Add state for agent typing:
   ```typescript
   const [isAgentTyping, setIsAgentTyping] = useState(false)
   ```

3. Subscribe to Supabase Realtime broadcast for "agent_typing" events:
   ```typescript
   useEffect(() => {
     if (!conversationId) return

     const supabase = createClient() // browser client
     const channel = supabase.channel(`agent-typing:${conversationId}`)
       .on('broadcast', { event: 'agent_typing' }, ({ payload }) => {
         setIsAgentTyping(payload?.isTyping ?? false)
       })
       .subscribe()

     return () => {
       supabase.removeChannel(channel)
     }
   }, [conversationId])
   ```

4. Auto-clear typing indicator after 30 seconds (safety timeout):
   ```typescript
   useEffect(() => {
     if (!isAgentTyping) return
     const timer = setTimeout(() => setIsAgentTyping(false), 30000)
     return () => clearTimeout(timer)
   }, [isAgentTyping])
   ```

5. Display "Bot escribiendo..." indicator just above the message input:
   ```tsx
   {isAgentTyping && (
     <div className="px-4 py-1.5 text-xs text-muted-foreground flex items-center gap-1.5 animate-pulse">
       <Bot className="h-3 w-3" />
       <span>Bot escribiendo...</span>
     </div>
   )}
   ```

   Place this between the message list and the MessageInput component.

6. NOTE: The typing indicator broadcast (isTyping true/false) is emitted by webhook-processor.ts in Plan 02. Plan 03 only needs to subscribe and display it — no broadcast logic here.
  </action>
  <verify>TypeScript compiles. Toggles render in chat header with Bot icon. Typing indicator uses Supabase Realtime broadcast. Toggles call server actions correctly with optimistic updates.</verify>
  <done>Per-chat agent toggles in header with optimistic updates. Bot typing indicator with Realtime broadcast subscription. Auto-clear safety timeout for typing.</done>
</task>

<task type="auto">
  <name>Task 3: Agent filter in conversation list (WINT-06)</name>
  <files>
    src/app/(dashboard)/whatsapp/components/conversation-list.tsx
  </files>
  <action>
Add an "Agente" filter option to the conversation list so managers can see which conversations were attended by the agent.

1. Look at the existing filter/search mechanism in conversation-list.tsx. There are likely existing filter options (e.g., by tags, by status). Add a new filter option alongside them.

2. Add filter state:
   ```typescript
   const [agentFilter, setAgentFilter] = useState<'all' | 'agent-attended' | 'human-only'>('all')
   ```

3. Add a filter toggle button or dropdown in the filter area of the conversation list:
   - A small Bot icon toggle button that cycles between: all conversations / agent-attended only / human-only
   - When active (agent-attended), highlight the button with bg-blue-500 style
   - Use a simple 3-state toggle: click once = agent-attended (blue), click again = human-only (gray), click again = all (default)
   - OR use a simpler approach: single toggle button with Bot icon. OFF = show all, ON = show only agent-attended conversations

   Simplest implementation:
   ```tsx
   <Button
     variant={agentFilter === 'agent-attended' ? 'default' : 'ghost'}
     size="icon"
     className="h-7 w-7"
     onClick={() => setAgentFilter(prev => prev === 'agent-attended' ? 'all' : 'agent-attended')}
     title="Filtrar: atendidas por agente"
   >
     <Bot className="h-3.5 w-3.5" />
   </Button>
   ```

4. Apply the filter to the conversation list:
   - When agentFilter === 'agent-attended': filter conversations where `agent_conversational === true` (explicitly enabled) OR where the conversation has messages with `sent_by_agent = true`.
   - Since checking messages would require extra DB queries, use a simpler heuristic: filter conversations where `agent_conversational === true` OR `agent_conversational === null` (inheriting global ON). For a more accurate approach, add a computed field or rely on the `agent_conversational` column.
   - Best pragmatic approach: Filter conversations where `conversation.agent_conversational !== false`. This shows conversations where the agent is or was active (true or inheriting global).

   ```typescript
   const filteredConversations = conversations.filter(conv => {
     if (agentFilter === 'agent-attended') {
       return conv.agent_conversational !== false
     }
     return true
   })
   ```

   Apply this filter AFTER existing search/filter logic but BEFORE rendering.

5. Place the Bot filter button near the existing search bar or filter controls, visually grouped with them.
  </action>
  <verify>TypeScript compiles. Conversation list renders filter button with Bot icon. Clicking the button filters conversations to show only agent-attended ones. Clicking again returns to showing all conversations.</verify>
  <done>Manager can filter conversation list to see only conversations attended by the agent via a Bot icon toggle button.</done>
</task>

</tasks>

<verification>
- [ ] Bot badge appears on outbound messages where sent_by_agent is true
- [ ] Bot overlay on conversation avatar when agent_conversational is explicitly true
- [ ] Two toggles in chat header (conversational + CRM) with proper styling
- [ ] Toggles call server actions and handle errors with toast
- [ ] "Bot escribiendo..." appears during agent processing via Realtime
- [ ] Typing indicator auto-clears after 30 seconds
- [ ] Agent filter toggle in conversation list shows only agent-attended conversations
- [ ] TypeScript compiles cleanly
</verification>

<success_criteria>
Inbox UX is complete when:
1. Agent messages have visible bot badge
2. Active-agent conversations show bot overlay on avatar
3. Per-chat toggles in header control agent activation
4. Typing indicator shows during agent processing
5. Agent filter in conversation list allows manager to view agent-attended conversations
6. All visual elements follow Apple/iPhone clean style
</success_criteria>

<output>
After completion, create `.planning/phases/16-whatsapp-agent-integration/16-03-SUMMARY.md`
</output>
