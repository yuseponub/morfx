---
phase: 15.8
plan: 03
subsystem: somnio-constants
tags: [bugfix, refactor, constants, timer-leak, hasPartialData, early-expiration]
dependency-graph:
  requires: [15.8-01, 15.8-02]
  provides: [medium-bugs-fixed, constants-consolidated]
  affects: [15.8-04]
tech-stack:
  added: []
  patterns: [single-source-of-truth-constants, zero-import-constants-file]
key-files:
  created:
    - src/lib/agents/somnio/constants.ts
  modified:
    - src/lib/sandbox/ingest-timer.ts
    - src/lib/agents/somnio/somnio-engine.ts
    - src/lib/agents/somnio/data-extractor.ts
    - src/lib/agents/somnio/transition-validator.ts
    - src/lib/agents/somnio/index.ts
decisions:
  - id: "15.8-03-D1"
    decision: "Document early expiration with comment instead of adding reason field to TimerAction type"
    reason: "TimerAction has no reason field; adding one would require updating all consumers. Comment documents the scenario clearly."
  - id: "15.8-03-D2"
    decision: "constants.ts has ZERO imports from project files"
    reason: "Prevents circular dependencies since constants is imported by multiple modules across different directories"
  - id: "15.8-03-D3"
    decision: "Re-export CRITICAL_FIELDS from constants via barrel index.ts instead of data-extractor"
    reason: "Single source of truth; data-extractor imports from constants, barrel exports from constants"
metrics:
  duration: "~10 minutes"
  completed: "2026-02-09"
---

# Phase 15.8 Plan 03: Medium Bugs + Constants Consolidation Summary

**One-liner:** Fixed 3 medium bugs (timer contextProvider leak, hasPartialData based on actual fields, early expiration documented) and created constants.ts as single source of truth for CRITICAL_FIELDS, TIMER_MINIMUM_FIELDS, and field count thresholds.

## What Was Done

### Task 1: Fix Medium Bugs #14, #15, #16

**Commit:** `b52f23f`

| Bug | File | Fix |
|-----|------|-----|
| #14 | ingest-timer.ts | `this.contextProvider = null` added to `destroy()` to prevent stale callback retention |
| #15 | somnio-engine.ts | Both `emitIngestStarted` calls now use `Object.keys(ingestResult.extractedData?.normalized ?? {}).length > 0` instead of string flag or hardcoded `true` |
| #16 | ingest-timer.ts | `reevaluateLevel` early expiration path documented with EARLY EXPIRATION block comment explaining when and why it fires (duration_exceeded) |

### Task 2: Create constants.ts and Consolidate Field Definitions

**Commit:** `3705066`

| File | Change |
|------|--------|
| constants.ts (NEW) | Created with `CRITICAL_FIELDS`, `TIMER_MINIMUM_FIELDS`, `MIN_FIELDS_FOR_AUTO_PROMO`, `CRITICAL_FIELDS_COUNT` - zero project imports |
| data-extractor.ts | Removed local `CRITICAL_FIELDS` definition, added `import { CRITICAL_FIELDS } from './constants'` |
| transition-validator.ts | Removed local `CRITICAL_FIELDS` and `MIN_FIELDS_FOR_AUTO_PROMO` definitions, added import from constants. Removed dead code `CRITICAL_FIELDS_FOR_TIMER_PROMO` |
| ingest-timer.ts | Removed local `TIMER_MINIMUM_FIELDS` definition, added `import { TIMER_MINIMUM_FIELDS } from '@/lib/agents/somnio/constants'` |
| index.ts (barrel) | Updated: `CRITICAL_FIELDS` now exported from `./constants` instead of `./data-extractor`. Added exports for `TIMER_MINIMUM_FIELDS`, `MIN_FIELDS_FOR_AUTO_PROMO`, `CRITICAL_FIELDS_COUNT`. Removed redundant `TRANSITION_CRITICAL_FIELDS` alias. |

## Deviations from Plan

### Auto-fixed Issues

**1. [Rule 2 - Missing Critical] Barrel file index.ts needed updating**
- **Found during:** Task 2
- **Issue:** The barrel file `index.ts` re-exported `CRITICAL_FIELDS` from `data-extractor` and `CRITICAL_FIELDS as TRANSITION_CRITICAL_FIELDS` from `transition-validator`. After removing local definitions, barrel needed to export from `constants.ts` instead.
- **Fix:** Updated barrel to export `CRITICAL_FIELDS`, `TIMER_MINIMUM_FIELDS`, `MIN_FIELDS_FOR_AUTO_PROMO`, `CRITICAL_FIELDS_COUNT` from `./constants`. Removed `TRANSITION_CRITICAL_FIELDS` alias (unused by any consumer).
- **Files modified:** `src/lib/agents/somnio/index.ts`
- **Commit:** `3705066`

**2. [Rule 1 - Bug] Dead code removal: CRITICAL_FIELDS_FOR_TIMER_PROMO**
- **Found during:** Task 2
- **Issue:** `transition-validator.ts` defined `CRITICAL_FIELDS_FOR_TIMER_PROMO = 5` but it was never referenced anywhere in the codebase.
- **Fix:** Removed the dead constant. Added comment noting `CRITICAL_FIELDS_COUNT` is available from constants if needed.
- **Files modified:** `src/lib/agents/somnio/transition-validator.ts`
- **Commit:** `3705066`

## Decisions Made

| ID | Decision | Rationale |
|----|----------|-----------|
| 15.8-03-D1 | Document early expiration with comment, not type field | TimerAction type has no reason field; adding one requires updating all consumers |
| 15.8-03-D2 | constants.ts has ZERO project imports | Prevents circular deps since it's imported across directory boundaries |
| 15.8-03-D3 | Barrel re-exports from constants.ts | Single source of truth; eliminates duplicate alias pattern |

## Commits

| Task | Commit | Description |
|------|--------|-------------|
| 1 | b52f23f | Medium bugs #14, #15, #16 |
| 2 | 3705066 | Consolidate CRITICAL_FIELDS and TIMER_MINIMUM_FIELDS into constants.ts |

## Verification

- TypeScript compiles with zero source errors (`npx tsc --noEmit` - 3 checks passed)
- `CRITICAL_FIELDS` exported only from `constants.ts` (zero duplicates)
- `TIMER_MINIMUM_FIELDS` exported only from `constants.ts` (zero duplicates)
- All 3 consumer files import from `constants.ts` (verified via grep)
- `constants.ts` has zero imports from project files (no circular dependency risk)
- `TIMER_ALL_FIELDS` in ingest-timer.ts still spreads imported `TIMER_MINIMUM_FIELDS` correctly

## Next Phase Readiness

Plan 15.8-04 (code quality improvements) can proceed. The `constants.ts` file created here provides the foundation for further consolidation if needed in Plan 04.

**No blockers for next plan.**
