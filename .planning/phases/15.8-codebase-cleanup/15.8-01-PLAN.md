---
phase: 15.8-codebase-cleanup
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/app/(dashboard)/sandbox/components/sandbox-layout.tsx
  - src/lib/sandbox/sandbox-engine.ts
  - src/lib/sandbox/ingest-timer.ts
  - src/lib/agents/somnio/message-sequencer.ts
autonomous: true

must_haves:
  truths:
    - "Stale closure bugs #1-3 fixed: handleSendMessage reads current messages, debugTurns, and crmAgents via refs, not stale closures"
    - "State mutation bug #4 fixed: checkImplicitYes and handleIngestMode return new state objects instead of mutating the input parameter"
    - "Bug #5 verified: contextProvider in ingest-timer.ts correctly reads from stateRef.current (already fixed or needs fix)"
    - "Race condition bug #6 mitigated: message-sequencer interruption check is more robust against stale session data"
    - "TypeScript compiles with zero source errors after all changes"
  artifacts:
    - path: "src/app/(dashboard)/sandbox/components/sandbox-layout.tsx"
      provides: "Stale closure fixes with useRef pattern for messages, debugTurns, crmAgents"
      contains: "messagesRef|debugTurnsRef|crmAgentsRef"
    - path: "src/lib/sandbox/sandbox-engine.ts"
      provides: "Immutable state handling in checkImplicitYes and handleIngestMode"
      contains: "spread operator for state return"
    - path: "src/lib/sandbox/ingest-timer.ts"
      provides: "Verified contextProvider reads from current state"
    - path: "src/lib/agents/somnio/message-sequencer.ts"
      provides: "More robust interruption detection"
  key_links:
    - from: "sandbox-layout.tsx handleSendMessage"
      to: "messagesRef.current"
      via: "useRef + useEffect sync"
      pattern: "messagesRef\\.current"
    - from: "sandbox-engine.ts checkImplicitYes"
      to: "processMessage caller"
      via: "return new state object instead of mutation"
      pattern: "return.*\\{.*\\.\\.\\.currentState"
---

<objective>
Fix all 6 critical severity bugs identified in the codebase audit: 3 stale closure bugs in sandbox-layout.tsx, 1 state mutation bug in sandbox-engine.ts, 1 stale closure verification in ingest-timer.ts, and 1 race condition in message-sequencer.ts.

Purpose: Eliminate the most dangerous runtime bugs (crashes, data corruption, unpredictable behavior) before any further feature development.
Output: 4 files patched with atomic fixes, each verified by `tsc --noEmit`.
</objective>

<execution_context>
@/home/jose147/.claude/get-shit-done/workflows/execute-plan.md
@/home/jose147/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/codebase/audit/BUGS.md
@.planning/phases/15.8-codebase-cleanup/15.8-RESEARCH.md

Key source files:
@src/app/(dashboard)/sandbox/components/sandbox-layout.tsx
@src/lib/sandbox/sandbox-engine.ts
@src/lib/sandbox/ingest-timer.ts
@src/lib/agents/somnio/message-sequencer.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix stale closures in sandbox-layout.tsx (Bugs #1, #2, #3)</name>
  <files>src/app/(dashboard)/sandbox/components/sandbox-layout.tsx</files>
  <action>
Fix 3 stale closure bugs in `handleSendMessage` callback. All 3 follow the same pattern already established in this file for `timerEnabledRef`, `stateRef`, `simulatorRef`.

**Bug #1 (messages stale closure, ~line 385):**
1. Add ref: `const messagesRef = useRef(messages)` near the other ref declarations
2. Add sync effect: `useEffect(() => { messagesRef.current = messages }, [messages])`
3. In `handleSendMessage`, replace the direct `messages` reference used to build `history` with `messagesRef.current`. Find the line like: `const history = messages.map(m => ({ role: m.role, content: m.content }))` and change to `messagesRef.current.map(...)`.

**Bug #2 (debugTurns stale closure, ~line 395):**
1. Add ref: `const debugTurnsRef = useRef(debugTurns)` near the other ref declarations
2. Add sync effect: `useEffect(() => { debugTurnsRef.current = debugTurns }, [debugTurns])`
3. In `handleSendMessage`, replace `debugTurns.length + 1` with `debugTurnsRef.current.length + 1` for turn number calculation.

**Bug #3 (crmAgents stale closure, ~line 389):**
1. Add ref: `const crmAgentsRef = useRef(crmAgents)` near the other ref declarations
2. Add sync effect: `useEffect(() => { crmAgentsRef.current = crmAgents }, [crmAgents])`
3. In `handleSendMessage`, replace the direct `crmAgents` reference used to filter enabled agents with `crmAgentsRef.current`.

**IMPORTANT:** Do NOT remove the original state variables (`messages`, `debugTurns`, `crmAgents`) - they are still needed for rendering. Only add refs and use refs inside the async `handleSendMessage` callback where stale closures occur.

**Pattern reference (already in the file):**
```typescript
const timerEnabledRef = useRef(timerEnabled)
useEffect(() => { timerEnabledRef.current = timerEnabled }, [timerEnabled])
```

After making changes, run `npx tsc --noEmit` to verify TypeScript compiles clean.
Commit: `fix(15.8-01): stale closures in handleSendMessage (#1, #2, #3)`
  </action>
  <verify>
1. `npx tsc --noEmit` passes with zero source errors
2. Grep confirms refs exist: `grep -n "messagesRef\|debugTurnsRef\|crmAgentsRef" src/app/(dashboard)/sandbox/components/sandbox-layout.tsx`
3. Grep confirms refs used in handleSendMessage: `grep -n "messagesRef.current\|debugTurnsRef.current\|crmAgentsRef.current" src/app/(dashboard)/sandbox/components/sandbox-layout.tsx`
  </verify>
  <done>
- messagesRef, debugTurnsRef, crmAgentsRef declared with useRef
- Each has a useEffect that syncs ref.current on state change
- handleSendMessage uses ref.current for history building, turn number, and CRM agent filtering
- TypeScript compiles clean
  </done>
</task>

<task type="auto">
  <name>Task 2: Fix state mutation + verify timer signal + verify stale closure + fix race condition (Bugs #4, #5, #6, #8)</name>
  <files>
    src/lib/sandbox/sandbox-engine.ts
    src/lib/sandbox/ingest-timer.ts
    src/lib/agents/somnio/message-sequencer.ts
  </files>
  <action>
Fix/verify 4 bugs across 3 files. Each fix is independent.

**Bug #4 (state mutation in sandbox-engine.ts):**

Read `sandbox-engine.ts` carefully. The `checkImplicitYes` and `handleIngestMode` methods mutate `currentState` directly as a communication channel to the caller (`processMessage`). The research warns this is nuanced.

The fix approach:
1. In `checkImplicitYes`: Instead of mutating `currentState.currentMode = 'ofrecer_promos'`, return an object with `{ newState: { ...currentState, currentMode: 'ofrecer_promos', datosCapturados: mergedData }, ... }`. The caller must destructure and use the returned state.
2. In `handleIngestMode`: Same pattern - return `{ newState: {...}, ... }` instead of mutating.
3. Update `processMessage` to use the returned state from these methods instead of relying on mutation of the passed-in parameter.

**CAUTION:** The `justCompletedIngest` check in `processMessage` (~line 311-316) relies on detecting mode changes. After this refactor, the mode change detection must use the returned new state, not check the mutated parameter. Read the code carefully and trace all paths where `currentState.currentMode` is checked after calling these methods.

If the refactor is too risky (touches too many code paths and could break timer/ingest flow), use a SAFER alternative:
- Keep the mutation BUT document it with a clear comment explaining it's intentional
- Add a `// WARNING: Intentional mutation - communicates state change to processMessage caller` comment
- Add a `Object.freeze` in development mode to catch unintended mutations elsewhere

**Bug #5 (ingest-timer.ts stale closure - VERIFY):**

Read `ingest-timer.ts` lines 418-428 (the `buildAction` callback) and trace where `contextProvider` is set.

In `sandbox-layout.tsx`, find where `simulator.setContextProvider(...)` is called (~line 292). Verify that the provider function reads from `stateRef.current` (not direct `state` variable).

If already fixed: Add a comment confirming it's correct and commit as verified.
If NOT fixed: The provider must read from `stateRef.current` to get latest state when timer fires.

**Bug #8 (timer signal override in sandbox-engine.ts - VERIFY):**

Research says this may be intentional: when ingest completes, cancel signal is set, then line 316 overrides with start for Level 3 (promos sin respuesta). This IS correct behavior - the ingest timer should be canceled and the promo timer should start.

Read the code at lines 311-316 and 531-537. If the behavior is:
1. `handleIngestMode` returns with `timerSignal = cancel` (cancel ingest timer)
2. `processMessage` detects `justCompletedIngest && newMode === 'ofrecer_promos'`
3. Sets `timerSignal = { type: 'start' }` (start promo timer)

Then this is CORRECT. Add a clarifying comment explaining the two-step signal: cancel ingest -> start promos. Do NOT change the logic.

If the behavior is actually a bug (both signals refer to the same timer level), then fix by ensuring the cancel applies to the ingest level and the start applies to the promo level.

**Bug #6 (race condition in message-sequencer.ts):**

Read `message-sequencer.ts` line 194 and line 366 where `checkForInterruption` compares `last_activity_at` with current time.

The issue: session may be cached, so `last_activity_at` could be stale.

Fix approach (safe, minimal):
1. In the sandbox context, this is a non-issue (no real DB, no caching). The race condition only matters in production with real SessionManager.
2. For now, add a comment documenting the known limitation.
3. If there's a `forceRefresh` or cache-bypass option on the session fetch, use it for the interruption check. If not, document as known limitation for Phase 16.

After ALL changes, run `npx tsc --noEmit` to verify TypeScript compiles clean.
Commit each fix atomically or as a group if they're in the same file.
  </action>
  <verify>
1. `npx tsc --noEmit` passes with zero source errors
2. For Bug #4: Verify state mutation is either refactored to return new objects OR documented as intentional
3. For Bug #5: Verify contextProvider reads from stateRef.current
4. For Bug #8: Verify timer signal override has clarifying comment
5. For Bug #6: Verify interruption check has documentation about cache staleness
  </verify>
  <done>
- Bug #4: State mutation either refactored to immutable returns OR explicitly documented as intentional pattern with safety comments
- Bug #5: contextProvider confirmed reading from stateRef.current (verified or fixed)
- Bug #8: Timer signal override confirmed as intentional with clarifying comment added
- Bug #6: Race condition documented with cache staleness caveat; improved if possible
- TypeScript compiles clean after all changes
  </done>
</task>

</tasks>

<verification>
After both tasks complete:
1. `npx tsc --noEmit` passes with zero source errors (GATE)
2. All 4 modified files have the expected changes
3. No unintended regressions in surrounding code
4. Each bug has either a code fix or a documented justification for current behavior
</verification>

<success_criteria>
1. Bugs #1, #2, #3 fixed with useRef pattern in sandbox-layout.tsx
2. Bug #4 addressed (refactored or documented) in sandbox-engine.ts
3. Bug #5 verified in ingest-timer.ts
4. Bug #6 documented/improved in message-sequencer.ts
5. Bug #8 verified as intentional in sandbox-engine.ts
6. TypeScript compiles with zero source errors
7. Each fix committed atomically with descriptive message
</success_criteria>

<output>
After completion, create `.planning/phases/15.8-codebase-cleanup/15.8-01-SUMMARY.md`
</output>
