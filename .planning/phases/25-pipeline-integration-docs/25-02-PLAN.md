---
phase: 25-pipeline-integration-docs
plan: 02
type: execute
wave: 2
depends_on: ["25-01"]
files_modified:
  - docs/architecture/05-robot-service-pattern.md
autonomous: false

must_haves:
  truths:
    - "A developer (Claude or human) reading the docs can understand the robot service pattern without reading source code"
    - "The doc describes the full communication flow: MorfX -> Inngest -> Robot -> Callback -> Domain -> Automation"
    - "A step-by-step guide exists for adding a new carrier (Inter, Envia, etc.)"
    - "Key files are listed with their purpose so a developer knows where to start"
    - "Anti-duplicate protection layers are documented"
  artifacts:
    - path: "docs/architecture/05-robot-service-pattern.md"
      provides: "Complete robot architecture documentation"
      min_lines: 150
      contains: "Adding a New Carrier"
  key_links:
    - from: "docs/architecture/05-robot-service-pattern.md"
      to: "robot-coordinadora/"
      via: "file references"
      pattern: "robot-coordinadora"
    - from: "docs/architecture/05-robot-service-pattern.md"
      to: "src/inngest/functions/robot-orchestrator.ts"
      via: "file references"
      pattern: "robot-orchestrator"
---

<objective>
Write comprehensive architecture documentation for the robot service pattern and verify the full E2E logistics flow.

Purpose: Future carriers (Inter, Envia, Bogota) will be built by Claude or human devs. They need clear documentation of the pattern established by Coordinadora. Also, the full flow from config to CRM updates must be verified end-to-end before closing v3.0 logistics milestone.
Output: Architecture doc at docs/architecture/05-robot-service-pattern.md and E2E verification confirmation.
</objective>

<execution_context>
@/home/jose147/.claude/get-shit-done/workflows/execute-plan.md
@/home/jose147/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/25-pipeline-integration-docs/25-CONTEXT.md
@.planning/phases/25-pipeline-integration-docs/25-RESEARCH.md

Key source files to document (READ these for accurate documentation):
@robot-coordinadora/src/index.ts
@robot-coordinadora/src/api/server.ts
@robot-coordinadora/src/adapters/coordinadora-adapter.ts
@robot-coordinadora/src/middleware/locks.ts
@robot-coordinadora/src/types/index.ts
@src/inngest/functions/robot-orchestrator.ts
@src/app/api/webhooks/robot-callback/route.ts
@src/lib/domain/robot-jobs.ts
@src/lib/domain/carrier-configs.ts
@src/lib/domain/carrier-coverage.ts
@src/lib/logistics/constants.ts
@src/app/actions/comandos.ts
@src/app/(dashboard)/comandos/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Write robot architecture documentation</name>
  <files>
    docs/architecture/05-robot-service-pattern.md
  </files>
  <action>
    Create comprehensive architecture documentation covering the robot service pattern. The audience is future development (Claude + human devs building new carrier integrations).

    **Document structure (follow the plan from 25-RESEARCH.md section "Robot Architecture Documentation Plan"):**

    **1. Overview**
    - What is a "robot" in MorfX context: standalone service that automates actions on external carrier portals
    - Why standalone (Playwright cannot run on Vercel serverless)
    - Current robots: Coordinadora (active), future: Inter, Envia, Servientrega

    **2. Robot Service Pattern**
    - Standalone Express + Playwright service deployed on Railway (Docker)
    - One adapter per carrier (CoordinadoraAdapter automates ff.coordinadora.com)
    - Batch processing: receives N orders, processes sequentially, reports per-order results
    - Session management: persistent browser cookies, re-auth on session expiry
    - Reference implementation: `robot-coordinadora/`

    **3. Communication Flow**
    - ASCII diagram from RESEARCH.md (the MorfX <-> Robot flow)
    - Step by step:
      1. User runs command in Chat de Comandos (e.g., "subir ordenes coord")
      2. Server action (`comandos.ts`) validates orders, creates robot_job + items via domain
      3. Inngest event `robot/job.submitted` dispatched
      4. Robot orchestrator Inngest function picks up event
      5. HTTP POST to robot service with credentials + orders + callbackUrl + callbackSecret
      6. Robot processes orders sequentially with Playwright
      7. Per-order HTTP callback to MorfX (`/api/webhooks/robot-callback`)
      8. Callback handler validates HMAC, calls domain `updateJobItemResult`
      9. Domain updates robot_job_item, checks job completion, emits `robot.coord.completed` trigger
      10. Automation triggers fire on robot.coord.completed (if configured)
      11. When all items reported: domain marks job as completed, sends `robot/job.batch_completed` event
      12. Orchestrator's `waitForEvent` resolves, function completes

    **4. Key Files Reference**
    - Table with all 13 key files from RESEARCH.md, organized by subsystem:
      - Robot Service (robot-coordinadora/)
      - MorfX Orchestration (src/inngest/)
      - MorfX Callback (src/app/api/webhooks/)
      - Domain Layer (src/lib/domain/)
      - Chat UI (src/app/actions/, src/app/(dashboard)/comandos/)
      - Config UI (src/app/(dashboard)/settings/logistica/)

    **5. Data Model**
    - carrier_configs: one row per carrier per workspace (credentials + dispatch config)
    - robot_jobs: batch job tracking (workspace, carrier, status, counts)
    - robot_job_items: per-order tracking (order_id, status, tracking_number, error)
    - Supabase Realtime on robot_job_items for live progress in Chat UI

    **6. Anti-Duplicate Protection**
    - 5 layers from RESEARCH.md:
      1. Workspace lock (robot middleware)
      2. Per-order lock (skip already processing)
      3. Batch idempotency cache (reject re-submissions)
      4. Inngest retries: 0 (fail-fast)
      5. Domain idempotency guard (skip terminal items)

    **7. Adding a New Carrier (Step-by-Step)**
    - 10-step guide from RESEARCH.md with expanded explanations
    - For each step: what to do, where the files go, and what to reference

    **8. Pipeline Config**
    - How dispatch stage binding works (carrier_configs.dispatch_pipeline_id + dispatch_stage_id)
    - Settings UI at /settings/logistica (from Plan 01)
    - The "subir ordenes" command reads config to find which orders to dispatch

    **IMPORTANT:**
    - Read ALL source files listed in context before writing (accuracy over speed)
    - Use Spanish for section headers that match UI concepts, English for technical terms
    - Include code snippets where they clarify patterns (e.g., domain function signatures, event types)
    - Do NOT copy entire files -- show key interfaces and function signatures
    - Target: 200-350 lines (comprehensive but not bloated)
  </action>
  <verify>
    - File exists at `docs/architecture/05-robot-service-pattern.md`
    - Contains sections: Overview, Robot Service Pattern, Communication Flow, Key Files, Data Model, Anti-Duplicate Protection, Adding a New Carrier, Pipeline Config
    - All 13 key files referenced with correct paths
    - 10-step "Adding a New Carrier" guide is present and complete
    - No broken file references (paths match actual codebase)
  </verify>
  <done>
    A developer reading 05-robot-service-pattern.md can understand: how the robot pattern works, how MorfX communicates with robots, where all the relevant code lives, and exactly what steps to follow when adding a new carrier (Inter, Envia, etc.).
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
    Complete logistics subsystem for v3.0:
    - Plan 01: Settings UI at /settings/logistica (pipeline/stage config for Coordinadora)
    - Plan 02: Robot architecture documentation
    - Full E2E flow: config -> command -> robot -> callbacks -> CRM updates (from phases 21-25)
  </what-built>
  <how-to-verify>
    **Settings UI Verification:**
    1. Go to /settings -- verify "Logistica" card appears (owner only)
    2. Click into /settings/logistica
    3. Select a pipeline from dropdown
    4. Verify stages dropdown populates with stages from that pipeline only
    5. Select a stage, toggle enabled on
    6. Click "Guardar" -- verify toast confirmation
    7. Refresh page -- verify saved values persist
    8. Verify future carriers (Inter, Envia, Servientrega) appear as disabled placeholders

    **Documentation Verification:**
    9. Open docs/architecture/05-robot-service-pattern.md
    10. Skim the "Adding a New Carrier" section -- does it make sense?

    **E2E Flow Verification (if robot-coordinadora is deployed on Railway):**
    11. In /settings/logistica, configure Coordinadora with the stage that has orders to dispatch
    12. Go to /comandos, type "subir ordenes coord"
    13. Verify orders are sent to robot, progress updates appear in real-time
    14. Verify completed orders show tracking numbers in CRM
    15. If robot is NOT deployed: confirm steps 1-10 only, E2E deferred to deployment

    Note: If the robot service is not deployed on Railway yet, E2E verification of steps 11-15 can be deferred. The config UI and documentation are verifiable independently.
  </how-to-verify>
  <resume-signal>Type "approved" to close Phase 25, or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
1. docs/architecture/05-robot-service-pattern.md exists with 150+ lines
2. Documentation covers all 8 sections outlined in the task
3. "Adding a New Carrier" has 10 clearly numbered steps
4. All file paths in documentation match actual codebase
5. User confirms settings UI works correctly
6. User confirms documentation is comprehensive
</verification>

<success_criteria>
- Architecture doc exists and is comprehensive (robot pattern, communication flow, carrier guide)
- User has verified the settings UI (from Plan 01) works end-to-end
- User has reviewed the documentation quality
- v3.0 logistics milestone closable after this verification
</success_criteria>

<output>
After completion, create `.planning/phases/25-pipeline-integration-docs/25-02-SUMMARY.md`
</output>
