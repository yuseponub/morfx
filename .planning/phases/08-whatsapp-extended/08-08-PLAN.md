---
phase: 08-whatsapp-extended
plan: 08
type: execute
wave: 2
depends_on: ["08-01", "08-02"]
files_modified:
  - src/lib/whatsapp/webhook-handler.ts
  - src/app/(dashboard)/configuracion/whatsapp/costos/page.tsx
  - src/app/(dashboard)/configuracion/whatsapp/costos/components/usage-summary.tsx
  - src/app/(dashboard)/configuracion/whatsapp/costos/components/usage-chart.tsx
  - src/app/(dashboard)/configuracion/whatsapp/costos/components/category-breakdown.tsx
autonomous: true

must_haves:
  truths:
    - "Message costs are recorded from webhook pricing data"
    - "User can view usage summary by date range"
    - "Dashboard shows total messages and costs"
    - "Costs are broken down by category"
    - "Chart shows daily usage trend"
  artifacts:
    - path: "src/app/(dashboard)/configuracion/whatsapp/costos/page.tsx"
      provides: "Usage dashboard page"
      min_lines: 40
    - path: "src/app/(dashboard)/configuracion/whatsapp/costos/components/usage-chart.tsx"
      provides: "Daily usage trend chart"
      min_lines: 30
  key_links:
    - from: "src/lib/whatsapp/webhook-handler.ts"
      to: "src/app/actions/usage.ts"
      via: "recordMessageCost on status webhook"
      pattern: "recordMessageCost"
    - from: "usage-summary.tsx"
      to: "src/app/actions/usage.ts"
      via: "getUsageSummary action"
      pattern: "getUsageSummary"
---

<objective>
Build usage tracking from webhooks and the cost dashboard for workspace admins.

Purpose: Enable tracking message costs for billing pass-through and usage visibility.
Output: Webhook cost recording and usage dashboard with charts.
</objective>

<execution_context>
@/home/jose147/.claude/get-shit-done/workflows/execute-plan.md
@/home/jose147/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/08-whatsapp-extended/08-CONTEXT.md
@.planning/phases/08-whatsapp-extended/08-RESEARCH.md
@src/lib/whatsapp/webhook-handler.ts
@src/app/actions/usage.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Integrate Cost Recording in Webhook Handler</name>
  <files>src/lib/whatsapp/webhook-handler.ts</files>
  <action>
**Update src/lib/whatsapp/webhook-handler.ts** to record costs from status webhooks:

Add the following to the status update handler:

```typescript
// Add import at top
import { recordMessageCost } from '@/app/actions/usage'

// In the processStatusUpdate function, after existing status update logic:

interface StatusWebhook {
  id: string  // wamid
  status: 'sent' | 'delivered' | 'read' | 'failed'
  pricing?: {
    billable: boolean
    pricing_model: 'CBP' | 'PMP'
    category: 'marketing' | 'utility' | 'authentication' | 'service'
  }
  recipient_id?: string  // Phone number
  errors?: { code: number; title: string }[]
}

async function processStatusUpdate(
  workspaceId: string,
  status: StatusWebhook
): Promise<void> {
  // ... existing status update code ...

  // Record cost if billable (only on 'sent' status to avoid duplicates)
  if (status.pricing?.billable && status.status === 'sent') {
    // Extract country code from phone (e.g., +57 for Colombia)
    const countryCode = status.recipient_id?.match(/^\+(\d{1,3})/)?.[1]
    const countryMap: Record<string, string> = {
      '57': 'CO', '1': 'US', '52': 'MX', '54': 'AR', '55': 'BR', '56': 'CL', '51': 'PE'
    }
    const country = countryMap[countryCode || ''] || null

    await recordMessageCost({
      workspaceId,
      wamid: status.id,
      category: status.pricing.category,
      recipientCountry: country
    })
  }
}
```

The pricing field structure from 360dialog webhooks:
- `billable`: Whether this message incurs a cost
- `pricing_model`: 'PMP' for per-message pricing
- `category`: The message category determining cost tier

Only record on 'sent' status to avoid duplicates when delivered/read statuses also have pricing data.
  </action>
  <verify>Run `pnpm tsc --noEmit` to verify TypeScript compiles. Check webhook handler imports recordMessageCost correctly.</verify>
  <done>Webhook handler updated to call recordMessageCost on billable sent status. Extracts country code from phone number for rate lookup.</done>
</task>

<task type="auto">
  <name>Task 2: Usage Dashboard Page and Summary</name>
  <files>
    src/app/(dashboard)/configuracion/whatsapp/costos/page.tsx
    src/app/(dashboard)/configuracion/whatsapp/costos/components/usage-summary.tsx
    src/app/(dashboard)/configuracion/whatsapp/costos/components/period-selector.tsx
  </files>
  <action>
**Create src/app/(dashboard)/configuracion/whatsapp/costos/components/period-selector.tsx:**

```typescript
'use client'

import { Button } from '@/components/ui/button'
import { cn } from '@/lib/utils'

type Period = 'today' | '7days' | '30days' | 'month'

interface PeriodSelectorProps {
  value: Period
  onChange: (period: Period) => void
}

const periods: { value: Period; label: string }[] = [
  { value: 'today', label: 'Hoy' },
  { value: '7days', label: '7 dias' },
  { value: '30days', label: '30 dias' },
  { value: 'month', label: 'Este mes' }
]

export function PeriodSelector({ value, onChange }: PeriodSelectorProps) {
  return (
    <div className="flex gap-1 p-1 bg-muted rounded-lg">
      {periods.map((period) => (
        <Button
          key={period.value}
          variant="ghost"
          size="sm"
          onClick={() => onChange(period.value)}
          className={cn(
            'rounded-md',
            value === period.value && 'bg-background shadow-sm'
          )}
        >
          {period.label}
        </Button>
      ))}
    </div>
  )
}
```

**Create src/app/(dashboard)/configuracion/whatsapp/costos/components/usage-summary.tsx:**

```typescript
'use client'

import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card'
import { MessageSquare, DollarSign, TrendingUp, AlertCircle } from 'lucide-react'

interface UsageSummaryProps {
  totalMessages: number
  totalCost: number
  byCategory: Record<string, { count: number; cost: number }>
  limit: number | null
  percentUsed: number | null
}

export function UsageSummary({
  totalMessages,
  totalCost,
  limit,
  percentUsed
}: UsageSummaryProps) {
  const formatCurrency = (value: number) =>
    value.toLocaleString('en-US', { style: 'currency', currency: 'USD', minimumFractionDigits: 2 })

  return (
    <div className="grid gap-4 md:grid-cols-3">
      <Card>
        <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
          <CardTitle className="text-sm font-medium">
            Total Mensajes
          </CardTitle>
          <MessageSquare className="h-4 w-4 text-muted-foreground" />
        </CardHeader>
        <CardContent>
          <div className="text-2xl font-bold">{totalMessages.toLocaleString()}</div>
          <p className="text-xs text-muted-foreground">
            Mensajes enviados en el periodo
          </p>
        </CardContent>
      </Card>

      <Card>
        <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
          <CardTitle className="text-sm font-medium">
            Costo Total
          </CardTitle>
          <DollarSign className="h-4 w-4 text-muted-foreground" />
        </CardHeader>
        <CardContent>
          <div className="text-2xl font-bold">{formatCurrency(totalCost)}</div>
          <p className="text-xs text-muted-foreground">
            Costo estimado en USD
          </p>
        </CardContent>
      </Card>

      <Card>
        <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
          <CardTitle className="text-sm font-medium">
            Limite Mensual
          </CardTitle>
          {percentUsed !== null && percentUsed >= 80 ? (
            <AlertCircle className="h-4 w-4 text-orange-500" />
          ) : (
            <TrendingUp className="h-4 w-4 text-muted-foreground" />
          )}
        </CardHeader>
        <CardContent>
          {limit ? (
            <>
              <div className="text-2xl font-bold">{percentUsed?.toFixed(0)}%</div>
              <div className="mt-2 h-2 bg-muted rounded-full overflow-hidden">
                <div
                  className={cn(
                    'h-full transition-all',
                    percentUsed && percentUsed >= 100 ? 'bg-red-500' :
                    percentUsed && percentUsed >= 80 ? 'bg-orange-500' : 'bg-primary'
                  )}
                  style={{ width: `${Math.min(percentUsed || 0, 100)}%` }}
                />
              </div>
              <p className="text-xs text-muted-foreground mt-1">
                {formatCurrency(totalCost)} de {formatCurrency(limit)}
              </p>
            </>
          ) : (
            <>
              <div className="text-2xl font-bold">Sin limite</div>
              <p className="text-xs text-muted-foreground">
                Contacta soporte para configurar
              </p>
            </>
          )}
        </CardContent>
      </Card>
    </div>
  )
}

function cn(...classes: (string | boolean | undefined)[]) {
  return classes.filter(Boolean).join(' ')
}
```

**Create src/app/(dashboard)/configuracion/whatsapp/costos/page.tsx:**

```typescript
'use client'

import { useState, useEffect } from 'react'
import { UsageSummary } from './components/usage-summary'
import { UsageChart } from './components/usage-chart'
import { CategoryBreakdown } from './components/category-breakdown'
import { PeriodSelector } from './components/period-selector'
import { getUsageSummary, getUsageByDay, getSpendingStatus } from '@/app/actions/usage'
import { Loader2 } from 'lucide-react'

type Period = 'today' | '7days' | '30days' | 'month'

export default function CostosPage() {
  const [period, setPeriod] = useState<Period>('month')
  const [loading, setLoading] = useState(true)
  const [summary, setSummary] = useState<any>(null)
  const [dailyData, setDailyData] = useState<any[]>([])
  const [spending, setSpending] = useState<any>(null)

  useEffect(() => {
    loadData()
  }, [period])

  async function loadData() {
    setLoading(true)
    try {
      const [summaryData, dailyUsage, spendingStatus] = await Promise.all([
        getUsageSummary(period),
        getUsageByDay(period === 'today' ? 1 : period === '7days' ? 7 : 30),
        getSpendingStatus()
      ])
      setSummary(summaryData)
      setDailyData(dailyUsage)
      setSpending(spendingStatus)
    } catch (error) {
      console.error('Failed to load usage data:', error)
    } finally {
      setLoading(false)
    }
  }

  if (loading && !summary) {
    return (
      <div className="container py-6">
        <div className="flex items-center justify-center h-64">
          <Loader2 className="h-8 w-8 animate-spin text-muted-foreground" />
        </div>
      </div>
    )
  }

  return (
    <div className="container py-6">
      <div className="flex items-center justify-between mb-6">
        <div>
          <h1 className="text-2xl font-bold">Costos y Uso</h1>
          <p className="text-muted-foreground">
            Estadisticas de mensajes y costos de WhatsApp
          </p>
        </div>
        <PeriodSelector value={period} onChange={setPeriod} />
      </div>

      {summary && (
        <div className="space-y-6">
          <UsageSummary
            totalMessages={summary.totalMessages}
            totalCost={summary.totalCost}
            byCategory={summary.byCategory}
            limit={spending?.limit}
            percentUsed={spending?.percentUsed}
          />

          <div className="grid gap-6 md:grid-cols-2">
            <UsageChart data={dailyData} />
            <CategoryBreakdown data={summary.byCategory} />
          </div>
        </div>
      )}
    </div>
  )
}
```

Use 'use client' since the page has interactive period selection.
  </action>
  <verify>Run `pnpm tsc --noEmit` to verify components compile.</verify>
  <done>Usage dashboard created with period selector, summary cards showing total messages/costs/limit, and layout for charts.</done>
</task>

<task type="auto">
  <name>Task 3: Usage Charts and Category Breakdown</name>
  <files>
    src/app/(dashboard)/configuracion/whatsapp/costos/components/usage-chart.tsx
    src/app/(dashboard)/configuracion/whatsapp/costos/components/category-breakdown.tsx
  </files>
  <action>
**Create src/app/(dashboard)/configuracion/whatsapp/costos/components/usage-chart.tsx:**

```typescript
'use client'

import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card'
import {
  AreaChart,
  Area,
  XAxis,
  YAxis,
  CartesianGrid,
  Tooltip,
  ResponsiveContainer
} from 'recharts'

interface UsageChartProps {
  data: { date: string; count: number; cost: number }[]
}

export function UsageChart({ data }: UsageChartProps) {
  // Format date for display
  const formattedData = data.map(d => ({
    ...d,
    displayDate: new Date(d.date).toLocaleDateString('es-CO', {
      month: 'short',
      day: 'numeric'
    })
  }))

  return (
    <Card>
      <CardHeader>
        <CardTitle className="text-base">Mensajes por Dia</CardTitle>
      </CardHeader>
      <CardContent>
        <div className="h-[300px]">
          <ResponsiveContainer width="100%" height="100%">
            <AreaChart data={formattedData} margin={{ top: 10, right: 10, left: 0, bottom: 0 }}>
              <defs>
                <linearGradient id="colorCount" x1="0" y1="0" x2="0" y2="1">
                  <stop offset="5%" stopColor="hsl(var(--primary))" stopOpacity={0.3} />
                  <stop offset="95%" stopColor="hsl(var(--primary))" stopOpacity={0} />
                </linearGradient>
              </defs>
              <CartesianGrid strokeDasharray="3 3" className="stroke-muted" />
              <XAxis
                dataKey="displayDate"
                tick={{ fontSize: 12 }}
                tickLine={false}
                axisLine={false}
              />
              <YAxis
                tick={{ fontSize: 12 }}
                tickLine={false}
                axisLine={false}
                tickFormatter={(v) => v.toLocaleString()}
              />
              <Tooltip
                content={({ active, payload }) => {
                  if (active && payload && payload.length) {
                    const data = payload[0].payload
                    return (
                      <div className="bg-background border rounded-lg shadow-lg p-3">
                        <p className="text-sm font-medium">{data.displayDate}</p>
                        <p className="text-sm text-muted-foreground">
                          {data.count.toLocaleString()} mensajes
                        </p>
                        <p className="text-sm text-muted-foreground">
                          ${data.cost.toFixed(4)} USD
                        </p>
                      </div>
                    )
                  }
                  return null
                }}
              />
              <Area
                type="monotone"
                dataKey="count"
                stroke="hsl(var(--primary))"
                fillOpacity={1}
                fill="url(#colorCount)"
                strokeWidth={2}
              />
            </AreaChart>
          </ResponsiveContainer>
        </div>
      </CardContent>
    </Card>
  )
}
```

**Create src/app/(dashboard)/configuracion/whatsapp/costos/components/category-breakdown.tsx:**

```typescript
'use client'

import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card'
import { PieChart, Pie, Cell, ResponsiveContainer, Legend, Tooltip } from 'recharts'

interface CategoryBreakdownProps {
  data: Record<string, { count: number; cost: number }>
}

const CATEGORY_LABELS: Record<string, string> = {
  marketing: 'Marketing',
  utility: 'Utilidad',
  authentication: 'Autenticacion',
  service: 'Servicio'
}

const CATEGORY_COLORS: Record<string, string> = {
  marketing: 'hsl(var(--chart-1))',
  utility: 'hsl(var(--chart-2))',
  authentication: 'hsl(var(--chart-3))',
  service: 'hsl(var(--chart-4))'
}

export function CategoryBreakdown({ data }: CategoryBreakdownProps) {
  const chartData = Object.entries(data)
    .filter(([_, v]) => v.count > 0)
    .map(([category, values]) => ({
      name: CATEGORY_LABELS[category] || category,
      value: values.count,
      cost: values.cost,
      color: CATEGORY_COLORS[category] || 'hsl(var(--muted))'
    }))

  const totalCost = Object.values(data).reduce((sum, v) => sum + v.cost, 0)

  if (chartData.length === 0) {
    return (
      <Card>
        <CardHeader>
          <CardTitle className="text-base">Por Categoria</CardTitle>
        </CardHeader>
        <CardContent className="flex items-center justify-center h-[300px]">
          <p className="text-muted-foreground">Sin datos en este periodo</p>
        </CardContent>
      </Card>
    )
  }

  return (
    <Card>
      <CardHeader>
        <CardTitle className="text-base">Por Categoria</CardTitle>
      </CardHeader>
      <CardContent>
        <div className="h-[300px]">
          <ResponsiveContainer width="100%" height="100%">
            <PieChart>
              <Pie
                data={chartData}
                cx="50%"
                cy="50%"
                innerRadius={60}
                outerRadius={80}
                paddingAngle={2}
                dataKey="value"
              >
                {chartData.map((entry, index) => (
                  <Cell key={`cell-${index}`} fill={entry.color} />
                ))}
              </Pie>
              <Tooltip
                content={({ active, payload }) => {
                  if (active && payload && payload.length) {
                    const data = payload[0].payload
                    return (
                      <div className="bg-background border rounded-lg shadow-lg p-3">
                        <p className="text-sm font-medium">{data.name}</p>
                        <p className="text-sm text-muted-foreground">
                          {data.value.toLocaleString()} mensajes
                        </p>
                        <p className="text-sm text-muted-foreground">
                          ${data.cost.toFixed(4)} USD
                        </p>
                      </div>
                    )
                  }
                  return null
                }}
              />
              <Legend
                formatter={(value) => <span className="text-sm">{value}</span>}
              />
            </PieChart>
          </ResponsiveContainer>
        </div>

        <div className="mt-4 space-y-2">
          {chartData.map((item) => (
            <div key={item.name} className="flex items-center justify-between text-sm">
              <div className="flex items-center gap-2">
                <div
                  className="w-3 h-3 rounded-full"
                  style={{ backgroundColor: item.color }}
                />
                <span>{item.name}</span>
              </div>
              <span className="text-muted-foreground">
                ${item.cost.toFixed(4)}
              </span>
            </div>
          ))}
          <div className="flex items-center justify-between text-sm font-medium pt-2 border-t">
            <span>Total</span>
            <span>${totalCost.toFixed(4)}</span>
          </div>
        </div>
      </CardContent>
    </Card>
  )
}
```

Both charts use recharts library which should already be available via shadcn/ui chart components. If not installed, add `pnpm add recharts`.
  </action>
  <verify>Run `pnpm tsc --noEmit` to verify components compile. Check that recharts is available.</verify>
  <done>UsageChart shows daily message count as area chart. CategoryBreakdown shows donut chart with legend and cost breakdown table.</done>
</task>

</tasks>

<verification>
1. Webhook handler records cost on billable sent status
2. Cost recording uses upsert to prevent duplicates
3. Usage dashboard loads summary data
4. Period selector changes date range
5. Summary cards show total messages, costs, and limit
6. Area chart shows daily trend
7. Pie chart shows category breakdown
8. Costs displayed in USD with proper formatting
</verification>

<success_criteria>
- Webhook records costs with correct category
- Dashboard shows summary cards
- Period selection updates all data
- Area chart renders daily data
- Pie chart shows category distribution
- Limit progress bar shows when limit configured
</success_criteria>

<output>
After completion, create `.planning/phases/08-whatsapp-extended/08-08-SUMMARY.md`
</output>
