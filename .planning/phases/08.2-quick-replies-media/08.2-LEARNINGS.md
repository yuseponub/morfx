# Phase 8.2: Quick Replies con Media - Learnings

**Fecha:** 2026-01-31
**Duracion:** ~15 minutos
**Plans ejecutados:** 1

---

## Bugs Encontrados

| Bug | Causa | Fix | Prevencion |
|-----|-------|-----|------------|
| Ninguno | - | - | Fase pequena y bien definida |

## Decisiones Tecnicas

| Decision | Alternativas Descartadas | Razon |
|----------|-------------------------|-------|
| Solo imagenes en v1 | Soportar video/audio/documents | Simplicidad - imagenes cubren 90% de casos de uso |
| Max 5MB para imagenes | Sin limite / limite mayor | Balance entre UX y storage costs |
| Imagen como caption del texto | Mensajes separados (imagen + texto) | Un solo mensaje es mejor UX, WhatsApp lo soporta |
| Reusar bucket whatsapp-media | Crear bucket separado | Consistencia, ya tiene policies correctas |

## Problemas de Integracion

| Componente A | Componente B | Problema | Solucion |
|--------------|--------------|----------|----------|
| Quick reply autocomplete | Message input | Necesita pasar media_url ademas de content | Extender callback onSelect con media info |
| File upload | Server Action | Files no se pueden pasar directo a Server Actions | Base64 encoding o upload directo a Storage |

## Tips para Futuros Agentes

### Lo que funciono bien
- Extender tabla existente con ALTER TABLE es simple y no-breaking
- Reusar bucket de Storage existente con subfolder (quick-replies/)
- Patron de thumbnail preview en forms y lists
- Callback con objeto completo {content, media_url, media_type} en lugar de solo string

### Lo que NO hacer
- NO intentar subir archivos grandes via Server Actions (limite de payload)
- NO olvidar limpiar archivos de Storage al eliminar quick reply

### Patrones a seguir
- Media upload: subir a Storage primero, guardar URL en DB
- Thumbnail: usar object-cover para aspect ratio consistente
- Optional media: campo nullable, UI muestra/oculta segun exista

### Comandos utiles
```bash
# Ver estructura de bucket en Supabase Storage
# (desde dashboard o usando supabase CLI)
supabase storage ls whatsapp-media/quick-replies/
```

## Deuda Tecnica Identificada

| Item | Prioridad | Fase sugerida |
|------|-----------|---------------|
| Soporte video/audio/documents en quick replies | Baja | Future enhancement |
| Upload directo a Storage sin Server Actions para imagenes grandes | Media | Si usuarios reportan problemas |
| Compresion de imagenes antes de upload | Baja | Optimizacion futura |

## Notas para el Modulo

### Quick Replies con Media
- Campos agregados: `media_url` (text nullable), `media_type` (text nullable)
- Storage path: `whatsapp-media/quick-replies/{workspace_id}/{filename}`
- Al enviar: si tiene media_url, enviar como mediaMessage con caption
- Al eliminar quick reply: tambien eliminar archivo de Storage

### Flujo de envio con media
1. Usuario selecciona quick reply con imagen
2. Autocomplete pasa {content, media_url, media_type}
3. Message input detecta media_url
4. Llama sendMediaMessage con caption = content

### UI Considerations
- Form muestra preview de imagen con boton de eliminar
- List muestra thumbnail 40x40 en esquina de card
- Autocomplete muestra thumbnail 24x24 junto al shortcut

---
*Generado al completar la fase. Input para entrenamiento de agentes de documentacion.*
