# Phase 15.7: Ingest Timer Pluggable - Context

**Gathered:** 2026-02-08
**Status:** Ready for planning

<domain>
## Phase Boundary

Hacer el timer del ingest un componente funcional, configurable y pluggable. El ingest (clasificacion + extraccion + acumulacion) ya funciona correctamente en sandbox. Lo que NO funciona es el timer que decide CUANDO actuar basado en el estado de los datos acumulados.

**Bugs a resolver:**
1. SandboxEngine ignora `shouldEmitTimerStart` â€” timer nunca se inicia en sandbox
2. Presets del debug panel (rapido/real/instantaneo) son cosmeticos â€” no afectan ningun timer
3. `timerExpiresAt` siempre es null â€” countdown muestra "-"
4. No hay simulacion de timer en sandbox (solo existe via Inngest en produccion)

**NO incluye:** Cambios al ingest (clasificacion/extraccion), cambios al flujo de produccion (Inngest), modulo de configuracion de agentes (futuro).

</domain>

<decisions>
## Implementation Decisions

### Separacion Ingest vs Timer
- **Ingest** (clasificacion + extraccion + acumulacion) es SIEMPRE activo. No tiene toggle. Es esencial para la funcionalidad del agente.
- **Timer** es lo que se puede activar/desactivar. Controla CUANDO el agente reacciona a los datos acumulados.
- El toggle ON/OFF del timer vive en el **tab de Ingest del debug panel** (no en el header).

### Arquitectura del Timer â€” 5 Niveles
El timer implementa 5 niveles escalonados basados en el estado de datos:

| Nivel | Condicion | Tiempo default | Accion |
|-------|-----------|---------------|--------|
| 0 - Sin datos | collecting_data activo, 0 campos | 10 min | Enviar reminder |
| 1 - Datos parciales | Algunos campos, faltan minimos | 6 min desde primer dato | Pedir campos faltantes |
| 2 - Datos minimos | 6 campos minimos completos | 2 min | Avanzar a ofrecer_promos |
| 3 - Promos sin respuesta | Promos enviadas, cliente no elige pack | 10 min despues de promos | Crear orden con valor 0 + mensaje |
| 4 - Pack sin confirmar | Pack elegido, sin confirmacion | 10 min | Crear orden con pack elegido + mensaje |

**Campos minimos requeridos (6):** nombre, apellido, telefono, direccion, ciudad, departamento
**Campos totales (8):** + barrio/indicaciones_extra, correo

### Mensajes del Timer
- **Nivel 0:** "Quedamos pendientes a tus datos, o si tienes alguna pregunta acerca del producto no dudes en hacerla"
- **Nivel 1:** "Para poder despachar tu producto nos faltaria:\n- [lista campos faltantes]\nQuedamos pendientesðŸ¤—" (dinamico, lista los campos que faltan con nombres legibles)
- **Nivel 2:** Sin mensaje. Transicion silenciosa a ofrecer_promos.
- **Nivel 3:** "Quedamos pendientes a la promocion que desees para poder despachar tu orden" + crear orden con valor 0
- **Nivel 4:** "Quedamos pendientes a la confirmacion de tu compra para poder despachar tu orden" + crear orden con pack

Los mensajes aparecen como **mensajes normales del agente** en el chat (sin indicador especial de timer).

### Comportamiento del Timer con Mensajes Entrantes
- **Datos nuevos llegan (niveles 0-1):** Re-evaluar nivel. Si paso de parcial a minimo, timer cambia a nivel 2 (2min). Si sigue parcial, timer sigue contando.
- **Pregunta llega (cualquier nivel):** Timer sigue corriendo. Pregunta se responde normalmente en paralelo.
- **Respuesta relevante llega (niveles 3-4):** Cliente elige pack o confirma â†’ timer se cancela.

### Configurabilidad â€” Presets + Sliders
- 3 presets: Real (tiempos produccion), Rapido (escalados), Instantaneo (~0s)
- Debajo de presets: **5 sliders independientes** (uno por nivel) que se ajustan al cambiar preset pero se pueden modificar individualmente
- Cambiar preset con timer activo: **reinicia el timer con nuevos tiempos**
- Preset instantaneo: **minimo 1-2 segundos** de delay (no 0 real)

### Configuracion en Codigo
- Timer config como constantes en codigo por ahora (TIMER_DEFAULTS con los 5 tiempos)
- Estructura preparada para que un futuro modulo de configuracion de agentes pueda leer/escribir estos valores
- La misma estructura de config se usa en sandbox Y eventualmente en produccion

### Timer en Sandbox
- Simulacion completa de los 5 niveles (misma logica que produccion)
- Countdown numerico simple (ej. "2:45") al lado del nivel actual
- Boton de pausa/reanudacion si es facilmente implementable sin introducir bugs
- Timer se implementa con setTimeout/setInterval en el frontend (no Inngest)

### Claude's Discretion
- Implementacion exacta del timer simulation engine (setTimeout vs setInterval vs requestAnimationFrame)
- Estructura interna del timer state machine
- Exacta proporcion de escalamiento para preset "rapido"
- Implementacion del boton de pausa (si introduce complejidad, omitir)
- Formato visual del countdown (font size, posicion exacta en el panel)

</decisions>

<specifics>
## Specific Ideas

- Referencia: [Proactive Timer de n8n](https://github.com/yuseponub/AGENTES-IA-FUNCIONALES-v3/blob/master/docs/06-PROACTIVE-TIMER.md) â€” loop cada 2min, 20 iteraciones max, flags de idempotencia
- El timer de n8n tiene check de actividad reciente (2min sin actividad). En MorfX esto se maneja via re-evaluacion de nivel cuando llegan datos.
- Campos minimos para n8n: nombre, apellido, telefono, direccion, ciudad, departamento (mismos 6)
- Para nivel 1, el mensaje de campos faltantes usa nombres legibles: 'direccion completa', 'ciudad o municipio', 'correo electronico'

</specifics>

<deferred>
## Deferred Ideas

- Modulo de configuracion de agentes (UI para editar timer config sin codigo) â€” fase futura
- Timer en produccion via Inngest con los 5 niveles (hoy solo tiene 2 timers basicos) â€” Phase 16 o posterior
- Metricas de conversion del timer (funnel: reminders â†’ promos â†’ ordenes) â€” fase futura
- Visualizacion de workflow del timer (nodos tipo n8n) â€” fase futura

</deferred>

---

*Phase: 15.7-ingest-timer-pluggable*
*Context gathered: 2026-02-08*
