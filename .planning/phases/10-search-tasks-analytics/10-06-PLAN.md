---
phase: 10-search-tasks-analytics
plan: 06
type: execute
wave: 4
depends_on: ["10-03", "10-04", "10-05"]
files_modified:
  - src/components/layout/sidebar.tsx
  - src/app/(dashboard)/layout.tsx
autonomous: false

must_haves:
  truths:
    - "Sidebar navigation order matches specification: CRM > WhatsApp > Tareas > Analytics > Settings"
    - "Analytics link hidden for agents"
    - "Global search visible below workspace selector"
    - "Task badge displays pending/overdue count"
    - "All features verified end-to-end"
  artifacts:
    - path: "src/components/layout/sidebar.tsx"
      provides: "Updated sidebar with new navigation structure"
      contains: "navItems"
  key_links:
    - from: "sidebar.tsx"
      to: "/analytics"
      via: "Navigation link (role-conditional)"
      pattern: "href.*analytics"
    - from: "sidebar.tsx"
      to: "GlobalSearch"
      via: "Component render"
      pattern: "GlobalSearch"
---

<objective>
Final integration of all Phase 10 features into the application navigation.

Purpose: Ensure all new features (search, tasks, analytics) are accessible from the sidebar with correct navigation order, role-based visibility, and badge indicators.

Output: Updated sidebar with complete navigation structure and human verification of all features.
</objective>

<execution_context>
@/home/jose147/.claude/get-shit-done/workflows/execute-plan.md
@/home/jose147/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/10-search-tasks-analytics/10-CONTEXT.md
@.planning/phases/10-search-tasks-analytics/10-03-SUMMARY.md
@.planning/phases/10-search-tasks-analytics/10-04-SUMMARY.md
@.planning/phases/10-search-tasks-analytics/10-05-SUMMARY.md

# Current sidebar
@src/components/layout/sidebar.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update sidebar navigation structure</name>
  <files>
    src/components/layout/sidebar.tsx
    src/app/(dashboard)/layout.tsx
  </files>
  <action>
Update sidebar to include all Phase 10 features with correct order and role-based visibility.

**Navigation order (per CONTEXT.md):**
1. CRM
2. WhatsApp
3. Tareas (with badge)
4. Analytics (admin/owner only)
5. Equipo
6. Configuracion

**Updates to sidebar.tsx:**

```tsx
'use client'

import Link from 'next/link'
import { usePathname } from 'next/navigation'
import {
  Building2,
  MessageSquare,
  ListTodo,
  BarChart3,
  Users,
  Settings,
  LogOut
} from 'lucide-react'
import { cn } from '@/lib/utils'
import { Tooltip, TooltipContent, TooltipProvider, TooltipTrigger } from '@/components/ui/tooltip'
import { WorkspaceSwitcher } from '@/components/workspace/workspace-switcher'
import { GlobalSearch } from '@/components/search/global-search'
import { Avatar, AvatarFallback } from '@/components/ui/avatar'
import { Badge } from '@/components/ui/badge'
import { logout } from '@/app/actions/auth'
import { useTaskBadge } from '@/hooks/use-task-badge'
import type { WorkspaceWithRole } from '@/lib/types/database'
import type { User } from '@supabase/supabase-js'

interface NavItem {
  href: string
  label: string
  icon: React.ComponentType<{ className?: string }>
  badge?: 'tasks'          // Show badge indicator
  adminOnly?: boolean      // Only show for admin/owner
}

const navItems: NavItem[] = [
  { href: '/crm', label: 'CRM', icon: Building2 },
  { href: '/whatsapp', label: 'WhatsApp', icon: MessageSquare },
  { href: '/tareas', label: 'Tareas', icon: ListTodo, badge: 'tasks' },
  { href: '/analytics', label: 'Analytics', icon: BarChart3, adminOnly: true },
  { href: '/settings/workspace/members', label: 'Equipo', icon: Users },
  { href: '/settings', label: 'Configuracion', icon: Settings },
]

interface SidebarProps {
  workspaces?: WorkspaceWithRole[]
  currentWorkspace?: WorkspaceWithRole | null
  user?: User | null
}

export function Sidebar({ workspaces = [], currentWorkspace, user }: SidebarProps) {
  const pathname = usePathname()
  const { badgeCount } = useTaskBadge()

  // Determine if user is admin/owner
  const isAdmin = currentWorkspace?.role === 'owner' || currentWorkspace?.role === 'admin'

  // Filter nav items based on role
  const visibleNavItems = navItems.filter(item => {
    if (item.adminOnly && !isAdmin) return false
    return true
  })

  return (
    <aside className="hidden md:flex flex-col w-64 border-r bg-card">
      {/* Logo/Brand */}
      <div className="h-16 flex items-center px-6 border-b">
        <Link href="/crm" className="flex items-center gap-2">
          <div className="w-8 h-8 rounded-lg bg-primary flex items-center justify-center">
            <span className="text-primary-foreground font-bold text-lg">M</span>
          </div>
          <span className="font-semibold text-xl tracking-tight">morfx</span>
        </Link>
      </div>

      {/* Workspace Switcher */}
      <div className="p-4 border-b">
        <WorkspaceSwitcher
          workspaces={workspaces}
          currentWorkspace={currentWorkspace}
        />
      </div>

      {/* Global Search */}
      <div className="px-4 pt-4">
        <GlobalSearch />
      </div>

      {/* Navigation */}
      <nav className="flex-1 p-4">
        <TooltipProvider>
          <ul className="space-y-1">
            {visibleNavItems.map((item) => {
              const isActive = pathname.startsWith(item.href)
              const Icon = item.icon
              const showBadge = item.badge === 'tasks' && badgeCount > 0

              return (
                <li key={item.href}>
                  <Tooltip>
                    <TooltipTrigger asChild>
                      <Link
                        href={item.href}
                        className={cn(
                          'flex items-center gap-3 px-3 py-2 rounded-md text-sm font-medium transition-colors',
                          isActive
                            ? 'bg-accent text-accent-foreground'
                            : 'text-muted-foreground hover:bg-accent hover:text-accent-foreground'
                        )}
                      >
                        <Icon className="h-5 w-5" />
                        <span className="flex-1">{item.label}</span>
                        {showBadge && (
                          <Badge
                            variant="destructive"
                            className="h-5 min-w-[20px] px-1.5 text-xs"
                          >
                            {badgeCount > 99 ? '99+' : badgeCount}
                          </Badge>
                        )}
                      </Link>
                    </TooltipTrigger>
                    <TooltipContent side="right">
                      <p>{item.label}</p>
                    </TooltipContent>
                  </Tooltip>
                </li>
              )
            })}
          </ul>
        </TooltipProvider>
      </nav>

      {/* Footer - User profile */}
      <div className="p-4 border-t">
        {user && (
          <div className="flex items-center gap-3">
            <Avatar className="h-9 w-9">
              <AvatarFallback className="bg-primary text-primary-foreground">
                {user.email?.charAt(0).toUpperCase() || 'U'}
              </AvatarFallback>
            </Avatar>
            <div className="flex-1 min-w-0">
              <p className="text-sm font-medium truncate">
                {user.email?.split('@')[0]}
              </p>
              <p className="text-xs text-muted-foreground truncate">
                {user.email}
              </p>
            </div>
            <form action={logout}>
              <Tooltip>
                <TooltipTrigger asChild>
                  <button
                    type="submit"
                    className="p-2 rounded-md hover:bg-accent text-muted-foreground hover:text-foreground transition-colors"
                  >
                    <LogOut className="h-4 w-4" />
                  </button>
                </TooltipTrigger>
                <TooltipContent side="right">
                  <p>Cerrar sesion</p>
                </TooltipContent>
              </Tooltip>
            </form>
          </div>
        )}
      </div>
    </aside>
  )
}
```

**Ensure layout.tsx passes currentWorkspace to Sidebar** (if not already) so role check works.

Key changes:
1. Add GlobalSearch below workspace switcher
2. Add Tareas nav item with badge
3. Add Analytics nav item (adminOnly)
4. Reorder nav items per specification
5. Role-based filtering for Analytics link
  </action>
  <verify>
1. Sidebar shows all nav items in correct order
2. Tareas shows badge when tasks are pending/overdue
3. Analytics link hidden for agent users
4. Global search button visible and functional
  </verify>
  <done>
Sidebar updated with complete navigation structure.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete Phase 10 implementation:
- Global search with Cmd+K shortcut
- Task management system with entity linking
- Analytics dashboard with metrics and charts
- Updated sidebar navigation
  </what-built>
  <how-to-verify>
**1. Global Search (SRCH-01, SRCH-02, SRCH-03)**
- Press Cmd+K (Mac) or Ctrl+K (Windows) - search dialog should open
- Type a contact name - should show in Contactos section
- Type an order amount - should show in Pedidos section
- Click filter tabs (Contactos, Pedidos, Chats) - results filter by type
- Select a result - should navigate to that entity

**2. Task Management (TASK-01, TASK-02, TASK-03, TASK-04)**
- Navigate to /tareas - should see task list page
- Click "Nueva tarea" - form should open
- Create task with title, description, due date, priority
- Mark task as complete - should show strikethrough
- Navigate to a contact detail (/crm/contactos/[id]) - find "Tareas" tab or button
- Create task from contact - should be linked to contact
- Check sidebar - Tareas should show badge if tasks are overdue/due soon

**3. Analytics Dashboard (ANLT-01, ANLT-02, ANLT-03, ANLT-04)**
- Navigate to /analytics as admin/owner - should see dashboard
- Verify 4 metric cards: Total Pedidos, Valor Total, Tasa de Conversion, Ticket Promedio
- Verify trend chart displays
- Change period (Hoy, 7 dias, 30 dias, Este mes) - data should update
- Log in as agent and try /analytics - should redirect to /crm/pedidos

**4. Navigation (CONTEXT.md compliance)**
- Sidebar order: CRM > WhatsApp > Tareas > Analytics > Equipo > Configuracion
- Analytics link should not appear for agent users
- Global search should be visible below workspace selector
  </how-to-verify>
  <resume-signal>Type "approved" if all features work, or describe any issues found</resume-signal>
</task>

</tasks>

<verification>
1. Navigation order matches CONTEXT.md specification
2. Global search opens with keyboard shortcut
3. Task badge displays correct count
4. Analytics hidden for agents
5. All three features (search, tasks, analytics) are functional
</verification>

<success_criteria>
- [ ] Sidebar navigation order: CRM > WhatsApp > Tareas > Analytics > Equipo > Settings
- [ ] Global search visible and functional with Cmd+K
- [ ] Tareas link shows badge with pending count
- [ ] Analytics link hidden for agent role
- [ ] Human verification confirms all features work
</success_criteria>

<output>
After completion and approval, create `.planning/phases/10-search-tasks-analytics/10-06-SUMMARY.md`
</output>
