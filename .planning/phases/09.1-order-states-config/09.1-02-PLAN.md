---
phase: 09.1-order-states-config
plan: 02
type: execute
wave: 2
depends_on: ["09.1-01"]
files_modified:
  - src/app/(dashboard)/crm/configuracion/estados-pedido/page.tsx
  - src/app/(dashboard)/crm/configuracion/estados-pedido/components/order-state-list.tsx
  - src/app/(dashboard)/crm/configuracion/estados-pedido/components/order-state-form.tsx
  - src/app/(dashboard)/crm/configuracion/estados-pedido/components/stage-assignment.tsx
  - src/app/(dashboard)/crm/configuracion/estados-pedido/components/avatar-preview.tsx
autonomous: true

must_haves:
  truths:
    - "Admin can access order states config at /crm/configuracion/estados-pedido"
    - "Admin can create a new order state with name and emoji"
    - "Admin can edit an existing order state"
    - "Admin can delete an order state"
    - "Admin can reorder states via drag-and-drop"
    - "Admin can assign pipeline stages to a state"
    - "Live preview shows emoji on sample avatar"
  artifacts:
    - path: "src/app/(dashboard)/crm/configuracion/estados-pedido/page.tsx"
      provides: "Settings page for order states"
      contains: "Estados de Pedido"
    - path: "src/app/(dashboard)/crm/configuracion/estados-pedido/components/order-state-list.tsx"
      provides: "Reorderable list with @dnd-kit"
      contains: "DndContext"
    - path: "src/app/(dashboard)/crm/configuracion/estados-pedido/components/order-state-form.tsx"
      provides: "Create/edit dialog with emoji picker"
      contains: "EmojiPicker"
    - path: "src/app/(dashboard)/crm/configuracion/estados-pedido/components/stage-assignment.tsx"
      provides: "Multi-select for stage assignment"
      contains: "Checkbox"
    - path: "src/app/(dashboard)/crm/configuracion/estados-pedido/components/avatar-preview.tsx"
      provides: "Live preview of emoji on avatar"
      contains: "absolute"
  key_links:
    - from: "order-state-list.tsx"
      to: "order-states.ts actions"
      via: "import and call Server Actions"
      pattern: "import.*from.*order-states"
    - from: "order-state-form.tsx"
      to: "emoji-picker.tsx"
      via: "Popover with EmojiPicker component"
      pattern: "import.*EmojiPicker"
---

<objective>
Build the configuration UI for order states management.

Purpose: Allow admins to create, edit, delete, and reorder order states. Each state has a name and emoji. Admins can assign pipeline stages to states. A live preview shows how the emoji will appear on contact avatars.

Output:
- Settings page at /crm/configuracion/estados-pedido
- Reorderable list component with @dnd-kit
- Create/edit dialog with emoji picker
- Stage assignment multi-select
- Avatar preview component
</objective>

<execution_context>
@/home/jose147/.claude/get-shit-done/workflows/execute-plan.md
@/home/jose147/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/09.1-order-states-config/09.1-CONTEXT.md
@.planning/phases/09.1-order-states-config/09.1-RESEARCH.md
@.planning/phases/09.1-order-states-config/09.1-01-SUMMARY.md

# Established patterns to follow exactly
@src/app/(dashboard)/crm/configuracion/pipelines/components/stage-manager.tsx
@src/app/(dashboard)/whatsapp/components/emoji-picker.tsx
@src/app/actions/pipelines.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create settings page and order state list</name>
  <files>
    src/app/(dashboard)/crm/configuracion/estados-pedido/page.tsx
    src/app/(dashboard)/crm/configuracion/estados-pedido/components/order-state-list.tsx
  </files>
  <action>
**page.tsx** (Server Component):
```typescript
import { getOrderStates } from '@/app/actions/order-states'
import { getPipelines } from '@/app/actions/pipelines'
import { OrderStateList } from './components/order-state-list'

export default async function OrderStatesPage() {
  const [states, pipelines] = await Promise.all([
    getOrderStates(),
    getPipelines(),
  ])

  return (
    <div className="container max-w-3xl py-8">
      <div className="mb-8">
        <h1 className="text-2xl font-bold">Estados de Pedido</h1>
        <p className="text-muted-foreground">
          Configura los estados que aparecen como indicadores en las conversaciones de WhatsApp.
          Asigna etapas del pipeline a cada estado para agruparlas visualmente.
        </p>
      </div>
      <OrderStateList states={states} pipelines={pipelines} />
    </div>
  )
}
```

**order-state-list.tsx** (Client Component):
Follow stage-manager.tsx pattern exactly:

1. Imports:
- @dnd-kit/core: DndContext, closestCenter, KeyboardSensor, PointerSensor, useSensor, useSensors, DragEndEvent
- @dnd-kit/sortable: arrayMove, SortableContext, sortableKeyboardCoordinates, useSortable, verticalListSortingStrategy
- @dnd-kit/utilities: CSS
- lucide-react: GripVerticalIcon, PlusIcon, PencilIcon, Trash2Icon
- UI components: Button, AlertDialog
- Server Actions: updateOrderStateOrder, deleteOrderState
- OrderStateForm component
- sonner: toast

2. Props:
```typescript
interface OrderStateListProps {
  states: OrderStateWithStages[]
  pipelines: PipelineWithStages[]
}
```

3. State:
- `const [localStates, setLocalStates] = useState(states)`
- `const [showAddDialog, setShowAddDialog] = useState(false)`
- `const [editingState, setEditingState] = useState<OrderStateWithStages | null>(null)`
- `const [deletingState, setDeletingState] = useState<OrderStateWithStages | null>(null)`

4. useEffect to sync when states prop changes

5. dndContextId via React.useId() to prevent hydration mismatch

6. Sensors setup (same as stage-manager.tsx)

7. handleDragEnd:
- Get old/new index
- Optimistic update with arrayMove
- Call updateOrderStateOrder(newIds)
- Revert on error

8. handleDelete:
- Call deleteOrderState(id)
- Show toast

9. Render:
- DndContext with sensors and closestCenter
- SortableContext with verticalListSortingStrategy
- Map states to SortableStateItem
- Empty state if no states
- Add button at bottom
- OrderStateForm dialog for add/edit
- AlertDialog for delete confirmation

10. SortableStateItem component:
- useSortable hook
- Display: drag handle, emoji (text-2xl), name, stage count badge, edit/delete buttons
- isDragging opacity
  </action>
  <verify>
- File exists: src/app/(dashboard)/crm/configuracion/estados-pedido/page.tsx
- File exists: src/app/(dashboard)/crm/configuracion/estados-pedido/components/order-state-list.tsx
- grep "DndContext" order-state-list.tsx returns matches
- No TypeScript errors: pnpm tsc --noEmit
  </verify>
  <done>
Settings page renders with reorderable list. Drag-and-drop works with optimistic updates. Delete confirmation dialog works.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create order state form with emoji picker and stage assignment</name>
  <files>
    src/app/(dashboard)/crm/configuracion/estados-pedido/components/order-state-form.tsx
    src/app/(dashboard)/crm/configuracion/estados-pedido/components/stage-assignment.tsx
    src/app/(dashboard)/crm/configuracion/estados-pedido/components/avatar-preview.tsx
  </files>
  <action>
**order-state-form.tsx**:

Dialog component for create/edit with:

1. Props:
```typescript
interface OrderStateFormProps {
  open: boolean
  onOpenChange: (open: boolean) => void
  mode: 'create' | 'edit'
  state?: OrderStateWithStages
  pipelines: PipelineWithStages[]
}
```

2. State:
- name (string)
- emoji (string)
- assignedStageIds (string[])
- isPending (boolean)
- error (string | null)

3. useEffect to reset form when dialog opens (same as StageFormDialog)

4. Form layout:
```
Dialog
  DialogHeader: "Nuevo estado" or "Editar estado"
  Form:
    - Name input (required)
    - Emoji picker in Popover (required)
      - Trigger: Button showing current emoji or "+" if none
      - Content: EmojiPicker component (import from @/app/(dashboard)/whatsapp/components/emoji-picker)
      - Close popover after selection
    - AvatarPreview component showing emoji on sample avatar
    - StageAssignment component (only in edit mode, or always show)
    - Error display
  DialogFooter: Cancel, Submit
```

5. handleSubmit:
- Validate name and emoji not empty
- If create: call createOrderState({name, emoji})
- If edit: call updateOrderState(id, {name, emoji})
- Then if assignedStageIds changed: call assignStagesToState(id, assignedStageIds)
- Show toast, close dialog

**stage-assignment.tsx**:

Multi-select component showing stages grouped by pipeline:

1. Props:
```typescript
interface StageAssignmentProps {
  pipelines: PipelineWithStages[]
  currentStateId?: string
  assignedStageIds: string[]
  onAssignmentChange: (stageIds: string[]) => void
}
```

2. Render grouped by pipeline:
```tsx
<div className="space-y-4">
  {pipelines.map(pipeline => (
    <div key={pipeline.id}>
      <h4 className="text-sm font-medium mb-2">{pipeline.name}</h4>
      <div className="space-y-1 ml-2">
        {pipeline.stages.map(stage => {
          const isAssignedToOther = stage.order_state_id && stage.order_state_id !== currentStateId
          const isChecked = assignedStageIds.includes(stage.id)

          return (
            <label key={stage.id} className="flex items-center gap-2 py-1">
              <Checkbox
                checked={isChecked}
                onCheckedChange={() => toggleStage(stage.id)}
                disabled={isAssignedToOther}
              />
              <span className="w-3 h-3 rounded-full" style={{ backgroundColor: stage.color }} />
              <span className={cn(isAssignedToOther && 'text-muted-foreground')}>
                {stage.name}
              </span>
              {isAssignedToOther && (
                <span className="text-xs text-muted-foreground">(asignado a otro estado)</span>
              )}
            </label>
          )
        })}
      </div>
    </div>
  ))}
</div>
```

3. toggleStage function:
- If in array, remove
- If not in array, add
- Call onAssignmentChange with new array

**avatar-preview.tsx**:

Simple preview component showing emoji positioned on avatar (Callbell style):

```typescript
interface AvatarPreviewProps {
  emoji?: string
}

export function AvatarPreview({ emoji }: AvatarPreviewProps) {
  return (
    <div className="flex items-center gap-4 p-4 bg-muted rounded-lg">
      <div className="relative inline-block">
        {/* Sample avatar */}
        <div className="w-12 h-12 rounded-full bg-primary/20 flex items-center justify-center">
          <span className="text-lg font-medium text-primary">JD</span>
        </div>
        {/* Emoji indicator badge - Callbell style */}
        {emoji && (
          <span className="absolute -top-1 -right-1 text-sm">
            {emoji}
          </span>
        )}
      </div>
      <div className="text-sm text-muted-foreground">
        {emoji
          ? 'Asi se vera el indicador en las conversaciones'
          : 'Selecciona un emoji para ver la vista previa'}
      </div>
    </div>
  )
}
```
  </action>
  <verify>
- Files exist at specified paths
- grep "EmojiPicker" order-state-form.tsx returns match
- grep "Checkbox" stage-assignment.tsx returns match
- grep "absolute" avatar-preview.tsx returns match
- No TypeScript errors
  </verify>
  <done>
Create/edit dialog works with emoji picker in popover. Stage assignment shows stages grouped by pipeline with disabled state for stages assigned elsewhere. Avatar preview shows live emoji positioning.
  </done>
</task>

</tasks>

<verification>
After all tasks complete:
1. Navigate to /crm/configuracion/estados-pedido
2. Page loads with empty state or list of states
3. Click "Agregar estado" opens dialog
4. Can select emoji via picker
5. Preview shows emoji on avatar
6. Can create state, appears in list
7. Can drag to reorder
8. Can edit state
9. Can assign stages in edit mode
10. Can delete state

Run: pnpm dev and manually verify at http://localhost:3020/crm/configuracion/estados-pedido
</verification>

<success_criteria>
- [x] Settings page renders at /crm/configuracion/estados-pedido
- [x] Order states display in reorderable list
- [x] Drag-and-drop works with optimistic updates
- [x] Create dialog has name input and emoji picker
- [x] Edit dialog shows current values
- [x] Stage assignment shows stages grouped by pipeline
- [x] Stages assigned to other states are disabled
- [x] Avatar preview shows emoji in Callbell position
- [x] Delete confirmation works
- [x] Toast notifications for all actions
</success_criteria>

<output>
After completion, create `.planning/phases/09.1-order-states-config/09.1-02-SUMMARY.md`
</output>
