---
phase: 18-domain-layer-foundation
plan: 08
type: execute
wave: 4
depends_on: ["18-01"]
files_modified:
  - src/lib/domain/notes.ts
  - src/lib/domain/custom-fields.ts
  - src/lib/domain/index.ts
  - src/app/actions/notes.ts
  - src/app/actions/task-notes.ts
  - src/app/actions/custom-fields.ts
  - src/lib/automations/action-executor.ts
  - src/lib/tools/handlers/crm/index.ts
  - src/lib/tools/schemas/crm.tools.ts
autonomous: true

must_haves:
  truths:
    - "Contact notes (create/update/delete) go through domain/notes with activity logging"
    - "Task notes (create/update/delete) go through domain/notes with activity logging"
    - "Custom field value updates go through domain/custom-fields with field.changed trigger"
    - "3 new note tool handlers: note.create, note.list, note.delete"
    - "2 new custom-field tool handlers: custom-field.update, custom-field.read"
    - "Action executor update_field for custom fields uses domain"
  artifacts:
    - path: "src/lib/domain/notes.ts"
      provides: "6 note domain functions (3 contact + 3 task)"
      exports: ["createNote", "updateNote", "deleteNote", "createTaskNote", "updateTaskNote", "deleteTaskNote"]
    - path: "src/lib/domain/custom-fields.ts"
      provides: "2 custom field domain functions"
      exports: ["updateCustomFieldValues", "readCustomFieldValues"]
  key_links:
    - from: "src/lib/domain/notes.ts"
      to: "contact_activity / task_activity tables"
      via: "activity logging inside domain"
      pattern: "contact_activity|task_activity"
    - from: "src/lib/domain/custom-fields.ts"
      to: "src/lib/automations/trigger-emitter.ts"
      via: "import emitFieldChanged"
      pattern: "trigger-emitter"
---

<objective>
Create notes and custom-fields domain functions, wire all callers, and create 5 new tool handlers (3 notes + 2 custom-fields).

Purpose: Notes and custom fields are currently server-action-only entities with no trigger emission and no tool handler access. After this plan, the bot can create notes and update custom fields, and custom field changes trigger field.changed automations.

Output: `src/lib/domain/notes.ts`, `src/lib/domain/custom-fields.ts` + 4 refactored callers + 5 new tool handlers.
</objective>

<execution_context>
@/home/jose147/.claude/get-shit-done/workflows/execute-plan.md
@/home/jose147/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/18-domain-layer-foundation/18-RESEARCH.md

Key reference files (READ THESE):
@src/app/actions/notes.ts (contact notes: createNote, updateNote, deleteNote + activity logging)
@src/app/actions/task-notes.ts (task notes: createTaskNote, updateTaskNote, deleteTaskNote + activity logging)
@src/app/actions/custom-fields.ts (field definitions CRUD + updateContactCustomFields)
@src/lib/automations/action-executor.ts (update_field action — handles custom fields via JSONB merge)
@src/lib/automations/trigger-emitter.ts (emitFieldChanged)
@src/lib/tools/schemas/crm.tools.ts (existing schema pattern)
@src/lib/domain/types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create notes + custom-fields domain functions</name>
  <files>src/lib/domain/notes.ts, src/lib/domain/custom-fields.ts, src/lib/domain/index.ts</files>
  <action>
**Create `src/lib/domain/notes.ts`** with 6 functions:

Contact notes:
1. **createNote(ctx, params):** params: contactId, content, createdBy (user name). Insert into notes. Also insert activity record into contact_activity (type='note_added'). Return: `{ noteId }`
2. **updateNote(ctx, params):** params: noteId, content. Update notes row. Return: `{ noteId }`
3. **deleteNote(ctx, params):** params: noteId. Delete from notes. Return: `{ noteId }`

Task notes:
4. **createTaskNote(ctx, params):** params: taskId, content, createdBy. Insert into task_notes. Also insert activity record into task_activity (type='note_added'). Return: `{ noteId }`
5. **updateTaskNote(ctx, params):** params: noteId, content. Update task_notes row. Return: `{ noteId }`
6. **deleteTaskNote(ctx, params):** params: noteId. Delete from task_notes. Return: `{ noteId }`

IMPORTANT: Activity logging (contact_activity / task_activity) is a DOMAIN concern — it moves from server actions into domain functions. Study `src/app/actions/notes.ts` and `src/app/actions/task-notes.ts` for exact activity record structure.

No triggers currently defined for notes in Phase 17 trigger catalog. Just domain encapsulation.

**Create `src/lib/domain/custom-fields.ts`** with 2 functions:

1. **updateCustomFieldValues(ctx, params):** params: contactId, fields: Record<string, unknown>
   - Logic: Read current contact's custom_fields JSONB. Merge new fields into existing. Update contact row. For each changed field, emit `emitFieldChanged({ workspaceId, entityType: 'contact', entityId: contactId, fieldName: `custom.${key}`, previousValue, newValue, contactId, cascadeDepth })`.
   - Return: `{ contactId }`
   - IMPORTANT: Study `src/app/actions/custom-fields.ts` updateContactCustomFields AND `src/lib/automations/action-executor.ts` update_field for the JSONB merge pattern.

2. **readCustomFieldValues(ctx, params):** params: contactId
   - Logic: Read contact's custom_fields JSONB + read custom_field_definitions for the workspace to provide field labels.
   - Return: `{ fields: Record<string, unknown>, definitions: Array<{ key, label, type }> }`
   - This is read-only but needed for the tool handler.

Note: Custom field DEFINITIONS (create/update/delete of the schema itself) remain in server actions — they are admin configuration, not CRM mutations.

Update `src/lib/domain/index.ts`: Add `export * from './notes'` and `export * from './custom-fields'`.
  </action>
  <verify>Both files compile. 6 note functions + 2 custom-field functions exported. Barrel export updated. Activity logging in domain note functions.</verify>
  <done>Notes and custom-fields domain functions created with activity logging and trigger emission.</done>
</task>

<task type="auto">
  <name>Task 2: Wire callers + create 5 new tool handlers</name>
  <files>src/app/actions/notes.ts, src/app/actions/task-notes.ts, src/app/actions/custom-fields.ts, src/lib/automations/action-executor.ts, src/lib/tools/handlers/crm/index.ts, src/lib/tools/schemas/crm.tools.ts</files>
  <action>
**Refactor `src/app/actions/notes.ts`:**
1. Import domain note functions
2. createNote, updateNote, deleteNote → call domain functions
3. REMOVE inline activity logging (moved to domain)
4. Keep auth validation + revalidatePath

**Refactor `src/app/actions/task-notes.ts`:**
1. Import domain task note functions
2. createTaskNote, updateTaskNote, deleteTaskNote → call domain functions
3. REMOVE inline activity logging (moved to domain)
4. Keep auth validation + revalidatePath

**Refactor `src/app/actions/custom-fields.ts`:**
1. Import `updateCustomFieldValues as domainUpdateCustomFieldValues` from domain
2. `updateContactCustomFields` → call domain function
3. Keep custom field DEFINITION functions (create/update/delete definitions) as-is — they're admin config, not CRM mutations
4. Keep auth + revalidatePath

**Refactor `src/lib/automations/action-executor.ts`:**
1. The `update_field` action when handling custom fields: Call `domainUpdateCustomFieldValues(ctx, { contactId, fields })` instead of direct JSONB merge
2. REMOVE inline emitFieldChanged for custom field changes — domain handles it
3. Note: update_field also handles standard contact/order fields — that was migrated in Plan 05 for contacts. Verify no duplicate coverage.

**Add 3 new NOTE tool handlers** to `src/lib/tools/handlers/crm/index.ts`:
1. **note.create**: Calls `domainCreateNote(ctx, { contactId, content, createdBy: 'bot' })`. Bot permission: YES.
   - Input: contactId (required), content (required)
2. **note.list**: Read-only. Query notes for a contact. Uses createAdminClient + workspace_id validation via contact ownership.
   - Input: contactId (required), page?, pageSize?
3. **note.delete**: Calls `domainDeleteNote(ctx, { noteId })`. Bot permission: NO (automations only).
   - Input: noteId (required)
   - Add comment about bot restriction

**Add 2 new CUSTOM-FIELD tool handlers:**
4. **custom-field.update**: Calls `domainUpdateCustomFieldValues(ctx, { contactId, fields })`. Bot permission: YES.
   - Input: contactId (required), fields: Record<string, unknown>
5. **custom-field.read**: Calls `domainReadCustomFieldValues(ctx, { contactId })`. Bot permission: YES.
   - Input: contactId (required)

**Add 5 tool schemas** to `src/lib/tools/schemas/crm.tools.ts`:
- note.create, note.list, note.delete, custom-field.update, custom-field.read
- Follow existing schema pattern with parameter JSON Schema
  </action>
  <verify>TypeScript compiles. 5 new tool schemas in crm.tools.ts. Server actions for notes have no inline activity logging. Action executor custom field handling uses domain.</verify>
  <done>Notes + custom-fields entity 100% complete. 5 new tool handlers registered. Bot can manage notes and custom fields.</done>
</task>

</tasks>

<verification>
1. `src/lib/domain/notes.ts` exports 6 functions with activity logging inside domain
2. `src/lib/domain/custom-fields.ts` exports 2 functions with field.changed trigger
3. Server actions for notes/task-notes delegate to domain (no inline activity logging)
4. Server action updateContactCustomFields delegates to domain
5. Action executor update_field for custom fields uses domain
6. 5 new tool handlers registered (note.create/list/delete, custom-field.update/read)
7. 5 new tool schemas in crm.tools.ts
8. `npx tsc --noEmit` passes
</verification>

<success_criteria>
- All note and custom-field mutations go through domain/
- Activity logging is a domain concern (not adapter concern)
- Custom field changes emit field.changed triggers
- Bot can create/list notes and update/read custom fields
- 5 new tool handlers functional
</success_criteria>

<output>
After completion, create `.planning/phases/18-domain-layer-foundation/18-08-SUMMARY.md`
</output>
