---
phase: 11-shopify-integration
plan: 07
type: execute
wave: 4
depends_on: ["11-05", "11-06"]
files_modified:
  - src/app/(dashboard)/crm/configuracion/page.tsx
  - src/components/sidebar/nav-links.tsx
autonomous: false

must_haves:
  truths:
    - "Integrations accessible from CRM settings"
    - "Navigation includes link to integrations"
    - "End-to-end flow verified working"
  artifacts:
    - path: "src/app/(dashboard)/crm/configuracion/page.tsx"
      provides: "Updated CRM settings page with integrations link"
  key_links:
    - from: "src/app/(dashboard)/crm/configuracion/page.tsx"
      to: "/configuracion/integraciones"
      via: "Link component"
      pattern: "href.*integraciones"
---

<objective>
Wire up navigation and perform end-to-end verification.

Purpose: Make integrations discoverable and verify the complete flow works.
Output: Updated navigation, end-to-end verification with user.
</objective>

<execution_context>
@/home/jose147/.claude/get-shit-done/workflows/execute-plan.md
@/home/jose147/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/11-shopify-integration/11-CONTEXT.md
@.planning/phases/11-shopify-integration/11-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add integrations to navigation</name>
  <files>src/app/(dashboard)/crm/configuracion/page.tsx</files>
  <action>
Update the CRM configuration page to include a link to integrations.

Look for the existing CRM settings page structure and add an "Integraciones" card/link that points to `/configuracion/integraciones`.

Pattern to follow (from existing settings pages):
- Card with icon, title, and description
- Link to /configuracion/integraciones
- Only visible to Owner role (add role check if not present)

Example addition:
```tsx
<Link href="/configuracion/integraciones">
  <Card className="hover:bg-accent transition-colors cursor-pointer">
    <CardHeader>
      <div className="flex items-center gap-2">
        <Plug className="h-5 w-5" />
        <CardTitle>Integraciones</CardTitle>
      </div>
      <CardDescription>
        Conecta tu tienda Shopify para sincronizar pedidos automaticamente
      </CardDescription>
    </CardHeader>
  </Card>
</Link>
```

If no CRM configuration page exists, check the main settings/configuracion layout and add the link there.

Also check if sidebar navigation (nav-links.tsx or similar) needs updating. If there's a settings section, add "Integraciones" under it for Owners.
  </action>
  <verify>Navigate to CRM settings, verify integrations link appears. Click link, verify it opens integrations page.</verify>
  <done>Integrations accessible from CRM settings or main navigation.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete Shopify integration system:
1. Database schema with integrations and webhook_events tables
2. HMAC verification and phone normalization utilities
3. Contact matching with fuzzy name+city logic
4. Order mapping with product matching (SKU/name/value)
5. Webhook handler with idempotency
6. Webhook endpoint at /api/webhooks/shopify
7. Server Actions for integration CRUD
8. Configuration UI at /configuracion/integraciones
  </what-built>
  <how-to-verify>
**Part 1: UI Verification**
1. Login as workspace Owner
2. Navigate to CRM settings or /configuracion/integraciones
3. Verify the Shopify configuration form appears
4. Check all fields are present:
   - Shop domain
   - Access Token
   - API Secret
   - Pipeline/Stage selection
   - Product matching dropdown
   - Fuzzy matching toggle
5. Verify "Test connection" button exists

**Part 2: Integration Flow (if Shopify credentials available)**
1. Enter Shopify credentials and click "Test connection"
2. Verify success/error message appears
3. Select pipeline and stage
4. Save the integration
5. Check sync status panel shows "Activa"

**Part 3: Webhook Endpoint (if testable)**
1. Create a test order in Shopify (if test environment available)
2. Check MorfX:
   - Webhook event logged in sync status
   - Contact created (if new customer)
   - Order created in configured pipeline/stage
   - Products mapped correctly

**If no Shopify credentials:**
- Verify UI renders correctly
- Verify form validation works (submit empty form)
- Verify "Test connection" with fake credentials shows error
- Confirm webhook endpoint responds to GET: `curl https://yourapp.com/api/webhooks/shopify`
  </how-to-verify>
  <resume-signal>Type "approved" if integration UI works and flow is testable, or describe any issues found.</resume-signal>
</task>

</tasks>

<verification>
1. Integrations accessible from settings navigation
2. Configuration form fully functional
3. Webhook endpoint reachable
4. End-to-end flow verified (if credentials available)
</verification>

<success_criteria>
- Admin can find and access integrations settings
- Complete configuration flow works
- Shopify webhooks can be received and processed
- Orders appear in MorfX with correct data
</success_criteria>

<output>
After completion, create `.planning/phases/11-shopify-integration/11-07-SUMMARY.md`
</output>
