---
phase: 16-whatsapp-agent-integration
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/agents/production/webhook-processor.ts
  - src/lib/agents/production/handoff-handler.ts
  - src/inngest/events.ts
  - src/inngest/functions/agent-production.ts
  - src/app/api/inngest/route.ts
  - src/lib/whatsapp/webhook-handler.ts
  - src/app/api/webhooks/whatsapp/route.ts
autonomous: true

must_haves:
  truths:
    - "Incoming WhatsApp text message triggers agent processing when agent is enabled"
    - "Agent processing runs asynchronously via Inngest (does not block webhook response)"
    - "Concurrent messages for same conversation are queued (Inngest concurrency limit)"
    - "Agent checks enabled status BEFORE sending response (handles toggle-off during processing)"
    - "Handoff creates task, sends configurable message, disables conversational agent only"
    - "Messages sent by agent are marked with sent_by_agent=true in DB"
    - "Contact is auto-created if conversation has no linked contact when agent processes"
  artifacts:
    - path: "src/lib/agents/production/webhook-processor.ts"
      provides: "Routes webhook messages through SomnioEngine"
      exports: ["processMessageWithAgent"]
    - path: "src/lib/agents/production/handoff-handler.ts"
      provides: "Handoff workflow with task creation and toggle"
      exports: ["executeHandoff", "getNextAvailableAgent"]
    - path: "src/inngest/functions/agent-production.ts"
      provides: "Inngest function for production agent message processing"
      exports: ["agentProductionFunctions"]
    - path: "src/inngest/events.ts"
      provides: "New event type for production message routing"
      contains: "agent/whatsapp.message_received"
  key_links:
    - from: "src/lib/whatsapp/webhook-handler.ts"
      to: "Inngest event emission"
      via: "inngest.send after message storage"
      pattern: "agent/whatsapp.message_received"
    - from: "src/inngest/functions/agent-production.ts"
      to: "src/lib/agents/production/webhook-processor.ts"
      via: "processMessageWithAgent call inside Inngest function"
      pattern: "processMessageWithAgent"
    - from: "src/lib/agents/production/webhook-processor.ts"
      to: "src/lib/agents/somnio/somnio-engine.ts"
      via: "SomnioEngine.processMessage"
      pattern: "SomnioEngine"
    - from: "src/lib/agents/production/handoff-handler.ts"
      to: "tasks table"
      via: "Supabase insert for task creation"
      pattern: "from\\('tasks'\\)"
---

<objective>
Wire incoming WhatsApp messages to the SomnioEngine via Inngest for reliable, queued agent processing with handoff support.

Purpose: This is the core integration that makes agents work on real WhatsApp conversations. Using Inngest ensures webhook returns 200 quickly (avoiding 360dialog retries), provides concurrency control per conversation (preventing duplicate responses), and gives automatic retries if agent processing fails.

Output: webhook-processor.ts, handoff-handler.ts, Inngest production function, modified webhook handler to emit events.
</objective>

<execution_context>
@/home/jose147/.claude/get-shit-done/workflows/execute-plan.md
@/home/jose147/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/16-whatsapp-agent-integration/16-CONTEXT.md
@.planning/phases/16-whatsapp-agent-integration/16-RESEARCH.md

Key source files:
@src/lib/agents/somnio/somnio-engine.ts
@src/lib/whatsapp/webhook-handler.ts
@src/app/api/webhooks/whatsapp/route.ts
@src/inngest/client.ts
@src/inngest/events.ts
@src/inngest/functions/agent-timers.ts
@src/app/api/inngest/route.ts
@src/lib/agents/production/agent-config.ts (from Plan 01)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Inngest event + production function + webhook integration</name>
  <files>
    src/inngest/events.ts
    src/inngest/functions/agent-production.ts
    src/app/api/inngest/route.ts
    src/lib/whatsapp/webhook-handler.ts
    src/app/api/webhooks/whatsapp/route.ts
  </files>
  <action>
**src/inngest/events.ts:**

Add new event type to AgentEvents (NOT IngestEvents):
```typescript
'agent/whatsapp.message_received': {
  data: {
    conversationId: string
    contactId: string | null
    messageContent: string
    workspaceId: string
    phone: string
    messageId: string  // wamid for deduplication
  }
}
```

**src/inngest/functions/agent-production.ts:**

Create new file with Inngest function:

```typescript
import { inngest } from '../client'
import { processMessageWithAgent } from '@/lib/agents/production/webhook-processor'
import { createModuleLogger } from '@/lib/audit/logger'

const logger = createModuleLogger('agent-production')

export const whatsappAgentProcessor = inngest.createFunction(
  {
    id: 'whatsapp-agent-processor',
    name: 'WhatsApp Agent Processor',
    retries: 2,
    concurrency: [{
      key: 'event.data.conversationId',
      limit: 1,  // Only 1 concurrent processing per conversation
    }],
  },
  { event: 'agent/whatsapp.message_received' },
  async ({ event, step }) => {
    const { conversationId, contactId, messageContent, workspaceId, phone, messageId } = event.data

    logger.info({ conversationId, messageId }, 'Processing message with agent via Inngest')

    await step.run('process-message', async () => {
      await processMessageWithAgent({
        conversationId,
        contactId,
        messageContent,
        workspaceId,
        phone,
      })
    })

    logger.info({ conversationId, messageId }, 'Agent processing complete')
  }
)

export const agentProductionFunctions = [whatsappAgentProcessor]
```

Key: `concurrency` with `key: 'event.data.conversationId'` and `limit: 1` ensures only one message is processed at a time per conversation (Pitfall 2 from research).

**src/app/api/inngest/route.ts:**

Add the new production functions to the serve array:
```typescript
import { agentProductionFunctions } from '@/inngest/functions/agent-production'

export const { GET, POST, PUT } = serve({
  client: inngest,
  functions: [
    ...agentTimerFunctions,
    ...agentProductionFunctions,
  ],
})
```

**src/lib/whatsapp/webhook-handler.ts:**

After the message is stored in processIncomingMessage (after the safety net update and BEFORE the final console.log), add agent routing:

1. Import inngest client dynamically to avoid circular deps: `const { inngest } = await import('@/inngest/client')`
2. Only for text messages (msg.type === 'text'):
   - Get the conversation's contact_id from the DB query we already have
   - Emit Inngest event:
```typescript
if (msg.type === 'text' && msg.text?.body) {
  try {
    const { inngest } = await import('@/inngest/client')
    await inngest.send({
      name: 'agent/whatsapp.message_received',
      data: {
        conversationId,
        contactId: null, // Will be resolved in processor
        messageContent: msg.text.body,
        workspaceId,
        phone,
        messageId: msg.id,
      },
    })
  } catch (err) {
    // Non-blocking: agent processing failure should NOT fail message storage
    console.error('Failed to emit agent event:', err)
  }
}
```

IMPORTANT: The Inngest event emission must be non-blocking. Wrap in try/catch so agent failures don't break message reception. The event is emitted AFTER message storage succeeds.

NOTE: The event is emitted for ALL text messages. The agent-config check happens inside processMessageWithAgent (not in webhook). This way we don't need to read agent config in the webhook path, and config changes take effect immediately.
  </action>
  <verify>TypeScript compiles without errors. Verify Inngest function has concurrency config. Verify webhook-handler.ts emits event only for text messages. Verify inngest serve route includes production functions.</verify>
  <done>Webhook emits Inngest event for text messages. Inngest function processes with concurrency limit per conversation. Inngest route serves new function.</done>
</task>

<task type="auto">
  <name>Task 2: Webhook processor + handoff handler</name>
  <files>
    src/lib/agents/production/webhook-processor.ts
    src/lib/agents/production/handoff-handler.ts
  </files>
  <action>
**src/lib/agents/production/webhook-processor.ts:**

Create module with:

1. `ProcessMessageInput` interface:
```typescript
interface ProcessMessageInput {
  conversationId: string
  contactId: string | null
  messageContent: string
  workspaceId: string
  phone: string
}
```

2. `processMessageWithAgent(input: ProcessMessageInput)` — Main function:

   a. Import and call `isAgentEnabledForConversation` from agent-config.ts. If false, return early (no-op).

   b. Get conversation from DB to check contact_id.

   c. If no contact_id, auto-create a minimal contact:
      - Use createAdminClient to insert into contacts table
      - Fields: workspace_id, phone (input.phone), name (from conversation.profile_name or phone)
      - Then update conversation.contact_id
      - This handles Pitfall 6 from research

   d. Create SomnioEngine instance with workspaceId

   e. Call `engine.processMessage()` with SomnioProcessMessageInput

   f. After processing, mark messages sent by agent:
      - Query messages table for recent outbound messages for this conversation that were created AFTER the processing started
      - Update them with `sent_by_agent = true`
      - This works because SomnioEngine's MessageSequencer already sends messages via the WhatsApp tool handler which inserts outbound messages into the DB

   g. **CRITICAL: Re-check agent enabled BEFORE confirming** (Pitfall 3)
      - After engine processing but before the function completes, verify agent is still enabled
      - If disabled during processing, the messages are already sent (can't unsend), but log a warning

   h. If result.newMode === 'handoff', call executeHandoff()

   i. Log completion with structured info (conversationId, success, messagesSent, tokensUsed)

3. `autoCreateContact(workspaceId: string, phone: string, profileName?: string)` — Helper:
   - Insert minimal contact with workspace_id, phone, name (profileName or phone)
   - Return the new contact ID
   - Handle race condition (23505 unique constraint → retry find)

**src/lib/agents/production/handoff-handler.ts:**

Create module with:

1. `executeHandoff(conversationId: string, workspaceId: string, config: AgentConfig)` — Main function:

   a. Send handoff message via WhatsApp:
      - Import sendTextMessage from whatsapp/api.ts
      - Get conversation phone from DB
      - Get API key from env (WHATSAPP_API_KEY)
      - Send config.handoff_message (default: "Regalame 1 min, ya te comunico con un asesor")
      - Mark this message as sent_by_agent in DB

   b. Toggle OFF conversational agent for this conversation:
      - Update conversations table: `agent_conversational = false`
      - CRM agent stays active (Pitfall 4 from research — only conversational disables)

   c. Create task for human agent:
      - Call getNextAvailableAgent for round-robin
      - Insert into tasks table with:
        - workspace_id
        - title: "Handoff: {contactName or phone}"
        - description: "El agente transfirió esta conversación. Motivo: el cliente solicitó un asesor."
        - conversation_id (FK link)
        - assigned_to: next available agent user_id (null if none)
        - priority: 'high'
        - status: 'pending'
        - type: 'handoff' (if tasks table has a type column, else use title prefix)

2. `getNextAvailableAgent(workspaceId: string)` — Round-robin:
   - Query team_members joined with teams for this workspace
   - Filter by is_online = true
   - Order by last_assigned_at ASC, NULLS FIRST
   - Limit 1
   - If found, update last_assigned_at to now
   - Return user_id or null

Use createAdminClient for all DB operations. Use createModuleLogger for structured logging.
  </action>
  <verify>TypeScript compiles without errors. Verify processMessageWithAgent imports SomnioEngine correctly. Verify handoff disables only conversational agent. Verify round-robin queries team_members correctly.</verify>
  <done>Webhook processor routes messages through SomnioEngine with agent-config checks, auto-contact creation, and sent_by_agent marking. Handoff handler creates tasks with round-robin and disables only conversational agent.</done>
</task>

</tasks>

<verification>
- [ ] Inngest event `agent/whatsapp.message_received` defined in events.ts
- [ ] Inngest function has concurrency limit per conversationId
- [ ] Webhook handler emits event non-blocking (try/catch)
- [ ] processMessageWithAgent checks agent config before and during processing
- [ ] Auto-contact creation handles race conditions
- [ ] Handoff only disables conversational agent, CRM stays active
- [ ] Round-robin uses last_assigned_at for fair distribution
- [ ] sent_by_agent column set on agent outbound messages
- [ ] TypeScript compiles cleanly
</verification>

<success_criteria>
Backend integration is complete when:
1. Text messages in webhook emit Inngest event
2. Inngest function processes with concurrency limit per conversation
3. processMessageWithAgent routes through SomnioEngine when agent enabled
4. Contacts auto-created for contactless conversations
5. Agent messages marked with sent_by_agent=true
6. Handoff creates task, sends message, toggles only conversational OFF
7. Round-robin assigns tasks to online team members
</success_criteria>

<output>
After completion, create `.planning/phases/16-whatsapp-agent-integration/16-02-SUMMARY.md`
</output>
