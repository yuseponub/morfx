---
phase: 01-foundation-auth
plan: 03
type: execute
wave: 3
depends_on: ["01-02"]
files_modified:
  - src/app/(dashboard)/layout.tsx
  - src/app/(dashboard)/crm/page.tsx
  - src/app/(dashboard)/whatsapp/page.tsx
  - src/app/(dashboard)/settings/page.tsx
  - src/app/onboarding/page.tsx
  - src/components/layout/sidebar.tsx
  - src/components/layout/header.tsx
  - src/components/layout/mobile-nav.tsx
  - src/components/layout/user-menu.tsx
  - src/components/layout/theme-toggle.tsx
autonomous: true

must_haves:
  truths:
    - "User sees sidebar with CRM, WhatsApp, Settings tabs"
    - "User can navigate between CRM, WhatsApp, Settings sections"
    - "User can logout from user menu in header"
    - "User can toggle dark/light mode"
    - "Navigation works on mobile with drawer pattern"
  artifacts:
    - path: "src/app/(dashboard)/layout.tsx"
      provides: "Protected dashboard layout"
      contains: "getUser"
    - path: "src/components/layout/sidebar.tsx"
      provides: "Fixed left sidebar navigation"
      min_lines: 50
    - path: "src/components/layout/header.tsx"
      provides: "Top header with user menu"
      min_lines: 30
    - path: "src/components/layout/user-menu.tsx"
      provides: "User dropdown with logout"
      contains: "logout"
    - path: "src/components/layout/theme-toggle.tsx"
      provides: "Dark/light mode toggle"
      contains: "setTheme"
  key_links:
    - from: "src/app/(dashboard)/layout.tsx"
      to: "Supabase auth"
      via: "getUser check"
      pattern: "supabase\\.auth\\.getUser"
    - from: "src/components/layout/user-menu.tsx"
      to: "logout action"
      via: "form action"
      pattern: "action.*logout"
    - from: "src/components/layout/sidebar.tsx"
      to: "Next.js routing"
      via: "Link components"
      pattern: "href=.*/crm|/whatsapp|/settings"
---

<objective>
Build application shell with sidebar navigation, header, and protected dashboard routes

Purpose: Provide the main navigation structure users interact with after authentication
Output: Working dashboard layout with sidebar, header, and placeholder pages for CRM/WhatsApp/Settings
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-foundation-auth/CONTEXT.md
@.planning/phases/01-foundation-auth/01-RESEARCH.md
@.planning/phases/01-foundation-auth/01-01-SUMMARY.md
@.planning/phases/01-foundation-auth/01-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create dashboard layout with sidebar and header</name>
  <files>
    src/app/(dashboard)/layout.tsx
    src/components/layout/sidebar.tsx
    src/components/layout/header.tsx
    src/components/layout/theme-toggle.tsx
    src/components/layout/user-menu.tsx
  </files>
  <action>
Add required shadcn/ui components:
```bash
pnpm dlx shadcn@latest add dropdown-menu avatar separator sheet tooltip
```

**src/components/layout/sidebar.tsx:**
Fixed left sidebar (desktop):
- Width: 240px (or collapsible to 64px icons-only)
- Logo/brand at top: "MorfX" with mathematical theme
- Navigation items with icons (use lucide-react):
  - CRM (icon: Users or Building2) -> /crm
  - WhatsApp (icon: MessageSquare) -> /whatsapp
  - Settings (icon: Settings) -> /settings
- Active state highlighting (use usePathname())
- Grayscale theme with accent on active item
- Optional: Collapse toggle button
- Spanish labels

**src/components/layout/header.tsx:**
Top header bar:
- Shows current section name (derive from pathname)
- Search placeholder (non-functional, just UI for now)
- ThemeToggle component
- UserMenu component (avatar + dropdown)
- Responsive: hide search on mobile

**src/components/layout/theme-toggle.tsx:**
- Use next-themes useTheme hook
- Toggle button (sun/moon icon from lucide-react)
- Options: light, dark, system
- Can be simple toggle or dropdown with all three options

**src/components/layout/user-menu.tsx:**
- Avatar with user initial (from user email)
- Dropdown menu (shadcn/ui DropdownMenu):
  - User email display
  - Separator
  - "Cerrar sesion" item that calls logout action
- Use form with action={logout} for the logout button

**src/app/(dashboard)/layout.tsx:**
Protected layout:
```typescript
import { createClient } from '@/lib/supabase/server'
import { redirect } from 'next/navigation'
import { Sidebar } from '@/components/layout/sidebar'
import { Header } from '@/components/layout/header'

export default async function DashboardLayout({
  children,
}: {
  children: React.ReactNode
}) {
  const supabase = await createClient()
  const { data: { user } } = await supabase.auth.getUser()

  if (!user) {
    redirect('/login')
  }

  return (
    <div className="flex h-screen">
      <Sidebar />
      <div className="flex-1 flex flex-col overflow-hidden">
        <Header user={user} />
        <main className="flex-1 overflow-auto p-6">
          {children}
        </main>
      </div>
    </div>
  )
}
```
  </action>
  <verify>
    - `pnpm build` passes
    - Dashboard layout renders with sidebar and header
    - ThemeToggle switches between light/dark mode
    - UserMenu shows and logout button exists
  </verify>
  <done>Dashboard layout with sidebar, header, theme toggle, and user menu</done>
</task>

<task type="auto">
  <name>Task 2: Create dashboard pages and mobile navigation</name>
  <files>
    src/app/(dashboard)/crm/page.tsx
    src/app/(dashboard)/whatsapp/page.tsx
    src/app/(dashboard)/settings/page.tsx
    src/components/layout/mobile-nav.tsx
  </files>
  <action>
**src/app/(dashboard)/crm/page.tsx:**
Placeholder page:
```typescript
export default function CRMPage() {
  return (
    <div className="space-y-4">
      <h1 className="text-2xl font-bold">CRM</h1>
      <p className="text-muted-foreground">
        Gestion de contactos y pedidos. Disponible en la siguiente fase.
      </p>
      {/* Placeholder content - empty state or coming soon message */}
    </div>
  )
}
```

**src/app/(dashboard)/whatsapp/page.tsx:**
Placeholder page with similar structure:
- Title: "WhatsApp"
- Message: "Inbox de conversaciones. Disponible en fases posteriores."

**src/app/(dashboard)/settings/page.tsx:**
Placeholder page:
- Title: "Configuracion"
- Message: "Ajustes de workspace y cuenta. Disponible proximamente."

**src/components/layout/mobile-nav.tsx:**
Mobile navigation (drawer pattern per CONTEXT.md):
- Use shadcn/ui Sheet component
- Hamburger button triggers sheet from left
- Sheet contains same navigation items as Sidebar
- Close sheet on navigation (onClick or automatic)
- Only visible on mobile (use Tailwind responsive classes)

Update Header to include MobileNav trigger on small screens:
- Show hamburger icon (Menu from lucide-react) on mobile
- Hide on desktop (md:hidden or similar)

Update Sidebar to hide on mobile:
- Add className="hidden md:flex" or similar
  </action>
  <verify>
    - `pnpm build` passes
    - /crm, /whatsapp, /settings pages render with placeholder content
    - Navigation between pages works
    - Mobile drawer opens/closes properly (test with browser dev tools responsive mode)
  </verify>
  <done>Dashboard pages created with mobile-responsive navigation drawer</done>
</task>

<task type="auto">
  <name>Task 3: Create onboarding page placeholder and finalize navigation</name>
  <files>
    src/app/onboarding/page.tsx
    src/app/page.tsx
  </files>
  <action>
**src/app/onboarding/page.tsx:**
Simple onboarding placeholder (full wizard in Phase 2):
```typescript
import { createClient } from '@/lib/supabase/server'
import { redirect } from 'next/navigation'

export default async function OnboardingPage() {
  const supabase = await createClient()
  const { data: { user } } = await supabase.auth.getUser()

  if (!user) {
    redirect('/login')
  }

  // For Phase 1, just redirect to dashboard
  // Phase 2 will implement actual onboarding wizard
  redirect('/crm')
}
```

Or alternatively, show a simple welcome message:
- "Bienvenido a MorfX"
- Brief explanation
- "Continuar al dashboard" button -> /crm

**src/app/page.tsx:**
Root page redirect logic:
```typescript
import { createClient } from '@/lib/supabase/server'
import { redirect } from 'next/navigation'

export default async function Home() {
  const supabase = await createClient()
  const { data: { user } } = await supabase.auth.getUser()

  if (user) {
    redirect('/crm')
  } else {
    redirect('/login')
  }
}
```

Verify all navigation flows:
- / -> redirects based on auth state
- Login successful -> /crm (or /onboarding for new users)
- Logout -> /login
- All sidebar links work
- Active state shows on current page
  </action>
  <verify>
    - `pnpm build` passes
    - / redirects correctly based on auth state
    - /onboarding exists and redirects to /crm (Phase 1 behavior)
    - Full navigation flow works: login -> dashboard -> navigate -> logout
  </verify>
  <done>Onboarding placeholder and root redirect configured for complete navigation flow</done>
</task>

</tasks>

<verification>
After all tasks complete:

1. **Build verification:**
   ```bash
   pnpm build
   ```
   Must complete without errors.

2. **Full user flow test (with Supabase configured):**

   a. Visit / (unauthenticated) -> redirects to /login
   b. Login -> redirects to /crm
   c. See sidebar with CRM, WhatsApp, Settings
   d. Click WhatsApp in sidebar -> navigates to /whatsapp
   e. Click Settings -> navigates to /settings
   f. Click theme toggle -> switches dark/light mode
   g. Click user menu -> shows email and logout option
   h. Click logout -> redirects to /login
   i. Try /crm while logged out -> redirects to /login

3. **Mobile test:**
   - Resize browser to mobile width
   - Sidebar hidden, hamburger menu visible
   - Click hamburger -> drawer slides in from left
   - Navigation items work from drawer
   - Drawer closes after navigation

4. **File structure check:**
   ```
   src/
   ├── app/
   │   ├── page.tsx (redirect logic)
   │   ├── onboarding/
   │   │   └── page.tsx
   │   └── (dashboard)/
   │       ├── layout.tsx (protected, with sidebar/header)
   │       ├── crm/page.tsx
   │       ├── whatsapp/page.tsx
   │       └── settings/page.tsx
   └── components/
       └── layout/
           ├── sidebar.tsx
           ├── header.tsx
           ├── mobile-nav.tsx
           ├── user-menu.tsx
           └── theme-toggle.tsx
   ```
</verification>

<success_criteria>
- Application shell displays with fixed left sidebar
- Sidebar shows CRM, WhatsApp, Settings navigation items
- Header shows current section, theme toggle, and user menu
- User can navigate between all three sections
- User can logout from user menu dropdown
- User can toggle dark/light mode
- Mobile view shows drawer navigation (hamburger menu)
- Protected routes redirect unauthenticated users to /login
- All UI uses Spanish labels
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-auth/01-03-SUMMARY.md`
</output>
