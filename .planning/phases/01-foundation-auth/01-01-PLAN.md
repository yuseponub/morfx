---
phase: 01-foundation-auth
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - pnpm-lock.yaml
  - next.config.ts
  - tailwind.config.ts
  - tsconfig.json
  - .env.local
  - .env.example
  - src/app/layout.tsx
  - src/app/page.tsx
  - src/lib/supabase/client.ts
  - src/lib/supabase/server.ts
  - src/lib/supabase/middleware.ts
  - src/lib/utils.ts
  - src/components/providers/theme-provider.tsx
  - middleware.ts
  - components.json
autonomous: true

must_haves:
  truths:
    - "Next.js app runs with pnpm dev"
    - "Supabase clients connect without errors"
    - "Dark/light mode toggle works without hydration flash"
    - "shadcn/ui components are available for use"
  artifacts:
    - path: "package.json"
      provides: "Project dependencies"
      contains: "@supabase/ssr"
    - path: "src/lib/supabase/client.ts"
      provides: "Browser Supabase client"
      exports: ["createClient"]
    - path: "src/lib/supabase/server.ts"
      provides: "Server Supabase client"
      exports: ["createClient"]
    - path: "middleware.ts"
      provides: "Token refresh and route protection"
      contains: "supabase.auth.getUser"
    - path: "src/components/providers/theme-provider.tsx"
      provides: "Theme context for dark/light mode"
      exports: ["ThemeProvider"]
  key_links:
    - from: "src/app/layout.tsx"
      to: "ThemeProvider"
      via: "wraps children"
      pattern: "ThemeProvider"
    - from: "middleware.ts"
      to: "Supabase"
      via: "cookie-based auth"
      pattern: "createServerClient"
---

<objective>
Set up Next.js project with Supabase auth infrastructure and shadcn/ui

Purpose: Establish the foundational codebase with proper auth plumbing before building auth flows
Output: Working Next.js app with Supabase clients, middleware, and shadcn/ui ready
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation-auth/CONTEXT.md
@.planning/phases/01-foundation-auth/01-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Initialize Next.js project with pnpm and core dependencies</name>
  <files>
    package.json
    pnpm-lock.yaml
    next.config.ts
    tsconfig.json
    .env.local
    .env.example
  </files>
  <action>
Create Next.js 15 project in the current directory (morfx/) using pnpm:

```bash
pnpm create next-app@latest . --typescript --tailwind --eslint --app --src-dir --import-alias "@/*"
```

If directory not empty, create in a temp folder and move files.

After scaffold, install core dependencies:
```bash
pnpm add @supabase/supabase-js @supabase/ssr next-themes
pnpm add react-hook-form zod @hookform/resolvers
```

Create environment files:

**.env.local:**
```
NEXT_PUBLIC_SUPABASE_URL=https://[project-id].supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=[anon-key]
```

**.env.example:**
```
NEXT_PUBLIC_SUPABASE_URL=your-supabase-url
NEXT_PUBLIC_SUPABASE_ANON_KEY=your-anon-key
```

User will need to update .env.local with actual Supabase credentials from their existing project.

Update next.config.ts to use TypeScript config format (Next.js 15 standard).
  </action>
  <verify>
    - `pnpm dev` starts development server on localhost:3000
    - `pnpm build` completes without errors
    - package.json contains @supabase/ssr, next-themes, zod
  </verify>
  <done>Next.js 15 project initialized with all required dependencies installed</done>
</task>

<task type="auto">
  <name>Task 2: Configure Supabase clients and middleware</name>
  <files>
    src/lib/supabase/client.ts
    src/lib/supabase/server.ts
    src/lib/supabase/middleware.ts
    src/lib/utils.ts
    middleware.ts
  </files>
  <action>
Create Supabase client factory files following the patterns from RESEARCH.md:

**src/lib/supabase/client.ts** - Browser client:
```typescript
'use client'

import { createBrowserClient } from '@supabase/ssr'

export function createClient() {
  return createBrowserClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!
  )
}
```

**src/lib/supabase/server.ts** - Server client with cookie handling:
- Use `cookies()` from next/headers (await it - Next.js 15 async API)
- Implement getAll/setAll cookie methods
- Handle Server Component context (setAll try/catch)

**src/lib/supabase/middleware.ts** - Helper for middleware client creation

**middleware.ts** at project root:
- Create Supabase client with request/response cookie handling
- Call `supabase.auth.getUser()` (NOT getSession - security)
- Redirect unauthenticated users to /login (except /login, /signup, /auth/*, /forgot-password, /reset-password)
- Use matcher to exclude static files

**src/lib/utils.ts** - Utility functions:
```typescript
import { clsx, type ClassValue } from "clsx"
import { twMerge } from "tailwind-merge"

export function cn(...inputs: ClassValue[]) {
  return twMerge(clsx(inputs))
}
```

Install class utilities if not present: `pnpm add clsx tailwind-merge`
  </action>
  <verify>
    - All Supabase client files exist and export createClient
    - middleware.ts exists at project root
    - `pnpm build` passes (TypeScript compiles)
    - No import errors in any file
  </verify>
  <done>Supabase client factory pattern implemented with browser, server, and middleware variants</done>
</task>

<task type="auto">
  <name>Task 3: Initialize shadcn/ui and configure theme provider</name>
  <files>
    components.json
    tailwind.config.ts
    src/app/globals.css
    src/app/layout.tsx
    src/app/page.tsx
    src/components/providers/theme-provider.tsx
    src/components/ui/button.tsx
  </files>
  <action>
Initialize shadcn/ui with dark mode support:

```bash
pnpm dlx shadcn@latest init
```

When prompted:
- Style: Default
- Base color: Slate (grayscale as per CONTEXT.md)
- CSS variables: Yes
- Tailwind config: tailwind.config.ts
- Components location: src/components
- Utils location: src/lib/utils

Add button component for testing:
```bash
pnpm dlx shadcn@latest add button
```

**src/components/providers/theme-provider.tsx:**
```typescript
'use client'

import * as React from 'react'
import { ThemeProvider as NextThemesProvider } from 'next-themes'

export function ThemeProvider({
  children,
  ...props
}: React.ComponentProps<typeof NextThemesProvider>) {
  return <NextThemesProvider {...props}>{children}</NextThemesProvider>
}
```

**src/app/layout.tsx:**
- Import ThemeProvider
- Set `lang="es"` on html element
- Add `suppressHydrationWarning` to html element
- Wrap children with ThemeProvider (attribute="class", defaultTheme="system", enableSystem, disableTransitionOnChange)
- Import globals.css

**src/app/page.tsx:**
- Simple redirect to /login (temporary landing)
- Or minimal page that confirms app works

Verify globals.css has CSS variables for light/dark themes (shadcn init adds these).
  </action>
  <verify>
    - `pnpm dev` runs without hydration warnings
    - components.json exists with correct config
    - src/components/ui/button.tsx exists
    - Theme toggle would work (manual test optional)
  </verify>
  <done>shadcn/ui initialized with dark mode support and theme provider configured</done>
</task>

</tasks>

<verification>
After all tasks complete:

1. **Build verification:**
   ```bash
   pnpm build
   ```
   Must complete without errors.

2. **Runtime verification:**
   ```bash
   pnpm dev
   ```
   - App starts on localhost:3000
   - No console errors about missing env vars (warnings OK if Supabase not configured yet)
   - No hydration mismatch warnings

3. **File structure check:**
   ```
   src/
   ├── app/
   │   ├── layout.tsx (with ThemeProvider)
   │   ├── page.tsx
   │   └── globals.css
   ├── components/
   │   ├── providers/
   │   │   └── theme-provider.tsx
   │   └── ui/
   │       └── button.tsx
   └── lib/
       ├── supabase/
       │   ├── client.ts
       │   ├── server.ts
       │   └── middleware.ts
       └── utils.ts
   middleware.ts
   .env.local
   .env.example
   ```
</verification>

<success_criteria>
- Next.js 15 app builds and runs without errors
- Supabase clients created for browser, server, and middleware contexts
- Middleware redirects unauthenticated users (will work once Supabase configured)
- shadcn/ui initialized with dark mode class strategy
- ThemeProvider wraps app with suppressHydrationWarning
- All dependencies installed: @supabase/ssr, next-themes, zod, react-hook-form
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-auth/01-01-SUMMARY.md`
</output>
