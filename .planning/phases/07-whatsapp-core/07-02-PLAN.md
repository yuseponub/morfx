---
phase: 07-whatsapp-core
plan: 02
type: execute
wave: 2
depends_on: ["07-01"]
files_modified:
  - src/hooks/use-conversations.ts
  - src/hooks/use-messages.ts
  - src/app/(dashboard)/whatsapp/page.tsx
  - src/app/(dashboard)/whatsapp/layout.tsx
  - src/app/(dashboard)/whatsapp/components/inbox-layout.tsx
  - src/app/(dashboard)/whatsapp/components/conversation-list.tsx
  - src/app/(dashboard)/whatsapp/components/conversation-item.tsx
  - src/app/(dashboard)/whatsapp/components/contact-panel.tsx
  - src/app/(dashboard)/whatsapp/components/filters/inbox-filters.tsx
  - src/app/(dashboard)/whatsapp/components/filters/search-input.tsx
  - src/app/(dashboard)/whatsapp/components/window-indicator.tsx
autonomous: true

must_haves:
  truths:
    - "User can see list of all conversations sorted by recency"
    - "User can search conversations by contact name or phone"
    - "User can filter conversations by read/unread status"
    - "User can see contact info in right panel when conversation selected"
    - "Conversations update in real-time when new messages arrive"
  artifacts:
    - path: "src/hooks/use-conversations.ts"
      provides: "Real-time conversation subscription with search"
      exports: ["useConversations"]
    - path: "src/hooks/use-messages.ts"
      provides: "Real-time message subscription"
      exports: ["useMessages"]
    - path: "src/app/(dashboard)/whatsapp/components/inbox-layout.tsx"
      provides: "3-column split view layout"
      min_lines: 50
    - path: "src/app/(dashboard)/whatsapp/components/conversation-list.tsx"
      provides: "Scrollable conversation list"
      min_lines: 40
    - path: "src/app/(dashboard)/whatsapp/components/contact-panel.tsx"
      provides: "Contact info and order history panel"
      min_lines: 60
  key_links:
    - from: "src/app/(dashboard)/whatsapp/components/conversation-list.tsx"
      to: "src/hooks/use-conversations.ts"
      via: "useConversations hook"
      pattern: "useConversations\\("
    - from: "src/hooks/use-conversations.ts"
      to: "supabase.channel"
      via: "Realtime subscription"
      pattern: "\\.channel\\("
---

<objective>
Build the conversation inbox UI: left panel with searchable conversation list, collapsible right panel with contact info and recent orders.

Purpose: Users can view and navigate their WhatsApp conversations with fuzzy search, filters, and contact context - the left and right columns of the 3-column layout.

Output: React hooks for real-time data, inbox layout component, conversation list, contact panel.
</objective>

<execution_context>
@/home/jose147/.claude/get-shit-done/workflows/execute-plan.md
@/home/jose147/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-whatsapp-core/07-RESEARCH.md
@.planning/phases/07-whatsapp-core/07-CONTEXT.md
@.planning/phases/07-whatsapp-core/07-01-SUMMARY.md

# Existing patterns
@src/app/(dashboard)/crm/pedidos/components/kanban-board.tsx
@src/lib/search/fuse-config.ts
@src/components/contacts/tag-badge.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create real-time hooks for conversations and messages</name>
  <files>
src/hooks/use-conversations.ts
src/hooks/use-messages.ts
  </files>
  <action>
Create hooks directory if not exists: `mkdir -p src/hooks`

**use-conversations.ts:**

1. Install date-fns: `pnpm add date-fns`

2. useConversations(workspaceId: string) hook:
   - State: conversations[], query (search string), filter (all/unread/archived)
   - Initial load via fetch from getConversations() action
   - Supabase Realtime subscription to conversations table (postgres_changes)
     - Filter by workspace_id
     - On INSERT/UPDATE: reload conversations
     - Cleanup channel on unmount
   - Fuse.js instance (memoized) for fuzzy search with keys:
     - contact.name (weight 2)
     - phone (weight 1.5)
     - last_message_preview (weight 1)
     - contact.tags.name (weight 0.8)
     - threshold: 0.4 (from Phase 6 pattern)
   - filteredConversations: apply search query via Fuse, then filter by status
   - Return: { conversations, query, setQuery, filter, setFilter, isLoading }

3. Export types: ConversationFilter = 'all' | 'unread' | 'archived'

**use-messages.ts:**

1. useMessages(conversationId: string | null) hook:
   - State: messages[], isLoading
   - When conversationId changes:
     - Fetch messages via action getMessages(conversationId)
     - Subscribe to postgres_changes on messages table filtered by conversation_id
     - On INSERT: append to messages array
     - On UPDATE: update message in array (for status changes)
   - Cleanup channel on unmount
   - Return: { messages, isLoading }

Use createClient from @/lib/supabase/client (browser client, not server).
  </action>
  <verify>
```bash
ls src/hooks/
grep "export function use" src/hooks/use-conversations.ts src/hooks/use-messages.ts
pnpm list date-fns
```
TypeScript compiles: `cd morfx && npx tsc --noEmit`
  </verify>
  <done>
Hooks exist with Supabase Realtime subscriptions and Fuse.js search integration.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create inbox layout and conversation list components</name>
  <files>
src/app/(dashboard)/whatsapp/layout.tsx
src/app/(dashboard)/whatsapp/page.tsx
src/app/(dashboard)/whatsapp/components/inbox-layout.tsx
src/app/(dashboard)/whatsapp/components/conversation-list.tsx
src/app/(dashboard)/whatsapp/components/conversation-item.tsx
src/app/(dashboard)/whatsapp/components/filters/inbox-filters.tsx
src/app/(dashboard)/whatsapp/components/filters/search-input.tsx
  </files>
  <action>
**layout.tsx:**
- Simple layout wrapper (can be minimal for now)
- className="h-full" to fill available space

**page.tsx:**
- Server Component that renders InboxLayout
- Pass initial conversations from getConversations()
- "use client" directive NOT here (Server Component)

**inbox-layout.tsx (Client Component):**
- Props: initialConversations
- State: selectedConversationId, isPanelOpen (right panel)
- 3-column grid layout:
  - Left (w-80 or similar): ConversationList
  - Center (flex-1): placeholder for ChatView (Plan 03)
  - Right (w-80, collapsible): ContactPanel
- Pass selectedConversationId and setSelectedConversationId to children
- Use ResizablePanelGroup from shadcn if desired, or simple flex

**conversation-list.tsx (Client Component):**
- Props: initialConversations, selectedId, onSelect
- Use useConversations hook for real-time + search
- Render InboxFilters at top
- Render SearchInput below filters
- Map over conversations -> ConversationItem
- ScrollArea for list

**conversation-item.tsx:**
- Props: conversation, isSelected, onSelect
- Display:
  - Contact name (or phone if no contact)
  - Last message preview (truncated)
  - Timestamp (relative: "hace 5 min" using date-fns formatDistanceToNow, locale es)
  - Unread badge if unread_count > 0
  - Tags (small TagBadge components)
- Highlight when selected
- onClick -> onSelect(conversation.id)

**inbox-filters.tsx:**
- Tab-style filter: Todos | No leidos | Archivados
- Use Toggle or custom buttons
- Pass filter value up to parent

**search-input.tsx:**
- Input with search icon
- Debounced onChange (300ms)
- Pass query up to parent
  </action>
  <verify>
```bash
ls src/app/\(dashboard\)/whatsapp/components/
ls src/app/\(dashboard\)/whatsapp/components/filters/
```
Navigate to /whatsapp in browser - should see layout with conversation list (empty initially).
TypeScript compiles: `cd morfx && npx tsc --noEmit`
  </verify>
  <done>
Inbox layout displays with 3-column structure, conversation list renders with search and filters.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create contact panel and window indicator components</name>
  <files>
src/app/(dashboard)/whatsapp/components/contact-panel.tsx
src/app/(dashboard)/whatsapp/components/window-indicator.tsx
src/app/actions/whatsapp.ts
  </files>
  <action>
**contact-panel.tsx (Client Component):**

- Props: conversation (ConversationWithDetails | null), onClose
- If no conversation selected: show empty state
- Header: "Contacto" + close button (X icon)
- If no linked contact:
  - Show phone number
  - "Contacto desconocido"
  - Button "Crear contacto" (links to /crm/contactos/nuevo?phone=xxx)
- If contact linked:
  - Contact name, phone, city
  - Tags section (TagBadge for each)
  - Address if present
- Divider
- "Pedidos recientes" section:
  - Fetch last 5 orders via getRecentOrders(contactId) action
  - Show: status badge, value, date
  - "Ver todos" link to /crm/contactos/[id]
- Button "Crear pedido":
  - Links to /crm/pedidos/nuevo?contact_id=xxx
  - If no contact: creates contact first (or opens order form with phone pre-filled)
- WindowIndicator at top showing 24h status

**window-indicator.tsx:**

- Props: lastCustomerMessageAt (string | null)
- Calculate window status using date-fns differenceInHours
- 3 states per CONTEXT.md:
  - Open (>2h remaining): show nothing (return null)
  - Closing (<2h remaining): yellow warning "Ventana cierra en Xh Xm"
  - Closed (>24h): red "Ventana cerrada - Solo templates"
- Use date-fns formatDistanceToNow for remaining time

**actions/whatsapp.ts:**

Add getRecentOrders(contactId: string, limit = 5) action:
- Query orders by contact_id, limit, order by created_at DESC
- Include stage name and color
- Return array of { id, total_value, stage, created_at }
  </action>
  <verify>
```bash
grep "export function" src/app/\(dashboard\)/whatsapp/components/contact-panel.tsx
grep "WindowIndicator" src/app/\(dashboard\)/whatsapp/components/window-indicator.tsx
grep "getRecentOrders" src/app/actions/whatsapp.ts
```
TypeScript compiles: `cd morfx && npx tsc --noEmit`
  </verify>
  <done>
Contact panel shows contact info, recent orders, and window indicator. Window indicator shows warning only when needed.
  </done>
</task>

</tasks>

<verification>
1. Navigate to /whatsapp - 3-column layout renders
2. Conversation list shows (empty if no data)
3. Search input filters conversations (fuzzy)
4. Filter tabs switch between all/unread/archived
5. Selecting a conversation shows contact panel on right
6. Window indicator appears appropriately
7. Real-time: adding a conversation in DB appears in list without refresh

Test real-time (if data exists):
```sql
-- In Supabase SQL Editor
INSERT INTO conversations (workspace_id, phone, phone_number_id, last_message_preview, last_message_at)
VALUES ('your-workspace-id', '+573001234567', 'test-phone-id', 'Test message', NOW());
```
Conversation should appear in UI without refresh.
</verification>

<success_criteria>
- [ ] /whatsapp page loads with 3-column layout
- [ ] Conversation list displays conversations sorted by last_message_at
- [ ] Search filters by contact name, phone, and message preview
- [ ] Filter tabs work (all, unread, archived)
- [ ] Selecting conversation shows contact panel
- [ ] Contact panel shows contact info or "unknown" state
- [ ] Recent orders appear in contact panel
- [ ] Window indicator shows warning only when <2h or closed
- [ ] Real-time updates work (new conversations appear)
</success_criteria>

<output>
After completion, create `.planning/phases/07-whatsapp-core/07-02-SUMMARY.md`
</output>
