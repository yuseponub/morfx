---
phase: 16.1
plan: 05
subsystem: agent-engine
tags: [unified-engine, production, webhook-processor, adapter-pattern]
dependency-graph:
  requires: ["16.1-01", "16.1-02", "16.1-03"]
  provides: ["production-webhook-processor-using-unified-engine"]
  affects: ["16.1-06"]
tech-stack:
  added: []
  patterns: ["ports-and-adapters", "dynamic-import", "backward-compat-mapping"]
key-files:
  created: []
  modified: ["src/lib/agents/production/webhook-processor.ts"]
decisions:
  - id: "16.1-05-01"
    summary: "Dynamic import of ../engine/unified-engine directly (not barrel) for parallel plan compatibility"
  - id: "16.1-05-02"
    summary: "EngineOutput mapped to SomnioEngineResult with retryable defaulting to true for backward compat"
  - id: "16.1-05-03"
    summary: "EngineOutput type imported from engine/types.ts (static type import) while UnifiedEngine uses dynamic import"
metrics:
  duration: "5m 20s"
  completed: "2026-02-10"
---

# Phase 16.1 Plan 05: Production Webhook Processor Wiring Summary

**Updated webhook-processor.ts to use UnifiedEngine with production adapters while keeping external interface (ProcessMessageInput, SomnioEngineResult) completely unchanged.**

## What Changed

### Task 1: Update webhook-processor to use UnifiedEngine

**Commit:** `a2e7bf5` feat(16.1-05): update webhook-processor to use UnifiedEngine with production adapters

**Changes to webhook-processor.ts (only step 6 modified):**

1. **Replaced SomnioEngine creation** with UnifiedEngine + createProductionAdapters:
   - `await import('../somnio')` -- barrel import for agent self-registration (kept)
   - `await import('../engine/unified-engine')` -- dynamic import for UnifiedEngine class
   - `await import('../engine-adapters/production')` -- dynamic import for adapter factory
   - `createProductionAdapters({ workspaceId, conversationId, phoneNumber })` -- creates all 5 adapters
   - `new UnifiedEngine(adapters, { workspaceId })` -- instantiate engine with adapters + config

2. **Added EngineOutput-to-SomnioEngineResult mapping** for backward compatibility:
   - All fields mapped 1:1 (success, response, messagesSent, orderCreated, orderId, contactId, newMode, tokensUsed, sessionId)
   - Error mapping with `retryable ?? true` default (EngineOutput has optional retryable; SomnioEngineResult requires it)

3. **Added type import:** `import type { EngineOutput } from '../engine/types'`

4. **Updated comments and error message** to reference UnifiedEngine instead of SomnioEngine

**Unchanged (verified):**
- `ProcessMessageInput` interface: exact same 5 fields
- Return type: `Promise<SomnioEngineResult>`
- Steps 1-5: agent check, conversation fetch, auto-contact creation, typing start, timestamp
- Steps 7-9: typing stop, sent_by_agent marking, handoff workflow
- `autoCreateContact()` helper function
- All logging structure

## Deviations from Plan

None -- plan executed exactly as written.

## Decisions Made

1. **Dynamic import path:** Used `../engine/unified-engine` (direct file) instead of `../engine` (barrel) because Plan 04 (running in parallel) hasn't added UnifiedEngine to the barrel export yet. This ensures compilation works now and at runtime once Plan 04 merges.

2. **EngineOutput type import:** Used static `import type { EngineOutput } from '../engine/types'` for the type annotation, since the types file already exists (Plan 01). The runtime class uses dynamic import.

3. **Retryable default:** `engineOutput.error.retryable ?? true` ensures backward compatibility since EngineOutput.error.retryable is optional (boolean | undefined) but SomnioEngineResult.error.retryable is required (boolean).

## Verification Results

| Check | Result |
|-------|--------|
| `npx tsc --noEmit` passes | Yes (only .next/ auto-gen errors) |
| ProcessMessageInput unchanged | Yes (lines 33-39, same 5 fields) |
| Return type SomnioEngineResult | Yes (line 53) |
| Dynamic imports used | Yes (lines 159, 162, 163) |
| agent-production.ts compiles | Yes (no errors) |

## Next Phase Readiness

Plan 06 (cleanup and integration tests) can proceed. The production webhook path is now wired through UnifiedEngine. Once Plan 04 commits the actual UnifiedEngine class and updates the barrel, the full production flow will be functional end-to-end.
