---
phase: "08.2"
plan: "01"
title: "Quick replies con soporte de media (fotos)"
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/20260131000004_quick_replies_media.sql
  - src/app/actions/quick-replies.ts
  - src/app/(dashboard)/configuracion/whatsapp/quick-replies/components/quick-reply-form.tsx
  - src/app/(dashboard)/configuracion/whatsapp/quick-replies/components/quick-reply-list.tsx
  - src/app/(dashboard)/whatsapp/components/quick-reply-autocomplete.tsx
  - src/app/(dashboard)/whatsapp/components/message-input.tsx
  - src/lib/whatsapp/types.ts
autonomous: true
estimated_effort: "30 minutes"
---

# Plan 08.2-01: Quick Replies con Media

## Objective

Permitir que las quick replies incluyan una imagen adjunta opcional. Cuando el usuario selecciona una quick reply con imagen, se debe enviar primero la imagen y luego el texto (o imagen con caption si es posible).

## Current State

- Quick replies tienen: shortcut, content (texto), category
- No hay campo para media/imagen
- Supabase Storage ya est√° configurado (usado para media en chat)
- sendMediaMessage ya existe en messages.ts

## Tasks

<task id="1">
<title>Crear migracion para agregar columna media_url</title>
<type>create</type>
<file>supabase/migrations/20260131000004_quick_replies_media.sql</file>
<action>
```sql
-- Add media support to quick replies
ALTER TABLE quick_replies ADD COLUMN media_url TEXT;
ALTER TABLE quick_replies ADD COLUMN media_type TEXT; -- image, video, document, audio

COMMENT ON COLUMN quick_replies.media_url IS 'URL of attached media file in Supabase Storage';
COMMENT ON COLUMN quick_replies.media_type IS 'Type of media: image, video, document, audio';
```
</action>
<verification>
- Migration file exists
- Columns added to table
</verification>
</task>

<task id="2">
<title>Actualizar tipo QuickReply</title>
<type>edit</type>
<file>src/lib/whatsapp/types.ts</file>
<action>
Agregar campos media_url y media_type al tipo QuickReply si existe ahi, o actualizar en quick-replies.ts
</action>
<verification>
- Tipo incluye media_url: string | null
- Tipo incluye media_type: string | null
</verification>
</task>

<task id="3">
<title>Actualizar Server Actions para soportar media</title>
<type>edit</type>
<file>src/app/actions/quick-replies.ts</file>
<action>
1. Actualizar interface QuickReply con media_url y media_type
2. Actualizar createQuickReply para aceptar media_url y media_type
3. Actualizar updateQuickReply para aceptar media_url y media_type
4. Crear funcion uploadQuickReplyMedia para subir imagen a Storage
5. Crear funcion deleteQuickReplyMedia para eliminar imagen
</action>
<verification>
- createQuickReply acepta parametro media_url
- updateQuickReply acepta parametro media_url
- uploadQuickReplyMedia sube a bucket 'whatsapp-media' (existente)
</verification>
</task>

<task id="4">
<title>Actualizar formulario de quick reply con upload de imagen</title>
<type>edit</type>
<file>src/app/(dashboard)/configuracion/whatsapp/quick-replies/components/quick-reply-form.tsx</file>
<action>
1. Agregar input type="file" para seleccionar imagen
2. Mostrar preview de imagen seleccionada
3. Al guardar: subir imagen primero, luego crear/actualizar quick reply con media_url
4. Boton para remover imagen
5. Mostrar imagen existente en modo edicion
</action>
<verification>
- Input file acepta imagenes
- Preview se muestra al seleccionar
- Imagen se sube a Storage al guardar
</verification>
</task>

<task id="5">
<title>Actualizar lista de quick replies para mostrar thumbnail</title>
<type>edit</type>
<file>src/app/(dashboard)/configuracion/whatsapp/quick-replies/components/quick-reply-list.tsx</file>
<action>
1. Mostrar thumbnail de imagen en cada card si existe media_url
2. Indicador visual de que tiene media adjunta
</action>
<verification>
- Cards muestran thumbnail si hay imagen
- Icono indica presencia de media
</verification>
</task>

<task id="6">
<title>Actualizar autocomplete para mostrar preview de media</title>
<type>edit</type>
<file>src/app/(dashboard)/whatsapp/components/quick-reply-autocomplete.tsx</file>
<action>
1. Mostrar thumbnail en dropdown de sugerencias si quick reply tiene imagen
2. Pasar media_url junto con content al seleccionar
</action>
<verification>
- Dropdown muestra thumbnail junto al texto
- selectSuggestion pasa media_url
</verification>
</task>

<task id="7">
<title>Actualizar message-input para enviar media + texto</title>
<type>edit</type>
<file>src/app/(dashboard)/whatsapp/components/message-input.tsx</file>
<action>
1. Recibir media_url de quick reply seleccionado
2. Si hay media_url: enviar imagen con caption (texto)
3. Usar sendMediaMessage existente con caption
</action>
<verification>
- Quick reply con imagen envia imagen+texto
- Quick reply sin imagen envia solo texto (comportamiento actual)
</verification>
</task>

## Verification Criteria

- [ ] Columnas media_url y media_type existen en quick_replies
- [ ] Formulario permite subir imagen
- [ ] Preview de imagen visible en formulario
- [ ] Lista muestra thumbnails
- [ ] Autocomplete muestra thumbnails
- [ ] Al usar quick reply con imagen, se envia imagen con caption

## must_haves

1. User can upload image when creating quick reply
2. Image preview shown in form
3. Quick reply with image sends image+text when used
4. Existing quick replies (text-only) continue working
