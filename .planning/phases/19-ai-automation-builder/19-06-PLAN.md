---
phase: 19-ai-automation-builder
plan: 06
type: execute
wave: 3
depends_on: ["19-01", "19-04"]
files_modified:
  - src/app/(dashboard)/automatizaciones/builder/components/automation-preview.tsx
  - src/app/(dashboard)/automatizaciones/builder/components/preview-nodes.tsx
  - src/app/(dashboard)/automatizaciones/builder/components/confirmation-buttons.tsx
autonomous: true

must_haves:
  truths:
    - "React Flow diagram renders inline in chat with custom node types"
    - "Diagram is read-only: no dragging, connecting, or selecting"
    - "Invalid resource nodes have red border and warning icon"
    - "Confirmation buttons appear below the diagram"
  artifacts:
    - path: "src/app/(dashboard)/automatizaciones/builder/components/automation-preview.tsx"
      provides: "React Flow diagram wrapper with dynamic import (SSR-safe)"
      min_lines: 40
    - path: "src/app/(dashboard)/automatizaciones/builder/components/preview-nodes.tsx"
      provides: "Custom React Flow node components for trigger, condition, and action"
      min_lines: 80
    - path: "src/app/(dashboard)/automatizaciones/builder/components/confirmation-buttons.tsx"
      provides: "Crear/Modificar buttons below diagram"
      min_lines: 30
  key_links:
    - from: "src/app/(dashboard)/automatizaciones/builder/components/automation-preview.tsx"
      to: "@xyflow/react"
      via: "ReactFlow component with custom nodeTypes"
      pattern: "ReactFlow"
    - from: "src/app/(dashboard)/automatizaciones/builder/components/automation-preview.tsx"
      to: "@xyflow/react/dist/style.css"
      via: "CSS import for React Flow styling"
      pattern: "style\\.css"
---

<objective>
Create the React Flow diagram preview component with custom node types for triggers, conditions, and actions. The diagram renders inline in chat messages when the generatePreview tool returns results. Includes confirmation buttons for creating or modifying the automation.

Purpose: The visual preview is the core UX of the builder — the user sees their automation as a flowchart before confirming.
Output: Read-only React Flow diagram with styled custom nodes and action buttons.
</objective>

<execution_context>
@/home/jose147/.claude/get-shit-done/workflows/execute-plan.md
@/home/jose147/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/19-ai-automation-builder/19-01-PLAN.md
@.planning/phases/19-ai-automation-builder/19-04-PLAN.md
@src/lib/builder/types.ts
@src/lib/builder/diagram-generator.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create custom React Flow node components</name>
  <files>src/app/(dashboard)/automatizaciones/builder/components/preview-nodes.tsx</files>
  <action>
    Create `preview-nodes.tsx` with three custom node components for React Flow.

    Import from `@xyflow/react`:
    ```typescript
    import { Handle, Position, type NodeProps } from '@xyflow/react'
    ```
    Import icons from lucide-react: `Zap` (trigger), `GitBranch` (condition), `Play` (action), `AlertTriangle` (error).

    1. **TriggerNode** (used for type='triggerNode'):
    - Purple/violet accent color (bg-violet-50 dark:bg-violet-950 border-violet-300)
    - Zap icon top-left
    - Label text (trigger name in Spanish)
    - Category badge (CRM/WhatsApp/Tareas) small and muted
    - If trigger_config has values, show them as small key-value pairs below label
    - Bottom Handle (source) for edge connection
    - If `hasError`: red border (border-red-500), AlertTriangle icon, error message below

    2. **ConditionNode** (used for type='conditionNode'):
    - Amber/yellow accent (bg-amber-50 dark:bg-amber-950 border-amber-300)
    - GitBranch icon
    - "Condiciones" label
    - Show condition count: "N condicion(es)"
    - Top Handle (target) + Bottom Handle (source)
    - Diamond shape hint: use `rotate-45` on the border or a diamond icon

    3. **ActionNode** (used for type='actionNode'):
    - Blue/sky accent (bg-sky-50 dark:bg-sky-950 border-sky-300)
    - Play icon
    - Label text (action name in Spanish)
    - Category badge
    - If delay, show: "Esperar N minutos/horas/dias" in small text
    - Show key params (e.g., tag name, template name, pipeline) as small details
    - Top Handle (target) for edge connection
    - Bottom Handle (source) for next action
    - If `hasError`: red border, AlertTriangle icon, error message

    Shared styling for all nodes:
    - `rounded-xl shadow-sm border-2 px-4 py-3 min-w-[220px] max-w-[280px]`
    - Text: `text-sm font-medium` for label, `text-xs text-muted-foreground` for details
    - React Flow Handle components for connections (small, subtle dots)

    Export `customNodeTypes` object:
    ```typescript
    export const customNodeTypes = {
      triggerNode: TriggerNode,
      conditionNode: ConditionNode,
      actionNode: ActionNode,
    }
    ```
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - File exports customNodeTypes with 3 node components
    - Each node has Handle components for edge connections
  </verify>
  <done>
    - Three custom node types with distinct colors and icons
    - Error state with red border and warning icon
    - Handles for edge connections
    - Responsive text showing relevant configuration details
  </done>
</task>

<task type="auto">
  <name>Task 2: Create automation preview component and confirmation buttons</name>
  <files>
    src/app/(dashboard)/automatizaciones/builder/components/automation-preview.tsx
    src/app/(dashboard)/automatizaciones/builder/components/confirmation-buttons.tsx
  </files>
  <action>
    1. **AutomationPreview** (`automation-preview.tsx`):

    CRITICAL: Use `next/dynamic` with `{ ssr: false }` to avoid SSR crash. React Flow uses browser APIs.

    ```tsx
    'use client'
    import dynamic from 'next/dynamic'

    // Dynamic import to avoid SSR — React Flow requires browser APIs
    const AutomationPreviewInner = dynamic(
      () => import('./automation-preview-inner').then(mod => mod.AutomationPreviewInner),
      { ssr: false, loading: () => <DiagramSkeleton /> }
    )
    ```

    Wait — to keep it in one file, use a pattern where the ReactFlow import is inside a dynamically imported wrapper. The cleanest approach:

    Create the component that wraps ReactFlow:

    ```tsx
    // automation-preview.tsx
    'use client'
    import { ReactFlow, Background, type Node, type Edge } from '@xyflow/react'
    import '@xyflow/react/dist/style.css'
    import { customNodeTypes } from './preview-nodes'
    import { ConfirmationButtons } from './confirmation-buttons'
    import { AlertTriangle } from 'lucide-react'
    import type { AutomationPreviewData } from '@/lib/builder/types'
    ```

    Props:
    ```typescript
    interface AutomationPreviewProps {
      data: AutomationPreviewData
      onConfirm: () => void
      onModify: () => void
      isUpdate?: boolean
    }
    ```

    Render:
    - Container: `w-full rounded-lg border bg-background overflow-hidden`
    - Header bar: Automation name + description in a small banner
    - React Flow area: fixed height `h-[300px]` (or dynamic based on node count: min 200, +80 per node)
    - ReactFlow props for read-only:
      ```
      fitView
      nodesDraggable={false}
      nodesConnectable={false}
      elementsSelectable={false}
      panOnDrag={false}
      zoomOnScroll={false}
      zoomOnPinch={false}
      zoomOnDoubleClick={false}
      preventScrolling={false}
      proOptions={{ hideAttribution: true }}
      ```
    - Background grid: `<Background gap={16} size={1} />`
    - Validation warnings section: If data.resourceValidations has items with found=false, show a warning banner below the diagram with the list of issues
    - Cycle warning: If data.hasCycles, show a red banner: "Se detecto un ciclo en las automatizaciones. No se puede crear hasta resolver."
    - Duplicate warning: If data.duplicateWarning, show an amber banner with the warning text
    - ConfirmationButtons at the bottom

    Then wrap this component for export with dynamic import to prevent SSR:

    Create a wrapper file or use the pattern:
    ```tsx
    // Export a dynamic-imported version for use in message rendering
    export const AutomationPreview = dynamic(
      () => Promise.resolve({ AutomationPreviewComponent }),  // or however it's structured
      { ssr: false }
    )
    ```

    Actually, the simplest approach: export the component normally from `automation-preview.tsx`, and in `builder-message.tsx` (Plan 05), use `dynamic(() => import('./automation-preview'), { ssr: false })` when importing it. This keeps the file clean.

    So: just export `AutomationPreview` as a normal component. The dynamic import wrapping happens in the consumer (builder-message.tsx). Add a TODO comment at the top: `// Import this component with dynamic({ ssr: false }) — see builder-message.tsx`

    2. **ConfirmationButtons** (`confirmation-buttons.tsx`):

    Props: `{ onConfirm, onModify, isUpdate?, disabled? }`

    Render:
    - Container: `flex items-center gap-3 p-3 border-t bg-muted/50`
    - Primary button: `isUpdate ? "Guardar cambios" : "Crear automatizacion"` — uses Button component from shadcn with default variant
    - Secondary button: "Modificar" — uses Button with outline variant
    - If `disabled` (e.g., has cycles), primary button is disabled with tooltip explaining why

    Both buttons call their respective callbacks. The callbacks will be provided by builder-message.tsx to either append a confirmation message to the chat or focus the input for modifications.
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - AutomationPreview renders ReactFlow with custom node types
    - ConfirmationButtons shows two buttons
    - React Flow CSS is imported
    - Component includes read-only props (no drag/connect/select)
  </verify>
  <done>
    - React Flow diagram renders with custom nodes (trigger=purple, condition=amber, action=blue)
    - Read-only: no interaction possible on the diagram
    - Validation warnings displayed below diagram
    - Cycle detection blocks creation with red banner
    - Confirmation buttons provide Crear/Modificar actions
  </done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` passes
- All 3 component files exist
- customNodeTypes exports 3 React Flow node types
- AutomationPreview is read-only (no drag/connect)
- React Flow CSS imported
</verification>

<success_criteria>
Flowchart diagram renders with custom styled nodes for trigger/condition/action. Diagram is fully read-only. Invalid resources show red borders and warnings. Confirmation buttons enable the create/modify workflow. Components are SSR-safe via dynamic import strategy.
</success_criteria>

<output>
After completion, create `.planning/phases/19-ai-automation-builder/19-06-SUMMARY.md`
</output>
