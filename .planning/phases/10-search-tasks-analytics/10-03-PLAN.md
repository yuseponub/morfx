---
phase: 10-search-tasks-analytics
plan: 03
type: execute
wave: 3
depends_on: ["10-02"]
files_modified:
  - src/components/tasks/create-task-button.tsx
  - src/app/(dashboard)/crm/contactos/[id]/components/contact-tasks.tsx
  - src/app/(dashboard)/crm/pedidos/components/order-sheet.tsx
  - src/app/(dashboard)/whatsapp/components/contact-panel.tsx
  - src/app/(dashboard)/configuracion/tareas/page.tsx
  - src/app/(dashboard)/configuracion/tareas/components/task-types-manager.tsx
  - src/components/layout/sidebar.tsx
  - src/hooks/use-task-badge.ts
autonomous: true

must_haves:
  truths:
    - "User can create task from contact detail page"
    - "User can create task from order detail sheet"
    - "User can create task from WhatsApp contact panel"
    - "Sidebar shows badge with pending/overdue task count"
    - "Admin can configure task types in settings"
  artifacts:
    - path: "src/components/tasks/create-task-button.tsx"
      provides: "Contextual task creation button"
      exports: ["CreateTaskButton"]
    - path: "src/app/(dashboard)/configuracion/tareas/page.tsx"
      provides: "Task settings page"
      contains: "TaskTypesManager"
    - path: "src/hooks/use-task-badge.ts"
      provides: "Hook for task badge count"
      exports: ["useTaskBadge"]
  key_links:
    - from: "create-task-button.tsx"
      to: "task-form.tsx"
      via: "Opens task form with pre-filled entity"
      pattern: "contact_id|order_id|conversation_id"
    - from: "sidebar.tsx"
      to: "use-task-badge.ts"
      via: "Badge count display"
      pattern: "useTaskBadge"
---

<objective>
Integrate task creation across the application and add task settings management.

Purpose: Users can create tasks contextually from contacts, orders, and conversations. The sidebar shows pending task notifications. Admins can customize task types.

Output: Contextual task buttons, sidebar badge, task settings page.
</objective>

<execution_context>
@/home/jose147/.claude/get-shit-done/workflows/execute-plan.md
@/home/jose147/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/10-search-tasks-analytics/10-CONTEXT.md
@.planning/phases/10-search-tasks-analytics/10-02-SUMMARY.md

# Files to integrate with
@src/app/(dashboard)/crm/contactos/[id]/page.tsx
@src/app/(dashboard)/crm/pedidos/components/order-sheet.tsx
@src/app/(dashboard)/whatsapp/components/contact-panel.tsx
@src/components/layout/sidebar.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create contextual task creation components</name>
  <files>
    src/components/tasks/create-task-button.tsx
    src/app/(dashboard)/crm/contactos/[id]/components/contact-tasks.tsx
    src/app/(dashboard)/crm/pedidos/components/order-sheet.tsx
    src/app/(dashboard)/whatsapp/components/contact-panel.tsx
  </files>
  <action>
**1. src/components/tasks/create-task-button.tsx**

Reusable button that opens task form with pre-filled entity:

```tsx
'use client'

interface CreateTaskButtonProps {
  // Pre-fill entity link (at most one)
  contactId?: string
  contactName?: string
  orderId?: string
  orderInfo?: string // e.g., "Pedido #123 - $50,000"
  conversationId?: string
  conversationPhone?: string

  // Styling
  variant?: 'default' | 'outline' | 'ghost'
  size?: 'sm' | 'default'
  className?: string
}

export function CreateTaskButton({
  contactId,
  contactName,
  orderId,
  orderInfo,
  conversationId,
  conversationPhone,
  variant = 'outline',
  size = 'sm',
  className
}: CreateTaskButtonProps) {
  // Renders button with ListTodo icon
  // Opens Sheet with TaskForm, passing entity props
  // Shows linked entity as read-only badge in form
}
```

Include:
- ListTodo icon from lucide-react
- Tooltip "Crear tarea"
- Opens TaskForm in Sheet with entity pre-filled
- Entity displayed as badge in form header (e.g., "Vinculada a: Juan Perez")

**2. src/app/(dashboard)/crm/contactos/[id]/components/contact-tasks.tsx**

New component showing tasks linked to this contact:
- List of tasks filtered by contact_id
- CreateTaskButton with contactId pre-filled
- If no tasks, show "Sin tareas" with create button
- Add to contact detail page tabs (new tab "Tareas")

**3. Update order-sheet.tsx**

Add CreateTaskButton in the order sheet header/actions area:
- Pass orderId and order summary info
- Small icon button next to existing actions

**4. Update contact-panel.tsx (WhatsApp)**

Add CreateTaskButton in the contact panel:
- Pass conversationId and phone
- Place near "Ver en CRM" link
- Only show if conversation has contact linked

All buttons should:
- Use consistent styling (outline variant, sm size)
- Show tooltip on hover
- Pre-fill the task form with entity context
  </action>
  <verify>
1. Contact detail /crm/contactos/[id] - "Tareas" tab shows and CreateTaskButton works
2. Order sheet - task button visible, creates task linked to order
3. WhatsApp contact panel - task button creates task linked to conversation
  </verify>
  <done>
Contextual task creation available from all three entity contexts.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add sidebar badge and task settings</name>
  <files>
    src/hooks/use-task-badge.ts
    src/components/layout/sidebar.tsx
    src/app/(dashboard)/configuracion/tareas/page.tsx
    src/app/(dashboard)/configuracion/tareas/components/task-types-manager.tsx
  </files>
  <action>
**1. src/hooks/use-task-badge.ts**

Hook that fetches task summary for badge display:

```tsx
'use client'

import { useEffect, useState, useCallback } from 'react'
import { getTaskSummary } from '@/app/actions/tasks'
import type { TaskSummary } from '@/lib/tasks/types'

export function useTaskBadge() {
  const [summary, setSummary] = useState<TaskSummary | null>(null)
  const [loading, setLoading] = useState(true)

  const refresh = useCallback(async () => {
    const result = await getTaskSummary()
    setSummary(result)
    setLoading(false)
  }, [])

  useEffect(() => {
    refresh()
    // Refresh every 5 minutes
    const interval = setInterval(refresh, 5 * 60 * 1000)
    return () => clearInterval(interval)
  }, [refresh])

  // Badge count = overdue + dueSoon
  const badgeCount = summary ? summary.overdue + summary.dueSoon : 0

  return {
    summary,
    badgeCount,
    loading,
    refresh
  }
}
```

**2. Update sidebar.tsx**

Add Tareas nav item with badge:

```tsx
const navItems = [
  { href: '/crm', label: 'CRM', icon: Building2 },
  { href: '/whatsapp', label: 'WhatsApp', icon: MessageSquare },
  { href: '/tareas', label: 'Tareas', icon: ListTodo, badge: true }, // NEW
  { href: '/settings/workspace/members', label: 'Equipo', icon: Users },
  { href: '/settings', label: 'Configuracion', icon: Settings },
]
```

For the Tareas item:
- Import ListTodo from lucide-react
- Use useTaskBadge hook
- Show red badge with count if badgeCount > 0
- Badge should match unread messages badge styling

Position: After WhatsApp, before Equipo (per CONTEXT.md).

**3. src/app/(dashboard)/configuracion/tareas/page.tsx**

Task settings page:
- Header: "Configuracion de Tareas"
- Section: Task types management
- Future: reminder settings, required fields (can be placeholder)

```tsx
export default async function TareasConfigPage() {
  const taskTypes = await getTaskTypes()

  return (
    <div className="container py-6 space-y-8">
      <div>
        <h1 className="text-2xl font-bold">Configuracion de Tareas</h1>
        <p className="text-muted-foreground">
          Personaliza los tipos de tarea y opciones
        </p>
      </div>

      <TaskTypesManager initialTypes={taskTypes} />

      {/* Future: reminder settings */}
      <Card className="p-6">
        <h2 className="font-semibold mb-2">Recordatorios</h2>
        <p className="text-sm text-muted-foreground">
          Proximamente: configura cuando recibir notificaciones de tareas.
        </p>
      </Card>
    </div>
  )
}
```

**4. src/app/(dashboard)/configuracion/tareas/components/task-types-manager.tsx**

Task type CRUD following pipelines/stage-manager pattern:
- List of task types with color indicators
- Add new type button
- Edit name and color inline or in dialog
- Delete with confirmation
- Drag to reorder using @dnd-kit (same pattern as stage-manager)

Colors: Use existing TAG_COLORS from tag system for consistency.
  </action>
  <verify>
1. Sidebar shows "Tareas" with badge count when tasks are overdue/due soon
2. Badge updates after completing tasks (may need refresh)
3. /configuracion/tareas page renders
4. Can create, edit, delete, and reorder task types
  </verify>
  <done>
Sidebar has Tareas link with notification badge. Settings page allows task type customization.
  </done>
</task>

</tasks>

<verification>
1. Create task from contact detail - task appears linked to contact
2. Create task from order sheet - task appears linked to order
3. Create task from WhatsApp panel - task appears linked to conversation
4. Sidebar badge shows correct count
5. Task types can be managed in settings
6. Navigation order matches CONTEXT.md specification
</verification>

<success_criteria>
- [ ] CreateTaskButton works from all three entity contexts
- [ ] Tasks created are properly linked to entities
- [ ] Sidebar shows Tareas with badge
- [ ] Badge count reflects overdue + dueSoon
- [ ] Task types settings page functional
- [ ] Task types can be created, edited, deleted, reordered
</success_criteria>

<output>
After completion, create `.planning/phases/10-search-tasks-analytics/10-03-SUMMARY.md`
</output>
