---
phase: 19-ai-automation-builder
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/builder/system-prompt.ts
  - src/lib/builder/tools.ts
autonomous: true

must_haves:
  truths:
    - "System prompt includes complete TRIGGER_CATALOG, ACTION_CATALOG, and VARIABLE_CATALOG knowledge"
    - "System prompt instructs agent to warn about missing resources but NOT auto-create"
    - "Tool definitions cover resource lookup, automation preview, and CRUD"
  artifacts:
    - path: "src/lib/builder/system-prompt.ts"
      provides: "BUILDER_SYSTEM_PROMPT with catalog knowledge and behavioral rules"
      min_lines: 100
    - path: "src/lib/builder/tools.ts"
      provides: "Builder tool definitions for AI SDK streamText"
      min_lines: 150
  key_links:
    - from: "src/lib/builder/system-prompt.ts"
      to: "src/lib/automations/constants.ts"
      via: "imports TRIGGER_CATALOG, ACTION_CATALOG, VARIABLE_CATALOG"
      pattern: "import.*from.*automations/constants"
    - from: "src/lib/builder/tools.ts"
      to: "src/lib/supabase/admin.ts"
      via: "createAdminClient for DB queries"
      pattern: "createAdminClient"
---

<objective>
Create the system prompt and tool definitions for the AI Automation Builder agent. The system prompt injects the full automation catalog so the agent understands available triggers, actions, conditions, and variables. The tools provide server-side resource lookup and automation CRUD.

Purpose: Define the agent's knowledge base and capabilities — the brain of the builder.
Output: System prompt with catalog knowledge, tool definitions with execute functions.
</objective>

<execution_context>
@/home/jose147/.claude/get-shit-done/workflows/execute-plan.md
@/home/jose147/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/lib/automations/types.ts
@src/lib/automations/constants.ts
@src/app/actions/automations.ts
@src/lib/supabase/admin.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create builder system prompt</name>
  <files>src/lib/builder/system-prompt.ts</files>
  <action>
    Create `src/lib/builder/system-prompt.ts` that exports `buildSystemPrompt(workspaceId: string): string`.

    The system prompt must include:

    1. **Role definition** (in Spanish since the CRM is Spanish-facing):
       - "Eres un asistente experto en automatizaciones de CRM."
       - "Tu trabajo es ayudar al usuario a crear, modificar, y entender automatizaciones."
       - "Respondes en espanol siempre."

    2. **Behavioral rules**:
       - Ask when information is ambiguous — do NOT infer defaults silently
       - When listing resources for the user to choose, present them in a numbered list
       - NEVER auto-create resources (tags, stages, etc.) — only WARN about missing ones
       - NEVER activate or deactivate automations — tell the user to do it manually
       - NEVER delete automations — tell the user to do it from the UI
       - After creating an automation, inform: "Tu automatizacion esta creada pero DESACTIVADA. Ve a verificarla y activala cuando estes listo."
       - Include a direct link format: `/automatizaciones/{id}/editar`
       - Do NOT suggest automation ideas proactively
       - For modifications: only change what the user asks, regenerate full preview
       - Every change (create or modify) requires showing preview diagram and user confirmation before executing

    3. **Catalog knowledge** — Inject the full catalogs from `src/lib/automations/constants.ts`:
       - Import TRIGGER_CATALOG, ACTION_CATALOG, VARIABLE_CATALOG
       - Format them as readable text in the system prompt with Spanish labels
       - Group triggers by category (CRM, WhatsApp, Tareas)
       - Group actions by category
       - Show available variables per trigger type

    4. **Tool usage instructions**:
       - Use `listPipelines` when user mentions pipelines, stages, or etapas
       - Use `listTags` when user mentions tags or etiquetas
       - Use `listTemplates` when user mentions templates or plantillas de WhatsApp
       - Use `listAutomations` when user wants to see existing automations or modify one
       - Use `getAutomation` to load details of a specific automation
       - Use `generatePreview` after gathering enough info to show a diagram
       - Use `createAutomation` ONLY after user confirms the preview
       - Use `updateAutomation` ONLY after user confirms the modified preview
       - NEVER call create/update without showing a preview first

    5. **Validation instructions**:
       - Always validate resources exist before including in preview
       - Mark invalid resources in the preview with error messages
       - Check for duplicate automations (same trigger_type + trigger_config) and warn
       - Check for cycles (automation A triggers B which triggers A) and BLOCK creation

    6. **Conversation style**:
       - Concise but clear
       - Use bullet points for lists
       - Confirm understanding before generating preview
       - After creation: summary + link + reminder about manual activation

    The function should build the string dynamically incorporating the catalog data, not hardcode it. This way if catalogs change, the prompt updates automatically.
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - The file imports from `@/lib/automations/constants`
    - The exported function returns a string containing trigger and action catalog info
  </verify>
  <done>
    - System prompt contains all 10 trigger types, 11 action types, and variable catalog
    - Behavioral rules enforce: no auto-create, no activate/deactivate, preview required
    - Prompt is in Spanish
  </done>
</task>

<task type="auto">
  <name>Task 2: Create builder tool definitions</name>
  <files>src/lib/builder/tools.ts</files>
  <action>
    Create `src/lib/builder/tools.ts` that exports `createBuilderTools(ctx: BuilderToolContext)` returning an object of AI SDK tool definitions.

    Import `z` from `zod`, `createAdminClient` from `@/lib/supabase/admin`, and types from `@/lib/builder/types`.

    Define these tools with `description`, `parameters` (Zod schema), and `execute` (async function):

    1. **listPipelines**: No params. Queries `pipelines` + `pipeline_stages` for the workspace. Returns array of `{id, name, stages: [{id, name, color, position}]}`. Uses `createAdminClient()` with workspace_id filter.

    2. **listTags**: No params. Queries `tags` for the workspace. Returns array of `{id, name, color}`.

    3. **listTemplates**: No params. Queries `whatsapp_templates` for the workspace. Returns array of `{name, status, language, components}`. Include the Meta approval status so the agent can warn about unapproved templates.

    4. **listAutomations**: No params. Queries `automations` for the workspace. Returns array of `{id, name, trigger_type, is_enabled, actions_count}`. Lightweight list (no full actions/conditions).

    5. **getAutomation**: Params: `{automationId: z.string().optional(), name: z.string().optional()}`. Queries `automations` by ID or name (ilike) for the workspace. Returns full automation data including trigger_config, conditions, and actions. If name is used and multiple match, return all matches so agent can ask user which one.

    6. **listWorkspaceMembers**: No params. Queries `workspace_members` joined with `auth.users` (or just profiles) for the workspace. Returns `{id, email}[]`. Needed for `create_task` action's `assignToUserId` param.

    7. **generatePreview**: Params: `{name: z.string(), description: z.string().optional(), trigger_type: z.string(), trigger_config: z.record(z.string(), z.unknown()).optional(), conditions: z.any().nullable().optional(), actions: z.array(z.object({type: z.string(), params: z.record(z.string(), z.unknown()), delay: z.any().nullable().optional()}))}`. This tool:
       a. Validates all referenced resources exist in the workspace (pipelines, stages, tags, templates)
       b. Checks for automation cycles (query existing automations, build adjacency graph, DFS)
       c. Checks for duplicates (same trigger_type + trigger_config among existing automations)
       d. Returns `AutomationPreviewData` (the validated form data + diagram nodes/edges + validations + warnings)
       NOTE: The diagram generation itself (nodes/edges) will be handled in Plan 04. For now, return the validation results and form data. The actual DiagramData field can return empty arrays — Plan 04 will add the real diagram generation.

    8. **createAutomation**: Params matching AutomationFormData shape. Calls the existing `createAutomation` server action logic (but NOT the server action itself since we're in an API route, not a server action context). Instead, use `createAdminClient()` to insert directly into `automations` table with proper workspace_id, created_by, and is_enabled=false. Returns `{success: true, automationId: string}` or `{success: false, error: string}`.

    9. **updateAutomation**: Params: `{automationId: z.string(), ...AutomationFormData fields}`. Updates via `createAdminClient()` with workspace ownership check. Returns success/error.

    Each tool's `execute` function receives the parsed params. The `ctx` (BuilderToolContext with workspaceId, userId) is captured via closure when `createBuilderTools(ctx)` is called.

    IMPORTANT: All queries MUST filter by `ctx.workspaceId` for workspace isolation. Use `createAdminClient()` (not the user's supabase client) since this runs in an API route context.

    Handle errors gracefully — return error messages the agent can relay to the user, never throw uncaught exceptions.
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - File exports `createBuilderTools` function
    - Each tool has description, parameters (Zod), and execute function
    - All DB queries filter by workspace_id
  </verify>
  <done>
    - 9 tools defined: listPipelines, listTags, listTemplates, listAutomations, getAutomation, listWorkspaceMembers, generatePreview, createAutomation, updateAutomation
    - All tools use createAdminClient with workspace isolation
    - generatePreview validates resources and checks for cycles/duplicates
    - create/update tools insert with is_enabled=false
  </done>
</task>

</tasks>

<verification>
- Both files exist and export their main functions
- TypeScript compiles: `npx tsc --noEmit`
- System prompt contains catalog data (trigger types, action types)
- Tools file defines 9 tools with Zod schemas
</verification>

<success_criteria>
System prompt dynamically incorporates all automation catalogs. Nine tools defined with proper workspace isolation. TypeScript compiles.
</success_criteria>

<output>
After completion, create `.planning/phases/19-ai-automation-builder/19-02-SUMMARY.md`
</output>
