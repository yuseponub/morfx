---
phase: 10.1-task-notes-history
plan: 04
type: execute
wave: 4
depends_on: ["10.1-03"]
files_modified:
  - src/app/(dashboard)/tareas/[id]/page.tsx
  - src/app/(dashboard)/tareas/components/task-detail-sheet.tsx
autonomous: false
user_setup: []

must_haves:
  truths:
    - "User can view notes on a task detail page/sheet"
    - "User can add notes from task detail"
    - "User can view complete change history for a task"
    - "Task detail shows postponement indicator"
  artifacts:
    - path: "src/app/(dashboard)/tareas/[id]/page.tsx"
      provides: "Task detail page with notes and history tabs"
      contains: "TaskNotesSection"
    - path: "src/app/(dashboard)/tareas/components/task-detail-sheet.tsx"
      provides: "Sheet view with notes and history"
      exports: ["TaskDetailSheet"]
  key_links:
    - from: "task detail page"
      to: "src/components/tasks/task-notes.tsx"
      via: "TaskNotesSection component"
      pattern: "TaskNotesSection"
    - from: "task detail page"
      to: "src/components/tasks/task-history.tsx"
      via: "TaskHistoryTimeline component"
      pattern: "TaskHistoryTimeline"
---

<objective>
Create task detail view with notes section and history timeline as tabs.

Purpose: Users can view and manage task notes and see the complete change history, including all postponements. The detail view follows the contact detail page pattern with tabbed interface.

Output: Task detail page or sheet with Info, Notas, and Historial tabs showing comprehensive task information.
</objective>

<execution_context>
@/home/jose147/.claude/get-shit-done/workflows/execute-plan.md
@/home/jose147/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10.1-task-notes-history/10.1-RESEARCH.md
@.planning/phases/10.1-task-notes-history/10.1-03-SUMMARY.md

# Key reference files
@src/app/(dashboard)/crm/contactos/[id]/page.tsx
@src/app/(dashboard)/tareas/page.tsx
@src/app/(dashboard)/tareas/components/task-form.tsx
@src/components/tasks/task-notes.tsx
@src/components/tasks/task-history.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create or update task detail view</name>
  <files>src/app/(dashboard)/tareas/[id]/page.tsx, src/app/(dashboard)/tareas/components/task-detail-sheet.tsx</files>
  <action>
First, check if there's an existing task detail pattern in the codebase. The task system may use:
- A dedicated page at /tareas/[id]
- A Sheet component opened from the task list
- An expandable row in the task list

Read the existing task-list.tsx and task-form.tsx to understand how task details are currently displayed.

**Option A: If using Sheet pattern (like orders)**

Create/update `src/app/(dashboard)/tareas/components/task-detail-sheet.tsx`:

```typescript
'use client'

import * as React from 'react'
import {
  Sheet,
  SheetContent,
  SheetHeader,
  SheetTitle,
} from '@/components/ui/sheet'
import { Tabs, TabsContent, TabsList, TabsTrigger } from '@/components/ui/tabs'
import { TaskNotesSection } from '@/components/tasks/task-notes'
import { TaskHistoryTimeline } from '@/components/tasks/task-history'
import { PostponementBadge } from '@/components/tasks/postponement-badge'
import { getTaskNotes } from '@/app/actions/task-notes'
import { getTaskActivity } from '@/app/actions/task-activity'
import type { TaskWithDetails, TaskNoteWithUser, TaskActivityWithUser } from '@/lib/tasks/types'

interface TaskDetailSheetProps {
  task: TaskWithDetails | null
  open: boolean
  onOpenChange: (open: boolean) => void
  currentUserId?: string
  isAdminOrOwner?: boolean
}

export function TaskDetailSheet({
  task,
  open,
  onOpenChange,
  currentUserId,
  isAdminOrOwner = false,
}: TaskDetailSheetProps) {
  const [notes, setNotes] = React.useState<TaskNoteWithUser[]>([])
  const [activities, setActivities] = React.useState<TaskActivityWithUser[]>([])
  const [loading, setLoading] = React.useState(false)

  // Load notes and activities when task changes
  React.useEffect(() => {
    if (task && open) {
      setLoading(true)
      Promise.all([
        getTaskNotes(task.id),
        getTaskActivity(task.id),
      ]).then(([notesData, activitiesData]) => {
        setNotes(notesData)
        setActivities(activitiesData)
        setLoading(false)
      })
    }
  }, [task?.id, open])

  if (!task) return null

  return (
    <Sheet open={open} onOpenChange={onOpenChange}>
      <SheetContent className="sm:max-w-[600px] flex flex-col h-full">
        <SheetHeader>
          <SheetTitle className="flex items-center gap-2">
            {task.title}
            <PostponementBadge count={task.postponement_count} />
          </SheetTitle>
        </SheetHeader>

        <Tabs defaultValue="info" className="flex-1 flex flex-col min-h-0">
          <TabsList className="grid w-full grid-cols-3">
            <TabsTrigger value="info">Info</TabsTrigger>
            <TabsTrigger value="notes">
              Notas {notes.length > 0 && `(${notes.length})`}
            </TabsTrigger>
            <TabsTrigger value="history">Historial</TabsTrigger>
          </TabsList>

          <TabsContent value="info" className="flex-1 overflow-y-auto">
            {/* Task info: description, due date, priority, type, assigned, linked entity */}
            <TaskInfoSection task={task} />
          </TabsContent>

          <TabsContent value="notes" className="flex-1 overflow-y-auto">
            {loading ? (
              <div className="animate-pulse space-y-4 p-4">
                <div className="h-20 bg-muted rounded" />
                <div className="h-20 bg-muted rounded" />
              </div>
            ) : (
              <TaskNotesSection
                taskId={task.id}
                initialNotes={notes}
                currentUserId={currentUserId}
                isAdminOrOwner={isAdminOrOwner}
              />
            )}
          </TabsContent>

          <TabsContent value="history" className="flex-1 overflow-y-auto">
            {loading ? (
              <div className="animate-pulse space-y-4 p-4">
                <div className="h-16 bg-muted rounded" />
                <div className="h-16 bg-muted rounded" />
              </div>
            ) : (
              <TaskHistoryTimeline activities={activities} />
            )}
          </TabsContent>
        </Tabs>
      </SheetContent>
    </Sheet>
  )
}

// Helper component for task info display
function TaskInfoSection({ task }: { task: TaskWithDetails }) {
  return (
    <div className="space-y-4 p-4">
      {task.description && (
        <div>
          <h4 className="text-sm font-medium text-muted-foreground mb-1">Descripcion</h4>
          <p className="text-sm whitespace-pre-wrap">{task.description}</p>
        </div>
      )}
      {task.due_date && (
        <div>
          <h4 className="text-sm font-medium text-muted-foreground mb-1">Fecha limite</h4>
          <p className="text-sm">
            {new Date(task.due_date).toLocaleString('es-CO', {
              dateStyle: 'full',
              timeStyle: 'short',
              timeZone: 'America/Bogota',
            })}
          </p>
        </div>
      )}
      {task.task_type && (
        <div>
          <h4 className="text-sm font-medium text-muted-foreground mb-1">Tipo</h4>
          <div className="flex items-center gap-2">
            <span
              className="h-2 w-2 rounded-full"
              style={{ backgroundColor: task.task_type.color }}
            />
            {task.task_type.name}
          </div>
        </div>
      )}
      {task.assigned_user && (
        <div>
          <h4 className="text-sm font-medium text-muted-foreground mb-1">Asignado a</h4>
          <p className="text-sm">{task.assigned_user.email}</p>
        </div>
      )}
      {(task.contact || task.order || task.conversation) && (
        <div>
          <h4 className="text-sm font-medium text-muted-foreground mb-1">Vinculada a</h4>
          <p className="text-sm">
            {task.contact && `Contacto: ${task.contact.name}`}
            {task.order && `Pedido: $${task.order.total_value.toLocaleString()}`}
            {task.conversation && `Conversacion: ${task.conversation.phone}`}
          </p>
        </div>
      )}
    </div>
  )
}
```

**Option B: If using dedicated page pattern**

Create `src/app/(dashboard)/tareas/[id]/page.tsx` following the contact detail page pattern with server-side data fetching and tabs.

**Implementation guidance:**
1. Read task-list.tsx first to see how task details are currently accessed
2. If there's an existing detail mechanism, enhance it with tabs
3. If no detail mechanism exists, create TaskDetailSheet and integrate into task-list
4. Ensure PostponementBadge is prominent in the header/title area
  </action>
  <verify>
```bash
# Check for task detail implementation
ls -la /mnt/c/Users/Usuario/Proyectos/morfx-new/src/app/\(dashboard\)/tareas/\[id\]/ 2>/dev/null || echo "No [id] directory"
ls -la /mnt/c/Users/Usuario/Proyectos/morfx-new/src/app/\(dashboard\)/tareas/components/ | grep -i detail 2>/dev/null || echo "No detail component"
# Check for tabs integration
grep -E "(TabsList|TaskNotesSection|TaskHistoryTimeline)" /mnt/c/Users/Usuario/Proyectos/morfx-new/src/app/\(dashboard\)/tareas/**/*.tsx 2>/dev/null | head -10
```
  </verify>
  <done>
Task detail view created/updated with:
- Tabbed interface (Info, Notas, Historial)
- PostponementBadge in header
- TaskNotesSection in Notas tab
- TaskHistoryTimeline in Historial tab
- Loading states for async data
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete task notes and history system with visual postponement tracking.

The phase adds:
1. Notes on tasks (create, edit, delete)
2. Automatic change history tracking via PostgreSQL trigger
3. Postponement badge showing when due dates are moved forward
4. Task detail view with Notas and Historial tabs
  </what-built>
  <how-to-verify>
1. Start the dev server:
   ```bash
   cd /mnt/c/Users/Usuario/Proyectos/morfx-new
   pkill -f "next dev" 2>/dev/null; sleep 2; npm run dev &
   ```

2. Ensure migration is applied:
   ```bash
   pnpm supabase db push
   ```

3. Navigate to http://localhost:3020/tareas

4. **Test notes functionality:**
   - Click on a task to open detail view
   - Go to "Notas" tab
   - Add a new note - should appear immediately
   - Edit the note - changes should save
   - Delete the note - should be removed

5. **Test history functionality:**
   - Go to "Historial" tab
   - Should show "Tarea creada" entry
   - Edit the task (change title or priority)
   - History should show "Tarea actualizada" with the change
   - Add/edit/delete notes - history should show note actions

6. **Test postponement tracking:**
   - Edit task and move due date forward (to later date)
   - History should show "Fecha limite cambiada"
   - PostponementBadge should show "1x" in yellow
   - Move date forward again - should show "2x"
   - Move forward third time - badge turns red "3x"

7. **Verify all success criteria from ROADMAP:**
   - [x] User puede agregar notas a una tarea
   - [x] Sistema registra automaticamente cambios de fecha limite
   - [x] User puede ver historial de cambios en la tarea
   - [x] Se muestra indicador visual cuando tarea postergada multiples veces

Expected behavior:
- Notes CRUD works with optimistic updates
- History shows all changes with Spanish labels
- Postponement badge appears only for postponed tasks
- Yellow for 1-2, red for 3+ postponements
  </how-to-verify>
  <resume-signal>Type "approved" if all functionality works, or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
After all tasks complete:
1. Task detail view has Info, Notas, Historial tabs
2. Notes can be added, edited, deleted
3. History shows all task changes
4. Postponement badge visible in detail and list views
5. Human verification passed
</verification>

<success_criteria>
- User can add/edit/delete notes on tasks
- History timeline shows all changes with icons
- Postponement badge shows in task detail header
- Tab navigation works smoothly
- Loading states prevent UI jank
- All four ROADMAP success criteria are met
</success_criteria>

<output>
After completion, create `.planning/phases/10.1-task-notes-history/10.1-04-SUMMARY.md`
</output>
