---
milestone: v2.0 Agentes Conversacionales
audited: 2026-02-16T20:00:00-05:00
status: tech_debt
scores:
  requirements: N/A (v2 requirements not formally tracked in REQUIREMENTS.md)
  phases: 13/13 functionally complete
  phase_verifications: 6/13 formal VERIFICATION.md
  integration: 47/47 connections verified
  flows: 5/5 E2E flows verified
  learnings: 13/13
gaps:
  requirements: []
  integration: []
  flows: []
tech_debt:
  - category: missing_verifications
    items:
      - "Phase 15 (Agent Sandbox): No VERIFICATION.md, 4/5 plans (human verification plan pending)"
      - "Phase 15.5 (Somnio Ingest): No VERIFICATION.md, 3/4 plans (human verification plan pending)"
      - "Phase 15.6 (Sandbox Evolution): No VERIFICATION.md (6/6 plans complete)"
      - "Phase 15.7 (Ingest Timer): No VERIFICATION.md, 2/3 plans (human verification plan pending)"
      - "Phase 16 (WhatsApp Agent Integration): No VERIFICATION.md, 5/6 plans (human verification plan pending)"
      - "Phase 17 (CRM Automations Engine): No VERIFICATION.md (10/10 plans complete)"
      - "Phase 18 (Domain Layer Foundation): No VERIFICATION.md (10/10 plans complete)"
  - category: roadmap_inconsistency
    items:
      - "Phases 15, 15.5, 15.7, 16 still listed as 'In progress' in ROADMAP despite milestone considered complete"
      - "These phases have only human-verification plans pending (no code work remaining)"
  - category: requirements_tracking
    items:
      - "v2.0 requirements not formally defined in REQUIREMENTS.md (only v1 requirements tracked)"
      - "Phase success criteria tracked in ROADMAP.md but not REQUIREMENTS.md"
  - category: deprecated_code
    items:
      - "SomnioEngine (src/lib/agents/somnio/somnio-engine.ts) - deprecated, replaced by UnifiedEngine"
      - "SandboxEngine (src/lib/sandbox/sandbox-engine.ts) - deprecated, replaced by UnifiedEngine"
      - "/api/agents/somnio endpoint - legacy, kept for backward compatibility"
---

# MVP v2.0 Milestone Audit: Agentes Conversacionales

**Audited:** 2026-02-16T20:00:00-05:00
**Status:** Tech Debt (no blockers, accumulated documentation debt)
**Milestone Goal:** Replicar el agente de ventas de Somnio (actualmente en n8n) en codigo TypeScript controlado, integrado con MorfX CRM y WhatsApp.

## Executive Summary

MVP v2.0 is **functionally complete**. All 13 phases have shipped working code. Cross-phase integration is excellent with 47 verified connections and 5 end-to-end flows confirmed working. The accumulated tech debt is documentation-focused: 7 phases lack formal VERIFICATION.md files, and 4 phases remain listed as "In progress" in the ROADMAP (only human-verification plans pending, no code work remaining).

## Phase Status

| Phase | Plans | Status | VERIFICATION | LEARNINGS |
|-------|-------|--------|-------------|-----------|
| 12. Action DSL Real | 4/4 | Complete | ✓ passed | ✓ |
| 13. Agent Engine Core | 6/6 | Complete | ✓ passed | ✓ |
| 14. Agente Ventas Somnio | 6/6 | Complete | ✓ passed | ✓ |
| 15. Agent Sandbox | 4/5 | Code complete* | ✗ missing | ✓ |
| 15.5. Somnio Ingest System | 3/4 | Code complete* | ✗ missing | ✓ |
| 15.6. Sandbox Evolution | 6/6 | Complete | ✗ missing | ✓ |
| 15.7. Ingest Timer Pluggable | 2/3 | Code complete* | ✗ missing | ✓ |
| 15.8. Codebase Cleanup | 4/4 | Complete | ✓ passed | ✓ |
| 16. WhatsApp Agent Integration | 5/6 | Code complete* | ✗ missing | ✓ |
| 16.1. Engine Unification | 6/6 | Complete | ✓ passed | ✓ |
| 17. CRM Automations Engine | 10/10 | Complete | ✗ missing | ✓ |
| 18. Domain Layer Foundation | 10/10 | Complete | ✗ missing | ✓ |
| 19. AI Automation Builder | 10/10 | Complete | ✓ passed | ✓ |

\* "Code complete" = all implementation plans finished, only human verification plan pending

**Totals:**
- Plans completed: 80/87 (7 human-verification plans never executed)
- Formal verifications: 6/13
- LEARNINGS: 13/13

## Cross-Phase Integration

**Status: PASS — 47 connections verified, 0 broken**

### Key Integration Points

| Integration | From | To | Status |
|-------------|------|-----|--------|
| Domain → Tool Handlers | Phase 18 | Phase 12 | ✓ All 20 CRM + 7 WhatsApp handlers use domain/ |
| Unified Engine → Adapters | Phase 16.1 | Phase 15, 16 | ✓ 5 interfaces, 10 implementations |
| Domain → Trigger Emission | Phase 18 | Phase 17 | ✓ All 6 domain modules emit triggers |
| Action Executor → Domain | Phase 17 | Phase 18 | ✓ 17 domain imports in action-executor |
| AI Builder → Automations | Phase 19 | Phase 17 | ✓ 9 tools, resource validation, cycle detection |
| WhatsApp Webhook → Agent | Phase 16 | Phase 16.1 | ✓ Inngest routing → UnifiedEngine → SomnioAgent |
| Sandbox → UnifiedEngine | Phase 15 | Phase 16.1 | ✓ sandbox/process/route → sandbox adapters |

### Security Validations

- ✓ HMAC signature verification on WhatsApp webhook
- ✓ Auth check on sandbox API
- ✓ Workspace membership on builder API
- ✓ Cascade depth limiting (MAX_CASCADE_DEPTH=3)
- ✓ All tool handlers filter by workspace_id

## E2E User Flows

| # | Flow | Status | Phases Involved |
|---|------|--------|-----------------|
| 1 | WhatsApp Customer Service | ✓ Complete | 7, 12, 13, 14, 16, 16.1, 18 |
| 2 | Sandbox Testing | ✓ Complete | 15, 15.5, 15.6, 15.7, 16.1 |
| 3 | Automation via Wizard | ✓ Complete | 17 |
| 4 | Automation via AI Builder | ✓ Complete | 17, 18, 19 |
| 5 | CRM → Trigger → Actions | ✓ Complete | 17, 18 |

All 5 flows verified end-to-end with source file evidence.

## Verified Phase Details

### Phase 12: Action DSL Real (VERIFIED)
- **Score:** 5/5 success criteria
- **Key deliverables:** 16 real handlers (9 CRM + 7 WhatsApp), rate limiter, timeouts, forensic logging
- **Code:** 2,308+ lines replacing all placeholders
- **Quality:** Zero TODOs, zero stubs, TypeScript compiles clean

### Phase 13: Agent Engine Core (VERIFIED)
- **Score:** 5/5 success criteria, 11/11 requirements (AGEN-01 to AGEN-11)
- **Key deliverables:** AgentEngine, AgentRegistry, SessionManager, ClaudeClient, TokenBudgetManager
- **Code:** 2,800+ lines with optimistic locking, Inngest timers
- **Quality:** Zero anti-patterns found

### Phase 14: Agente Ventas Somnio (VERIFIED)
- **Score:** 5/5 success criteria
- **Key deliverables:** 33 intents, 9-field data extraction, template management, order creation, message sequencing
- **Code:** 5,149+ lines across 14 files
- **Quality:** Full separation of concerns, no stubs

### Phase 15.8: Codebase Cleanup (VERIFIED)
- **Score:** 8/8 success criteria
- **Key deliverables:** 16 bugs fixed, 3 security fixes, 4 consolidations
- **Code:** 18 files modified, 1 created
- **Quality:** TypeScript compiles clean

### Phase 16.1: Engine Unification (VERIFIED)
- **Score:** 7/7 success criteria
- **Key deliverables:** UnifiedEngine, SomnioAgent (744 lines), 5 adapter interfaces, 10 adapter implementations
- **Code:** ~1,364 new lines, eliminated ~800 duplicated lines
- **Quality:** Ports/adapters architecture, zero orphaned code

### Phase 19: AI Automation Builder (VERIFIED)
- **Score:** 7/7 success criteria
- **Key deliverables:** AI SDK v6 streaming, 9 builder tools, React Flow diagrams, validation (resources, cycles, duplicates)
- **Code:** 2,419 lines lib + 1,375 lines UI
- **Quality:** No stubs, workspace isolation on all queries

## Tech Debt Summary

### 1. Missing VERIFICATION.md (7 phases)

Phases 15, 15.5, 15.6, 15.7, 16, 17, 18 lack formal verification documents. These phases have all implementation work complete and the integration checker confirms working code, but no structured verification was run.

**Impact:** Low — code quality confirmed via integration check
**Recommendation:** Accept as-is for milestone completion. Future phases should include verification.

### 2. Pending Human Verification Plans (4 phases)

Phases 15, 15.5, 15.7, 16 each have a final human verification plan that was never formally executed. These correspond to plans 15-05, 15.5-04, 15.7-03, 16-06.

**Impact:** Low — the user has been testing the product in practice during development
**Recommendation:** Close as part of milestone completion.

### 3. ROADMAP Inconsistency

4 phases (15, 15.5, 15.7, 16) still show "In progress" in ROADMAP.md despite the milestone being considered complete.

**Impact:** Documentation only
**Recommendation:** Update ROADMAP.md statuses during milestone completion.

### 4. v2 Requirements Not in REQUIREMENTS.md

MVP v2.0 requirements are tracked only as success criteria in ROADMAP.md, not as formal requirements in REQUIREMENTS.md. This means traceability is informal.

**Impact:** Low — requirements are documented in ROADMAP phase details
**Recommendation:** Consider adding v2 requirements to REQUIREMENTS.md for next milestone.

### 5. Deprecated Code Still Present

- `src/lib/agents/somnio/somnio-engine.ts` — replaced by UnifiedEngine + SomnioAgent
- `src/lib/sandbox/sandbox-engine.ts` — replaced by UnifiedEngine + sandbox adapters
- `/api/agents/somnio` — legacy endpoint

**Impact:** Low — files preserved as backup per Phase 16.1 strategy
**Recommendation:** Safe to delete after confirming production stability.

## Milestone Goal Assessment

**Goal:** Replicar el agente de ventas de Somnio en codigo TypeScript controlado, integrado con MorfX CRM y WhatsApp.

| Aspect | Status | Evidence |
|--------|--------|----------|
| Sales agent in TypeScript | ✓ | SomnioAgent (744 lines), 33 intents, data extraction, templates |
| CRM integration | ✓ | Domain layer (33 functions), 20 CRM tool handlers |
| WhatsApp integration | ✓ | Production adapters, webhook routing, message sequencing |
| Sandbox for testing | ✓ | /sandbox with debug panels, in-memory adapters |
| Automations engine | ✓ | 10 triggers, 11 actions, condition evaluator, Inngest runners |
| AI Automation Builder | ✓ | Natural language creation, resource validation, React Flow preview |
| Domain layer | ✓ | Single source of truth for all mutations |
| Engine unification | ✓ | One engine, two adapter sets (sandbox + production) |

**Verdict:** Milestone goal fully achieved. The system delivers everything the goal intended plus additional capabilities (automations engine, AI builder, domain layer) that went beyond the original scope.

---

*Audited: 2026-02-16T20:00:00-05:00*
*Auditor: Claude (gsd-milestone-auditor)*
