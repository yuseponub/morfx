---
phase: 16-whatsapp-agent-integration
plan: 04
type: execute
wave: 2
depends_on: ["16-01"]
files_modified:
  - src/app/(dashboard)/whatsapp/components/agent-config-slider.tsx
  - src/app/(dashboard)/whatsapp/components/inbox-layout.tsx
  - src/app/(dashboard)/whatsapp/components/contact-panel.tsx
  - src/components/layout/sidebar.tsx
  - src/components/layout/mobile-nav.tsx
autonomous: true

must_haves:
  truths:
    - "Agent config slider panel overlays the contact panel area in the inbox"
    - "Slider has global ON/OFF toggle, agent selector, CRM agent toggles, timer preset, response speed"
    - "Slider can be collapsed/hidden to restore contact panel"
    - "Sidebar navigation has 'Agentes' item with Bot icon between Sandbox and Equipo"
    - "Mobile navigation also has 'Agentes' item"
  artifacts:
    - path: "src/app/(dashboard)/whatsapp/components/agent-config-slider.tsx"
      provides: "Global agent configuration panel"
      contains: "AgentConfigSlider"
    - path: "src/app/(dashboard)/whatsapp/components/inbox-layout.tsx"
      provides: "Toggle between contact panel and agent config slider"
      contains: "AgentConfigSlider"
    - path: "src/components/layout/sidebar.tsx"
      provides: "Agentes nav item"
      contains: "/agentes"
  key_links:
    - from: "src/app/(dashboard)/whatsapp/components/agent-config-slider.tsx"
      to: "src/app/actions/agent-config.ts"
      via: "getAgentConfig and updateAgentConfig server actions"
      pattern: "updateAgentConfig"
    - from: "src/app/(dashboard)/whatsapp/components/inbox-layout.tsx"
      to: "src/app/(dashboard)/whatsapp/components/agent-config-slider.tsx"
      via: "Conditional render in right column slot"
      pattern: "AgentConfigSlider"
---

<objective>
Create the agent config slider for the inbox and add the Agentes module to navigation.

Purpose: The slider provides quick access to global agent settings directly from the inbox (toggle ON/OFF, select agent, configure CRM agents, timer presets). Navigation update prepares for the Agentes module (Plan 05).

Output: AgentConfigSlider component, modified inbox-layout with panel switching, updated sidebar and mobile nav.
</objective>

<execution_context>
@/home/jose147/.claude/get-shit-done/workflows/execute-plan.md
@/home/jose147/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/16-whatsapp-agent-integration/16-CONTEXT.md
@.planning/phases/16-whatsapp-agent-integration/16-RESEARCH.md

Key source files:
@src/app/(dashboard)/whatsapp/components/inbox-layout.tsx
@src/app/(dashboard)/whatsapp/components/contact-panel.tsx
@src/components/layout/sidebar.tsx
@src/components/layout/mobile-nav.tsx
@src/app/actions/agent-config.ts (from Plan 01)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Agent config slider component</name>
  <files>src/app/(dashboard)/whatsapp/components/agent-config-slider.tsx</files>
  <action>
Create new component `AgentConfigSlider`:

Props:
```typescript
interface AgentConfigSliderProps {
  workspaceId: string
  onClose: () => void
}
```

State:
- `config`: AgentConfig | null (loaded from server action)
- `isLoading`: boolean
- `isSaving`: boolean

On mount: Call `getAgentConfig()` server action to load current config. If no config exists, show defaults.

Layout (same w-80 as contact panel, since it replaces it):

```
[Header: "Configuracion de Agente" with X close button]

[Section: Global Toggle]
  - Large Switch: "Agente activo" with Bot icon
  - Description: "Habilita el agente para todas las conversaciones"

[Section: Agente Conversacional]
  - Label: "Agente de ventas"
  - Select dropdown with available agents (for now just "Somnio Sales v1")
  - This reads from agent registry (can hardcode for now since only one agent exists)

[Section: Agentes CRM]
  - Toggle for each CRM agent (for now just "Order Manager")
  - Each toggle uses Switch with agent name

[Section: Handoff]
  - Label: "Mensaje de handoff"
  - Textarea with the handoff message (editable)
  - Default: "Regalame 1 min, ya te comunico con un asesor"

[Section: Timer & Velocidad]
  - Timer preset: 3 buttons (Real / Rapido / Instantaneo) - same as sandbox
  - Response speed: Slider from 0.5x to 2.0x (step 0.1)
  - Description under each control explaining what it does
```

Each control change calls `updateAgentConfig()` server action with the changed field. Use debounce (300ms) for text/slider inputs, immediate for toggles/selects.

Style: Clean sections with consistent spacing, dividers between sections, scroll if content overflows. Use Tailwind classes consistent with existing contact-panel styling.

Icons: Use lucide-react Bot, Zap, Clock, MessageSquare icons. Apple/iPhone style means clean, minimal, rounded elements.

Import Switch from '@/components/ui/switch'.
Import Select from '@/components/ui/select' if it exists, or use a simple styled select.
Import Slider from '@/components/ui/slider' if it exists, or use an HTML range input styled with Tailwind.
Import Textarea from '@/components/ui/textarea'.
  </action>
  <verify>TypeScript compiles. Component renders without errors. All sections are present. Config changes call server actions.</verify>
  <done>AgentConfigSlider renders all config sections, loads and saves config via server actions.</done>
</task>

<task type="auto">
  <name>Task 2: Inbox layout panel switching + navigation update</name>
  <files>
    src/app/(dashboard)/whatsapp/components/inbox-layout.tsx
    src/components/layout/sidebar.tsx
    src/components/layout/mobile-nav.tsx
  </files>
  <action>
**inbox-layout.tsx:**

1. Import AgentConfigSlider from './agent-config-slider'.
2. Add state for which panel is showing:
   ```typescript
   const [rightPanel, setRightPanel] = useState<'contact' | 'agent-config'>('contact')
   ```

3. Add a button in the inbox to toggle to agent config panel. The natural place is to add a Bot icon button that switches the right panel:
   - Pass `onToggleAgentConfig` to ChatView or add it alongside the panel toggle
   - When user clicks the agent config button, set rightPanel to 'agent-config'
   - When AgentConfigSlider's onClose is called, set rightPanel back to 'contact'

4. Modify the right column rendering:
   ```tsx
   {/* Right column: Contact panel or Agent config slider */}
   <div className={cn(
     'flex-shrink-0 border-l bg-background transition-all duration-200',
     isPanelOpen ? 'w-80' : 'w-0 overflow-hidden'
   )}>
     {rightPanel === 'contact' ? (
       <ContactPanel
         conversation={selectedConversation}
         onClose={() => setIsPanelOpen(false)}
         onConversationUpdated={refreshSelectedConversation}
         onOrdersChanged={refreshOrdersFn}
       />
     ) : (
       <AgentConfigSlider
         workspaceId={workspaceId}
         onClose={() => setRightPanel('contact')}
       />
     )}
   </div>
   ```

5. Pass a callback to ChatView so it can open the agent config:
   ```tsx
   <ChatView
     conversationId={selectedConversationId}
     conversation={selectedConversation}
     onTogglePanel={() => setIsPanelOpen(!isPanelOpen)}
     onOpenAgentConfig={() => {
       setRightPanel('agent-config')
       setIsPanelOpen(true)
     }}
   />
   ```

   In ChatView, add a Bot icon button in the header area or pass it to ChatHeader. The simplest approach: add a Bot button next to the PanelRightOpen button in ChatHeader that calls onOpenAgentConfig.

   Update ChatHeader props to accept optional `onOpenAgentConfig?: () => void`, and add:
   ```tsx
   <Button variant="ghost" size="icon" className="h-8 w-8" onClick={onOpenAgentConfig} title="Config de agente">
     <Bot className="h-4 w-4" />
   </Button>
   ```

**sidebar.tsx:**

Add 'Agentes' nav item between Sandbox and Equipo:
```typescript
{
  href: '/agentes',
  label: 'Agentes',
  icon: Bot, // Already imported
},
```

Insert it after the Sandbox item in the navItems array. Bot icon is already imported in sidebar.tsx.

**mobile-nav.tsx:**

1. Import Bot from lucide-react.
2. Add Agentes to the navItems array:
```typescript
{
  href: '/agentes',
  label: 'Agentes',
  icon: Bot,
},
```

Also add the missing nav items that sidebar has but mobile doesn't (Tareas, Analytics, Sandbox) â€” actually only add Agentes to keep the scope focused. The mobile nav is already simplified.
  </action>
  <verify>TypeScript compiles. Right column can switch between ContactPanel and AgentConfigSlider. Bot button in header opens agent config. Sidebar shows Agentes link. Mobile nav shows Agentes link.</verify>
  <done>Inbox layout supports panel switching. Navigation updated with Agentes module link. Agent config accessible from inbox header.</done>
</task>

</tasks>

<verification>
- [ ] AgentConfigSlider renders with all config sections
- [ ] Global toggle, agent selector, CRM toggles, handoff message, timer preset, speed all work
- [ ] Slider replaces contact panel in inbox right column
- [ ] Bot button in chat header opens agent config panel
- [ ] Close button on slider returns to contact panel
- [ ] Sidebar has Agentes link with Bot icon
- [ ] Mobile nav has Agentes link
- [ ] TypeScript compiles cleanly
</verification>

<success_criteria>
Config UI and navigation complete when:
1. Agent config slider shows all settings from workspace_agent_config
2. Changes save via server actions
3. Panel switching works (contact <-> agent config)
4. Navigation includes Agentes module link
5. Apple/iPhone clean style throughout
</success_criteria>

<output>
After completion, create `.planning/phases/16-whatsapp-agent-integration/16-04-SUMMARY.md`
</output>
