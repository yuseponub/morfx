---
phase: 05-contacts-extended
plan: 02
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - src/app/actions/custom-fields.ts
  - src/lib/custom-fields/validator.ts
  - src/lib/custom-fields/renderer.tsx
  - src/app/(dashboard)/crm/configuracion/campos-custom/page.tsx
  - src/app/(dashboard)/crm/configuracion/campos-custom/components/field-builder.tsx
  - src/app/(dashboard)/crm/contactos/[id]/components/custom-fields-section.tsx
  - src/components/custom-fields/field-input.tsx
  - src/components/custom-fields/field-display.tsx
autonomous: true

must_haves:
  truths:
    - "Admin/Owner can create custom field definitions in workspace settings"
    - "Custom fields appear on contact detail page for viewing and editing"
    - "Field values are validated according to field type"
    - "Contact form includes custom fields with proper validation"
  artifacts:
    - path: "src/app/actions/custom-fields.ts"
      provides: "Server Actions for custom field definitions CRUD"
      exports: ["getCustomFields", "createCustomField", "updateCustomField", "deleteCustomField"]
    - path: "src/lib/custom-fields/validator.ts"
      provides: "Dynamic Zod schema builder for custom fields"
      exports: ["buildCustomFieldSchema"]
    - path: "src/app/(dashboard)/crm/configuracion/campos-custom/page.tsx"
      provides: "Settings page for managing custom field definitions"
    - path: "src/components/custom-fields/field-input.tsx"
      provides: "Dynamic input component for each field type"
  key_links:
    - from: "custom-fields-section.tsx"
      to: "src/app/actions/custom-fields.ts"
      via: "Server Action calls"
      pattern: "updateContact.*custom_fields"
    - from: "field-builder.tsx"
      to: "src/app/actions/custom-fields.ts"
      via: "createCustomField Server Action"
      pattern: "createCustomField"
---

<objective>
Implement the complete custom fields system: Server Actions for field definitions CRUD, dynamic Zod validation, field builder UI in settings, and custom fields display/edit on contact detail page.

Purpose: Workspace admins need to define what data to collect, and users need to view/edit that data on contacts.
Output: Settings page for field management, dynamic field rendering on contact detail, validation per field type.
</objective>

<execution_context>
@/home/jose147/.claude/get-shit-done/workflows/execute-plan.md
@/home/jose147/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/05-contacts-extended/05-CONTEXT.md
@.planning/phases/05-contacts-extended/05-RESEARCH.md
@.planning/phases/05-contacts-extended/05-01-SUMMARY.md
@src/lib/custom-fields/types.ts
@src/app/actions/contacts.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Server Actions and Zod validator for custom fields</name>
  <files>src/app/actions/custom-fields.ts, src/lib/custom-fields/validator.ts</files>
  <action>
**src/app/actions/custom-fields.ts:**

Create Server Actions following existing pattern from contacts.ts:

1. `getCustomFields()` - Get all custom field definitions for current workspace
   - Return sorted by display_order
   - Used by field builder and contact forms

2. `createCustomField(data)` - Create new field definition
   - Validate: name required, key must be slug-safe (lowercase, underscores)
   - Auto-generate key from name if not provided (e.g., "Fecha Cumpleanos" -> "fecha_cumpleanos")
   - Check key uniqueness within workspace
   - Only owner/admin can create (check role)

3. `updateCustomField(id, data)` - Update field definition
   - Cannot change key (would break existing data)
   - Can update: name, options, is_required, display_order
   - Only owner/admin can update

4. `deleteCustomField(id)` - Delete field definition
   - WARNING: This removes the definition but contact data remains in JSONB
   - Only owner/admin can delete
   - Consider: should we also clean up data from contacts? (For MVP: no, just delete definition)

5. `reorderCustomFields(orderedIds: string[])` - Update display_order for all fields
   - Receives array of field IDs in new order
   - Updates display_order to match array index

Input validation with Zod:
```typescript
const createFieldSchema = z.object({
  name: z.string().min(1, 'Nombre requerido').max(100),
  key: z.string().regex(/^[a-z][a-z0-9_]*$/, 'Solo letras minusculas, numeros y guion bajo').optional(),
  field_type: z.enum(['text', 'number', 'date', 'select', 'checkbox', 'url', 'email', 'phone', 'currency', 'percentage', 'file', 'contact_relation']),
  options: z.array(z.string()).optional(),
  is_required: z.boolean().default(false),
})
```

**src/lib/custom-fields/validator.ts:**

Create `buildCustomFieldSchema(definitions: CustomFieldDefinition[])`:

```typescript
export function buildCustomFieldSchema(definitions: CustomFieldDefinition[]) {
  const shape: Record<string, z.ZodTypeAny> = {}

  for (const def of definitions) {
    let fieldSchema: z.ZodTypeAny

    switch (def.field_type) {
      case 'text':
        fieldSchema = z.string()
        break
      case 'number':
      case 'currency':
      case 'percentage':
        fieldSchema = z.coerce.number()
        break
      case 'date':
        fieldSchema = z.coerce.date()
        break
      case 'checkbox':
        fieldSchema = z.boolean()
        break
      case 'select':
        if (def.options && def.options.length > 0) {
          fieldSchema = z.enum(def.options as [string, ...string[]])
        } else {
          fieldSchema = z.string()
        }
        break
      case 'email':
        fieldSchema = z.string().email('Email invalido')
        break
      case 'url':
        fieldSchema = z.string().url('URL invalida')
        break
      case 'phone':
        fieldSchema = z.string().min(10, 'Telefono invalido')
        break
      case 'file':
        fieldSchema = z.string().url() // File stored as URL
        break
      case 'contact_relation':
        fieldSchema = z.string().uuid('Contacto invalido')
        break
      default:
        fieldSchema = z.unknown()
    }

    // Make optional if not required
    if (!def.is_required) {
      fieldSchema = fieldSchema.optional().nullable()
    }

    shape[def.key] = fieldSchema
  }

  return z.object(shape)
}
```

Also create helper to generate key from name:
```typescript
export function generateFieldKey(name: string): string {
  return name
    .toLowerCase()
    .normalize('NFD')
    .replace(/[\u0300-\u036f]/g, '') // Remove accents
    .replace(/[^a-z0-9]+/g, '_')
    .replace(/^_|_$/g, '')
    .substring(0, 50)
}
```
  </action>
  <verify>TypeScript compiles: `cd morfx && pnpm exec tsc --noEmit`</verify>
  <done>Server Actions exist for custom field CRUD, dynamic Zod schema builder works</done>
</task>

<task type="auto">
  <name>Task 2: Create custom field input and display components</name>
  <files>src/components/custom-fields/field-input.tsx, src/components/custom-fields/field-display.tsx</files>
  <action>
**src/components/custom-fields/field-input.tsx:**

Create a dynamic input component that renders appropriate shadcn/ui input based on field type:

```typescript
interface FieldInputProps {
  definition: CustomFieldDefinition
  value: unknown
  onChange: (value: unknown) => void
  error?: string
  disabled?: boolean
}

export function FieldInput({ definition, value, onChange, error, disabled }: FieldInputProps)
```

Render based on field_type:
- `text`: Input type="text"
- `number`: Input type="number"
- `date`: Input type="date" (or use a date picker if available)
- `select`: Select with options from definition.options
- `checkbox`: Checkbox
- `url`: Input type="url"
- `email`: Input type="email"
- `phone`: Input type="tel"
- `currency`: Input type="number" with $ prefix
- `percentage`: Input type="number" with % suffix
- `file`: For MVP, just Input type="url" (paste file URL from Supabase Storage)
- `contact_relation`: Combobox to search and select contact by name (similar to city combobox pattern from Phase 4)

Use existing shadcn components: Input, Select, Checkbox, Label
Show error message below input if provided
Handle null/undefined values gracefully

**src/components/custom-fields/field-display.tsx:**

Read-only display component for custom field values:

```typescript
interface FieldDisplayProps {
  definition: CustomFieldDefinition
  value: unknown
}

export function FieldDisplay({ definition, value }: FieldDisplayProps)
```

Format based on field_type:
- `text`, `email`, `url`, `phone`: Display as text (url/email as clickable link)
- `number`: Format with locale (1,234.56)
- `currency`: Format with $ and locale
- `percentage`: Format with % suffix
- `date`: Format as "29 ene 2026" (Spanish locale)
- `checkbox`: Checkmark icon or "Si"/"No"
- `select`: Display selected option
- `contact_relation`: Display linked contact name (fetch via ID)
- `file`: Link to file URL

Handle null/empty values: show "-" or empty state
  </action>
  <verify>Components render without errors (TypeScript compiles)</verify>
  <done>FieldInput and FieldDisplay components handle all 12 field types</done>
</task>

<task type="auto">
  <name>Task 3: Create custom field builder UI and integrate into contact detail</name>
  <files>
    src/app/(dashboard)/crm/configuracion/campos-custom/page.tsx
    src/app/(dashboard)/crm/configuracion/campos-custom/components/field-builder.tsx
    src/app/(dashboard)/crm/contactos/[id]/components/custom-fields-section.tsx
    src/app/(dashboard)/crm/contactos/[id]/page.tsx
  </files>
  <action>
**src/app/(dashboard)/crm/configuracion/campos-custom/page.tsx:**

Settings page for custom field management:
- List all custom field definitions with name, type, required badge
- "Nuevo campo" button opens field builder dialog
- Each field has Edit and Delete actions
- Drag-and-drop reordering (or simple up/down buttons for MVP)
- Server component that fetches fields via getCustomFields()

**src/app/(dashboard)/crm/configuracion/campos-custom/components/field-builder.tsx:**

Dialog/Sheet for creating/editing a custom field:
- Form fields:
  - Nombre (text input)
  - Tipo de campo (select with all 12 types)
  - Opciones (only visible when type is 'select', array input)
  - Obligatorio (checkbox)
- Preview of what the field will look like
- Save calls createCustomField or updateCustomField
- Use react-hook-form + zodResolver for validation

**src/app/(dashboard)/crm/contactos/[id]/components/custom-fields-section.tsx:**

Section on contact detail page showing custom fields:
- Fetch custom field definitions via getCustomFields()
- Display all fields with current values from contact.custom_fields
- Edit mode: use FieldInput for each field
- View mode: use FieldDisplay for each field
- Save button updates contact.custom_fields via updateContact

Group fields logically (by display_order)
Show "Sin campos personalizados" if no definitions exist
Add link to configure custom fields (for admin/owner)

**Update src/app/(dashboard)/crm/contactos/[id]/page.tsx:**

Add CustomFieldsSection below the existing contact info section
Pass contact.custom_fields data to the section
  </action>
  <verify>
1. Navigate to /crm/configuracion/campos-custom - page loads
2. Create a custom field - appears in list
3. View contact detail - custom fields section visible
  </verify>
  <done>
- Custom field builder UI exists in settings
- Custom fields display and edit on contact detail page
- All 12 field types supported
  </done>
</task>

</tasks>

<verification>
1. TypeScript compiles: `cd morfx && pnpm exec tsc --noEmit`
2. Server Actions exported: getCustomFields, createCustomField, updateCustomField, deleteCustomField
3. FieldInput handles all 12 field types
4. Settings page at /crm/configuracion/campos-custom loads
5. Contact detail page shows custom fields section
</verification>

<success_criteria>
- Admin/Owner can create, edit, delete custom field definitions
- Custom fields appear on contact detail page
- Values are validated according to field type (Zod schema)
- All 12 field types render correctly in both input and display modes
- Field definitions are workspace-isolated
</success_criteria>

<output>
After completion, create `.planning/phases/05-contacts-extended/05-02-SUMMARY.md`
</output>
