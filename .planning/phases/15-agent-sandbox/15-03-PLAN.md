---
phase: 15-agent-sandbox
plan: 03
type: execute
wave: 2
depends_on: ["15-01"]
files_modified:
  - src/app/(dashboard)/sandbox/components/debug-panel/debug-tabs.tsx
  - src/app/(dashboard)/sandbox/components/debug-panel/tools-tab.tsx
  - src/app/(dashboard)/sandbox/components/debug-panel/state-tab.tsx
  - src/app/(dashboard)/sandbox/components/debug-panel/intent-tab.tsx
  - src/app/(dashboard)/sandbox/components/debug-panel/tokens-tab.tsx
autonomous: true

must_haves:
  truths:
    - "User can see 4 tabs: Tools, Estado, Intent, Tokens"
    - "Tools tab shows expandable list of tool executions with inputs/outputs"
    - "Estado tab shows editable JSON viewer of session state"
    - "Intent tab shows detected intent with confidence per message"
    - "Tokens tab shows token count per turn and cumulative total"
  artifacts:
    - path: "src/app/(dashboard)/sandbox/components/debug-panel/debug-tabs.tsx"
      provides: "Tab container for debug panel"
      exports: ["DebugTabs"]
    - path: "src/app/(dashboard)/sandbox/components/debug-panel/tools-tab.tsx"
      provides: "Tool executions list"
      exports: ["ToolsTab"]
    - path: "src/app/(dashboard)/sandbox/components/debug-panel/state-tab.tsx"
      provides: "Editable JSON state viewer"
      contains: "JsonView"
    - path: "src/app/(dashboard)/sandbox/components/debug-panel/intent-tab.tsx"
      provides: "Intent detection info"
      exports: ["IntentTab"]
    - path: "src/app/(dashboard)/sandbox/components/debug-panel/tokens-tab.tsx"
      provides: "Token usage tracking"
      exports: ["TokensTab"]
  key_links:
    - from: "src/app/(dashboard)/sandbox/components/debug-panel/state-tab.tsx"
      to: "@uiw/react-json-view"
      via: "Library import"
      pattern: "JsonView"
    - from: "src/app/(dashboard)/sandbox/components/debug-panel/debug-tabs.tsx"
      to: "@radix-ui/react-tabs"
      via: "Tab component import"
      pattern: "Tabs"
---

<objective>
Create the debug panel with 4 tabs: Tools, Estado, Intent, and Tokens. Each tab provides debugging visibility into agent execution.

Purpose: Enables developers to understand exactly what the agent is doing - which tools were called, what state changes occurred, what intent was detected, and how many tokens were consumed.
Output: Complete debug panel that can be integrated into the sandbox layout.
</objective>

<execution_context>
@/home/jose147/.claude/get-shit-done/workflows/execute-plan.md
@/home/jose147/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/15-agent-sandbox/15-CONTEXT.md
@.planning/phases/15-agent-sandbox/15-RESEARCH.md
@.planning/phases/15-agent-sandbox/15-01-SUMMARY.md
@src/lib/sandbox/types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create debug panel tabs container and Tools tab</name>
  <files>
    src/app/(dashboard)/sandbox/components/debug-panel/debug-tabs.tsx
    src/app/(dashboard)/sandbox/components/debug-panel/tools-tab.tsx
  </files>
  <action>
Create directories:
```bash
mkdir -p src/app/\(dashboard\)/sandbox/components/debug-panel
```

Create `src/app/(dashboard)/sandbox/components/debug-panel/debug-tabs.tsx`:

```typescript
'use client'

/**
 * Debug Tabs Component
 * Phase 15: Agent Sandbox
 *
 * Tab container for the debug panel.
 * Uses Radix UI Tabs (already in project).
 */

import { Tabs, TabsContent, TabsList, TabsTrigger } from '@/components/ui/tabs'
import { Wrench, FileJson, Brain, Coins } from 'lucide-react'
import { ToolsTab } from './tools-tab'
import { StateTab } from './state-tab'
import { IntentTab } from './intent-tab'
import { TokensTab } from './tokens-tab'
import type { DebugTurn, SandboxState } from '@/lib/sandbox/types'

interface DebugTabsProps {
  debugTurns: DebugTurn[]
  state: SandboxState
  onStateEdit: (newState: SandboxState) => void
  totalTokens: number
}

export function DebugTabs({
  debugTurns,
  state,
  onStateEdit,
  totalTokens,
}: DebugTabsProps) {
  return (
    <div className="h-full flex flex-col bg-background">
      <div className="px-3 py-2 border-b">
        <h3 className="text-sm font-medium">Debug Panel</h3>
      </div>

      <Tabs defaultValue="tools" className="flex-1 flex flex-col min-h-0">
        <TabsList className="mx-3 mt-2 grid w-auto grid-cols-4">
          <TabsTrigger value="tools" className="text-xs">
            <Wrench className="h-3.5 w-3.5 mr-1" />
            Tools
          </TabsTrigger>
          <TabsTrigger value="state" className="text-xs">
            <FileJson className="h-3.5 w-3.5 mr-1" />
            Estado
          </TabsTrigger>
          <TabsTrigger value="intent" className="text-xs">
            <Brain className="h-3.5 w-3.5 mr-1" />
            Intent
          </TabsTrigger>
          <TabsTrigger value="tokens" className="text-xs">
            <Coins className="h-3.5 w-3.5 mr-1" />
            Tokens
          </TabsTrigger>
        </TabsList>

        <div className="flex-1 min-h-0 overflow-auto">
          <TabsContent value="tools" className="h-full m-0 p-3">
            <ToolsTab debugTurns={debugTurns} />
          </TabsContent>

          <TabsContent value="state" className="h-full m-0 p-3">
            <StateTab state={state} onStateEdit={onStateEdit} />
          </TabsContent>

          <TabsContent value="intent" className="h-full m-0 p-3">
            <IntentTab debugTurns={debugTurns} />
          </TabsContent>

          <TabsContent value="tokens" className="h-full m-0 p-3">
            <TokensTab debugTurns={debugTurns} totalTokens={totalTokens} />
          </TabsContent>
        </div>
      </Tabs>
    </div>
  )
}
```

Create `src/app/(dashboard)/sandbox/components/debug-panel/tools-tab.tsx`:

```typescript
'use client'

/**
 * Tools Tab Component
 * Phase 15: Agent Sandbox
 *
 * Expandable list of tool executions with inputs/outputs.
 * Shows tool name + status badge, click to expand.
 */

import { useState } from 'react'
import { ChevronDown, ChevronRight, Check, X } from 'lucide-react'
import { Badge } from '@/components/ui/badge'
import { cn } from '@/lib/utils'
import type { DebugTurn, ToolExecution } from '@/lib/sandbox/types'

interface ToolsTabProps {
  debugTurns: DebugTurn[]
}

function ToolExecutionItem({ tool }: { tool: ToolExecution }) {
  const [expanded, setExpanded] = useState(false)

  return (
    <div className="border rounded-lg overflow-hidden">
      <button
        className="flex items-center gap-2 w-full px-3 py-2 text-left hover:bg-muted/50 transition-colors"
        onClick={() => setExpanded(!expanded)}
      >
        {expanded ? (
          <ChevronDown className="h-4 w-4 shrink-0" />
        ) : (
          <ChevronRight className="h-4 w-4 shrink-0" />
        )}

        <span className="font-mono text-sm truncate flex-1">{tool.name}</span>

        {tool.result ? (
          <Badge variant={tool.result.success ? 'default' : 'destructive'} className="shrink-0">
            {tool.result.success ? (
              <>
                <Check className="h-3 w-3 mr-1" />
                OK
              </>
            ) : (
              <>
                <X className="h-3 w-3 mr-1" />
                Error
              </>
            )}
          </Badge>
        ) : (
          <Badge variant="secondary" className="shrink-0">Pendiente</Badge>
        )}
      </button>

      {expanded && (
        <div className="px-3 pb-3 space-y-2 border-t bg-muted/30">
          <div className="pt-2">
            <span className="text-xs text-muted-foreground">Input:</span>
            <pre className="mt-1 p-2 bg-background rounded text-xs overflow-auto max-h-32">
              {JSON.stringify(tool.input, null, 2)}
            </pre>
          </div>

          {tool.result && (
            <div>
              <span className="text-xs text-muted-foreground">Output:</span>
              <pre className={cn(
                'mt-1 p-2 rounded text-xs overflow-auto max-h-32',
                tool.result.success ? 'bg-background' : 'bg-destructive/10'
              )}>
                {JSON.stringify(tool.result.success ? tool.result.data : tool.result.error, null, 2)}
              </pre>
            </div>
          )}

          {tool.durationMs && (
            <div className="text-xs text-muted-foreground">
              Duracion: {tool.durationMs}ms
            </div>
          )}
        </div>
      )}
    </div>
  )
}

export function ToolsTab({ debugTurns }: ToolsTabProps) {
  // Collect all tool executions from all turns
  const allTools = debugTurns.flatMap((turn, turnIdx) =>
    turn.tools.map((tool, toolIdx) => ({
      ...tool,
      turnNumber: turn.turnNumber,
      key: `${turnIdx}-${toolIdx}`,
    }))
  )

  if (allTools.length === 0) {
    return (
      <div className="flex items-center justify-center h-32 text-sm text-muted-foreground">
        No se han ejecutado tools todavia
      </div>
    )
  }

  return (
    <div className="space-y-2">
      <div className="text-xs text-muted-foreground mb-2">
        {allTools.length} tool{allTools.length !== 1 ? 's' : ''} ejecutado{allTools.length !== 1 ? 's' : ''}
      </div>

      {allTools.map(tool => (
        <ToolExecutionItem key={tool.key} tool={tool} />
      ))}
    </div>
  )
}
```
  </action>
  <verify>
Run `npx tsc --noEmit src/app/\(dashboard\)/sandbox/components/debug-panel/debug-tabs.tsx` to verify compilation (will have import errors until other tabs exist).
Verify directory structure created correctly.
  </verify>
  <done>
Debug tabs container created with 4 tabs.
Tools tab shows expandable list of tool executions with input/output JSON.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create State, Intent, and Tokens tabs</name>
  <files>
    src/app/(dashboard)/sandbox/components/debug-panel/state-tab.tsx
    src/app/(dashboard)/sandbox/components/debug-panel/intent-tab.tsx
    src/app/(dashboard)/sandbox/components/debug-panel/tokens-tab.tsx
  </files>
  <action>
Create `src/app/(dashboard)/sandbox/components/debug-panel/state-tab.tsx`:

```typescript
'use client'

/**
 * State Tab Component
 * Phase 15: Agent Sandbox
 *
 * EDITABLE JSON viewer of session state.
 * Per CONTEXT.md: "El JSON editable es para que Claude me ayude a predisponer estados especificos durante debugging"
 */

import { useCallback } from 'react'
import JsonView from '@uiw/react-json-view'
import { darkTheme } from '@uiw/react-json-view/dark'
import { lightTheme } from '@uiw/react-json-view/light'
import { useTheme } from 'next-themes'
import { Info } from 'lucide-react'
import type { SandboxState } from '@/lib/sandbox/types'

interface StateTabProps {
  state: SandboxState
  onStateEdit: (newState: SandboxState) => void
}

export function StateTab({ state, onStateEdit }: StateTabProps) {
  const { theme, systemTheme } = useTheme()
  const resolvedTheme = theme === 'system' ? systemTheme : theme
  const jsonTheme = resolvedTheme === 'dark' ? darkTheme : lightTheme

  const handleEdit = useCallback(({
    newValue,
    type,
    keyPath,
  }: {
    newValue: unknown
    type: 'add' | 'edit' | 'delete'
    keyPath: (string | number)[]
  }) => {
    // Deep clone current state
    const newState = JSON.parse(JSON.stringify(state)) as Record<string, unknown>

    // Navigate to the parent of the edited key
    let current = newState as Record<string, unknown>
    for (let i = 0; i < keyPath.length - 1; i++) {
      current = current[keyPath[i] as string] as Record<string, unknown>
    }

    const lastKey = keyPath[keyPath.length - 1] as string

    if (type === 'delete') {
      delete current[lastKey]
    } else {
      current[lastKey] = newValue
    }

    onStateEdit(newState as unknown as SandboxState)
  }, [state, onStateEdit])

  return (
    <div className="space-y-3">
      <div className="flex items-start gap-2 p-2 bg-blue-50 dark:bg-blue-950/30 rounded-lg text-xs">
        <Info className="h-4 w-4 text-blue-500 shrink-0 mt-0.5" />
        <p className="text-blue-700 dark:text-blue-300">
          Puedes editar valores directamente para predisponer estados especificos.
          Los cambios se aplican inmediatamente.
        </p>
      </div>

      <div className="rounded-lg border overflow-hidden">
        <JsonView
          value={state}
          style={{
            ...jsonTheme,
            padding: '12px',
            background: resolvedTheme === 'dark' ? 'hsl(var(--muted))' : 'hsl(var(--background))',
          }}
          displayDataTypes={false}
          displayObjectSize={true}
          collapsed={2}
          enableClipboard={true}
          editable={{
            add: true,
            edit: true,
            delete: true,
          }}
          onEdit={handleEdit}
        />
      </div>
    </div>
  )
}
```

Create `src/app/(dashboard)/sandbox/components/debug-panel/intent-tab.tsx`:

```typescript
'use client'

/**
 * Intent Tab Component
 * Phase 15: Agent Sandbox
 *
 * Shows intent detected + confidence score per message.
 */

import { Target, TrendingUp } from 'lucide-react'
import { Badge } from '@/components/ui/badge'
import { Progress } from '@/components/ui/progress'
import { cn } from '@/lib/utils'
import { format } from 'date-fns'
import type { DebugTurn } from '@/lib/sandbox/types'

interface IntentTabProps {
  debugTurns: DebugTurn[]
}

function getConfidenceColor(confidence: number): string {
  if (confidence >= 85) return 'text-green-600 dark:text-green-400'
  if (confidence >= 60) return 'text-yellow-600 dark:text-yellow-400'
  if (confidence >= 40) return 'text-orange-600 dark:text-orange-400'
  return 'text-red-600 dark:text-red-400'
}

function getConfidenceBadge(confidence: number): 'default' | 'secondary' | 'destructive' {
  if (confidence >= 85) return 'default'
  if (confidence >= 60) return 'secondary'
  return 'destructive'
}

export function IntentTab({ debugTurns }: IntentTabProps) {
  // Filter turns that have intent info
  const turnsWithIntent = debugTurns.filter(turn => turn.intent)

  if (turnsWithIntent.length === 0) {
    return (
      <div className="flex items-center justify-center h-32 text-sm text-muted-foreground">
        No hay detecciones de intent todavia
      </div>
    )
  }

  return (
    <div className="space-y-3">
      {turnsWithIntent.map((turn, idx) => (
        <div key={idx} className="border rounded-lg p-3 space-y-2">
          {/* Header */}
          <div className="flex items-center justify-between">
            <div className="flex items-center gap-2">
              <Target className="h-4 w-4 text-muted-foreground" />
              <span className="text-xs text-muted-foreground">
                Turno {turn.turnNumber}
              </span>
            </div>
            <span className="text-xs text-muted-foreground">
              {format(new Date(turn.intent!.timestamp), 'HH:mm:ss')}
            </span>
          </div>

          {/* Intent name */}
          <div className="flex items-center gap-2">
            <Badge variant={getConfidenceBadge(turn.intent!.confidence)}>
              {turn.intent!.intent}
            </Badge>
          </div>

          {/* Confidence bar */}
          <div className="space-y-1">
            <div className="flex items-center justify-between text-xs">
              <span className="text-muted-foreground">Confianza</span>
              <span className={cn('font-medium', getConfidenceColor(turn.intent!.confidence))}>
                {turn.intent!.confidence}%
              </span>
            </div>
            <Progress value={turn.intent!.confidence} className="h-2" />
          </div>

          {/* Alternatives if present */}
          {turn.intent!.alternatives && turn.intent!.alternatives.length > 0 && (
            <div className="pt-2 border-t">
              <span className="text-xs text-muted-foreground">Alternativas:</span>
              <div className="flex flex-wrap gap-1 mt-1">
                {turn.intent!.alternatives.map((alt, altIdx) => (
                  <Badge key={altIdx} variant="outline" className="text-xs">
                    {alt.intent} ({alt.confidence}%)
                  </Badge>
                ))}
              </div>
            </div>
          )}

          {/* Reasoning if present */}
          {turn.intent!.reasoning && (
            <div className="pt-2 border-t">
              <span className="text-xs text-muted-foreground">Razonamiento:</span>
              <p className="text-xs mt-1">{turn.intent!.reasoning}</p>
            </div>
          )}
        </div>
      ))}
    </div>
  )
}
```

Create `src/app/(dashboard)/sandbox/components/debug-panel/tokens-tab.tsx`:

```typescript
'use client'

/**
 * Tokens Tab Component
 * Phase 15: Agent Sandbox
 *
 * Shows token count per turn and cumulative total.
 */

import { Coins, TrendingUp } from 'lucide-react'
import { format } from 'date-fns'
import type { DebugTurn } from '@/lib/sandbox/types'

interface TokensTabProps {
  debugTurns: DebugTurn[]
  totalTokens: number
}

export function TokensTab({ debugTurns, totalTokens }: TokensTabProps) {
  if (debugTurns.length === 0) {
    return (
      <div className="flex items-center justify-center h-32 text-sm text-muted-foreground">
        No hay datos de tokens todavia
      </div>
    )
  }

  // Calculate running total for each turn
  let runningTotal = 0
  const turnsWithRunningTotal = debugTurns.map(turn => {
    runningTotal += turn.tokens.tokensUsed
    return {
      ...turn,
      runningTotal,
    }
  })

  // Calculate averages
  const avgPerTurn = totalTokens / debugTurns.length

  return (
    <div className="space-y-4">
      {/* Summary card */}
      <div className="border rounded-lg p-4 bg-muted/30">
        <div className="flex items-center gap-2 mb-3">
          <Coins className="h-5 w-5 text-primary" />
          <span className="font-medium">Resumen de tokens</span>
        </div>

        <div className="grid grid-cols-2 gap-4">
          <div>
            <div className="text-2xl font-bold">{totalTokens.toLocaleString()}</div>
            <div className="text-xs text-muted-foreground">Total acumulado</div>
          </div>
          <div>
            <div className="text-2xl font-bold">{Math.round(avgPerTurn).toLocaleString()}</div>
            <div className="text-xs text-muted-foreground">Promedio por turno</div>
          </div>
        </div>

        {/* Budget warning */}
        {totalTokens > 40000 && (
          <div className="mt-3 p-2 bg-yellow-100 dark:bg-yellow-900/30 rounded text-xs text-yellow-700 dark:text-yellow-300">
            Aproximandose al limite de 50K tokens por conversacion
          </div>
        )}
      </div>

      {/* Per-turn breakdown */}
      <div className="space-y-2">
        <div className="text-xs text-muted-foreground font-medium">Por turno</div>

        {turnsWithRunningTotal.map((turn, idx) => (
          <div
            key={idx}
            className="flex items-center justify-between p-2 border rounded-lg text-sm"
          >
            <div className="flex items-center gap-2">
              <span className="text-xs text-muted-foreground w-8">
                #{turn.turnNumber}
              </span>
              <span className="text-xs text-muted-foreground">
                {format(new Date(turn.tokens.timestamp), 'HH:mm:ss')}
              </span>
            </div>

            <div className="flex items-center gap-4">
              <span className="font-mono">
                +{turn.tokens.tokensUsed.toLocaleString()}
              </span>
              <span className="text-xs text-muted-foreground flex items-center gap-1">
                <TrendingUp className="h-3 w-3" />
                {turn.runningTotal.toLocaleString()}
              </span>
            </div>
          </div>
        ))}
      </div>
    </div>
  )
}
```
  </action>
  <verify>
Run `npx tsc --noEmit src/app/\(dashboard\)/sandbox/components/debug-panel/debug-tabs.tsx` to verify all tabs compile together.
Verify all exports are correct.
  </verify>
  <done>
State tab created with editable JSON viewer using @uiw/react-json-view.
Intent tab shows intent name, confidence bar, alternatives, and reasoning.
Tokens tab shows per-turn breakdown and running total with budget warning.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create index file for debug panel</name>
  <files>
    src/app/(dashboard)/sandbox/components/debug-panel/index.ts
  </files>
  <action>
Create `src/app/(dashboard)/sandbox/components/debug-panel/index.ts`:

```typescript
/**
 * Debug Panel Exports
 * Phase 15: Agent Sandbox
 */

export { DebugTabs } from './debug-tabs'
export { ToolsTab } from './tools-tab'
export { StateTab } from './state-tab'
export { IntentTab } from './intent-tab'
export { TokensTab } from './tokens-tab'
```
  </action>
  <verify>
Run `npx tsc --noEmit src/app/\(dashboard\)/sandbox/components/debug-panel/index.ts` to verify exports compile.
  </verify>
  <done>
Index file exports all debug panel components.
  </done>
</task>

</tasks>

<verification>
1. All debug panel components compile without errors
2. DebugTabs renders 4 tabs with correct icons
3. Tools tab shows expandable items with JSON preview
4. State tab renders JsonView with edit capability
5. Intent tab shows confidence progress bar
6. Tokens tab shows running total calculation
</verification>

<success_criteria>
- DebugTabs component renders 4 tabs: Tools, Estado, Intent, Tokens
- Tools tab expands/collapses to show tool input/output JSON
- State tab uses @uiw/react-json-view with editable: true
- Intent tab shows confidence with color-coded badge and progress bar
- Tokens tab shows per-turn breakdown and cumulative total
- All components properly typed with SandboxState and DebugTurn
</success_criteria>

<output>
After completion, create `.planning/phases/15-agent-sandbox/15-03-SUMMARY.md`
</output>
