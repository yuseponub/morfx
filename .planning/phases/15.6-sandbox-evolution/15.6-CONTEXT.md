# Phase 15.6: Sandbox Evolution - Context

**Gathered:** 2026-02-07
**Status:** Ready for planning

<domain>
## Phase Boundary

Evolucionar el sandbox de testing de agentes con: visibilidad de tools (dry-run + live), separacion de agentes conversacionales vs CRM, debug panel multi-panel drag & drop, nuevo tab Ingest con timers configurables, y tokens desglosados por modelo. Todo dentro del sandbox existente (/sandbox).

</domain>

<decisions>
## Implementation Decisions

### Tools & Dry-Run/Live
- En modo **dry-run** (default): mostrar simulacion completa - nombre del tool, inputs que SE ENVIARIAN, y respuesta mock simulada (contactId falso, orderId falso, etc.)
- En modo **live**: ejecutar tools reales contra la base de datos real de Supabase
- Los datos creados en modo live tienen prefijo `test-` en el nombre (ej: `test-Jose Romero`) para distinguirlos de datos reales
- Toggle dry-run/live es **por agente CRM** (cada uno tiene su propio toggle)

### Agent Separation (Conversacional vs CRM)
- **Agente conversacional** (Somnio): maneja flujo de venta, templates, clasificacion de intents. NO sabe que existen agentes CRM. Solo emite resultados (datos extraidos, pack seleccionado, compra confirmada)
- **Agentes CRM**: ejecutan operaciones de datos. Se seleccionan desde un **dropdown multi-select** en el sandbox. Se pueden activar varios al tiempo
- Agentes CRM organizados **por accion**: ej. "Order Manager" (crear orden - incluye crear contacto), "Edit Order" (buscar y editar), etc. Se iran creando mas progresivamente
- El **Order Manager** es un solo agente con **3 modos**: datos completos (flujo normal), solo datos sin promo, datos minimos (crear orden borrador)
- El **orquestador** es quien decide que agente CRM llamar, basado en el estado del flujo (no Somnio directamente)
- Los agentes CRM **pueden usar Claude** para decisiones complejas (ej: deduplicar contactos, inferir datos faltantes)
- Dropdown de agente conversacional (existente) + dropdown multi-select de agentes CRM (nuevo)

### Debug Panel Layout
- **Drag & drop panels** tipo IDE (VS Code) para acomodar paneles como el usuario quiera
- Maximo **3 paneles** visibles simultaneamente
- 5 tabs disponibles: Tools, Estado, Intent, Tokens, Ingest
- Layout **por defecto siempre** (no se guarda entre sesiones). Layout default: Tools + Estado visibles
- Tab **Ingest** muestra:
  - **Estado superior**: estado actual del ingest (activo/inactivo), campos acumulados, clasificacion del ultimo mensaje, tiempo restante del timer
  - **Timeline inferior**: cada mensaje clasificado (datos/pregunta/mixto/irrelevante) con timestamps y campos extraidos
  - **Controles de timer**: presets rapidos ("Real" 6min/10min, "Rapido" 30s/60s, "Instantaneo" 0s/0s) + sliders para ajuste fino

### Tokens por Modelo
- **Tabla por modelo**: columnas Modelo | Tokens Input | Tokens Output | Total
- Una fila por modelo usado (Haiku, Sonnet, y cualquier agente CRM que use Claude)
- Mostrar **input y output tokens por separado** (tienen precios distintos)
- **Solo tokens**, sin conversion a USD
- Desglose por turno + totales acumulados de la sesion

### Claude's Discretion
- Layout default exacto de los paneles drag & drop
- Implementacion tecnica del drag & drop (libreria a usar)
- Estructura interna de los agentes CRM (interfaces, types)
- Como el orquestador determina que agente CRM llamar (analizar codigo actual)
- Diseno visual de presets y sliders del tab Ingest

</decisions>

<specifics>
## Specific Ideas

- El usuario quiere poder probar agentes CRM por separado y en combinacion con el conversacional
- Los agentes CRM se van creando progresivamente: empezar con Order Manager, luego Edit Order, etc.
- Ingest necesita ser "jugable" - poder configurar timers para hacer pruebas rapidas sin esperar 6 minutos
- El sandbox es la herramienta principal de pruebas para TODOS los agentes (conversacionales y CRM)
- El patr√≥n Command/Handler: conversacional genera comandos, orquestador los rutea, CRM los ejecuta

</specifics>

<deferred>
## Deferred Ideas

- Ninguna - la discusion se mantuvo dentro del alcance de la fase

</deferred>

---

*Phase: 15.6-sandbox-evolution*
*Context gathered: 2026-02-07*
