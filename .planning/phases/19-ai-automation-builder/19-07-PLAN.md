---
phase: 19-ai-automation-builder
plan: 07
type: execute
wave: 4
depends_on: ["19-05", "19-06"]
files_modified:
  - src/app/(dashboard)/automatizaciones/builder/components/builder-message.tsx
  - src/app/(dashboard)/automatizaciones/builder/components/builder-chat.tsx
  - src/app/(dashboard)/automatizaciones/builder/components/builder-layout.tsx
autonomous: true

must_haves:
  truths:
    - "generatePreview tool results render as React Flow diagrams inline in chat"
    - "Confirm button in diagram appends a confirmation message triggering createAutomation"
    - "Modify button focuses the input for the user to describe changes"
    - "After creation, the automation link is shown in the chat"
  artifacts:
    - path: "src/app/(dashboard)/automatizaciones/builder/components/builder-message.tsx"
      provides: "Message rendering with diagram preview for generatePreview tool results"
      min_lines: 80
  key_links:
    - from: "src/app/(dashboard)/automatizaciones/builder/components/builder-message.tsx"
      to: "src/app/(dashboard)/automatizaciones/builder/components/automation-preview.tsx"
      via: "dynamic import for generatePreview tool results"
      pattern: "dynamic.*automation-preview"
    - from: "builder-chat.tsx"
      to: "useChat.append"
      via: "Programmatic message append for confirmation"
      pattern: "append"
---

<objective>
Wire the diagram preview component into the chat message rendering. When the generatePreview tool returns results, render the React Flow diagram inline. Wire the confirmation buttons to trigger automation creation/update via programmatic message append.

Purpose: Complete the preview-confirm-create flow that is the core UX of the builder.
Output: End-to-end flow: user describes -> agent generates preview -> diagram shown -> user confirms -> automation created.
</objective>

<execution_context>
@/home/jose147/.claude/get-shit-done/workflows/execute-plan.md
@/home/jose147/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/19-ai-automation-builder/19-05-PLAN.md
@.planning/phases/19-ai-automation-builder/19-06-PLAN.md
@src/app/(dashboard)/automatizaciones/builder/components/builder-message.tsx
@src/app/(dashboard)/automatizaciones/builder/components/builder-chat.tsx
@src/app/(dashboard)/automatizaciones/builder/components/automation-preview.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Wire diagram preview into message rendering</name>
  <files>
    src/app/(dashboard)/automatizaciones/builder/components/builder-message.tsx
    src/app/(dashboard)/automatizaciones/builder/components/builder-chat.tsx
  </files>
  <action>
    1. **Update builder-message.tsx**:

    Replace the `PreviewPlaceholder` from Plan 05 with the actual AutomationPreview component.

    Use dynamic import for the preview to avoid SSR issues:
    ```tsx
    import dynamic from 'next/dynamic'

    const AutomationPreview = dynamic(
      () => import('./automation-preview').then(mod => mod.AutomationPreview),
      { ssr: false, loading: () => <div className="w-full h-48 rounded-lg border animate-pulse bg-muted" /> }
    )
    ```

    Update the tool-invocation rendering for `generatePreview`:
    ```tsx
    if (part.toolInvocation.state === 'result' && part.toolInvocation.toolName === 'generatePreview') {
      const previewData = part.toolInvocation.result as AutomationPreviewData
      return (
        <AutomationPreview
          key={i}
          data={previewData}
          onConfirm={() => onConfirmPreview(previewData)}
          onModify={onModifyRequest}
          isUpdate={!!previewData.existingAutomationId}
        />
      )
    }
    ```

    Also handle `createAutomation` and `updateAutomation` tool results:
    ```tsx
    if (part.toolInvocation.state === 'result' && part.toolInvocation.toolName === 'createAutomation') {
      const result = part.toolInvocation.result
      if (result?.success) {
        return (
          <div key={i} className="flex items-center gap-2 text-sm text-green-600 dark:text-green-400">
            <CheckCircle2 className="h-4 w-4" />
            Automatizacion creada
          </div>
        )
      }
    }
    ```

    The `onConfirmPreview` and `onModifyRequest` callbacks come as props from BuilderChat.

    Update BuilderMessage props to include:
    ```typescript
    interface BuilderMessageProps {
      message: Message
      onConfirmPreview: (data: AutomationPreviewData) => void
      onModifyRequest: () => void
    }
    ```

    2. **Update builder-chat.tsx**:

    Add `append` from useChat for programmatic message sending:
    ```tsx
    const { messages, input, handleInputChange, handleSubmit, isLoading, error, append } = useChat({...})
    ```

    Implement confirmation handler:
    ```typescript
    const handleConfirmPreview = useCallback((previewData: AutomationPreviewData) => {
      // Append a user message that tells the agent to create
      append({
        role: 'user',
        content: 'Confirmo. Crea la automatizacion.',
      })
    }, [append])
    ```

    The agent will see this confirmation message and call the `createAutomation` tool.

    Implement modify handler:
    ```typescript
    const handleModifyRequest = useCallback(() => {
      // Focus the input and optionally pre-fill with "Quiero cambiar..."
      inputRef.current?.focus()
    }, [])
    ```

    Add an `inputRef` and pass it to BuilderInput for focus management.

    Pass callbacks to each BuilderMessage:
    ```tsx
    {messages.map(message => (
      <BuilderMessage
        key={message.id}
        message={message}
        onConfirmPreview={handleConfirmPreview}
        onModifyRequest={handleModifyRequest}
      />
    ))}
    ```

    3. **Handle post-creation state**:
    After the agent creates an automation (createAutomation tool returns success), the agent's text response should contain the link. The markdown rendering in the text part will make it clickable. No special handling needed beyond rendering the agent's text response which will contain the link per the system prompt instructions.
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - builder-message.tsx dynamically imports AutomationPreview
    - Confirmation button appends a user message via useChat.append
    - Modify button focuses the input
  </verify>
  <done>
    - generatePreview results render as React Flow diagrams inline
    - "Crear automatizacion" button sends confirmation message to agent
    - "Modificar" button focuses input for user changes
    - createAutomation results show success indicator
    - Full create flow works: describe -> preview -> confirm -> created
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire generatePreview tool to use diagram generator</name>
  <files>
    src/lib/builder/tools.ts
  </files>
  <action>
    Update the `generatePreview` tool's `execute` function in `src/lib/builder/tools.ts` to use the real diagram generator and validation from Plan 04.

    Import:
    ```typescript
    import { automationToDiagram } from '@/lib/builder/diagram-generator'
    import { validateResources, detectCycles, findDuplicateAutomations } from '@/lib/builder/validation'
    ```

    Update the `generatePreview` execute function:
    ```typescript
    execute: async (params) => {
      // 1. Validate resources
      const resourceValidations = await validateResources(ctx.workspaceId, {
        name: params.name,
        trigger_type: params.trigger_type as TriggerType,
        trigger_config: params.trigger_config || {},
        actions: params.actions as AutomationAction[],
        conditions: params.conditions || null,
      })

      // 2. Check cycles
      const cycleResult = await detectCycles(ctx.workspaceId, {
        name: params.name,
        trigger_type: params.trigger_type as TriggerType,
        trigger_config: params.trigger_config || {},
        actions: params.actions as AutomationAction[],
      })

      // 3. Check duplicates
      const duplicateResult = await findDuplicateAutomations(ctx.workspaceId, {
        name: params.name,
        trigger_type: params.trigger_type as TriggerType,
        trigger_config: params.trigger_config || {},
        actions: params.actions as AutomationAction[],
      })

      // 4. Generate diagram
      const diagram = automationToDiagram(
        {
          name: params.name,
          trigger_type: params.trigger_type,
          trigger_config: params.trigger_config || {},
          conditions: params.conditions || null,
          actions: params.actions,
        },
        resourceValidations
      )

      // 5. Return complete preview data
      return {
        name: params.name,
        description: params.description || null,
        trigger_type: params.trigger_type,
        trigger_config: params.trigger_config || {},
        conditions: params.conditions || null,
        actions: params.actions,
        diagram,
        resourceValidations,
        hasCycles: cycleResult.hasCycles,
        duplicateWarning: duplicateResult.isDuplicate
          ? `Ya existe(n) automatizacion(es) similar(es): ${duplicateResult.existing.map(e => e.name).join(', ')}`
          : null,
      }
    }
    ```

    This connects Plans 02 and 04 into the working preview pipeline.
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - generatePreview tool imports and uses diagram-generator and validation
    - Returns AutomationPreviewData with diagram, validations, cycles, duplicates
  </verify>
  <done>
    - generatePreview tool produces real diagram data with validation
    - Resource validation runs against workspace DB
    - Cycle detection included in preview
    - Duplicate warning included in preview
  </done>
</task>

</tasks>

<verification>
- TypeScript compiles: `npx tsc --noEmit`
- Full flow: user sends message -> agent generates preview -> diagram renders -> user clicks Confirm -> automation created
- Diagram shows inline in chat with proper styling
- Confirmation buttons trigger the right actions
</verification>

<success_criteria>
End-to-end builder flow works: natural language description -> validated preview diagram -> user confirmation -> automation created (disabled). Diagram renders with validated nodes showing errors/warnings. Post-creation shows success with link.
</success_criteria>

<output>
After completion, create `.planning/phases/19-ai-automation-builder/19-07-SUMMARY.md`
</output>
