---
phase: 16.1-engine-unification
plan: 04
subsystem: engine
tags: [unified-engine, ports-adapters, sandbox, somnio-agent, dependency-injection]

# Dependency graph
requires:
  - phase: 16.1-01
    provides: "Adapter interfaces and engine types (EngineInput, EngineOutput, EngineConfig, EngineAdapters)"
  - phase: 16.1-02
    provides: "SomnioAgent class with all business logic extracted"
  - phase: 16.1-03
    provides: "Sandbox and production adapter implementations"
provides:
  - "UnifiedEngine class — thin I/O runner connecting input -> SomnioAgent -> adapters"
  - "Sandbox API route using UnifiedEngine with sandbox adapters"
affects: ["16.1-05 (production wiring)", "16.1-06 (verification)"]

# Tech tracking
tech-stack:
  added: []
  patterns: ["per-request engine instantiation for stateful adapters", "EngineOutput to SandboxEngineResult mapping"]

key-files:
  created:
    - "src/lib/agents/engine/unified-engine.ts"
  modified:
    - "src/lib/agents/engine/index.ts"
    - "src/app/api/sandbox/process/route.ts"

key-decisions:
  - "Engine created per-request (not module-level) because sandbox adapters hold per-request state"
  - "EngineOutput mapped to SandboxEngineResult shape explicitly in route for frontend compatibility"
  - "Order result messages added by engine (not agent) since they depend on adapter mode configuration"

patterns-established:
  - "Per-request engine pattern: create adapters + engine per POST for stateful sandbox processing"
  - "Engine delegates ALL business logic to SomnioAgent, ALL I/O to adapters — zero business decisions in engine"

# Metrics
duration: 8min
completed: 2026-02-10
---

# Phase 16.1 Plan 04: UnifiedEngine + Sandbox Wiring Summary

**UnifiedEngine thin runner created with SomnioAgent delegation and sandbox API route wired to unified pipeline**

## Performance

- **Duration:** ~8 min
- **Started:** 2026-02-10T17:09:39Z
- **Completed:** 2026-02-10T17:17:36Z
- **Tasks:** 2/2
- **Files modified:** 3

## Accomplishments

- Created UnifiedEngine class as thin I/O runner: get session -> call SomnioAgent -> route output to 5 adapters
- Wired sandbox API route to use UnifiedEngine + createSandboxAdapters instead of SandboxEngine
- Frontend receives identical SandboxEngineResult shape (success, messages, debugTurn, newState, timerSignal, error)

## Task Commits

Each task was committed atomically:

1. **Task 1: Create UnifiedEngine class** - `8dc46df` (feat)
2. **Task 2: Wire sandbox API route to UnifiedEngine** - `073388b` (feat)

## Files Created/Modified

- `src/lib/agents/engine/unified-engine.ts` - UnifiedEngine class: thin runner connecting input -> SomnioAgent -> 5 adapters
- `src/lib/agents/engine/index.ts` - Added `export { UnifiedEngine }` to barrel
- `src/app/api/sandbox/process/route.ts` - Updated from SandboxEngine to UnifiedEngine + createSandboxAdapters

## Decisions Made

- **Per-request engine instantiation:** Unlike old SandboxEngine (module-level singleton), the unified engine is created per-request because sandbox adapters hold request-specific state (SandboxState, history). This is the correct pattern for stateful adapters.
- **Order message generation in engine:** The engine adds CRM result messages (`[SANDBOX: CRM DRY-RUN - Order created...]`) because this depends on the adapter's CRM mode configuration, which the agent doesn't know about. This keeps the agent pure (no adapter-specific messages).
- **State snapshot via adapter cast:** Engine uses `(storage as { getState? }).getState()` to get sandbox state snapshot for debug panel. This is a sandbox-specific path that production adapters simply won't expose.

## Deviations from Plan

None - plan executed exactly as written.

## Issues Encountered

None.

## User Setup Required

None - no external service configuration required.

## Next Phase Readiness

- UnifiedEngine is ready for production wiring (Plan 05 - running in parallel)
- Sandbox verification (Plan 06) can test the unified sandbox pipeline
- Old SandboxEngine preserved as backup per CONTEXT.md migration strategy

---
*Phase: 16.1-engine-unification*
*Completed: 2026-02-10*
