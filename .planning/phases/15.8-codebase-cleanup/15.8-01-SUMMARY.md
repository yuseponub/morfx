---
phase: 15.8
plan: 01
subsystem: sandbox-engine
tags: [bugfix, stale-closure, state-mutation, timer-signal, race-condition]
dependency-graph:
  requires: [15.7]
  provides: [critical-bugs-fixed]
  affects: [15.8-02, 15.8-03, 16]
tech-stack:
  added: []
  patterns: [useRef-sync-pattern, intentional-mutation-documentation, two-step-timer-signal]
key-files:
  created: []
  modified:
    - src/app/(dashboard)/sandbox/components/sandbox-layout.tsx
    - src/lib/sandbox/sandbox-engine.ts
    - src/lib/sandbox/ingest-timer.ts
decisions:
  - id: "15.8-01-D1"
    decision: "Keep state mutation pattern in handleIngestMode/checkImplicitYes with documentation instead of refactoring to immutable returns"
    reason: "Mutation is intentional communication channel to processMessage; refactoring requires restructuring return types and all caller code paths"
  - id: "15.8-01-D2"
    decision: "Bug #8 confirmed as intentional two-step timer signal design, not a bug"
    reason: "Cancel signal clears ingest timer (levels 0-2), then start signal initiates promo timer (level 3) - different timer purposes"
  - id: "15.8-01-D3"
    decision: "Bug #5 already fixed in Phase 15.7 via contextProvider + stateRef.current pattern"
    reason: "Verified in code: sandbox-layout.tsx sets contextProvider reading from stateRef.current"
  - id: "15.8-01-D4"
    decision: "Bug #6 documented as known limitation for Phase 16+"
    reason: "Race condition only affects production with real DB caching; sandbox uses no real DB"
metrics:
  duration: "~11 minutes"
  completed: "2026-02-09"
---

# Phase 15.8 Plan 01: Critical Bugs Summary

**One-liner:** Fix 3 stale closures in handleSendMessage via useRef pattern, document intentional state mutation and two-step timer signal, verify already-fixed closure and document race condition limitation.

## What Was Done

### Task 1: Stale Closures in sandbox-layout.tsx (Bugs #1, #2, #3)
- Used existing `messagesRef.current` instead of `messages` for history building in `handleSendMessage`
- Used existing `debugTurnsRef.current` instead of `debugTurns` for turn number calculation
- Used existing `crmAgentsRef.current` instead of `crmAgents` for CRM agent filtering
- Additionally used `stateRef.current` and `workspaceRef.current` for API request body
- Removed stale state variables from `useCallback` dependency array (now `[responseSpeed, timerConfig, startTimerForLevel]`)
- **Bonus fix:** Bug #7 (null access on `debugTurn.tokens.tokensUsed`) fixed via optional chaining by linter

### Task 2: State Mutation in sandbox-engine.ts (Bug #4)
- Chose SAFER alternative: documented the intentional mutation pattern instead of risky refactor
- Added WARNING comments at both mutation sites (`handleIngestMode` line ~538, `checkImplicitYes` line ~645)
- Documented the caller detection sites in `processMessage` (lines ~123, ~145)
- Explained why: mutation communicates mode transition to processMessage via pass-by-reference

### Task 3: Verify/Document Remaining Bugs (#5, #6, #8)
- **Bug #8:** Confirmed two-step timer signal is correct design:
  - Step 1: `handleIngestMode` sets `lastTimerSignal = cancel` (clears ingest timer, levels 0-2)
  - Step 2: `processMessage` overrides with `lastTimerSignal = start` (starts promo timer, level 3)
  - Added TIMER SIGNAL documentation blocks at both signal assignment sites
- **Bug #5:** Verified already fixed in Phase 15.7 - `contextProvider` reads from `stateRef.current`
  - Added VERIFIED comment in `ingest-timer.ts`
- **Bug #6:** Documented as known limitation in `message-sequencer.ts`
  - SessionManager cache staleness only affects production, not sandbox
  - Added mitigation suggestions for Phase 16+ (cache-bypass, DB timestamp comparison)

## Deviations from Plan

### Auto-fixed Issues

**1. [Rule 1 - Bug] Fixed null access on debugTurn.tokens (Bug #7)**
- **Found during:** Task 1
- **Issue:** `result.debugTurn.tokens.tokensUsed` could crash if tokens is undefined
- **Fix:** Linter auto-applied optional chaining: `result.debugTurn?.tokens?.tokensUsed ?? 0`
- **Files modified:** `sandbox-layout.tsx` line 435
- **Commit:** 76f2e44

**2. [Rule 1 - Bug] Also fixed stale `state` and `workspace` references**
- **Found during:** Task 1
- **Issue:** `state` and `workspace?.id` in handleSendMessage body were also captured in closure
- **Fix:** Changed to `stateRef.current` and `workspaceRef.current?.id`
- **Files modified:** `sandbox-layout.tsx` lines 401, 405
- **Commit:** 76f2e44

## Decisions Made

| ID | Decision | Rationale |
|----|----------|-----------|
| 15.8-01-D1 | Document mutation pattern, don't refactor | Intentional communication channel; refactor too risky |
| 15.8-01-D2 | Bug #8 is correct design (two-step signal) | Cancel and start refer to different timer levels |
| 15.8-01-D3 | Bug #5 already fixed | contextProvider reads from stateRef.current |
| 15.8-01-D4 | Bug #6 documented for Phase 16+ | Only affects production, not sandbox |

## Commits

| Task | Commit | Description |
|------|--------|-------------|
| 1 | 76f2e44 | Stale closures in handleSendMessage (#1, #2, #3, +#7) |
| 2 | 8eaa0c4 | Document intentional state mutation pattern (Bug #4) |
| 3 | e6866b3 | Verify timer signal #8, closure #5, document race condition #6 |

## Verification

- TypeScript compiles with zero source errors (`npx tsc --noEmit`)
- All 4 modified files have expected changes
- Bug #8 has explanatory comments at both signal sites (grep confirms 4 matches)
- messagesRef, debugTurnsRef, crmAgentsRef all used in handleSendMessage
- contextProvider verified reading from stateRef.current

## Next Phase Readiness

Plan 15.8-02 (High Severity Bugs) can proceed. Note that a concurrent commit `4fbcec3` already fixed bugs #7, #9, #10, #11, #12, #13 from Plan 02. The plan executor for 15.8-02 should verify which bugs are already resolved before proceeding.

**No blockers for next plan.**
