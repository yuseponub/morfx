# Phase 16.1 Plan 02: SomnioAgent Extraction Summary

**One-liner:** Extracted full Somnio business logic from both engines into single SomnioAgent class with explicit return values replacing state mutation

## Execution Details

| Field | Value |
|-------|-------|
| Phase | 16.1-engine-unification |
| Plan | 02 |
| Type | execute |
| Started | 2026-02-10T16:55:51Z |
| Completed | 2026-02-10T17:01:47Z |
| Duration | ~6 min |
| Tasks | 1/1 |

## Commits

| Hash | Type | Description |
|------|------|-------------|
| 63ea3b1 | feat | create SomnioAgent with full business logic |

## What Was Built

### SomnioAgent Class (744 lines)
**File:** `src/lib/agents/somnio/somnio-agent.ts`

The single source of truth for all Somnio agent business logic, extracted from both `SandboxEngine` (681 lines) and `SomnioEngine` (844 lines).

**Exports:**
- `SomnioAgent` — Main class with `processMessage()` entry point
- `SomnioAgentInput` — Input interface (message, session, history, turnNumber, forceIntent)
- `SomnioAgentOutput` — Output interface (messages, stateUpdates, timerSignals, shouldCreateOrder, tokens, debug)

**Architecture:**
- Receives pre-fetched data (no I/O operations)
- Returns output signals (messages, state updates, timer signals, order creation flag)
- UnifiedEngine (Plan 04) will call adapters based on these signals
- All Somnio components created directly in constructor (not injectable per CONTEXT.md)

### Critical Refactoring: State Mutation Elimination

Both SandboxEngine's `handleIngestMode` and `checkImplicitYes` used intentional state mutation (`currentState.currentMode = 'ofrecer_promos'`) as a communication channel to the caller. This was refactored to explicit return types:

```typescript
interface IngestModeResult {
  handled: boolean
  earlyReturn?: SomnioAgentOutput
  modeChanged?: string       // Replaces currentState.currentMode mutation
  updatedData?: Record<string, string>
  updatedIngestStatus?: any
  timerSignal?: { type: 'start' | 'reevaluate' | 'cancel'; reason?: string }
}
```

The caller (`processMessage`) now explicitly consumes these results:
```typescript
if (ingestResult.modeChanged) {
  justCompletedIngest = ingestResult.modeChanged === 'ofrecer_promos'
  currentMode = ingestResult.modeChanged
}
```

### 8 Preservation Items Verified

1. **Ingest mode complete flow** — datos/pregunta/mixto/irrelevante classification via IngestManager, silent accumulation for datos
2. **Implicit yes** — datos outside collecting_data detected via MessageClassifier, transitions to collecting_data (partial) or ofrecer_promos (complete)
3. **forceIntent** — skip intent detection, confidence 100%, skip templates on compra_confirmada
4. **Timer signals** — start on collecting_data entry, cancel+start two-step on ingest complete->promos, reevaluate on other transitions
5. **IngestStatus tracking** — timeline, fieldsAccumulated, lastClassification, firstDataAt, active flag
6. **Mock session intentsVistos ordering** — BEFORE current intent via `intentsVistosBeforeCurrent` for primera_vez/siguientes detection
7. **State mutation refactored** — explicit IngestModeResult/ImplicitYesResult return values
8. **Two-step timer signal pattern** — preserved via timerSignals array (cancel ingest L0-L2, then start promo L3)

## Decisions Made

| Decision | Rationale |
|----------|-----------|
| Use `unknown` for IngestStatus types | Agent is environment-agnostic; sandbox IngestStatus shape is debug-specific |
| Mock session built inside agent | SomnioOrchestrator expects AgentSessionWithState; agent builds compatible mock from AgentSessionLike |
| `as Parameters<>` cast for orchestrator | AgentSessionLike lacks timestamp fields (created_at, etc.) that AgentSessionWithState has but orchestrator never uses |
| Timer signals as array, not single value | Preserves two-step pattern (cancel + start) without overwriting signals |

## Verification

- [x] `npx tsc --noEmit` passes (no errors in somnio-agent.ts)
- [x] No `currentState.currentMode =` mutation patterns
- [x] Exports: SomnioAgent, SomnioAgentInput, SomnioAgentOutput
- [x] No direct DB/Inngest/MessageSequencer calls
- [x] All 8 preservation items present in code
- [x] Mock session uses intentsVistos BEFORE current intent

## Deviations from Plan

None — plan executed exactly as written.

## Key Links

| From | To | Via |
|------|----|----|
| somnio-agent.ts | engine/types.ts | imports AgentSessionLike |
| somnio-agent.ts | somnio-orchestrator.ts | orchestrator.orchestrate() |
| somnio-agent.ts | ingest-manager.ts | ingestManager.handleMessage() |
| somnio-agent.ts | message-classifier.ts | messageClassifier.classify() |
| somnio-agent.ts | intent-detector.ts | intentDetector.detect() |
| somnio-agent.ts | data-extractor.ts | mergeExtractedData, hasCriticalData |
| somnio-agent.ts | config.ts | somnioAgentConfig |
| somnio-agent.ts | registry.ts | agentRegistry.get() |

## Next Phase Readiness

SomnioAgent is ready for Plan 04 (UnifiedEngine) to consume:
- `processMessage(input: SomnioAgentInput): Promise<SomnioAgentOutput>`
- UnifiedEngine calls adapters based on output signals (messages, stateUpdates, timerSignals, shouldCreateOrder)
- No blockers or concerns

---
*Plan 02 of Phase 16.1-engine-unification*
*Completed: 2026-02-10*
