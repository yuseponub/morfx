---
phase: 14-agente-ventas-somnio
plan: 03
type: execute
wave: 2
depends_on: ["14-01"]
files_modified:
  - src/lib/agents/somnio/template-manager.ts
  - src/lib/agents/somnio/variable-substitutor.ts
  - src/lib/agents/somnio/index.ts
autonomous: true

must_haves:
  truths:
    - "Templates load from agent_templates table by agent_id and intent"
    - "Template selection distinguishes primera_vez vs siguientes visits"
    - "Variables like {{nombre}}, {{precio}} are substituted with actual values"
    - "Hardcoded prices: 1x=$77,900, 2x=$109,900, 3x=$139,900"
    - "Templates track which have been sent to avoid repetition"
  artifacts:
    - path: "src/lib/agents/somnio/template-manager.ts"
      provides: "TemplateManager class for loading, selecting, tracking templates"
      exports: ["TemplateManager", "TemplateSelection"]
    - path: "src/lib/agents/somnio/variable-substitutor.ts"
      provides: "Variable substitution for template content"
      exports: ["substituteVariables", "SOMNIO_PRICES"]
  key_links:
    - from: "src/lib/agents/somnio/template-manager.ts"
      to: "agent_templates table"
      via: "Supabase admin client query"
      pattern: "from\\('agent_templates'\\)"
    - from: "src/lib/agents/somnio/variable-substitutor.ts"
      to: "datos_capturados in SessionState"
      via: "Variable values from captured data"
      pattern: "\\{\\{\\w+\\}\\}"
---

<objective>
Create Template Manager for loading and selecting message templates from database, plus variable substitution for dynamic content.

Purpose: Templates are the Somnio agent's responses. Each intent maps to a sequence of messages (primera_vez or siguientes). Variables like {{nombre}} personalize responses.

Output: TemplateManager class, variable substitution utility, ready for MessageSequencer to use.
</objective>

<execution_context>
@/home/jose147/.claude/get-shit-done/workflows/execute-plan.md
@/home/jose147/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/14-agente-ventas-somnio/14-CONTEXT.md
@.planning/phases/14-agente-ventas-somnio/14-01-SUMMARY.md
@src/lib/agents/types.ts
@src/lib/supabase/admin.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create variable substitution utility</name>
  <files>
    src/lib/agents/somnio/variable-substitutor.ts
  </files>
  <action>
Create src/lib/agents/somnio/variable-substitutor.ts:

1. SOMNIO_PRICES constant:
```typescript
export const SOMNIO_PRICES = {
  '1x': '$77,900',
  '2x': '$109,900',
  '3x': '$139,900',
} as const

export type PackType = keyof typeof SOMNIO_PRICES
```

2. VariableContext interface:
```typescript
interface VariableContext {
  nombre?: string
  apellido?: string
  telefono?: string
  direccion?: string
  ciudad?: string
  departamento?: string
  barrio?: string
  // Computed/special variables
  precio?: string
  precio_1x?: string
  precio_2x?: string
  precio_3x?: string
  pack?: PackType
  // Allow additional arbitrary values
  [key: string]: string | undefined
}
```

3. substituteVariables function:
```typescript
export function substituteVariables(
  template: string,
  context: VariableContext
): string {
  // Pre-populate price variables
  const fullContext = {
    ...context,
    precio_1x: SOMNIO_PRICES['1x'],
    precio_2x: SOMNIO_PRICES['2x'],
    precio_3x: SOMNIO_PRICES['3x'],
    precio: context.pack ? SOMNIO_PRICES[context.pack] : SOMNIO_PRICES['1x'],
  }

  // Replace all {{variable}} patterns
  return template.replace(/\{\{(\w+)\}\}/g, (match, varName) => {
    const value = fullContext[varName]
    return value ?? match // Keep original if not found
  })
}
```

4. extractVariables function:
```typescript
export function extractVariables(template: string): string[] {
  const matches = template.matchAll(/\{\{(\w+)\}\}/g)
  return [...new Set([...matches].map(m => m[1]))]
}
```

5. hasUnsubstitutedVariables function:
```typescript
export function hasUnsubstitutedVariables(text: string): boolean {
  return /\{\{\w+\}\}/.test(text)
}
```
  </action>
  <verify>
```typescript
// Test cases
substituteVariables('Hola {{nombre}}, el precio es {{precio_1x}}', { nombre: 'Juan' })
  === 'Hola Juan, el precio es $77,900'

extractVariables('{{nombre}} - {{precio}}') === ['nombre', 'precio']

hasUnsubstitutedVariables('Hola {{nombre}}') === true
hasUnsubstitutedVariables('Hola Juan') === false
```
TypeScript compiles without errors.
  </verify>
  <done>
Variable substitution utility with {{variable}} pattern replacement, price constants, and variable extraction.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Template Manager component</name>
  <files>
    src/lib/agents/somnio/template-manager.ts
    src/lib/agents/somnio/index.ts
  </files>
  <action>
Create src/lib/agents/somnio/template-manager.ts:

1. TemplateSelection interface:
```typescript
interface TemplateSelection {
  templates: AgentTemplate[]
  visitType: 'primera_vez' | 'siguientes'
  alreadySent: string[] // Template IDs already sent
}
```

2. ProcessedTemplate interface:
```typescript
interface ProcessedTemplate {
  id: string
  content: string // After variable substitution
  contentType: 'texto' | 'template' | 'imagen'
  delaySeconds: number
  orden: number
}
```

3. TemplateManager class:
```typescript
export class TemplateManager {
  private cache: Map<string, AgentTemplate[]> = new Map()
  private cacheExpiry: number = 5 * 60 * 1000 // 5 minutes
  private lastCacheUpdate: number = 0

  constructor(private workspaceId?: string) {}

  async getTemplatesForIntent(
    agentId: string,
    intent: string,
    templatesSent: string[]
  ): Promise<TemplateSelection>

  async processTemplates(
    templates: AgentTemplate[],
    context: VariableContext
  ): Promise<ProcessedTemplate[]>

  isFirstVisit(intent: string, intentsVistos: IntentRecord[]): boolean

  private async loadTemplates(agentId: string): Promise<AgentTemplate[]>
  private invalidateCache(): void
}
```

4. Implementation details:
   - loadTemplates: Query agent_templates WHERE agent_id = X AND (workspace_id IS NULL OR workspace_id = Y) ORDER BY intent, visit_type, orden
   - Use createAdminClient for database access (bypass RLS for agent operations)
   - getTemplatesForIntent:
     - Determine visit_type: primera_vez if intent not in intentsVistos, else siguientes
     - Filter templates by agent_id, intent, visit_type
     - Filter out already sent templates
     - Return TemplateSelection with ordenados templates
   - processTemplates:
     - Apply substituteVariables to each template
     - Return ProcessedTemplate[] with delay info
   - isFirstVisit: Check if intent appears in intentsVistos array

5. Template fallback logic:
   - If no templates for 'siguientes' exist, fall back to 'primera_vez'
   - If no templates at all for intent, return empty array (orchestrator handles)

Update src/lib/agents/somnio/index.ts:
- Export TemplateManager, TemplateSelection, ProcessedTemplate
- Export substituteVariables, SOMNIO_PRICES, extractVariables
  </action>
  <verify>
```bash
cd /mnt/c/Users/Usuario/Proyectos/morfx-new && npx tsc --noEmit
```
TypeScript compiles. TemplateManager properly typed with caching.
  </verify>
  <done>
TemplateManager component created that:
- Loads templates from database with caching
- Distinguishes primera_vez vs siguientes visits
- Tracks templates already sent
- Processes templates with variable substitution
- Returns ordered templates with delay info
  </done>
</task>

</tasks>

<verification>
1. substituteVariables handles all Somnio variables (nombre, precio, etc.)
2. SOMNIO_PRICES has correct hardcoded values
3. TemplateManager loads from agent_templates table
4. Visit type detection works correctly
5. Template caching implemented with 5-minute expiry
6. TypeScript compiles without errors
</verification>

<success_criteria>
- Variables like {{nombre}}, {{precio_1x}} substitute correctly
- TemplateManager queries database for templates
- First visit vs repeat visit templates selected correctly
- Sent template tracking prevents repetition
- Templates ordered by 'orden' field
</success_criteria>

<output>
After completion, create `.planning/phases/14-agente-ventas-somnio/14-03-SUMMARY.md`
</output>
