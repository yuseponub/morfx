---
phase: 17-crm-automations-engine
plan: 05
type: execute
wave: 3
depends_on: ["17-01", "17-03"]
files_modified:
  - src/app/(dashboard)/automatizaciones/page.tsx
  - src/app/(dashboard)/automatizaciones/nueva/page.tsx
  - src/app/(dashboard)/automatizaciones/[id]/editar/page.tsx
  - src/app/(dashboard)/automatizaciones/components/automation-wizard.tsx
  - src/app/(dashboard)/automatizaciones/components/trigger-step.tsx
  - src/app/(dashboard)/automatizaciones/components/conditions-step.tsx
  - src/app/(dashboard)/automatizaciones/components/actions-step.tsx
  - src/app/(dashboard)/automatizaciones/components/variable-picker.tsx
autonomous: true

must_haves:
  truths:
    - "Usuario puede crear automatizacion con wizard de 3 pasos (trigger, condiciones, acciones)"
    - "Cada paso del wizard muestra opciones relevantes del catalogo"
    - "Condiciones soportan AND/OR groups combinables"
    - "Acciones se pueden agregar/remover/reordenar con delay opcional"
    - "Variable picker muestra variables disponibles segun el trigger seleccionado"
  artifacts:
    - path: "src/app/(dashboard)/automatizaciones/nueva/page.tsx"
      provides: "New automation page with wizard"
    - path: "src/app/(dashboard)/automatizaciones/components/automation-wizard.tsx"
      provides: "Multi-step wizard container"
    - path: "src/app/(dashboard)/automatizaciones/components/trigger-step.tsx"
      provides: "Step 1: Trigger selection and configuration"
    - path: "src/app/(dashboard)/automatizaciones/components/conditions-step.tsx"
      provides: "Step 2: AND/OR condition groups"
    - path: "src/app/(dashboard)/automatizaciones/components/actions-step.tsx"
      provides: "Step 3: Sequential actions with delays"
  key_links:
    - from: "src/app/(dashboard)/automatizaciones/components/automation-wizard.tsx"
      to: "src/app/actions/automations.ts"
      via: "Calls createAutomation/updateAutomation on submit"
      pattern: "createAutomation|updateAutomation"
    - from: "src/app/(dashboard)/automatizaciones/components/variable-picker.tsx"
      to: "src/lib/automations/constants.ts"
      via: "Reads VARIABLE_CATALOG for available variables"
      pattern: "VARIABLE_CATALOG"
---

<objective>
Build the automation builder wizard UI — a 3-step form (trigger, conditions, actions) for creating and editing automations.

Purpose: This is the primary user-facing interface for configuring automations. Users select a trigger type, define optional conditions (AND/OR groups), and configure one or more sequential actions with optional delays. The wizard uses data from TRIGGER_CATALOG, ACTION_CATALOG, and VARIABLE_CATALOG to show available options.

Output: Page routes and wizard components for creating/editing automations.

**SCOPE NOTE:** This plan is dense (2 tasks, 8 files). Task 1 handles 5 files (wizard container, trigger step, variable picker, and 2 page routes — all tightly coupled). Task 2 handles the remaining 2 component files. Monitor quality carefully during execution — if context usage approaches 50%, prioritize completing Task 1 fully before starting Task 2, and split Task 2 into a follow-up plan if needed.
</objective>

<execution_context>
@/home/jose147/.claude/get-shit-done/workflows/execute-plan.md
@/home/jose147/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/17-crm-automations-engine/17-CONTEXT.md
@src/lib/automations/types.ts
@src/lib/automations/constants.ts
@src/app/actions/automations.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Wizard container, trigger step, and variable picker</name>
  <files>
    src/app/(dashboard)/automatizaciones/nueva/page.tsx,
    src/app/(dashboard)/automatizaciones/[id]/editar/page.tsx,
    src/app/(dashboard)/automatizaciones/components/automation-wizard.tsx,
    src/app/(dashboard)/automatizaciones/components/trigger-step.tsx,
    src/app/(dashboard)/automatizaciones/components/variable-picker.tsx
  </files>
  <action>
**File 1: automation-wizard.tsx**
'use client' component. Multi-step wizard with 3 steps.

State:
```typescript
const [step, setStep] = useState(1) // 1: Trigger, 2: Conditions, 3: Actions
const [formData, setFormData] = useState<AutomationFormData>(initialData || defaultFormData)
const [isSubmitting, setIsSubmitting] = useState(false)
```

Layout:
- Header with automation name input (editable text) and step indicator (3 dots/circles with labels: Trigger, Condiciones, Acciones)
- Step content area (renders TriggerStep, ConditionsStep, or ActionsStep based on step)
- Footer with Back/Next/Guardar buttons. "Guardar" only on step 3. Disable Next if step validation fails.
- On submit: call `createAutomation(formData)` or `updateAutomation(id, formData)` and redirect to `/automatizaciones`

Props:
```typescript
interface WizardProps {
  initialData?: AutomationFormData & { id?: string }
  pipelines: PipelineWithStages[]
  tags: Tag[]
}
```

Pass pipelines and tags from server component pages (needed for select dropdowns in trigger config and action params).

**File 2: trigger-step.tsx**
'use client' component. Step 1 of the wizard.

- Show trigger categories (CRM, WhatsApp, Tareas) as grouped sections
- Each trigger type from TRIGGER_CATALOG shown as a selectable card with icon, label, description
- When a trigger is selected, show its configFields below:
  - `select` type: dropdown (populated with pipelines/stages/tags from props)
  - `text` type: text input
  - `tags` type: tag input (for keywords)
- Icons per category: Building2 for CRM, MessageSquare for WhatsApp, ListTodo for Tareas

Update formData.trigger_type and formData.trigger_config as user selects/configures.

**File 3: variable-picker.tsx**
'use client' component. Floating/inline variable picker.

- Takes `triggerType: TriggerType` prop
- Reads `VARIABLE_CATALOG[triggerType]` to get available variables
- Displays as a popover or dropdown with variable list
- Each variable shows: path (e.g., `contacto.nombre`) and label (e.g., `Nombre del contacto`)
- On click: calls `onInsert(variablePath)` callback which inserts `{{variablePath}}` at cursor position
- Used in actions step for text fields that support variables

**File 4: nueva/page.tsx**
Server component. Loads pipelines and tags, renders AutomationWizard with no initialData.

```typescript
export default async function NuevaAutomacionPage() {
  const pipelines = await getPipelines()  // from orders actions
  const tags = await getTags()            // from tags actions
  return <AutomationWizard pipelines={pipelines} tags={tags} />
}
```

**File 5: [id]/editar/page.tsx**
Server component. Loads automation by ID + pipelines + tags, renders AutomationWizard with initialData.

Use Tailwind and shadcn components (Card, Button, Input, Select, Badge, Popover) throughout.
  </action>
  <verify>New automation page renders at /automatizaciones/nueva. Wizard shows 3-step indicator. Trigger step shows all 10 trigger types grouped by category. Variable picker shows variables for selected trigger type. TypeScript compiles.</verify>
  <done>Wizard container with step navigation, trigger selection with config fields, variable picker with trigger-aware variable list, and new/edit page routes.</done>
</task>

<task type="auto">
  <name>Task 2: Conditions step and actions step</name>
  <files>
    src/app/(dashboard)/automatizaciones/components/conditions-step.tsx,
    src/app/(dashboard)/automatizaciones/components/actions-step.tsx
  </files>
  <action>
**File 1: conditions-step.tsx**
'use client' component. Step 2: Condition group builder.

Layout:
- Header: "Condiciones (opcional)" with explanation text: "Si no agregas condiciones, la automatizacion se ejecutara siempre que ocurra el trigger"
- "Agregar grupo de condiciones" button (creates a ConditionGroup)
- Each condition group is a Card with:
  - Logic toggle: AND/OR pill buttons at top
  - List of conditions, each row has:
    - Field selector (dropdown with common fields: order.stage_id, contact.city, order.tags, etc.)
    - Operator selector (dropdown: equals, not_equals, contains, in, gt, lt, etc.)
    - Value input (text, or multi-select for 'in'/'not_in')
    - Remove button (X icon)
  - "Agregar condicion" button inside the group
  - "Agregar sub-grupo" button (for nesting — creates a nested ConditionGroup)
  - Remove group button

State management: Update `formData.conditions` as user adds/removes conditions and groups.

Keep it simple — allow 1 level of nesting (a group can contain conditions and one level of sub-groups). Deep nesting is rare and adds UI complexity.

**File 2: actions-step.tsx**
'use client' component. Step 3: Action sequence builder.

Layout:
- Header: "Acciones" with count badge
- List of actions, each as a numbered Card:
  - Action type selector (grouped by category from ACTION_CATALOG)
  - Dynamic params form based on selected action type:
    - `select` params: dropdown (pipelines, stages, tags, users, templates)
    - `text` params: text input with variable picker button (if supportsVariables)
    - `textarea` params: textarea with variable picker (if supportsVariables)
    - `boolean` params: checkbox/switch
    - `delay` params: number input + unit selector (minutes/hours/days)
    - `key_value` params: key-value pair inputs (for webhook headers)
    - `json` params: textarea for JSON (for webhook payload)
  - Optional delay before action: toggle to enable, then number + unit selector
  - Remove action button
  - Drag handle for reorder (use simple up/down buttons, not full DnD — simpler for 1-10 items)
- "Agregar accion" button at bottom
- Show MAX_ACTIONS_PER_AUTOMATION limit warning when approaching limit
- VariablePicker component available for text fields that support variables

For `send_whatsapp_template` action: show a template selector dropdown. The available templates should be loaded via a prop or fetched client-side.

Use shadcn components: Card, Button, Input, Textarea, Select, Switch, Badge, Popover (for variable picker).

State management: Update `formData.actions` array as user adds/removes/reorders actions.
  </action>
  <verify>Conditions step allows creating AND/OR groups with conditions and nested sub-groups. Actions step shows all 11 action types with dynamic param forms. Variable picker insertable in text fields. Max actions limit displayed. TypeScript compiles.</verify>
  <done>Conditions step with AND/OR group builder and nested sub-groups. Actions step with all 11 action types, dynamic params, variable picker integration, delay config, and reorder controls.</done>
</task>

</tasks>

<verification>
1. Wizard navigates between 3 steps with proper state preservation
2. Trigger step shows all 10 trigger types with config fields
3. Conditions step builds AND/OR groups with nested support
4. Actions step supports all 11 action types with dynamic params
5. Variable picker shows trigger-specific variables
6. Form submits to createAutomation/updateAutomation server actions
7. Edit page loads existing automation data into wizard
8. TypeScript compiles without errors
</verification>

<success_criteria>
- Complete 3-step wizard for creating automations
- All trigger types, condition operators, and action types represented
- Variable picker context-aware based on selected trigger
- Form validation prevents empty required fields
- Works for both create (/nueva) and edit (/[id]/editar)
</success_criteria>

<output>
After completion, create `.planning/phases/17-crm-automations-engine/17-05-SUMMARY.md`
</output>
