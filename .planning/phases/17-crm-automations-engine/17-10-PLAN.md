---
phase: 17-crm-automations-engine
plan: 10
type: execute
wave: 6
depends_on: ["17-06", "17-07", "17-08", "17-09"]
files_modified: []
autonomous: false

must_haves:
  truths:
    - "Usuario puede crear automatizacion con trigger + condiciones + acciones via wizard"
    - "Automatizacion se ejecuta en tiempo real cuando trigger se dispara"
    - "Panel de historial muestra ejecuciones con estado y detalle por accion"
    - "Toggle habilita/deshabilita automatizacion"
    - "Ordenes conectadas visibles en detalle de orden"
    - "Sidebar muestra Automatizaciones con badge de fallos"
    - "TypeScript compila sin errores"
  artifacts: []
  key_links: []
---

<objective>
Verify all Phase 17 success criteria through TypeScript compilation, visual inspection, and functional testing.

Purpose: This is the final verification checkpoint before marking Phase 17 as complete. All 7 success criteria from the roadmap must be verifiable. The user will test the complete automation flow in the deployed application.

Output: Verification report confirming all success criteria pass or identifying gaps for closure.
</objective>

<execution_context>
@/home/jose147/.claude/get-shit-done/workflows/execute-plan.md
@/home/jose147/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/17-crm-automations-engine/17-CONTEXT.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: TypeScript compilation and structural verification</name>
  <files></files>
  <action>
Run full TypeScript check:
```bash
npx tsc --noEmit
```

Fix any compilation errors.

Then verify structural completeness:
1. Migration file exists: `supabase/migrations/*automations*.sql`
2. Types file exists: `src/lib/automations/types.ts`
3. Constants catalog exists: `src/lib/automations/constants.ts`
4. Condition evaluator exists: `src/lib/automations/condition-evaluator.ts`
5. Variable resolver exists: `src/lib/automations/variable-resolver.ts`
6. Action executor exists: `src/lib/automations/action-executor.ts`
7. Trigger emitter exists: `src/lib/automations/trigger-emitter.ts`
8. Server actions exist: `src/app/actions/automations.ts`
9. Inngest functions exist: `src/inngest/functions/automation-runner.ts`
10. Inngest route registers automations: grep for `automationFunctions` in `src/app/api/inngest/route.ts`
11. Builder wizard exists: `src/app/(dashboard)/automatizaciones/` with nueva/editar pages and components
12. List page exists: `src/app/(dashboard)/automatizaciones/page.tsx`
13. History page exists: `src/app/(dashboard)/automatizaciones/historial/page.tsx`
14. Sidebar includes Automatizaciones: grep for `automatizaciones` in `src/components/layout/sidebar.tsx`
15. Related orders exists: `src/app/(dashboard)/crm/orders/[id]/components/related-orders.tsx`
16. Trigger emission in server actions: grep for `emitOrder` in `src/app/actions/orders.ts`

Fix any issues found.
  </action>
  <verify>npx tsc --noEmit passes. All 16 structural checks pass.</verify>
  <done>TypeScript compiles. All automation engine artifacts exist and are properly wired.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete CRM Automations Engine with:
- 10 trigger types (CRM: stage change, tag, contact, order, field; WhatsApp: message, keyword; Tasks: completed, overdue)
- 11 action types (CRM: tag, stage, field, create order, duplicate order; WhatsApp: template, text, media; Tasks: create; Webhook)
- AND/OR condition groups with nested support
- Sequential action execution with optional delays
- Cascade protection (max 3 levels deep)
- Variable template resolution ({{contacto.nombre}}, etc.)
- 3-step wizard builder (trigger, conditions, actions)
- Automation list with enable/disable toggle, duplicate, delete
- Execution history with per-action detail
- Sidebar navigation with failure badge
- Connected orders (source_order_id) with related orders UI
  </what-built>
  <how-to-verify>
1. **Navigacion:**
   - [ ] /automatizaciones aparece en el sidebar con icono Zap
   - [ ] Pagina muestra lista vacia con estado "Crea tu primera automatizacion"
   - [ ] Boton "Nueva automatizacion" lleva a /automatizaciones/nueva

2. **Wizard de creacion:**
   - [ ] Paso 1 (Trigger): muestra 10 tipos de trigger agrupados por categoria
   - [ ] Seleccionar trigger muestra campos de configuracion
   - [ ] Paso 2 (Condiciones): permite crear grupo AND/OR con condiciones
   - [ ] Paso 3 (Acciones): permite agregar multiples acciones con delay opcional
   - [ ] Variable picker muestra variables disponibles segun trigger
   - [ ] Guardar crea la automatizacion y redirige a lista

3. **Lista de automatizaciones:**
   - [ ] Automatizacion creada aparece en la lista
   - [ ] Toggle habilita/deshabilita la automatizacion
   - [ ] Boton duplicar crea copia con "(copia)" en el nombre
   - [ ] Editar abre el wizard con datos pre-cargados
   - [ ] Eliminar con confirmacion funciona

4. **Ejecucion (requiere crear automatizacion de prueba):**
   - [ ] Crear automatizacion: trigger "Orden cambia de etapa" -> accion "Asignar tag"
   - [ ] Mover una orden de etapa en el CRM
   - [ ] Verificar que el tag se asigno automaticamente
   - [ ] /automatizaciones/historial muestra la ejecucion con estado "success"
   - [ ] Click en ejecucion muestra detalle con resultado de cada accion

5. **Ordenes conectadas:**
   - [ ] Crear automatizacion: "Orden creada" -> "Duplicar orden a otro pipeline"
   - [ ] Crear una orden -> verificar que se crea orden duplicada en otro pipeline
   - [ ] Detalle de la orden original muestra "Ordenes relacionadas" con la derivada
   - [ ] Click navega a la orden derivada
   - [ ] Orden derivada muestra relacion con la original

6. **Edge cases:**
   - [ ] Automatizacion deshabilitada NO se ejecuta
   - [ ] Badge en sidebar muestra numero de fallos recientes
   - [ ] Mobile nav incluye Automatizaciones

Desplegar a Vercel primero: `git push origin main`
URL: [Vercel deployment URL]
  </how-to-verify>
  <resume-signal>Escribe "aprobado" si todo funciona, o describe los problemas encontrados para crear planes de correccion.</resume-signal>
</task>

</tasks>

<verification>
Phase 17 Success Criteria verification (from ROADMAP.md):
1. [ ] Usuario puede crear automatizaciones con trigger + condiciones + accion
2. [ ] Triggers soportados: cambio de stage, tag, contacto/orden, WhatsApp
3. [ ] Acciones soportadas: crear orden, tag, WhatsApp, tarea
4. [ ] Condiciones combinables: AND/OR groups
5. [ ] Automatizaciones se ejecutan en tiempo real
6. [ ] Panel de historial muestra ejecuciones con estado
7. [ ] Toggle habilita/deshabilita
</verification>

<success_criteria>
All 7 phase success criteria pass. TypeScript compiles. User approves the deployment.
</success_criteria>

<output>
After completion, create `.planning/phases/17-crm-automations-engine/17-10-SUMMARY.md`
Then create `.planning/phases/17-crm-automations-engine/LEARNINGS-phase-17.md`
</output>
