---
phase: 14-agente-ventas-somnio
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/agents/somnio/data-extractor.ts
  - src/lib/agents/somnio/normalizers.ts
  - src/lib/agents/somnio/index.ts
autonomous: true

must_haves:
  truths:
    # User-observable behaviors (not implementation details)
    - "Customer's phone number displays correctly normalized in captured data"
    - "Customer's city appears with proper capitalization in session state"
    - "Department auto-fills when customer provides a known city"
    - "When customer says 'no tengo correo', the field shows N/A instead of empty"
    - "Agent captures all 9 data fields from free-form customer messages"
  artifacts:
    - path: "src/lib/agents/somnio/data-extractor.ts"
      provides: "DataExtractor class using Claude to extract customer data"
      exports: ["DataExtractor", "ExtractedData"]
    - path: "src/lib/agents/somnio/normalizers.ts"
      provides: "Normalization functions for phone, city, address, departamento"
      exports: ["normalizePhone", "normalizeCity", "normalizeAddress", "inferDepartamento"]
  key_links:
    - from: "src/lib/agents/somnio/data-extractor.ts"
      to: "src/lib/agents/claude-client.ts"
      via: "ClaudeClient for extraction"
      pattern: "claudeClient\\.generateResponse"
---

<objective>
Create the Data Extractor component that uses Claude to intelligently extract 9 customer fields from conversation messages, with normalization and inference capabilities.

Purpose: Enables the Somnio agent to capture customer data during collecting_data mode. This is core to the sales flow - without complete data, we cannot create orders.

Output: DataExtractor class, normalization utilities, ready for integration with Somnio orchestrator.
</objective>

<execution_context>
@/home/jose147/.claude/get-shit-done/workflows/execute-plan.md
@/home/jose147/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/14-agente-ventas-somnio/14-CONTEXT.md
@src/lib/agents/claude-client.ts
@src/lib/agents/types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create normalization utilities for customer data</name>
  <files>
    src/lib/agents/somnio/normalizers.ts
  </files>
  <action>
Create src/lib/agents/somnio/normalizers.ts with:

1. normalizePhone(input: string): string
   - Strip all non-digits
   - If 10 digits starting with 3, prepend 57
   - If 11 digits starting with 57, keep as is
   - Return normalized or original if invalid

2. normalizeCity(input: string): string
   - Trim and proper case (first letter uppercase)
   - Handle common variations: bogota/Bogota -> Bogota, medellin -> Medellin
   - Map common misspellings

3. normalizeAddress(input: string): string
   - Convert cll -> Calle, cra -> Carrera, av -> Avenida
   - Proper case each word
   - Preserve numbers

4. inferDepartamento(city: string): string | null
   - Map known cities to departments:
     - Bogota -> Cundinamarca
     - Medellin -> Antioquia
     - Cali -> Valle del Cauca
     - Barranquilla -> Atlantico
     - Cartagena -> Bolivar
     - Bucaramanga -> Santander
     - etc. (top 20 Colombian cities)
   - Return null if city not in map

5. CITY_TO_DEPARTAMENTO: Record<string, string>
   - Exportable constant with the mapping

6. detectNegation(input: string, field: string): boolean
   - Check for patterns like "no tengo {field}", "no lo se", "no"
   - Return true if negation detected for the field
  </action>
  <verify>
```bash
cd /mnt/c/Users/Usuario/Proyectos/morfx-new && npx tsc --noEmit
```
TypeScript compiles without errors.
  </verify>
  <done>
Normalization utilities created for phone, city, address, departamento inference, and negation detection.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Data Extractor component</name>
  <files>
    src/lib/agents/somnio/data-extractor.ts
    src/lib/agents/somnio/index.ts
  </files>
  <action>
Create src/lib/agents/somnio/data-extractor.ts:

1. ExtractedData interface:
```typescript
interface ExtractedData {
  nombre?: string
  apellido?: string
  telefono?: string
  direccion?: string
  ciudad?: string
  departamento?: string
  barrio?: string
  correo?: string
  indicaciones_extra?: string
}
```

2. ExtractionResult interface:
```typescript
interface ExtractionResult {
  extracted: ExtractedData
  normalized: ExtractedData // After normalization
  inferred: { departamento?: string } // Inferred fields
  negations: string[] // Fields with detected negations
  confidence: Record<string, number> // Field-level confidence
}
```

3. DataExtractor class:
```typescript
export class DataExtractor {
  private claudeClient: ClaudeClient

  constructor(claudeClient?: ClaudeClient) {
    this.claudeClient = claudeClient ?? new ClaudeClient()
  }

  async extract(
    message: string,
    existingData: Record<string, string>,
    conversationHistory: ClaudeMessage[]
  ): Promise<ExtractionResult>
}
```

4. Implementation details:
   - DATA_EXTRACTOR_PROMPT: System prompt instructing Claude to extract customer data
     - List of 9 fields with descriptions
     - Instructions to capture ALL data in message, not just one field
     - Output format: JSON with extracted values and confidence
   - Call Claude with message + history + existing data context
   - Parse response as JSON
   - Apply normalizers (normalizePhone, normalizeCity, normalizeAddress)
   - Apply inferDepartamento if city found but not departamento
   - Detect negations and mark fields as "N/A"
   - Return ExtractionResult with all details

5. Helper methods:
   - mergeExtractedData(existing, newData): Merge without overwriting with empty
   - hasMinimumData(data): Check if 5 critical fields present
   - hasCriticalData(data): Check if all 5 critical + 3 additional

Update src/lib/agents/somnio/index.ts:
- Export DataExtractor, ExtractedData, ExtractionResult
- Export normalization utilities
  </action>
  <verify>
```bash
cd /mnt/c/Users/Usuario/Proyectos/morfx-new && npx tsc --noEmit
```
TypeScript compiles. DataExtractor class properly typed.
  </verify>
  <done>
DataExtractor component created that:
- Extracts 9 customer fields using Claude
- Normalizes phone, city, address automatically
- Infers departamento from city
- Detects negations (e.g., "no tengo correo")
- Provides confidence scores per field
  </done>
</task>

</tasks>

<verification>
1. Normalizers work correctly for Colombian data (phones, cities, addresses)
2. DataExtractor uses Claude to extract all 9 fields
3. Negation detection works for common patterns
4. Departamento inference covers top 20 Colombian cities
5. TypeScript compiles without errors
6. All types properly exported
</verification>

<success_criteria>
- normalizePhone converts 10-digit numbers to 57XXXXXXXXXX
- normalizeCity handles common city variations
- inferDepartamento maps major Colombian cities
- DataExtractor.extract returns structured ExtractionResult
- hasMinimumData and hasCriticalData helpers work correctly
</success_criteria>

<output>
After completion, create `.planning/phases/14-agente-ventas-somnio/14-02-SUMMARY.md`
</output>
