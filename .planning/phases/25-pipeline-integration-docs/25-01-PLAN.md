---
phase: 25-pipeline-integration-docs
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/app/(dashboard)/settings/logistica/page.tsx
  - src/app/(dashboard)/settings/logistica/components/logistics-config-form.tsx
  - src/app/actions/logistics-config.ts
  - src/app/(dashboard)/settings/page.tsx
autonomous: true

must_haves:
  truths:
    - "Admin can navigate to /settings/logistica from settings hub"
    - "Admin can select a pipeline and stage for Coordinadora dispatch"
    - "Admin can toggle Coordinadora on/off without losing pipeline/stage selection"
    - "Future carriers (Inter, Envia, Servientrega) appear as disabled placeholders"
    - "Saving config persists through page refresh"
  artifacts:
    - path: "src/app/(dashboard)/settings/logistica/page.tsx"
      provides: "Server page with auth + role check + data fetching"
      min_lines: 25
    - path: "src/app/(dashboard)/settings/logistica/components/logistics-config-form.tsx"
      provides: "Client form with pipeline/stage selects, carrier cards, toggle, save"
      min_lines: 80
    - path: "src/app/actions/logistics-config.ts"
      provides: "Server actions for get/update carrier dispatch config"
      exports: ["getLogisticsConfig", "updateDispatchConfig"]
    - path: "src/app/(dashboard)/settings/page.tsx"
      provides: "Settings hub with Logistica link added"
      contains: "logistica"
  key_links:
    - from: "src/app/(dashboard)/settings/logistica/components/logistics-config-form.tsx"
      to: "src/app/actions/logistics-config.ts"
      via: "updateDispatchConfig server action call"
      pattern: "updateDispatchConfig"
    - from: "src/app/actions/logistics-config.ts"
      to: "src/lib/domain/carrier-configs.ts"
      via: "upsertCarrierConfig domain function"
      pattern: "upsertCarrierConfig"
    - from: "src/app/(dashboard)/settings/logistica/page.tsx"
      to: "src/app/actions/logistics-config.ts"
      via: "getLogisticsConfig for initial data"
      pattern: "getLogisticsConfig"
---

<objective>
Create the Logistics settings page where workspace admins configure which pipeline stage feeds which carrier robot.

Purpose: Admins currently must set dispatch_pipeline_id and dispatch_stage_id via direct DB edits. This plan adds a visual UI following the exact same pattern as the activacion-cliente settings page.
Output: Working /settings/logistica page with pipeline/stage dropdowns, carrier toggle, placeholder carriers, and settings hub link.
</objective>

<execution_context>
@/home/jose147/.claude/get-shit-done/workflows/execute-plan.md
@/home/jose147/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/25-pipeline-integration-docs/25-CONTEXT.md
@.planning/phases/25-pipeline-integration-docs/25-RESEARCH.md

Key reference files (clone these patterns):
@src/app/(dashboard)/settings/activacion-cliente/page.tsx
@src/app/(dashboard)/settings/activacion-cliente/components/activation-config-form.tsx
@src/app/actions/client-activation.ts
@src/app/(dashboard)/settings/page.tsx

Domain layer (already exists, DO NOT modify):
@src/lib/domain/carrier-configs.ts
@src/app/actions/pipelines.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Server action + settings page + hub link</name>
  <files>
    src/app/actions/logistics-config.ts
    src/app/(dashboard)/settings/logistica/page.tsx
    src/app/(dashboard)/settings/page.tsx
  </files>
  <action>
    **1. Create `src/app/actions/logistics-config.ts`:**

    Clone the pattern from `src/app/actions/client-activation.ts`. Two exported server actions:

    `getLogisticsConfig()`: Returns `CarrierConfig | null` for carrier='coordinadora'.
    - Auth check: user + workspace from cookies (same pattern as client-activation.ts)
    - Calls `getCarrierConfig({ workspaceId, source: 'server-action' }, 'coordinadora')`
    - Returns `result.data` on success, `null` on failure

    `updateDispatchConfig(params)`: Updates dispatch pipeline/stage/enabled.
    - Params: `{ carrier: string, dispatchPipelineId: string | null, dispatchStageId: string | null, isEnabled: boolean }`
    - Returns `ActionResult<CarrierConfig>` (same type pattern as client-activation.ts)
    - Auth check: user + workspace + role check (owner or admin only)
    - Calls `upsertCarrierConfig(ctx, { carrier, dispatchPipelineId, dispatchStageId, isEnabled })`
    - IMPORTANT: Do NOT pass portalUsername or portalPassword (leave undefined so existing credentials are untouched)
    - revalidatePath('/settings/logistica')
    - Return `{ success: true, data }` or `{ error: string }`

    **2. Create `src/app/(dashboard)/settings/logistica/page.tsx`:**

    Clone the exact pattern from `activacion-cliente/page.tsx`:
    - createClient() for auth, cookies() for workspaceId
    - Role check (owner or admin), redirect to /settings if insufficient
    - Parallel data fetch: `Promise.all([getLogisticsConfig(), getPipelines()])`
    - Render inside `<div className="flex-1 overflow-y-auto">` (mandatory dashboard wrapper)
    - Inner container: `<div className="max-w-2xl mx-auto py-8 px-4 space-y-6">`
    - Header: h1 "Logistica", subtitle "Configura que etapa del pipeline activa cada robot de transportadora"
    - Render `<LogisticsConfigForm config={config} pipelines={pipelines} />`

    **3. Add settings hub link in `src/app/(dashboard)/settings/page.tsx`:**

    Add to the `settingsLinks` array (after the "Badge de cliente" entry):
    ```typescript
    {
      href: '/settings/logistica',
      title: 'Logistica',
      description: 'Configura que etapa del pipeline activa cada robot de transportadora',
      icon: Truck,
      ownerOnly: true,
    }
    ```
    Import `Truck` from `lucide-react` in the imports line.
  </action>
  <verify>
    - `npx tsc --noEmit` passes with no errors in the new files
    - `npm run build` succeeds (or at minimum the page.tsx and action files compile)
  </verify>
  <done>
    Server action exports getLogisticsConfig and updateDispatchConfig. Settings page renders at /settings/logistica with auth guard. Settings hub shows "Logistica" card for owners.
  </done>
</task>

<task type="auto">
  <name>Task 2: Client form component with carrier cards and pipeline/stage dropdowns</name>
  <files>
    src/app/(dashboard)/settings/logistica/components/logistics-config-form.tsx
  </files>
  <action>
    Create the client form component following the `activation-config-form.tsx` pattern but adapted for logistics config.

    **Props:**
    ```typescript
    interface LogisticsConfigFormProps {
      config: CarrierConfig | null
      pipelines: PipelineWithStages[]
    }
    ```

    **State (useState):**
    - `selectedPipelineId: string | null` -- from `config?.dispatch_pipeline_id`
    - `selectedStageId: string | null` -- from `config?.dispatch_stage_id`
    - `isEnabled: boolean` -- from `config?.is_enabled ?? false`

    **Static constant (inside the file):**
    ```typescript
    const KNOWN_CARRIERS = [
      { id: 'coordinadora', name: 'Coordinadora', available: true },
      { id: 'interrapidisimo', name: 'Inter Rapidisimo', available: false },
      { id: 'envia', name: 'Envia', available: false },
      { id: 'servientrega', name: 'Servientrega', available: false },
    ] as const
    ```

    **Layout (Cards):**

    1. **Active Carrier Card (Coordinadora):**
       - Card with `CardHeader` showing carrier name + `Switch` toggle for `isEnabled`
       - `CardContent` with:
         - Pipeline `Select` dropdown: lists all pipelines from props. Placeholder "Seleccionar pipeline..."
         - Stage `Select` dropdown: filtered by selected pipeline (`pipelines.find(p => p.id === selectedPipelineId)?.stages ?? []`). Disabled when no pipeline selected. Placeholder "Seleccionar etapa..."
         - Each stage option shows a colored dot (same pattern as activation-config-form stage rendering: `<span className="w-3 h-3 rounded-full" style={{ backgroundColor: stage.color }} />`)
       - When pipeline changes: reset `selectedStageId` to null (stages may differ)
       - When toggle is off: visually dim the dropdowns (opacity-50, pointer-events-none)

    2. **Placeholder Carrier Cards (future carriers):**
       - For each carrier where `available === false`, render a simpler Card:
         - CardHeader with carrier name + `Badge variant="secondary"` showing "Proximamente"
         - Entire card has `opacity-60` and no interactive elements
         - Do NOT create carrier_configs rows for these

    3. **Save Button:**
       - `<Button onClick={handleSave} disabled={isPending}>` with Loader2 spinner
       - `handleSave` uses `useTransition` + calls `updateDispatchConfig({ carrier: 'coordinadora', dispatchPipelineId: selectedPipelineId, dispatchStageId: selectedStageId, isEnabled })`
       - On success: `toast.success('Configuracion de logistica actualizada')`
       - On error: `toast.error(result.error)`

    **Imports needed:**
    - `useState, useTransition` from react
    - `Card, CardContent, CardHeader, CardTitle, CardDescription` from @/components/ui/card
    - `Select, SelectContent, SelectItem, SelectTrigger, SelectValue` from @/components/ui/select
    - `Switch` from @/components/ui/switch
    - `Button` from @/components/ui/button
    - `Badge` from @/components/ui/badge
    - `Label` from @/components/ui/label
    - `Loader2, Truck` from lucide-react
    - `toast` from sonner
    - `updateDispatchConfig` from @/app/actions/logistics-config
    - `CarrierConfig` type from @/lib/domain/carrier-configs
    - `PipelineWithStages` type from @/lib/orders/types

    **IMPORTANT:** This is a 'use client' component. All shadcn components already exist in the project -- do NOT install anything new.
  </action>
  <verify>
    - `npx tsc --noEmit` passes with no type errors
    - `npm run build` succeeds
    - The form component renders without runtime errors when visiting /settings/logistica (verify via `npm run dev` or build)
  </verify>
  <done>
    Client form shows Coordinadora card with pipeline/stage dropdowns + enable toggle. Stage dropdown filters by selected pipeline. Future carriers appear as disabled placeholders with "Proximamente" badge. Save button persists config through domain layer. Page refresh shows saved values.
  </done>
</task>

</tasks>

<verification>
1. Build passes: `npm run build` succeeds
2. TypeScript clean: `npx tsc --noEmit` shows no errors in new files
3. Settings hub shows "Logistica" card (owner only)
4. /settings/logistica loads with auth + role guard
5. Pipeline dropdown shows all workspace pipelines
6. Stage dropdown filters by selected pipeline
7. Enable/disable toggle works, dimming dropdowns when off
8. Save persists to carrier_configs via domain layer
9. Page refresh shows saved values
10. Future carriers show as disabled placeholders
</verification>

<success_criteria>
- Admin navigates to /settings/logistica from settings hub
- Selects pipeline, selects stage within that pipeline, toggles enabled
- Saves successfully (toast confirmation)
- Refreshes page -- sees saved values
- Non-admin users redirected to /settings
- Future carriers (Inter, Envia, Servientrega) visible but disabled
</success_criteria>

<output>
After completion, create `.planning/phases/25-pipeline-integration-docs/25-01-SUMMARY.md`
</output>
