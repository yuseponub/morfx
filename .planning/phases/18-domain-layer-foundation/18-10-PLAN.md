---
phase: 18-domain-layer-foundation
plan: 10
type: execute
wave: 6
depends_on: ["18-03", "18-05", "18-06", "18-07", "18-08", "18-09"]
files_modified:
  - src/lib/domain/index.ts
autonomous: false

must_haves:
  truths:
    - "TypeScript compiles with zero errors across the entire project"
    - "All 8 domain modules are exported from index.ts"
    - "No server action file has direct trigger emission code (all removed)"
    - "No tool handler has direct DB mutation code for migrated entities"
    - "Action executor has no inline trigger emissions (all delegated to domain)"
    - "All 13 new tool handlers are registered and discoverable"
    - "Both dead triggers are active (keyword_match, task.overdue)"
    - "CLAUDE.md has Regla 3: Domain Layer"
  artifacts:
    - path: "src/lib/domain/index.ts"
      provides: "Complete barrel export of all 8 entity modules"
      contains: "orders|contacts|tags|messages|tasks|notes|custom-fields|conversations"
  key_links:
    - from: "src/lib/domain/"
      to: "src/lib/automations/trigger-emitter.ts"
      via: "Every domain mutation emits its trigger"
      pattern: "emit"
---

<objective>
Verify the complete Phase 18 migration: TypeScript compilation, domain completeness, trigger correctness, tool handler registration, and human verification of the full system.

Purpose: This is the final verification plan. It ensures all 9 success criteria of Phase 18 are met before marking the phase complete.

Output: Verified working system + human confirmation.
</objective>

<execution_context>
@/home/jose147/.claude/get-shit-done/workflows/execute-plan.md
@/home/jose147/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/18-domain-layer-foundation/18-CONTEXT.md
@.planning/phases/18-domain-layer-foundation/18-RESEARCH.md
@CLAUDE.md

All prior plan summaries:
@.planning/phases/18-domain-layer-foundation/18-01-SUMMARY.md
@.planning/phases/18-domain-layer-foundation/18-02-SUMMARY.md
@.planning/phases/18-domain-layer-foundation/18-03-SUMMARY.md
@.planning/phases/18-domain-layer-foundation/18-04-SUMMARY.md
@.planning/phases/18-domain-layer-foundation/18-05-SUMMARY.md
@.planning/phases/18-domain-layer-foundation/18-06-SUMMARY.md
@.planning/phases/18-domain-layer-foundation/18-07-SUMMARY.md
@.planning/phases/18-domain-layer-foundation/18-08-SUMMARY.md
@.planning/phases/18-domain-layer-foundation/18-09-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: TypeScript compilation + domain completeness audit</name>
  <files>src/lib/domain/index.ts</files>
  <action>
**Step 1: Full TypeScript compilation check**
Run `npx tsc --noEmit` on the entire project. Fix any TypeScript errors that may have been introduced during the migration.

**Step 2: Domain completeness audit**
Verify all 8 domain modules exist and export the expected functions:

1. `src/lib/domain/orders.ts` — 7 functions: createOrder, updateOrder, moveOrderToStage, deleteOrder, duplicateOrder, addOrderTag, removeOrderTag
2. `src/lib/domain/contacts.ts` — 4 functions: createContact, updateContact, deleteContact, bulkCreateContacts
3. `src/lib/domain/tags.ts` — 2 functions: assignTag, removeTag
4. `src/lib/domain/messages.ts` — 4 functions: sendTextMessage, sendMediaMessage, sendTemplateMessage, receiveMessage
5. `src/lib/domain/tasks.ts` — 4 functions: createTask, updateTask, completeTask, deleteTask
6. `src/lib/domain/notes.ts` — 6 functions: createNote, updateNote, deleteNote, createTaskNote, updateTaskNote, deleteTaskNote
7. `src/lib/domain/custom-fields.ts` — 2 functions: updateCustomFieldValues, readCustomFieldValues
8. `src/lib/domain/conversations.ts` — 4 functions: assignConversation, archiveConversation, linkContactToConversation, findOrCreateConversation

Verify `src/lib/domain/index.ts` re-exports all 8 modules.

**Step 3: Trigger emission audit**
Grep across all domain files to verify every mutation function calls its corresponding emit function. Verify:
- createOrder → emitOrderCreated
- moveOrderToStage → emitOrderStageChanged
- updateOrder → emitFieldChanged
- createContact → emitContactCreated
- updateContact → emitFieldChanged
- assignTag → emitTagAssigned
- removeTag → emitTagRemoved
- receiveMessage → emitWhatsAppMessageReceived + emitWhatsAppKeywordMatch
- completeTask → emitTaskCompleted
- updateCustomFieldValues → emitFieldChanged

**Step 4: Orphaned trigger emission check**
Grep for `emit` in these files — they should have NO trigger emission calls:
- `src/app/actions/orders.ts`
- `src/app/actions/contacts.ts`
- `src/app/actions/tasks.ts`
- `src/app/actions/custom-fields.ts`
- `src/lib/automations/action-executor.ts` (should only have trigger code for actions not yet migrated, if any)

**Step 5: New tool handler registration check**
Verify all 13 new tool handlers are in `src/lib/tools/schemas/crm.tools.ts`:
- Orders: crm.order.update, crm.order.delete, crm.order.duplicate, crm.order.list (4)
- Tasks: task.create, task.update, task.complete, task.list (4)
- Notes: note.create, note.list, note.delete (3)
- Custom Fields: custom-field.update, custom-field.read (2)

Verify handler implementations exist in `src/lib/tools/handlers/crm/index.ts`.

**Step 6: Dead trigger activation check**
- Verify `receiveMessage` in `src/lib/domain/messages.ts` calls `emitWhatsAppKeywordMatch`
- Verify `src/inngest/functions/task-overdue-cron.ts` exists and calls `emitTaskOverdue`
- Verify cron is registered in `src/app/api/inngest/route.ts`

**Step 7: CLAUDE.md rule check**
Verify CLAUDE.md contains "Regla 3: Domain Layer" section.

Fix any issues found during the audit. Push all fixes.
  </action>
  <verify>npx tsc --noEmit passes. All 33 domain functions exist. All trigger emissions correct. No orphaned triggers in old callers. 13 new tool handlers registered. Both dead triggers active. CLAUDE.md rule present.</verify>
  <done>TypeScript compiles. Domain layer is complete and consistent. All 9 success criteria pass automated verification.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete domain layer foundation:
- 8 domain modules in src/lib/domain/ with 33 functions
- All 5 caller types (server actions, tool handlers, action executor, webhooks, adapters) refactored
- 13 new tool handlers (4 order, 4 task, 3 note, 2 custom-field)
- 2 dead triggers activated (keyword_match, task.overdue)
- DB audit safety net (mutation_audit table)
- Permanent CLAUDE.md rule
  </what-built>
  <how-to-verify>
1. **CRM operations test:** Go to the CRM pipeline, create an order, move it to a different stage, add a tag. Verify automations fire (check /automatizaciones history).
2. **Bot trigger test:** If WhatsApp bot is connected, send a message that triggers a tool handler (e.g., ask bot to create a contact or tag). Verify the automation triggers fire (check /automatizaciones history — the bot action should appear as a trigger source).
3. **Shopify trigger test (optional):** If Shopify is connected, check that new Shopify orders create MorfX orders AND trigger automations.
4. **Task overdue test (optional):** Create a task with a past due date. Wait 15 minutes (or check Inngest dashboard) — the overdue trigger should fire.
5. **General check:** Navigate through the app — create contacts, orders, tasks, notes. Everything should work identically to before (no regressions).
  </how-to-verify>
  <resume-signal>Type "approved" or describe any issues found.</resume-signal>
</task>

</tasks>

<verification>
Phase 18 Success Criteria verification:
1. [x] Toda operacion que modifica datos pasa por domain/ — verified by orphaned trigger check + TypeScript audit
2. [x] Todas las funciones domain emiten triggers — verified by trigger emission audit
3. [x] Tool handlers existentes refactoreados — verified by grep for domain imports in handlers
4. [x] Action executor refactoreado — verified by grep for domain imports in action-executor
5. [x] Nuevos tool handlers creados — verified by 13 new handler count
6. [x] Triggers muertos activados — verified by keyword_match in receiveMessage + task-overdue-cron
7. [x] Shopify webhook emite triggers — verified by domain imports in webhook-handler
8. [x] Regla permanente en CLAUDE.md — verified by grep for "Regla 3"
9. [x] Bot WhatsApp puede disparar automatizaciones — verified by tool handlers using domain (which emits triggers)
</verification>

<success_criteria>
- TypeScript compiles with zero errors
- All 9 phase success criteria pass
- Human verification confirms no regressions
- Domain layer is the single source of truth for all mutations
</success_criteria>

<output>
After completion, create `.planning/phases/18-domain-layer-foundation/18-10-SUMMARY.md`
</output>
