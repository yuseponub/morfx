---
phase: 21-db-domain-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/20260222000000_dane_municipalities.sql
  - supabase/migrations/20260222000001_coordinadora_coverage.sql
autonomous: true

must_haves:
  truths:
    - "A query for any Colombian municipality returns its DANE code, department, and name"
    - "1,122+ municipalities are loaded with unique 5-digit DANE codes"
    - "Given a city name and department, the system can answer whether Coordinadora covers it"
    - "Given a covered city, the system can answer whether COD (contraentrega) is available"
    - "All 1,488 Coordinadora cities are loaded in the coverage table"
  artifacts:
    - path: "supabase/migrations/20260222000000_dane_municipalities.sql"
      provides: "dane_municipalities table with 1,122+ seeded rows"
      contains: "CREATE TABLE dane_municipalities"
    - path: "supabase/migrations/20260222000001_coordinadora_coverage.sql"
      provides: "carrier_coverage table with 1,488 seeded rows"
      contains: "CREATE TABLE carrier_coverage"
  key_links:
    - from: "carrier_coverage"
      to: "dane_municipalities"
      via: "dane_municipality_id FK (nullable)"
      pattern: "REFERENCES dane_municipalities"
---

<objective>
Create the DANE municipalities reference table and Coordinadora coverage table with full seed data.

Purpose: These two global reference tables are the foundation for ALL carrier integrations in v3.0. The DANE municipalities table standardizes Colombian geographic data, and the Coordinadora coverage table maps which cities the carrier serves and whether COD is available. Without these tables, city validation (Phase 22) and order submission (Phase 23) cannot work.

Output: Two SQL migration files containing table creation + full seed data (1,122+ DANE municipalities and 1,488 Coordinadora cities).
</objective>

<execution_context>
@/home/jose147/.claude/get-shit-done/workflows/execute-plan.md
@/home/jose147/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/21-db-domain-foundation/21-CONTEXT.md
@.planning/phases/21-db-domain-foundation/21-RESEARCH.md
@.planning/phases/21-db-domain-foundation/data/ciudades-coordinadora.txt

# Existing migration patterns
@supabase/migrations/20260221000000_client_activation_badge.sql
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create dane_municipalities table with seed data</name>
  <files>supabase/migrations/20260222000000_dane_municipalities.sql</files>
  <action>
Create a SQL migration that:

1. Creates the `dane_municipalities` table (global reference, NO workspace_id, NO RLS):
   - `id SERIAL PRIMARY KEY`
   - `dane_code CHAR(5) NOT NULL UNIQUE` -- 5-digit DANE DIVIPOLA code (2-digit dept + 3-digit muni)
   - `department_code CHAR(2) NOT NULL` -- first 2 digits of dane_code
   - `department_name TEXT NOT NULL` -- full department name (e.g., "ANTIOQUIA")
   - `municipality_name TEXT NOT NULL` -- official name (e.g., "Medellin")
   - `municipality_name_normalized TEXT NOT NULL` -- uppercase, no accents, trimmed
   - `department_name_normalized TEXT NOT NULL` -- uppercase, no accents, trimmed
   - `created_at TIMESTAMPTZ NOT NULL DEFAULT timezone('America/Bogota', NOW())`

2. Create indexes:
   - `CREATE INDEX idx_dane_muni_normalized ON dane_municipalities(municipality_name_normalized, department_name_normalized)` -- for lookup queries
   - `CREATE INDEX idx_dane_dept_code ON dane_municipalities(department_code)` -- for department-level queries

3. Grant permissions (NO RLS since global reference):
   - `GRANT SELECT ON dane_municipalities TO authenticated;`
   - `GRANT SELECT ON dane_municipalities TO service_role;`
   - Also grant usage on the sequence: `GRANT USAGE, SELECT ON SEQUENCE dane_municipalities_id_seq TO authenticated, service_role;`

4. Seed with ALL Colombian municipalities from DANE DIVIPOLA. Use INSERT INTO statements.

**DANE data source:** Download from https://www.datos.gov.co/resource/gdxc-w37w.json (DANE DIVIPOLA open data API -- returns JSON with Codigo Departamento, Nombre Departamento, Codigo Municipio, Nombre Municipio). Alternatively, use the well-known list of 1,122 Colombian municipalities.

**Normalization for seed data:** Use PostgreSQL's `upper()` and `translate()` functions for accent removal in the INSERT, OR pre-compute normalized values. The normalization formula is: uppercase + remove diacritics (NFD decomposition, strip combining marks) + trim.

Since PostgreSQL doesn't have built-in NFD normalization, pre-compute the normalized values in the INSERT statements directly. For example: `INSERT INTO dane_municipalities (dane_code, department_code, department_name, municipality_name, municipality_name_normalized, department_name_normalized) VALUES ('05001', '05', 'Antioquia', 'Medellin', 'MEDELLIN', 'ANTIOQUIA'), ...`

**Important considerations:**
- dane_code is CHAR(5) with leading zeros (e.g., '05001' for Medellin, NOT '5001')
- department_code is the first 2 chars of dane_code
- Include ALL 32 departments + Bogota D.C. (department code '11')
- Minimum 1,122 municipalities (the official count)
- If exact DANE data cannot be fetched at execution time, use the comprehensive list from well-known sources. The data must be accurate -- this is a reference table that all carrier integrations depend on.
  </action>
  <verify>
Run: `grep -c "INSERT INTO dane_municipalities" supabase/migrations/20260222000000_dane_municipalities.sql` -- should show INSERT statements.
Run: `grep "CREATE TABLE dane_municipalities" supabase/migrations/20260222000000_dane_municipalities.sql` -- should exist.
Run: `grep "UNIQUE" supabase/migrations/20260222000000_dane_municipalities.sql` -- should show dane_code UNIQUE constraint.
Count the number of value tuples in the INSERT to verify >= 1,122 municipalities.
  </verify>
  <done>
dane_municipalities table is defined with correct schema (SERIAL PK, CHAR(5) dane_code UNIQUE, department fields, normalized fields, timestamp). At least 1,122 Colombian municipalities are seeded. No RLS, no workspace_id. SELECT granted to authenticated and service_role.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create carrier_coverage table with Coordinadora seed data</name>
  <files>supabase/migrations/20260222000001_coordinadora_coverage.sql</files>
  <action>
Create a SQL migration that:

1. Creates the `carrier_coverage` table (global reference, NO workspace_id, NO RLS):
   - `id SERIAL PRIMARY KEY`
   - `carrier TEXT NOT NULL DEFAULT 'coordinadora'`
   - `city_coordinadora TEXT NOT NULL` -- exact Coordinadora format: "CIUDAD (DEPTO_ABREV)", e.g., "MEDELLIN (ANT)"
   - `city_name TEXT NOT NULL` -- parsed city name uppercase: "MEDELLIN"
   - `department_abbrev TEXT NOT NULL` -- parsed abbreviation: "ANT"
   - `dane_municipality_id INTEGER REFERENCES dane_municipalities(id)` -- nullable FK (Mexican cities and sub-municipal areas have no DANE match)
   - `supports_cod BOOLEAN NOT NULL DEFAULT false` -- whether COD (recaudo contraentrega) is available
   - `is_active BOOLEAN NOT NULL DEFAULT true`
   - `created_at TIMESTAMPTZ NOT NULL DEFAULT timezone('America/Bogota', NOW())`
   - `UNIQUE(carrier, city_coordinadora)`

2. Create indexes:
   - `CREATE INDEX idx_carrier_coverage_lookup ON carrier_coverage(carrier, city_name, department_abbrev)` -- primary lookup for city validation
   - `CREATE INDEX idx_carrier_coverage_cod ON carrier_coverage(carrier, supports_cod) WHERE is_active = true` -- COD city filtering
   - `CREATE INDEX idx_carrier_coverage_dane ON carrier_coverage(dane_municipality_id) WHERE dane_municipality_id IS NOT NULL` -- reverse lookup

3. Grant permissions (NO RLS):
   - `GRANT SELECT ON carrier_coverage TO authenticated;`
   - `GRANT SELECT ON carrier_coverage TO service_role;`
   - `GRANT USAGE, SELECT ON SEQUENCE carrier_coverage_id_seq TO authenticated, service_role;`

4. Seed ALL 1,488 Coordinadora cities from `@.planning/phases/21-db-domain-foundation/data/ciudades-coordinadora.txt`.

**Seed data parsing:**
- Read each line from ciudades-coordinadora.txt (format: "CITY_NAME (DEPT_ABBREV)")
- Parse city_name and department_abbrev from the format: everything before " (" is city_name, everything between "(" and ")" is department_abbrev
- city_coordinadora = the full line as-is (trimmed)
- TRIM all values (pitfall #4 from research: trailing whitespace in data)
- Example: "ABEJORRAL (ANT)" -> city_coordinadora="ABEJORRAL (ANT)", city_name="ABEJORRAL", department_abbrev="ANT"

**dane_municipality_id matching:**
- After inserting all coverage rows, run an UPDATE to match coverage cities to DANE municipalities:
  ```sql
  UPDATE carrier_coverage cc
  SET dane_municipality_id = dm.id
  FROM dane_municipalities dm
  WHERE cc.city_name = dm.municipality_name_normalized
    AND cc.dane_municipality_id IS NULL;
  ```
- This is a best-effort match. Not all Coordinadora cities will have DANE matches (Mexican cities CMX/MEX, sub-municipal areas like "EL DOCE (ANT)").

**COD (supports_cod) flag:**
- Default all to `false` for now. The COD city list (~1,181 cities) was mentioned by user but not yet provided as a file. The flag can be updated later via a separate migration or seed script when the list is available.
- Add a comment in the migration noting this: `-- TODO: Update supports_cod when COD city list is provided`

**Critical:** Ensure all 1,488 lines from ciudades-coordinadora.txt are converted to INSERT statements. Count the INSERT value tuples to verify.
  </action>
  <verify>
Run: Count INSERT value tuples in the migration file -- should be exactly 1,488.
Run: `grep "CREATE TABLE carrier_coverage" supabase/migrations/20260222000001_coordinadora_coverage.sql` -- should exist.
Run: `grep "dane_municipalities" supabase/migrations/20260222000001_coordinadora_coverage.sql` -- should show FK reference.
Run: `grep "UNIQUE" supabase/migrations/20260222000001_coordinadora_coverage.sql` -- should show carrier+city_coordinadora unique constraint.
Verify the file parses ciudades-coordinadora.txt correctly by checking a few known entries: ABEJORRAL (ANT), BOGOTA (C/MARCA), MEDELLIN (ANT).
  </verify>
  <done>
carrier_coverage table is defined with correct schema. All 1,488 Coordinadora cities are seeded from ciudades-coordinadora.txt with parsed city_name and department_abbrev. dane_municipality_id is populated where DANE matches exist (nullable for unmatched). supports_cod defaults to false with TODO comment. No RLS, no workspace_id.
  </done>
</task>

</tasks>

<verification>
1. Both migration files exist and follow the project's SQL migration naming convention (YYYYMMDDHHMMSS_name.sql)
2. dane_municipalities has >= 1,122 rows seeded
3. carrier_coverage has exactly 1,488 rows seeded (matching ciudades-coordinadora.txt line count)
4. carrier_coverage.dane_municipality_id references dane_municipalities(id) as nullable FK
5. Neither table has workspace_id or RLS policies
6. Both tables use timezone('America/Bogota', NOW()) for timestamps
7. SELECT is granted to authenticated and service_role
</verification>

<success_criteria>
- dane_municipalities table with 1,122+ Colombian municipalities (dane_code, department, name, normalized fields)
- carrier_coverage table with 1,488 Coordinadora cities parsed from ciudades-coordinadora.txt
- FK relationship from carrier_coverage to dane_municipalities (nullable)
- Lookup indexes for city validation queries
- Zero RLS, zero workspace_id on reference tables
</success_criteria>

<output>
After completion, create `.planning/phases/21-db-domain-foundation/21-01-SUMMARY.md`
</output>
