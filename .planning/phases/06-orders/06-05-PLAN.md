---
phase: 06-orders
plan: 05
type: execute
wave: 3
depends_on: ["06-03", "06-04"]
files_modified:
  - package.json
  - src/lib/search/fuse-config.ts
  - src/app/(dashboard)/crm/pedidos/components/kanban-board.tsx
  - src/app/(dashboard)/crm/pedidos/components/kanban-column.tsx
  - src/app/(dashboard)/crm/pedidos/components/kanban-card.tsx
  - src/app/(dashboard)/crm/pedidos/components/order-sheet.tsx
  - src/app/(dashboard)/crm/pedidos/components/pipeline-tabs.tsx
  - src/app/(dashboard)/crm/pedidos/components/view-toggle.tsx
  - src/app/(dashboard)/crm/pedidos/components/order-filters.tsx
  - src/app/(dashboard)/crm/pedidos/page.tsx
autonomous: true

must_haves:
  truths:
    - "User can view orders in Kanban board view"
    - "User can drag-and-drop orders between pipeline stages"
    - "User can switch between Kanban and list view"
    - "User can search orders with fuzzy matching"
    - "User can open multiple pipelines in tabs"
    - "Click on order card opens detail sheet"
  artifacts:
    - path: "src/app/(dashboard)/crm/pedidos/components/kanban-board.tsx"
      provides: "Kanban board with @dnd-kit"
      contains: "DndContext"
    - path: "src/lib/search/fuse-config.ts"
      provides: "Fuse.js configuration for order search"
      exports: ["createOrderSearcher", "useOrderSearch"]
    - path: "src/app/(dashboard)/crm/pedidos/components/pipeline-tabs.tsx"
      provides: "Bottom taskbar for multiple pipelines"
  key_links:
    - from: "kanban-board.tsx"
      to: "actions/orders.ts"
      via: "moveOrderToStage on drag end"
      pattern: "moveOrderToStage"
    - from: "kanban-card.tsx"
      to: "order-sheet.tsx"
      via: "Click opens detail"
      pattern: "onClick.*setSelectedOrder"
    - from: "order-filters.tsx"
      to: "fuse-config.ts"
      via: "Fuzzy search"
      pattern: "createOrderSearcher|useOrderSearch"
---

<objective>
Create the Kanban board view with drag-and-drop, pipeline tabs, fuzzy search, and view toggle for complete order management experience.

Purpose: Kanban view is the primary order management interface; enables visual pipeline management
Output: Full Kanban experience with DnD, multi-pipeline tabs, fuzzy search, and order detail sheet
</objective>

<execution_context>
@/home/jose147/.claude/get-shit-done/workflows/execute-plan.md
@/home/jose147/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/06-orders/06-CONTEXT.md
@.planning/phases/06-orders/06-RESEARCH.md
@.planning/phases/06-orders/06-03-SUMMARY.md
@.planning/phases/06-orders/06-04-SUMMARY.md
@src/lib/orders/types.ts
@src/app/actions/orders.ts
@src/app/actions/pipelines.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install Fuse.js and create search utilities</name>
  <files>
    package.json
    src/lib/search/fuse-config.ts
  </files>
  <action>
**1. Install Fuse.js:**
```bash
pnpm add fuse.js
```

**2. Create src/lib/search/fuse-config.ts:**

```typescript
// src/lib/search/fuse-config.ts
import Fuse, { IFuseOptions } from 'fuse.js'
import { useMemo, useState } from 'react'
import type { Order } from '@/lib/orders/types'

// Fuse.js options for order search
const orderSearchOptions: IFuseOptions<Order> = {
  // Search these fields with weights
  keys: [
    { name: 'contact.name', weight: 2 },      // Contact name most important
    { name: 'contact.phone', weight: 1.5 },   // Phone number
    { name: 'products.title', weight: 1 },    // Product names
    { name: 'products.sku', weight: 1 },      // Product SKUs
    { name: 'tracking_number', weight: 1.5 }, // Tracking/guia
    { name: 'contact.city', weight: 0.8 },    // City
    { name: 'description', weight: 0.5 },     // Notes/description
    { name: 'carrier', weight: 0.5 },         // Transportadora
  ],
  // Fuzzy matching config
  threshold: 0.4,           // 0 = exact match, 1 = match anything
  distance: 100,            // How close match must be to location
  ignoreLocation: true,     // Search entire string, not just start
  minMatchCharLength: 2,    // Ignore single character matches
  // Results config
  shouldSort: true,         // Sort by relevance
  includeScore: true,       // Include match score in results
  findAllMatches: true,     // Don't stop at first match
}

/**
 * Create a Fuse.js instance for searching orders
 * Memoize this - don't recreate on every search
 */
export function createOrderSearcher(orders: Order[]): Fuse<Order> {
  return new Fuse(orders, orderSearchOptions)
}

/**
 * React hook for fuzzy searching orders
 * Returns filtered orders based on search query
 */
export function useOrderSearch(orders: Order[]) {
  const [query, setQuery] = useState('')

  // Memoize Fuse instance - only recreate when orders change
  const fuse = useMemo(() => createOrderSearcher(orders), [orders])

  // Memoize search results
  const results = useMemo(() => {
    const trimmed = query.trim()
    if (!trimmed) return orders

    return fuse.search(trimmed).map(result => result.item)
  }, [fuse, query, orders])

  return {
    query,
    setQuery,
    results,
    hasQuery: query.trim().length > 0,
  }
}

/**
 * Normalize search input
 * - Lowercase
 * - Remove extra whitespace
 * - Handle common typos
 */
export function normalizeSearchQuery(query: string): string {
  return query
    .toLowerCase()
    .trim()
    .replace(/\s+/g, ' ') // Collapse multiple spaces
}
```

This provides:
- Weighted fuzzy search across contact, products, tracking
- Threshold 0.4 for good balance of fuzzy and relevant
- Hook for easy React integration
- Memoization to prevent performance issues
  </action>
  <verify>
Run: `pnpm tsc --noEmit` - No TypeScript errors
Check: fuse.js in package.json dependencies
  </verify>
  <done>
Fuse.js installed, search utilities created with proper memoization
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Kanban board components</name>
  <files>
    src/app/(dashboard)/crm/pedidos/components/kanban-board.tsx
    src/app/(dashboard)/crm/pedidos/components/kanban-column.tsx
    src/app/(dashboard)/crm/pedidos/components/kanban-card.tsx
    src/app/(dashboard)/crm/pedidos/components/order-sheet.tsx
  </files>
  <action>
Create Kanban components following @dnd-kit patterns from research:

**1. kanban-board.tsx:**
```typescript
'use client'

import {
  DndContext,
  DragOverlay,
  closestCorners,
  PointerSensor,
  KeyboardSensor,
  useSensor,
  useSensors,
  DragStartEvent,
  DragEndEvent,
} from '@dnd-kit/core'
import { sortableKeyboardCoordinates } from '@dnd-kit/sortable'
import { useState } from 'react'
import { KanbanColumn } from './kanban-column'
import { KanbanCard } from './kanban-card'
import { OrderSheet } from './order-sheet'
import { moveOrderToStage } from '@/app/actions/orders'
import { toast } from 'sonner'
import type { Order, PipelineStage, OrdersByStage } from '@/lib/orders/types'

interface KanbanBoardProps {
  stages: PipelineStage[]
  ordersByStage: OrdersByStage
  onOrderClick: (order: Order) => void
}

export function KanbanBoard({ stages, ordersByStage, onOrderClick }: KanbanBoardProps) {
  const [activeOrder, setActiveOrder] = useState<Order | null>(null)

  const sensors = useSensors(
    useSensor(PointerSensor, {
      activationConstraint: { distance: 8 }, // Prevent accidental drags
    }),
    useSensor(KeyboardSensor, {
      coordinateGetter: sortableKeyboardCoordinates,
    })
  )

  const handleDragStart = (event: DragStartEvent) => {
    const orderId = event.active.id as string
    // Find order across all stages
    for (const orders of Object.values(ordersByStage)) {
      const order = orders.find(o => o.id === orderId)
      if (order) {
        setActiveOrder(order)
        break
      }
    }
  }

  const handleDragEnd = async (event: DragEndEvent) => {
    const { active, over } = event
    setActiveOrder(null)

    if (!over) return

    const orderId = active.id as string
    const newStageId = over.id as string

    // Find current stage
    let currentStageId: string | null = null
    for (const [stageId, orders] of Object.entries(ordersByStage)) {
      if (orders.some(o => o.id === orderId)) {
        currentStageId = stageId
        break
      }
    }

    // Only update if stage changed
    if (currentStageId === newStageId) return

    // Optimistic update would go here, but we're keeping it simple
    // Server Action handles the update
    const result = await moveOrderToStage(orderId, newStageId)

    if (result.error) {
      toast.error(result.error)
    }
  }

  return (
    <DndContext
      sensors={sensors}
      collisionDetection={closestCorners}
      onDragStart={handleDragStart}
      onDragEnd={handleDragEnd}
    >
      <div className="flex gap-4 overflow-x-auto pb-4 min-h-[calc(100vh-300px)]">
        {stages.map((stage) => (
          <KanbanColumn
            key={stage.id}
            stage={stage}
            orders={ordersByStage[stage.id] || []}
            onOrderClick={onOrderClick}
          />
        ))}
      </div>

      <DragOverlay>
        {activeOrder ? <KanbanCard order={activeOrder} isDragging /> : null}
      </DragOverlay>
    </DndContext>
  )
}
```

**2. kanban-column.tsx:**
- useDroppable for the column
- SortableContext with verticalListSortingStrategy
- Header with stage color dot, name, count
- WIP limit warning badge if at/over limit
- Render KanbanCard for each order

**3. kanban-card.tsx:**
- useSortable hook for drag behavior
- CSS.Transform.toString for positioning
- Card shows: contact name, value (currency), products (first 2 + count), date
- Tags displayed as small badges
- onClick opens OrderSheet (not part of drag)
- Visual feedback: opacity 0.5 when dragging, ring when isDragging prop

**4. order-sheet.tsx:**
- Sheet component (side panel) showing full order details
- Sections:
  - Header: Contact name, total value, stage badge
  - Contact info: phone, email, city, address
  - Products: list with sku, title, quantity, subtotal
  - Tracking: carrier, tracking number (link if valid URL pattern)
  - Notes: description
  - Tags: TagInput component for adding/removing
  - Timeline: Show created/updated dates
  - Actions: Edit button (opens order form), Delete button
- Close button in header
  </action>
  <verify>
Import components in page.tsx and render
Verify drag-and-drop moves orders between columns
Click on card opens sheet with details
Run: `pnpm tsc --noEmit`
  </verify>
  <done>
Kanban board with DnD, columns with WIP indicators, cards with order info, detail sheet
  </done>
</task>

<task type="auto">
  <name>Task 3: Create pipeline tabs, filters, and integrate into page</name>
  <files>
    src/app/(dashboard)/crm/pedidos/components/pipeline-tabs.tsx
    src/app/(dashboard)/crm/pedidos/components/view-toggle.tsx
    src/app/(dashboard)/crm/pedidos/components/order-filters.tsx
    src/app/(dashboard)/crm/pedidos/page.tsx
  </files>
  <action>
Create remaining components and integrate:

**1. pipeline-tabs.tsx:**
- Fixed bottom bar (like Windows taskbar)
- Shows open pipelines as tabs
- Each tab: pipeline name, close button (X)
- Active tab highlighted
- "+" button to add pipeline (opens selector)
- Store open pipeline IDs in localStorage for persistence
- Pattern from research: `className="fixed bottom-0 left-0 right-0 bg-background border-t"`

**2. view-toggle.tsx:**
- Simple toggle button group: Kanban | Lista
- Uses ToggleGroup from shadcn/ui
- Icons: LayoutGrid for Kanban, List for Lista
- State controlled by parent

**3. order-filters.tsx:**
- Filter bar component
- Contains:
  - Search input with magnifying glass icon (uses useOrderSearch)
  - Stage filter dropdown (multi-select)
  - Tag filter (reuse TagFilter pattern from contacts)
  - Date range picker (optional, can be simplified)
  - "Limpiar filtros" button
- Filters work on both Kanban and List views

**4. Update page.tsx:**
- Add view state: 'kanban' | 'list'
- Add active pipeline state
- Add open pipelines state (persisted to localStorage)
- Render ViewToggle
- Conditionally render KanbanBoard or OrdersTable based on view
- Render PipelineTabs at bottom
- Render OrderFilters above content
- Add OrderSheet state for selected order
- Pass filtered orders (from useOrderSearch) to both views
- Group orders by stage for Kanban: `ordersByStage`

Page structure:
```
<div className="flex flex-col h-full pb-10"> {/* pb-10 for bottom tabs */}
  <header>
    <h1>Pedidos</h1>
    <ViewToggle />
    <Button>Nuevo Pedido</Button>
  </header>

  <OrderFilters />

  {view === 'kanban' ? (
    <KanbanBoard stages={...} ordersByStage={...} />
  ) : (
    <OrdersTable orders={...} />
  )}

  <PipelineTabs pipelines={...} />

  <OrderSheet order={selectedOrder} open={!!selectedOrder} onClose={() => setSelectedOrder(null)} />
</div>
```

Ensure:
- Kanban is default view (from CONTEXT.md)
- Pipeline tabs persist across page refresh
- Search filters both views
- Clicking card in Kanban opens sheet
- Clicking row in table can also open sheet
  </action>
  <verify>
Navigate to /crm/pedidos - Kanban view renders by default
Toggle to List view - table renders
Search filters orders in both views
Drag order between stages - updates correctly
Open multiple pipelines in tabs
Click card - sheet opens with details
Run: `pnpm tsc --noEmit`
  </verify>
  <done>
Complete orders UI with Kanban/List toggle, fuzzy search, pipeline tabs, order detail sheet
  </done>
</task>

</tasks>

<verification>
1. Fuse.js installed and search works
2. Kanban board renders with stages as columns
3. Drag-and-drop moves orders between stages
4. WIP limit enforced (toast error if exceeded)
5. View toggle switches between Kanban and List
6. Search filters orders with fuzzy matching
7. Pipeline tabs show at bottom, persist selection
8. Order sheet opens with full details on click
9. Can edit order from sheet
10. All components compile: `pnpm tsc --noEmit`
</verification>

<success_criteria>
- Kanban board with @dnd-kit drag-and-drop
- Multi-pipeline tabs (Windows taskbar style)
- Fuzzy search across contact, products, tracking
- View toggle between Kanban and List
- Order detail sheet with edit capability
- WIP limits enforced on drag
- Responsive design
</success_criteria>

<output>
After completion, create `.planning/phases/06-orders/06-05-SUMMARY.md`
</output>
