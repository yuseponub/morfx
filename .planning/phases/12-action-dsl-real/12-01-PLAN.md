---
phase: 12-action-dsl-real
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/tools/types.ts
  - src/lib/tools/rate-limiter.ts
  - src/lib/audit/tool-logger.ts
  - supabase/migrations/20260205_tool_logs_agent_session.sql
autonomous: true

must_haves:
  truths:
    - "ToolResult<T> type exists with success/error discrimination"
    - "ToolError type includes type, code, message, suggestion, retryable"
    - "Rate limiter enforces per-workspace per-module sliding window limits"
    - "tool_executions table has agent_session_id column"
    - "logToolExecution accepts and persists agent_session_id"
  artifacts:
    - path: "src/lib/tools/types.ts"
      provides: "ToolResult<T>, ToolSuccess<T>, ToolError, ToolErrorType types"
      contains: "ToolResult"
    - path: "src/lib/tools/rate-limiter.ts"
      provides: "In-memory sliding window rate limiter"
      exports: ["rateLimiter"]
    - path: "src/lib/audit/tool-logger.ts"
      provides: "Enhanced forensic logging with agent_session_id"
      contains: "agent_session_id"
    - path: "supabase/migrations/20260205_tool_logs_agent_session.sql"
      provides: "Database migration for agent_session_id column"
      contains: "agent_session_id"
  key_links:
    - from: "src/lib/tools/rate-limiter.ts"
      to: "src/lib/tools/types.ts"
      via: "ToolModule import for domain-specific limits"
      pattern: "ToolModule"
    - from: "src/lib/audit/tool-logger.ts"
      to: "src/lib/tools/types.ts"
      via: "ToolExecutionRecord import with new field"
      pattern: "agent_session_id"
---

<objective>
Create the foundation types, rate limiter, and enhanced logging needed by all subsequent tool handler plans.

Purpose: All real tool handlers depend on the ToolResult<T> response contract, rate limiting, and enhanced forensic logging. This plan creates those shared foundations.
Output: New types, rate limiter module, enhanced logger, and database migration.
</objective>

<execution_context>
@/home/jose147/.claude/get-shit-done/workflows/execute-plan.md
@/home/jose147/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-action-dsl-real/12-RESEARCH.md
@.planning/phases/12-action-dsl-real/12-CONTEXT.md
@src/lib/tools/types.ts
@src/lib/audit/tool-logger.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add ToolResult types and enhance ToolExecutionRecord</name>
  <files>src/lib/tools/types.ts</files>
  <action>
  Add the following types to `src/lib/tools/types.ts` (ADD to existing file, do NOT replace existing types):

  1. **ToolErrorType** -- Union type of error classifications:
     `'validation_error' | 'not_found' | 'duplicate' | 'external_api_error' | 'permission_denied' | 'rate_limited' | 'timeout' | 'internal_error'`

  2. **ToolSuccess<T>** -- Success response:
     ```typescript
     interface ToolSuccess<T> {
       success: true
       data: T
       resource_url?: string    // CRM: /crm/contactos/{id}
       message_id?: string      // WhatsApp: 360dialog wamid
     }
     ```

  3. **ToolError** -- Error response:
     ```typescript
     interface ToolError {
       success: false
       error: {
         type: ToolErrorType
         code: string            // e.g., 'PHONE_DUPLICATE'
         message: string         // Human-readable in Spanish
         suggestion?: string     // e.g., 'Use crm.contact.read'
         retryable: boolean
       }
     }
     ```

  4. **ToolResult<T>** -- Discriminated union:
     `type ToolResult<T> = ToolSuccess<T> | ToolError`

  5. Add `agent_session_id?: string` field to the existing `ToolExecutionRecord` interface.

  6. Add `agent_session_id?: string` field to the existing `ExecutionContext` interface (alongside existing `sessionId`).

  Export all new types.

  IMPORTANT: Do NOT modify or remove any existing types. Only ADD new ones and extend existing interfaces.
  </action>
  <verify>
  Run `npx tsc --noEmit` -- no TypeScript errors. Verify the new types exist with grep: `grep -n "ToolResult\|ToolError\|ToolSuccess\|ToolErrorType\|agent_session_id" src/lib/tools/types.ts`
  </verify>
  <done>
  ToolResult<T>, ToolSuccess<T>, ToolError, and ToolErrorType types exported from types.ts. ToolExecutionRecord and ExecutionContext include agent_session_id field.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create rate limiter and migration, enhance tool-logger</name>
  <files>
    src/lib/tools/rate-limiter.ts
    supabase/migrations/20260205_tool_logs_agent_session.sql
    src/lib/audit/tool-logger.ts
  </files>
  <action>
  **A) Create `src/lib/tools/rate-limiter.ts`:**

  Implement an in-memory sliding window rate limiter with these specs:
  - Class `ToolRateLimiter` with a `Map<string, number[]>` for tracking timestamps
  - Key format: `{workspaceId}:{module}` (e.g., `ws-123:crm`)
  - Default limits:
    - `crm`: 120 calls per 60 seconds
    - `whatsapp`: 30 calls per 60 seconds
    - `system`: 60 calls per 60 seconds
  - Method `check(workspaceId: string, module: 'crm' | 'whatsapp' | 'system')` returns:
    ```typescript
    { allowed: boolean; remaining: number; resetMs: number }
    ```
  - Periodic cleanup every 5 minutes to prevent memory leaks (remove entries with all timestamps expired)
  - Export singleton instance: `export const rateLimiter = new ToolRateLimiter()`

  Follow the exact pattern from 12-RESEARCH.md Pattern 5, including the cleanup `setInterval`.

  **B) Create migration `supabase/migrations/20260205_tool_logs_agent_session.sql`:**

  ```sql
  -- Add agent_session_id to tool_executions for agent conversation tracing
  ALTER TABLE tool_executions
    ADD COLUMN IF NOT EXISTS agent_session_id UUID;

  -- Index for reconstructing agent conversations
  CREATE INDEX IF NOT EXISTS idx_tool_executions_agent_session
    ON tool_executions(agent_session_id)
    WHERE agent_session_id IS NOT NULL;

  COMMENT ON COLUMN tool_executions.agent_session_id IS
    'Agent session ID for tracing. NOT NULL when invoked by agent.';
  ```

  **C) Enhance `src/lib/audit/tool-logger.ts`:**

  1. Change the Supabase client import from `createClient` (cookie-based) to `createAdminClient` from `@/lib/supabase/admin`. The tool logger runs in server context without user session (from API routes, agents, webhooks). It MUST use admin client. Remove the `await` from `createClient()` since `createAdminClient()` is synchronous.

  2. Add `agent_session_id` to the `ToolExecutionInput` type (it inherits from ToolExecutionRecord via Omit, so this should work automatically after Task 1 updates).

  3. Add `agent_session_id: execution.agent_session_id` to the Supabase insert in `logToolExecution()`.

  IMPORTANT: Do NOT change the function signatures or remove any existing functionality. Only add the new field and fix the client import.
  </action>
  <verify>
  1. `npx tsc --noEmit` -- no TypeScript errors
  2. `grep -n "rateLimiter\|ToolRateLimiter" src/lib/tools/rate-limiter.ts` -- confirms exports
  3. `grep -n "agent_session_id" src/lib/audit/tool-logger.ts` -- confirms field added
  4. `grep -n "createAdminClient" src/lib/audit/tool-logger.ts` -- confirms admin client
  5. `cat supabase/migrations/20260205_tool_logs_agent_session.sql` -- migration exists
  </verify>
  <done>
  Rate limiter module created with sliding window. Migration adds agent_session_id column. Tool logger uses admin client and persists agent_session_id.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with zero errors
2. New types are properly exported from types.ts
3. Rate limiter singleton is importable
4. Tool logger uses createAdminClient (not createClient)
5. Migration SQL is valid
</verification>

<success_criteria>
- ToolResult<T> type system is complete and exported
- Rate limiter enforces per-workspace per-module limits
- Tool logger persists agent_session_id to database
- All existing TypeScript code still compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/12-action-dsl-real/12-01-SUMMARY.md`
</output>
