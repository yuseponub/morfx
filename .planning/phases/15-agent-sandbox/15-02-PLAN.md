---
phase: 15-agent-sandbox
plan: 02
type: execute
wave: 2
depends_on: ["15-01"]
files_modified:
  - src/app/(dashboard)/sandbox/page.tsx
  - src/app/(dashboard)/sandbox/components/sandbox-layout.tsx
  - src/app/(dashboard)/sandbox/components/sandbox-header.tsx
  - src/app/(dashboard)/sandbox/components/sandbox-chat.tsx
  - src/app/(dashboard)/sandbox/components/sandbox-message-bubble.tsx
  - src/app/(dashboard)/sandbox/components/sandbox-input.tsx
autonomous: true

must_haves:
  truths:
    - "User can access /sandbox and see split layout"
    - "User can type a message and see it appear in chat"
    - "Messages from user appear on right side with primary color"
    - "Messages from agent appear on left side with muted color (INVERTED from inbox)"
    - "Typing indicator shows when agent is processing"
    - "Timestamps visible in HH:MM:SS format"
  artifacts:
    - path: "src/app/(dashboard)/sandbox/page.tsx"
      provides: "Main sandbox page"
      min_lines: 30
    - path: "src/app/(dashboard)/sandbox/components/sandbox-layout.tsx"
      provides: "Allotment split pane layout"
      contains: "Allotment"
    - path: "src/app/(dashboard)/sandbox/components/sandbox-chat.tsx"
      provides: "Chat panel with message list and input"
      exports: ["SandboxChat"]
    - path: "src/app/(dashboard)/sandbox/components/sandbox-message-bubble.tsx"
      provides: "Message bubble with inverted theme"
      exports: ["SandboxMessageBubble"]
  key_links:
    - from: "src/app/(dashboard)/sandbox/page.tsx"
      to: "src/app/(dashboard)/sandbox/components/sandbox-layout.tsx"
      via: "Component import"
      pattern: "SandboxLayout"
    - from: "src/app/(dashboard)/sandbox/components/sandbox-chat.tsx"
      to: "src/lib/sandbox/sandbox-engine.ts"
      via: "Engine invocation"
      pattern: "SandboxEngine"
---

<objective>
Create the sandbox chat UI with Allotment split layout, inverted-theme message bubbles, and message input with typing indicator.

Purpose: Delivers the core user experience - writing messages as "customer" and seeing agent responses in real-time with production-like behavior.
Output: Split-pane layout with chat panel on left (60%), ready for debug panel on right (40%).
</objective>

<execution_context>
@/home/jose147/.claude/get-shit-done/workflows/execute-plan.md
@/home/jose147/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/15-agent-sandbox/15-CONTEXT.md
@.planning/phases/15-agent-sandbox/15-RESEARCH.md
@.planning/phases/15-agent-sandbox/15-01-SUMMARY.md
@src/lib/sandbox/types.ts
@src/lib/sandbox/sandbox-engine.ts
@src/app/(dashboard)/whatsapp/components/message-bubble.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create sandbox page and layout components</name>
  <files>
    src/app/(dashboard)/sandbox/page.tsx
    src/app/(dashboard)/sandbox/components/sandbox-layout.tsx
    src/app/(dashboard)/sandbox/components/sandbox-header.tsx
  </files>
  <action>
Create `src/app/(dashboard)/sandbox/page.tsx`:

```typescript
/**
 * Agent Sandbox Page
 * Phase 15: Agent Sandbox
 *
 * Main page for testing agent conversations without affecting real data.
 */

import { SandboxLayout } from './components/sandbox-layout'

export const metadata = {
  title: 'Agent Sandbox | MorfX',
  description: 'Prueba agentes de conversacion sin afectar datos reales',
}

export default function SandboxPage() {
  return <SandboxLayout />
}
```

Create `src/app/(dashboard)/sandbox/components/sandbox-layout.tsx`:

```typescript
'use client'

/**
 * Sandbox Layout Component
 * Phase 15: Agent Sandbox
 *
 * Allotment split pane layout with chat (60%) and debug panel (40%).
 * Resizable with drag handle.
 */

import { useState, useCallback } from 'react'
import { Allotment } from 'allotment'
import 'allotment/dist/style.css'
import { SandboxHeader } from './sandbox-header'
import { SandboxChat } from './sandbox-chat'
import type { ActiveSandboxSession, SandboxState, DebugTurn, SandboxMessage } from '@/lib/sandbox/types'
import { SandboxEngine } from '@/lib/sandbox/sandbox-engine'
import { getLastAgentId } from '@/lib/sandbox/sandbox-session'

// Initial agent - will be expanded when more agents are registered
const DEFAULT_AGENT_ID = 'somnio-sales-v1'

export function SandboxLayout() {
  // Session state
  const [agentId, setAgentId] = useState<string>(getLastAgentId() ?? DEFAULT_AGENT_ID)
  const [messages, setMessages] = useState<SandboxMessage[]>([])
  const [state, setState] = useState<SandboxState>(() => new SandboxEngine().getInitialState())
  const [debugTurns, setDebugTurns] = useState<DebugTurn[]>([])
  const [totalTokens, setTotalTokens] = useState(0)
  const [isTyping, setIsTyping] = useState(false)

  // Engine instance
  const [engine] = useState(() => new SandboxEngine())

  // Handle message send
  const handleSendMessage = useCallback(async (content: string) => {
    // 1. Add user message immediately
    const userMessage: SandboxMessage = {
      id: `msg-${Date.now()}-user`,
      role: 'user',
      content,
      timestamp: new Date().toISOString(),
    }
    setMessages(prev => [...prev, userMessage])

    // 2. Show typing indicator
    setIsTyping(true)

    // 3. Build history for engine
    const history = messages.map(m => ({ role: m.role, content: m.content }))
    history.push({ role: 'user', content })

    // 4. Process message
    const turnNumber = debugTurns.length + 1
    const result = await engine.processMessage(content, state, history, turnNumber)

    // 5. Hide typing and add response messages with delays
    if (result.success && result.messages.length > 0) {
      for (let i = 0; i < result.messages.length; i++) {
        // Simulate delay (2-6 seconds) between messages
        const delay = 2000 + Math.random() * 4000
        await new Promise(resolve => setTimeout(resolve, delay))

        const assistantMessage: SandboxMessage = {
          id: `msg-${Date.now()}-assistant-${i}`,
          role: 'assistant',
          content: result.messages[i],
          timestamp: new Date().toISOString(),
        }
        setMessages(prev => [...prev, assistantMessage])
      }
    }

    setIsTyping(false)

    // 6. Update state and debug info
    setState(result.newState)
    setDebugTurns(prev => [...prev, result.debugTurn])
    setTotalTokens(prev => prev + result.debugTurn.tokens.tokensUsed)
  }, [messages, state, debugTurns, engine])

  // Handle session reset
  const handleReset = useCallback(() => {
    setMessages([])
    setState(engine.getInitialState())
    setDebugTurns([])
    setTotalTokens(0)
    setIsTyping(false)
  }, [engine])

  // Handle agent change
  const handleAgentChange = useCallback((newAgentId: string) => {
    setAgentId(newAgentId)
  }, [])

  // Handle state edit from debug panel
  const handleStateEdit = useCallback((newState: SandboxState) => {
    setState(newState)
  }, [])

  return (
    <div className="flex flex-col h-full">
      <SandboxHeader
        agentId={agentId}
        onAgentChange={handleAgentChange}
        onReset={handleReset}
        totalTokens={totalTokens}
        messageCount={messages.length}
      />

      <div className="flex-1 min-h-0">
        <Allotment defaultSizes={[60, 40]} minSize={300}>
          <Allotment.Pane>
            <SandboxChat
              messages={messages}
              isTyping={isTyping}
              onSendMessage={handleSendMessage}
              agentId={agentId}
              currentMode={state.currentMode}
            />
          </Allotment.Pane>
          <Allotment.Pane snap>
            {/* Debug panel placeholder - will be implemented in Plan 03 */}
            <div className="h-full bg-muted/30 flex items-center justify-center text-muted-foreground">
              <div className="text-center space-y-2">
                <p className="font-medium">Debug Panel</p>
                <p className="text-sm">Tools | Estado | Intent | Tokens</p>
              </div>
            </div>
          </Allotment.Pane>
        </Allotment>
      </div>
    </div>
  )
}
```

Create `src/app/(dashboard)/sandbox/components/sandbox-header.tsx`:

```typescript
'use client'

/**
 * Sandbox Header Component
 * Phase 15: Agent Sandbox
 *
 * Toolbar with agent selector and session controls.
 * Shows agent name + status.
 */

import { Bot, RotateCcw, Coins } from 'lucide-react'
import { Button } from '@/components/ui/button'
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from '@/components/ui/select'
import {
  AlertDialog,
  AlertDialogAction,
  AlertDialogCancel,
  AlertDialogContent,
  AlertDialogDescription,
  AlertDialogFooter,
  AlertDialogHeader,
  AlertDialogTitle,
  AlertDialogTrigger,
} from '@/components/ui/alert-dialog'
import { setLastAgentId } from '@/lib/sandbox/sandbox-session'

// Available agents - will grow as more agents are registered
const AVAILABLE_AGENTS = [
  { id: 'somnio-sales-v1', name: 'Somnio Sales Agent' },
]

interface SandboxHeaderProps {
  agentId: string
  onAgentChange: (agentId: string) => void
  onReset: () => void
  totalTokens: number
  messageCount: number
}

export function SandboxHeader({
  agentId,
  onAgentChange,
  onReset,
  totalTokens,
  messageCount,
}: SandboxHeaderProps) {
  const currentAgent = AVAILABLE_AGENTS.find(a => a.id === agentId)

  const handleAgentChange = (newAgentId: string) => {
    setLastAgentId(newAgentId)
    onAgentChange(newAgentId)
  }

  return (
    <div className="flex items-center justify-between px-4 py-3 border-b bg-background">
      {/* Left: Agent selector and status */}
      <div className="flex items-center gap-3">
        <Bot className="h-5 w-5 text-primary" />

        <Select value={agentId} onValueChange={handleAgentChange}>
          <SelectTrigger className="w-[200px]">
            <SelectValue placeholder="Seleccionar agente" />
          </SelectTrigger>
          <SelectContent>
            {AVAILABLE_AGENTS.map(agent => (
              <SelectItem key={agent.id} value={agent.id}>
                {agent.name}
              </SelectItem>
            ))}
          </SelectContent>
        </Select>

        <span className="flex items-center gap-1.5 text-sm text-muted-foreground">
          <span className="inline-block w-2 h-2 rounded-full bg-green-500" />
          Activo
        </span>
      </div>

      {/* Right: Stats and controls */}
      <div className="flex items-center gap-4">
        {/* Token counter */}
        <div className="flex items-center gap-1.5 text-sm text-muted-foreground">
          <Coins className="h-4 w-4" />
          <span>{totalTokens.toLocaleString()} tokens</span>
          <span className="mx-1">|</span>
          <span>{messageCount} mensajes</span>
        </div>

        {/* Reset button with confirmation */}
        <AlertDialog>
          <AlertDialogTrigger asChild>
            <Button variant="outline" size="sm" disabled={messageCount === 0}>
              <RotateCcw className="h-4 w-4 mr-1.5" />
              Resetear
            </Button>
          </AlertDialogTrigger>
          <AlertDialogContent>
            <AlertDialogHeader>
              <AlertDialogTitle>Resetear sesion?</AlertDialogTitle>
              <AlertDialogDescription>
                Esto borrara todos los mensajes y el estado actual de la conversacion.
                Esta accion no se puede deshacer.
              </AlertDialogDescription>
            </AlertDialogHeader>
            <AlertDialogFooter>
              <AlertDialogCancel>Cancelar</AlertDialogCancel>
              <AlertDialogAction onClick={onReset}>
                Resetear
              </AlertDialogAction>
            </AlertDialogFooter>
          </AlertDialogContent>
        </AlertDialog>
      </div>
    </div>
  )
}
```
  </action>
  <verify>
Run `npx tsc --noEmit src/app/\(dashboard\)/sandbox/page.tsx` to verify page compiles.
Verify all component imports resolve correctly.
  </verify>
  <done>
Sandbox page created with Allotment split layout.
Header shows agent selector with confirmation dialogs.
Chat panel placeholder ready for message components.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create chat panel with message bubbles and input</name>
  <files>
    src/app/(dashboard)/sandbox/components/sandbox-chat.tsx
    src/app/(dashboard)/sandbox/components/sandbox-message-bubble.tsx
    src/app/(dashboard)/sandbox/components/sandbox-input.tsx
  </files>
  <action>
Create `src/app/(dashboard)/sandbox/components/sandbox-message-bubble.tsx`:

```typescript
'use client'

/**
 * Sandbox Message Bubble Component
 * Phase 15: Agent Sandbox
 *
 * Message bubble with INVERTED theme from real inbox:
 * - User messages (playing as customer): right side, primary color
 * - Agent messages: left side, muted color
 *
 * This is opposite of the real inbox where own messages are outbound (agent)
 * and received are customer. Here we're simulating being the customer.
 */

import { format } from 'date-fns'
import { cn } from '@/lib/utils'
import type { SandboxMessage } from '@/lib/sandbox/types'

interface SandboxMessageBubbleProps {
  message: SandboxMessage
}

export function SandboxMessageBubble({ message }: SandboxMessageBubbleProps) {
  // In sandbox: user = customer (right), assistant = agent (left)
  const isUser = message.role === 'user'

  // Format timestamp as HH:MM:SS per CONTEXT.md requirement
  const timestamp = format(new Date(message.timestamp), 'HH:mm:ss')

  return (
    <div
      className={cn(
        'flex px-4 py-1',
        isUser ? 'justify-end' : 'justify-start'
      )}
    >
      <div
        className={cn(
          'relative max-w-[70%] rounded-lg px-3 py-2 shadow-sm',
          isUser
            ? 'bg-primary text-primary-foreground rounded-br-none' // User = right, primary
            : 'bg-muted rounded-bl-none' // Agent = left, muted
        )}
      >
        {/* Message content */}
        <div className="text-sm">
          <p className="whitespace-pre-wrap break-words">{message.content}</p>
        </div>

        {/* Timestamp - always visible per CONTEXT.md */}
        <div
          className={cn(
            'flex items-center gap-1 mt-1',
            isUser ? 'justify-end' : 'justify-start'
          )}
        >
          <span
            className={cn(
              'text-[10px]',
              isUser ? 'text-primary-foreground/70' : 'text-muted-foreground'
            )}
          >
            {timestamp}
          </span>
        </div>
      </div>
    </div>
  )
}
```

Create `src/app/(dashboard)/sandbox/components/sandbox-input.tsx`:

```typescript
'use client'

/**
 * Sandbox Input Component
 * Phase 15: Agent Sandbox
 *
 * Message input fixed at bottom of chat panel.
 * Simple text input with send button.
 */

import { useState, useCallback, useRef, useEffect } from 'react'
import { Send } from 'lucide-react'
import { Button } from '@/components/ui/button'
import { Textarea } from '@/components/ui/textarea'

interface SandboxInputProps {
  onSend: (message: string) => void
  disabled?: boolean
  placeholder?: string
}

export function SandboxInput({ onSend, disabled, placeholder }: SandboxInputProps) {
  const [message, setMessage] = useState('')
  const textareaRef = useRef<HTMLTextAreaElement>(null)

  const handleSend = useCallback(() => {
    const trimmed = message.trim()
    if (!trimmed || disabled) return

    onSend(trimmed)
    setMessage('')

    // Focus back on textarea
    textareaRef.current?.focus()
  }, [message, disabled, onSend])

  const handleKeyDown = useCallback((e: React.KeyboardEvent) => {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault()
      handleSend()
    }
  }, [handleSend])

  // Auto-resize textarea
  useEffect(() => {
    const textarea = textareaRef.current
    if (textarea) {
      textarea.style.height = 'auto'
      textarea.style.height = `${Math.min(textarea.scrollHeight, 120)}px`
    }
  }, [message])

  return (
    <div className="flex items-end gap-2 p-4 border-t bg-background">
      <Textarea
        ref={textareaRef}
        value={message}
        onChange={(e) => setMessage(e.target.value)}
        onKeyDown={handleKeyDown}
        placeholder={placeholder ?? 'Escribe como cliente...'}
        disabled={disabled}
        className="min-h-[40px] max-h-[120px] resize-none"
        rows={1}
      />
      <Button
        onClick={handleSend}
        disabled={disabled || !message.trim()}
        size="icon"
        className="shrink-0"
      >
        <Send className="h-4 w-4" />
        <span className="sr-only">Enviar</span>
      </Button>
    </div>
  )
}
```

Create `src/app/(dashboard)/sandbox/components/sandbox-chat.tsx`:

```typescript
'use client'

/**
 * Sandbox Chat Component
 * Phase 15: Agent Sandbox
 *
 * Chat panel with message list, typing indicator, and input.
 * Messages scroll to bottom on new message.
 */

import { useRef, useEffect } from 'react'
import { ScrollArea } from '@/components/ui/scroll-area'
import { SandboxMessageBubble } from './sandbox-message-bubble'
import { SandboxInput } from './sandbox-input'
import { TypingIndicator } from './typing-indicator'
import type { SandboxMessage } from '@/lib/sandbox/types'

interface SandboxChatProps {
  messages: SandboxMessage[]
  isTyping: boolean
  onSendMessage: (content: string) => void
  agentId: string
  currentMode: string
}

export function SandboxChat({
  messages,
  isTyping,
  onSendMessage,
  agentId,
  currentMode,
}: SandboxChatProps) {
  const scrollRef = useRef<HTMLDivElement>(null)
  const bottomRef = useRef<HTMLDivElement>(null)

  // Scroll to bottom when new messages arrive
  useEffect(() => {
    bottomRef.current?.scrollIntoView({ behavior: 'smooth' })
  }, [messages, isTyping])

  return (
    <div className="flex flex-col h-full">
      {/* Chat header */}
      <div className="px-4 py-2 border-b bg-muted/30">
        <div className="flex items-center justify-between">
          <span className="text-sm font-medium">Chat de prueba</span>
          <span className="text-xs text-muted-foreground">
            Modo: {currentMode}
          </span>
        </div>
      </div>

      {/* Messages area */}
      <ScrollArea className="flex-1" ref={scrollRef}>
        <div className="py-4 space-y-1">
          {messages.length === 0 ? (
            <div className="flex items-center justify-center h-32 text-muted-foreground text-sm">
              Escribe un mensaje para iniciar la conversacion
            </div>
          ) : (
            <>
              {messages.map((message) => (
                <SandboxMessageBubble key={message.id} message={message} />
              ))}
            </>
          )}

          {/* Typing indicator */}
          {isTyping && (
            <div className="px-4 py-1">
              <TypingIndicator />
            </div>
          )}

          {/* Scroll anchor */}
          <div ref={bottomRef} />
        </div>
      </ScrollArea>

      {/* Input area */}
      <SandboxInput
        onSend={onSendMessage}
        disabled={isTyping}
        placeholder="Escribe como cliente..."
      />
    </div>
  )
}
```
  </action>
  <verify>
Run `npx tsc --noEmit src/app/\(dashboard\)/sandbox/components/sandbox-chat.tsx` to verify all components compile.
Check that imports between components resolve correctly.
  </verify>
  <done>
Chat panel created with inverted-theme message bubbles.
User messages appear on right with primary color.
Agent messages appear on left with muted color.
Typing indicator shows during processing.
Timestamps visible in HH:MM:SS format.
Input auto-resizes and handles Enter key.
  </done>
</task>

</tasks>

<verification>
1. Navigate to http://localhost:3020/sandbox - page loads without errors
2. Split layout visible with chat on left, placeholder on right
3. Agent selector dropdown works
4. Typing a message and pressing Enter shows it on right side
5. (May fail if no API key) Agent response appears on left after delay
6. Typing indicator visible during processing
7. Timestamps show HH:MM:SS format
8. Reset button shows confirmation dialog
</verification>

<success_criteria>
- /sandbox page accessible and renders split layout
- Allotment panels are resizable with drag
- User messages appear right-aligned with primary background
- Agent messages appear left-aligned with muted background
- Typing indicator animates during processing
- Timestamps visible on all messages in HH:MM:SS format
- Message input handles Enter key and disabled during typing
</success_criteria>

<output>
After completion, create `.planning/phases/15-agent-sandbox/15-02-SUMMARY.md`
</output>
