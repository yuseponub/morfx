---
phase: 18-domain-layer-foundation
plan: 03
type: execute
wave: 2
depends_on: ["18-01", "18-02"]
files_modified:
  - src/app/actions/orders.ts
  - src/lib/tools/handlers/crm/index.ts
  - src/lib/automations/action-executor.ts
  - src/lib/shopify/webhook-handler.ts
  - src/lib/agents/engine-adapters/production/orders.ts
  - src/lib/tools/schemas/crm.tools.ts
  - src/lib/tools/init.ts
autonomous: true

must_haves:
  truths:
    - "Server action createOrder calls domain.createOrder and no longer has inline DB logic"
    - "Tool handler crm.order.create calls domain.createOrder and no longer has inline DB logic"
    - "Action executor create_order calls domain.createOrder and no longer has inline trigger emission"
    - "Shopify webhook calls domain.createOrder instead of direct DB inserts"
    - "Production orders adapter calls domain.createOrder instead of direct OrderCreator DB logic"
    - "4 new tool handlers registered: crm.order.update, crm.order.delete, crm.order.duplicate, crm.order.list"
    - "No duplicate trigger emissions — old emissions removed from callers"
  artifacts:
    - path: "src/app/actions/orders.ts"
      provides: "Thin adapter calling domain/orders"
      contains: "import.*domain/orders"
    - path: "src/lib/tools/schemas/crm.tools.ts"
      provides: "4 new order tool schemas"
      contains: "crm.order.update"
  key_links:
    - from: "src/app/actions/orders.ts"
      to: "src/lib/domain/orders.ts"
      via: "import { createOrder, updateOrder, ... } from '@/lib/domain/orders'"
      pattern: "domain/orders"
    - from: "src/lib/tools/handlers/crm/index.ts"
      to: "src/lib/domain/orders.ts"
      via: "import domain order functions"
      pattern: "domain/orders"
    - from: "src/lib/automations/action-executor.ts"
      to: "src/lib/domain/orders.ts"
      via: "import domain order functions"
      pattern: "domain/orders"
---

<objective>
Wire ALL order callers to use domain/orders.ts instead of direct DB logic. Remove old trigger emissions from callers (Pitfall 5 and 6 from RESEARCH). Create 4 new order tool handlers and register them.

Purpose: Complete the orders entity migration. After this plan, every order mutation in the system goes through domain/, and every order mutation emits triggers — including bot operations, Shopify webhooks, and automations.

Output: 5 refactored caller files + 4 new tool handler schemas + registration.
</objective>

<execution_context>
@/home/jose147/.claude/get-shit-done/workflows/execute-plan.md
@/home/jose147/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/18-domain-layer-foundation/18-RESEARCH.md
@.planning/phases/18-domain-layer-foundation/18-02-SUMMARY.md

Key reference files:
@src/lib/domain/orders.ts (domain functions created in Plan 02)
@src/lib/domain/types.ts (DomainContext, DomainResult)
@src/app/actions/orders.ts (server actions to refactor)
@src/lib/tools/handlers/crm/index.ts (tool handlers to refactor + add new ones)
@src/lib/automations/action-executor.ts (action executor to refactor)
@src/lib/shopify/webhook-handler.ts (Shopify webhook to refactor)
@src/lib/agents/engine-adapters/production/orders.ts (production adapter to refactor)
@src/lib/tools/schemas/crm.tools.ts (add new tool schemas)
@src/lib/tools/init.ts (verify registration)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Wire server actions + action executor to domain/orders</name>
  <files>src/app/actions/orders.ts, src/lib/automations/action-executor.ts</files>
  <action>
**Refactor `src/app/actions/orders.ts`:**

For each mutation function (createOrder, updateOrder, moveOrderToStage, deleteOrder, deleteOrders, duplicateOrder, addOrderTag, removeOrderTag):
1. Import domain functions: `import { createOrder as domainCreateOrder, ... } from '@/lib/domain/orders'`
2. Import DomainContext: `import type { DomainContext } from '@/lib/domain/types'`
3. Keep auth validation (getUser + cookie workspace check)
4. Build DomainContext: `{ workspaceId, source: 'server-action' }`
5. Call domain function instead of direct DB
6. Keep `revalidatePath()` calls AFTER domain returns (adapter concern)
7. REMOVE all trigger emission imports and calls (emitOrderCreated, emitOrderStageChanged, emitFieldChanged, emitTagAssigned, emitTagRemoved) — domain handles these now
8. Keep Zod validation schemas as-is (adapter concern)
9. Keep read-only functions (getPipelines, getOrders, getOrderById, etc.) as-is — they don't mutate

For `deleteOrders` (bulk delete): loop over IDs calling `domainDeleteOrder` per ID.

**CRITICAL:** Remove ALL trigger emission code from orders.ts. The domain functions now emit triggers. Having both = duplicate triggers (Pitfall 5).

**Refactor `src/lib/automations/action-executor.ts`:**

For order-related action types (create_order, duplicate_order, change_stage, update_field for orders, assign_tag for orders, remove_tag for orders):
1. Import domain functions
2. Build DomainContext: `{ workspaceId, source: 'automation', cascadeDepth }`
3. Call domain function instead of direct DB + tool handler
4. REMOVE inline trigger emission code for these actions — domain handles cascade triggers now
5. Keep non-order actions unchanged (they'll be migrated in later plans)

**CRITICAL:** The action executor currently emits cascade triggers with `cascadeDepth + 1`. Domain functions receive `cascadeDepth` via DomainContext and pass it to trigger emitters. Remove the action executor's inline trigger emissions for order actions (Pitfall 6).
  </action>
  <verify>TypeScript compiles: `npx tsc --noEmit`. Search for orphaned trigger imports in orders.ts — should have NO emitOrder/emitTag/emitField imports left. Verify action-executor no longer has inline order trigger emissions.</verify>
  <done>Server actions and action executor delegate all order mutations to domain. No duplicate trigger emissions.</done>
</task>

<task type="auto">
  <name>Task 2: Wire tool handlers + Shopify + adapter + new tool handlers</name>
  <files>src/lib/tools/handlers/crm/index.ts, src/lib/shopify/webhook-handler.ts, src/lib/agents/engine-adapters/production/orders.ts, src/lib/tools/schemas/crm.tools.ts</files>
  <action>
**Refactor `src/lib/tools/handlers/crm/index.ts` — order handlers:**

For `crm.order.create` and `crm.order.updateStatus` handlers:
1. Import domain functions: `import { createOrder as domainCreateOrder, moveOrderToStage as domainMoveOrderToStage } from '@/lib/domain/orders'`
2. Build DomainContext: `{ workspaceId: context.workspaceId, source: 'tool-handler' }`
3. Call domain function. Map DomainResult to ToolResult (success/error mapping).
4. Remove direct DB logic for these handlers.
5. Keep other CRM handlers (contact, tag) unchanged for now — they'll be migrated in Plan 05.

**Add 4 NEW order tool handlers** to the same file:
- `crm.order.update`: Calls `domainUpdateOrder(ctx, params)`. Params: orderId, contactId?, description?, carrier?, trackingNumber?, shippingAddress?, shippingCity?
- `crm.order.delete`: Calls `domainDeleteOrder(ctx, { orderId })`. Bot permission: NO (automations only). Add check: if source is 'tool-handler', return error "Delete not available for bot". Actually, bot permission is enforced at a higher level — just implement the handler normally but add a comment that bot schemas should exclude this.
- `crm.order.duplicate`: Calls `domainDuplicateOrder(ctx, { sourceOrderId, targetPipelineId, targetStageId? })`.
- `crm.order.list`: Read-only — query orders with filters (pipelineId?, stageId?, contactId?, page?, pageSize?). Uses createAdminClient + workspace_id filter. No domain function needed for reads.

**Add tool schemas** to `src/lib/tools/schemas/crm.tools.ts`:
- Add 4 new tool definitions following existing pattern (name, description, parameters with JSON Schema, examples)
- crm.order.update, crm.order.delete, crm.order.duplicate, crm.order.list

**Refactor `src/lib/shopify/webhook-handler.ts`:**

In `processShopifyWebhook` where it creates orders:
1. Import `createOrder as domainCreateOrder` from `@/lib/domain/orders`
2. Import `createContact as domainCreateContact` from `@/lib/domain/contacts` — BUT contacts domain doesn't exist yet (Plan 04). For NOW, keep direct contact creation logic, only replace order creation with domain call.
3. Build DomainContext: `{ workspaceId, source: 'webhook' }`
4. Replace direct order insert with `domainCreateOrder(ctx, { contactId, pipelineId, products, ... })`
5. Keep idempotency check, contact matching, webhook event logging as-is.

**Refactor `src/lib/agents/engine-adapters/production/orders.ts`:**

The ProductionOrdersAdapter wraps OrderCreator. Refactor to:
1. Import domain order functions
2. Build DomainContext: `{ workspaceId, source: 'adapter' }`
3. Keep OrderCreator's data mapping logic (datosCapturados -> params) in the adapter
4. Replace OrderCreator's direct DB calls with domain function calls
5. The adapter maps agent-specific data to domain params, then calls domain.
  </action>
  <verify>TypeScript compiles. New tool handlers appear in the exports. Grep for `crm.order.update` in schemas file. Shopify handler no longer has direct order INSERT. Production adapter imports from domain/orders.</verify>
  <done>All 5 order callers wired to domain. 4 new order tool handlers created and registered. Orders entity is 100% complete.</done>
</task>

</tasks>

<verification>
1. `src/app/actions/orders.ts` has NO trigger emission code (no emitOrder*, emitTag*, emitField* calls)
2. `src/lib/tools/handlers/crm/index.ts` has order handlers calling domain, plus 4 new handlers
3. `src/lib/automations/action-executor.ts` order actions call domain, no inline trigger code for orders
4. `src/lib/shopify/webhook-handler.ts` calls domain.createOrder
5. `src/lib/agents/engine-adapters/production/orders.ts` calls domain functions
6. `src/lib/tools/schemas/crm.tools.ts` has 4 new order tool schemas
7. `npx tsc --noEmit` passes
8. No duplicate trigger emissions possible for orders
</verification>

<success_criteria>
- Every order mutation in the system goes through domain/orders.ts
- Every order mutation emits its trigger (including bot, Shopify, automations)
- No caller has direct DB mutation logic for orders
- 4 new order tool handlers are registered and functional
</success_criteria>

<output>
After completion, create `.planning/phases/18-domain-layer-foundation/18-03-SUMMARY.md`
</output>
