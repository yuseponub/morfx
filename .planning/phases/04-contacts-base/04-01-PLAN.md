---
phase: 04-contacts-base
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/20260129000001_contacts_and_tags.sql
  - src/lib/types/database.ts
  - src/lib/utils/phone.ts
  - src/lib/data/colombia-cities.ts
  - src/lib/data/tag-colors.ts
  - src/app/actions/contacts.ts
  - src/app/actions/tags.ts
autonomous: true

must_haves:
  truths:
    - "Contacts table exists with workspace isolation (RLS)"
    - "Tags table exists with workspace isolation (RLS)"
    - "Contact CRUD operations work via Server Actions"
    - "Phone numbers are normalized to E.164 format (+57XXXXXXXXXX)"
  artifacts:
    - path: "supabase/migrations/20260129000001_contacts_and_tags.sql"
      provides: "Database schema for contacts and tags"
      contains: "CREATE TABLE contacts"
    - path: "src/lib/utils/phone.ts"
      provides: "Phone normalization with libphonenumber-js"
      exports: ["normalizePhone", "formatPhoneDisplay", "isValidColombianPhone"]
    - path: "src/app/actions/contacts.ts"
      provides: "Contact CRUD Server Actions"
      exports: ["createContact", "updateContact", "deleteContact", "getContacts"]
    - path: "src/app/actions/tags.ts"
      provides: "Tag CRUD Server Actions"
      exports: ["createTag", "getTags", "deleteTag"]
  key_links:
    - from: "src/app/actions/contacts.ts"
      to: "src/lib/utils/phone.ts"
      via: "normalizePhone import"
      pattern: "import.*normalizePhone.*from.*phone"
    - from: "src/app/actions/contacts.ts"
      to: "supabase"
      via: "createClient and RLS"
      pattern: "from\\('contacts'\\)"
---

<objective>
Create the database foundation and Server Actions for contact and tag management.

Purpose: Establish the data layer that enables contact CRUD with phone normalization and workspace-isolated tags. This is the foundation for the entire CRM contacts module.

Output:
- Migration file with contacts, tags, contact_tags tables and RLS policies
- TypeScript types for Contact and Tag entities
- Phone normalization utility using libphonenumber-js
- Colombian cities dataset for city autocomplete
- Tag color palette with contrast-safe colors
- Server Actions for contact and tag CRUD operations
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-contacts-base/04-CONTEXT.md
@.planning/phases/04-contacts-base/04-RESEARCH.md

# Existing patterns to follow
@src/app/actions/workspace.ts
@src/app/actions/invitations.ts
@src/lib/types/database.ts
@supabase/migrations/20260128000001_workspaces_and_roles.sql
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install dependencies and create data utilities</name>
  <files>
    - package.json
    - src/lib/utils/phone.ts
    - src/lib/data/colombia-cities.ts
    - src/lib/data/tag-colors.ts
  </files>
  <action>
1. Install libphonenumber-js and emblor:
   ```bash
   pnpm add libphonenumber-js emblor
   ```

2. Create phone normalization utility `src/lib/utils/phone.ts`:
   - `normalizePhone(input: string): string | null` - Normalizes to E.164 (+573001234567)
   - `formatPhoneDisplay(e164: string): string` - Formats for display (+57 300 123 4567)
   - `isValidColombianPhone(input: string): boolean` - Validates Colombian phone numbers
   - Use 'CO' as default country code
   - Handle edge cases: numbers with/without +, with/without country code

3. Create Colombian cities dataset `src/lib/data/colombia-cities.ts`:
   - Export `colombiaCities` array with ~1100 municipalities
   - Each entry: `{ value: string, label: string, department: string }`
   - Include major cities: Bogota, Medellin, Cali, Barranquilla, Cartagena, etc.
   - Sort alphabetically by label
   - Source data from colombia-json GitHub repo format

4. Create tag color palette `src/lib/data/tag-colors.ts`:
   - Export `TAG_COLORS` array with 10 predefined colors
   - Each entry: `{ name: string, value: string, textColor: string }`
   - Colors: Rojo, Naranja, Amarillo, Verde, Azul, Indigo, Violeta, Rosa, Gris, Cian
   - Include `getContrastColor(hexColor: string): string` function for custom colors
   - Default color: Indigo (#6366f1)
  </action>
  <verify>
    - `pnpm list libphonenumber-js emblor` shows both packages
    - TypeScript compiles without errors: `pnpm tsc --noEmit`
  </verify>
  <done>
    - Phone utility normalizes "3001234567" to "+573001234567"
    - Cities dataset exports array with 50+ Colombian cities
    - Tag colors export provides 10 palette colors with contrast
  </done>
</task>

<task type="auto">
  <name>Task 2: Create database migration for contacts and tags</name>
  <files>
    - supabase/migrations/20260129000001_contacts_and_tags.sql
    - src/lib/types/database.ts
  </files>
  <action>
1. Create migration file `supabase/migrations/20260129000001_contacts_and_tags.sql`:

   **Tags table:**
   - id: UUID PRIMARY KEY (gen_random_uuid)
   - workspace_id: UUID NOT NULL REFERENCES workspaces(id) ON DELETE CASCADE
   - name: TEXT NOT NULL
   - color: TEXT NOT NULL DEFAULT '#6366f1' (Indigo)
   - created_at: TIMESTAMPTZ DEFAULT timezone('America/Bogota', NOW())
   - UNIQUE(workspace_id, name)

   **Contacts table:**
   - id: UUID PRIMARY KEY (gen_random_uuid)
   - workspace_id: UUID NOT NULL REFERENCES workspaces(id) ON DELETE CASCADE
   - name: TEXT NOT NULL
   - phone: TEXT NOT NULL (E.164 format)
   - email: TEXT (nullable)
   - address: TEXT (nullable)
   - city: TEXT (nullable)
   - created_at: TIMESTAMPTZ DEFAULT timezone('America/Bogota', NOW())
   - updated_at: TIMESTAMPTZ DEFAULT timezone('America/Bogota', NOW())
   - UNIQUE(workspace_id, phone)

   **Contact_tags junction table:**
   - id: UUID PRIMARY KEY (gen_random_uuid)
   - contact_id: UUID NOT NULL REFERENCES contacts(id) ON DELETE CASCADE
   - tag_id: UUID NOT NULL REFERENCES tags(id) ON DELETE CASCADE
   - created_at: TIMESTAMPTZ DEFAULT timezone('America/Bogota', NOW())
   - UNIQUE(contact_id, tag_id)

   **Indexes:**
   - idx_contacts_workspace ON contacts(workspace_id)
   - idx_contacts_phone ON contacts(phone)
   - idx_contacts_updated ON contacts(updated_at DESC)
   - idx_tags_workspace ON tags(workspace_id)
   - idx_contact_tags_contact ON contact_tags(contact_id)
   - idx_contact_tags_tag ON contact_tags(tag_id)

   **RLS Policies (following Phase 2 patterns):**
   - contacts_workspace_isolation: workspace_id matches JWT app_metadata.workspace_id
   - tags_workspace_isolation: same pattern
   - contact_tags_access: through contact ownership check

   **Triggers:**
   - Reuse existing `set_workspace_id()` function from Phase 2 migration
   - Create contacts_set_workspace trigger (BEFORE INSERT)
   - Create tags_set_workspace trigger (BEFORE INSERT)
   - Reuse existing `update_updated_at()` function or create if not exists
   - Create contacts_updated_at trigger (BEFORE UPDATE)

2. Update `src/lib/types/database.ts` to add:
   - `Tag` interface: id, workspace_id, name, color, created_at
   - `Contact` interface: id, workspace_id, name, phone, email, address, city, created_at, updated_at
   - `ContactTag` interface: id, contact_id, tag_id, created_at
   - `ContactWithTags` joined type (contact with nested tags array)
   - `CreateContactInput` form type
   - `UpdateContactInput` form type
   - `CreateTagInput` form type
  </action>
  <verify>
    - Migration file exists and has valid SQL syntax
    - TypeScript compiles: `pnpm tsc --noEmit`
    - Types exported from database.ts
  </verify>
  <done>
    - Migration creates contacts, tags, contact_tags tables
    - RLS policies enforce workspace isolation
    - TypeScript types match database schema
  </done>
</task>

<task type="auto">
  <name>Task 3: Create Server Actions for contacts and tags CRUD</name>
  <files>
    - src/app/actions/contacts.ts
    - src/app/actions/tags.ts
  </files>
  <action>
1. Create `src/app/actions/contacts.ts` (following workspace.ts pattern):

   **Schema validation (Zod):**
   ```typescript
   const contactSchema = z.object({
     name: z.string().min(1, 'El nombre es requerido'),
     phone: z.string().min(1, 'El telefono es requerido'),
     email: z.string().email('Email invalido').optional().or(z.literal('')),
     address: z.string().optional(),
     city: z.string().optional(),
   })
   ```

   **Functions:**
   - `getContacts()` - List all contacts with tags for current workspace
     - Query: contacts with contact_tags -> tags join
     - Order by: updated_at DESC (most recent first)
     - RLS handles workspace filtering automatically

   - `getContact(id: string)` - Get single contact with tags
     - Return null if not found (RLS prevents cross-workspace access)

   - `createContact(formData: FormData)` - Create new contact
     - Validate with Zod schema
     - Normalize phone with `normalizePhone()` - return error if invalid
     - Insert via Supabase (RLS auto-sets workspace_id via trigger)
     - Handle 23505 unique violation (duplicate phone)
     - revalidatePath('/crm/contactos')
     - Return { success: true, data } or { error: { field: ['message'] } }

   - `updateContact(id: string, formData: FormData)` - Update contact
     - Same validation as create
     - Normalize phone
     - Update via Supabase
     - revalidatePath

   - `deleteContact(id: string)` - Delete single contact
     - Delete via Supabase (cascade deletes contact_tags)
     - revalidatePath

   - `deleteContacts(ids: string[])` - Bulk delete
     - Delete multiple contacts
     - revalidatePath

   - `addTagToContact(contactId: string, tagId: string)` - Add tag
     - Insert into contact_tags
     - Handle duplicate gracefully (unique constraint)
     - revalidatePath

   - `removeTagFromContact(contactId: string, tagId: string)` - Remove tag
     - Delete from contact_tags
     - revalidatePath

   - `bulkAddTag(contactIds: string[], tagId: string)` - Bulk add tag
   - `bulkRemoveTag(contactIds: string[], tagId: string)` - Bulk remove tag

2. Create `src/app/actions/tags.ts`:

   **Functions:**
   - `getTags()` - List all tags for current workspace
     - Order by: name ASC

   - `createTag(formData: FormData)` - Create new tag
     - Validate: name required, color optional (default to palette first color)
     - Handle 23505 unique violation (duplicate name in workspace)
     - revalidatePath

   - `updateTag(id: string, formData: FormData)` - Update tag name/color

   - `deleteTag(id: string)` - Delete tag
     - Cascade deletes contact_tags entries
     - revalidatePath
  </action>
  <verify>
    - TypeScript compiles without errors: `pnpm tsc --noEmit`
    - Server Actions export correctly (check exports with IDE)
  </verify>
  <done>
    - All CRUD operations implemented following existing patterns
    - Phone normalization integrated into create/update
    - Bulk operations supported for contact management
    - Proper error handling with Zod validation
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

1. **Dependencies installed:**
   ```bash
   pnpm list libphonenumber-js emblor
   ```

2. **TypeScript compiles:**
   ```bash
   pnpm tsc --noEmit
   ```

3. **Migration file valid:**
   - Check file exists: `ls supabase/migrations/20260129000001_contacts_and_tags.sql`
   - Review SQL syntax (no syntax errors)

4. **Phone normalization works:**
   - Unit test mentally: normalizePhone("3001234567") should return "+573001234567"
   - normalizePhone("300 123 4567") should return "+573001234567"
   - normalizePhone("invalid") should return null

5. **Server Actions structure:**
   - contacts.ts exports: getContacts, getContact, createContact, updateContact, deleteContact, deleteContacts, addTagToContact, removeTagFromContact, bulkAddTag, bulkRemoveTag
   - tags.ts exports: getTags, createTag, updateTag, deleteTag
</verification>

<success_criteria>
- [ ] libphonenumber-js and emblor installed in package.json
- [ ] Phone utility normalizes Colombian phone numbers to E.164
- [ ] Colombian cities dataset provides autocomplete options
- [ ] Tag color palette with 10 colors and contrast calculation
- [ ] Migration file creates contacts, tags, contact_tags with RLS
- [ ] TypeScript types match database schema
- [ ] Contact Server Actions handle CRUD with phone normalization
- [ ] Tag Server Actions handle CRUD with workspace isolation
- [ ] All code compiles without TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/04-contacts-base/04-01-SUMMARY.md` using the summary template.
</output>
