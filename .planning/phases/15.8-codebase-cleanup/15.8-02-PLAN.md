---
phase: 15.8-codebase-cleanup
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/app/(dashboard)/sandbox/components/sandbox-layout.tsx
  - src/lib/agents/somnio/somnio-orchestrator.ts
  - src/lib/agents/somnio/data-extractor.ts
  - src/lib/agents/somnio/template-manager.ts
  - src/lib/agents/crm/order-manager/agent.ts
  - src/lib/agents/somnio/message-sequencer.ts
  - src/app/api/sandbox/process/route.ts
  - src/app/api/webhooks/whatsapp/route.ts
  - src/app/actions/invitations.ts
autonomous: true

must_haves:
  truths:
    - "Null access bugs #7 and #12 fixed: optional chaining prevents crashes on missing tokens and null contacts"
    - "Token tracking bug #9 fixed: DataExtractor.extract tokensUsed captured and propagated"
    - "Model constant bug #10 fixed: data-extractor uses config model instead of hardcoded string"
    - "Query safety bug #11 addressed: template-manager workspaceId validated or safely interpolated"
    - "Async error bug #13 addressed: message-sequencer sendMessage error handling improved"
    - "Security #2: WhatsApp webhook validates HMAC signature (or has env-gated validation)"
    - "Security #3: invitations.ts removeMember, updateMemberRole, cancelInvitation verify workspace membership"
    - "Security #4: sandbox API requires authentication and validates workspace ownership"
    - "TypeScript compiles with zero source errors"
  artifacts:
    - path: "src/app/(dashboard)/sandbox/components/sandbox-layout.tsx"
      provides: "Null-safe token access"
      contains: "tokens\\?\\.tokensUsed"
    - path: "src/app/api/sandbox/process/route.ts"
      provides: "Authentication check + workspace validation"
      contains: "auth\\.getUser|401"
    - path: "src/app/api/webhooks/whatsapp/route.ts"
      provides: "HMAC signature verification"
      contains: "verifyWhatsAppHmac|X-Hub-Signature"
    - path: "src/app/actions/invitations.ts"
      provides: "Workspace membership verification in 3 functions"
      contains: "workspace_members.*role.*owner.*admin"
  key_links:
    - from: "sandbox/process/route.ts"
      to: "supabase.auth.getUser()"
      via: "authentication check before processing"
      pattern: "getUser.*user.*401"
    - from: "webhooks/whatsapp/route.ts"
      to: "HMAC verification"
      via: "crypto.timingSafeEqual"
      pattern: "timingSafeEqual|createHmac"
---

<objective>
Fix all 7 high severity bugs and implement 3 actionable security fixes: sandbox authentication, WhatsApp webhook HMAC verification, and workspace isolation in server actions.

Purpose: Eliminate null access crashes, logic errors, and close the most important security gaps before production deployment in Phase 16.
Output: 9 files patched with targeted fixes, each verified by `tsc --noEmit`.
</objective>

<execution_context>
@/home/jose147/.claude/get-shit-done/workflows/execute-plan.md
@/home/jose147/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/codebase/audit/BUGS.md
@.planning/codebase/audit/SECURITY.md
@.planning/phases/15.8-codebase-cleanup/15.8-RESEARCH.md

Key source files:
@src/app/(dashboard)/sandbox/components/sandbox-layout.tsx
@src/lib/agents/somnio/somnio-orchestrator.ts
@src/lib/agents/somnio/data-extractor.ts
@src/lib/agents/somnio/template-manager.ts
@src/lib/agents/crm/order-manager/agent.ts
@src/lib/agents/somnio/message-sequencer.ts
@src/app/api/sandbox/process/route.ts
@src/app/api/webhooks/whatsapp/route.ts
@src/app/actions/invitations.ts
@src/app/api/webhooks/shopify/route.ts (reference for HMAC pattern)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix high severity bugs #7, #9, #10, #11, #12, #13</name>
  <files>
    src/app/(dashboard)/sandbox/components/sandbox-layout.tsx
    src/lib/agents/somnio/somnio-orchestrator.ts
    src/lib/agents/somnio/data-extractor.ts
    src/lib/agents/somnio/template-manager.ts
    src/lib/agents/crm/order-manager/agent.ts
    src/lib/agents/somnio/message-sequencer.ts
  </files>
  <action>
Fix 6 independent high severity bugs. Each is a small, targeted change.

**Bug #7 (null token access in sandbox-layout.tsx, ~line 435):**
Find where `result.debugTurn.tokens.tokensUsed` is accessed without null check.
Change to: `result.debugTurn?.tokens?.tokensUsed ?? 0`
Also check any other property accesses on `result.debugTurn.tokens` nearby and add optional chaining.

**Bug #9 (missing token tracking in somnio-orchestrator.ts, ~line 356):**
Find where `DataExtractor.extract()` is called. The result should include `tokensUsed` but it's being ignored (hardcoded to 0).
Fix: Capture the `tokensUsed` from the extract result and add it to the orchestrator's token tracking.
Look at the return type of `dataExtractor.extract()` to see what fields are available. If it returns `{ result, tokensUsed }`, destructure properly and propagate `tokensUsed` to the caller.

**Bug #10 (model string in data-extractor.ts, ~line 217):**
Find the hardcoded model string (`'claude-sonnet-4-5'` or similar) in data-extractor.ts.
Replace with the model from the agent config: use `this.model` or whatever config property holds the model name.
If there's already a `this.model` property, use it. If not, check the constructor for a config parameter that includes model selection.
The goal: model choice should come from config, not a hardcoded string.

**Bug #11 (query injection risk in template-manager.ts, ~line 238):**
Find the `.or()` call with template string interpolation of `this.workspaceId`.
The research notes that Supabase client handles escaping, but for defense-in-depth:
1. Validate that `this.workspaceId` is a valid UUID format before interpolation
2. OR use the safer pattern: `.or('workspace_id.is.null,workspace_id.eq.' + this.workspaceId)`
Both approaches are acceptable. Choose the simplest one.

**Bug #12 (null contacts in order-manager/agent.ts, ~line 197-202):**
Find where `contacts` result is checked with `contacts && contacts.length > 0`.
Change to: `Array.isArray(contacts) && contacts.length > 0`
This handles the case where API returns `{ contacts: null }` instead of `{ contacts: [] }`.

**Bug #13 (missing await in message-sequencer.ts, ~line 259):**
Find where `sendMessage` is called async but error handling may be incomplete.
Read the surrounding code carefully. The fix should ensure that:
1. If `sendMessage` fails, the error is caught and the sequence is properly aborted
2. The `success` variable correctly reflects the send outcome
If the issue is that a try/catch is missing around the async call, add it. If the issue is that the return value isn't properly awaited, add `await`.

After ALL fixes, run `npx tsc --noEmit` to verify clean compilation.
Commit: `fix(15.8-02): high severity bugs #7, #9, #10, #11, #12, #13`
  </action>
  <verify>
1. `npx tsc --noEmit` passes with zero source errors
2. Bug #7: `grep -n "tokens?\\." src/app/(dashboard)/sandbox/components/sandbox-layout.tsx` shows optional chaining
3. Bug #9: Token tracking captured from dataExtractor.extract() call
4. Bug #10: No hardcoded model string in data-extractor.ts (uses config)
5. Bug #12: `grep -n "Array.isArray" src/lib/agents/crm/order-manager/agent.ts` shows array check
  </verify>
  <done>
- Bug #7: Null-safe token access with optional chaining
- Bug #9: tokensUsed properly captured from DataExtractor.extract()
- Bug #10: Model comes from config, not hardcoded string
- Bug #11: workspaceId safely interpolated in query
- Bug #12: Array.isArray check prevents null contacts crash
- Bug #13: sendMessage error handling improved
- TypeScript compiles clean
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement security fixes (Security #2, #3, #4)</name>
  <files>
    src/app/api/sandbox/process/route.ts
    src/app/api/webhooks/whatsapp/route.ts
    src/app/actions/invitations.ts
  </files>
  <action>
Implement 3 actionable security fixes. Each is independent.

**Security #4 (sandbox API authentication - src/app/api/sandbox/process/route.ts):**

Add authentication and workspace validation to the sandbox process endpoint:

1. Import `createClient` from `@/lib/supabase/server`
2. At the TOP of the POST handler (before parsing body), add:
   ```typescript
   const supabase = await createClient()
   const { data: { user } } = await supabase.auth.getUser()
   if (!user) {
     return NextResponse.json({ error: 'Authentication required' }, { status: 401 })
   }
   ```
3. After parsing body, if `workspaceId` is provided AND any CRM agent has `mode: 'live'`, validate workspace membership:
   ```typescript
   const hasLiveAgent = crmAgents?.some((a: any) => a.mode === 'live')
   if (hasLiveAgent && workspaceId) {
     const { data: membership } = await supabase
       .from('workspace_members')
       .select('role')
       .eq('workspace_id', workspaceId)
       .eq('user_id', user.id)
       .single()
     if (!membership) {
       return NextResponse.json({ error: 'Workspace access denied' }, { status: 403 })
     }
   }
   ```

**Security #2 (WhatsApp webhook HMAC - src/app/api/webhooks/whatsapp/route.ts):**

Add HMAC signature verification, gated by environment variable (so it doesn't break development):

1. At the top of the POST handler, BEFORE `request.json()`:
   - Read the raw body: `const rawBody = await request.text()`
   - Check for `WHATSAPP_WEBHOOK_SECRET` env var
   - If the env var exists (production), verify the signature:
     ```typescript
     const webhookSecret = process.env.WHATSAPP_WEBHOOK_SECRET
     if (webhookSecret) {
       const signature = request.headers.get('X-Hub-Signature-256') || request.headers.get('X-360Dialog-Signature') || ''
       if (!signature) {
         console.warn('WhatsApp webhook: missing signature header')
         return NextResponse.json({ error: 'Missing signature' }, { status: 401 })
       }
       const isValid = verifyWhatsAppHmac(rawBody, signature, webhookSecret)
       if (!isValid) {
         console.warn('WhatsApp webhook: invalid signature')
         return NextResponse.json({ error: 'Invalid signature' }, { status: 401 })
       }
     }
     const payload = JSON.parse(rawBody)
     ```
   - If env var doesn't exist (development), skip verification and parse normally

2. Add the HMAC verification function either inline in the route file or in a small helper:
   ```typescript
   import crypto from 'crypto'

   function verifyWhatsAppHmac(body: string, signature: string, secret: string): boolean {
     const hmac = crypto.createHmac('sha256', secret)
     hmac.update(body)
     const expectedSignature = hmac.digest('hex')
     // Handle both 'sha256=xxx' prefix format and raw hex format
     const actualSignature = signature.startsWith('sha256=') ? signature.slice(7) : signature
     try {
       return crypto.timingSafeEqual(
         Buffer.from(expectedSignature),
         Buffer.from(actualSignature)
       )
     } catch {
       return false  // Length mismatch
     }
   }
   ```

3. IMPORTANT: The existing code uses `request.json()` to parse the body. After adding HMAC verification, we read the body as text first, then parse with `JSON.parse(rawBody)`. Make sure to update ALL references from `await request.json()` to `JSON.parse(rawBody)`.

**Security #3 (workspace isolation in invitations.ts):**

Add workspace membership verification to 3 functions in `src/app/actions/invitations.ts`:

1. **`removeMember(workspaceId, memberId)`** (~line 207-243):
   After the auth check (`if (!user)`), add workspace admin/owner verification:
   ```typescript
   const { data: membership } = await supabase
     .from('workspace_members')
     .select('role')
     .eq('workspace_id', workspaceId)
     .eq('user_id', user.id)
     .single()

   if (!membership || !['owner', 'admin'].includes(membership.role)) {
     return { error: 'No tienes permisos para esta accion' }
   }
   ```

2. **`updateMemberRole(workspaceId, memberId, newRole)`** (~line 245-281):
   Same pattern as removeMember - verify admin/owner access before proceeding.

3. **`cancelInvitation(invitationId)`** (~line 101-121):
   After the auth check, fetch the invitation to get its workspace_id, then verify membership:
   ```typescript
   // First fetch the invitation to get workspace_id
   const { data: invitation } = await supabase
     .from('workspace_invitations')
     .select('workspace_id')
     .eq('id', invitationId)
     .single()

   if (!invitation) {
     return { error: 'Invitacion no encontrada' }
   }

   // Verify user is admin/owner of the workspace
   const { data: membership } = await supabase
     .from('workspace_members')
     .select('role')
     .eq('workspace_id', invitation.workspace_id)
     .eq('user_id', user.id)
     .single()

   if (!membership || !['owner', 'admin'].includes(membership.role)) {
     return { error: 'No tienes permisos para esta accion' }
   }
   ```

After ALL security fixes, run `npx tsc --noEmit` to verify clean compilation.
Commit: `fix(15.8-02): security fixes - sandbox auth, webhook HMAC, workspace isolation`
  </action>
  <verify>
1. `npx tsc --noEmit` passes with zero source errors
2. Security #4: `grep -n "getUser\|401" src/app/api/sandbox/process/route.ts` shows auth check
3. Security #2: `grep -n "verifyWhatsAppHmac\|createHmac\|timingSafeEqual" src/app/api/webhooks/whatsapp/route.ts` shows HMAC verification
4. Security #3: `grep -n "workspace_members.*role" src/app/actions/invitations.ts` shows membership checks in 3 functions
  </verify>
  <done>
- Security #4: Sandbox API requires authentication; LIVE mode validates workspace membership
- Security #2: WhatsApp webhook verifies HMAC signature when WHATSAPP_WEBHOOK_SECRET is set
- Security #3: removeMember, updateMemberRole, cancelInvitation all verify workspace admin/owner access
- TypeScript compiles clean
  </done>
</task>

</tasks>

<verification>
After both tasks complete:
1. `npx tsc --noEmit` passes with zero source errors (GATE)
2. All 9 modified files have the expected changes
3. Security fixes don't break existing functionality (auth gate is conditional on env var for HMAC)
4. Each fix committed atomically with descriptive message
</verification>

<success_criteria>
1. Bugs #7, #9, #10, #11, #12, #13 all fixed
2. Security #2: HMAC verification added (env-gated)
3. Security #3: 3 functions in invitations.ts have workspace verification
4. Security #4: Sandbox API has auth check + workspace validation for LIVE mode
5. TypeScript compiles with zero source errors
6. Each fix or group committed atomically
</success_criteria>

<output>
After completion, create `.planning/phases/15.8-codebase-cleanup/15.8-02-SUMMARY.md`
</output>
