---
phase: 07-whatsapp-core
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/20260130000002_whatsapp_conversations.sql
  - src/lib/whatsapp/types.ts
  - src/lib/whatsapp/api.ts
  - src/lib/whatsapp/webhook-handler.ts
  - src/app/api/webhooks/whatsapp/route.ts
  - src/app/actions/conversations.ts
autonomous: true
user_setup:
  - service: 360dialog
    why: "WhatsApp Business API access"
    env_vars:
      - name: WHATSAPP_360_API_KEY
        source: "360dialog Partner Hub -> Account -> API Key"
      - name: WHATSAPP_PHONE_NUMBER_ID
        source: "360dialog Partner Hub -> Numbers -> Phone Number ID"
    dashboard_config:
      - task: "Configure webhook URL"
        location: "360dialog Partner Hub -> Settings -> Webhooks -> Set to https://yourdomain.com/api/webhooks/whatsapp"

must_haves:
  truths:
    - "System can receive webhook payloads from 360dialog"
    - "Incoming messages are stored in database with unique wamid"
    - "Messages link to existing contacts by phone number"
    - "360dialog API client can send text messages"
  artifacts:
    - path: "supabase/migrations/20260130000002_whatsapp_conversations.sql"
      provides: "Conversations and messages tables with RLS"
      contains: "CREATE TABLE conversations"
    - path: "src/lib/whatsapp/types.ts"
      provides: "TypeScript types for WhatsApp domain"
      exports: ["Conversation", "Message", "WebhookPayload"]
    - path: "src/lib/whatsapp/api.ts"
      provides: "360dialog API client"
      exports: ["sendTextMessage", "sendMediaMessage"]
    - path: "src/lib/whatsapp/webhook-handler.ts"
      provides: "Webhook processing logic"
      exports: ["processWebhook"]
    - path: "src/app/api/webhooks/whatsapp/route.ts"
      provides: "Webhook endpoint"
      exports: ["GET", "POST"]
    - path: "src/app/actions/conversations.ts"
      provides: "Server Actions for conversation operations"
      exports: ["getConversations", "getConversation"]
  key_links:
    - from: "src/app/api/webhooks/whatsapp/route.ts"
      to: "src/lib/whatsapp/webhook-handler.ts"
      via: "processWebhook function call"
      pattern: "processWebhook\\("
    - from: "src/lib/whatsapp/webhook-handler.ts"
      to: "supabase.from('messages')"
      via: "Database insert"
      pattern: "from\\('messages'\\)"
---

<objective>
Create the WhatsApp infrastructure: database schema for conversations and messages, 360dialog API client for sending messages, and webhook endpoint for receiving messages.

Purpose: Enable the system to communicate with WhatsApp through 360dialog - receiving incoming messages via webhooks and sending outbound messages via API.

Output: Database tables, TypeScript types, API client, webhook handler, and Server Actions.
</objective>

<execution_context>
@/home/jose147/.claude/get-shit-done/workflows/execute-plan.md
@/home/jose147/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-whatsapp-core/07-RESEARCH.md
@.planning/phases/07-whatsapp-core/07-CONTEXT.md

# Existing patterns to follow
@supabase/migrations/20260129000001_contacts_and_tags.sql
@src/app/actions/orders.ts
@src/lib/orders/types.ts
@src/lib/supabase/server.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create database schema for conversations and messages</name>
  <files>supabase/migrations/20260130000002_whatsapp_conversations.sql</files>
  <action>
Create a new migration file with:

1. **conversations table:**
   - id (UUID PK), workspace_id (FK workspaces), contact_id (FK contacts nullable, ON DELETE SET NULL)
   - phone (TEXT NOT NULL, E.164 format), phone_number_id (TEXT NOT NULL, 360dialog phone ID)
   - status (TEXT, CHECK 'active'|'archived', default 'active')
   - is_read (BOOLEAN default false), unread_count (INTEGER default 0)
   - last_customer_message_at (TIMESTAMPTZ, for 24h window calculation)
   - last_message_at (TIMESTAMPTZ), last_message_preview (TEXT)
   - assigned_to (UUID FK auth.users nullable, ON DELETE SET NULL) - for Phase 8 but schema now
   - created_at, updated_at (America/Bogota timezone)
   - UNIQUE(workspace_id, phone)

2. **messages table:**
   - id (UUID PK), conversation_id (FK conversations ON DELETE CASCADE), workspace_id (FK workspaces ON DELETE CASCADE)
   - wamid (TEXT, unique constraint for deduplication)
   - direction (TEXT, CHECK 'inbound'|'outbound')
   - type (TEXT, CHECK 'text'|'image'|'video'|'audio'|'document'|'sticker'|'location'|'contacts'|'template'|'interactive'|'reaction')
   - content (JSONB NOT NULL)
   - status (TEXT, CHECK 'pending'|'sent'|'delivered'|'read'|'failed' for outbound)
   - status_timestamp, error_code, error_message
   - media_url, media_mime_type, media_filename (for stored media)
   - timestamp (TIMESTAMPTZ default America/Bogota NOW()), created_at

3. **Indexes:**
   - idx_conversations_workspace (workspace_id)
   - idx_conversations_phone (workspace_id, phone)
   - idx_conversations_updated (workspace_id, last_message_at DESC)
   - idx_messages_conversation (conversation_id, timestamp DESC)
   - idx_messages_wamid (wamid) WHERE wamid IS NOT NULL

4. **Triggers:**
   - conversations_set_workspace (BEFORE INSERT, use set_workspace_id())
   - conversations_updated_at (BEFORE UPDATE, use update_updated_at_column())
   - messages_set_workspace (BEFORE INSERT, use set_workspace_id())
   - update_conversation_on_message (AFTER INSERT on messages) - updates last_message_at, last_message_preview, unread_count, and last_customer_message_at for inbound

5. **RLS Policies:**
   - conversations: workspace isolation using is_workspace_member()
   - messages: access via parent conversation workspace

6. **Enable Realtime:**
   - ALTER PUBLICATION supabase_realtime ADD TABLE conversations;
   - ALTER PUBLICATION supabase_realtime ADD TABLE messages;

Follow the pattern from 20260129000001_contacts_and_tags.sql for structure and comments.
  </action>
  <verify>
Run `cat supabase/migrations/20260130000002_whatsapp_conversations.sql` and verify:
- Tables have all required columns with correct types
- Unique constraints on (workspace_id, phone) and wamid
- Indexes created for performance
- Trigger for conversation updates exists
- RLS policies for workspace isolation
- Realtime enabled
  </verify>
  <done>
Migration file exists with conversations and messages tables, indexes, triggers, RLS policies, and Realtime enabled.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create WhatsApp TypeScript types</name>
  <files>src/lib/whatsapp/types.ts</files>
  <action>
Create the types file with:

1. **Database types:**
   - Conversation (matches DB schema)
   - Message (matches DB schema)
   - ConversationWithDetails (includes contact, tags, recent orders count)
   - MessageContent (JSONB content structure for each type)

2. **API types:**
   - Send360MessageParams (to, type, content)
   - Send360Response (messages[].id)
   - TextContent ({ body: string })
   - MediaContent ({ id?: string, link?: string, caption?: string })

3. **Webhook types (from RESEARCH.md):**
   - WebhookPayload (object, entry array)
   - WebhookEntry (id, changes array)
   - WebhookChange (value, field)
   - WebhookValue (messaging_product, metadata, contacts, messages, statuses)
   - IncomingMessage (from, id, timestamp, type, text, image, etc.)
   - MessageStatus (id, status, timestamp, recipient_id)

4. **UI types:**
   - ConversationListItem (for inbox display)
   - WindowStatus ('open' | 'closing' | 'closed')

Follow the pattern from src/lib/orders/types.ts with section comments.
  </action>
  <verify>
Run `grep -E "export (type|interface)" src/lib/whatsapp/types.ts` and verify all types are exported.
TypeScript should compile without errors: `cd morfx && npx tsc --noEmit`
  </verify>
  <done>
Types file exists with Conversation, Message, WebhookPayload, and all related interfaces.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create 360dialog API client and webhook handler</name>
  <files>
src/lib/whatsapp/api.ts
src/lib/whatsapp/webhook-handler.ts
src/app/api/webhooks/whatsapp/route.ts
  </files>
  <action>
**api.ts - 360dialog API client:**

1. Constants: BASE_URL = 'https://waba-v2.360dialog.io'

2. sendTextMessage(apiKey, to, text): Promise<Send360Response>
   - POST /messages with messaging_product: 'whatsapp', recipient_type: 'individual', type: 'text', text: { body }
   - Headers: D360-API-KEY, Content-Type: application/json
   - Handle errors, throw with message

3. sendMediaMessage(apiKey, to, type, mediaUrl, caption?): Promise<Send360Response>
   - Similar structure for image/video/document/audio

4. getMediaUrl(apiKey, mediaId): Promise<string>
   - GET /media/{mediaId} to get download URL
   - For downloading incoming media

**webhook-handler.ts - Async processing:**

1. processWebhook(payload: WebhookPayload, workspaceId: string, phoneNumberId: string)
   - Loop through entry.changes
   - Call processIncomingMessage() for each message
   - Call processStatusUpdate() for each status

2. processIncomingMessage(msg: IncomingMessage, metadata, contact, workspaceId):
   - Normalize phone to E.164
   - Find or create conversation (upsert by workspace_id + phone)
   - Link to contact if phone matches (SELECT id FROM contacts WHERE workspace_id AND phone)
   - Insert message with wamid (use ON CONFLICT DO NOTHING for idempotency)
   - Update conversation: last_message_at, last_message_preview, last_customer_message_at, unread_count++
   - Content JSONB: { text: msg.text?.body } for text, { mediaId: msg.image?.id } for media

3. processStatusUpdate(status: MessageStatus):
   - UPDATE messages SET status, status_timestamp WHERE wamid

**route.ts - Webhook endpoint:**

1. GET handler for webhook verification:
   - Return request query param 'hub.challenge' if 'hub.verify_token' matches env var

2. POST handler:
   - Parse JSON body
   - Return 200 immediately (critical for 360dialog timeout)
   - Then process async (in production would use queue, for MVP process inline)
   - Get workspace from workspace_settings by phone_number_id
   - Call processWebhook()

Use createClient from @/lib/supabase/server.
  </action>
  <verify>
Verify files exist and have correct exports:
```bash
grep "export async function" src/lib/whatsapp/api.ts
grep "export async function" src/lib/whatsapp/webhook-handler.ts
grep "export async function" src/app/api/webhooks/whatsapp/route.ts
```
TypeScript compiles: `cd morfx && npx tsc --noEmit`
  </verify>
  <done>
API client can send text/media messages, webhook handler processes incoming messages and status updates, route.ts handles verification and POST webhooks.
  </done>
</task>

<task type="auto">
  <name>Task 4: Create conversation Server Actions</name>
  <files>src/app/actions/conversations.ts</files>
  <action>
Create Server Actions following the pattern from actions/orders.ts:

1. **getConversations(filters?: ConversationFilters):**
   - Get workspace from cookie
   - Query conversations with contact join (name, phone, city, tags)
   - Filters: search (fuzzy on phone/contact name), status, is_read, assigned_to
   - Order by last_message_at DESC
   - Return ConversationWithDetails[]

2. **getConversation(id: string):**
   - Single conversation with full details
   - Include contact info if linked
   - Return ConversationWithDetails | null

3. **markAsRead(id: string):**
   - UPDATE conversations SET is_read = true, unread_count = 0
   - Revalidate path

4. **archiveConversation(id: string):**
   - UPDATE conversations SET status = 'archived'
   - Revalidate path

5. **unarchiveConversation(id: string):**
   - UPDATE conversations SET status = 'active'
   - Revalidate path

6. **linkContactToConversation(conversationId: string, contactId: string):**
   - UPDATE conversations SET contact_id
   - Revalidate path

Use ActionResult<T> pattern from orders.ts. Import types from @/lib/whatsapp/types.
  </action>
  <verify>
```bash
grep "export async function" src/app/actions/conversations.ts
```
Should show: getConversations, getConversation, markAsRead, archiveConversation, unarchiveConversation, linkContactToConversation

TypeScript compiles: `cd morfx && npx tsc --noEmit`
  </verify>
  <done>
Server Actions exist for all conversation operations with workspace isolation and proper typing.
  </done>
</task>

</tasks>

<verification>
1. Migration file has correct schema with all tables, indexes, triggers, RLS
2. Types compile without errors
3. API client has send functions
4. Webhook handler processes messages and statuses
5. Route.ts handles GET verification and POST webhooks
6. Server Actions query conversations correctly

Run: `cd morfx && npx tsc --noEmit` - should pass with no errors
</verification>

<success_criteria>
- [ ] Database migration creates conversations and messages tables
- [ ] Tables have workspace isolation via RLS
- [ ] Messages table has wamid unique constraint for deduplication
- [ ] Trigger updates conversation stats on new message
- [ ] 360dialog API client can send text messages
- [ ] Webhook endpoint returns 200 quickly
- [ ] Incoming messages are stored with contact linking
- [ ] Status updates modify message status
- [ ] Server Actions can query conversations
</success_criteria>

<output>
After completion, create `.planning/phases/07-whatsapp-core/07-01-SUMMARY.md`
</output>
