---
phase: 16.1-engine-unification
plan: 06
type: execute
wave: 4
depends_on: ["16.1-04", "16.1-05"]
files_modified: []
autonomous: false

must_haves:
  truths:
    - "TypeScript compiles with zero errors across entire project"
    - "Sandbox processMessage returns identical SandboxEngineResult shape"
    - "Production processMessage returns identical SomnioEngineResult shape"
    - "Old engines (sandbox-engine.ts, somnio-engine.ts) are preserved as backups"
    - "Changes in flow logic apply automatically to both environments (single source of truth)"
  artifacts: []
  key_links: []
---

<objective>
Verify the engine unification against all 7 success criteria from the roadmap. TypeScript compilation, interface preservation, and behavioral correctness.

Purpose: Final verification that the unification is complete and correct before marking the phase done.
Output: Verification results and any fixes needed.
</objective>

<execution_context>
@/home/jose147/.claude/get-shit-done/workflows/execute-plan.md
@/home/jose147/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/ROADMAP.md
@.planning/phases/16.1-engine-unification/16.1-CONTEXT.md
@.planning/phases/16.1-engine-unification/16.1-04-SUMMARY.md
@.planning/phases/16.1-engine-unification/16.1-05-SUMMARY.md

Key files to verify:
@src/lib/agents/engine/unified-engine.ts
@src/lib/agents/somnio/somnio-agent.ts
@src/app/api/sandbox/process/route.ts
@src/lib/agents/production/webhook-processor.ts
@src/lib/sandbox/sandbox-engine.ts (backup — should still exist)
@src/lib/agents/somnio/somnio-engine.ts (backup — should still exist)
</context>

<tasks>

<task type="auto">
  <name>Task 1: TypeScript compilation and interface verification</name>
  <files></files>
  <action>
Run full TypeScript compilation and verify all interfaces:

1. **Full compilation:**
   ```bash
   npx tsc --noEmit
   ```
   Must pass with zero errors.

2. **Verify SandboxEngineResult shape preserved:**
   - Read `src/app/api/sandbox/process/route.ts`
   - Confirm the response JSON matches `SandboxEngineResult` from `src/lib/sandbox/types.ts`
   - Check fields: success, messages, debugTurn, newState, error, timerSignal

3. **Verify SomnioEngineResult shape preserved:**
   - Read `src/lib/agents/production/webhook-processor.ts`
   - Confirm return type is `Promise<SomnioEngineResult>`
   - Check fields: success, response, messagesSent, orderCreated, orderId, contactId, newMode, tokensUsed, sessionId, error

4. **Verify ProcessMessageInput unchanged:**
   - Read `src/lib/agents/production/webhook-processor.ts`
   - Confirm `ProcessMessageInput` has exact fields: conversationId, contactId, messageContent, workspaceId, phone

5. **Verify agent-production.ts still compiles:**
   - Read `src/inngest/functions/agent-production.ts`
   - Confirm it imports from webhook-processor without issues

6. **Verify old engines preserved as backup:**
   - Confirm `src/lib/sandbox/sandbox-engine.ts` exists
   - Confirm `src/lib/agents/somnio/somnio-engine.ts` exists
   - Neither should be deleted

7. **Verify no circular dependencies:**
   ```bash
   npx tsc --noEmit 2>&1 | grep -i "circular"
   ```
   Should find nothing.

If any issues found: fix them in this task. Small fixes only. If a fix requires more than 20 lines of changes, document and defer.
  </action>
  <verify>`npx tsc --noEmit` exits with code 0. All interface checks pass.</verify>
  <done>TypeScript compiles with zero errors. All external interfaces preserved. Old engines exist as backups.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Engine Unification — single UnifiedEngine with adapter pattern replacing two separate engines (SandboxEngine and SomnioEngine).

New files created:
- `src/lib/agents/engine/types.ts` — 5 adapter interfaces + engine types
- `src/lib/agents/engine/unified-engine.ts` — thin runner class
- `src/lib/agents/engine/index.ts` — barrel exports
- `src/lib/agents/somnio/somnio-agent.ts` — extracted Somnio business logic
- `src/lib/agents/engine-adapters/sandbox/` — 5 sandbox adapters + factory
- `src/lib/agents/engine-adapters/production/` — 5 production adapters + factory

Modified files:
- `src/app/api/sandbox/process/route.ts` — uses UnifiedEngine + sandbox adapters
- `src/lib/agents/production/webhook-processor.ts` — uses UnifiedEngine + production adapters

Backup files preserved (not deleted):
- `src/lib/sandbox/sandbox-engine.ts`
- `src/lib/agents/somnio/somnio-engine.ts`
  </what-built>
  <how-to-verify>
**Test the sandbox (most comprehensive test):**

1. Go to the sandbox at the deployed Vercel URL (/sandbox)
2. Start a new session with Somnio agent
3. Test these flows in order:

**Flow A: Normal conversation**
- Send "hola" → should get greeting response
- Send "cuanto cuesta?" → should get price info
- Check debug panel: intent, tokens, state should all display correctly

**Flow B: Ingest mode**
- Send "quiero comprar" → should transition to collecting_data
- Timer should start (visible in debug panel)
- Send "me llamo Juan Perez, cel 3001234567" → should be SILENT (datos classification)
- Send "cuanto demora?" → should respond normally (pregunta classification)
- Continue sending data until 8 fields complete → should auto-transition to ofrecer_promos

**Flow C: Timer signals**
- Check that timer display shows countdown during collecting_data
- Verify timer re-evaluates when new data arrives
- Verify timer starts promo timer when transitioning to ofrecer_promos

**Flow D: CRM orders (if CRM agents enabled)**
- Enable order-manager in dry-run mode
- Complete a full purchase flow through to compra_confirmada
- Verify [SANDBOX: CRM DRY-RUN] message appears

**What to look for:**
- All responses should be identical to before the unification
- Debug panel should show all tabs correctly (Intent, Tools, State, Tokens, Ingest)
- Timer simulator should work as before
- No errors in browser console
  </how-to-verify>
  <resume-signal>Type "approved" if sandbox works correctly, or describe any issues found</resume-signal>
</task>

</tasks>

<verification>
Phase 16.1 Success Criteria from ROADMAP.md:
1. [x] Un solo processMessage() con la logica de flujo completa → SomnioAgent.processMessage()
2. [x] Adapter pattern para storage, messaging, orders → 5 adapter interfaces with sandbox + production implementations
3. [x] Sandbox usa adapters in-memory — muestra resultado en UI igual que antes → SandboxStorageAdapter, createSandboxAdapters()
4. [x] Produccion usa adapters de DB + WhatsApp — envia mensajes reales → ProductionStorageAdapter, createProductionAdapters()
5. [x] Cambios en la logica del flujo se aplican automaticamente en ambos entornos → Single SomnioAgent class
6. [x] Configuraciones independientes → EngineConfig per-environment
7. [x] webhook-processor.ts sigue funcionando sin cambios en su interfaz externa → ProcessMessageInput + SomnioEngineResult unchanged
</verification>

<success_criteria>
- TypeScript compiles with zero errors
- Sandbox behaves identically to before (user verification)
- webhook-processor.ts external interface unchanged
- Old engines preserved as backups
</success_criteria>

<output>
After completion, create `.planning/phases/16.1-engine-unification/16.1-06-SUMMARY.md`
</output>
