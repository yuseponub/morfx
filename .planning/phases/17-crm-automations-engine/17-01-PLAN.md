---
phase: 17-crm-automations-engine
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/2026MMDD_automations.sql
  - src/lib/automations/types.ts
  - src/lib/automations/constants.ts
autonomous: true

must_haves:
  truths:
    - "Tablas automations y automation_executions existen en la DB con RLS"
    - "TypeScript types cubren toda la estructura de automatizaciones (triggers, conditions, actions)"
    - "Catalogo de triggers, acciones, variables y limites documentado como constantes exportables"
  artifacts:
    - path: "supabase/migrations/2026MMDD_automations.sql"
      provides: "Tables automations + automation_executions with RLS and indexes"
      contains: "CREATE TABLE automations"
    - path: "src/lib/automations/types.ts"
      provides: "Full type system for automations"
      exports: ["Automation", "AutomationAction", "ConditionGroup", "TriggerType", "ActionType"]
    - path: "src/lib/automations/constants.ts"
      provides: "Limits catalog, trigger/action/variable definitions for Phase 18"
      exports: ["MAX_CASCADE_DEPTH", "MAX_ACTIONS_PER_AUTOMATION", "TRIGGER_CATALOG", "ACTION_CATALOG", "VARIABLE_CATALOG"]
  key_links:
    - from: "src/lib/automations/types.ts"
      to: "supabase/migrations/2026MMDD_automations.sql"
      via: "Types mirror DB columns"
      pattern: "trigger_type.*TriggerType"
---

<objective>
Create the database foundation, TypeScript type system, and constants catalog for the CRM Automations Engine.

Purpose: Everything else in Phase 17 depends on these types, tables, and constants. The DB schema stores automation definitions and execution history. The TypeScript types provide compile-time safety for all automation logic. The constants catalog documents all triggers, actions, variables, and limits for Phase 18's AI Builder to read programmatically.

Output: One SQL migration, two TypeScript files.
</objective>

<execution_context>
@/home/jose147/.claude/get-shit-done/workflows/execute-plan.md
@/home/jose147/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/17-crm-automations-engine/17-CONTEXT.md
@.planning/phases/17-crm-automations-engine/17-RESEARCH.md

# Existing patterns to follow
@supabase/migrations/20260129000003_orders_foundation.sql
@src/lib/orders/types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Database migration — automations + automation_executions tables</name>
  <files>supabase/migrations/2026MMDD_automations.sql</files>
  <action>
Create a Supabase migration file with the exact date format matching the project convention (YYYYMMDD prefix).

**Table 1: automations**
```sql
CREATE TABLE automations (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  workspace_id UUID NOT NULL REFERENCES workspaces(id) ON DELETE CASCADE,
  name TEXT NOT NULL,
  description TEXT,
  is_enabled BOOLEAN NOT NULL DEFAULT true,
  trigger_type TEXT NOT NULL,  -- 'order.stage_changed', 'tag.assigned', 'tag.removed', 'contact.created', 'order.created', 'field.changed', 'whatsapp.message_received', 'whatsapp.keyword_match', 'task.completed', 'task.overdue'
  trigger_config JSONB NOT NULL DEFAULT '{}',  -- Pipeline filter, keyword, field name, etc.
  conditions JSONB,  -- ConditionGroup or null (null = always match)
  actions JSONB NOT NULL DEFAULT '[]',  -- AutomationAction[] (sequential)
  created_by UUID REFERENCES auth.users(id) ON DELETE SET NULL,
  created_at TIMESTAMPTZ NOT NULL DEFAULT timezone('America/Bogota', NOW()),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT timezone('America/Bogota', NOW())
);
```

**Table 2: automation_executions**
```sql
CREATE TABLE automation_executions (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  workspace_id UUID NOT NULL REFERENCES workspaces(id) ON DELETE CASCADE,
  automation_id UUID NOT NULL REFERENCES automations(id) ON DELETE CASCADE,
  trigger_event JSONB NOT NULL,  -- Snapshot of the trigger event data
  status TEXT NOT NULL DEFAULT 'running' CHECK (status IN ('running', 'success', 'failed', 'cancelled')),
  actions_log JSONB NOT NULL DEFAULT '[]',  -- [{index, type, status, result, duration_ms, error}]
  error_message TEXT,
  started_at TIMESTAMPTZ NOT NULL DEFAULT timezone('America/Bogota', NOW()),
  completed_at TIMESTAMPTZ,
  duration_ms INTEGER,
  cascade_depth INTEGER NOT NULL DEFAULT 0
);
```

**Indexes:**
- `automations(workspace_id, trigger_type, is_enabled)` — for querying matching automations on trigger
- `automation_executions(workspace_id, automation_id)` — for history lookup
- `automation_executions(workspace_id, started_at DESC)` — for recent executions list
- `automation_executions(status)` WHERE status = 'failed' — partial index for failure monitoring

**RLS policies** (follow existing workspace isolation pattern from orders_foundation.sql):
- `automations`: SELECT/INSERT/UPDATE/DELETE where workspace_id matches user's workspace
- `automation_executions`: SELECT only (executions are created by system, not users)
- Enable RLS on both tables

**Trigger for updated_at:**
- Create `update_automations_updated_at` trigger using the existing `update_updated_at_column()` function (already exists from contacts migration).

**Also add `source_order_id` column to orders table** for connected orders:
```sql
ALTER TABLE orders ADD COLUMN source_order_id UUID REFERENCES orders(id) ON DELETE SET NULL;
CREATE INDEX idx_orders_source_order_id ON orders(source_order_id) WHERE source_order_id IS NOT NULL;
```
Note: The existing `linked_order_id` is for returns. `source_order_id` is for automation-created connected orders (1-to-many: one source can have many derived orders).

Use `timezone('America/Bogota', NOW())` for all timestamps per CLAUDE.md rule.
  </action>
  <verify>Check that the SQL file is valid: look for matching CREATE TABLE, proper FK references, RLS ENABLE, and index statements. Verify both tables have workspace_id FK to workspaces.</verify>
  <done>Migration file exists with automations table, automation_executions table, RLS policies, indexes, updated_at trigger, and source_order_id column on orders.</done>
</task>

<task type="auto">
  <name>Task 2: TypeScript types and constants catalog</name>
  <files>src/lib/automations/types.ts, src/lib/automations/constants.ts</files>
  <action>
**File 1: src/lib/automations/types.ts**

Define the complete type system for automations. Follow the style of src/lib/orders/types.ts.

```typescript
// Trigger types — exhaustive list matching DB CHECK constraint
export type TriggerType =
  | 'order.stage_changed'
  | 'tag.assigned'
  | 'tag.removed'
  | 'contact.created'
  | 'order.created'
  | 'field.changed'
  | 'whatsapp.message_received'
  | 'whatsapp.keyword_match'
  | 'task.completed'
  | 'task.overdue'

// Trigger config per type (discriminated union by trigger_type)
export type TriggerConfig = {
  pipelineId?: string    // For order triggers: filter by specific pipeline
  stageId?: string       // For stage_changed: specific stage
  tagId?: string         // For tag triggers: specific tag
  fieldName?: string     // For field.changed: which field
  keywords?: string[]    // For keyword_match: list of keywords to match
}

// Condition system
export type ConditionOperator =
  | 'equals' | 'not_equals'
  | 'contains' | 'not_contains'
  | 'in' | 'not_in'
  | 'gt' | 'lt' | 'gte' | 'lte'
  | 'exists' | 'not_exists'

export interface Condition {
  field: string           // e.g., 'order.stage_id', 'contact.city', 'order.tags'
  operator: ConditionOperator
  value: unknown
}

export interface ConditionGroup {
  logic: 'AND' | 'OR'
  conditions: (Condition | ConditionGroup)[]
}

// Action types
export type ActionType =
  | 'assign_tag'
  | 'remove_tag'
  | 'change_stage'
  | 'update_field'
  | 'create_order'
  | 'duplicate_order'
  | 'send_whatsapp_template'
  | 'send_whatsapp_text'
  | 'send_whatsapp_media'
  | 'create_task'
  | 'webhook'

// Delay config
export interface DelayConfig {
  amount: number
  unit: 'minutes' | 'hours' | 'days'
}

// Action definition (stored in actions JSONB array)
export interface AutomationAction {
  type: ActionType
  params: Record<string, unknown>  // Type-specific params
  delay?: DelayConfig | null
}

// DB row types
export interface Automation {
  id: string
  workspace_id: string
  name: string
  description: string | null
  is_enabled: boolean
  trigger_type: TriggerType
  trigger_config: TriggerConfig
  conditions: ConditionGroup | null
  actions: AutomationAction[]
  created_by: string | null
  created_at: string
  updated_at: string
}

export interface AutomationExecution {
  id: string
  workspace_id: string
  automation_id: string
  trigger_event: Record<string, unknown>
  status: 'running' | 'success' | 'failed' | 'cancelled'
  actions_log: ActionLog[]
  error_message: string | null
  started_at: string
  completed_at: string | null
  duration_ms: number | null
  cascade_depth: number
}

export interface ActionLog {
  index: number
  type: ActionType
  status: 'success' | 'failed' | 'skipped'
  result?: unknown
  duration_ms: number
  error?: string
}

// Form types for CRUD
export interface AutomationFormData {
  name: string
  description?: string
  trigger_type: TriggerType
  trigger_config: TriggerConfig
  conditions?: ConditionGroup | null
  actions: AutomationAction[]
}

// Trigger context — the data available when a trigger fires
export interface TriggerContext {
  workspaceId: string
  // Order context
  orderId?: string
  orderName?: string
  orderValue?: number
  previousStageId?: string
  previousStageName?: string
  newStageId?: string
  newStageName?: string
  pipelineId?: string
  pipelineName?: string
  // Contact context
  contactId?: string
  contactName?: string
  contactPhone?: string
  contactEmail?: string
  contactCity?: string
  // Tag context
  tagId?: string
  tagName?: string
  // WhatsApp context
  conversationId?: string
  messageContent?: string
  // Task context
  taskId?: string
  taskTitle?: string
  // Generic
  [key: string]: unknown
}
```

**File 2: src/lib/automations/constants.ts**

ZERO imports from other project files (prevents circular deps, per Phase 15.8 pattern).

```typescript
// ============================================================================
// Limits (Phase 18 AI Builder reads these programmatically)
// ============================================================================
export const MAX_CASCADE_DEPTH = 3
export const MAX_ACTIONS_PER_AUTOMATION = 10
export const MAX_AUTOMATIONS_PER_WORKSPACE = 50
export const MAX_DELAY_DAYS = 30
export const WEBHOOK_TIMEOUT_MS = 10_000
export const WEBHOOK_MAX_RETRIES = 3
export const WEBHOOK_RATE_LIMIT_PER_HOUR = 100

// ============================================================================
// Trigger Catalog
// ============================================================================
export const TRIGGER_CATALOG = [
  {
    type: 'order.stage_changed',
    label: 'Orden cambia de etapa',
    category: 'CRM',
    description: 'Se dispara cuando una orden se mueve a otra etapa del pipeline',
    configFields: [
      { name: 'pipelineId', label: 'Pipeline', type: 'select', required: false },
      { name: 'stageId', label: 'Etapa destino', type: 'select', required: false },
    ],
    variables: ['orden.id', 'orden.nombre', 'orden.valor', 'orden.stage_anterior', 'orden.stage_nuevo', 'orden.pipeline', 'contacto.nombre', 'contacto.telefono', 'contacto.ciudad'],
  },
  {
    type: 'tag.assigned',
    label: 'Tag asignado',
    category: 'CRM',
    description: 'Se dispara cuando se asigna un tag a un contacto, orden o conversacion',
    configFields: [
      { name: 'tagId', label: 'Tag especifico', type: 'select', required: false },
    ],
    variables: ['tag.nombre', 'tag.color', 'entidad.tipo', 'entidad.id', 'contacto.nombre', 'contacto.telefono'],
  },
  {
    type: 'tag.removed',
    label: 'Tag removido',
    category: 'CRM',
    description: 'Se dispara cuando se remueve un tag',
    configFields: [
      { name: 'tagId', label: 'Tag especifico', type: 'select', required: false },
    ],
    variables: ['tag.nombre', 'entidad.tipo', 'entidad.id', 'contacto.nombre'],
  },
  {
    type: 'contact.created',
    label: 'Contacto creado',
    category: 'CRM',
    description: 'Se dispara cuando se crea un nuevo contacto',
    configFields: [],
    variables: ['contacto.id', 'contacto.nombre', 'contacto.telefono', 'contacto.email', 'contacto.ciudad'],
  },
  {
    type: 'order.created',
    label: 'Orden creada',
    category: 'CRM',
    description: 'Se dispara cuando se crea una nueva orden',
    configFields: [
      { name: 'pipelineId', label: 'Pipeline', type: 'select', required: false },
    ],
    variables: ['orden.id', 'orden.valor', 'orden.pipeline', 'orden.stage', 'contacto.nombre', 'contacto.telefono'],
  },
  {
    type: 'field.changed',
    label: 'Campo cambia de valor',
    category: 'CRM',
    description: 'Se dispara cuando un campo especifico de contacto u orden cambia',
    configFields: [
      { name: 'fieldName', label: 'Campo', type: 'text', required: true },
    ],
    variables: ['campo.nombre', 'campo.valor_anterior', 'campo.valor_nuevo', 'entidad.tipo', 'entidad.id'],
  },
  {
    type: 'whatsapp.message_received',
    label: 'Mensaje de WhatsApp recibido',
    category: 'WhatsApp',
    description: 'Se dispara con cualquier mensaje entrante de WhatsApp',
    configFields: [],
    variables: ['mensaje.contenido', 'mensaje.telefono', 'conversacion.id', 'contacto.nombre', 'contacto.telefono'],
  },
  {
    type: 'whatsapp.keyword_match',
    label: 'Palabra clave en WhatsApp',
    category: 'WhatsApp',
    description: 'Se dispara cuando un mensaje contiene palabras clave especificas',
    configFields: [
      { name: 'keywords', label: 'Palabras clave', type: 'tags', required: true },
    ],
    variables: ['mensaje.contenido', 'mensaje.keyword_matched', 'mensaje.telefono', 'contacto.nombre'],
  },
  {
    type: 'task.completed',
    label: 'Tarea completada',
    category: 'Tareas',
    description: 'Se dispara cuando una tarea se marca como completada',
    configFields: [],
    variables: ['tarea.id', 'tarea.titulo', 'tarea.descripcion', 'contacto.nombre', 'orden.id'],
  },
  {
    type: 'task.overdue',
    label: 'Tarea vencida',
    category: 'Tareas',
    description: 'Se dispara cuando una tarea pasa su fecha limite sin completarse',
    configFields: [],
    variables: ['tarea.id', 'tarea.titulo', 'tarea.fecha_limite', 'contacto.nombre', 'orden.id'],
  },
] as const

// ============================================================================
// Action Catalog
// ============================================================================
export const ACTION_CATALOG = [
  {
    type: 'assign_tag',
    label: 'Asignar tag',
    category: 'CRM',
    description: 'Asigna un tag a un contacto u orden',
    params: [
      { name: 'tagName', label: 'Tag', type: 'select', required: true },
      { name: 'entityType', label: 'Tipo de entidad', type: 'select', options: ['contact', 'order'], required: false },
    ],
  },
  {
    type: 'remove_tag',
    label: 'Remover tag',
    category: 'CRM',
    params: [
      { name: 'tagName', label: 'Tag', type: 'select', required: true },
    ],
  },
  {
    type: 'change_stage',
    label: 'Cambiar etapa',
    category: 'CRM',
    params: [
      { name: 'pipelineId', label: 'Pipeline', type: 'select', required: true },
      { name: 'stageId', label: 'Etapa destino', type: 'select', required: true },
    ],
  },
  {
    type: 'update_field',
    label: 'Actualizar campo',
    category: 'CRM',
    params: [
      { name: 'fieldName', label: 'Campo', type: 'text', required: true },
      { name: 'value', label: 'Valor', type: 'text', required: true },
    ],
  },
  {
    type: 'create_order',
    label: 'Crear orden',
    category: 'Ordenes',
    params: [
      { name: 'pipelineId', label: 'Pipeline', type: 'select', required: true },
      { name: 'stageId', label: 'Etapa', type: 'select', required: false },
      { name: 'copyProducts', label: 'Copiar productos', type: 'boolean', required: false },
      { name: 'copyTags', label: 'Copiar tags', type: 'boolean', required: false },
    ],
  },
  {
    type: 'duplicate_order',
    label: 'Duplicar orden a otro pipeline',
    category: 'Ordenes',
    description: 'Crea una copia de la orden en otro pipeline con source_order_id para referencia bidireccional',
    params: [
      { name: 'targetPipelineId', label: 'Pipeline destino', type: 'select', required: true },
      { name: 'targetStageId', label: 'Etapa destino', type: 'select', required: false },
      { name: 'copyContact', label: 'Copiar contacto', type: 'boolean', required: false },
      { name: 'copyProducts', label: 'Copiar productos', type: 'boolean', required: false },
      { name: 'copyValue', label: 'Copiar valor', type: 'boolean', required: false },
      { name: 'copyTags', label: 'Copiar tags', type: 'boolean', required: false },
    ],
  },
  {
    type: 'send_whatsapp_template',
    label: 'Enviar template WhatsApp',
    category: 'WhatsApp',
    params: [
      { name: 'templateName', label: 'Template', type: 'select', required: true },
      { name: 'variables', label: 'Variables', type: 'key_value', required: false },
    ],
  },
  {
    type: 'send_whatsapp_text',
    label: 'Enviar texto WhatsApp',
    category: 'WhatsApp',
    params: [
      { name: 'text', label: 'Mensaje', type: 'textarea', required: true, supportsVariables: true },
    ],
  },
  {
    type: 'send_whatsapp_media',
    label: 'Enviar media WhatsApp',
    category: 'WhatsApp',
    params: [
      { name: 'mediaUrl', label: 'URL del archivo', type: 'text', required: true },
      { name: 'caption', label: 'Texto', type: 'text', required: false, supportsVariables: true },
    ],
  },
  {
    type: 'create_task',
    label: 'Crear tarea',
    category: 'Tareas',
    params: [
      { name: 'title', label: 'Titulo', type: 'text', required: true, supportsVariables: true },
      { name: 'description', label: 'Descripcion', type: 'textarea', required: false, supportsVariables: true },
      { name: 'dueDateRelative', label: 'Fecha limite (relativa)', type: 'delay', required: false },
      { name: 'assignToUserId', label: 'Asignar a', type: 'select', required: false },
    ],
  },
  {
    type: 'webhook',
    label: 'Webhook saliente',
    category: 'Integraciones',
    description: 'Envia POST a URL externa con datos del trigger',
    params: [
      { name: 'url', label: 'URL', type: 'text', required: true },
      { name: 'headers', label: 'Headers', type: 'key_value', required: false },
      { name: 'payloadTemplate', label: 'Payload JSON', type: 'json', required: false, supportsVariables: true },
    ],
  },
] as const

// ============================================================================
// Variable Catalog (per trigger type)
// ============================================================================
export const VARIABLE_CATALOG = {
  'order.stage_changed': [
    { path: 'orden.id', label: 'ID de la orden' },
    { path: 'orden.valor', label: 'Valor total' },
    { path: 'orden.stage_anterior', label: 'Etapa anterior' },
    { path: 'orden.stage_nuevo', label: 'Etapa nueva' },
    { path: 'orden.pipeline', label: 'Pipeline' },
    { path: 'contacto.nombre', label: 'Nombre del contacto' },
    { path: 'contacto.telefono', label: 'Telefono del contacto' },
    { path: 'contacto.email', label: 'Email del contacto' },
    { path: 'contacto.ciudad', label: 'Ciudad del contacto' },
  ],
  'tag.assigned': [
    { path: 'tag.nombre', label: 'Nombre del tag' },
    { path: 'entidad.tipo', label: 'Tipo de entidad (contact/order)' },
    { path: 'entidad.id', label: 'ID de la entidad' },
    { path: 'contacto.nombre', label: 'Nombre del contacto' },
    { path: 'contacto.telefono', label: 'Telefono del contacto' },
  ],
  'tag.removed': [
    { path: 'tag.nombre', label: 'Nombre del tag' },
    { path: 'entidad.tipo', label: 'Tipo de entidad' },
    { path: 'entidad.id', label: 'ID de la entidad' },
    { path: 'contacto.nombre', label: 'Nombre del contacto' },
  ],
  'contact.created': [
    { path: 'contacto.id', label: 'ID del contacto' },
    { path: 'contacto.nombre', label: 'Nombre' },
    { path: 'contacto.telefono', label: 'Telefono' },
    { path: 'contacto.email', label: 'Email' },
    { path: 'contacto.ciudad', label: 'Ciudad' },
  ],
  'order.created': [
    { path: 'orden.id', label: 'ID de la orden' },
    { path: 'orden.valor', label: 'Valor total' },
    { path: 'orden.pipeline', label: 'Pipeline' },
    { path: 'orden.stage', label: 'Etapa' },
    { path: 'contacto.nombre', label: 'Nombre del contacto' },
    { path: 'contacto.telefono', label: 'Telefono del contacto' },
  ],
  'field.changed': [
    { path: 'campo.nombre', label: 'Nombre del campo' },
    { path: 'campo.valor_anterior', label: 'Valor anterior' },
    { path: 'campo.valor_nuevo', label: 'Valor nuevo' },
    { path: 'entidad.tipo', label: 'Tipo de entidad' },
    { path: 'entidad.id', label: 'ID de la entidad' },
  ],
  'whatsapp.message_received': [
    { path: 'mensaje.contenido', label: 'Contenido del mensaje' },
    { path: 'mensaje.telefono', label: 'Telefono del remitente' },
    { path: 'conversacion.id', label: 'ID de la conversacion' },
    { path: 'contacto.nombre', label: 'Nombre del contacto' },
    { path: 'contacto.telefono', label: 'Telefono del contacto' },
  ],
  'whatsapp.keyword_match': [
    { path: 'mensaje.contenido', label: 'Contenido del mensaje' },
    { path: 'mensaje.keyword_matched', label: 'Keyword que matcheo' },
    { path: 'mensaje.telefono', label: 'Telefono' },
    { path: 'contacto.nombre', label: 'Nombre del contacto' },
  ],
  'task.completed': [
    { path: 'tarea.id', label: 'ID de la tarea' },
    { path: 'tarea.titulo', label: 'Titulo' },
    { path: 'tarea.descripcion', label: 'Descripcion' },
    { path: 'contacto.nombre', label: 'Nombre del contacto' },
    { path: 'orden.id', label: 'ID de la orden' },
  ],
  'task.overdue': [
    { path: 'tarea.id', label: 'ID de la tarea' },
    { path: 'tarea.titulo', label: 'Titulo' },
    { path: 'tarea.fecha_limite', label: 'Fecha limite' },
    { path: 'contacto.nombre', label: 'Nombre del contacto' },
    { path: 'orden.id', label: 'ID de la orden' },
  ],
} as const

// ============================================================================
// Delay limits
// ============================================================================
export const DELAY_LIMITS = {
  minutes: { min: 1, max: 60 * 24 * MAX_DELAY_DAYS },
  hours: { min: 1, max: 24 * MAX_DELAY_DAYS },
  days: { min: 1, max: MAX_DELAY_DAYS },
} as const

// ============================================================================
// Helper: Convert delay to milliseconds
// ============================================================================
export function delayToMs(delay: { amount: number; unit: 'minutes' | 'hours' | 'days' }): number {
  const multipliers = { minutes: 60_000, hours: 3_600_000, days: 86_400_000 }
  return delay.amount * multipliers[delay.unit]
}
```

Ensure constants.ts has ZERO imports from other project files (prevents circular deps). Types can be defined inline.
  </action>
  <verify>Both files export the expected types and constants. Run `npx tsc --noEmit src/lib/automations/types.ts src/lib/automations/constants.ts` to verify no TypeScript errors (may need to check that types.ts compiles standalone).</verify>
  <done>types.ts exports all type definitions. constants.ts exports catalogs and limits with zero project imports. Both compile without errors.</done>
</task>

</tasks>

<verification>
1. Migration SQL has valid CREATE TABLE for automations and automation_executions
2. RLS policies enabled on both tables
3. source_order_id column added to orders table
4. types.ts exports: TriggerType, ActionType, ConditionGroup, Condition, AutomationAction, Automation, AutomationExecution, TriggerContext
5. constants.ts exports: MAX_CASCADE_DEPTH, TRIGGER_CATALOG, ACTION_CATALOG, VARIABLE_CATALOG with zero imports
6. TypeScript compiles without errors
</verification>

<success_criteria>
- Both DB tables are defined with proper FK references, RLS, and indexes
- TypeScript type system covers all trigger types, action types, conditions, and execution logs
- Constants catalog is self-contained (zero imports) and documents all triggers/actions/variables/limits
- source_order_id column exists on orders table for connected orders
</success_criteria>

<output>
After completion, create `.planning/phases/17-crm-automations-engine/17-01-SUMMARY.md`
</output>
