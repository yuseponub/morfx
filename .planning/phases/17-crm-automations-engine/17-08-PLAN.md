---
phase: 17-crm-automations-engine
plan: 08
type: execute
wave: 5
depends_on: ["17-03", "17-05"]
files_modified:
  - src/app/(dashboard)/automatizaciones/page.tsx
  - src/app/(dashboard)/automatizaciones/components/automation-list.tsx
  - src/app/(dashboard)/automatizaciones/historial/page.tsx
  - src/app/(dashboard)/automatizaciones/components/execution-history.tsx
  - src/app/(dashboard)/automatizaciones/components/execution-detail-dialog.tsx
  - src/components/layout/sidebar.tsx
  - src/components/layout/mobile-nav.tsx
autonomous: true

must_haves:
  truths:
    - "Automation list page shows all automations with enable/disable toggle"
    - "Each automation card shows trigger type, action count, last execution status"
    - "Execution history page shows paginated list of executions with filters"
    - "Execution detail dialog shows per-action results with duration"
    - "Sidebar has Automatizaciones link with failure badge"
    - "Duplicate button creates a copy of an automation"
  artifacts:
    - path: "src/app/(dashboard)/automatizaciones/page.tsx"
      provides: "Main automations list page"
    - path: "src/app/(dashboard)/automatizaciones/components/automation-list.tsx"
      provides: "Automation list with toggle, duplicate, delete"
    - path: "src/app/(dashboard)/automatizaciones/historial/page.tsx"
      provides: "Execution history page"
    - path: "src/app/(dashboard)/automatizaciones/components/execution-history.tsx"
      provides: "Paginated execution list component"
    - path: "src/components/layout/sidebar.tsx"
      provides: "Sidebar with Automatizaciones link"
  key_links:
    - from: "src/app/(dashboard)/automatizaciones/page.tsx"
      to: "src/app/actions/automations.ts"
      via: "getAutomations server action"
      pattern: "getAutomations"
    - from: "src/app/(dashboard)/automatizaciones/historial/page.tsx"
      to: "src/app/actions/automations.ts"
      via: "getExecutionHistory server action"
      pattern: "getExecutionHistory"
    - from: "src/components/layout/sidebar.tsx"
      to: "src/app/actions/automations.ts"
      via: "getRecentFailures for badge count"
      pattern: "getRecentFailures"
---

<objective>
Build the automation list page, execution history page, and wire sidebar navigation with failure badge.

Purpose: Users need to see all their automations at a glance with enable/disable toggles, navigate to the builder to create/edit, view execution history for debugging, and see a badge in the sidebar when automations fail. This completes the user-facing management UI.

Output: List page, history page, detail dialog, sidebar integration.
</objective>

<execution_context>
@/home/jose147/.claude/get-shit-done/workflows/execute-plan.md
@/home/jose147/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/17-crm-automations-engine/17-CONTEXT.md
@src/app/actions/automations.ts
@src/lib/automations/types.ts
@src/lib/automations/constants.ts
@src/components/layout/sidebar.tsx

# Pattern to follow for list pages
@src/app/(dashboard)/tareas/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Automation list page with toggle, duplicate, and delete</name>
  <files>
    src/app/(dashboard)/automatizaciones/page.tsx,
    src/app/(dashboard)/automatizaciones/components/automation-list.tsx
  </files>
  <action>
**File 1: page.tsx**
Server component. Main automations page.

```typescript
import { getAutomations } from '@/app/actions/automations'
import { AutomationList } from './components/automation-list'

export default async function AutomatizacionesPage() {
  const automations = await getAutomations()
  // Return error state if automations fetch fails
  return (
    <div className="p-6 space-y-6">
      <div className="flex items-center justify-between">
        <div>
          <h1 className="text-2xl font-bold">Automatizaciones</h1>
          <p className="text-muted-foreground">Reglas trigger + condiciones + acciones</p>
        </div>
        <div className="flex items-center gap-2">
          <Link href="/automatizaciones/historial">
            <Button variant="outline" size="sm">
              <History className="h-4 w-4 mr-2" />
              Historial
            </Button>
          </Link>
          <Link href="/automatizaciones/nueva">
            <Button>
              <Plus className="h-4 w-4 mr-2" />
              Nueva automatizacion
            </Button>
          </Link>
        </div>
      </div>
      <AutomationList automations={automations} />
    </div>
  )
}
```

**File 2: automation-list.tsx**
'use client' component.

Features:
- Search/filter bar (text search on name, filter by trigger category: CRM/WhatsApp/Tareas)
- Grid or list of automation cards, each showing:
  - Name (bold) and description (muted)
  - Trigger type badge (from TRIGGER_CATALOG label, colored by category)
  - Action count badge (e.g., "3 acciones")
  - Last execution status (success/failed/never) with relative time
  - Enable/disable Switch toggle (calls `toggleAutomation` server action)
  - Dropdown menu (three dots) with: Editar, Duplicar, Eliminar
- Editar: Link to `/automatizaciones/{id}/editar`
- Duplicar: calls `duplicateAutomation` server action, then `router.refresh()`
- Eliminar: confirmation dialog, then `deleteAutomation` server action
- Empty state: illustration + "Crea tu primera automatizacion" with button

Use shadcn components: Card, Switch, Badge, Button, DropdownMenu, AlertDialog (for delete confirmation), Input (for search).

Use TRIGGER_CATALOG from constants.ts to map trigger types to display labels and category colors:
- CRM category: blue badges
- WhatsApp category: green badges
- Tareas category: yellow badges

**Toggle implementation:**
```typescript
const handleToggle = async (id: string) => {
  await toggleAutomation(id)
  router.refresh()
}
```

**Duplicate implementation:**
```typescript
const handleDuplicate = async (id: string) => {
  await duplicateAutomation(id)
  router.refresh()
}
```
  </action>
  <verify>List page renders all automations. Toggle switch calls toggleAutomation. Duplicate creates copy. Delete with confirmation. Search filters by name. Category filter works. Empty state shown when no automations. TypeScript compiles.</verify>
  <done>Automation list page with search, category filters, enable/disable toggle, duplicate, delete, and empty state.</done>
</task>

<task type="auto">
  <name>Task 2: Execution history page and sidebar navigation</name>
  <files>
    src/app/(dashboard)/automatizaciones/historial/page.tsx,
    src/app/(dashboard)/automatizaciones/components/execution-history.tsx,
    src/app/(dashboard)/automatizaciones/components/execution-detail-dialog.tsx,
    src/components/layout/sidebar.tsx,
    src/components/layout/mobile-nav.tsx
  </files>
  <action>
**File 1: historial/page.tsx**
Server component. Execution history page.

```typescript
import { getExecutionHistory } from '@/app/actions/automations'
import { ExecutionHistory } from '../components/execution-history'

export default async function HistorialPage({
  searchParams,
}: {
  searchParams: { page?: string; status?: string; automationId?: string }
}) {
  const result = await getExecutionHistory({
    page: Number(searchParams.page) || 1,
    status: searchParams.status,
    automationId: searchParams.automationId,
  })
  return (
    <div className="p-6 space-y-6">
      <div className="flex items-center justify-between">
        <h1 className="text-2xl font-bold">Historial de ejecuciones</h1>
        <Link href="/automatizaciones">
          <Button variant="outline" size="sm">
            <ArrowLeft className="h-4 w-4 mr-2" />
            Automatizaciones
          </Button>
        </Link>
      </div>
      <ExecutionHistory data={result.data} total={result.total} page={result.page} pageSize={result.pageSize} />
    </div>
  )
}
```

**File 2: execution-history.tsx**
'use client' component. Paginated execution list.

Features:
- Filter bar: status dropdown (all, success, failed, cancelled), automation name dropdown
- Table with columns: Fecha, Automatizacion, Trigger, Estado, Duracion, Acciones
- Status badges: success=green, failed=red, running=yellow, cancelled=gray
- Duration in human-readable format (ms -> "1.2s", "2m 30s")
- Click row -> open ExecutionDetailDialog
- Pagination controls at bottom (Anterior/Siguiente + page indicator)
- URL-based pagination using searchParams and router.push

**File 3: execution-detail-dialog.tsx**
'use client' component. Modal dialog showing full execution detail.

Shows:
- Automation name and trigger type
- Trigger event data (formatted JSON, collapsible)
- Cascade depth indicator (if > 0)
- Per-action timeline:
  - Each action as a row: index, type label, status badge, duration, result/error
  - Failed actions highlighted in red with error message
  - Skipped actions (after failure) shown as gray
- Total duration
- Close button

Use shadcn Dialog component.

**File 4: sidebar.tsx**
Add Automatizaciones nav item to the `navItems` array. Use `Zap` icon from lucide-react (represents automation/lightning).

```typescript
import { Zap } from 'lucide-react'

// Add to navItems array, between Agentes and Equipo:
{
  href: '/automatizaciones',
  label: 'Automatizaciones',
  icon: Zap,
  hasBadge: true,  // For failure count badge
}
```

For the badge: create a `useAutomationBadge` hook (similar to `useTaskBadge`) that calls `getRecentFailures()` server action to get failure count. If count > 0, show red badge with count. The hook can poll every 60 seconds or use a simple interval.

Alternatively, for simplicity, the badge can be loaded in the sidebar server component's data fetching. Since sidebar data is fetched in the layout, add `getRecentFailures()` to the layout data loading and pass it as a prop.

**SIMPLEST APPROACH:** Add the badge count inline in sidebar using the same pattern as `useTaskBadge`. Create a simple `useAutomationBadge` hook in `src/hooks/use-automation-badge.ts` that returns the failure count.

**File 5: mobile-nav.tsx**
Add the same Automatizaciones nav item to the mobile navigation, matching the sidebar structure.
  </action>
  <verify>History page renders with pagination. Filter by status and automation works. Click row shows detail dialog. Per-action timeline renders. Sidebar shows Automatizaciones link with Zap icon. Badge shows failure count. Mobile nav has the link. TypeScript compiles.</verify>
  <done>Execution history page with pagination and filters, detail dialog with per-action timeline, sidebar navigation with Zap icon and failure badge, and mobile nav support.</done>
</task>

</tasks>

<verification>
1. Automation list page shows all automations with toggle/duplicate/delete
2. Search and category filter work
3. Empty state shown when no automations
4. History page shows paginated executions with status/duration
5. Execution detail dialog shows per-action results
6. Sidebar has Automatizaciones link with failure badge
7. Mobile nav includes Automatizaciones
8. TypeScript compiles without errors
</verification>

<success_criteria>
- Full automation management UI: list, toggle, duplicate, delete
- Full execution history: list with pagination, filters, detail dialog
- Sidebar integration with failure badge
- Mobile navigation support
</success_criteria>

<output>
After completion, create `.planning/phases/17-crm-automations-engine/17-08-SUMMARY.md`
</output>
