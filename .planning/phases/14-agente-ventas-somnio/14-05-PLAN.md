---
phase: 14-agente-ventas-somnio
plan: 05
type: execute
wave: 4
depends_on: ["14-01", "14-02", "14-03", "14-04"]
files_modified:
  - src/lib/agents/somnio/somnio-orchestrator.ts
  - src/lib/agents/somnio/transition-validator.ts
  - src/lib/agents/somnio/index.ts
autonomous: true

must_haves:
  truths:
    - "resumen_* intents require ofrecer_promos seen first"
    - "compra_confirmada requires resumen_* seen first"
    - "ofrecer_promos auto-triggers when 8 fields complete"
    - "ofrecer_promos via timer when 5 critical fields + 2min inactive"
    - "Mode transitions follow defined state machine"
    - "Data extraction runs in collecting_data mode"
    - "compra_confirmada intent triggers order creation flow"
  artifacts:
    - path: "src/lib/agents/somnio/somnio-orchestrator.ts"
      provides: "SomnioOrchestrator extending base Orchestrator with Somnio-specific logic"
      exports: ["SomnioOrchestrator"]
    - path: "src/lib/agents/somnio/transition-validator.ts"
      provides: "Validation logic for intent transitions and mode changes"
      exports: ["TransitionValidator", "validateTransition"]
  key_links:
    - from: "src/lib/agents/somnio/somnio-orchestrator.ts"
      to: "src/lib/agents/somnio/data-extractor.ts"
      via: "DataExtractor for collecting_data mode"
      pattern: "dataExtractor\\.extract"
    - from: "src/lib/agents/somnio/somnio-orchestrator.ts"
      to: "src/lib/agents/somnio/template-manager.ts"
      via: "TemplateManager for response templates"
      pattern: "templateManager\\.getTemplatesForIntent"
    - from: "src/lib/agents/somnio/somnio-orchestrator.ts"
      to: "OrderCreator (via SomnioEngine)"
      via: "compra_confirmada triggers crm.order.create"
      pattern: "compra_confirmada.*order"
---

<objective>
Create the Somnio Orchestrator that implements the specific flow logic for the Somnio sales agent, including transition validation, data extraction triggering, and auto-triggers for ofrecer_promos.

Purpose: This is the brain of the Somnio agent - it decides what to do based on intent, current state, captured data, and transition rules from CONTEXT.md.

Output: SomnioOrchestrator class, TransitionValidator utility, ready for integration with AgentEngine.
</objective>

<execution_context>
@/home/jose147/.claude/get-shit-done/workflows/execute-plan.md
@/home/jose147/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/14-agente-ventas-somnio/14-CONTEXT.md
@.planning/phases/14-agente-ventas-somnio/14-01-SUMMARY.md
@.planning/phases/14-agente-ventas-somnio/14-02-SUMMARY.md
@.planning/phases/14-agente-ventas-somnio/14-03-SUMMARY.md
@.planning/phases/14-agente-ventas-somnio/14-04-SUMMARY.md
@src/lib/agents/orchestrator.ts
@src/lib/agents/somnio/config.ts
@src/lib/agents/somnio/intents.ts
@src/lib/agents/somnio/template-manager.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Transition Validator</name>
  <files>
    src/lib/agents/somnio/transition-validator.ts
  </files>
  <action>
Create src/lib/agents/somnio/transition-validator.ts:

1. TransitionRule interface:
```typescript
interface TransitionRule {
  intent: string
  requiredIntents?: string[] // Must have seen these intents first
  requiredMode?: string // Must be in this mode
  requiredFields?: string[] // Must have these data fields
  minFields?: number // Minimum fields captured
}
```

2. TransitionResult interface:
```typescript
interface TransitionResult {
  allowed: boolean
  reason?: string
  suggestedIntent?: string // If blocked, suggest alternative
  autoTrigger?: string // Intent that should auto-trigger
}
```

3. TRANSITION_RULES constant (from CONTEXT.md):
```typescript
const TRANSITION_RULES: TransitionRule[] = [
  // resumen_* requires ofrecer_promos
  { intent: 'resumen_1x', requiredIntents: ['ofrecer_promos'] },
  { intent: 'resumen_2x', requiredIntents: ['ofrecer_promos'] },
  { intent: 'resumen_3x', requiredIntents: ['ofrecer_promos'] },
  // compra_confirmada requires a resumen
  { intent: 'compra_confirmada', requiredIntents: ['resumen_1x', 'resumen_2x', 'resumen_3x'] },
  // ofrecer_promos auto-triggers
  { intent: 'ofrecer_promos', minFields: 8 },
]
```

4. TransitionValidator class:
```typescript
export class TransitionValidator {
  validateTransition(
    intent: string,
    intentsVistos: IntentRecord[],
    currentMode: string,
    datosCapturados: Record<string, string>
  ): TransitionResult

  checkAutoTriggers(
    intentsVistos: IntentRecord[],
    datosCapturados: Record<string, string>
  ): string | null // Returns intent to auto-trigger, or null

  private hasSeenIntent(intent: string, intentsVistos: IntentRecord[]): boolean
  private hasSeenAnyIntent(intents: string[], intentsVistos: IntentRecord[]): boolean
  private countFields(datos: Record<string, string>): number
  private hasCriticalFields(datos: Record<string, string>): boolean
}
```

5. Implementation details:
   - validateTransition:
     - Check requiredIntents: All must be in intentsVistos
     - Check requiredMode: currentMode must match
     - Check requiredFields: All must be in datosCapturados
     - Check minFields: countFields >= minFields
     - Return allowed: true/false with reason
   - checkAutoTriggers:
     - If 8 fields complete and ofrecer_promos not seen -> return 'ofrecer_promos'
     - Return null if no auto-trigger needed
   - CRITICAL_FIELDS = ['nombre', 'telefono', 'direccion', 'ciudad', 'departamento']
   - countFields counts non-empty, non-N/A values
  </action>
  <verify>
```bash
cd /mnt/c/Users/Usuario/Proyectos/morfx-new && npx tsc --noEmit
```
TypeScript compiles. Transition rules match CONTEXT.md.
  </verify>
  <done>
TransitionValidator component created that:
- Validates intent transitions based on required preconditions
- Blocks resumen_* without ofrecer_promos
- Blocks compra_confirmada without resumen
- Detects auto-trigger for ofrecer_promos at 8 fields
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Somnio Orchestrator</name>
  <files>
    src/lib/agents/somnio/somnio-orchestrator.ts
    src/lib/agents/somnio/index.ts
  </files>
  <action>
Create src/lib/agents/somnio/somnio-orchestrator.ts:

1. SomnioOrchestratorResult interface:
```typescript
interface SomnioOrchestratorResult {
  action: OrchestratorAction
  intent: string
  response?: string
  templates?: ProcessedTemplate[]
  toolCalls?: ToolCallRequest[]
  nextMode?: string
  stateUpdates?: {
    intentsVistos?: string[]
    templatesSent?: string[]
    datosCapturados?: Record<string, string>
    packSeleccionado?: PackSelection
  }
  shouldExtractData?: boolean
  extractedData?: ExtractedData
  // Flag for compra_confirmada to signal order creation
  shouldCreateOrder?: boolean
}
```

2. SomnioOrchestrator class:
```typescript
export class SomnioOrchestrator {
  private baseOrchestrator: Orchestrator
  private dataExtractor: DataExtractor
  private templateManager: TemplateManager
  private transitionValidator: TransitionValidator

  constructor(
    claudeClient: ClaudeClient,
    options?: {
      dataExtractor?: DataExtractor
      templateManager?: TemplateManager
      transitionValidator?: TransitionValidator
    }
  )

  async orchestrate(
    intent: IntentResult,
    session: AgentSessionWithState,
    message: string,
    history: ClaudeMessage[]
  ): Promise<SomnioOrchestratorResult>

  private async handleCollectingDataMode(
    session: AgentSessionWithState,
    message: string,
    history: ClaudeMessage[]
  ): Promise<{ extracted: ExtractedData; nextMode?: string }>

  private async selectTemplates(
    intent: string,
    session: AgentSessionWithState
  ): Promise<ProcessedTemplate[]>

  private determineNextMode(
    intent: string,
    currentMode: string,
    datosCapturados: Record<string, string>
  ): string | null

  private detectPackSelection(
    message: string,
    intent: string
  ): PackSelection | null
}
```

3. Implementation flow:
   - orchestrate:
     1. Validate transition with TransitionValidator
     2. If blocked, return clarification response
     3. Check auto-triggers (ofrecer_promos)
     4. If in collecting_data mode, run DataExtractor
     5. Select templates via TemplateManager
     6. Determine next mode based on intent and data
     7. Build tool calls if needed (crm.contact.create, etc.)
     8. **CRITICAL: On compra_confirmada intent, set shouldCreateOrder=true**
        - This signals SomnioEngine to invoke OrderCreator
        - The crm.order.create tool call is generated in response
     9. Return full result

4. Mode logic:
   - 'conversacion' -> 'collecting_data' on captura_datos_si_compra
   - 'collecting_data' -> 'ofrecer_promos' on 8 fields complete
   - 'ofrecer_promos' -> 'resumen' on resumen_* intent
   - 'resumen' -> 'confirmado' on compra_confirmada
   - Any mode -> 'handoff' on fallback intent

5. Pack detection:
   - "quiero el 2x", "dame el de 2", "el combo de 2" -> '2x'
   - Similar for 1x and 3x
   - Store in packSeleccionado

6. Tool call generation:
   - collecting_data + minimum data -> crm.contact.create or crm.contact.update
   - **compra_confirmada -> shouldCreateOrder=true (triggers OrderCreator in SomnioEngine)**
   - Any response -> whatsapp.message.send (via MessageSequencer)

Update src/lib/agents/somnio/index.ts:
- Export SomnioOrchestrator, SomnioOrchestratorResult
- Export TransitionValidator, TransitionResult
  </action>
  <verify>
```bash
cd /mnt/c/Users/Usuario/Proyectos/morfx-new && npx tsc --noEmit
```
TypeScript compiles. SomnioOrchestrator integrates all components.
  </verify>
  <done>
SomnioOrchestrator component created that:
- Validates transitions with rules from CONTEXT.md
- Extracts data in collecting_data mode
- Auto-triggers ofrecer_promos at 8 fields
- Selects templates for intent
- Determines next mode based on flow
- **Signals shouldCreateOrder on compra_confirmada for OrderCreator integration**
- Generates tool calls for CRM and WhatsApp
  </done>
</task>

</tasks>

<verification>
1. TransitionValidator blocks invalid transitions
2. resumen_* blocked without ofrecer_promos
3. ofrecer_promos auto-triggers at 8 complete fields
4. SomnioOrchestrator uses DataExtractor in collecting_data mode
5. Templates selected based on intent and visit type
6. Pack detection works for "quiero el 2x" patterns
7. compra_confirmada sets shouldCreateOrder flag
8. TypeScript compiles without errors
</verification>

<success_criteria>
- Transition rules enforced per CONTEXT.md
- Auto-trigger for ofrecer_promos works
- Mode transitions follow state machine
- DataExtractor integration in collecting_data mode
- TemplateManager integration for responses
- compra_confirmada triggers shouldCreateOrder for OrderCreator
- Tool calls generated for CRM operations
</success_criteria>

<output>
After completion, create `.planning/phases/14-agente-ventas-somnio/14-05-SUMMARY.md`
</output>
