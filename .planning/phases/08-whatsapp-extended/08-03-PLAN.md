---
phase: 08-whatsapp-extended
plan: 03
type: execute
wave: 2
depends_on: ["08-01"]
files_modified:
  - src/app/(dashboard)/configuracion/whatsapp/page.tsx
  - src/app/(dashboard)/configuracion/whatsapp/templates/page.tsx
  - src/app/(dashboard)/configuracion/whatsapp/templates/components/template-list.tsx
  - src/app/(dashboard)/configuracion/whatsapp/templates/components/template-form.tsx
  - src/app/(dashboard)/configuracion/whatsapp/templates/components/variable-mapper.tsx
  - src/app/(dashboard)/configuracion/whatsapp/templates/components/template-status-badge.tsx
autonomous: true

must_haves:
  truths:
    - "Admin can view list of all templates with status badges"
    - "Admin can create new template with category selection"
    - "Admin can map template variables to contact/order fields"
    - "Template status shows as color badge (pending=yellow, approved=green, rejected=red)"
    - "Rejected templates show rejection reason"
  artifacts:
    - path: "src/app/(dashboard)/configuracion/whatsapp/templates/page.tsx"
      provides: "Template management page"
      min_lines: 50
    - path: "src/app/(dashboard)/configuracion/whatsapp/templates/components/template-form.tsx"
      provides: "Template creation/edit form"
      min_lines: 100
    - path: "src/app/(dashboard)/configuracion/whatsapp/templates/components/variable-mapper.tsx"
      provides: "Variable mapping UI"
      min_lines: 50
  key_links:
    - from: "template-list.tsx"
      to: "src/app/actions/templates.ts"
      via: "Server Action calls"
      pattern: "getTemplates"
    - from: "template-form.tsx"
      to: "src/app/actions/templates.ts"
      via: "createTemplate action"
      pattern: "createTemplate"
---

<objective>
Build the template management UI where admins can create, view, and manage WhatsApp message templates.

Purpose: Enable workspace admins to create templates for Meta approval and track their status.
Output: Settings page with template list, creation form, and variable mapping.
</objective>

<execution_context>
@/home/jose147/.claude/get-shit-done/workflows/execute-plan.md
@/home/jose147/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/08-whatsapp-extended/08-CONTEXT.md
@.planning/phases/08-whatsapp-extended/08-RESEARCH.md
@src/app/actions/templates.ts
@src/lib/whatsapp/types.ts
@src/app/(dashboard)/crm/configuracion/campos-custom/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: WhatsApp Settings Hub and Template List Page</name>
  <files>
    src/app/(dashboard)/configuracion/whatsapp/page.tsx
    src/app/(dashboard)/configuracion/whatsapp/templates/page.tsx
    src/app/(dashboard)/configuracion/whatsapp/templates/components/template-list.tsx
    src/app/(dashboard)/configuracion/whatsapp/templates/components/template-status-badge.tsx
  </files>
  <action>
**Create src/app/(dashboard)/configuracion/whatsapp/page.tsx:**
Hub page linking to Templates, Equipos, Quick Replies, Costos. Simple card grid with links.

```typescript
import Link from 'next/link'
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card'
import { FileText, Users, MessageSquare, DollarSign } from 'lucide-react'

const settings = [
  {
    title: 'Templates',
    description: 'Gestionar plantillas de mensajes para WhatsApp',
    href: '/configuracion/whatsapp/templates',
    icon: FileText
  },
  {
    title: 'Equipos',
    description: 'Configurar equipos y asignacion de agentes',
    href: '/configuracion/whatsapp/equipos',
    icon: Users
  },
  {
    title: 'Respuestas Rapidas',
    description: 'Crear respuestas predefinidas con atajos',
    href: '/configuracion/whatsapp/quick-replies',
    icon: MessageSquare
  },
  {
    title: 'Costos y Uso',
    description: 'Ver estadisticas de mensajes y costos',
    href: '/configuracion/whatsapp/costos',
    icon: DollarSign
  }
]

export default function WhatsAppSettingsPage() {
  return (
    <div className="container py-6">
      <h1 className="text-2xl font-bold mb-6">Configuracion de WhatsApp</h1>
      <div className="grid gap-4 md:grid-cols-2">
        {settings.map((setting) => (
          <Link key={setting.href} href={setting.href}>
            <Card className="hover:bg-muted/50 transition-colors cursor-pointer">
              <CardHeader className="flex flex-row items-center gap-4">
                <setting.icon className="h-8 w-8 text-muted-foreground" />
                <div>
                  <CardTitle className="text-lg">{setting.title}</CardTitle>
                  <CardDescription>{setting.description}</CardDescription>
                </div>
              </CardHeader>
            </Card>
          </Link>
        ))}
      </div>
    </div>
  )
}
```

**Create src/app/(dashboard)/configuracion/whatsapp/templates/page.tsx:**
```typescript
import { Suspense } from 'react'
import { getTemplates, syncTemplateStatuses } from '@/app/actions/templates'
import { TemplateList } from './components/template-list'
import { Button } from '@/components/ui/button'
import { RefreshCw, Plus } from 'lucide-react'
import Link from 'next/link'

async function SyncButton() {
  // Sync statuses from 360dialog on page load
  await syncTemplateStatuses()
  return null
}

export default async function TemplatesPage() {
  const templates = await getTemplates()

  return (
    <div className="container py-6">
      <div className="flex items-center justify-between mb-6">
        <div>
          <h1 className="text-2xl font-bold">Templates de WhatsApp</h1>
          <p className="text-muted-foreground">
            Crea y gestiona plantillas de mensajes para enviar fuera de la ventana de 24h
          </p>
        </div>
        <div className="flex gap-2">
          <form action={syncTemplateStatuses}>
            <Button variant="outline" size="sm">
              <RefreshCw className="h-4 w-4 mr-2" />
              Sincronizar
            </Button>
          </form>
          <Link href="/configuracion/whatsapp/templates/nuevo">
            <Button>
              <Plus className="h-4 w-4 mr-2" />
              Nuevo Template
            </Button>
          </Link>
        </div>
      </div>

      <Suspense fallback={<div>Cargando...</div>}>
        <SyncButton />
      </Suspense>

      <TemplateList templates={templates} />
    </div>
  )
}
```

**Create src/app/(dashboard)/configuracion/whatsapp/templates/components/template-status-badge.tsx:**
```typescript
'use client'

import { Badge } from '@/components/ui/badge'
import { TemplateStatus } from '@/lib/whatsapp/types'
import { cn } from '@/lib/utils'

const statusConfig: Record<TemplateStatus, { label: string; className: string }> = {
  PENDING: { label: 'Pendiente', className: 'bg-yellow-100 text-yellow-800 hover:bg-yellow-100' },
  APPROVED: { label: 'Aprobado', className: 'bg-green-100 text-green-800 hover:bg-green-100' },
  REJECTED: { label: 'Rechazado', className: 'bg-red-100 text-red-800 hover:bg-red-100' },
  PAUSED: { label: 'Pausado', className: 'bg-orange-100 text-orange-800 hover:bg-orange-100' },
  DISABLED: { label: 'Deshabilitado', className: 'bg-gray-100 text-gray-800 hover:bg-gray-100' }
}

export function TemplateStatusBadge({ status }: { status: TemplateStatus }) {
  const config = statusConfig[status] || statusConfig.PENDING
  return (
    <Badge variant="secondary" className={cn(config.className)}>
      {config.label}
    </Badge>
  )
}
```

**Create src/app/(dashboard)/configuracion/whatsapp/templates/components/template-list.tsx:**
```typescript
'use client'

import { useState } from 'react'
import { Template } from '@/lib/whatsapp/types'
import { TemplateStatusBadge } from './template-status-badge'
import { Button } from '@/components/ui/button'
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card'
import { Trash2, Edit, AlertCircle, ChevronDown, ChevronUp } from 'lucide-react'
import { deleteTemplate } from '@/app/actions/templates'
import { toast } from 'sonner'
import { AlertDialog, AlertDialogAction, AlertDialogCancel, AlertDialogContent, AlertDialogDescription, AlertDialogFooter, AlertDialogHeader, AlertDialogTitle, AlertDialogTrigger } from '@/components/ui/alert-dialog'
import Link from 'next/link'

const categoryLabels = {
  MARKETING: 'Marketing',
  UTILITY: 'Utilidad',
  AUTHENTICATION: 'Autenticacion'
}

export function TemplateList({ templates }: { templates: Template[] }) {
  const [expandedId, setExpandedId] = useState<string | null>(null)

  if (templates.length === 0) {
    return (
      <Card>
        <CardContent className="py-12 text-center text-muted-foreground">
          No hay templates creados. Crea uno para enviar mensajes fuera de la ventana de 24h.
        </CardContent>
      </Card>
    )
  }

  async function handleDelete(id: string) {
    try {
      await deleteTemplate(id)
      toast.success('Template eliminado')
    } catch (error) {
      toast.error('Error al eliminar template')
    }
  }

  return (
    <div className="space-y-3">
      {templates.map((template) => (
        <Card key={template.id}>
          <CardHeader className="py-4">
            <div className="flex items-center justify-between">
              <div className="flex items-center gap-3">
                <CardTitle className="text-base font-medium">{template.name}</CardTitle>
                <TemplateStatusBadge status={template.status} />
                <span className="text-xs text-muted-foreground">
                  {categoryLabels[template.category]}
                </span>
              </div>
              <div className="flex items-center gap-2">
                <Button
                  variant="ghost"
                  size="sm"
                  onClick={() => setExpandedId(expandedId === template.id ? null : template.id)}
                >
                  {expandedId === template.id ? (
                    <ChevronUp className="h-4 w-4" />
                  ) : (
                    <ChevronDown className="h-4 w-4" />
                  )}
                </Button>
                <Link href={`/configuracion/whatsapp/templates/${template.id}`}>
                  <Button variant="ghost" size="icon">
                    <Edit className="h-4 w-4" />
                  </Button>
                </Link>
                <AlertDialog>
                  <AlertDialogTrigger asChild>
                    <Button variant="ghost" size="icon" className="text-destructive">
                      <Trash2 className="h-4 w-4" />
                    </Button>
                  </AlertDialogTrigger>
                  <AlertDialogContent>
                    <AlertDialogHeader>
                      <AlertDialogTitle>Eliminar template</AlertDialogTitle>
                      <AlertDialogDescription>
                        Esta accion no se puede deshacer. El template se eliminara de 360dialog.
                      </AlertDialogDescription>
                    </AlertDialogHeader>
                    <AlertDialogFooter>
                      <AlertDialogCancel>Cancelar</AlertDialogCancel>
                      <AlertDialogAction onClick={() => handleDelete(template.id)}>
                        Eliminar
                      </AlertDialogAction>
                    </AlertDialogFooter>
                  </AlertDialogContent>
                </AlertDialog>
              </div>
            </div>
          </CardHeader>

          {expandedId === template.id && (
            <CardContent className="pt-0 pb-4">
              {template.rejected_reason && (
                <div className="flex items-start gap-2 p-3 bg-red-50 rounded-lg mb-3">
                  <AlertCircle className="h-4 w-4 text-red-600 mt-0.5" />
                  <div>
                    <p className="text-sm font-medium text-red-800">Razon del rechazo:</p>
                    <p className="text-sm text-red-700">{template.rejected_reason}</p>
                  </div>
                </div>
              )}

              <div className="space-y-2">
                {template.components.map((comp, idx) => (
                  <div key={idx} className="text-sm">
                    <span className="font-medium text-muted-foreground">
                      {comp.type}:
                    </span>{' '}
                    <span>{comp.text || '(sin texto)'}</span>
                  </div>
                ))}
              </div>

              {Object.keys(template.variable_mapping).length > 0 && (
                <div className="mt-3 pt-3 border-t">
                  <p className="text-sm font-medium text-muted-foreground mb-2">
                    Variables mapeadas:
                  </p>
                  <div className="flex flex-wrap gap-2">
                    {Object.entries(template.variable_mapping).map(([key, value]) => (
                      <span
                        key={key}
                        className="text-xs bg-muted px-2 py-1 rounded"
                      >
                        {`{{${key}}}`} → {value}
                      </span>
                    ))}
                  </div>
                </div>
              )}
            </CardContent>
          )}
        </Card>
      ))}
    </div>
  )
}
```

Use existing UI components and patterns from the project.
  </action>
  <verify>Run `pnpm tsc --noEmit` to verify no TypeScript errors. Check that pages render at /configuracion/whatsapp and /configuracion/whatsapp/templates.</verify>
  <done>WhatsApp settings hub created with 4 setting cards. Template list page shows all templates with status badges, expandable details, and delete confirmation. Status badges use correct colors (yellow/green/red).</done>
</task>

<task type="auto">
  <name>Task 2: Template Creation Form with Variable Mapper</name>
  <files>
    src/app/(dashboard)/configuracion/whatsapp/templates/nuevo/page.tsx
    src/app/(dashboard)/configuracion/whatsapp/templates/components/template-form.tsx
    src/app/(dashboard)/configuracion/whatsapp/templates/components/variable-mapper.tsx
  </files>
  <action>
**Create src/app/(dashboard)/configuracion/whatsapp/templates/components/variable-mapper.tsx:**
```typescript
'use client'

import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select'
import { Input } from '@/components/ui/input'
import { useState } from 'react'

interface VariableMapperProps {
  templateBody: string
  mapping: Record<string, string>
  onChange: (mapping: Record<string, string>) => void
}

const AVAILABLE_FIELDS = [
  { value: 'contact.name', label: 'Nombre del contacto' },
  { value: 'contact.phone', label: 'Telefono del contacto' },
  { value: 'contact.email', label: 'Email del contacto' },
  { value: 'contact.city', label: 'Ciudad del contacto' },
  { value: 'order.id', label: 'ID del pedido' },
  { value: 'order.total', label: 'Total del pedido' },
  { value: 'order.tracking_number', label: 'Numero de guia' },
  { value: 'order.carrier', label: 'Transportadora' },
  { value: 'custom', label: 'Valor personalizado...' }
]

export function VariableMapper({ templateBody, mapping, onChange }: VariableMapperProps) {
  const [customValues, setCustomValues] = useState<Record<string, string>>({})

  // Extract variables like {{1}}, {{2}} from body
  const variables = templateBody.match(/\{\{(\d+)\}\}/g) || []
  const uniqueVars = [...new Set(variables)]

  if (uniqueVars.length === 0) {
    return (
      <p className="text-sm text-muted-foreground">
        No hay variables en el cuerpo del template. Usa {`{{1}}`}, {`{{2}}`}, etc. para agregar variables.
      </p>
    )
  }

  const handleChange = (varNum: string, value: string) => {
    if (value === 'custom') {
      // Keep custom selection, actual value comes from input
      onChange({ ...mapping, [varNum]: customValues[varNum] || '' })
    } else {
      onChange({ ...mapping, [varNum]: value })
    }
  }

  const handleCustomValue = (varNum: string, value: string) => {
    setCustomValues({ ...customValues, [varNum]: value })
    if (mapping[varNum] === '' || !AVAILABLE_FIELDS.find(f => f.value === mapping[varNum])) {
      onChange({ ...mapping, [varNum]: value })
    }
  }

  const isCustom = (varNum: string) => {
    const value = mapping[varNum]
    return value && !AVAILABLE_FIELDS.find(f => f.value === value)
  }

  return (
    <div className="space-y-4">
      <div className="flex items-center justify-between">
        <h4 className="text-sm font-medium">Mapeo de Variables</h4>
        <p className="text-xs text-muted-foreground">
          Conecta cada variable con un campo de contacto o pedido
        </p>
      </div>

      <div className="space-y-3">
        {uniqueVars.map((varMatch) => {
          const varNum = varMatch.replace(/[{}]/g, '')
          const currentValue = mapping[varNum] || ''
          const isCustomValue = isCustom(varNum)

          return (
            <div key={varNum} className="flex items-center gap-3">
              <span className="text-sm font-mono bg-muted px-2 py-1 rounded min-w-[60px] text-center">
                {`{{${varNum}}}`}
              </span>
              <span className="text-muted-foreground">→</span>
              <Select
                value={isCustomValue ? 'custom' : currentValue}
                onValueChange={(value) => handleChange(varNum, value)}
              >
                <SelectTrigger className="flex-1">
                  <SelectValue placeholder="Seleccionar campo..." />
                </SelectTrigger>
                <SelectContent>
                  {AVAILABLE_FIELDS.map((field) => (
                    <SelectItem key={field.value} value={field.value}>
                      {field.label}
                    </SelectItem>
                  ))}
                </SelectContent>
              </Select>
              {isCustomValue && (
                <Input
                  placeholder="Valor personalizado"
                  value={customValues[varNum] || currentValue}
                  onChange={(e) => handleCustomValue(varNum, e.target.value)}
                  className="w-48"
                />
              )}
            </div>
          )
        })}
      </div>
    </div>
  )
}
```

**Create src/app/(dashboard)/configuracion/whatsapp/templates/components/template-form.tsx:**
```typescript
'use client'

import { useState } from 'react'
import { useRouter } from 'next/navigation'
import { Button } from '@/components/ui/button'
import { Input } from '@/components/ui/input'
import { Label } from '@/components/ui/label'
import { Textarea } from '@/components/ui/textarea'
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select'
import { Card, CardContent, CardHeader, CardTitle, CardDescription } from '@/components/ui/card'
import { VariableMapper } from './variable-mapper'
import { createTemplate } from '@/app/actions/templates'
import { TemplateCategory, TemplateComponent } from '@/lib/whatsapp/types'
import { toast } from 'sonner'
import { Loader2, AlertCircle } from 'lucide-react'

const categoryInfo = {
  MARKETING: {
    label: 'Marketing',
    description: 'Promociones, ofertas, novedades. Mayor costo por mensaje.',
    examples: 'Ej: "Aprovecha 20% de descuento en tu proxima compra"'
  },
  UTILITY: {
    label: 'Utilidad',
    description: 'Actualizaciones de pedidos, confirmaciones, recordatorios.',
    examples: 'Ej: "Tu pedido #123 ha sido enviado con guia ABC123"'
  },
  AUTHENTICATION: {
    label: 'Autenticacion',
    description: 'Codigos OTP, verificaciones de identidad.',
    examples: 'Ej: "Tu codigo de verificacion es: 123456"'
  }
}

export function TemplateForm() {
  const router = useRouter()
  const [loading, setLoading] = useState(false)
  const [name, setName] = useState('')
  const [category, setCategory] = useState<TemplateCategory>('UTILITY')
  const [language, setLanguage] = useState('es')
  const [headerText, setHeaderText] = useState('')
  const [bodyText, setBodyText] = useState('')
  const [footerText, setFooterText] = useState('')
  const [variableMapping, setVariableMapping] = useState<Record<string, string>>({})

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault()
    setLoading(true)

    try {
      // Build components array
      const components: TemplateComponent[] = []

      if (headerText.trim()) {
        components.push({ type: 'HEADER', format: 'TEXT', text: headerText })
      }

      if (bodyText.trim()) {
        components.push({ type: 'BODY', text: bodyText })
      } else {
        toast.error('El cuerpo del mensaje es requerido')
        setLoading(false)
        return
      }

      if (footerText.trim()) {
        components.push({ type: 'FOOTER', text: footerText })
      }

      await createTemplate({
        name,
        language,
        category,
        components,
        variable_mapping: variableMapping
      })

      toast.success('Template creado y enviado a Meta para aprobacion')
      router.push('/configuracion/whatsapp/templates')
    } catch (error) {
      toast.error(error instanceof Error ? error.message : 'Error al crear template')
    } finally {
      setLoading(false)
    }
  }

  return (
    <form onSubmit={handleSubmit} className="space-y-6">
      <Card>
        <CardHeader>
          <CardTitle>Informacion Basica</CardTitle>
          <CardDescription>
            El nombre debe ser unico y solo puede contener letras minusculas, numeros y guiones bajos.
          </CardDescription>
        </CardHeader>
        <CardContent className="space-y-4">
          <div className="grid gap-4 md:grid-cols-2">
            <div className="space-y-2">
              <Label htmlFor="name">Nombre del template</Label>
              <Input
                id="name"
                value={name}
                onChange={(e) => setName(e.target.value.toLowerCase().replace(/[^a-z0-9_]/g, '_'))}
                placeholder="confirmacion_envio"
                required
              />
            </div>
            <div className="space-y-2">
              <Label htmlFor="language">Idioma</Label>
              <Select value={language} onValueChange={setLanguage}>
                <SelectTrigger>
                  <SelectValue />
                </SelectTrigger>
                <SelectContent>
                  <SelectItem value="es">Español</SelectItem>
                  <SelectItem value="en_US">English (US)</SelectItem>
                </SelectContent>
              </Select>
            </div>
          </div>

          <div className="space-y-2">
            <Label>Categoria</Label>
            <div className="grid gap-3 md:grid-cols-3">
              {(Object.keys(categoryInfo) as TemplateCategory[]).map((cat) => {
                const info = categoryInfo[cat]
                return (
                  <div
                    key={cat}
                    onClick={() => setCategory(cat)}
                    className={`p-3 border rounded-lg cursor-pointer transition-colors ${
                      category === cat ? 'border-primary bg-primary/5' : 'hover:bg-muted/50'
                    }`}
                  >
                    <p className="font-medium">{info.label}</p>
                    <p className="text-xs text-muted-foreground mt-1">{info.description}</p>
                  </div>
                )
              })}
            </div>
          </div>
        </CardContent>
      </Card>

      <Card>
        <CardHeader>
          <CardTitle>Contenido del Mensaje</CardTitle>
          <CardDescription>
            Usa {`{{1}}`}, {`{{2}}`}, etc. para agregar variables que se reemplazaran con datos del contacto o pedido.
          </CardDescription>
        </CardHeader>
        <CardContent className="space-y-4">
          <div className="space-y-2">
            <Label htmlFor="header">Encabezado (opcional)</Label>
            <Input
              id="header"
              value={headerText}
              onChange={(e) => setHeaderText(e.target.value)}
              placeholder="Actualizacion de tu pedido"
            />
          </div>

          <div className="space-y-2">
            <Label htmlFor="body">Cuerpo del mensaje *</Label>
            <Textarea
              id="body"
              value={bodyText}
              onChange={(e) => setBodyText(e.target.value)}
              placeholder="Hola {{1}}, tu pedido #{{2}} ha sido enviado con la guia {{3}}."
              rows={4}
              required
            />
            <p className="text-xs text-muted-foreground">
              Ejemplo: Hola {`{{1}}`}, tu pedido #{`{{2}}`} ha sido enviado.
            </p>
          </div>

          <div className="space-y-2">
            <Label htmlFor="footer">Pie de pagina (opcional)</Label>
            <Input
              id="footer"
              value={footerText}
              onChange={(e) => setFooterText(e.target.value)}
              placeholder="Gracias por tu compra - Tu Tienda"
            />
          </div>
        </CardContent>
      </Card>

      {bodyText.includes('{{') && (
        <Card>
          <CardHeader>
            <CardTitle>Mapeo de Variables</CardTitle>
            <CardDescription>
              Conecta cada variable del mensaje con el campo correspondiente. Esto se usara al enviar el template.
            </CardDescription>
          </CardHeader>
          <CardContent>
            <VariableMapper
              templateBody={bodyText + headerText}
              mapping={variableMapping}
              onChange={setVariableMapping}
            />
          </CardContent>
        </Card>
      )}

      <Card className="border-yellow-200 bg-yellow-50">
        <CardContent className="pt-6">
          <div className="flex gap-3">
            <AlertCircle className="h-5 w-5 text-yellow-600 flex-shrink-0" />
            <div className="text-sm text-yellow-800">
              <p className="font-medium">Proceso de aprobacion</p>
              <p className="mt-1">
                Despues de crear el template, Meta lo revisara (1-24 horas). Solo podras usarlo
                cuando el estado sea "Aprobado".
              </p>
            </div>
          </div>
        </CardContent>
      </Card>

      <div className="flex justify-end gap-3">
        <Button type="button" variant="outline" onClick={() => router.back()}>
          Cancelar
        </Button>
        <Button type="submit" disabled={loading || !name || !bodyText}>
          {loading && <Loader2 className="h-4 w-4 mr-2 animate-spin" />}
          Crear y Enviar a Meta
        </Button>
      </div>
    </form>
  )
}
```

**Create src/app/(dashboard)/configuracion/whatsapp/templates/nuevo/page.tsx:**
```typescript
import { TemplateForm } from '../components/template-form'

export default function NewTemplatePage() {
  return (
    <div className="container py-6 max-w-3xl">
      <div className="mb-6">
        <h1 className="text-2xl font-bold">Nuevo Template</h1>
        <p className="text-muted-foreground">
          Crea una plantilla de mensaje para enviar fuera de la ventana de 24 horas
        </p>
      </div>

      <TemplateForm />
    </div>
  )
}
```

Follow existing form patterns from src/app/(dashboard)/crm/configuracion/campos-custom.
  </action>
  <verify>Run `pnpm tsc --noEmit` to verify TypeScript compiles. Navigate to /configuracion/whatsapp/templates/nuevo and verify form renders.</verify>
  <done>Template form created with name, language, category selection. Body textarea with variable guidance. Variable mapper extracts variables and maps to contact/order fields. Warning card explains Meta approval process.</done>
</task>

<task type="auto">
  <name>Task 3: Template Detail/Edit Page</name>
  <files>
    src/app/(dashboard)/configuracion/whatsapp/templates/[id]/page.tsx
    src/app/(dashboard)/configuracion/whatsapp/templates/[id]/components/template-detail.tsx
  </files>
  <action>
**Create src/app/(dashboard)/configuracion/whatsapp/templates/[id]/page.tsx:**
```typescript
import { notFound } from 'next/navigation'
import { getTemplate } from '@/app/actions/templates'
import { TemplateDetail } from './components/template-detail'

interface Props {
  params: Promise<{ id: string }>
}

export default async function TemplateDetailPage({ params }: Props) {
  const { id } = await params
  const template = await getTemplate(id)

  if (!template) {
    notFound()
  }

  return (
    <div className="container py-6 max-w-3xl">
      <TemplateDetail template={template} />
    </div>
  )
}
```

**Create src/app/(dashboard)/configuracion/whatsapp/templates/[id]/components/template-detail.tsx:**
```typescript
'use client'

import { useState } from 'react'
import { Template } from '@/lib/whatsapp/types'
import { TemplateStatusBadge } from '../../components/template-status-badge'
import { VariableMapper } from '../../components/variable-mapper'
import { Card, CardContent, CardHeader, CardTitle, CardDescription } from '@/components/ui/card'
import { Button } from '@/components/ui/button'
import { updateTemplateMapping } from '@/app/actions/templates'
import { toast } from 'sonner'
import { Loader2, ArrowLeft, AlertCircle } from 'lucide-react'
import Link from 'next/link'

const categoryLabels = {
  MARKETING: 'Marketing',
  UTILITY: 'Utilidad',
  AUTHENTICATION: 'Autenticacion'
}

export function TemplateDetail({ template }: { template: Template }) {
  const [mapping, setMapping] = useState<Record<string, string>>(template.variable_mapping || {})
  const [saving, setSaving] = useState(false)
  const [hasChanges, setHasChanges] = useState(false)

  const bodyText = template.components.find(c => c.type === 'BODY')?.text || ''
  const headerText = template.components.find(c => c.type === 'HEADER')?.text || ''
  const footerText = template.components.find(c => c.type === 'FOOTER')?.text || ''

  const handleMappingChange = (newMapping: Record<string, string>) => {
    setMapping(newMapping)
    setHasChanges(true)
  }

  const handleSave = async () => {
    setSaving(true)
    try {
      await updateTemplateMapping(template.id, mapping)
      toast.success('Mapeo de variables guardado')
      setHasChanges(false)
    } catch (error) {
      toast.error('Error al guardar')
    } finally {
      setSaving(false)
    }
  }

  return (
    <div className="space-y-6">
      <div className="flex items-center gap-4">
        <Link href="/configuracion/whatsapp/templates">
          <Button variant="ghost" size="icon">
            <ArrowLeft className="h-4 w-4" />
          </Button>
        </Link>
        <div className="flex-1">
          <div className="flex items-center gap-3">
            <h1 className="text-2xl font-bold">{template.name}</h1>
            <TemplateStatusBadge status={template.status} />
          </div>
          <p className="text-muted-foreground">
            {categoryLabels[template.category]} · {template.language === 'es' ? 'Español' : 'English'}
          </p>
        </div>
      </div>

      {template.rejected_reason && (
        <Card className="border-red-200 bg-red-50">
          <CardContent className="pt-6">
            <div className="flex gap-3">
              <AlertCircle className="h-5 w-5 text-red-600 flex-shrink-0" />
              <div className="text-sm text-red-800">
                <p className="font-medium">Template rechazado por Meta</p>
                <p className="mt-1">{template.rejected_reason}</p>
                <p className="mt-2 text-xs">
                  Debes crear un nuevo template con contenido diferente. Los templates rechazados no pueden ser editados.
                </p>
              </div>
            </div>
          </CardContent>
        </Card>
      )}

      <Card>
        <CardHeader>
          <CardTitle>Contenido del Template</CardTitle>
          <CardDescription>
            El contenido no puede ser editado despues de enviar a Meta. Solo puedes modificar el mapeo de variables.
          </CardDescription>
        </CardHeader>
        <CardContent className="space-y-4">
          {headerText && (
            <div>
              <p className="text-sm font-medium text-muted-foreground">Encabezado</p>
              <p className="mt-1">{headerText}</p>
            </div>
          )}

          <div>
            <p className="text-sm font-medium text-muted-foreground">Cuerpo</p>
            <p className="mt-1 whitespace-pre-wrap">{bodyText}</p>
          </div>

          {footerText && (
            <div>
              <p className="text-sm font-medium text-muted-foreground">Pie de pagina</p>
              <p className="mt-1">{footerText}</p>
            </div>
          )}
        </CardContent>
      </Card>

      {(bodyText.includes('{{') || headerText.includes('{{')) && (
        <Card>
          <CardHeader>
            <CardTitle>Mapeo de Variables</CardTitle>
            <CardDescription>
              Puedes cambiar a que campos se conectan las variables en cualquier momento.
            </CardDescription>
          </CardHeader>
          <CardContent className="space-y-4">
            <VariableMapper
              templateBody={bodyText + headerText}
              mapping={mapping}
              onChange={handleMappingChange}
            />

            {hasChanges && (
              <div className="flex justify-end">
                <Button onClick={handleSave} disabled={saving}>
                  {saving && <Loader2 className="h-4 w-4 mr-2 animate-spin" />}
                  Guardar Mapeo
                </Button>
              </div>
            )}
          </CardContent>
        </Card>
      )}

      <Card>
        <CardHeader>
          <CardTitle>Informacion</CardTitle>
        </CardHeader>
        <CardContent>
          <div className="grid gap-4 md:grid-cols-2 text-sm">
            <div>
              <p className="text-muted-foreground">Creado</p>
              <p>{new Date(template.created_at).toLocaleString('es-CO')}</p>
            </div>
            {template.submitted_at && (
              <div>
                <p className="text-muted-foreground">Enviado a Meta</p>
                <p>{new Date(template.submitted_at).toLocaleString('es-CO')}</p>
              </div>
            )}
            {template.approved_at && (
              <div>
                <p className="text-muted-foreground">Aprobado</p>
                <p>{new Date(template.approved_at).toLocaleString('es-CO')}</p>
              </div>
            )}
            {template.quality_rating && (
              <div>
                <p className="text-muted-foreground">Calidad</p>
                <p>{template.quality_rating}</p>
              </div>
            )}
          </div>
        </CardContent>
      </Card>
    </div>
  )
}
```

Follow existing detail page patterns from contact detail page.
  </action>
  <verify>Run `pnpm tsc --noEmit` to verify TypeScript compiles. Test that template detail page shows at /configuracion/whatsapp/templates/[id].</verify>
  <done>Template detail page shows template content (read-only), status badge, rejection reason if rejected, and editable variable mapping. Info section shows creation, submission, and approval dates.</done>
</task>

</tasks>

<verification>
1. WhatsApp settings hub shows 4 cards linking to subpages
2. Template list displays all templates with status badges
3. Template form allows creating new templates with category selection
4. Variable mapper extracts {{n}} patterns and maps to fields
5. Template detail shows content and allows editing variable mapping
6. Rejected templates show rejection reason
</verification>

<success_criteria>
- All pages compile without TypeScript errors
- Settings hub links to all 4 subpages
- Template list shows status badges with correct colors
- Template form validates required fields
- Variable mapper shows only detected variables
- Detail page allows saving variable mapping changes
</success_criteria>

<output>
After completion, create `.planning/phases/08-whatsapp-extended/08-03-SUMMARY.md`
</output>
