---
phase: 15.6-sandbox-evolution
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/app/(dashboard)/sandbox/components/debug-panel/tab-bar.tsx
  - src/app/(dashboard)/sandbox/components/debug-panel/panel-container.tsx
  - src/app/(dashboard)/sandbox/components/debug-panel/debug-tabs.tsx
  - src/app/(dashboard)/sandbox/components/debug-panel/index.ts
  - src/components/ui/slider.tsx
autonomous: true

must_haves:
  truths:
    - "Debug panel shows a draggable tab bar with 5 tabs (Tools, Estado, Intent, Tokens, Ingest)"
    - "Clicking a tab toggles its visibility (max 3 visible simultaneously)"
    - "Tabs can be reordered by dragging in the tab bar"
    - "Visible panels render in a responsive grid (1, 2, or 3 columns)"
    - "Default layout shows Tools + Estado visible"
  artifacts:
    - path: "src/app/(dashboard)/sandbox/components/debug-panel/tab-bar.tsx"
      provides: "Draggable tab bar using @dnd-kit/sortable"
      contains: "SortableContext"
    - path: "src/app/(dashboard)/sandbox/components/debug-panel/panel-container.tsx"
      provides: "Grid container rendering 1-3 visible panels"
      contains: "grid-cols"
    - path: "src/app/(dashboard)/sandbox/components/debug-panel/debug-tabs.tsx"
      provides: "Refactored container combining TabBar + PanelContainer"
      contains: "TabBar"
    - path: "src/components/ui/slider.tsx"
      provides: "Radix UI Slider component for ingest timer controls"
      contains: "SliderPrimitive"
  key_links:
    - from: "debug-tabs.tsx"
      to: "tab-bar.tsx"
      via: "renders TabBar component"
      pattern: "<TabBar"
    - from: "debug-tabs.tsx"
      to: "panel-container.tsx"
      via: "renders PanelContainer with visible tab IDs"
      pattern: "<PanelContainer"
---

<objective>
Build the multi-panel debug UI: a sortable tab bar with @dnd-kit that controls visibility of up to 3 panels simultaneously, replacing the current single-tab Radix UI Tabs. Also install the Radix UI Slider component via shadcn for ingest timer controls (Plan 04 dependency).

Purpose: Success Criteria 4 requires "Debug panel permite ver hasta 3 tabs simultaneamente". The current single-tab view only shows one at a time.
Output: New tab-bar.tsx, panel-container.tsx, refactored debug-tabs.tsx, and slider component.
</objective>

<execution_context>
@/home/jose147/.claude/get-shit-done/workflows/execute-plan.md
@/home/jose147/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/app/(dashboard)/sandbox/components/debug-panel/debug-tabs.tsx
@src/app/(dashboard)/sandbox/components/debug-panel/index.ts
@src/app/(dashboard)/sandbox/components/sandbox-split-panel.tsx
@src/app/(dashboard)/sandbox/components/sandbox-layout.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install Radix UI Slider via shadcn and create TabBar + PanelContainer components</name>
  <files>
    src/components/ui/slider.tsx
    src/app/(dashboard)/sandbox/components/debug-panel/tab-bar.tsx
    src/app/(dashboard)/sandbox/components/debug-panel/panel-container.tsx
  </files>
  <action>
**1. Install slider component:**
```bash
cd /mnt/c/Users/Usuario/Proyectos/morfx-new && npx shadcn@latest add slider --yes
```
This creates `src/components/ui/slider.tsx` with `@radix-ui/react-slider`.

**2. Create `tab-bar.tsx`:**

A horizontal tab bar where tabs can be dragged to reorder using @dnd-kit/sortable. Clicking a tab toggles its visibility. Maximum 3 tabs can be visible simultaneously.

```typescript
'use client'

import { DndContext, closestCenter, type DragEndEvent } from '@dnd-kit/core'
import { SortableContext, horizontalListSortingStrategy, arrayMove, useSortable } from '@dnd-kit/sortable'
import { CSS } from '@dnd-kit/utilities'
import { Wrench, FileJson, Brain, Coins, Database } from 'lucide-react'
import { cn } from '@/lib/utils'
import type { DebugPanelTab, DebugPanelTabId } from '@/lib/sandbox/types'

const TAB_ICONS: Record<DebugPanelTabId, React.ComponentType<{ className?: string }>> = {
  tools: Wrench,
  state: FileJson,
  intent: Brain,
  tokens: Coins,
  ingest: Database,
}

interface SortableTabItemProps {
  tab: DebugPanelTab
  onToggle: () => void
  canActivate: boolean
}

function SortableTabItem({ tab, onToggle, canActivate }: SortableTabItemProps) {
  const { attributes, listeners, setNodeRef, transform, transition, isDragging } = useSortable({ id: tab.id })
  const style = {
    transform: CSS.Transform.toString(transform),
    transition,
  }
  const Icon = TAB_ICONS[tab.id]

  return (
    <div ref={setNodeRef} style={style} {...attributes} {...listeners}>
      <button
        onClick={onToggle}
        disabled={!tab.visible && !canActivate}
        className={cn(
          'px-3 py-1.5 text-xs flex items-center gap-1.5 rounded-t border-t border-x transition-colors cursor-grab active:cursor-grabbing',
          tab.visible
            ? 'bg-background border-border text-foreground font-medium'
            : canActivate
              ? 'bg-muted/40 border-transparent text-muted-foreground hover:bg-muted/60'
              : 'bg-muted/20 border-transparent text-muted-foreground/50 cursor-not-allowed',
          isDragging && 'opacity-50 z-50'
        )}
        title={!tab.visible && !canActivate ? 'Maximo 3 paneles visibles' : undefined}
      >
        <Icon className="h-3.5 w-3.5" />
        {tab.label}
      </button>
    </div>
  )
}

interface TabBarProps {
  tabs: DebugPanelTab[]
  onReorder: (tabs: DebugPanelTab[]) => void
  onToggleTab: (tabId: DebugPanelTabId) => void
  maxVisible?: number
}

export function TabBar({ tabs, onReorder, onToggleTab, maxVisible = 3 }: TabBarProps) {
  const visibleCount = tabs.filter(t => t.visible).length
  const canActivateMore = visibleCount < maxVisible

  function handleDragEnd(event: DragEndEvent) {
    const { active, over } = event
    if (active.id !== over?.id) {
      const oldIndex = tabs.findIndex(t => t.id === active.id)
      const newIndex = tabs.findIndex(t => t.id === over?.id)
      if (oldIndex !== -1 && newIndex !== -1) {
        onReorder(arrayMove(tabs, oldIndex, newIndex))
      }
    }
  }

  return (
    <DndContext collisionDetection={closestCenter} onDragEnd={handleDragEnd}>
      <SortableContext items={tabs.map(t => t.id)} strategy={horizontalListSortingStrategy}>
        <div className="flex gap-1 px-3 pt-2 border-b bg-muted/20">
          {tabs.map(tab => (
            <SortableTabItem
              key={tab.id}
              tab={tab}
              onToggle={() => onToggleTab(tab.id)}
              canActivate={canActivateMore}
            />
          ))}
          <div className="flex-1" />
          <span className="self-end pb-1.5 text-[10px] text-muted-foreground/60">
            {visibleCount}/{maxVisible}
          </span>
        </div>
      </SortableContext>
    </DndContext>
  )
}
```

**3. Create `panel-container.tsx`:**

Renders 1-3 visible panels in a CSS grid. Each panel renders the corresponding tab component.

```typescript
'use client'

import { cn } from '@/lib/utils'
import { ToolsTab } from './tools-tab'
import { StateTab } from './state-tab'
import { IntentTab } from './intent-tab'
import { TokensTab } from './tokens-tab'
import type { DebugPanelTabId, DebugTurn, SandboxState, IngestStatus } from '@/lib/sandbox/types'

interface PanelContainerProps {
  visiblePanels: DebugPanelTabId[]
  debugTurns: DebugTurn[]
  state: SandboxState
  onStateEdit: (newState: SandboxState) => void
  totalTokens: number
}

function PanelContent({ id, ...props }: { id: DebugPanelTabId } & Omit<PanelContainerProps, 'visiblePanels'>) {
  switch (id) {
    case 'tools':
      return <ToolsTab debugTurns={props.debugTurns} />
    case 'state':
      return <StateTab state={props.state} onStateEdit={props.onStateEdit} />
    case 'intent':
      return <IntentTab debugTurns={props.debugTurns} />
    case 'tokens':
      return <TokensTab debugTurns={props.debugTurns} totalTokens={props.totalTokens} />
    case 'ingest':
      // IngestTab will be created in Plan 04. Show placeholder for now.
      return (
        <div className="flex items-center justify-center h-full text-sm text-muted-foreground">
          Tab Ingest (disponible pronto)
        </div>
      )
    default:
      return null
  }
}

export function PanelContainer({ visiblePanels, ...props }: PanelContainerProps) {
  if (visiblePanels.length === 0) {
    return (
      <div className="flex items-center justify-center h-full text-sm text-muted-foreground">
        Selecciona un tab para ver el panel de debug
      </div>
    )
  }

  const gridCols =
    visiblePanels.length === 1 ? 'grid-cols-1'
    : visiblePanels.length === 2 ? 'grid-cols-2'
    : 'grid-cols-3'

  return (
    <div className={cn('grid gap-2 h-full p-2', gridCols)}>
      {visiblePanels.map(panelId => (
        <div key={panelId} className="overflow-auto border rounded-lg p-3 min-w-0">
          <PanelContent id={panelId} {...props} />
        </div>
      ))}
    </div>
  )
}
```

**IMPORTANT:** Keep `DebugPanelTabId` imported from sandbox/types. The `ingest` case is a placeholder that will be replaced in Plan 04. The `tokens` tab still uses the existing TokensTab component - Plan 04 will enhance it.
  </action>
  <verify>
- `ls src/components/ui/slider.tsx` confirms slider installed
- `npx tsc --noEmit` passes (or only shows errors from Plan 01 types not yet applied - if running in parallel)
  </verify>
  <done>
- slider.tsx component exists via shadcn
- tab-bar.tsx renders sortable tabs with DnD, toggle on click, max 3 enforcement
- panel-container.tsx renders 1-3 panels in responsive grid
- Ingest panel shows placeholder (will be replaced in Plan 04)
  </done>
</task>

<task type="auto">
  <name>Task 2: Refactor debug-tabs.tsx to use TabBar + PanelContainer and update exports</name>
  <files>
    src/app/(dashboard)/sandbox/components/debug-panel/debug-tabs.tsx
    src/app/(dashboard)/sandbox/components/debug-panel/index.ts
  </files>
  <action>
**Refactor `debug-tabs.tsx`:**

Replace the current Radix UI Tabs implementation with the new TabBar + PanelContainer. The DebugTabs component now manages:
- Tab order state (reorderable array)
- Tab visibility state (which tabs are visible, max 3)
- Default: Tools + Estado visible

```typescript
'use client'

/**
 * Debug Tabs Component
 * Phase 15.6: Sandbox Evolution
 *
 * Multi-panel debug container with draggable tab bar.
 * Supports up to 3 visible panels simultaneously.
 */

import { useState, useCallback } from 'react'
import { TabBar } from './tab-bar'
import { PanelContainer } from './panel-container'
import type { DebugTurn, SandboxState, DebugPanelTab, DebugPanelTabId } from '@/lib/sandbox/types'

const DEFAULT_TABS: DebugPanelTab[] = [
  { id: 'tools', label: 'Tools', visible: true },
  { id: 'state', label: 'Estado', visible: true },
  { id: 'intent', label: 'Intent', visible: false },
  { id: 'tokens', label: 'Tokens', visible: false },
  { id: 'ingest', label: 'Ingest', visible: false },
]

const MAX_VISIBLE = 3

interface DebugTabsProps {
  debugTurns: DebugTurn[]
  state: SandboxState
  onStateEdit: (newState: SandboxState) => void
  totalTokens: number
}

export function DebugTabs({
  debugTurns,
  state,
  onStateEdit,
  totalTokens,
}: DebugTabsProps) {
  const [tabs, setTabs] = useState<DebugPanelTab[]>(DEFAULT_TABS)

  const handleReorder = useCallback((newTabs: DebugPanelTab[]) => {
    setTabs(newTabs)
  }, [])

  const handleToggleTab = useCallback((tabId: DebugPanelTabId) => {
    setTabs(prev => {
      const tab = prev.find(t => t.id === tabId)
      if (!tab) return prev

      // If already visible, toggle off
      if (tab.visible) {
        return prev.map(t => t.id === tabId ? { ...t, visible: false } : t)
      }

      // If not visible, check if we can add more
      const visibleCount = prev.filter(t => t.visible).length
      if (visibleCount >= MAX_VISIBLE) return prev // Can't add more

      return prev.map(t => t.id === tabId ? { ...t, visible: true } : t)
    })
  }, [])

  const visiblePanels = tabs.filter(t => t.visible).map(t => t.id)

  return (
    <div className="h-full flex flex-col bg-background">
      <div className="px-3 py-2 border-b">
        <h3 className="text-sm font-medium">Debug Panel</h3>
      </div>

      <TabBar
        tabs={tabs}
        onReorder={handleReorder}
        onToggleTab={handleToggleTab}
        maxVisible={MAX_VISIBLE}
      />

      <div className="flex-1 min-h-0 overflow-hidden">
        <PanelContainer
          visiblePanels={visiblePanels}
          debugTurns={debugTurns}
          state={state}
          onStateEdit={onStateEdit}
          totalTokens={totalTokens}
        />
      </div>
    </div>
  )
}
```

**Update `index.ts`:**

Add exports for new components:
```typescript
export { DebugTabs } from './debug-tabs'
export { ToolsTab } from './tools-tab'
export { StateTab } from './state-tab'
export { IntentTab } from './intent-tab'
export { TokensTab } from './tokens-tab'
export { TabBar } from './tab-bar'
export { PanelContainer } from './panel-container'
```

**IMPORTANT:** The DebugTabs component signature (props) remains the same, so sandbox-layout.tsx needs NO changes. The internal implementation switches from Radix Tabs to TabBar + PanelContainer.

**IMPORTANT:** Remove unused Radix UI Tabs imports from debug-tabs.tsx (Tabs, TabsContent, TabsList, TabsTrigger). Also remove the unused lucide-react icon imports (Wrench, FileJson, Brain, Coins) since the icons are now in tab-bar.tsx.
  </action>
  <verify>
```bash
cd /mnt/c/Users/Usuario/Proyectos/morfx-new && npx tsc --noEmit --pretty 2>&1 | head -50
```
TypeScript compiles. The DebugTabs props interface is unchanged, so sandbox-layout.tsx still works.
  </verify>
  <done>
- debug-tabs.tsx uses TabBar + PanelContainer instead of Radix UI Tabs
- Default layout shows Tools + Estado visible (matching CONTEXT.md)
- Max 3 panels enforced
- Tabs can be toggled and reordered
- index.ts exports updated with new components
- No changes needed in sandbox-layout.tsx (same props interface)
  </done>
</task>

</tasks>

<verification>
```bash
cd /mnt/c/Users/Usuario/Proyectos/morfx-new && npx tsc --noEmit --pretty
```
Verify the debug panel renders with the tab bar visible and Tools + Estado panels shown by default.
</verification>

<success_criteria>
1. Tab bar shows 5 tabs: Tools, Estado, Intent, Tokens, Ingest
2. Clicking a tab toggles its visibility
3. Max 3 tabs can be visible simultaneously (4th click is disabled)
4. Tabs can be drag-reordered in the tab bar
5. Visible panels render in responsive grid (1/2/3 columns)
6. Default: Tools + Estado visible
7. slider.tsx component installed
</success_criteria>

<output>
After completion, create `.planning/phases/15.6-sandbox-evolution/15.6-02-SUMMARY.md`
</output>
