---
phase: 14-agente-ventas-somnio
plan: 06
type: execute
wave: 5
depends_on: ["14-05"]
files_modified:
  - src/lib/agents/somnio/order-creator.ts
  - src/lib/agents/somnio/somnio-engine.ts
  - src/lib/agents/somnio/index.ts
  - src/app/api/agents/somnio/route.ts
autonomous: false

must_haves:
  truths:
    - "compra_confirmada creates contact and order in MorfX"
    - "Order includes selected pack and correct price"
    - "Contact created with all captured data fields"
    - "Somnio agent processes messages end-to-end"
    - "API endpoint /api/agents/somnio accepts webhook messages"
  artifacts:
    - path: "src/lib/agents/somnio/order-creator.ts"
      provides: "OrderCreator class for creating contacts and orders on compra_confirmada"
      exports: ["OrderCreator", "OrderCreationResult"]
    - path: "src/lib/agents/somnio/somnio-engine.ts"
      provides: "SomnioEngine extending AgentEngine with Somnio-specific components"
      exports: ["SomnioEngine"]
    - path: "src/app/api/agents/somnio/route.ts"
      provides: "API route for processing Somnio agent messages"
      exports: ["POST"]
  key_links:
    - from: "src/lib/agents/somnio/order-creator.ts"
      to: "crm.contact.create handler"
      via: "executeToolFromAgent"
      pattern: "crm\\.contact\\.create"
    - from: "src/lib/agents/somnio/order-creator.ts"
      to: "crm.order.create handler"
      via: "executeToolFromAgent"
      pattern: "crm\\.order\\.create"
    - from: "src/lib/agents/somnio/somnio-engine.ts"
      to: "src/lib/agents/somnio/order-creator.ts"
      via: "OrderCreator invoked when orchestrator returns shouldCreateOrder=true"
      pattern: "shouldCreateOrder.*orderCreator\\.createContactAndOrder"
    - from: "src/app/api/agents/somnio/route.ts"
      to: "src/lib/agents/somnio/somnio-engine.ts"
      via: "SomnioEngine.processMessage"
      pattern: "somnioEngine\\.processMessage"
---

<objective>
Create the Order Creator component, wire up the complete SomnioEngine, and create the API endpoint for processing Somnio agent messages.

Purpose: This completes the Somnio agent implementation. When a customer confirms purchase, we create the contact and order in MorfX. The API endpoint allows webhook integration.

Output: OrderCreator, SomnioEngine, API route - complete end-to-end flow for Somnio sales agent.
</objective>

<execution_context>
@/home/jose147/.claude/get-shit-done/workflows/execute-plan.md
@/home/jose147/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/14-agente-ventas-somnio/14-CONTEXT.md
@.planning/phases/14-agente-ventas-somnio/14-05-SUMMARY.md
@src/lib/agents/engine.ts
@src/lib/tools/executor.ts
@src/lib/tools/handlers/crm/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Order Creator component</name>
  <files>
    src/lib/agents/somnio/order-creator.ts
  </files>
  <action>
Create src/lib/agents/somnio/order-creator.ts:

1. OrderCreationResult interface:
```typescript
interface OrderCreationResult {
  success: boolean
  contactId?: string
  orderId?: string
  error?: {
    code: string
    message: string
  }
}
```

2. ContactData interface (from captured data):
```typescript
interface ContactData {
  nombre: string
  apellido?: string
  telefono: string
  direccion: string
  ciudad: string
  departamento: string
  barrio?: string
  correo?: string
  indicaciones_extra?: string
}
```

3. OrderData interface:
```typescript
interface OrderData {
  contactId: string
  pack: PackSelection
  price: number
  notes?: string
}
```

4. OrderCreator class:
```typescript
export class OrderCreator {
  constructor(private workspaceId: string) {}

  async createContactAndOrder(
    data: ContactData,
    pack: PackSelection,
    sessionId: string
  ): Promise<OrderCreationResult>

  async findOrCreateContact(
    data: ContactData,
    sessionId: string
  ): Promise<{ contactId: string; isNew: boolean }>

  async createOrder(
    orderData: OrderData,
    sessionId: string
  ): Promise<{ orderId: string }>

  private mapPackToProduct(pack: PackSelection): {
    productName: string
    quantity: number
    price: number
  }
}
```

5. Implementation details:
   - createContactAndOrder:
     1. Find existing contact by phone or create new
     2. Create order with pack details
     3. Return both IDs
   - findOrCreateContact:
     - Use crm.contact.list with phone filter first
     - If exists, update with new data via crm.contact.update
     - If not, create via crm.contact.create
     - Return contactId and isNew flag
   - createOrder:
     - Map pack to product: '1x' -> 1 unit, '2x' -> 2 units, '3x' -> 3 units
     - Use SOMNIO_PRICES for values
     - Call crm.order.create with contactId and product details
   - mapPackToProduct:
     - '1x': { productName: 'Somnio 90 Caps', quantity: 1, price: 77900 }
     - '2x': { productName: 'Somnio 90 Caps x2', quantity: 2, price: 109900 }
     - '3x': { productName: 'Somnio 90 Caps x3', quantity: 3, price: 139900 }
   - All tool calls via executeToolFromAgent with agentSessionId for tracing
  </action>
  <verify>
```bash
cd /mnt/c/Users/Usuario/Proyectos/morfx-new && npx tsc --noEmit
```
TypeScript compiles. OrderCreator uses Action DSL tools correctly.
  </verify>
  <done>
OrderCreator component created that:
- Finds or creates contact by phone
- Updates contact with captured data
- Creates order with pack and correct price
- Uses Action DSL tools with agent tracing
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Somnio Engine and API route</name>
  <files>
    src/lib/agents/somnio/somnio-engine.ts
    src/lib/agents/somnio/index.ts
    src/app/api/agents/somnio/route.ts
  </files>
  <action>
Create src/lib/agents/somnio/somnio-engine.ts:

1. SomnioEngine class extending/composing AgentEngine:
```typescript
export class SomnioEngine {
  private baseEngine: AgentEngine
  private orchestrator: SomnioOrchestrator
  private messageSequencer: MessageSequencer
  private orderCreator: OrderCreator

  constructor(workspaceId: string, options?: {
    baseEngine?: AgentEngine
    orchestrator?: SomnioOrchestrator
    messageSequencer?: MessageSequencer
  }) {
    this.baseEngine = options?.baseEngine ?? new AgentEngine()
    this.orchestrator = options?.orchestrator ?? new SomnioOrchestrator(new ClaudeClient())
    this.messageSequencer = options?.messageSequencer ?? new MessageSequencer(new SessionManager())
    this.orderCreator = new OrderCreator(workspaceId)
  }

  async processMessage(input: ProcessMessageInput): Promise<SomnioEngineResult>

  async getOrCreateSession(
    conversationId: string,
    contactId: string
  ): Promise<string>
}
```

2. SomnioEngineResult interface:
```typescript
interface SomnioEngineResult {
  success: boolean
  response?: string
  messagesSent?: number
  orderCreated?: boolean
  orderId?: string
  contactId?: string
  newMode?: string
  tokensUsed?: number
  error?: {
    code: string
    message: string
    retryable: boolean
  }
}
```

3. processMessage implementation:
   1. Get or create session for conversation
   2. Use base engine's intent detection flow
   3. Use SomnioOrchestrator instead of base orchestrator
   4. If result has templates, use MessageSequencer to send
   5. **CRITICAL WIRING: Check orchestrator result for shouldCreateOrder flag**
      - If shouldCreateOrder === true:
        - Extract datosCapturados from session state
        - Get packSeleccionado from session state
        - Call orderCreator.createContactAndOrder(datosCapturados, pack, sessionId)
        - Include orderId and contactId in result
   6. Update session state with all changes
   7. Return comprehensive result

4. Order creation wiring pseudocode:
```typescript
// In processMessage, after orchestration:
if (orchestratorResult.shouldCreateOrder) {
  const { datosCapturados, packSeleccionado } = session.state
  const orderResult = await this.orderCreator.createContactAndOrder(
    datosCapturados as ContactData,
    packSeleccionado,
    session.id
  )
  if (orderResult.success) {
    result.orderCreated = true
    result.orderId = orderResult.orderId
    result.contactId = orderResult.contactId
  }
}
```

Create src/app/api/agents/somnio/route.ts:

1. POST handler:
```typescript
export async function POST(request: Request) {
  // Validate request body
  const body = await request.json()
  const { conversationId, contactId, messageContent, workspaceId, phoneNumber } = body

  // Validate required fields
  if (!conversationId || !messageContent || !workspaceId) {
    return NextResponse.json({ error: 'Missing required fields' }, { status: 400 })
  }

  // Process message
  const engine = new SomnioEngine(workspaceId)
  const result = await engine.processMessage({
    conversationId,
    contactId,
    messageContent,
    workspaceId,
    phoneNumber,
  })

  // Return result
  return NextResponse.json(result)
}
```

2. Request validation with Zod schema
3. Error handling with proper HTTP status codes
4. Logging with createModuleLogger

Update src/lib/agents/somnio/index.ts:
- Export SomnioEngine, SomnioEngineResult
- Export OrderCreator, OrderCreationResult
  </action>
  <verify>
```bash
cd /mnt/c/Users/Usuario/Proyectos/morfx-new && npx tsc --noEmit
```
TypeScript compiles. API route exists and handles POST requests.
  </verify>
  <done>
SomnioEngine and API route created that:
- Process messages through complete Somnio flow
- Use SomnioOrchestrator for flow logic
- Send messages via MessageSequencer with delays
- **Wire shouldCreateOrder from orchestrator to OrderCreator.createContactAndOrder**
- Create contacts and orders on compra_confirmada
- Expose /api/agents/somnio endpoint
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete Somnio Sales Agent implementation:
- Database schema for templates
- 20 intents with prompts
- Data extraction with normalization
- Template management with variable substitution
- Message sequencing with delays and interruption handling
- Transition validation and flow logic
- Order creation on purchase confirmation
- API endpoint for message processing
  </what-built>
  <how-to-verify>
1. Start the dev server: `npm run dev`
2. Insert test templates into agent_templates table via Supabase Studio
3. Test API endpoint:
```bash
curl -X POST http://localhost:3020/api/agents/somnio \
  -H "Content-Type: application/json" \
  -d '{
    "conversationId": "test-conv-id",
    "contactId": "test-contact-id",
    "messageContent": "Hola, cuanto cuesta?",
    "workspaceId": "your-workspace-id"
  }'
```
4. Verify response includes templates for 'hola+precio' intent
5. Check that session was created in agent_sessions table
6. Test data extraction:
   - Send message with customer data
   - Verify datos_capturados updates in session_state
7. Test transition blocking:
   - Try to confirm purchase without seeing promos first
   - Should receive blocking response
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues found</resume-signal>
</task>

</tasks>

<verification>
1. OrderCreator uses Action DSL tools correctly
2. SomnioEngine orchestrates complete flow
3. SomnioEngine wires shouldCreateOrder to OrderCreator
4. API route validates input and handles errors
5. Sessions created and tracked correctly
6. Tool execution logs captured for tracing
7. Human verification of end-to-end flow
</verification>

<success_criteria>
- compra_confirmada creates contact and order
- Order has correct pack and price
- SomnioEngine processes messages end-to-end
- shouldCreateOrder flag properly wired to OrderCreator
- API endpoint accessible at /api/agents/somnio
- Error handling with proper HTTP status codes
- Human verified complete flow works
</success_criteria>

<output>
After completion, create `.planning/phases/14-agente-ventas-somnio/14-06-SUMMARY.md`
</output>
