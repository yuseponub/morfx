---
phase: 15.6-sandbox-evolution
plan: 01
subsystem: agents, sandbox
tags: [typescript, types, per-model-tokens, crm-agents, ingest-timeline, debug-panels]

# Dependency graph
requires:
  - phase: 15-agent-sandbox
    provides: SandboxEngine, DebugTurn, TokenInfo types
  - phase: 15.5-somnio-ingest
    provides: IngestStatus, MessageClassifier, IngestManager
  - phase: 13-agent-engine-core
    provides: ClaudeClient, IntentDetector, ModelTypes
provides:
  - ModelTokenEntry type for per-model token tracking
  - TokenInfo.models array for per-model breakdown in DebugTurn
  - CrmAgentState, CrmCommandResult, CrmExecutionMode types
  - IngestTimelineEntry type and IngestStatus.timeline
  - DebugPanelTabId and DebugPanelTab types for multi-panel debug UI
  - ClaudeClient returning tokenDetail on all methods
  - IntentDetector returning tokenDetails array
  - SandboxEngine propagating per-model tokens to DebugTurn
affects:
  - 15.6-02 (Tokens tab UI needs ModelTokenEntry/TokenInfo.models)
  - 15.6-03 (CRM agent panel needs CrmAgentState/CrmCommandResult)
  - 15.6-04 (Ingest timeline uses IngestTimelineEntry)
  - 15.6-05 (Multi-panel debug uses DebugPanelTabId/DebugPanelTab)

# Tech tracking
tech-stack:
  added: []
  patterns:
    - "Per-model token tracking via ModelTokenEntry alongside total tokensUsed"
    - "Approximate input/output split for orchestrator (70/30) when exact split unavailable"
    - "Timeline accumulation pattern for ingest classification entries"

key-files:
  created: []
  modified:
    - src/lib/agents/types.ts
    - src/lib/sandbox/types.ts
    - src/lib/agents/claude-client.ts
    - src/lib/agents/intent-detector.ts
    - src/lib/sandbox/sandbox-engine.ts

key-decisions:
  - "ModelTokenEntry uses ClaudeModel type for model field (type-safe model identity)"
  - "Orchestrator token split approximated as 70/30 input/output since SomnioOrchestrator doesn't expose split"
  - "IngestStatus.timeline is required (not optional) to simplify consumer code"
  - "tokenDetails returned as array from IntentDetector to support reanalyze multi-call scenarios"
  - "No changes to production SomnioOrchestrator/SomnioEngine - only sandbox pipeline gets per-model tracking"

patterns-established:
  - "Backward-compatible extension: add new fields alongside existing ones (tokensUsed + tokenDetail)"
  - "Per-model tracking pattern: collect ModelTokenEntry[] array, push entries from each Claude call"

# Metrics
duration: 8min
completed: 2026-02-07
---

# Phase 15.6 Plan 01: Foundation Types Summary

**Per-model token tracking types (ModelTokenEntry) propagated through ClaudeClient -> IntentDetector -> SandboxEngine -> DebugTurn, plus CRM agent, ingest timeline, and multi-panel debug types**

## Performance

- **Duration:** 8 min
- **Started:** 2026-02-07T21:18:28Z
- **Completed:** 2026-02-07T21:27:00Z
- **Tasks:** 3
- **Files modified:** 5

## Accomplishments
- ModelTokenEntry type defined in agents/types.ts with model, inputTokens, outputTokens
- ClaudeClient.detectIntent, orchestrate, and streamResponse all return tokenDetail: ModelTokenEntry
- IntentDetector.detect returns tokenDetails: ModelTokenEntry[] for multi-call scenarios
- SandboxEngine collects and propagates per-model token details to DebugTurn.tokens.models in all code paths
- IngestStatus.timeline populated with classification entries during handleIngestMode and checkImplicitYes
- CRM agent types (CrmAgentState, CrmCommandResult, CrmExecutionMode) defined for future plans
- Multi-panel debug types (DebugPanelTabId, DebugPanelTab) defined for future plans

## Task Commits

Each task was committed atomically:

1. **Task 1: Extend type definitions** - `7119510` (feat)
2. **Task 2: Add per-model token detail to ClaudeClient and IntentDetector** - `bbee12a` (feat)
3. **Task 3: Propagate token detail through SandboxEngine** - `977d445` (feat)

## Files Created/Modified
- `src/lib/agents/types.ts` - Added ModelTokenEntry interface in new Per-Model Token Tracking section
- `src/lib/sandbox/types.ts` - Extended TokenInfo with models array, added CRM/ingest/panel types, updated IngestStatus with timeline
- `src/lib/agents/claude-client.ts` - Added tokenDetail to return of detectIntent, orchestrate, streamResponse
- `src/lib/agents/intent-detector.ts` - Added tokenDetails: ModelTokenEntry[] to IntentDetectionResult and detect method
- `src/lib/sandbox/sandbox-engine.ts` - Propagates tokenDetails through all code paths, populates timeline entries

## Decisions Made
- ModelTokenEntry uses ClaudeModel type (not string) for type-safe model identity
- Orchestrator token split approximated as 70% input / 30% output since SomnioOrchestrator doesn't expose the split (acceptable for Phase 15.6)
- IngestStatus.timeline is a required field (not optional) to simplify consumer code and avoid null checks
- No changes to production code paths (SomnioOrchestrator, SomnioEngine, DataExtractor, MessageClassifier) - only sandbox pipeline gets per-model tracking
- Downstream consumers verified: all use destructuring that ignores extra fields, no changes needed

## Deviations from Plan

None - plan executed exactly as written.

## Issues Encountered
None

## User Setup Required
None - no external service configuration required.

## Next Phase Readiness
- All foundation types defined and exported, ready for Plans 02-06
- TokenInfo.models available for Tokens tab UI (Plan 02)
- CRM types available for CRM agent panel (Plan 03)
- IngestTimelineEntry available for ingest timeline (Plan 04)
- DebugPanelTabId/DebugPanelTab available for multi-panel debug (Plan 05)
- No blockers or concerns

---
*Phase: 15.6-sandbox-evolution*
*Completed: 2026-02-07*
