---
phase: 10.1-task-notes-history
plan: 04
type: execute
wave: 4
depends_on: ["10.1-03"]
files_modified:
  - src/app/(dashboard)/tareas/components/task-detail-sheet.tsx
  - src/app/(dashboard)/tareas/components/task-list.tsx
autonomous: false
user_setup: []

must_haves:
  truths:
    - "User can view notes on a task detail sheet"
    - "User can add notes from task detail"
    - "User can view complete change history for a task"
    - "Task detail shows postponement indicator"
  artifacts:
    - path: "src/app/(dashboard)/tareas/components/task-detail-sheet.tsx"
      provides: "Sheet view with notes and history tabs"
      exports: ["TaskDetailSheet"]
  key_links:
    - from: "src/app/(dashboard)/tareas/components/task-detail-sheet.tsx"
      to: "src/components/tasks/task-notes.tsx"
      via: "TaskNotesSection component in Notas tab"
      pattern: "TaskNotesSection"
    - from: "src/app/(dashboard)/tareas/components/task-detail-sheet.tsx"
      to: "src/components/tasks/task-history.tsx"
      via: "TaskHistoryTimeline component in Historial tab"
      pattern: "TaskHistoryTimeline"
    - from: "src/app/(dashboard)/tareas/components/task-list.tsx"
      to: "src/app/(dashboard)/tareas/components/task-detail-sheet.tsx"
      via: "TaskDetailSheet opened on task click"
      pattern: "TaskDetailSheet"
---

<objective>
Create task detail sheet with notes section and history timeline as tabs.

Purpose: Users can view and manage task notes and see the complete change history, including all postponements. The detail view uses Sheet pattern (consistent with existing task-list.tsx edit pattern).

Output: TaskDetailSheet component with Info, Notas, and Historial tabs, integrated into task-list.tsx.
</objective>

<execution_context>
@/home/jose147/.claude/get-shit-done/workflows/execute-plan.md
@/home/jose147/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10.1-task-notes-history/10.1-RESEARCH.md
@.planning/phases/10.1-task-notes-history/10.1-03-SUMMARY.md

# Key reference files
@src/app/(dashboard)/tareas/components/task-list.tsx
@src/components/tasks/task-notes.tsx
@src/components/tasks/task-history.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create TaskDetailSheet component</name>
  <files>src/app/(dashboard)/tareas/components/task-detail-sheet.tsx</files>
  <action>
**Decision: Use Sheet pattern** (not dedicated page). The existing task-list.tsx uses Sheet for task editing (lines 297-318). This maintains UI consistency.

Create new file `src/app/(dashboard)/tareas/components/task-detail-sheet.tsx`:

```typescript
'use client'

import * as React from 'react'
import {
  Sheet,
  SheetContent,
  SheetHeader,
  SheetTitle,
} from '@/components/ui/sheet'
import { Tabs, TabsContent, TabsList, TabsTrigger } from '@/components/ui/tabs'
import { TaskNotesSection } from '@/components/tasks/task-notes'
import { TaskHistoryTimeline } from '@/components/tasks/task-history'
import { PostponementBadge } from '@/components/tasks/postponement-badge'
import { getTaskNotes } from '@/app/actions/task-notes'
import { getTaskActivity } from '@/app/actions/task-activity'
import type { TaskWithDetails, TaskNoteWithUser, TaskActivityWithUser } from '@/lib/tasks/types'

interface TaskDetailSheetProps {
  task: TaskWithDetails | null
  open: boolean
  onOpenChange: (open: boolean) => void
  currentUserId?: string
  isAdminOrOwner?: boolean
}

export function TaskDetailSheet({
  task,
  open,
  onOpenChange,
  currentUserId,
  isAdminOrOwner = false,
}: TaskDetailSheetProps) {
  const [notes, setNotes] = React.useState<TaskNoteWithUser[]>([])
  const [activities, setActivities] = React.useState<TaskActivityWithUser[]>([])
  const [loading, setLoading] = React.useState(false)

  // Load notes and activities when task changes
  React.useEffect(() => {
    if (task && open) {
      setLoading(true)
      Promise.all([
        getTaskNotes(task.id),
        getTaskActivity(task.id),
      ]).then(([notesData, activitiesData]) => {
        setNotes(notesData)
        setActivities(activitiesData)
        setLoading(false)
      })
    }
  }, [task?.id, open])

  if (!task) return null

  return (
    <Sheet open={open} onOpenChange={onOpenChange}>
      <SheetContent className="sm:max-w-[600px] flex flex-col h-full">
        <SheetHeader>
          <SheetTitle className="flex items-center gap-2">
            {task.title}
            <PostponementBadge count={task.postponement_count} />
          </SheetTitle>
        </SheetHeader>

        <Tabs defaultValue="info" className="flex-1 flex flex-col min-h-0">
          <TabsList className="grid w-full grid-cols-3">
            <TabsTrigger value="info">Info</TabsTrigger>
            <TabsTrigger value="notes">
              Notas {notes.length > 0 && `(${notes.length})`}
            </TabsTrigger>
            <TabsTrigger value="history">Historial</TabsTrigger>
          </TabsList>

          <TabsContent value="info" className="flex-1 overflow-y-auto">
            <TaskInfoSection task={task} />
          </TabsContent>

          <TabsContent value="notes" className="flex-1 overflow-y-auto">
            {loading ? (
              <div className="animate-pulse space-y-4 p-4">
                <div className="h-20 bg-muted rounded" />
                <div className="h-20 bg-muted rounded" />
              </div>
            ) : (
              <TaskNotesSection
                taskId={task.id}
                initialNotes={notes}
                currentUserId={currentUserId}
                isAdminOrOwner={isAdminOrOwner}
              />
            )}
          </TabsContent>

          <TabsContent value="history" className="flex-1 overflow-y-auto">
            {loading ? (
              <div className="animate-pulse space-y-4 p-4">
                <div className="h-16 bg-muted rounded" />
                <div className="h-16 bg-muted rounded" />
              </div>
            ) : (
              <TaskHistoryTimeline activities={activities} />
            )}
          </TabsContent>
        </Tabs>
      </SheetContent>
    </Sheet>
  )
}

// Helper component for task info display
function TaskInfoSection({ task }: { task: TaskWithDetails }) {
  return (
    <div className="space-y-4 p-4">
      {task.description && (
        <div>
          <h4 className="text-sm font-medium text-muted-foreground mb-1">Descripcion</h4>
          <p className="text-sm whitespace-pre-wrap">{task.description}</p>
        </div>
      )}
      {task.due_date && (
        <div>
          <h4 className="text-sm font-medium text-muted-foreground mb-1">Fecha limite</h4>
          <p className="text-sm">
            {new Date(task.due_date).toLocaleString('es-CO', {
              dateStyle: 'full',
              timeStyle: 'short',
              timeZone: 'America/Bogota',
            })}
          </p>
        </div>
      )}
      {task.task_type && (
        <div>
          <h4 className="text-sm font-medium text-muted-foreground mb-1">Tipo</h4>
          <div className="flex items-center gap-2">
            <span
              className="h-2 w-2 rounded-full"
              style={{ backgroundColor: task.task_type.color }}
            />
            {task.task_type.name}
          </div>
        </div>
      )}
      {task.assigned_user && (
        <div>
          <h4 className="text-sm font-medium text-muted-foreground mb-1">Asignado a</h4>
          <p className="text-sm">{task.assigned_user.email}</p>
        </div>
      )}
      {(task.contact || task.order || task.conversation) && (
        <div>
          <h4 className="text-sm font-medium text-muted-foreground mb-1">Vinculada a</h4>
          <p className="text-sm">
            {task.contact && `Contacto: ${task.contact.name}`}
            {task.order && `Pedido: $${task.order.total_value.toLocaleString()}`}
            {task.conversation && `Conversacion: ${task.conversation.phone}`}
          </p>
        </div>
      )}
    </div>
  )
}
```

**Key implementation details:**
- Uses Sheet component (same as existing edit flow)
- Three tabs: Info, Notas, Historial
- Loads notes and activities on open via useEffect
- PostponementBadge in header next to title
- Loading skeletons while fetching data
- TaskInfoSection helper for task metadata display
- Tabs use flex-1 + overflow-y-auto for proper scrolling
  </action>
  <verify>
```bash
# Check component exists with exports
grep -E "(export function TaskDetailSheet|TaskNotesSection|TaskHistoryTimeline|TabsList)" /mnt/c/Users/Usuario/Proyectos/morfx-new/src/app/\(dashboard\)/tareas/components/task-detail-sheet.tsx
```
  </verify>
  <done>
src/app/(dashboard)/tareas/components/task-detail-sheet.tsx exists with:
- TaskDetailSheet component using Sheet pattern
- Three tabs (Info, Notas, Historial)
- PostponementBadge in header
- TaskNotesSection in Notas tab
- TaskHistoryTimeline in Historial tab
- Loading states
- TaskInfoSection helper
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate TaskDetailSheet into task-list.tsx</name>
  <files>src/app/(dashboard)/tareas/components/task-list.tsx</files>
  <action>
Modify `src/app/(dashboard)/tareas/components/task-list.tsx` to add task detail viewing functionality.

**Step 1:** Add import at top (after line 27, with other component imports):
```typescript
import { TaskDetailSheet } from './task-detail-sheet'
```

**Step 2:** Add state for detail sheet (after line 117, with other state declarations):
```typescript
  // Detail sheet state
  const [detailSheetOpen, setDetailSheetOpen] = React.useState(false)
  const [selectedTask, setSelectedTask] = React.useState<TaskWithDetails | null>(null)
```

**Step 3:** Add handler for viewing task details (after handleFormClose around line 198):
```typescript
  const handleViewDetails = (task: TaskWithDetails) => {
    setSelectedTask(task)
    setDetailSheetOpen(true)
  }

  const handleDetailSheetClose = () => {
    setDetailSheetOpen(false)
    setSelectedTask(null)
  }
```

**Step 4:** Modify TaskItem usage to handle click for viewing (in the task mapping around lines 282-289). The TaskItem component already exists and handles onEdit/onDelete. We need to add an onClick handler to view details.

Replace the TaskItem rendering:
```typescript
                  <TaskItem
                    key={task.id}
                    task={task}
                    onEdit={handleEdit}
                    onDelete={handleDelete}
                    onClick={() => handleViewDetails(task)}
                  />
```

Note: This requires TaskItem to accept and use onClick prop. If TaskItem doesn't support onClick, wrap it:
```typescript
                  <div
                    key={task.id}
                    onClick={() => handleViewDetails(task)}
                    className="cursor-pointer"
                  >
                    <TaskItem
                      task={task}
                      onEdit={handleEdit}
                      onDelete={handleDelete}
                    />
                  </div>
```

**Step 5:** Add TaskDetailSheet component at the end of the return statement (before the closing `</>`, after the AlertDialog around line 341):
```typescript
      {/* Task Detail Sheet */}
      <TaskDetailSheet
        task={selectedTask}
        open={detailSheetOpen}
        onOpenChange={handleDetailSheetClose}
      />
```

**Integration summary:**
- Clicking a task opens detail sheet
- Edit/Delete actions still work via dropdown menu
- Detail sheet shows Info, Notas, Historial tabs
  </action>
  <verify>
```bash
# Check TaskDetailSheet is imported and used
grep -E "(import.*TaskDetailSheet|TaskDetailSheet|detailSheetOpen|handleViewDetails)" /mnt/c/Users/Usuario/Proyectos/morfx-new/src/app/\(dashboard\)/tareas/components/task-list.tsx
```
  </verify>
  <done>
task-list.tsx integrates TaskDetailSheet with:
- Import added
- State for detailSheetOpen and selectedTask
- handleViewDetails and handleDetailSheetClose handlers
- TaskItem click handler to open detail sheet
- TaskDetailSheet component rendered
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete task notes and history system with visual postponement tracking.

The phase adds:
1. Notes on tasks (create, edit, delete)
2. Automatic change history tracking via PostgreSQL trigger
3. Postponement badge showing when due dates are moved forward
4. Task detail sheet with Notas and Historial tabs
  </what-built>
  <how-to-verify>
1. Start the dev server:
   ```bash
   cd /mnt/c/Users/Usuario/Proyectos/morfx-new
   pkill -f "next dev" 2>/dev/null; sleep 2; npm run dev &
   ```

2. Ensure migration is applied:
   ```bash
   pnpm supabase db push
   ```

3. Navigate to http://localhost:3020/tareas

4. **Test detail sheet opening:**
   - Click on any task in the list
   - A side sheet should open with the task title and tabs
   - Verify PostponementBadge appears next to title (if postponed)

5. **Test notes functionality:**
   - Click "Notas" tab
   - Add a new note - should appear immediately
   - Edit the note - changes should save
   - Delete the note - should be removed

6. **Test history functionality:**
   - Click "Historial" tab
   - Should show "Tarea creada" entry
   - Edit the task (via dropdown menu -> Editar, change title or priority)
   - Re-open detail sheet, history should show "Tarea actualizada" with the change
   - Add/edit/delete notes - history should show note actions

7. **Test postponement tracking:**
   - Edit task and move due date forward (to later date)
   - History should show "Fecha limite cambiada"
   - PostponementBadge in detail header should show "1x" in yellow
   - Move date forward again - should show "2x"
   - Move forward third time - badge turns red "3x"

8. **Verify all success criteria from ROADMAP:**
   - [x] User puede agregar notas a una tarea
   - [x] Sistema registra automaticamente cambios de fecha limite
   - [x] User puede ver historial de cambios en la tarea
   - [x] Se muestra indicador visual cuando tarea postergada multiples veces

Expected behavior:
- Notes CRUD works with optimistic updates
- History shows all changes with Spanish labels
- Postponement badge appears only for postponed tasks
- Yellow for 1-2, red for 3+ postponements
  </how-to-verify>
  <resume-signal>Type "approved" if all functionality works, or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
After all tasks complete:
1. TaskDetailSheet component exists with tabbed interface
2. task-list.tsx integrates TaskDetailSheet
3. Clicking task opens detail sheet
4. Notes can be added, edited, deleted
5. History shows all task changes
6. Postponement badge visible in detail header
7. Human verification passed
</verification>

<success_criteria>
- User can add/edit/delete notes on tasks
- History timeline shows all changes with icons
- Postponement badge shows in task detail header
- Tab navigation works smoothly
- Loading states prevent UI jank
- All four ROADMAP success criteria are met
</success_criteria>

<output>
After completion, create `.planning/phases/10.1-task-notes-history/10.1-04-SUMMARY.md`
</output>
