# Phase 15.8: Codebase Cleanup - Research

**Researched:** 2026-02-09
**Domain:** Bug fixes, security hardening, code consolidation (internal codebase refactoring)
**Confidence:** HIGH

## Summary

This phase addresses 16 bugs, 11 security vulnerabilities, 7 duplicate code categories, and 5 consistency issues identified in the deep codebase audit. The research focused on verifying each audit finding against the **current** codebase state (as of 2026-02-09), identifying accurate line numbers, understanding dependency chains between fixes, and documenting the exact patterns needed for safe remediation.

Key findings from verification:
- **All 16 bugs confirmed** - line numbers mostly accurate (some shifted due to Phase 15.7 changes). File locations corrected for `ingest-timer.ts` (in `src/lib/sandbox/`, not `src/lib/agents/somnio/`).
- **TypeScript compiles clean** - only errors are in `.next/dev/types/validator.ts` (auto-generated). Source code has zero TS errors, so each fix can be verified with `tsc --noEmit`.
- **.env.local never committed to git** - Security finding #1 (hardcoded secrets) is LOW urgency since no git history exposure.
- **3 files import `createAdminClient` from `server.ts`** - usage.ts, super-admin.ts, messages.ts. All others use `admin.ts`.
- **Some audit bugs need re-evaluation** - Bug #5 (ingest-timer stale closure) may already be fixed by `contextProvider` pattern. Bug #8 (timer signal override) needs careful analysis of the `justCompletedIngest` logic added in Phase 15.7.

**Primary recommendation:** Fix bugs atomically in severity order (critical > high > medium), verify with `tsc --noEmit` after each change, then tackle security and duplicates. Group only truly independent fixes.

## Standard Stack

This phase is purely internal codebase refactoring. No new libraries needed.

### Core
| Library | Version | Purpose | Why Used |
|---------|---------|---------|----------|
| TypeScript | (existing) | Type safety verification | `tsc --noEmit` validates all changes |
| Next.js 15 | (existing) | App Router, API routes | Security fixes affect route handlers |
| Supabase | (existing) | Auth, DB, RLS | Security fixes involve auth checks |
| crypto (Node.js) | built-in | HMAC verification | WhatsApp webhook signature verification |

### Supporting
| Library | Version | Purpose | When to Use |
|---------|---------|---------|-------------|
| libphonenumber-js | (existing) | Phone normalization | Consolidation target - canonical implementation |

### Alternatives Considered
| Instead of | Could Use | Tradeoff |
|------------|-----------|----------|
| Custom HMAC verification | Express middleware | Custom is fine - Shopify already has a working pattern to copy |
| Rate limiting library | Vercel Edge Config / Upstash | Defer to future phase - not in scope for 15.8 |

## Architecture Patterns

### Pattern 1: Stale Closure Fix via useRef
**What:** Replace direct state references in async callbacks with `useRef` + `useEffect` sync pattern.
**When to use:** Bugs #1, #2, #3 (sandbox-layout.tsx)
**Verification:** Already used in the same file for `timerEnabledRef`, `stateRef`, `simulatorRef`. Extend the pattern.

```typescript
// ALREADY EXISTS in sandbox-layout.tsx (verified):
// stateRef, timerEnabledRef, timerExpireRef, simulatorRef

// NEED TO ADD for bugs #1, #2, #3:
const messagesRef = useRef(messages)
useEffect(() => { messagesRef.current = messages }, [messages])

const debugTurnsRef = useRef(debugTurns)
useEffect(() => { debugTurnsRef.current = debugTurns }, [debugTurns])

const crmAgentsRef = useRef(crmAgents)
useEffect(() => { crmAgentsRef.current = crmAgents }, [crmAgents])

// Then in handleSendMessage callback:
const history = messagesRef.current.map(m => ({ role: m.role, content: m.content }))
const turnNumber = debugTurnsRef.current.length + 1
const enabledCrmAgents = crmAgentsRef.current.filter(a => a.enabled)...
```

**File:** `src/app/(dashboard)/sandbox/components/sandbox-layout.tsx`
**Current lines:** ~385 (history), ~395 (turnNumber), ~389 (crmAgents)

### Pattern 2: Immutable State Return
**What:** Return new state objects instead of mutating input parameters.
**When to use:** Bug #4 (sandbox-engine.ts)
**Caution:** The mutation pattern is INTENTIONAL in `handleIngestMode` and `checkImplicitYes` - it communicates state changes to the caller (processMessage). The fix must preserve this communication channel.

```typescript
// CURRENT (mutation):
currentState.currentMode = 'ofrecer_promos'
currentState.datosCapturados = mergedData
return null  // caller checks currentState.currentMode

// FIX APPROACH: Return new state instead of mutating
// But the caller (processMessage) needs to detect the transition.
// Safest: add explicit return signal instead of side-effect mutation
```

**Key insight:** This bug is more nuanced than the audit suggests. The mutation is the mechanism for `processMessage` to detect transitions from `handleIngestMode`/`checkImplicitYes`. A pure immutability fix requires restructuring the return type.

### Pattern 3: Optional Chaining for Null Safety
**What:** Add `?.` and `?? defaultValue` for potentially null property access.
**When to use:** Bugs #7, #12

```typescript
// Bug #7: sandbox-layout.tsx line ~435
result.debugTurn.tokens?.tokensUsed ?? 0

// Bug #12: order-manager/agent.ts line ~196
if (Array.isArray(contacts) && contacts.length > 0) {
```

### Pattern 4: Auth + Workspace Verification
**What:** Add authentication check and workspace membership verification to API routes.
**When to use:** Security #4 (sandbox API), Security #3 (server actions)

```typescript
// For sandbox API route (src/app/api/sandbox/process/route.ts):
import { createClient } from '@/lib/supabase/server'

export async function POST(request: NextRequest) {
  const supabase = await createClient()
  const { data: { user } } = await supabase.auth.getUser()
  if (!user) {
    return NextResponse.json({ error: 'Authentication required' }, { status: 401 })
  }
  // ... rest of handler
}
```

### Pattern 5: HMAC Webhook Verification
**What:** Verify cryptographic signature on incoming webhook requests.
**When to use:** Security #2 (WhatsApp webhook)
**Reference:** Copy pattern from existing `src/app/api/webhooks/shopify/route.ts` which already implements `verifyShopifyHmac()`.

```typescript
// Need to verify 360dialog's signature header
// Header name: likely 'X-Hub-Signature-256' (Meta/WhatsApp Cloud API standard)
// or check 360dialog-specific docs
import crypto from 'crypto'

function verifyWhatsAppHmac(body: string, signature: string, secret: string): boolean {
  const hmac = crypto.createHmac('sha256', secret)
  hmac.update(body)
  const digest = 'sha256=' + hmac.digest('hex')
  return crypto.timingSafeEqual(Buffer.from(signature), Buffer.from(digest))
}
```

### Anti-Patterns to Avoid
- **Mutating function parameters** (Bug #4): Always return new objects. If caller needs to detect change, use explicit return values.
- **Capturing React state in async callbacks** (Bugs #1-3): Always use refs for values read inside async closures.
- **Hardcoded model strings** (Bug #10): Use constants from config.
- **Duplicate constants across files** (CRITICAL_FIELDS): Single source of truth.
- **Duplicate utility implementations** (phone normalizers): One canonical implementation.

## Don't Hand-Roll

| Problem | Don't Build | Use Instead | Why |
|---------|-------------|-------------|-----|
| Phone normalization | 4 separate implementations | Single `src/lib/utils/phone.ts` with multiple exports | Already has libphonenumber-js, handles edge cases |
| HMAC verification | Custom from scratch | Copy `verifyShopifyHmac` pattern from existing Shopify webhook | Already tested, uses `timingSafeEqual` |
| Admin client | Two implementations in different files | Single `src/lib/supabase/admin.ts`, re-export from server.ts | Identical code, just consolidate |
| Workspace auth check | Inline per-file | Helper function `verifyWorkspaceMembership(userId, workspaceId)` | Used in 3+ security fixes |

## Common Pitfalls

### Pitfall 1: Breaking the Mutation Communication Channel (Bug #4)
**What goes wrong:** Removing state mutation in `handleIngestMode`/`checkImplicitYes` without replacing the communication mechanism causes the caller (`processMessage`) to lose track of mode transitions.
**Why it happens:** The mutation pattern is intentional - `processMessage` checks `currentState.currentMode` after calling these methods to detect transitions.
**How to avoid:** Either (a) change the return type to include the new state, or (b) keep a minimal mutation but document it explicitly.
**Warning signs:** After fixing, `justCompletedIngest` logic in `processMessage` stops working.

### Pitfall 2: Phone Normalizer Return Type Mismatch
**What goes wrong:** `normalizers.ts` returns `string` (raw digits), `phone.ts` returns `string | null` (E.164 with `+`). Swapping one for the other breaks callers that expect the old format.
**Why it happens:** Different normalizers have different contracts.
**How to avoid:** Add a `normalizePhoneRaw()` export that strips `+` for backward compatibility. Update imports incrementally.
**Warning signs:** Contact matching fails because phone format changed.

### Pitfall 3: Auth Check in Sandbox Breaks Dev Experience
**What goes wrong:** Adding auth to `/api/sandbox/process` means the sandbox page must have an authenticated session cookie. If the dev session expires, sandbox stops working with no clear error.
**Why it happens:** Sandbox is an internal tool, auth wasn't originally needed.
**How to avoid:** Ensure sandbox page (which is behind auth middleware already) properly handles session refresh. Add clear error message for 401 responses.
**Warning signs:** Sandbox silently stops responding after session timeout.

### Pitfall 4: Circular Dependencies in Constants Consolidation
**What goes wrong:** Creating `constants.ts` that imports from or is imported by files that already have complex import chains can create circular dependencies.
**Why it happens:** `data-extractor.ts` is imported by `ingest-manager.ts`, which is imported by `sandbox-engine.ts` and `somnio-engine.ts`.
**How to avoid:** `constants.ts` should have ZERO imports from other project files. Only export primitive values.
**Warning signs:** Runtime errors about undefined imports, or TypeScript errors about circular references.

### Pitfall 5: Bug #8 Timer Signal Override May Already Be Fixed
**What goes wrong:** The audit says cancel signal at line 537 gets overridden by start at line 316. But Phase 15.7 added `lastTimerSignal` pattern that may have already addressed this.
**Why it happens:** The audit was done before Phase 15.7 was complete.
**How to avoid:** Re-read the actual current code path carefully before changing anything. Trace the flow: `handleIngestMode` returns null on 'complete' -> sets `lastTimerSignal = cancel` -> `processMessage` continues -> line 316 checks `justCompletedIngest` and sets `start`.
**Warning signs:** The "override" is actually CORRECT behavior for Level 3 timer (promos sin respuesta). Removing it would break the timer system.

### Pitfall 6: Security Fix Scope Creep
**What goes wrong:** Trying to implement the full security recommendation (MFA, audit logging, DB-backed admin roles) when the fix should be minimal and targeted.
**Why it happens:** The audit recommends ideal-state solutions that are disproportionate to current threat model.
**How to avoid:** Focus on the 3 actionable security fixes: (1) sandbox auth, (2) webhook HMAC, (3) workspace isolation in server actions. Defer rate limiting, CSP headers, super admin overhaul.
**Warning signs:** Creating new database tables, new middleware layers, or new auth flows.

## Code Examples

### Verified: Stale Closure Fix Pattern (from existing codebase)
```typescript
// Source: src/app/(dashboard)/sandbox/components/sandbox-layout.tsx (lines 266-268)
// ALREADY IMPLEMENTED for timerExpireRef:
const timerExpireRef = useRef(handleTimerExpire)
useEffect(() => {
  timerExpireRef.current = handleTimerExpire
}, [handleTimerExpire])

// In callback, access via ref:
(level, action) => {
  timerExpireRef.current(level, action)
}
```

### Verified: Admin Client Implementation (from existing codebase)
```typescript
// Source: src/lib/supabase/admin.ts (lines 7-21)
// THIS is the canonical version (has error handling):
export function createAdminClient() {
  const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL!
  const serviceRoleKey = process.env.SUPABASE_SERVICE_ROLE_KEY!
  if (!serviceRoleKey) {
    throw new Error('SUPABASE_SERVICE_ROLE_KEY is not set')
  }
  return createSupabaseClient(supabaseUrl, serviceRoleKey, {
    auth: { autoRefreshToken: false, persistSession: false },
  })
}

// Source: src/lib/supabase/server.ts (lines 36-47)
// THIS is the duplicate to remove (no error handling):
export function createAdminClient() {
  return createSupabaseClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.SUPABASE_SERVICE_ROLE_KEY!,
    { auth: { autoRefreshToken: false, persistSession: false } },
  )
}
```

### Verified: CRITICAL_FIELDS Duplication (from codebase)
```typescript
// Source: src/lib/agents/somnio/data-extractor.ts (lines 61-67)
export const CRITICAL_FIELDS = ['nombre', 'telefono', 'direccion', 'ciudad', 'departamento'] as const

// Source: src/lib/agents/somnio/transition-validator.ts (lines 61-67)
export const CRITICAL_FIELDS = ['nombre', 'telefono', 'direccion', 'ciudad', 'departamento'] as const

// Source: src/lib/sandbox/ingest-timer.ts (lines 44-51)
export const TIMER_MINIMUM_FIELDS = ['nombre', 'apellido', 'telefono', 'direccion', 'ciudad', 'departamento'] as const
// NOTE: TIMER_MINIMUM_FIELDS includes 'apellido' - it's NOT the same as CRITICAL_FIELDS
```

### Verified: Shopify HMAC Pattern (to copy for WhatsApp)
```typescript
// Source: src/app/api/webhooks/shopify/route.ts (pattern reference)
// Already implements verifyShopifyHmac() with crypto.timingSafeEqual
// WhatsApp webhook should follow same pattern with appropriate header name
```

## State of the Art

| Old Approach | Current Approach | When Changed | Impact |
|--------------|------------------|--------------|--------|
| Direct state capture in callbacks | useRef + useEffect sync | Phase 15.7 (partial) | Need to extend to 3 more refs |
| Mutation as return signal | Explicit return types | Not yet changed | Bug #4 fix opportunity |
| Multiple phone normalizers | Should consolidate to one | Not yet | Bug surface reduction |
| No sandbox auth | Should add auth check | Not yet | Security requirement |

## Open Questions

1. **Bug #8: Is the timer signal override actually a bug?**
   - What we know: `handleIngestMode` sets `lastTimerSignal = cancel` on complete. Then line 316 checks `justCompletedIngest && newState.currentMode === 'ofrecer_promos'` and overrides with `start`.
   - What's unclear: The comment at line 311-315 explains this is intentional - "need Level 3 (promos sin respuesta)". Canceling the ingest timer and starting the promo timer makes semantic sense.
   - Recommendation: Verify current behavior manually in sandbox. If Level 3 timer starts correctly after ingest completion, this is NOT a bug. Mark as "by design" and add clarifying comment.

2. **Bug #5: Is the stale closure in ingest-timer.ts already fixed?**
   - What we know: Phase 15.7 added `contextProvider` pattern (lines 418-428 in ingest-timer.ts). The provider uses `stateRef.current` in sandbox-layout.tsx (lines 292-303).
   - What's unclear: Whether all paths that create the provider correctly reference `stateRef`.
   - Recommendation: Verify `contextProvider` is set via `simulator.setContextProvider(...)` in the `useEffect` at line 292. If it reads from `stateRef.current`, this bug is already fixed.

3. **Security #7: Does Inngest handle its own signature verification?**
   - What we know: Inngest SDK's `serve()` handler may verify `INNGEST_SIGNING_KEY` internally. The audit flags this as "should be explicitly validated."
   - What's unclear: Whether `serve()` from `inngest/next` already validates the signing key.
   - Recommendation: LOW priority. Verify in Inngest docs. If `INNGEST_SIGNING_KEY` env var is set, Inngest SDK handles verification. Skip unless docs say otherwise.

4. **Security #1: .env.local git history**
   - What we know: `git log --all --full-history -- .env.local` returns empty. File was NEVER committed.
   - What's unclear: Nothing - this is confirmed safe.
   - Recommendation: Mark as non-issue. No key rotation needed. Consider adding `git-secrets` pre-commit hook as preventive measure (future phase).

5. **WhatsApp webhook HMAC: What header does 360dialog use?**
   - What we know: The audit suggests `X-360Dialog-Signature`, the WhatsApp Cloud API uses `X-Hub-Signature-256`.
   - What's unclear: Exact header name for 360dialog specifically.
   - Recommendation: Check 360dialog documentation during implementation. Start with `X-Hub-Signature-256` (Meta standard).

## Dependency Map Between Fixes

Understanding which fixes can be done independently vs which have dependencies:

### Independent Fixes (can be done in any order)
- Bug #7 (null check in sandbox-layout.tsx)
- Bug #9 (token tracking in somnio-orchestrator.ts)
- Bug #10 (model constant in data-extractor.ts)
- Bug #12 (array check in order-manager/agent.ts)
- Bug #14 (timer cleanup in sandbox-layout.tsx)
- Bug #16 (expiration context in ingest-timer.ts)
- Security #4 (sandbox auth)
- Duplicate: Supabase admin client consolidation
- Duplicate: Model ID constants

### Dependent Fixes (must be done in order)
1. **Constants consolidation** BEFORE phone normalizer consolidation (CRITICAL_FIELDS may be referenced in imports)
2. **Bugs #1, #2, #3** should be done together (all in same function `handleSendMessage`)
3. **Bug #4** BEFORE Bug #8 verification (both affect state flow in sandbox-engine.ts)
4. **Security #3** (workspace isolation) can be done as one batch across all 3 affected functions in invitations.ts

### Fixes That Need Manual Verification
- Bug #5 (may already be fixed)
- Bug #8 (may be intentional behavior)
- Bug #13 (need to trace async error path carefully)
- Bug #15 (need to understand hasPartialData semantic)

## Detailed File Impact Analysis

### Files Modified by Multiple Fixes
| File | Bugs | Security | Duplicates | Total Touches |
|------|------|----------|------------|---------------|
| `sandbox-layout.tsx` | #1, #2, #3, #7, #14 | - | - | 5 |
| `sandbox-engine.ts` | #4, #8 | - | - | 2 |
| `data-extractor.ts` | #10 | - | CRITICAL_FIELDS | 2 |
| `transition-validator.ts` | - | - | CRITICAL_FIELDS | 1 |
| `ingest-timer.ts` | #5, #16 | - | TIMER_MINIMUM_FIELDS | 3 |
| `message-sequencer.ts` | #6, #13 | - | - | 2 |
| `somnio-orchestrator.ts` | #9 | - | - | 1 |
| `somnio-engine.ts` | #15 | - | - | 1 |
| `template-manager.ts` | #11 | - | - | 1 |
| `order-manager/agent.ts` | #12 | - | - | 1 |
| `sandbox/process/route.ts` | - | #4 | - | 1 |
| `webhooks/whatsapp/route.ts` | - | #2 | - | 1 |
| `actions/invitations.ts` | - | #3 (3 functions) | - | 1 |
| `supabase/server.ts` | - | - | Admin client | 1 |
| `webhook-handler.ts` | - | - | Phone normalizer | 1 |
| `normalizers.ts` | - | - | Phone normalizer | 1 |

### New Files to Create
| File | Purpose |
|------|---------|
| `src/lib/agents/somnio/constants.ts` | Consolidated CRITICAL_FIELDS and related constants |
| `src/lib/whatsapp/hmac.ts` | WhatsApp HMAC verification helper (optional - could go inline) |

## Recommended Plan Structure

Given the user-approved strategy (fix ONE at a time, verify, commit atomically), the planner should structure plans as:

### Plan 01: Critical Bugs (Bugs #1-6)
- 6 critical severity bugs
- sandbox-layout.tsx stale closures (3 bugs, same function)
- sandbox-engine.ts state mutation (1 bug)
- ingest-timer.ts stale closure verification (1 bug - may be already fixed)
- message-sequencer.ts race condition (1 bug)

### Plan 02: High Severity Bugs + Security (Bugs #7-13, Security #2-4)
- 7 high severity bugs
- 3 actionable security fixes (sandbox auth, webhook HMAC, workspace isolation)
- These are all independent, can be committed atomically

### Plan 03: Medium Bugs + Consolidation (Bugs #14-16, Duplicates)
- 3 medium severity bugs
- Phone normalizer consolidation (4 implementations -> 1)
- CRITICAL_FIELDS consolidation (2 definitions -> 1)
- Supabase admin client consolidation (2 implementations -> 1)
- Model ID constants

Each plan should be 1 commit per fix with `tsc --noEmit` verification.

## Sources

### Primary (HIGH confidence)
- Codebase files read directly (all line numbers verified 2026-02-09)
- `.planning/codebase/audit/BUGS.md` - 16 bugs
- `.planning/codebase/audit/SECURITY.md` - 11 vulnerabilities
- `.planning/codebase/audit/DUPLICATES.md` - 7 duplicate categories
- `.planning/codebase/audit/CONSISTENCY.md` - 5 consistency issues
- `tsc --noEmit` output - zero source errors confirmed
- `git log --all --full-history -- .env.local` - never committed confirmed

### Secondary (MEDIUM confidence)
- WhatsApp Cloud API HMAC header name (`X-Hub-Signature-256`) - standard Meta convention
- Inngest SDK signature verification - likely handled by `serve()` when `INNGEST_SIGNING_KEY` is set

### Tertiary (LOW confidence)
- 360dialog-specific webhook signature header name - needs verification against their docs

## Metadata

**Confidence breakdown:**
- Bug fixes: HIGH - all bugs verified against current codebase, line numbers confirmed
- Security fixes: HIGH - affected code verified, patterns from existing Shopify webhook available
- Consolidation: HIGH - all duplicate locations verified, import chains traced
- Open questions: MEDIUM - 4 items need manual verification during implementation

**Research date:** 2026-02-09
**Valid until:** Indefinite (internal codebase audit, no external dependencies changing)
