---
phase: 10-search-tasks-analytics
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/20260203000001_tasks_foundation.sql
  - src/lib/tasks/types.ts
autonomous: true

must_haves:
  truths:
    - "tasks table exists with workspace isolation"
    - "Tasks can be linked to exactly one entity (contact, order, or conversation)"
    - "task_types table allows workspace-specific task categorization"
    - "RLS policies enforce workspace-level access control"
  artifacts:
    - path: "supabase/migrations/20260203000001_tasks_foundation.sql"
      provides: "Tasks database schema with exclusive arc pattern"
      contains: "CREATE TABLE tasks"
    - path: "src/lib/tasks/types.ts"
      provides: "TypeScript types for task system"
      exports: ["Task", "TaskWithDetails", "CreateTaskInput", "TaskType"]
  key_links:
    - from: "tasks.contact_id"
      to: "contacts.id"
      via: "FK with ON DELETE CASCADE"
      pattern: "REFERENCES contacts"
    - from: "tasks.order_id"
      to: "orders.id"
      via: "FK with ON DELETE CASCADE"
      pattern: "REFERENCES orders"
    - from: "tasks.conversation_id"
      to: "conversations.id"
      via: "FK with ON DELETE CASCADE"
      pattern: "REFERENCES conversations"
---

<objective>
Create the database foundation for the task management system with proper entity linking.

Purpose: Enables users to create tasks linked to contacts, orders, or conversations with workspace isolation and proper referential integrity using the exclusive arc pattern.

Output: Migration file with tasks and task_types tables, RLS policies, and TypeScript type definitions.
</objective>

<execution_context>
@/home/jose147/.claude/get-shit-done/workflows/execute-plan.md
@/home/jose147/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/10-search-tasks-analytics/10-CONTEXT.md
@.planning/phases/10-search-tasks-analytics/10-RESEARCH.md

# Existing patterns
@supabase/migrations/20260129000002_custom_fields_notes_activity.sql
@src/lib/orders/types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create tasks database migration</name>
  <files>supabase/migrations/20260203000001_tasks_foundation.sql</files>
  <action>
Create migration with:

1. **task_types table** - Workspace-scoped task categories:
   - id (UUID, PK)
   - workspace_id (UUID, FK workspaces, NOT NULL)
   - name (TEXT, NOT NULL) - e.g., "Llamada", "Seguimiento", "Cobro"
   - color (TEXT, DEFAULT 'gray')
   - position (INT, DEFAULT 0) - for ordering
   - created_at, updated_at with America/Bogota timezone

2. **tasks table** - Main task entity with exclusive arc pattern:
   - id (UUID, PK)
   - workspace_id (UUID, FK workspaces, NOT NULL)
   - title (TEXT, NOT NULL)
   - description (TEXT, nullable)
   - due_date (TIMESTAMPTZ, nullable)
   - priority (TEXT, DEFAULT 'medium', CHECK IN ('low', 'medium', 'high'))
   - status (TEXT, DEFAULT 'pending', CHECK IN ('pending', 'completed'))
   - task_type_id (UUID, FK task_types, nullable)

   Exclusive arc columns (exactly one or none):
   - contact_id (UUID, FK contacts ON DELETE CASCADE, nullable)
   - order_id (UUID, FK orders ON DELETE CASCADE, nullable)
   - conversation_id (UUID, FK conversations ON DELETE CASCADE, nullable)

   Assignment:
   - assigned_to (UUID, FK workspace_members.user_id ON DELETE SET NULL, nullable)
   - created_by (UUID, FK workspace_members.user_id ON DELETE SET NULL)

   Timestamps:
   - completed_at (TIMESTAMPTZ, nullable)
   - created_at, updated_at with America/Bogota timezone

3. **CHECK constraint** for exclusive arc:
   ```sql
   CONSTRAINT task_entity_exclusive CHECK (
     (CASE WHEN contact_id IS NOT NULL THEN 1 ELSE 0 END +
      CASE WHEN order_id IS NOT NULL THEN 1 ELSE 0 END +
      CASE WHEN conversation_id IS NOT NULL THEN 1 ELSE 0 END) <= 1
   )
   ```

4. **Indexes**:
   - idx_tasks_workspace ON tasks(workspace_id)
   - idx_tasks_contact ON tasks(contact_id) WHERE contact_id IS NOT NULL
   - idx_tasks_order ON tasks(order_id) WHERE order_id IS NOT NULL
   - idx_tasks_conversation ON tasks(conversation_id) WHERE conversation_id IS NOT NULL
   - idx_tasks_due_pending ON tasks(workspace_id, due_date) WHERE status = 'pending'
   - idx_tasks_assigned ON tasks(assigned_to) WHERE assigned_to IS NOT NULL
   - idx_task_types_workspace ON task_types(workspace_id)

5. **RLS policies**:
   - task_types: workspace members can SELECT; managers (owner/admin) can INSERT/UPDATE/DELETE
   - tasks: workspace members can SELECT; members can INSERT (created_by = self); author or assigned can UPDATE; managers can DELETE

6. **Trigger** for updated_at on both tables (reuse pattern from existing migrations)

Use America/Bogota timezone consistently: `timezone('America/Bogota', NOW())`
  </action>
  <verify>
Run: `pnpm supabase db reset` (if local) or verify migration syntax is valid SQL.
Check that all FKs reference correct tables, all constraints are properly named.
  </verify>
  <done>
Migration file exists with tasks and task_types tables, exclusive arc constraint, proper indexes, and RLS policies.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create TypeScript types for tasks</name>
  <files>src/lib/tasks/types.ts</files>
  <action>
Create types file following project conventions (see src/lib/orders/types.ts pattern):

```typescript
// Task type/category for workspace customization
export interface TaskType {
  id: string
  workspace_id: string
  name: string
  color: string
  position: number
  created_at: string
  updated_at: string
}

// Base task without relations
export interface Task {
  id: string
  workspace_id: string
  title: string
  description: string | null
  due_date: string | null
  priority: 'low' | 'medium' | 'high'
  status: 'pending' | 'completed'
  task_type_id: string | null

  // Exclusive arc - at most one populated
  contact_id: string | null
  order_id: string | null
  conversation_id: string | null

  assigned_to: string | null
  created_by: string | null
  completed_at: string | null
  created_at: string
  updated_at: string
}

// Task with joined relations for display
export interface TaskWithDetails extends Task {
  task_type?: TaskType | null
  contact?: {
    id: string
    name: string
    phone: string | null
  } | null
  order?: {
    id: string
    total_value: number
    contact?: { name: string } | null
  } | null
  conversation?: {
    id: string
    phone: string
    contact?: { name: string } | null
  } | null
  assigned_user?: {
    id: string
    email: string
  } | null
  created_user?: {
    id: string
    email: string
  } | null
}

// Input for creating a task
export interface CreateTaskInput {
  title: string
  description?: string
  due_date?: string
  priority?: 'low' | 'medium' | 'high'
  task_type_id?: string
  assigned_to?: string
  // Entity linking - at most one
  contact_id?: string
  order_id?: string
  conversation_id?: string
}

// Input for updating a task
export interface UpdateTaskInput {
  title?: string
  description?: string | null
  due_date?: string | null
  priority?: 'low' | 'medium' | 'high'
  status?: 'pending' | 'completed'
  task_type_id?: string | null
  assigned_to?: string | null
}

// Filters for task list
export interface TaskFilters {
  status?: 'pending' | 'completed' | 'all'
  priority?: 'low' | 'medium' | 'high'
  assigned_to?: string | 'me' | 'unassigned'
  entity_type?: 'contact' | 'order' | 'conversation'
  entity_id?: string
  due_before?: string
  due_after?: string
  task_type_id?: string
}

// Summary for badge counts
export interface TaskSummary {
  pending: number
  overdue: number
  dueSoon: number // within 24 hours
}

// Input for task type management
export interface CreateTaskTypeInput {
  name: string
  color?: string
}

export interface UpdateTaskTypeInput {
  name?: string
  color?: string
  position?: number
}
```

Include JSDoc comments for complex types explaining the exclusive arc pattern.
  </action>
  <verify>
Run: `pnpm tsc --noEmit` - TypeScript compiles without errors.
Check that types align with migration schema.
  </verify>
  <done>
Types file exists at src/lib/tasks/types.ts with all required interfaces exported.
  </done>
</task>

</tasks>

<verification>
1. Migration file has valid SQL syntax
2. Exclusive arc constraint is properly defined
3. All FKs reference correct parent tables
4. RLS policies follow project conventions (workspace isolation)
5. TypeScript types compile and match database schema
6. Indexes cover common query patterns (by workspace, by entity, by due date)
</verification>

<success_criteria>
- [ ] tasks table created with exclusive arc for entity linking
- [ ] task_types table for workspace customization
- [ ] RLS policies enforce workspace isolation
- [ ] TypeScript types defined and exported
- [ ] Migration ready for application
</success_criteria>

<output>
After completion, create `.planning/phases/10-search-tasks-analytics/10-01-SUMMARY.md`
</output>
